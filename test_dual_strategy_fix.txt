npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

> ezbuildr@1.0.0 test
> cross-env VITEST_INTEGRATION=true vitest run --coverage


[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m
      [2mCoverage enabled with [22m[33mv8[39m

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w2_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w2_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w9_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w9_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w5_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w5_v3 (Reused: true)

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w14_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w6_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w14_v3 (Reused: true)

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w6_v3 (Reused: true)

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w10_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mðŸ“Š Schema test_schema_w2_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708944202,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708944203,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w2_v3\",public"}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w10_v3 (Reused: true)

{"level":30,"time":1768708944254,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w2_v3\",public"}
{"level":30,"time":1768708944254,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mðŸ“Š Schema test_schema_w9_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708944278,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708944279,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w9_v3\",public"}
{"level":30,"time":1768708944327,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w9_v3\",public"}
{"level":30,"time":1768708944327,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w7_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w7_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mðŸ“Š Schema test_schema_w5_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mðŸ“Š Schema test_schema_w6_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mðŸ“Š Schema test_schema_w14_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708944486,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708944487,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708944487,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w6_v3\",public"}
{"level":30,"time":1768708944488,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w14_v3\",public"}
{"level":30,"time":1768708944540,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w6_v3\",public"}
{"level":30,"time":1768708944540,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708944543,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w14_v3\",public"}
{"level":30,"time":1768708944544,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mðŸ“Š Schema test_schema_w10_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708944624,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708944625,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w10_v3\",public"}
{"level":30,"time":1768708944677,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w10_v3\",public"}
{"level":30,"time":1768708944677,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mðŸ“Š Schema test_schema_w7_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708944803,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708944805,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w7_v3\",public"}
{"level":30,"time":1768708944856,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w7_v3\",public"}
{"level":30,"time":1768708944857,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w2_v3, public
âœ… Enforced search_path: test_schema_w2_v3, public

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w9_v3, public
âœ… Enforced search_path: test_schema_w9_v3, public

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w10_v3
âœ… Current search_path: test_schema_w10_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w10_v3
âœ… Current search_path: test_schema_w10_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w5_v3, public
âœ… Enforced search_path: test_schema_w5_v3, public

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w7_v3
âœ… Current search_path: test_schema_w7_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w6_v3, public
âœ… Enforced search_path: test_schema_w6_v3, public

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w14_v3, public
âœ… Enforced search_path: test_schema_w14_v3, public

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w7_v3
âœ… Current search_path: test_schema_w7_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w7_v3
âœ… Current search_path: test_schema_w7_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w10_v3, public
âœ… Enforced search_path: test_schema_w10_v3, public

{"level":30,"time":1768708945548,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768708945551,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768708945555,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768708945556,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768708945565,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768708945575,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768708945577,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w7_v3
âœ… Current search_path: test_schema_w7_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w7_v3, public
âœ… Enforced search_path: test_schema_w7_v3, public

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w138_v3
âœ… Current search_path: test_schema_w5_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w8_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w3_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w4_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w1_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w11_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w13_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w12_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w8_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w3_v3 (Reused: true)

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w4_v3 (Reused: true)

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w1_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w11_v3 (Reused: true)

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w13_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w12_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mðŸ“Š Schema test_schema_w8_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708946478,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708946479,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w8_v3\",public"}
{"level":30,"time":1768708946523,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w8_v3\",public"}
{"level":30,"time":1768708946523,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mðŸ“Š Schema test_schema_w11_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708946549,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708946550,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w11_v3\",public"}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708946594,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w11_v3\",public"}
{"level":30,"time":1768708946595,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mðŸ“Š Schema test_schema_w1_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708946642,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708946642,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w1_v3\",public"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mðŸ“Š Schema test_schema_w4_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mðŸ“Š Schema test_schema_w12_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mðŸ“Š Schema test_schema_w3_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mðŸ“Š Schema test_schema_w13_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708946648,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708946648,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708946648,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708946649,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708946648,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w4_v3\",public"}
{"level":30,"time":1768708946649,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w12_v3\",public"}
{"level":30,"time":1768708946648,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w3_v3\",public"}
{"level":30,"time":1768708946649,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w13_v3\",public"}
{"level":30,"time":1768708946688,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w1_v3\",public"}
{"level":30,"time":1768708946688,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708946691,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w4_v3\",public"}
{"level":30,"time":1768708946691,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708946695,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w12_v3\",public"}
{"level":30,"time":1768708946692,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w13_v3\",public"}
{"level":30,"time":1768708946692,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708946695,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708946695,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w3_v3\",public"}
{"level":30,"time":1768708946695,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w8_v3, public
âœ… Enforced search_path: test_schema_w8_v3, public

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w11_v3, public
âœ… Enforced search_path: test_schema_w11_v3, public

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w6_v3
âœ… Current search_path: test_schema_w6_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mâš ï¸ Could not set database-level search_path (expected in cloud DBs): tuple concurrently updated
âœ… Enforced search_path: test_schema_w1_v3, public

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mâš ï¸ Could not set database-level search_path (expected in cloud DBs): tuple concurrently updated
âœ… Enforced search_path: test_schema_w3_v3, public

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w5_v3
âœ… Current search_path: test_schema_w5_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w13_v3, public
âœ… Enforced search_path: test_schema_w13_v3, public

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w4_v3, public
âœ… Enforced search_path: test_schema_w4_v3, public

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w12_v3, public
âœ… Enforced search_path: test_schema_w12_v3, public

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w2_v3
âœ… Current search_path: test_schema_w7_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w9_v3
âœ… Current search_path: test_schema_w9_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w9_v3
âœ… Current search_path: test_schema_w10_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w2_v3
âœ… Current search_path: test_schema_w2_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w10_v3
âœ… Current search_path: test_schema_w9_v3, public
â© Schema reused, skipping migrations.

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould transfer user-owned project to org
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,fea3ab4c-3a6d-4966-a722-13e35f23b58f,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'fea3ab4c-3a6d-4966-a722-13e35f23b58f'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m522[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (08c78ad9-5d04-45bd-b291-e2fd32975b62, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, fea3ab4c-3a6d-4966-a722-13e35f23b58f, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 04:02:28.792624, 2026-01-18 04:02:28.792624).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w7_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould create invite for existing user without creating placeholder
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,6b0573f5-8803-4a15-9207-9e9ce9ab5e82,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'6b0573f5-8803-4a15-9207-9e9ce9ab5e82'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m521[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (ef59955e-2ffa-4bd4-8d27-ba77dc445dd9, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, 6b0573f5-8803-4a15-9207-9e9ce9ab5e82, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-18 04:02:29.227537, 2026-01-18 04:02:29.227537).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w14_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768708948302,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould prevent transfer to org if user is not a member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,621a6172-e043-4af3-9a9d-da6fb8ad62f0,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'621a6172-e043-4af3-9a9d-da6fb8ad62f0'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m523[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (9c224849-9cbb-453b-83fe-9bf6eb159c42, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 621a6172-e043-4af3-9a9d-da6fb8ad62f0, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 04:02:29.780802, 2026-01-18 04:02:29.780802).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w10_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":50,"time":1768708949071,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["8dab6f6e-f9db-4890-9f9e-a9c449a75028","$2b$12$kasihLkQy64VeV9LXdHmt.jrpy7c/9g3FmIDSYfZuFpS5IsDERZXS"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(8dab6f6e-f9db-4890-9f9e-a9c449a75028) is not present in table \"users\".","schema":"test_schema_w8_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"8dab6f6e-f9db-4890-9f9e-a9c449a75028","msg":"Failed to create user credentials"}
{"level":50,"time":1768708949072,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["8dab6f6e-f9db-4890-9f9e-a9c449a75028","$2b$12$kasihLkQy64VeV9LXdHmt.jrpy7c/9g3FmIDSYfZuFpS5IsDERZXS"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(8dab6f6e-f9db-4890-9f9e-a9c449a75028) is not present in table \"users\".","schema":"test_schema_w8_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768708949118,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["e3301674-9ed5-4a10-8a13-2672a287a912","$2b$12$nPIyldcCOXC3D0iKYr0qb.6MJl8iW0rwef3TbmVOjJdUDF5tHY.Iy"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(e3301674-9ed5-4a10-8a13-2672a287a912) is not present in table \"users\".","schema":"test_schema_w9_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"e3301674-9ed5-4a10-8a13-2672a287a912","msg":"Failed to create user credentials"}
{"level":50,"time":1768708949118,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["e3301674-9ed5-4a10-8a13-2672a287a912","$2b$12$nPIyldcCOXC3D0iKYr0qb.6MJl8iW0rwef3TbmVOjJdUDF5tHY.Iy"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(e3301674-9ed5-4a10-8a13-2672a287a912) is not present in table \"users\".","schema":"test_schema_w9_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768708949384,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["TZslFbBjlxWCLhS0k0ALq","$2b$12$5YtylsvBlR4saU//w1rew.kk8YFP4/0jILPTGBZpu1DjFEL3jzLMC"],"cause":{"length":331,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(TZslFbBjlxWCLhS0k0ALq) is not present in table \"users\".","schema":"test_schema_w9_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"TZslFbBjlxWCLhS0k0ALq","msg":"Failed to create user credentials"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould allow org member to transfer org-owned project to another org they belong to
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,feeae8b5-42f3-4e2e-98b6-15fb2f66d0f4,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'feeae8b5-42f3-4e2e-98b6-15fb2f66d0f4'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m522[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (7f5ca02a-b761-4737-8e2a-1702a5d45e8b, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, feeae8b5-42f3-4e2e-98b6-15fb2f66d0f4, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 04:02:30.886744, 2026-01-18 04:02:30.886744).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w5_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":50,"time":1768708950028,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["65dee692-e284-41fb-8a42-98024f130a2e","$2b$12$oWaOSePZzNlg3viK4A/BveWdtPfqUt1bGdVGeO3vSFEhpvUVkDm/a"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(65dee692-e284-41fb-8a42-98024f130a2e) is not present in table \"users\".","schema":"test_schema_w11_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"65dee692-e284-41fb-8a42-98024f130a2e","msg":"Failed to create user credentials"}
{"level":50,"time":1768708950028,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["65dee692-e284-41fb-8a42-98024f130a2e","$2b$12$oWaOSePZzNlg3viK4A/BveWdtPfqUt1bGdVGeO3vSFEhpvUVkDm/a"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(65dee692-e284-41fb-8a42-98024f130a2e) is not present in table \"users\".","schema":"test_schema_w11_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768708950181,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["mRW3u5GTV6d0k6U3EeoDf","$2b$12$ogk7kUa44yRX7Wp8VHlhYOE6pkbp3JfCIKpzYII9IfbtXXFxaN0vq"],"cause":{"length":332,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(mRW3u5GTV6d0k6U3EeoDf) is not present in table \"users\".","schema":"test_schema_w11_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"mRW3u5GTV6d0k6U3EeoDf","msg":"Failed to create user credentials"}
{"level":50,"time":1768708950600,"env":"test","module":"auth-routes","email":"test-1768708950132-b3p7qn@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768708950738,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould exclude revoked sessions
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould require admin access to create invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,0a568b3a-d8a6-40a5-9a7a-ed9be7379b11,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'0a568b3a-d8a6-40a5-9a7a-ed9be7379b11'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m520[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (c6f550b9-069e-48e3-993e-2084aec5c5e9, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, 0a568b3a-d8a6-40a5-9a7a-ed9be7379b11, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-18 04:02:31.792514, 2026-01-18 04:02:31.792514).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w5_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":50,"time":1768708950796,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["e104d5a5-b370-4248-9f6e-1d15806e2083","$2b$12$3pQYycxur/q2G.Zh0af4QudLdtqHFyLdegrMC/z5dNyz7x3PG6Pim"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(e104d5a5-b370-4248-9f6e-1d15806e2083) is not present in table \"users\".","schema":"test_schema_w5_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"e104d5a5-b370-4248-9f6e-1d15806e2083","msg":"Failed to create user credentials"}
{"level":50,"time":1768708950796,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["e104d5a5-b370-4248-9f6e-1d15806e2083","$2b$12$3pQYycxur/q2G.Zh0af4QudLdtqHFyLdegrMC/z5dNyz7x3PG6Pim"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(e104d5a5-b370-4248-9f6e-1d15806e2083) is not present in table \"users\".","schema":"test_schema_w5_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768708950804,"env":"test","module":"auth-routes","email":"test-1768708950132-b3p7qn@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould detach workflow from project when transferring to different owner
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,9ed77984-a7da-4987-8ba8-3c1e6d25cc89,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'9ed77984-a7da-4987-8ba8-3c1e6d25cc89'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m523[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (5040c9cf-0293-43ab-aba5-b7be12706a3f, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 9ed77984-a7da-4987-8ba8-3c1e6d25cc89, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 04:02:31.882796, 2026-01-18 04:02:31.882796).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w11_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":50,"time":1768708950936,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould exclude revoked sessions
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

{"level":50,"time":1768708951218,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768708951328,"env":"test","module":"auth-routes","email":"test-1768708950881-3ggak6@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768708951457,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould generate unique backup codes
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768708951471,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

{"level":50,"time":1768708951560,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["5bc6e5b6-88ce-4d1d-9d3b-e00e0a72e355","$2b$12$7Umc4fgVohkymNjJhUEshOFRa/ZWFDLPVVDLijxWsKDN9Ic./6FjG"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(5bc6e5b6-88ce-4d1d-9d3b-e00e0a72e355) is not present in table \"users\".","schema":"test_schema_w5_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"5bc6e5b6-88ce-4d1d-9d3b-e00e0a72e355","msg":"Failed to create user credentials"}
{"level":50,"time":1768708951560,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["5bc6e5b6-88ce-4d1d-9d3b-e00e0a72e355","$2b$12$7Umc4fgVohkymNjJhUEshOFRa/ZWFDLPVVDLijxWsKDN9Ic./6FjG"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(5bc6e5b6-88ce-4d1d-9d3b-e00e0a72e355) is not present in table \"users\".","schema":"test_schema_w5_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mremoveMember[2m > [22m[2mshould prevent self-removal
[22m[39mCRITICAL: User lookup failed validation in beforeEach: [90mundefined[39m

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould keep workflow in project when transferring to same owner
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,e27fba00-3b03-4ab6-aa40-dc5408c4c5ba,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'e27fba00-3b03-4ab6-aa40-dc5408c4c5ba'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m523[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (2ba8548a-2d3b-4616-8cc5-2ca636a3c9e4, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, e27fba00-3b03-4ab6-aa40-dc5408c4c5ba, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 04:02:32.873411, 2026-01-18 04:02:32.873411).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w12_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mðŸ“Š Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708951981,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708951981,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w0_v3\",public"}
{"level":30,"time":1768708952020,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w0_v3\",public"}
{"level":30,"time":1768708952020,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mleaveOrganization[2m > [22m[2mshould allow admin to leave organization
[22m[39mCRITICAL: User lookup failed validation in beforeEach: [90mundefined[39m

{"level":30,"time":1768708952680,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708952681,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/organizationService.test.ts [2m([22m[2m13 tests[22m[2m | [22m[31m13 failed[39m[2m)[22m[33m 9080[2mms[22m[39m
[31m       [31mÃ—[31m should create organization and auto-create admin membership[39m[32m 155[2mms[22m[39m
[31m       [31mÃ—[31m should return all organizations for user[39m[33m 505[2mms[22m[39m
[31m       [31mÃ—[31m should return empty array for user with no memberships[39m[33m 471[2mms[22m[39m
[31m       [31mÃ—[31m should allow admin to update organization[39m[33m 530[2mms[22m[39m
[31m       [31mÃ—[31m should deny non-admin from updating organization[39m[33m 495[2mms[22m[39m
[31m       [31mÃ—[31m should return all members of organization[39m[33m 483[2mms[22m[39m
[31m       [31mÃ—[31m should allow admin to promote member[39m[33m 522[2mms[22m[39m
[31m       [31mÃ—[31m should allow admin to demote other admin[39m[33m 481[2mms[22m[39m
[31m       [31mÃ—[31m should prevent self-demotion[39m[33m 501[2mms[22m[39m
[31m       [31mÃ—[31m should allow admin to remove member[39m[33m 480[2mms[22m[39m
[31m       [31mÃ—[31m should prevent self-removal[39m[33m 619[2mms[22m[39m
[31m       [31mÃ—[31m should allow member to leave organization[39m[32m 177[2mms[22m[39m
[31m       [31mÃ—[31m should allow admin to leave organization[39m[33m 669[2mms[22m[39m
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould accept invite and create membership
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,5f29cf4d-7e1a-4b09-b323-5755fa1bab92,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'5f29cf4d-7e1a-4b09-b323-5755fa1bab92'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m520[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (ba23521a-b28b-4070-ac08-5f1683bb4a68, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, 5f29cf4d-7e1a-4b09-b323-5755fa1bab92, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-18 04:02:33.737105, 2026-01-18 04:02:33.737105).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w2_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w0_v3, public
âœ… Enforced search_path: test_schema_w0_v3, public

{"level":50,"time":1768708953033,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w1_v3
âœ… Current search_path: test_schema_w5_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w15_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w15_v3 (Reused: true)

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould prevent non-member from transferring org workflow
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,b97a1b5c-2189-464a-b04a-8d0b6b5fc00b,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'b97a1b5c-2189-464a-b04a-8d0b6b5fc00b'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m522[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (413404ab-2361-42ee-9fff-850eb28c6842, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, b97a1b5c-2189-464a-b04a-8d0b6b5fc00b, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 04:02:35.346391, 2026-01-18 04:02:35.346391).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w3_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768708954442,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768708954462,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708954451,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708954452,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708954457,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708954457,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708954461,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708954462,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708954462,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708954462,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mðŸ“Š Schema test_schema_w15_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708954714,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708954715,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w15_v3\",public"}
{"level":30,"time":1768708954752,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w15_v3\",public"}
{"level":30,"time":1768708954753,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768708954899,"env":"test","module":"auth-routes","email":"test-1768708954476-sisobn@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768708954915,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["fd8a2270-86ce-4487-a419-ca0d768683f4","$2b$12$gt5ELk71dZSZNQjvunG/6O/UkpmCx3L7Qx7lO5dTDEuHWgbdGav0y"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(fd8a2270-86ce-4487-a419-ca0d768683f4) is not present in table \"users\".","schema":"test_schema_w6_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"fd8a2270-86ce-4487-a419-ca0d768683f4","msg":"Failed to create user credentials"}
{"level":50,"time":1768708954915,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["fd8a2270-86ce-4487-a419-ca0d768683f4","$2b$12$gt5ELk71dZSZNQjvunG/6O/UkpmCx3L7Qx7lO5dTDEuHWgbdGav0y"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(fd8a2270-86ce-4487-a419-ca0d768683f4) is not present in table \"users\".","schema":"test_schema_w6_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/auth.middleware.integration.test.ts:35:15

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708954927,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708954927,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768708954943,"env":"test","module":"auth-routes","email":"nonexistent@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768708954994,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould rotate refresh token on each use
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768708955041,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for non-existent user
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

 [31mâ¯[39m tests/integration/auth/auth.middleware.integration.test.ts [2m([22m[2m27 tests[22m[2m | [22m[33m27 skipped[39m[2m)[22m[33m 3788[2mms[22m[39m
       [2m[90mâ†“[39m[22m should allow access with valid JWT Bearer token
       [2m[90mâ†“[39m[22m should return 401 when no token provided
       [2m[90mâ†“[39m[22m should return 401 with invalid token
       [2m[90mâ†“[39m[22m should return 401 with expired token
       [2m[90mâ†“[39m[22m should proceed without authentication if no token provided
       [2m[90mâ†“[39m[22m should authenticate with JWT Bearer token
       [2m[90mâ†“[39m[22m should authenticate with refresh token cookie (GET only)
       [2m[90mâ†“[39m[22m should reject cookie auth for POST requests (mutation-strict)
       [2m[90mâ†“[39m[22m should reject cookie auth for PUT requests
       [2m[90mâ†“[39m[22m should reject cookie auth for DELETE requests
       [2m[90mâ†“[39m[22m should allow cookie auth for HEAD requests
       [2m[90mâ†“[39m[22m should prioritize JWT over cookie when both present
       [2m[90mâ†“[39m[22m should return 401 when no auth provided
       [2m[90mâ†“[39m[22m should return 401 when both JWT and cookie are invalid
       [2m[90mâ†“[39m[22m should authenticate with JWT if provided
       [2m[90mâ†“[39m[22m should authenticate with cookie if JWT not provided
       [2m[90mâ†“[39m[22m should proceed anonymously if no auth provided
       [2m[90mâ†“[39m[22m should proceed anonymously if both JWT and cookie are invalid
       [2m[90mâ†“[39m[22m should only allow safe methods for cookie auth
       [2m[90mâ†“[39m[22m should ignore cookies when Bearer token present
       [2m[90mâ†“[39m[22m should attach userId to request
       [2m[90mâ†“[39m[22m should attach userEmail to request
       [2m[90mâ†“[39m[22m should return consistent error format for missing token
       [2m[90mâ†“[39m[22m should return consistent error format for invalid token
       [2m[90mâ†“[39m[22m should return consistent error format for expired token
       [2m[90mâ†“[39m[22m should handle malformed JWT gracefully
       [2m[90mâ†“[39m[22m should handle JWT with wrong algorithm
[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

{"level":50,"time":1768708955466,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["152a9b0e-500c-4baf-a798-597673156e21","$2b$12$kDkFWksuCL6zkq65wgVjpe5tazbSBpBYESTOM3O6l21Y9W3dL9NY6"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(152a9b0e-500c-4baf-a798-597673156e21) is not present in table \"users\".","schema":"test_schema_w13_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"152a9b0e-500c-4baf-a798-597673156e21","msg":"Failed to create user credentials"}
{"level":50,"time":1768708955466,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["152a9b0e-500c-4baf-a798-597673156e21","$2b$12$kDkFWksuCL6zkq65wgVjpe5tazbSBpBYESTOM3O6l21Y9W3dL9NY6"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(152a9b0e-500c-4baf-a798-597673156e21) is not present in table \"users\".","schema":"test_schema_w13_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mDatabase Transfer[2m > [22m[2mshould transfer database ownership
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,4a9fdd94-6148-4455-ab70-20606893f4b2,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'4a9fdd94-6148-4455-ab70-20606893f4b2'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m522[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (3e598458-08cc-446b-a7ee-e4cf2f908c15, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 4a9fdd94-6148-4455-ab70-20606893f4b2, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 04:02:36.824999, 2026-01-18 04:02:36.824999).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w4_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject already accepted invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,c5e18774-2937-4723-83fe-0a88e1572faf,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'c5e18774-2937-4723-83fe-0a88e1572faf'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m520[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (99491c4b-30b0-4912-bfbf-874362573496, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, c5e18774-2937-4723-83fe-0a88e1572faf, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-18 04:02:36.947926, 2026-01-18 04:02:36.947926).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w1_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

{"level":50,"time":1768708956332,"env":"test","module":"auth-routes","email":"test-1768708955097-6srfs@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768708956421,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 403 for unverified email
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mDatabase Transfer[2m > [22m[2mshould allow org member to transfer org database
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,83ced460-b4ce-4eb5-810d-5cd5ccfd8625,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'83ced460-b4ce-4eb5-810d-5cd5ccfd8625'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m522[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (741d2fad-7184-4f19-8caa-6d459b6e22cf, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 83ced460-b4ce-4eb5-810d-5cd5ccfd8625, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 04:02:37.760672, 2026-01-18 04:02:37.760672).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w6_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":30,"time":1768708957310,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708957311,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/auth.flows.real.test.ts [2m([22m[2m11 tests[22m[2m | [22m[31m11 failed[39m[2m)[22m[33m 11633[2mms[22m[39m
[31m       [31mÃ—[31m should complete registration, verify email, then login[39m[33m 476[2mms[22m[39m
[31m       [31mÃ—[31m should lock account after 5 failed attempts, then unlock after waiting[39m[33m 710[2mms[22m[39m
[31m       [31mÃ—[31m should record all login attempts[39m[33m 735[2mms[22m[39m
[31m       [31mÃ—[31m should complete MFA setup and login with TOTP[39m[33m 709[2mms[22m[39m
[31m       [31mÃ—[31m should login with backup code when TOTP unavailable[39m[33m 720[2mms[22m[39m
[31m       [31mÃ—[31m should complete full password reset flow[39m[33m 935[2mms[22m[39m
[31m       [31mÃ—[31m should invalidate all sessions after password reset[39m[33m 942[2mms[22m[39m
[31m       [31mÃ—[31m should rotate refresh token on each use[39m[33m 1727[2mms[22m[39m
[31m       [31mÃ—[31m should detect and prevent refresh token reuse (token theft)[39m[33m 353[2mms[22m[39m
[31m       [31mÃ—[31m should list all active sessions[39m[33m 701[2mms[22m[39m
[31m       [31mÃ—[31m should revoke specific session[39m[33m 687[2mms[22m[39m
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mDatabase Transfer[2m > [22m[2mshould prevent transfer to org if user is not a member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,189890e2-e8f2-497d-b176-56bf46a20780,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'189890e2-e8f2-497d-b176-56bf46a20780'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m518[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (eea9d98b-99c0-4815-8e47-b89a3fa11f64, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 189890e2-e8f2-497d-b176-56bf46a20780, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 04:02:38.7096, 2026-01-18 04:02:38.7096).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w4_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

{"level":50,"time":1768708957818,"env":"test","module":"auth-routes","email":"test-1768708957399-bho5i@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768708957945,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768708957995,"env":"test","module":"auth-routes","email":"test-1768708957399-bho5i@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768708958106,"env":"test","module":"auth-routes","email":"test-1768708957683-bd2xm@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768708958120,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768708958183,"env":"test","module":"auth-routes","email":"test-1768708957399-bho5i@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768708958197,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould prevent backup code reuse
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768708958204,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":50,"time":1768708958282,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould return pending invites for user email
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,7b6dcf92-21d4-49f4-8c62-b6d385d3ff1b,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'7b6dcf92-21d4-49f4-8c62-b6d385d3ff1b'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m520[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (552dc126-2f94-4c05-b218-b0009516cdc6, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, 7b6dcf92-21d4-49f4-8c62-b6d385d3ff1b, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-18 04:02:39.366146, 2026-01-18 04:02:39.366146).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w3_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":50,"time":1768708958376,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["k4Bz5SAPR0OY2cNsMeQO_","$2b$12$p3PNctsq9ObN9Sd6apRNZOcqbqLGOv4mrZ6z43HjOfTkkqt0fgNmK"],"cause":{"length":331,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(k4Bz5SAPR0OY2cNsMeQO_) is not present in table \"users\".","schema":"test_schema_w3_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"k4Bz5SAPR0OY2cNsMeQO_","msg":"Failed to create user credentials"}
{"level":50,"time":1768708958426,"env":"test","module":"auth-routes","userId":"ebfb703005aa13fb4a17e7f5b8ed0d5b","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768708958522,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:74:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708958595,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708958596,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708958628,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708958628,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/unit/engine/templateNode.test.ts [2m([22m[2m17 tests[22m[2m | [22m[31m17 failed[39m[2m)[22m[33m 14793[2mms[22m[39m
[31m       [31mÃ—[31m should resolve template by key from workflowTemplates mapping[39m[33m 700[2mms[22m[39m
[31m       [31mÃ—[31m should throw error if template key not found[39m[33m 581[2mms[22m[39m
[31m       [31mÃ—[31m should store output in runOutputs table[39m[33m 679[2mms[22m[39m
[31m       [31mÃ—[31m should resolve template by templateId directly[39m[33m 588[2mms[22m[39m
[31m       [31mÃ—[31m should throw error if templateId not found[39m[33m 573[2mms[22m[39m
[31m       [31mÃ—[31m should use docxRenderer2 by default (v2 engine)[39m[33m 642[2mms[22m[39m
[31m       [31mÃ—[31m should use legacy engine when engine="legacy"[39m[33m 587[2mms[22m[39m
[31m       [31mÃ—[31m should generate PDF when toPdf=true[39m[33m 581[2mms[22m[39m
[31m       [31mÃ—[31m should default to DOCX when toPdf=false[39m[33m 583[2mms[22m[39m
[31m       [31mÃ—[31m should skip execution when condition evaluates to false[39m[33m 1062[2mms[22m[39m
[31m       [31mÃ—[31m should execute when condition evaluates to true[39m[33m 803[2mms[22m[39m
[31m       [31mÃ—[31m should resolve simple bindings[39m[33m 1081[2mms[22m[39m
[31m       [31mÃ—[31m should handle binding resolution errors gracefully[39m[33m 613[2mms[22m[39m
[31m       [31mÃ—[31m should record failed output in runOutputs table[39m[33m 890[2mms[22m[39m
[31m       [31mÃ—[31m should not throw errors (should return error in result)[39m[33m 740[2mms[22m[39m
[31m       [31mÃ—[31m should deny access to templates from different tenant[39m[33m 587[2mms[22m[39m
[31m       [31mÃ—[31m should require either templateKey or templateId[39m[33m 561[2mms[22m[39m
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mTransfer Validation[2m > [22m[2mshould only allow transfer to self when targetOwnerType is user
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,4c573552-7e8b-472a-8bf7-d191e70d0732,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'4c573552-7e8b-472a-8bf7-d191e70d0732'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m522[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (da63fa51-b27c-4a1e-b384-e3cc96f2bb95, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 4c573552-7e8b-472a-8bf7-d191e70d0732, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 04:02:39.675258, 2026-01-18 04:02:39.675258).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w2_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

 [31mâ¯[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m13 failed[39m[2m)[22m[33m 12950[2mms[22m[39m
[31m       [31mÃ—[31m should trust current device[39m[33m 577[2mms[22m[39m
[31m       [31mÃ—[31m should set trust expiry to 30 days[39m[33m 716[2mms[22m[39m
[31m       [31mÃ—[31m should update expiry if device already trusted[39m[33m 842[2mms[22m[39m
       [33m[2mâœ“[22m[39m should require authentication [33m 404[2mms[22m[39m
[31m       [31mÃ—[31m should list all trusted devices[39m[33m 492[2mms[22m[39m
[31m       [31mÃ—[31m should mark current device[39m[33m 711[2mms[22m[39m
[31m       [31mÃ—[31m should exclude revoked devices[39m[33m 840[2mms[22m[39m
[31m       [31mÃ—[31m should exclude expired devices[39m[33m 1071[2mms[22m[39m
[31m       [31mÃ—[31m should revoke specific device[39m[33m 725[2mms[22m[39m
[31m       [31mÃ—[31m should return 404 for non-existent device[39m[33m 702[2mms[22m[39m
[31m       [31mÃ—[31m should prevent revoking other user's device[39m[33m 688[2mms[22m[39m
[31m       [31mÃ—[31m should skip MFA for trusted device[39m[33m 734[2mms[22m[39m
[31m       [31mÃ—[31m should require MFA for untrusted device[39m[33m 725[2mms[22m[39m
[31m       [31mÃ—[31m should update lastUsedAt on trusted device login[39m[33m 710[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w17_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w17_v3 (Reused: true)

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w15_v3, public
âœ… Enforced search_path: test_schema_w15_v3, public

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w12_v3
âœ… Current search_path: test_schema_w1_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mðŸ“Š Schema test_schema_w17_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708959462,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708959463,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w17_v3\",public"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould not return expired invites
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,1ef69f69-991f-436f-b870-2865e51d46af,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'1ef69f69-991f-436f-b870-2865e51d46af'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m520[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (f0b46295-9cf7-4bc8-b11f-1dd1f540c4b6, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, 1ef69f69-991f-436f-b870-2865e51d46af, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-18 04:02:40.504868, 2026-01-18 04:02:40.504868).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w8_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":30,"time":1768708959500,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w17_v3\",public"}
{"level":30,"time":1768708959500,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768708959632,"env":"test","module":"auth-routes","email":"test-1768708959194-qzbfbh@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":50,"time":1768708959759,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould keep current session active
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

 [31mâ¯[39m tests/unit/services/PdfQueueService.test.ts [2m([22m[2m15 tests[22m[2m | [22m[31m15 failed[39m[2m)[22m[33m 16176[2mms[22m[39m
[31m       [31mÃ—[31m should enqueue a PDF conversion job[39m[33m 861[2mms[22m[39m
[31m       [31mÃ—[31m should create output with empty storagePath initially[39m[33m 874[2mms[22m[39m
[31m       [31mÃ—[31m should return job status for pending job[39m[33m 784[2mms[22m[39m
[31m       [31mÃ—[31m should return null for non-existent job[39m[33m 840[2mms[22m[39m
[31m       [31mÃ—[31m should parse attempt count from error field[39m[33m 774[2mms[22m[39m
[31m       [31mÃ—[31m should convert DOCX to PDF immediately[39m[33m 881[2mms[22m[39m
[31m       [31mÃ—[31m should handle conversion errors gracefully[39m[33m 835[2mms[22m[39m
[31m       [31mÃ—[31m should start and stop service[39m[33m 753[2mms[22m[39m
[31m       [31mÃ—[31m should not start if already running[39m[33m 757[2mms[22m[39m
[31m       [31mÃ—[31m should handle stop when not running[39m[33m 770[2mms[22m[39m
[31m       [31mÃ—[31m should process pending jobs when queue is processed[39m[33m 1008[2mms[22m[39m
[31m       [31mÃ—[31m should process multiple jobs in batch[39m[33m 1253[2mms[22m[39m
[31m       [31mÃ—[31m should handle missing DOCX output gracefully[39m[33m 1267[2mms[22m[39m
[31m       [31mÃ—[31m should support enqueue within transaction[39m[33m 793[2mms[22m[39m
[31m       [31mÃ—[31m should support convertImmediate within transaction[39m[33m 812[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768708959813,"env":"test","module":"auth-routes","email":"test-1768708959194-qzbfbh@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

{"level":50,"time":1768708959911,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould keep current session active
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":50,"time":1768708960017,"env":"test","module":"auth-routes","email":"test-1768708959602-bplmx@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w16_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":50,"time":1768708960116,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Status[2m > [22m[2mshould return MFA status for user
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768708960122,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mTransfer Validation[2m > [22m[2mshould allow transfer from user to self (org member transferring org asset to themselves)
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,554fa0b0-0371-4eef-8ed5-9c4b6d74dfd4,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'554fa0b0-0371-4eef-8ed5-9c4b6d74dfd4'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m520[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (e9ea9b5f-2c94-4934-ad6b-e5142e37e926, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 554fa0b0-0371-4eef-8ed5-9c4b6d74dfd4, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 04:02:41.14325, 2026-01-18 04:02:41.14325).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w7_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w16_v3 (Reused: true)

{"level":30,"time":1768708960330,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708960331,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/transferOwnership.test.ts [2m([22m[2m11 tests[22m[2m | [22m[31m11 failed[39m[2m)[22m[33m 16386[2mms[22m[39m
[31m       [31mÃ—[31m should transfer user-owned project to org[39m[33m 1049[2mms[22m[39m
[31m       [31mÃ—[31m should prevent transfer to org if user is not a member[39m[33m 978[2mms[22m[39m
[31m       [31mÃ—[31m should allow org member to transfer org-owned project to another org they belong to[39m[33m 1117[2mms[22m[39m
[31m       [31mÃ—[31m should detach workflow from project when transferring to different owner[39m[33m 991[2mms[22m[39m
[31m       [31mÃ—[31m should keep workflow in project when transferring to same owner[39m[33m 990[2mms[22m[39m
[31m       [31mÃ—[31m should prevent non-member from transferring org workflow[39m[33m 2478[2mms[22m[39m
[31m       [31mÃ—[31m should transfer database ownership[39m[33m 1474[2mms[22m[39m
[31m       [31mÃ—[31m should allow org member to transfer org database[39m[33m 929[2mms[22m[39m
[31m       [31mÃ—[31m should prevent transfer to org if user is not a member[39m[33m 958[2mms[22m[39m
[31m       [31mÃ—[31m should only allow transfer to self when targetOwnerType is user[39m[33m 982[2mms[22m[39m
[31m       [31mÃ—[31m should allow transfer from user to self (org member transferring org asset to themselves)[39m[33m 1449[2mms[22m[39m
{"level":30,"time":1768708960496,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708960498,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/unit/services/WorkflowTemplateService.test.ts [2m([22m[2m21 tests[22m[2m | [22m[31m21 failed[39m[2m)[22m[33m 17072[2mms[22m[39m
[31m       [31mÃ—[31m should throw error if template belongs to different project[39m[33m 604[2mms[22m[39m
[31m       [31mÃ—[31m should automatically unset other primaries when setting new primary[39m[33m 606[2mms[22m[39m
[31m         [31mÃ—[31m should list all templates for workflow version[39m[33m 618[2mms[22m[39m
[31m         [31mÃ—[31m should return empty array for version with no templates[39m[33m 585[2mms[22m[39m
[31m         [31mÃ—[31m should get template mapping by id and version[39m[33m 558[2mms[22m[39m
[31m         [31mÃ—[31m should throw error if mapping not found[39m[33m 574[2mms[22m[39m
[31m         [31mÃ—[31m should get template by key[39m[33m 672[2mms[22m[39m
[31m         [31mÃ—[31m should throw error if key not found[39m[33m 588[2mms[22m[39m
[31m         [31mÃ—[31m should get primary template for workflow version[39m[33m 571[2mms[22m[39m
[31m         [31mÃ—[31m should return null when no primary template exists[39m[33m 643[2mms[22m[39m
[31m         [31mÃ—[31m should update mapping key[39m[33m 835[2mms[22m[39m
[31m         [31mÃ—[31m should update isPrimary flag[39m[33m 576[2mms[22m[39m
[31m         [31mÃ—[31m should throw error if new key already exists[39m[33m 826[2mms[22m[39m
[31m         [31mÃ—[31m should throw error if mapping not found[39m[33m 994[2mms[22m[39m
[31m         [31mÃ—[31m should unset other primaries when setting isPrimary to true[39m[33m 831[2mms[22m[39m
[31m         [31mÃ—[31m should detach template from workflow version[39m[33m 726[2mms[22m[39m
[31m         [31mÃ—[31m should throw error if mapping not found[39m[33m 858[2mms[22m[39m
[31m         [31mÃ—[31m should set template as primary[39m[33m 652[2mms[22m[39m
[31m         [31mÃ—[31m should throw error if mapping not found[39m[33m 669[2mms[22m[39m
[31m         [31mÃ—[31m should support operations within a transaction[39m[33m 572[2mms[22m[39m
[31m         [31mÃ—[31m should rollback on transaction error[39m[33m 581[2mms[22m[39m
[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39mðŸ“Š Schema test_schema_w16_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstderr[2m | tests/unit/services/AuthService.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): Error: [vitest] No "closeDatabase" export is defined on the "../../../server/db" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

    at VitestMocker.createError [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:311:17[90m)[39m
    at Object.get [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:384:16[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:177:34
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m {
  codeFrame: [32m'vi.mock(import("../../../server/db"), async (importOriginal) => {\n'[39m +
    [32m'  const actual = await importOriginal()\n'[39m +
    [32m'  return {\n'[39m +
    [32m'    ...actual,\n'[39m +
    [32m'    // your mocked methods\n'[39m +
    [32m'  }\n'[39m +
    [32m'})'[39m
}

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w18_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w18_v3 (Reused: true)

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w17_v3, public
âœ… Enforced search_path: test_schema_w17_v3, public

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w7_v3
âœ… Current search_path: test_schema_w2_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mðŸ“Š Schema test_schema_w18_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708961107,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708961108,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w18_v3\",public"}
{"level":30,"time":1768708961155,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w18_v3\",public"}
{"level":30,"time":1768708961155,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708961406,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708961407,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

 [31mâ¯[39m tests/integration/auth/oauth2.token-refresh.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m25 failed[39m[2m)[22m[33m 15747[2mms[22m[39m
[31m       [31mÃ—[31m should refresh access token with valid refresh token[39m[32m 105[2mms[22m[39m
[31m       [31mÃ—[31m should rotate refresh token after use[39m[33m 734[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 when refresh token is missing[39m[33m 450[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 for invalid refresh token[39m[33m 406[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 for expired refresh token[39m[33m 452[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 for revoked refresh token[39m[33m 424[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 when user is not found[39m[33m 445[2mms[22m[39m
[31m       [31mÃ—[31m should update refresh token metadata on rotation[39m[33m 437[2mms[22m[39m
[31m       [31mÃ—[31m should handle concurrent refresh token requests (token reuse detection)[39m[33m 687[2mms[22m[39m
[31m       [31mÃ—[31m should set secure cookie in production[39m[33m 441[2mms[22m[39m
[31m       [31mÃ—[31m should set proper cookie attributes[39m[33m 429[2mms[22m[39m
[31m       [31mÃ—[31m should include user role information in response[39m[33m 444[2mms[22m[39m
[31m       [31mÃ—[31m should create refresh token on login[39m[33m 672[2mms[22m[39m
[31m       [31mÃ—[31m should revoke refresh token on logout[39m[33m 452[2mms[22m[39m
[31m       [31mÃ—[31m should handle logout without refresh token gracefully[39m[33m 936[2mms[22m[39m
[31m       [31mÃ—[31m should support multiple active refresh tokens per user[39m[33m 913[2mms[22m[39m
[31m       [31mÃ—[31m should revoke all user tokens on password reset[39m[33m 422[2mms[22m[39m
[31m       [31mÃ—[31m should use cryptographically strong random tokens[39m[33m 450[2mms[22m[39m
[31m       [31mÃ—[31m should hash refresh tokens before storing in database[39m[33m 443[2mms[22m[39m
[31m       [31mÃ—[31m should prevent refresh token reuse after rotation[39m[33m 437[2mms[22m[39m
[31m       [31mÃ—[31m should validate token ownership[39m[33m 463[2mms[22m[39m
[31m       [31mÃ—[31m should set HttpOnly flag to prevent XSS[39m[33m 442[2mms[22m[39m
[31m       [31mÃ—[31m should set SameSite=Strict to prevent CSRF[39m[33m 447[2mms[22m[39m
[31m       [31mÃ—[31m should set proper cookie path[39m[33m 452[2mms[22m[39m
[31m       [31mÃ—[31m should set appropriate expiry (30 days)[39m[33m 444[2mms[22m[39m
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w20_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w20_v3 (Reused: true)

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":50,"time":1768708961767,"env":"test","module":"auth-routes","email":"test-1768708961341-df2r6s@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":30,"time":1768708961786,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708961787,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

 [31mâ¯[39m tests/unit/repositories/WorkflowTemplateRepository.test.ts [2m([22m[2m19 tests[22m[2m | [22m[31m19 failed[39m[2m)[22m[33m 18440[2mms[22m[39m
[31m       [31mÃ—[31m should create a workflow template mapping[39m[33m 1111[2mms[22m[39m
[31m       [31mÃ—[31m should create non-primary mapping by default[39m[33m 763[2mms[22m[39m
[31m       [31mÃ—[31m should find all templates for a workflow version[39m[33m 729[2mms[22m[39m
[31m       [31mÃ—[31m should return empty array for version with no templates[39m[33m 722[2mms[22m[39m
[31m       [31mÃ—[31m should order by createdAt desc (newest first)[39m[33m 706[2mms[22m[39m
[31m       [31mÃ—[31m should find mapping by workflow version and key[39m[33m 813[2mms[22m[39m
[31m       [31mÃ—[31m should return undefined for non-existent key[39m[33m 743[2mms[22m[39m
[31m       [31mÃ—[31m should find primary template for workflow version[39m[33m 956[2mms[22m[39m
[31m       [31mÃ—[31m should return undefined when no primary template exists[39m[33m 813[2mms[22m[39m
[31m       [31mÃ—[31m should set a template as primary and unset others[39m[33m 761[2mms[22m[39m
[31m       [31mÃ—[31m should handle setting primary when none existed before[39m[33m 1252[2mms[22m[39m
[31m       [31mÃ—[31m should not delete mapping if workflow version does not match[39m[33m 709[2mms[22m[39m
[31m       [31mÃ—[31m should return true if key exists in workflow version[39m[33m 693[2mms[22m[39m
[31m       [31mÃ—[31m should return false if key does not exist[39m[33m 734[2mms[22m[39m
[31m       [31mÃ—[31m should exclude specified id when checking existence[39m[33m 721[2mms[22m[39m
[31m       [31mÃ—[31m should return true if key exists on different mapping[39m[33m 744[2mms[22m[39m
[31m       [31mÃ—[31m should update mapping fields[39m[33m 731[2mms[22m[39m
[31m       [31mÃ—[31m should find mapping by id[39m[33m 1034[2mms[22m[39m
[31m       [31mÃ—[31m should return undefined for non-existent id[39m[33m 755[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768708961862,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all trusted devices
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":30,"time":1768708961882,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":30,"time":1768708961883,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w18_v3, public
âœ… Enforced search_path: test_schema_w18_v3, public

 [31mâ¯[39m tests/integration/organizationInvites.test.ts [2m([22m[2m17 tests[22m[2m | [22m[31m16 failed[39m[2m)[22m[33m 18268[2mms[22m[39m
[31m       [31mÃ—[31m should create placeholder user for non-existent email[39m[33m 665[2mms[22m[39m
[31m       [31mÃ—[31m should create invite for existing user without creating placeholder[39m[33m 1249[2mms[22m[39m
[31m       [31mÃ—[31m should prevent duplicate pending invites[39m[33m 481[2mms[22m[39m
[31m       [31mÃ—[31m should prevent inviting existing members[39m[33m 931[2mms[22m[39m
       [33m[2mâœ“[22m[39m should require admin access to create invite [33m 1161[2mms[22m[39m
[31m       [31mÃ—[31m should set expiry to 7 days from now[39m[33m 780[2mms[22m[39m
[31m       [31mÃ—[31m should accept invite and create membership[39m[33m 1166[2mms[22m[39m
[31m       [31mÃ—[31m should convert placeholder user to real user on accept[39m[33m 770[2mms[22m[39m
[31m       [31mÃ—[31m should reject expired invite[39m[33m 1278[2mms[22m[39m
[31m       [31mÃ—[31m should reject already accepted invite[39m[33m 1152[2mms[22m[39m
[31m       [31mÃ—[31m should verify email matches invite[39m[33m 449[2mms[22m[39m
[31m       [31mÃ—[31m should reject invalid token[39m[33m 814[2mms[22m[39m
[31m       [31mÃ—[31m should return pending invites for user email[39m[33m 1153[2mms[22m[39m
[31m       [31mÃ—[31m should not return expired invites[39m[33m 1143[2mms[22m[39m
[31m       [31mÃ—[31m should not return accepted invites[39m[33m 807[2mms[22m[39m
[31m       [31mÃ—[31m should allow admin to revoke invite[39m[33m 506[2mms[22m[39m
[31m       [31mÃ—[31m should prevent accepting revoked invite[39m[33m 784[2mms[22m[39m
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w21_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mðŸ“Š Schema test_schema_w20_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w21_v3 (Reused: true)

{"level":30,"time":1768708962015,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708962016,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w20_v3\",public"}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w2_v3
âœ… Current search_path: test_schema_w15_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708962068,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w20_v3\",public"}
{"level":30,"time":1768708962068,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mðŸ“Š Schema test_schema_w21_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708962416,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708962417,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w21_v3\",public"}
{"level":30,"time":1768708962463,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w21_v3\",public"}
{"level":30,"time":1768708962463,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708962693,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708962693,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/ai/workflowEdit.test.ts [2m([22m[2m8 tests[22m[2m | [22m[33m8 skipped[39m[2m)[22m[33m 4065[2mms[22m[39m
     [2m[90mâ†“[39m[22m should create draft version on successful AI edit
     [2m[90mâ†“[39m[22m should enforce draft mode (revert active workflow to draft)
     [2m[90mâ†“[39m[22m should not create version when no changes detected (checksum match)
     [2m[90mâ†“[39m[22m should reject unauthorized access
     [2m[90mâ†“[39m[22m should reject unsafe DataVault operations
     [2m[90mâ†“[39m[22m should handle multi-operation edits with tempId resolution
     [2m[90mâ†“[39m[22m should create BEFORE and AFTER snapshots
     [2m[90mâ†“[39m[22m should rollback on validation failure
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w20_v3, public
âœ… Enforced search_path: test_schema_w20_v3, public

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w4_v3
âœ… Current search_path: test_schema_w4_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w21_v3, public
âœ… Enforced search_path: test_schema_w21_v3, public

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w1_v3
âœ… Current search_path: test_schema_w15_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768708963452,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768708963659,"env":"test","module":"auth-routes","email":"test-1768708963235-0lwo2@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768708963698,"env":"test","module":"auth","err":{"type":"Error","message":"User not found after upsert","stack":"Error: User not found after upsert\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:162:27\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google authentication failed"}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768708963791,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould include device metadata in sessions
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768708963797,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768708963889,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708963890,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/auth/oauth2.sessions.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m25 failed[39m[2m)[22m[33m 18229[2mms[22m[39m
[31m       [31mÃ—[31m should list all active sessions for current user[39m[32m 154[2mms[22m[39m
[31m       [31mÃ—[31m should mark current session as current[39m[33m 539[2mms[22m[39m
[31m       [31mÃ—[31m should return empty array when user has no active sessions[39m[33m 707[2mms[22m[39m
[31m       [31mÃ—[31m should not include expired sessions[39m[33m 445[2mms[22m[39m
[31m       [31mÃ—[31m should not include revoked sessions[39m[33m 450[2mms[22m[39m
[31m       [31mÃ—[31m should parse device name from user agent[39m[33m 433[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 for unauthenticated request[39m[33m 448[2mms[22m[39m
[31m       [31mÃ—[31m should revoke a specific session[39m[33m 443[2mms[22m[39m
[31m       [31mÃ—[31m should return 404 for non-existent session[39m[33m 926[2mms[22m[39m
[31m       [31mÃ—[31m should prevent revoking current session[39m[33m 1932[2mms[22m[39m
[31m       [31mÃ—[31m should prevent revoking another user's session[39m[33m 446[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 for unauthenticated request[39m[33m 426[2mms[22m[39m
[31m       [31mÃ—[31m should revoke all sessions except current[39m[33m 2243[2mms[22m[39m
[31m       [31mÃ—[31m should revoke all trusted devices[39m[33m 426[2mms[22m[39m
[31m       [31mÃ—[31m should return 400 when no active session found[39m[33m 425[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 for unauthenticated request[39m[33m 439[2mms[22m[39m
[31m         [31mÃ—[31m should mark current device as trusted[39m[33m 682[2mms[22m[39m
[31m         [31mÃ—[31m should update existing trusted device expiry[39m[33m 471[2mms[22m[39m
[31m         [31mÃ—[31m should list all trusted devices[39m[33m 443[2mms[22m[39m
[31m         [31mÃ—[31m should not include revoked devices[39m[33m 443[2mms[22m[39m
[31m         [31mÃ—[31m should revoke a trusted device[39m[33m 440[2mms[22m[39m
[31m         [31mÃ—[31m should return 404 for non-existent device[39m[33m 446[2mms[22m[39m
[31m       [31mÃ—[31m should track IP address for sessions[39m[33m 439[2mms[22m[39m
[31m       [31mÃ—[31m should track user agent for sessions[39m[33m 432[2mms[22m[39m
[31m       [31mÃ—[31m should update lastUsedAt on token refresh[39m[33m 426[2mms[22m[39m
{"level":50,"time":1768708964041,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:168:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
{"level":50,"time":1768708964042,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:168:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google authentication failed"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":50,"time":1768708964144,"env":"test","module":"auth-routes","email":"test-1768708963695-wkae04h@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":40,"time":1768708964149,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768708964149,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:158:23"},"msg":"Google token verification failed"}
{"level":50,"time":1768708964150,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:158:23"},"msg":"Google authentication failed"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768708964249,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Regeneration[2m > [22m[2mshould return error if MFA not enabled
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768708964257,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

{"level":50,"time":1768708964658,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["f88805cac40023e697b3ec4d9be81a9b","3d25847da2c69d6738861d5b7fdad3f2b3069c6ca7dd2a4a18f3bd4f67beed06","2026-02-17T04:02:44.575Z",false,"{\"ip\":\"::ffff:127.0.0.1\"}",null,"::ffff:127.0.0.1","Location Unknown","2026-01-18T04:02:44.575Z"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(f88805cac40023e697b3ec4d9be81a9b) is not present in table \"users\".","schema":"test_schema_w15_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mGET /api/auth/me[2m > [22m[2mshould return current user for valid token
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)
params: f88805cac40023e697b3ec4d9be81a9b,3d25847da2c69d6738861d5b7fdad3f2b3069c6ca7dd2a4a18f3bd4f67beed06,2026-02-17T04:02:44.575Z,false,{"ip":"::ffff:127.0.0.1"},,::ffff:127.0.0.1,Location Unknown,2026-01-18T04:02:44.575Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
    at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:150:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:325:24 {
  query: [32m'insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)'[39m,
  params: [
    [32m'f88805cac40023e697b3ec4d9be81a9b'[39m,
    [32m'3d25847da2c69d6738861d5b7fdad3f2b3069c6ca7dd2a4a18f3bd4f67beed06'[39m,
    [32m'2026-02-17T04:02:44.575Z'[39m,
    [33mfalse[39m,
    [32m'{"ip":"::ffff:127.0.0.1"}'[39m,
    [1mnull[22m,
    [32m'::ffff:127.0.0.1'[39m,
    [32m'Location Unknown'[39m,
    [32m'2026-01-18T04:02:44.575Z'[39m
  ],
  cause: error: insert or update on table "refresh_tokens" violates foreign key constraint "refresh_tokens_user_id_users_id_fk"
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
      at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:150:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:325:24 {
    length: [33m335[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23503'[39m,
    detail: [32m'Key (user_id)=(f88805cac40023e697b3ec4d9be81a9b) is not present in table "users".'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w15_v3'[39m,
    table: [32m'refresh_tokens'[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [32m'refresh_tokens_user_id_users_id_fk'[39m,
    file: [32m'ri_triggers.c'[39m,
    line: [32m'2599'[39m,
    routine: [32m'ri_ReportViolation'[39m
  }
}

{"level":50,"time":1768708964669,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w24_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w24_v3 (Reused: true)

{"level":50,"time":1768708964864,"env":"test","module":"auth-routes","email":"test-1768708964435-wen7i6@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768708964961,"env":"test","module":"auth","err":{"type":"DrizzleQueryError","message":"Failed query: insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"\nparams: google-user-refresh,refresh@example.com,Refresh,Test,,ca86efc6-2e12-41af-9b70-aafca0e21331,viewer,google,easy,true,,Refresh,Test,,2026-01-18T04:02:44.903Z: insert or update on table \"users\" violates foreign key constraint \"users_tenant_id_tenants_id_fk\"","stack":"Error: Failed query: insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"\nparams: google-user-refresh,refresh@example.com,Refresh,Test,,ca86efc6-2e12-41af-9b70-aafca0e21331,viewer,google,easy,true,,Refresh,Test,,2026-01-18T04:02:44.903Z\n    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:72:22)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7\ncaused by: error: insert or update on table \"users\" violates foreign key constraint \"users_tenant_id_tenants_id_fk\"\n    at C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\pg-pool\\index.js:45:11\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18\n    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:72:22)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7","query":"insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"","params":["google-user-refresh","refresh@example.com","Refresh","Test",null,"ca86efc6-2e12-41af-9b70-aafca0e21331","viewer","google","easy",true,null,"Refresh","Test",null,"2026-01-18T04:02:44.903Z"]},"userId":"google-user-refresh","msg":"Failed to upsert user during authentication"}
{"level":50,"time":1768708964962,"env":"test","module":"auth","err":{"type":"Error","message":"Failed to create or update user account","stack":"Error: Failed to create or update user account\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:73:11)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"msg":"Google authentication failed"}
{"level":50,"time":1768708964997,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould not expose sensitive token data
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768708965003,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768708965009,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708965010,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/collections.e2e.test.ts [2m([22m[2m22 tests[22m[2m | [22m[33m22 skipped[39m[2m)[22m[33m 3428[2mms[22m[39m
       [2m[90mâ†“[39m[22m should create a collection
       [2m[90mâ†“[39m[22m should list collections
       [2m[90mâ†“[39m[22m should get a collection by ID
       [2m[90mâ†“[39m[22m should update a collection
       [2m[90mâ†“[39m[22m should create text field
       [2m[90mâ†“[39m[22m should create email field
       [2m[90mâ†“[39m[22m should create number field
       [2m[90mâ†“[39m[22m should create select field with options
       [2m[90mâ†“[39m[22m should create boolean field
       [2m[90mâ†“[39m[22m should list all fields
       [2m[90mâ†“[39m[22m should update field
       [2m[90mâ†“[39m[22m should create a record
       [2m[90mâ†“[39m[22m should create multiple records
       [2m[90mâ†“[39m[22m should list records with pagination
       [2m[90mâ†“[39m[22m should get a single record
       [2m[90mâ†“[39m[22m should update a record
       [2m[90mâ†“[39m[22m should find records by filters
       [2m[90mâ†“[39m[22m should delete a record
       [2m[90mâ†“[39m[22m should list collections with stats
       [2m[90mâ†“[39m[22m should enforce required fields
       [2m[90mâ†“[39m[22m should validate field types
       [2m[90mâ†“[39m[22m should delete collection (cascade fields and records)
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mðŸ“Š Schema test_schema_w24_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708965138,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708965139,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w24_v3\",public"}
{"level":30,"time":1768708965191,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w24_v3\",public"}
{"level":30,"time":1768708965191,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/AuthService.test.ts[2m > [22m[2mAuthService[2m > [22m[2mJWT Token Management[2m > [22m[2mverifyToken()[2m > [22m[2mshould throw error for invalid token signature
[22m[39mDEBUG: verifyToken threw: Invalid or malformed token InvalidTokenError

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

{"level":50,"time":1768708965564,"env":"test","module":"auth","err":{"type":"DrizzleQueryError","message":"Failed query: insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"\nparams: google-user-idtoken,idtoken@example.com,,,,ca86efc6-2e12-41af-9b70-aafca0e21331,viewer,google,easy,true,,,,,2026-01-18T04:02:45.506Z: insert or update on table \"users\" violates foreign key constraint \"users_tenant_id_tenants_id_fk\"","stack":"Error: Failed query: insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"\nparams: google-user-idtoken,idtoken@example.com,,,,ca86efc6-2e12-41af-9b70-aafca0e21331,viewer,google,easy,true,,,,,2026-01-18T04:02:45.506Z\n    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:72:22)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7\ncaused by: error: insert or update on table \"users\" violates foreign key constraint \"users_tenant_id_tenants_id_fk\"\n    at C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\pg-pool\\index.js:45:11\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18\n    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:72:22)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7","query":"insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"","params":["google-user-idtoken","idtoken@example.com",null,null,null,"ca86efc6-2e12-41af-9b70-aafca0e21331","viewer","google","easy",true,null,null,null,null,"2026-01-18T04:02:45.506Z"]},"userId":"google-user-idtoken","msg":"Failed to upsert user during authentication"}
{"level":50,"time":1768708965565,"env":"test","module":"auth","err":{"type":"Error","message":"Failed to create or update user account","stack":"Error: Failed to create or update user account\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:73:11)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"msg":"Google authentication failed"}
{"level":50,"time":1768708965660,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768708965691,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":50,"time":1768708965715,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w19_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w19_v3 (Reused: true)

{"level":50,"time":1768708965923,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["fdb02e5be6c95aec20c50b720565aa29","a9c4cd18420626c0e5f7cdebdfa02d9f71578d6ba52f8cf7e27443e9e478ea73","2026-02-17T04:02:45.871Z",false,"{\"ip\":\"::ffff:127.0.0.1\"}",null,"::ffff:127.0.0.1","Location Unknown","2026-01-18T04:02:45.871Z"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(fdb02e5be6c95aec20c50b720565aa29) is not present in table \"users\".","schema":"test_schema_w15_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mTenant-Level MFA Enforcement[2m > [22m[2mshould enforce MFA for tenant users when required by tenant
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)
params: fdb02e5be6c95aec20c50b720565aa29,a9c4cd18420626c0e5f7cdebdfa02d9f71578d6ba52f8cf7e27443e9e478ea73,2026-02-17T04:02:45.871Z,false,{"ip":"::ffff:127.0.0.1"},,::ffff:127.0.0.1,Location Unknown,2026-01-18T04:02:45.871Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
    at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:150:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:325:24 {
  query: [32m'insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)'[39m,
  params: [
    [32m'fdb02e5be6c95aec20c50b720565aa29'[39m,
    [32m'a9c4cd18420626c0e5f7cdebdfa02d9f71578d6ba52f8cf7e27443e9e478ea73'[39m,
    [32m'2026-02-17T04:02:45.871Z'[39m,
    [33mfalse[39m,
    [32m'{"ip":"::ffff:127.0.0.1"}'[39m,
    [1mnull[22m,
    [32m'::ffff:127.0.0.1'[39m,
    [32m'Location Unknown'[39m,
    [32m'2026-01-18T04:02:45.871Z'[39m
  ],
  cause: error: insert or update on table "refresh_tokens" violates foreign key constraint "refresh_tokens_user_id_users_id_fk"
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
      at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:150:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:325:24 {
    length: [33m335[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23503'[39m,
    detail: [32m'Key (user_id)=(fdb02e5be6c95aec20c50b720565aa29) is not present in table "users".'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w15_v3'[39m,
    table: [32m'refresh_tokens'[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [32m'refresh_tokens_user_id_users_id_fk'[39m,
    file: [32m'ri_triggers.c'[39m,
    line: [32m'2599'[39m,
    routine: [32m'ri_ReportViolation'[39m
  }
}

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w24_v3, public
âœ… Enforced search_path: test_schema_w24_v3, public

{"level":30,"time":1768708966017,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708966017,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w18_v3
âœ… Current search_path: test_schema_w18_v3, public
â© Schema reused, skipping migrations.

 [31mâ¯[39m tests/integration/session.management.real.test.ts [2m([22m[2m18 tests[22m[2m | [22m[31m17 failed[39m[2m)[22m[33m 20339[2mms[22m[39m
[31m       [31mÃ—[31m should list all active sessions for current user[39m[33m 385[2mms[22m[39m
[31m       [31mÃ—[31m should mark current session correctly[39m[33m 709[2mms[22m[39m
[31m       [31mÃ—[31m should exclude revoked sessions[39m[33m 1846[2mms[22m[39m
[31m       [31mÃ—[31m should order sessions by last used (most recent first)[39m[33m 370[2mms[22m[39m
[31m       [31mÃ—[31m should filter sessions by current user only[39m[33m 677[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 401 for unauthenticated request [33m 401[2mms[22m[39m
[31m       [31mÃ—[31m should revoke specific session[39m[33m 362[2mms[22m[39m
[31m       [31mÃ—[31m should prevent revoking current session[39m[33m 2193[2mms[22m[39m
[31m       [31mÃ—[31m should return 404 for non-existent session[39m[33m 693[2mms[22m[39m
[31m       [31mÃ—[31m should prevent revoking other user's session[39m[33m 726[2mms[22m[39m
[31m       [31mÃ—[31m should revoke all other sessions[39m[33m 2135[2mms[22m[39m
[31m       [31mÃ—[31m should keep current session active[39m[33m 1424[2mms[22m[39m
[31m       [31mÃ—[31m should return 400 if no active session found[39m[33m 385[2mms[22m[39m
[31m       [31mÃ—[31m should revoke all trusted devices[39m[33m 1483[2mms[22m[39m
[31m       [31mÃ—[31m should handle user with single session gracefully[39m[33m 411[2mms[22m[39m
[31m       [31mÃ—[31m should include device metadata in sessions[39m[33m 1540[2mms[22m[39m
[31m       [31mÃ—[31m should not expose sensitive token data[39m[33m 1205[2mms[22m[39m
[31m       [31mÃ—[31m should track session activity timestamps[39m[33m 422[2mms[22m[39m
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mðŸ“Š Schema test_schema_w19_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708966329,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708966330,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w19_v3\",public"}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708966385,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w19_v3\",public"}
{"level":30,"time":1768708966385,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768708966417,"env":"test","module":"auth","err":{"type":"Error","message":"User not found after upsert","stack":"Error: User not found after upsert\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:162:27\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google authentication failed"}
{"level":30,"time":1768708966511,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708966511,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/variableSafety.test.ts [2m([22m[2m4 tests[22m[2m | [22m[31m4 failed[39m[2m)[22m[33m 5347[2mms[22m[39m
[31m     [31mÃ—[31m REPRO: ScriptEngine fails to resolve alias 'input_variable' when aliasMap is NOT provided[39m[33m 322[2mms[22m[39m
[31m     [31mÃ—[31m ScriptEngine resolves alias 'input_variable' when aliasMap is provided[39m[33m 532[2mms[22m[39m
[31m     [31mÃ—[31m REPRO: BlockRunner fails to resolve alias in CreateRecordConfig[39m[33m 499[2mms[22m[39m
[31m     [31mÃ—[31m BlockRunner logic resolves alias with aliasMap[39m[33m 501[2mms[22m[39m
{"level":50,"time":1768708966619,"env":"test","module":"auth","err":{"type":"Error","message":"Token verification failed","stack":"Error: Token verification failed\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:431:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

{"level":40,"time":1768708966717,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768708966717,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
{"level":30,"time":1768708966787,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708966787,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708966800,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":50,"time":1768708966815,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token payload","stack":"Error: Invalid token payload\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:88:26)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
{"level":30,"time":1768708966843,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708966844,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708966866,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708966867,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mâœ… Applied failsafe schema fixes

 [31mâ¯[39m tests/integration/auth.routes.real.test.ts [2m([22m[2m26 tests[22m[2m | [22m[31m18 failed[39m[2m)[22m[33m 21110[2mms[22m[39m
[31m       [31mÃ—[31m should register a new user successfully[39m[33m 478[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 400 for invalid email format [33m 395[2mms[22m[39m
       [32mâœ“[39m should return 400 for weak password[32m 53[2mms[22m[39m
[31m       [31mÃ—[31m should return 409 for duplicate email[39m[33m 1214[2mms[22m[39m
[31m       [31mÃ—[31m should set httpOnly refresh token cookie[39m[33m 763[2mms[22m[39m
[31m       [31mÃ—[31m should login with valid credentials[39m[33m 716[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 for invalid password[39m[33m 2219[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 401 for non-existent user [33m 552[2mms[22m[39m
[31m       [31mÃ—[31m should return 403 for unverified email[39m[33m 1375[2mms[22m[39m
[31m       [31mÃ—[31m should record failed login attempt[39m[33m 364[2mms[22m[39m
[31m       [31mÃ—[31m should return requiresMfa=true for MFA-enabled users[39m[33m 1204[2mms[22m[39m
[31m       [31mÃ—[31m should lock account after 5 failed attempts[39m[33m 696[2mms[22m[39m
[31m       [31mÃ—[31m should logout and clear refresh token cookie[39m[33m 713[2mms[22m[39m
[31m       [31mÃ—[31m should refresh access token with valid refresh token[39m[33m 712[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 401 for missing refresh token [33m 400[2mms[22m[39m
[31m       [31mÃ—[31m should rotate refresh token after use[39m[33m 415[2mms[22m[39m
[31m       [31mÃ—[31m should send password reset email for existing user[39m[33m 714[2mms[22m[39m
       [33m[2mâœ“[22m[39m should not reveal if email exists (security) [33m 456[2mms[22m[39m
[31m       [31mÃ—[31m should reset password with valid token[39m[33m 377[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 400 for invalid token [33m 450[2mms[22m[39m
[31m       [31mÃ—[31m should return 400 for weak new password[39m[33m 394[2mms[22m[39m
[31m       [31mÃ—[31m should return current user for valid token[39m[33m 2285[2mms[22m[39m
       [32mâœ“[39m should return 401 for missing token[32m 59[2mms[22m[39m
       [32mâœ“[39m should return 401 for invalid token[32m 55[2mms[22m[39m
[31m         [31mÃ—[31m should complete MFA login with valid TOTP code[39m[33m 653[2mms[22m[39m
[31m         [31mÃ—[31m should reject invalid MFA code[39m[33m 416[2mms[22m[39m
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":30,"time":1768708966926,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708966926,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/auth/oauth2.google.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m5 failed[39m[2m)[22m[33m 6608[2mms[22m[39m
[31m       [31mÃ—[31m should successfully authenticate with valid Google ID token[39m[33m 458[2mms[22m[39m
       [32mâœ“[39m should return 400 when ID token is missing[32m 118[2mms[22m[39m
       [32mâœ“[39m should return 403 when Origin header is invalid[32m 110[2mms[22m[39m
       [32mâœ“[39m should return 401 when Google token verification fails[32m 104[2mms[22m[39m
       [32mâœ“[39m should return 401 when email is not verified by Google[32m 109[2mms[22m[39m
[31m       [31mÃ—[31m should update existing user on subsequent logins[39m[32m 198[2mms[22m[39m
[31m       [31mÃ—[31m should create refresh token record in database[39m[33m 615[2mms[22m[39m
[31m       [31mÃ—[31m should support both "token" and "idToken" fields[39m[33m 601[2mms[22m[39m
       [33m[2mâœ“[22m[39m should respect rate limiting [33m 447[2mms[22m[39m
[31m       [31mÃ—[31m should handle missing profile information gracefully[39m[33m 406[2mms[22m[39m
       [32mâœ“[39m should verify valid Google ID token[32m 95[2mms[22m[39m
       [32mâœ“[39m should throw error when token verification fails[32m 106[2mms[22m[39m
       [32mâœ“[39m should throw error when email is not verified[32m 96[2mms[22m[39m
       [32mâœ“[39m should throw error when payload is null[32m 98[2mms[22m[39m
 [31mâ¯[39m tests/integration/ownershipAccess.test.ts [2m([22m[2m19 tests[22m[2m | [22m[31m6 failed[39m[2m)[22m[33m 13300[2mms[22m[39m
       [32mâœ“[39m should allow access to user-owned asset by owner[32m 245[2mms[22m[39m
       [32mâœ“[39m should deny access to user-owned asset by non-owner[32m 246[2mms[22m[39m
[31m       [31mÃ—[31m should allow access to org-owned asset by org member[39m[33m 381[2mms[22m[39m
       [33m[2mâœ“[22m[39m should deny access to org-owned asset by non-member [33m 312[2mms[22m[39m
       [32mâœ“[39m should allow access to null ownership (legacy data)[32m 232[2mms[22m[39m
[31m       [31mÃ—[31m should return true for org member[39m[33m 361[2mms[22m[39m
       [32mâœ“[39m should return false for non-member[32m 275[2mms[22m[39m
[31m       [31mÃ—[31m should return true for org admin[39m[33m 369[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return true for org admin [33m 329[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return false for org member (non-admin) [33m 363[2mms[22m[39m
       [32mâœ“[39m should return false for non-member[32m 281[2mms[22m[39m
[31m       [31mÃ—[31m should return all org IDs for a user[39m[33m 644[2mms[22m[39m
       [32mâœ“[39m should return empty array for user with no memberships[32m 276[2mms[22m[39m
       [32mâœ“[39m should allow creating user-owned asset if ownerUuid matches userId[32m 239[2mms[22m[39m
       [32mâœ“[39m should deny creating user-owned asset if ownerUuid does not match userId[32m 242[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow creating org-owned asset if user is member [33m 385[2mms[22m[39m
       [33m[2mâœ“[22m[39m should deny creating org-owned asset if user is not member [33m 304[2mms[22m[39m
[31m       [31mÃ—[31m should not allow member of org1 to access org2-owned assets[39m[33m 664[2mms[22m[39m
[31m       [31mÃ—[31m should allow member of multiple orgs to access all their org assets[39m[33m 420[2mms[22m[39m
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w28_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [31mâ¯[39m tests/integration/mfa.flow.real.test.ts [2m([22m[2m20 tests[22m[2m | [22m[31m20 failed[39m[2m)[22m[33m 21166[2mms[22m[39m
[31m       [31mÃ—[31m should complete full MFA setup flow[39m[33m 374[2mms[22m[39m
[31m       [31mÃ—[31m should reject invalid TOTP code during setup[39m[33m 708[2mms[22m[39m
[31m       [31mÃ—[31m should not allow MFA setup if already enabled[39m[33m 709[2mms[22m[39m
[31m       [31mÃ—[31m should generate unique backup codes[39m[33m 1546[2mms[22m[39m
[31m       [31mÃ—[31m should store hashed backup codes[39m[33m 396[2mms[22m[39m
[31m       [31mÃ—[31m should require MFA for enabled users[39m[33m 1187[2mms[22m[39m
[31m       [31mÃ—[31m should complete MFA login with valid TOTP[39m[33m 881[2mms[22m[39m
[31m       [31mÃ—[31m should reject invalid TOTP during login[39m[33m 851[2mms[22m[39m
[31m       [31mÃ—[31m should accept TOTP codes within 60-second window[39m[33m 720[2mms[22m[39m
[31m       [31mÃ—[31m should login with valid backup code[39m[33m 693[2mms[22m[39m
[31m       [31mÃ—[31m should mark backup code as used[39m[33m 861[2mms[22m[39m
[31m       [31mÃ—[31m should prevent backup code reuse[39m[33m 1187[2mms[22m[39m
[31m       [31mÃ—[31m should try TOTP before backup code[39m[33m 382[2mms[22m[39m
[31m       [31mÃ—[31m should return MFA status for user[39m[33m 1500[2mms[22m[39m
[31m       [31mÃ—[31m should return backup codes count for MFA users[39m[33m 374[2mms[22m[39m
[31m       [31mÃ—[31m should disable MFA with password verification[39m[33m 728[2mms[22m[39m
[31m       [31mÃ—[31m should require correct password to disable MFA[39m[33m 743[2mms[22m[39m
[31m       [31mÃ—[31m should regenerate backup codes[39m[33m 749[2mms[22m[39m
[31m       [31mÃ—[31m should return error if MFA not enabled[39m[33m 1568[2mms[22m[39m
[31m       [31mÃ—[31m should enforce MFA for tenant users when required by tenant[39m[33m 1975[2mms[22m[39m
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w28_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w19_v3, public
âœ… Enforced search_path: test_schema_w19_v3, public

{"level":30,"time":1768708967196,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w19_v3
âœ… Current search_path: test_schema_w18_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mðŸ“Š Schema test_schema_w28_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708967463,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708967464,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w28_v3\",public"}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

{"level":30,"time":1768708967518,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w28_v3\",public"}
{"level":30,"time":1768708967518,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstderr[2m | tests/integration/analytics_service.test.ts[2m > [22m[2mAnalytics Service Integration
[22m[39mMANUAL PATCH FAILED DrizzleQueryError: Failed query: ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "workflow_runs"("id") ON DELETE CASCADE
params: 
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/analytics_service.test.ts:28:13 {
  query: [32m'ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "workflow_runs"("id") ON DELETE CASCADE'[39m,
  params: [],
  cause: error: constraint "workflow_run_metrics_run_id_workflow_runs_id_fk" for relation "workflow_run_metrics" already exists
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/analytics_service.test.ts:28:13 {
    length: [33m179[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42710'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'tablecmds.c'[39m,
    line: [32m'9387'[39m,
    routine: [32m'ATExecAddConstraint'[39m
  }
}

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w22_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w22_v3 (Reused: true)

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w28_v3, public
âœ… Enforced search_path: test_schema_w28_v3, public

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708968361,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w24_v3
âœ… Current search_path: test_schema_w18_v3, public
â© Schema reused, skipping migrations.

 [31mâ¯[39m tests/unit/services/AuthService.test.ts [2m([22m[2m113 tests[22m[2m | [22m[31m13 failed[39m[2m)[22m[33m 12270[2mms[22m[39m
         [32mâœ“[39m should hash a password using bcrypt with 12 rounds[32m 243[2mms[22m[39m
         [33m[2mâœ“[22m[39m should generate different hashes for same password [33m 461[2mms[22m[39m
         [32mâœ“[39m should handle empty passwords[32m 230[2mms[22m[39m
         [32mâœ“[39m should handle long passwords[32m 230[2mms[22m[39m
         [32mâœ“[39m should handle unicode characters in password[32m 238[2mms[22m[39m
         [33m[2mâœ“[22m[39m should return true for correct password [33m 462[2mms[22m[39m
         [33m[2mâœ“[22m[39m should return false for incorrect password [33m 483[2mms[22m[39m
         [33m[2mâœ“[22m[39m should be case-sensitive [33m 483[2mms[22m[39m
         [33m[2mâœ“[22m[39m should handle empty password comparison [33m 496[2mms[22m[39m
         [32mâœ“[39m should accept valid email addresses[32m 2[2mms[22m[39m
         [32mâœ“[39m should reject emails longer than 254 characters (RFC 5321)[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject emails shorter than 3 characters[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject emails with consecutive dots[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject emails without @ symbol[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject emails without domain[32m 2[2mms[22m[39m
         [32mâœ“[39m should reject emails with spaces[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject emails without TLD[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject null or undefined[32m 9[2mms[22m[39m
         [32mâœ“[39m should reject emails with local part longer than 64 characters[32m 1[2mms[22m[39m
         [32mâœ“[39m should accept valid strong passwords[32m 55[2mms[22m[39m
         [32mâœ“[39m should reject passwords shorter than 8 characters[32m 2[2mms[22m[39m
         [32mâœ“[39m should reject passwords longer than 128 characters[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject weak passwords with zxcvbn score < 3[32m 8[2mms[22m[39m
         [32mâœ“[39m should provide helpful feedback for weak passwords[32m 5[2mms[22m[39m
         [32mâœ“[39m should reject password containing user's email[32m 5[2mms[22m[39m
         [32mâœ“[39m should reject password containing user's name[32m 4[2mms[22m[39m
         [32mâœ“[39m should accept strong password even with user inputs provided[32m 6[2mms[22m[39m
         [32mâœ“[39m should accept password with exactly 8 characters if strong enough[32m 2[2mms[22m[39m
         [32mâœ“[39m should accept password with exactly 128 characters if strong[32m 156[2mms[22m[39m
         [32mâœ“[39m should return score in result object[32m 6[2mms[22m[39m
         [32mâœ“[39m should create a valid JWT token for a user[32m 6[2mms[22m[39m
         [32mâœ“[39m should include userId, email, tenantId, and role in token payload[32m 3[2mms[22m[39m
         [32mâœ“[39m should set token expiry to 15 minutes by default[32m 2[2mms[22m[39m
         [32mâœ“[39m should throw error if JWT_SECRET is not configured[32m 2[2mms[22m[39m
         [32mâœ“[39m should handle null tenantId and role[32m 2[2mms[22m[39m
         [32mâœ“[39m should verify and decode a valid token[32m 4[2mms[22m[39m
         [33m[2mâœ“[22m[39m should throw error for expired token [33m 1105[2mms[22m[39m
         [32mâœ“[39m should throw error for invalid token signature[32m 3[2mms[22m[39m
         [32mâœ“[39m should throw error for malformed token[32m 2[2mms[22m[39m
         [32mâœ“[39m should throw error for invalid token[32m 2[2mms[22m[39m
         [32mâœ“[39m should extract token from Bearer authorization header[32m 1[2mms[22m[39m
         [32mâœ“[39m should return token if no Bearer prefix[32m 1[2mms[22m[39m
         [32mâœ“[39m should return null for undefined header[32m 1[2mms[22m[39m
         [32mâœ“[39m should return null for empty header[32m 2[2mms[22m[39m
         [32mâœ“[39m should handle Bearer with multiple spaces[32m 1[2mms[22m[39m
         [32mâœ“[39m should return true for JWT-like tokens[32m 2[2mms[22m[39m
         [32mâœ“[39m should return false for non-JWT tokens[32m 2[2mms[22m[39m
         [32mâœ“[39m should return false for empty token[32m 2[2mms[22m[39m
         [32mâœ“[39m should return false for null/undefined[32m 2[2mms[22m[39m
         [32mâœ“[39m should create a valid portal token for an email[32m 3[2mms[22m[39m
         [32mâœ“[39m should include email and portal flag in token payload[32m 3[2mms[22m[39m
         [32mâœ“[39m should set token expiry to 24 hours[32m 2[2mms[22m[39m
         [32mâœ“[39m should verify and decode a valid portal token[32m 2[2mms[22m[39m
         [32mâœ“[39m should throw error for non-portal token[32m 3[2mms[22m[39m
         [32mâœ“[39m should throw error for token without email[32m 3[2mms[22m[39m
         [32mâœ“[39m should throw error for expired portal token[32m 2[2mms[22m[39m
[31m         [31mÃ—[31m should generate password reset token for existing user[39m[32m 249[2mms[22m[39m
         [32mâœ“[39m should return null for non-existent user[32m 2[2mms[22m[39m
[31m         [31mÃ—[31m should invalidate previous reset tokens[39m[32m 3[2mms[22m[39m
         [32mâœ“[39m should return userId for valid token[32m 2[2mms[22m[39m
         [32mâœ“[39m should return null for invalid token[32m 2[2mms[22m[39m
         [32mâœ“[39m should return null for expired token[32m 2[2mms[22m[39m
         [32mâœ“[39m should return null for used token[32m 2[2mms[22m[39m
         [32mâœ“[39m should mark token as used[32m 4[2mms[22m[39m
         [32mâœ“[39m should generate verification token[32m 2[2mms[22m[39m
         [32mâœ“[39m should have 24 hour expiry[32m 2[2mms[22m[39m
         [32mâœ“[39m should verify email with valid token[32m 2[2mms[22m[39m
         [32mâœ“[39m should return false for invalid token[32m 1[2mms[22m[39m
         [32mâœ“[39m should return false for expired token[32m 2[2mms[22m[39m
         [32mâœ“[39m should delete token after successful verification[32m 2[2mms[22m[39m
         [32mâœ“[39m should create refresh token with 30-day expiry[32m 4[2mms[22m[39m
         [32mâœ“[39m should store device metadata[32m 2[2mms[22m[39m
         [32mâœ“[39m should return userId for valid token[32m 2[2mms[22m[39m
         [32mâœ“[39m should return null for revoked token[32m 1[2mms[22m[39m
         [32mâœ“[39m should return null for expired token[32m 2[2mms[22m[39m
[31m         [31mÃ—[31m should rotate valid token and return new one[39m[32m 2[2mms[22m[39m
[31m         [31mÃ—[31m should return null for unknown token[39m[32m 2[2mms[22m[39m
[31m         [31mÃ—[31m should revoke all tokens on reuse detection[39m[32m 3[2mms[22m[39m
[31m         [31mÃ—[31m should return null for expired token[39m[32m 2[2mms[22m[39m
         [32mâœ“[39m should revoke specific token[32m 3[2mms[22m[39m
         [32mâœ“[39m should revoke all tokens for user[32m 2[2mms[22m[39m
[31m         [31mÃ—[31m should cleanup expired refresh tokens[39m[32m 3[2mms[22m[39m
[31m         [31mÃ—[31m should cleanup expired password reset tokens[39m[32m 3[2mms[22m[39m
[31m         [31mÃ—[31m should cleanup expired email verification tokens[39m[32m 3[2mms[22m[39m
[31m         [31mÃ—[31m should cleanup old login attempts via accountLockoutService[39m[32m 2[2mms[22m[39m
         [32mâœ“[39m should use JWT_SECRET if provided[32m 2[2mms[22m[39m
         [32mâœ“[39m should warn if JWT_SECRET is less than 32 characters[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject token with modified payload[32m 2[2mms[22m[39m
         [32mâœ“[39m should reject token with valid structure but invalid signature[32m 2[2mms[22m[39m
         [33m[2mâœ“[22m[39m should handle password with special characters [33m 497[2mms[22m[39m
         [32mâœ“[39m should handle password with only spaces[32m 247[2mms[22m[39m
         [33m[2mâœ“[22m[39m should handle password with newlines and tabs [33m 468[2mms[22m[39m
         [33m[2mâœ“[22m[39m should reject password with null bytes (if validation exists) [33m 488[2mms[22m[39m
         [32mâœ“[39m should reject email with unicode domain (security fix)[32m 2[2mms[22m[39m
         [32mâœ“[39m should reject email starting with dot (security fix)[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject email ending with dot before @ (security fix)[32m 1[2mms[22m[39m
         [32mâœ“[39m should handle email with plus addressing[32m 1[2mms[22m[39m
         [32mâœ“[39m should handle email with subdomain[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject email with invalid TLD (single char)[32m 1[2mms[22m[39m
         [32mâœ“[39m should accept email with numeric TLD[32m 2[2mms[22m[39m
         [32mâœ“[39m should prevent timing attacks on token validation[32m 4[2mms[22m[39m
[31m         [31mÃ—[31m should support full user authentication lifecycle[39m[32m 249[2mms[22m[39m
[31m         [31mÃ—[31m should support complete password reset workflow[39m[32m 2[2mms[22m[39m
[31m         [31mÃ—[31m should prevent reuse of password reset tokens[39m[32m 2[2mms[22m[39m
         [32mâœ“[39m should support multiple valid refresh tokens per user[32m 3[2mms[22m[39m
         [32mâœ“[39m should revoke all user tokens on security event[32m 2[2mms[22m[39m
         [32mâœ“[39m should handle database connection failures gracefully[32m 3[2mms[22m[39m
         [32mâœ“[39m should handle transaction failures[32m 3[2mms[22m[39m
         [32mâœ“[39m should throw error if JWT signing fails[32m 2[2mms[22m[39m
         [32mâœ“[39m should hash password in reasonable time (< 500ms)[32m 252[2mms[22m[39m
         [33m[2mâœ“[22m[39m should compare password in reasonable time (< 500ms) [33m 490[2mms[22m[39m
         [32mâœ“[39m should create JWT token in < 10ms[32m 3[2mms[22m[39m
         [32mâœ“[39m should verify JWT token in < 50ms[32m 3[2mms[22m[39m
{"level":30,"time":1768708968466,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768708968491,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/js_helpers.test.ts[2m > [22m[2mDetailed Verification: JS Helper Availability
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708968477,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708968478,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708968483,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708968484,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708968490,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708968490,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708968491,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708968491,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

{"level":30,"time":1768708968628,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708968628,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mðŸ“Š Schema test_schema_w22_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708968674,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708968675,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w22_v3\",public"}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w27_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708968749,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w22_v3\",public"}
{"level":30,"time":1768708968750,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w27_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

 [31mâ¯[39m tests/integration/js_helpers.test.ts [2m([22m[2m1 test[22m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 3160[2mms[22m[39m
     [2m[90mâ†“[39m[22m should execute a JS block that uses helper functions
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mðŸ“Š Schema test_schema_w27_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708969188,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708969189,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w27_v3\",public"}
{"level":30,"time":1768708969249,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w27_v3\",public"}
{"level":30,"time":1768708969249,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w22_v3, public
âœ… Enforced search_path: test_schema_w22_v3, public

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w22_v3
âœ… Current search_path: test_schema_w27_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w23_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w23_v3 (Reused: true)

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w27_v3, public
âœ… Enforced search_path: test_schema_w27_v3, public

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w25_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w25_v3 (Reused: true)

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w28_v3
âœ… Current search_path: test_schema_w22_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mðŸ“Š Schema test_schema_w23_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708970204,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708970205,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w23_v3\",public"}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

{"level":30,"time":1768708970261,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w23_v3\",public"}
{"level":30,"time":1768708970261,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[DEBUG] BaseRepository.update workflow_runs: id=213508c1-27d0-473b-9c23-28f5b0ef61fb, updates={"completed":true,"completedAt":"2026-01-18T04:02:50.410Z","progress":100}
{"level":30,"time":1768708970463,"env":"test","module":"writeback-execution-service","runId":"213508c1-27d0-473b-9c23-28f5b0ef61fb","workflowId":"0cca51ff-5ab6-4b90-b516-97383ee80614","msg":"Executing writeback mappings for completed run"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708970492,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708970492,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708970513,"env":"test","runId":"213508c1-27d0-473b-9c23-28f5b0ef61fb","service":"DocumentGenerationService","msg":"Starting document generation for run"}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [31mâ¯[39m tests/integration/organizations-audit-fixes.test.ts [2m([22m[2m8 tests[22m[2m | [22m[33m8 skipped[39m[2m)[22m[33m 3880[2mms[22m[39m
       [2m[90mâ†“[39m[22m should cascade ownership to workflow runs when project is transferred
       [2m[90mâ†“[39m[22m should prevent double-acceptance via transaction
       [2m[90mâ†“[39m[22m should not create invite if email fails
       [2m[90mâ†“[39m[22m should allow re-invite after invite expires
       [2m[90mâ†“[39m[22m should allow last admin to delete empty organization
       [2m[90mâ†“[39m[22m should prevent deletion if org owns assets
       [2m[90mâ†“[39m[22m should cleanup placeholder user when invite is revoked
       [2m[90mâ†“[39m[22m should fail fast on non-existent org
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mðŸ“Š Schema test_schema_w25_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708970557,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708970557,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w25_v3\",public"}
{"level":50,"time":1768708970567,"env":"test","runId":"213508c1-27d0-473b-9c23-28f5b0ef61fb","service":"DocumentGenerationService","error":{"message":"Workflow run not found","stack":"ApiError: Workflow run not found\n    at Object.notFound (C:/Users/scoot/poll/VaultLogic/server/utils/errors.ts:88:12)\n    at DocumentGenerationService.generateDocumentsForRun (C:/Users/scoot/poll/VaultLogic/server/services/DocumentGenerationService.ts:48:27)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at RunLifecycleService.generateDocuments (C:/Users/scoot/poll/VaultLogic/server/services/workflow-runs/RunLifecycleService.ts:319:7)\n    at RunCompletionService.completeRun (C:/Users/scoot/poll/VaultLogic/server/services/workflow-runs/RunCompletionService.ts:90:13)\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/analytics_service.test.ts:88:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:20","name":"ApiError"},"errorType":"object","errorConstructor":"ApiError","msg":"Document generation failed"}
{"level":50,"time":1768708970567,"env":"test","error":{"error":{"code":"NOT_FOUND","message":""}},"runId":"213508c1-27d0-473b-9c23-28f5b0ef61fb","msg":"Document generation failed"}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708970621,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w25_v3\",public"}
{"level":30,"time":1768708970621,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708970669,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708970670,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768708970845,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

 [31mâ¯[39m tests/integration/analytics_service.test.ts [2m([22m[2m1 test[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 6376[2mms[22m[39m
[31m     [31mÃ—[31m should generate events and metrics on run completion[39m[33m 1963[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708970872,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768708970857,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708970858,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708970864,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708970865,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708970871,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708970871,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708970872,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708970872,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w23_v3, public
âœ… Enforced search_path: test_schema_w23_v3, public

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w25_v3
âœ… Current search_path: test_schema_w25_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w26_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w26_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w25_v3, public
âœ… Enforced search_path: test_schema_w25_v3, public

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768708971443,"env":"test","module":"user-credentials-repository","userId":"e819f6c9-5c72-4c1b-9946-4215d282f926","msg":"User credentials created"}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w25_v3
âœ… Current search_path: test_schema_w22_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708971696,"env":"test","module":"email-queue","jobId":"bc2c03ad-fa57-42c1-aa95-3e72f08961a1","to":"test-GceOA3A5aIYPtYtIOYdQg@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mðŸ“Š Schema test_schema_w26_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708971731,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708971732,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w26_v3\",public"}
{"level":50,"time":1768708971775,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["e819f6c9-5c72-4c1b-9946-4215d282f926","99e81815bdc44da8810df3e32abb73121157c1da837df2e8257aac75017d0120","2026-02-17T04:02:51.701Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-18T04:02:51.701Z"],"cause":{"length":339,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(e819f6c9-5c72-4c1b-9946-4215d282f926) is not present in table \"users\".","schema":"test_schema_w23_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

{"level":30,"time":1768708971789,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708971790,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w26_v3\",public"}
{"level":30,"time":1768708971789,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708971790,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708971871,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708971872,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mDEBUG: Existing functions: []

 [31mâ¯[39m tests/integration/dataBlocks.test.ts [2m([22m[2m2 tests[22m[2m | [22m[33m2 skipped[39m[2m)[22m[33m 3540[2mms[22m[39m
     [2m[90mâ†“[39m[22m should write data to DataVault via WriteBlock
     [2m[90mâ†“[39m[22m should query data from DataVault via QueryBlock and use in Logic
 [31mâ¯[39m tests/integration/auth/protected.routes.test.ts [2m([22m[2m33 tests[22m[2m | [22m[33m33 skipped[39m[2m)[22m[33m 3958[2mms[22m[39m
       [2m[90mâ†“[39m[22m should allow access with valid Bearer token
       [2m[90mâ†“[39m[22m should reject access without Authorization header
       [2m[90mâ†“[39m[22m should reject access with empty Bearer token
       [2m[90mâ†“[39m[22m should reject access with malformed Authorization header
       [2m[90mâ†“[39m[22m should reject access with wrong token type
       [2m[90mâ†“[39m[22m should allow POST with valid Bearer token
       [2m[90mâ†“[39m[22m should reject POST without Bearer token
       [2m[90mâ†“[39m[22m should reject POST with invalid token
       [2m[90mâ†“[39m[22m should allow PUT with valid Bearer token
       [2m[90mâ†“[39m[22m should reject PUT without Bearer token
       [2m[90mâ†“[39m[22m should allow DELETE with valid Bearer token
       [2m[90mâ†“[39m[22m should reject DELETE without Bearer token
       [2m[90mâ†“[39m[22m should allow PATCH with valid Bearer token
       [2m[90mâ†“[39m[22m should reject PATCH without Bearer token
       [2m[90mâ†“[39m[22m should handle Bearer token with extra spaces
       [2m[90mâ†“[39m[22m should handle token with newlines
       [2m[90mâ†“[39m[22m should handle very long invalid token
       [2m[90mâ†“[39m[22m should handle empty Authorization header
       [2m[90mâ†“[39m[22m should handle Authorization header with only Bearer
       [2m[90mâ†“[39m[22m should handle multiple Authorization headers
       [2m[90mâ†“[39m[22m should reject token with SQL injection attempt
       [2m[90mâ†“[39m[22m should reject token with XSS attempt
       [2m[90mâ†“[39m[22m should reject token with missing userId
       [2m[90mâ†“[39m[22m should reject token with non-existent userId
       [2m[90mâ†“[39m[22m should not allow user to access another user's resources
       [2m[90mâ†“[39m[22m should inject userId into request context
       [2m[90mâ†“[39m[22m should inject tenantId into request context
       [2m[90mâ†“[39m[22m should inject role into request context
       [2m[90mâ†“[39m[22m should not apply general rate limiting to authenticated requests
       [2m[90mâ†“[39m[22m should handle request with both Bearer token and cookies
       [2m[90mâ†“[39m[22m should prioritize Bearer token over cookie when both present
       [2m[90mâ†“[39m[22m should allow unauthenticated access to optional auth routes
       [2m[90mâ†“[39m[22m should enhance optional auth routes with user context when authenticated
{"level":30,"time":1768708972256,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768708972282,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.snapshots.test.ts[2m > [22m[2mStage 13: Workflow Snapshots & Versioning
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708972268,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708972269,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708972275,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708972276,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708972282,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708972282,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708972282,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708972282,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w36_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w36_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":30,"time":1768708972574,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w26_v3, public
âœ… Enforced search_path: test_schema_w26_v3, public

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768708972662,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768708972687,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts[2m > [22m[2mRuns API - DOCX Generation Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708972673,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708972674,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708972680,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708972681,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708972687,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708972687,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708972687,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708972687,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w23_v3
âœ… Current search_path: test_schema_w25_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mðŸ“Š Schema test_schema_w36_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708972830,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708972831,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w36_v3\",public"}
{"level":30,"time":1768708972891,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w36_v3\",public"}
{"level":30,"time":1768708972891,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708972950,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708973319,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708973319,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768708973321,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["7e121583-ad1d-4cb6-ac21-60c84d24db0a","$2b$12$mB.Krjp1Jfw8T3aLt9ACR.JN0PDe9tBJXlW3U77.1jtWuXjjUmJlO"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(7e121583-ad1d-4cb6-ac21-60c84d24db0a) is not present in table \"users\".","schema":"test_schema_w36_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"7e121583-ad1d-4cb6-ac21-60c84d24db0a","msg":"Failed to create user credentials"}
{"level":50,"time":1768708973321,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["7e121583-ad1d-4cb6-ac21-60c84d24db0a","$2b$12$mB.Krjp1Jfw8T3aLt9ACR.JN0PDe9tBJXlW3U77.1jtWuXjjUmJlO"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(7e121583-ad1d-4cb6-ac21-60c84d24db0a) is not present in table \"users\".","schema":"test_schema_w36_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w37_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w37_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708973596,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mDEBUG: Existing functions: []

 [31mâ¯[39m tests/integration/api.snapshots.test.ts [2m([22m[2m1 test[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 3984[2mms[22m[39m
[31m     [31mÃ—[31m should maintain immutability of runs across versions[39m[32m 124[2mms[22m[39m
{"level":30,"time":1768708973668,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w36_v3, public
âœ… Enforced search_path: test_schema_w36_v3, public

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w23_v3
âœ… Current search_path: test_schema_w23_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708973827,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708973827,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708973906,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mðŸ“Š Schema test_schema_w37_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708973921,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708973922,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w37_v3\",public"}
{"level":30,"time":1768708973931,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.projects.test.ts[2m > [22m[2mProjects API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708973918,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708973918,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708973925,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708973925,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708973931,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708973931,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708973931,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708973931,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768708973918,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768708973973,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w37_v3\",public"}
{"level":30,"time":1768708973973,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708974012,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

 [31mâ¯[39m tests/integration/api.runs.docx.test.ts [2m([22m[2m6 tests[22m[2m | [22m[33m6 skipped[39m[2m)[22m[33m 4119[2mms[22m[39m
       [2m[90mâ†“[39m[22m should execute workflow with template node and generate DOCX
       [2m[90mâ†“[39m[22m should handle missing template data gracefully
       [2m[90mâ†“[39m[22m should download DOCX output from successful run
       [2m[90mâ†“[39m[22m should return 404 for PDF when not generated
       [2m[90mâ†“[39m[22m should return 404 for non-existent run
       [2m[90mâ†“[39m[22m should extract placeholders from uploaded template
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

{"level":50,"time":1768708974568,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["79edcfc5-a98f-4788-902c-4365fc77cc2c","$2b$12$UdKTLDcPF2zp6GmLZdJFxOEdLhjbLRrQwl.DaMMZOn0vIO2u.yYoq"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(79edcfc5-a98f-4788-902c-4365fc77cc2c) is not present in table \"users\".","schema":"test_schema_w37_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"79edcfc5-a98f-4788-902c-4365fc77cc2c","msg":"Failed to create user credentials"}
{"level":50,"time":1768708974568,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["79edcfc5-a98f-4788-902c-4365fc77cc2c","$2b$12$UdKTLDcPF2zp6GmLZdJFxOEdLhjbLRrQwl.DaMMZOn0vIO2u.yYoq"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(79edcfc5-a98f-4788-902c-4365fc77cc2c) is not present in table \"users\".","schema":"test_schema_w37_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w37_v3, public
âœ… Enforced search_path: test_schema_w37_v3, public

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w37_v3
âœ… Current search_path: test_schema_w37_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768708974964,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708974965,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w41_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w41_v3 (Reused: true)

 [31mâ¯[39m tests/integration/api.projects.test.ts [2m([22m[2m10 tests[22m[2m | [22m[33m10 skipped[39m[2m)[22m[33m 4102[2mms[22m[39m
       [2m[90mâ†“[39m[22m should create a new project
       [2m[90mâ†“[39m[22m should reject without authentication
       [2m[90mâ†“[39m[22m should reject with invalid data
       [2m[90mâ†“[39m[22m should list projects for tenant
       [2m[90mâ†“[39m[22m should support pagination
       [2m[90mâ†“[39m[22m should get project by ID
       [2m[90mâ†“[39m[22m should return 404 for non-existent project
       [2m[90mâ†“[39m[22m should update project
       [2m[90mâ†“[39m[22m should soft-delete project
       [2m[90mâ†“[39m[22m should not allow cross-tenant access
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mðŸ“Š Schema test_schema_w41_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708975659,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w29_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w29_v3 (Reused: true)

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w30_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w30_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708976375,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708976376,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w41_v3\",public"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mðŸ“Š Schema test_schema_w29_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708976425,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708976425,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w29_v3\",public"}
{"level":30,"time":1768708976434,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w41_v3\",public"}
{"level":30,"time":1768708976434,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768708976459,"env":"test","error":{},"msg":"Failed to create connection:"}
{"level":30,"time":1768708976477,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w29_v3\",public"}
{"level":30,"time":1768708976477,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mðŸ“Š Schema test_schema_w30_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708976710,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708976711,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w30_v3\",public"}
{"level":30,"time":1768708976771,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w30_v3\",public"}
{"level":30,"time":1768708976772,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w31_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w31_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w32_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708977180,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708977181,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w32_v3 (Reused: true)

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w41_v3, public
âœ… Enforced search_path: test_schema_w41_v3, public

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w29_v3, public
âœ… Enforced search_path: test_schema_w29_v3, public

 [31mâ¯[39m tests/integration/workflows/runtime-pipelines.test.ts [2m([22m[2m4 tests[22m[2m | [22m[33m4 skipped[39m[2m)[22m[33m 5213[2mms[22m[39m
       [2m[90mâ†“[39m[22m should create DataVault row on workflow completion
       [2m[90mâ†“[39m[22m should execute writebacks via RunService.completeRun()
       [2m[90mâ†“[39m[22m should skip document generation when visibleIf condition is false
       [2m[90mâ†“[39m[22m should generate document when visibleIf condition is true
[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w33_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w41_v3
âœ… Current search_path: test_schema_w41_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w34_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w33_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w37_v3
âœ… Current search_path: test_schema_w37_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w34_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mðŸ“Š Schema test_schema_w31_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708977558,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708977559,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w31_v3\",public"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w30_v3, public
âœ… Enforced search_path: test_schema_w30_v3, public

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mðŸ“Š Schema test_schema_w32_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708977599,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708977600,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w32_v3\",public"}
{"level":30,"time":1768708977609,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w31_v3\",public"}
{"level":30,"time":1768708977609,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708977631,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768708977668,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w32_v3\",public"}
{"level":30,"time":1768708977668,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w37_v3
âœ… Current search_path: test_schema_w37_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mðŸ“Š Schema test_schema_w33_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708977762,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708977763,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w33_v3\",public"}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mðŸ“Š Schema test_schema_w34_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708977820,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708977821,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w34_v3\",public"}
{"level":30,"time":1768708977827,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w33_v3\",public"}
{"level":30,"time":1768708977827,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708977890,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w34_v3\",public"}
{"level":30,"time":1768708977890,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768708977928,"env":"test","error":{},"msg":"Failed to create connection:"}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w43_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w43_v3 (Reused: true)

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w35_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w31_v3, public
âœ… Enforced search_path: test_schema_w31_v3, public

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mðŸ“Š Schema test_schema_w43_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708978412,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708978413,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w43_v3\",public"}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w35_v3 (Reused: true)

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w32_v3, public
âœ… Enforced search_path: test_schema_w32_v3, public

{"level":30,"time":1768708978468,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w43_v3\",public"}
{"level":30,"time":1768708978468,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w34_v3
âœ… Current search_path: test_schema_w32_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708978493,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768708978526,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768708978551,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708978550,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w37_v3
âœ… Current search_path: test_schema_w37_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708978537,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708978538,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708978544,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708978545,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708978550,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708978550,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708978551,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708978551,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":40,"time":1768708978594,"env":"test","module":"auth-middleware","path":"/test","msg":"No authorization token provided"}
[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w33_v3, public
âœ… Enforced search_path: test_schema_w33_v3, public

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w34_v3, public
âœ… Enforced search_path: test_schema_w34_v3, public

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w37_v3
âœ… Current search_path: test_schema_w37_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w37_v3
âœ… Current search_path: test_schema_w37_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mðŸ“Š Schema test_schema_w35_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708978827,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708978828,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w35_v3\",public"}
{"level":30,"time":1768708978842,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768708978865,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts[2m > [22m[2mDataVault v4 Regression Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708978851,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708978852,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708978858,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708978859,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708978864,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708978864,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708978864,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708978864,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768708978869,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708978869,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708978877,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w35_v3\",public"}
{"level":30,"time":1768708978877,"env":"test","msg":"DB: initialized flag set."}
 [31mâ¯[39m tests/integration/auth/oauth2.callback.test.ts [2m([22m[2m16 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 5888[2mms[22m[39m
[31m       [31mÃ—[31m should initiate OAuth2 3-legged flow and generate authorization URL[39m[33m 344[2mms[22m[39m
       [32mâœ“[39m should include optional scope in authorization URL[32m 148[2mms[22m[39m
       [32mâœ“[39m should validate valid OAuth2 state token[32m 176[2mms[22m[39m
       [32mâœ“[39m should reject invalid OAuth2 state token[32m 154[2mms[22m[39m
       [32mâœ“[39m should reject expired OAuth2 state token[32m 148[2mms[22m[39m
       [32mâœ“[39m should clean up OAuth2 state after use[32m 140[2mms[22m[39m
       [32mâœ“[39m should handle callback with missing state parameter[32m 142[2mms[22m[39m
       [32mâœ“[39m should handle callback with missing code parameter[32m 141[2mms[22m[39m
       [32mâœ“[39m should handle OAuth2 provider error responses[32m 147[2mms[22m[39m
[31m       [31mÃ—[31m should track OAuth2 connection status[39m[32m 251[2mms[22m[39m
       [32mâœ“[39m should store OAuth2 state in connection metadata[32m 154[2mms[22m[39m
       [32mâœ“[39m should use cryptographically secure random state[32m 147[2mms[22m[39m
       [32mâœ“[39m should prevent state reuse after validation[32m 152[2mms[22m[39m
       [32mâœ“[39m should include PKCE support metadata in state record[32m 141[2mms[22m[39m
       [32mâœ“[39m should validate redirect URI matches allowed URIs[32m 148[2mms[22m[39m
       [32mâœ“[39m should encode redirect URI in authorization URL[32m 144[2mms[22m[39m
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w44_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708978988,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708978989,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w44_v3 (Reused: true)

{"level":50,"time":1768708979040,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768708979195,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w43_v3, public
âœ… Enforced search_path: test_schema_w43_v3, public

 [31mâ¯[39m tests/integration/datavault-v4-regression.test.ts [2m([22m[2m23 tests[22m[2m | [22m[33m23 skipped[39m[2m)[22m[33m 3135[2mms[22m[39m
       [2m[90mâ†“[39m[22m should create a select column with options
       [2m[90mâ†“[39m[22m should create a multiselect column with options
       [2m[90mâ†“[39m[22m should validate select value against options
       [2m[90mâ†“[39m[22m should validate multiselect values as array
       [2m[90mâ†“[39m[22m should create an autonumber column with sequence
       [2m[90mâ†“[39m[22m should format autonumber with prefix
       [2m[90mâ†“[39m[22m should create a note for a row
       [2m[90mâ†“[39m[22m should get all notes for a row
       [2m[90mâ†“[39m[22m should delete a note
       [2m[90mâ†“[39m[22m should not allow deleting notes by other users
       [2m[90mâ†“[39m[22m should create an API token
       [2m[90mâ†“[39m[22m should validate API token scopes
       [2m[90mâ†“[39m[22m should revoke (delete) an API token
       [2m[90mâ†“[39m[22m should deny access with expired token
       [2m[90mâ†“[39m[22m should grant table permission
       [2m[90mâ†“[39m[22m should list table permissions
       [2m[90mâ†“[39m[22m should update table permission role
       [2m[90mâ†“[39m[22m should revoke table permission
       [2m[90mâ†“[39m[22m should enforce RBAC - only owners can manage permissions
       [2m[90mâ†“[39m[22m should paginate rows efficiently
       [2m[90mâ†“[39m[22m should return user-friendly error for invalid column type
       [2m[90mâ†“[39m[22m should return user-friendly error for missing required fields
       [2m[90mâ†“[39m[22m should handle network errors gracefully
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w26_v3
âœ… Current search_path: test_schema_w18_v3, public
â© Schema reused, skipping migrations.

[90mstderr[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests
[22m[39mCleanup error (non-fatal): DrizzleQueryError: Failed query: delete from "workflows" where  = $1
params: fb93acf3-a519-4520-9255-8ebb3c0ff147
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/api.runs.graph.test.ts:256:9 {
  query: [32m'delete from "workflows" where  = $1'[39m,
  params: [ [32m'fb93acf3-a519-4520-9255-8ebb3c0ff147'[39m ],
  cause: error: syntax error at or near "="
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/api.runs.graph.test.ts:256:9 {
    length: [33m90[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42601'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'32'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'scan.l'[39m,
    line: [32m'1244'[39m,
    routine: [32m'scanner_yyerror'[39m
  }
}

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708979356,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708979356,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":40,"time":1768708979403,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mðŸ“Š Schema test_schema_w44_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708979435,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708979436,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w44_v3\",public"}
{"level":30,"time":1768708979488,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w44_v3\",public"}
{"level":30,"time":1768708979488,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768708979500,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":40,"time":1768708979604,"env":"test","module":"auth-middleware","path":"/test","msg":"No authorization token provided"}
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708979605,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708979605,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w35_v3, public
âœ… Enforced search_path: test_schema_w35_v3, public

 [31mâ¯[39m tests/integration/api.runs.graph.test.ts [2m([22m[2m19 tests[22m[2m | [22m[33m19 skipped[39m[2m)[22m[33m 3796[2mms[22m[39m
       [2m[90mâ†“[39m[22m should list all runs with pagination
       [2m[90mâ†“[39m[22m should filter runs by status
       [2m[90mâ†“[39m[22m should filter runs by workflow
       [2m[90mâ†“[39m[22m should filter runs by project
       [2m[90mâ†“[39m[22m should filter runs by date range
       [2m[90mâ†“[39m[22m should search runs by query string
       [2m[90mâ†“[39m[22m should get run by ID with all details
       [2m[90mâ†“[39m[22m should return 404 for non-existent run
       [2m[90mâ†“[39m[22m should get logs for a run
       [2m[90mâ†“[39m[22m should re-run workflow with same inputs
       [2m[90mâ†“[39m[22m should re-run workflow with override inputs
       [2m[90mâ†“[39m[22m should return 404 for non-existent run
       [2m[90mâ†“[39m[22m should export runs to CSV
       [2m[90mâ†“[39m[22m should export runs with filters applied
       [2m[90mâ†“[39m[22m should compare two runs
       [2m[90mâ†“[39m[22m should identify changed input keys
       [2m[90mâ†“[39m[22m should return 404 if run A not found
       [2m[90mâ†“[39m[22m should return 404 if run B not found
       [2m[90mâ†“[39m[22m should enforce tenant isolation on runs list
 [31mâ¯[39m tests/unit/middleware/auth.middleware.test.ts [2m([22m[2m22 tests[22m[2m | [22m[31m11 failed[39m[2m)[22m[33m 5051[2mms[22m[39m
       [32mâœ“[39m should authenticate with valid JWT token[32m 57[2mms[22m[39m
       [32mâœ“[39m should return 401 for missing token[32m 53[2mms[22m[39m
       [32mâœ“[39m should return 401 for invalid token[32m 50[2mms[22m[39m
       [32mâœ“[39m should return 401 for expired token[32m 50[2mms[22m[39m
       [32mâœ“[39m should extract token without Bearer prefix[32m 48[2mms[22m[39m
       [32mâœ“[39m should authenticate with valid token[32m 44[2mms[22m[39m
       [32mâœ“[39m should proceed without auth when no token provided[32m 46[2mms[22m[39m
       [32mâœ“[39m should proceed even with invalid token[32m 47[2mms[22m[39m
[31m       [31mÃ—[31m should authenticate with JWT Bearer token[39m[32m 57[2mms[22m[39m
[31m       [31mÃ—[31m should authenticate with refresh token cookie for GET requests[39m[32m 48[2mms[22m[39m
[31m       [31mÃ—[31m should reject cookie auth for POST requests[39m[32m 50[2mms[22m[39m
[31m       [31mÃ—[31m should prioritize JWT over cookie when both present[39m[32m 48[2mms[22m[39m
[31m       [31mÃ—[31m should allow cookie auth only for safe methods[39m[32m 55[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 when no auth provided[39m[32m 52[2mms[22m[39m
[31m       [31mÃ—[31m should authenticate with JWT[39m[32m 51[2mms[22m[39m
[31m       [31mÃ—[31m should authenticate with cookie for GET[39m[32m 50[2mms[22m[39m
[31m       [31mÃ—[31m should proceed without auth when none provided[39m[32m 53[2mms[22m[39m
[31m       [31mÃ—[31m should proceed even with invalid auth[39m[32m 55[2mms[22m[39m
       [32mâœ“[39m should not allow token tampering[32m 48[2mms[22m[39m
[31m       [31mÃ—[31m should not allow cookie auth for mutations (CSRF protection)[39m[32m 48[2mms[22m[39m
       [32mâœ“[39m should reject malformed JWT[32m 51[2mms[22m[39m
       [32mâœ“[39m should handle missing authorization header gracefully[32m 52[2mms[22m[39m
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/api.expression-validation.test.ts[2m > [22m[2mExpression Validation API Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/api.expression-validation.test.ts[2m > [22m[2mExpression Validation API Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768708979672,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768708979699,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts[2m > [22m[2mExpression Validation API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts[2m > [22m[2mData Sources API - Native Catalog
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts[2m > [22m[2mData Sources API - Native Catalog
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768708979685,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708979685,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708979691,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708979692,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708979698,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708979698,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708979699,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708979699,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768708979706,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768708979731,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts[2m > [22m[2mData Sources API - Native Catalog
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708979718,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708979718,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708979724,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708979725,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708979731,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708979731,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708979731,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708979731,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w33_v3
âœ… Current search_path: test_schema_w33_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/intake.workflow.test.ts[2m > [22m[2mIntake Workflow Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/intake.workflow.test.ts[2m > [22m[2mIntake Workflow Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768708979925,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768708979951,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/intake.workflow.test.ts[2m > [22m[2mIntake Workflow Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708979937,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708979938,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708979944,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708979944,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708979950,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708979950,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708979951,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708979951,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts[2m > [22m[2mLifecycle Hooks Execution
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts[2m > [22m[2mLifecycle Hooks Execution
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768708979988,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w38_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708980013,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts[2m > [22m[2mLifecycle Hooks Execution
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708979998,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708979999,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708980004,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708980005,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708980012,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708980012,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708980013,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708980013,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w38_v3 (Reused: true)

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

{"level":50,"time":1768708980240,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["7388bc45-3554-4512-afaf-a63310f44cbc","$2b$12$AaCXjYyYFThuM.swODAbvOsdvn2cbOs7s1y6UzHk1raa0emGRoSyS"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(7388bc45-3554-4512-afaf-a63310f44cbc) is not present in table \"users\".","schema":"test_schema_w35_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"7388bc45-3554-4512-afaf-a63310f44cbc","msg":"Failed to create user credentials"}
{"level":50,"time":1768708980240,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["7388bc45-3554-4512-afaf-a63310f44cbc","$2b$12$AaCXjYyYFThuM.swODAbvOsdvn2cbOs7s1y6UzHk1raa0emGRoSyS"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(7388bc45-3554-4512-afaf-a63310f44cbc) is not present in table \"users\".","schema":"test_schema_w35_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstderr[2m | tests/integration/api.expression-validation.test.ts[2m > [22m[2mExpression Validation API Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/api.expression-validation.test.ts:20:11

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768708980256,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708980257,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768708980293,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["1daeb1c3-fc4a-49f9-b2dc-198f2e2abd10","$2b$12$vodAc.214c75Jle2TO6VOOAC.xkOybc6waV84SD5tstChhIboIqKW"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(1daeb1c3-fc4a-49f9-b2dc-198f2e2abd10) is not present in table \"users\".","schema":"test_schema_w44_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"1daeb1c3-fc4a-49f9-b2dc-198f2e2abd10","msg":"Failed to create user credentials"}
{"level":50,"time":1768708980293,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["1daeb1c3-fc4a-49f9-b2dc-198f2e2abd10","$2b$12$vodAc.214c75Jle2TO6VOOAC.xkOybc6waV84SD5tstChhIboIqKW"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(1daeb1c3-fc4a-49f9-b2dc-198f2e2abd10) is not present in table \"users\".","schema":"test_schema_w44_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w44_v3, public
âœ… Enforced search_path: test_schema_w44_v3, public

[90mstderr[2m | tests/integration/api.dataSources.native.test.ts[2m > [22m[2mData Sources API - Native Catalog
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/api.dataSources.native.test.ts:20:15

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708980306,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708980307,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w44_v3
âœ… Current search_path: test_schema_w44_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mðŸ“Š Schema test_schema_w38_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708980472,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708980472,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w38_v3\",public"}
{"level":30,"time":1768708980480,"env":"test","module":"user-credentials-repository","userId":"b78a7e45-5ec6-4e84-8cae-dace89bbf527","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

{"level":30,"time":1768708980506,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768708980532,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w38_v3\",public"}
{"level":30,"time":1768708980532,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mâœ… Applied failsafe schema fixes

 [31mâ¯[39m tests/integration/api.expression-validation.test.ts [2m([22m[2m10 tests[22m[2m | [22m[33m10 skipped[39m[2m)[22m[33m 3581[2mms[22m[39m
       [2m[90mâ†“[39m[22m should validate a correct expression with valid variables
       [2m[90mâ†“[39m[22m should validate expression with string concatenation
       [2m[90mâ†“[39m[22m should reject expression with invalid syntax
       [2m[90mâ†“[39m[22m should reject without authentication
       [2m[90mâ†“[39m[22m should reject missing required fields
       [2m[90mâ†“[39m[22m should return available variables for a node
       [2m[90mâ†“[39m[22m should reject without authentication
       [2m[90mâ†“[39m[22m should reject non-existent workflow
       [2m[90mâ†“[39m[22m should return list of helper functions with metadata
       [2m[90mâ†“[39m[22m should reject without authentication
{"level":30,"time":1768708980587,"env":"test","module":"email-queue","jobId":"45acf165-ce23-4705-aca6-41158d2a5e4e","to":"test-nIZRd1shgWA_RoJGULEfx@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768708980618,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["aac6e542-adc1-4e84-9895-6e72661a5533","$2b$12$zay9NKHw2u3IUaOPbAqh7OUtP4wKOkIn5Mhe7ahUq7XFU5D8kPBnG"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(aac6e542-adc1-4e84-9895-6e72661a5533) is not present in table \"users\".","schema":"test_schema_w44_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"aac6e542-adc1-4e84-9895-6e72661a5533","msg":"Failed to create user credentials"}
{"level":50,"time":1768708980618,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["aac6e542-adc1-4e84-9895-6e72661a5533","$2b$12$zay9NKHw2u3IUaOPbAqh7OUtP4wKOkIn5Mhe7ahUq7XFU5D8kPBnG"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(aac6e542-adc1-4e84-9895-6e72661a5533) is not present in table \"users\".","schema":"test_schema_w44_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
 [31mâ¯[39m tests/integration/api.dataSources.native.test.ts [2m([22m[2m2 tests[22m[2m | [22m[33m2 skipped[39m[2m)[22m[33m 3574[2mms[22m[39m
     [2m[90mâ†“[39m[22m should list databases and databases' tables in the catalog
     [2m[90mâ†“[39m[22m should create a native_table data source
[90mstderr[2m | tests/integration/lifecycle-hooks-execution.test.ts[2m > [22m[2mLifecycle Hooks Execution
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/lifecycle-hooks-execution.test.ts:41:11

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708980634,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708980634,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708980645,"env":"test","module":"auth-routes","userId":"b78a7e45-5ec6-4e84-8cae-dace89bbf527","email":"test-nIZRd1shgWA_RoJGULEfx@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w45_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w45_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault.permissions.test.ts[2m > [22m[2mDataVault Table Permissions API (v4 Micro-Phase 6)
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/datavault.permissions.test.ts[2m > [22m[2mDataVault Table Permissions API (v4 Micro-Phase 6)
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768708980914,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":40,"time":1768708980920,"env":"test","module":"tenant-middleware","userId":"b78a7e45-5ec6-4e84-8cae-dace89bbf527","path":"/","msg":"User does not have an associated tenant"}
[90mstderr[2m | tests/integration/intake.workflow.test.ts[2m > [22m[2mIntake Workflow Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: Project creation failed: {"message":"Tenant required","error":"no_tenant","details":"Your account is not associated with any tenant. Please contact support."}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:153:15)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/intake.workflow.test.ts:11:15

{"level":30,"time":1768708980927,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708980927,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w40_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708980941,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts[2m > [22m[2mDataVault Table Permissions API (v4 Micro-Phase 6)
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708980927,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708980928,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708980933,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708980934,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708980940,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708980940,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708980941,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708980941,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
 [31mâ¯[39m tests/integration/lifecycle-hooks-execution.test.ts [2m([22m[2m15 tests[22m[2m | [22m[33m15 skipped[39m[2m)[22m[33m 3696[2mms[22m[39m
       [2m[90mâ†“[39m[22m should execute beforePage hook and capture console output
       [2m[90mâ†“[39m[22m should execute beforePage hook with mutation mode enabled
       [2m[90mâ†“[39m[22m should handle errors gracefully without breaking workflow
       [2m[90mâ†“[39m[22m should execute afterPage hook with user input data
       [2m[90mâ†“[39m[22m should execute Python afterPage hook
       [2m[90mâ†“[39m[22m should execute beforeFinalBlock hook before document generation
       [2m[90mâ†“[39m[22m should execute afterDocumentsGenerated hook for cleanup
       [2m[90mâ†“[39m[22m should timeout hook that exceeds timeoutMs limit
       [2m[90mâ†“[39m[22m should execute multiple hooks in correct order
       [2m[90mâ†“[39m[22m should list all hooks for a workflow
       [2m[90mâ†“[39m[22m should update a hook
       [2m[90mâ†“[39m[22m should delete a hook
       [2m[90mâ†“[39m[22m should test a hook with sample data
       [2m[90mâ†“[39m[22m should retrieve execution logs for a run
       [2m[90mâ†“[39m[22m should clear execution logs for a run
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w39_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w40_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w39_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mðŸ“Š Schema test_schema_w45_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708981211,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708981212,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w45_v3\",public"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768708981261,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w45_v3\",public"}
{"level":30,"time":1768708981261,"env":"test","msg":"DB: initialized flag set."}
 [31mâ¯[39m tests/integration/intake.workflow.test.ts [2m([22m[2m2 tests[22m[2m | [22m[33m2 skipped[39m[2m)[22m[33m 4021[2mms[22m[39m
     [2m[90mâ†“[39m[22m should allow designating a workflow as Intake
     [2m[90mâ†“[39m[22m should allow linking a downstream workflow to an intake workflow
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w38_v3, public
âœ… Enforced search_path: test_schema_w38_v3, public

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mðŸ“Š Schema test_schema_w40_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708981404,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708981405,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w40_v3\",public"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w46_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w44_v3
âœ… Current search_path: test_schema_w43_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mðŸ“Š Schema test_schema_w39_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708981431,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708981431,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w39_v3\",public"}
{"level":30,"time":1768708981460,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w40_v3\",public"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w46_v3 (Reused: true)

{"level":30,"time":1768708981461,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708981485,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w39_v3\",public"}
{"level":30,"time":1768708981485,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768708981492,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["4e6ddd8b-dfb2-460e-a67d-fa35ee149ac9","$2b$12$8y3Ymagz9zKrz5t06LTsTuQtPW1UegjHANk/Ix5.FFP2LhffURVV."],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(4e6ddd8b-dfb2-460e-a67d-fa35ee149ac9) is not present in table \"users\".","schema":"test_schema_w43_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"4e6ddd8b-dfb2-460e-a67d-fa35ee149ac9","msg":"Failed to create user credentials"}
{"level":50,"time":1768708981492,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["4e6ddd8b-dfb2-460e-a67d-fa35ee149ac9","$2b$12$8y3Ymagz9zKrz5t06LTsTuQtPW1UegjHANk/Ix5.FFP2LhffURVV."],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(4e6ddd8b-dfb2-460e-a67d-fa35ee149ac9) is not present in table \"users\".","schema":"test_schema_w43_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/datavault.permissions.test.ts[2m > [22m[2mDataVault Table Permissions API (v4 Micro-Phase 6)
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/datavault.permissions.test.ts:22:11

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708981506,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708981506,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w48_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w48_v3 (Reused: true)

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w47_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708981685,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708981686,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w47_v3 (Reused: true)

 [31mâ¯[39m tests/integration/externalSends.test.ts [2m([22m[2m2 tests[22m[2m | [22m[33m2 skipped[39m[2m)[22m[33m 4156[2mms[22m[39m
     [2m[90mâ†“[39m[22m PREVIEW MODE: Should simulate send and NOT call fetch
     [2m[90mâ†“[39m[22m LIVE MODE: Should call fetch with mapped payload
 [31mâ¯[39m tests/integration/datavault.permissions.test.ts [2m([22m[2m22 tests[22m[2m | [22m[33m22 skipped[39m[2m)[22m[33m 3529[2mms[22m[39m
       [2m[90mâ†“[39m[22m should allow owner to read table
       [2m[90mâ†“[39m[22m should allow writer to read table
       [2m[90mâ†“[39m[22m should allow reader to read table
       [2m[90mâ†“[39m[22m should deny non-member from reading table
       [2m[90mâ†“[39m[22m should allow owner to update table
       [2m[90mâ†“[39m[22m should deny writer from updating table
       [2m[90mâ†“[39m[22m should deny reader from updating table
       [2m[90mâ†“[39m[22m should deny writer from deleting table
       [2m[90mâ†“[39m[22m should deny reader from deleting table
       [2m[90mâ†“[39m[22m should deny non-member from deleting table
       [2m[90mâ†“[39m[22m should allow owner to view permissions
       [2m[90mâ†“[39m[22m should deny writer from viewing permissions
       [2m[90mâ†“[39m[22m should deny reader from viewing permissions
       [2m[90mâ†“[39m[22m should allow owner to grant permissions
       [2m[90mâ†“[39m[22m should allow owner to update existing permission (upsert)
       [2m[90mâ†“[39m[22m should deny writer from granting permissions
       [2m[90mâ†“[39m[22m should prevent modifying table owner permissions
       [2m[90mâ†“[39m[22m should allow owner to revoke permissions
       [2m[90mâ†“[39m[22m should deny writer from revoking permissions
       [2m[90mâ†“[39m[22m should enforce owner includes write and read
       [2m[90mâ†“[39m[22m should enforce write includes read but not owner
       [2m[90mâ†“[39m[22m should enforce read is read-only
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mðŸ“Š Schema test_schema_w46_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708981870,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708981871,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w46_v3\",public"}
{"level":30,"time":1768708981925,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w46_v3\",public"}
{"level":30,"time":1768708981925,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w45_v3, public
âœ… Enforced search_path: test_schema_w45_v3, public

{"level":30,"time":1768708982061,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708982062,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mðŸ“Š Schema test_schema_w48_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708982103,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708982105,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w48_v3\",public"}
 [31mâ¯[39m tests/integration/workflow_versioning.test.ts [2m([22m[2m3 tests[22m[2m | [22m[33m3 skipped[39m[2m)[22m[33m 3489[2mms[22m[39m
     [2m[90mâ†“[39m[22m should diff two versions correctly
     [2m[90mâ†“[39m[22m should create a version and populate changelog
     [2m[90mâ†“[39m[22m should track execution lineage via snapshot
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w44_v3
âœ… Current search_path: test_schema_w44_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mðŸ“Š Schema test_schema_w47_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708982163,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708982165,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w47_v3\",public"}
{"level":30,"time":1768708982167,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w48_v3\",public"}
{"level":30,"time":1768708982167,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708982220,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w47_v3\",public"}
{"level":30,"time":1768708982220,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w40_v3, public
âœ… Enforced search_path: test_schema_w40_v3, public

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w39_v3, public
âœ… Enforced search_path: test_schema_w39_v3, public

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w46_v3
âœ… Current search_path: test_schema_w46_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w46_v3
âœ… Current search_path: test_schema_w46_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.templates-runs.test.ts[2m > [22m[2mTemplates and Runs API Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/api.templates-runs.test.ts[2m > [22m[2mTemplates and Runs API Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768708982555,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768708982579,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts[2m > [22m[2mTemplates and Runs API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708982566,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708982566,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708982573,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708982573,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708982579,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708982579,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708982579,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708982579,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w46_v3, public
âœ… Enforced search_path: test_schema_w46_v3, public

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w47_v3
âœ… Current search_path: test_schema_w40_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w48_v3, public
âœ… Enforced search_path: test_schema_w48_v3, public

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w47_v3, public
âœ… Enforced search_path: test_schema_w47_v3, public

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w45_v3
âœ… Current search_path: test_schema_w45_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w45_v3
âœ… Current search_path: test_schema_w45_v3, public
â© Schema reused, skipping migrations.

{"level":50,"time":1768708983108,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["765cdeca-c118-46e5-84ee-22a17e9b84ad","$2b$12$OFhmJm7py0k1LzBlfrPQyukekPyqBWJC31rXJLSkQoqOlHS5QSBrW"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(765cdeca-c118-46e5-84ee-22a17e9b84ad) is not present in table \"users\".","schema":"test_schema_w45_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"765cdeca-c118-46e5-84ee-22a17e9b84ad","msg":"Failed to create user credentials"}
{"level":50,"time":1768708983108,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["765cdeca-c118-46e5-84ee-22a17e9b84ad","$2b$12$OFhmJm7py0k1LzBlfrPQyukekPyqBWJC31rXJLSkQoqOlHS5QSBrW"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(765cdeca-c118-46e5-84ee-22a17e9b84ad) is not present in table \"users\".","schema":"test_schema_w45_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/api.templates-runs.test.ts[2m > [22m[2mTemplates and Runs API Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at Module.setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/api.templates-runs.test.ts:59:11

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768708983124,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708983125,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w42_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w42_v3 (Reused: true)

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

 [31mâ¯[39m tests/integration/api.templates-runs.test.ts [2m([22m[2m15 tests[22m[2m | [22m[33m15 skipped[39m[2m)[22m[33m 3520[2mms[22m[39m
         [2m[90mâ†“[39m[22m should create template with file upload
         [2m[90mâ†“[39m[22m should reject non-docx files
         [2m[90mâ†“[39m[22m should reject without file
         [2m[90mâ†“[39m[22m should list templates
         [2m[90mâ†“[39m[22m should get template by ID
         [2m[90mâ†“[39m[22m should extract placeholders
         [2m[90mâ†“[39m[22m should update template name
         [2m[90mâ†“[39m[22m should delete template
         [2m[90mâ†“[39m[22m should execute workflow
         [2m[90mâ†“[39m[22m should include logs in debug mode
         [2m[90mâ†“[39m[22m should reject without required permission
         [2m[90mâ†“[39m[22m should list runs
         [2m[90mâ†“[39m[22m should filter by workflowId
         [2m[90mâ†“[39m[22m should get run by ID
         [2m[90mâ†“[39m[22m should get run logs
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768708983494,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768708983519,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708983505,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708983506,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708983512,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708983513,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708983518,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708983518,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708983518,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708983519,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768708983549,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768708983574,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708983560,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708983561,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708983567,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708983567,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708983573,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708983573,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708983574,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708983574,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mðŸ“Š Schema test_schema_w42_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708983671,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708983672,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w42_v3\",public"}
{"level":30,"time":1768708983729,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w42_v3\",public"}
{"level":30,"time":1768708983729,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768708984127,"env":"test","module":"user-credentials-repository","userId":"436d3c9f-15f7-499e-bf40-363fe8e51827","msg":"User credentials created"}
{"level":50,"time":1768708984153,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["bcb3a24f-a893-403b-a542-7d924078a9e4","$2b$12$Iy2CVDPLqkt/dIxyjkH5lediBNxQpl/n0tbUL/zzxOUs94VlEaqkK"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(bcb3a24f-a893-403b-a542-7d924078a9e4) is not present in table \"users\".","schema":"test_schema_w42_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"bcb3a24f-a893-403b-a542-7d924078a9e4","msg":"Failed to create user credentials"}
{"level":50,"time":1768708984153,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["bcb3a24f-a893-403b-a542-7d924078a9e4","$2b$12$Iy2CVDPLqkt/dIxyjkH5lediBNxQpl/n0tbUL/zzxOUs94VlEaqkK"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(bcb3a24f-a893-403b-a542-7d924078a9e4) is not present in table \"users\".","schema":"test_schema_w42_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/session.management.integration.test.ts:31:15

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708984169,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708984169,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768708984204,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["436d3c9f-15f7-499e-bf40-363fe8e51827","3562b727d2fbb26e9040cc0d142294de9f4a070b1851a0b2a4deb970cf85a3d9","2026-01-19T04:03:04.128Z"],"cause":{"length":383,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(436d3c9f-15f7-499e-bf40-363fe8e51827) is not present in table \"users\".","schema":"test_schema_w42_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/jwt.authentication.test.ts:31:15

{"level":30,"time":1768708984220,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708984221,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w49_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w49_v3 (Reused: true)

{"level":30,"time":1768708984328,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708984329,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [31mâ¯[39m tests/integration/regression-REG-1.test.ts [2m([22m[2m8 tests[22m[2m | [22m[33m8 skipped[39m[2m)[22m[33m 3999[2mms[22m[39m
       [2m[90mâ†“[39m[22m should block Next when required visible question is empty
       [2m[90mâ†“[39m[22m should NOT block Next when required question is hidden
       [2m[90mâ†“[39m[22m should block when required becomes visible and is empty
       [2m[90mâ†“[39m[22m should skip hidden required page entirely
       [2m[90mâ†“[39m[22m should enforce required on visible page
       [2m[90mâ†“[39m[22m should evaluate visibility consistently across modes
       [2m[90mâ†“[39m[22m should handle malformed visibility expression gracefully
       [2m[90mâ†“[39m[22m should handle missing variable in visibility expression
{"level":30,"time":1768708984518,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708984518,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w42_v3, public
âœ… Enforced search_path: test_schema_w42_v3, public

{"level":30,"time":1768708984544,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708984544,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/auth/session.management.integration.test.ts [2m([22m[2m18 tests[22m[2m | [22m[33m18 skipped[39m[2m)[22m[33m 3591[2mms[22m[39m
       [2m[90mâ†“[39m[22m should create refresh token on login
       [2m[90mâ†“[39m[22m should track device metadata in session
       [2m[90mâ†“[39m[22m should create separate sessions for multiple device logins
       [2m[90mâ†“[39m[22m should list all active sessions for user
       [2m[90mâ†“[39m[22m should mark current session correctly
       [2m[90mâ†“[39m[22m should not include revoked sessions
       [2m[90mâ†“[39m[22m should order sessions by last used (most recent first)
       [2m[90mâ†“[39m[22m should require authentication
       [2m[90mâ†“[39m[22m should revoke specific session
       [2m[90mâ†“[39m[22m should prevent revoking current session
       [2m[90mâ†“[39m[22m should not allow revoking other users sessions
       [2m[90mâ†“[39m[22m should return 404 for non-existent session ID
       [2m[90mâ†“[39m[22m should revoke all sessions except current
       [2m[90mâ†“[39m[22m should revoke all trusted devices
       [2m[90mâ†“[39m[22m should require active session
       [2m[90mâ†“[39m[22m should reject refresh token after 30 days
       [2m[90mâ†“[39m[22m should handle multiple concurrent logins
       [2m[90mâ†“[39m[22m should handle concurrent token refreshes
 [31mâ¯[39m tests/integration/auth/jwt.authentication.test.ts [2m([22m[2m27 tests[22m[2m | [22m[33m27 skipped[39m[2m)[22m[33m 3692[2mms[22m[39m
       [2m[90mâ†“[39m[22m should generate valid JWT token on successful login
       [2m[90mâ†“[39m[22m should include correct payload in JWT token
       [2m[90mâ†“[39m[22m should set JWT expiry to 15 minutes
       [2m[90mâ†“[39m[22m should accept valid JWT token on protected routes
       [2m[90mâ†“[39m[22m should reject request without authorization header
       [2m[90mâ†“[39m[22m should reject request with malformed token
       [2m[90mâ†“[39m[22m should accept request with missing Bearer prefix (lenient)
       [2m[90mâ†“[39m[22m should reject token with invalid signature
       [2m[90mâ†“[39m[22m should reject expired JWT token
       [2m[90mâ†“[39m[22m should return token_expired error code for expired tokens
       [2m[90mâ†“[39m[22m should authenticate with Bearer token in Authorization header
       [2m[90mâ†“[39m[22m should work with Bearer token on POST requests
       [2m[90mâ†“[39m[22m should work with Bearer token on PUT requests
       [2m[90mâ†“[39m[22m should work with Bearer token on DELETE requests
       [2m[90mâ†“[39m[22m should exchange valid session cookie for JWT token
       [2m[90mâ†“[39m[22m should reject token exchange without valid cookie
       [2m[90mâ†“[39m[22m should prefer Bearer token over cookie when both present
       [2m[90mâ†“[39m[22m should fall back to cookie if Bearer token is invalid
       [2m[90mâ†“[39m[22m should allow GET requests with cookie auth only
       [2m[90mâ†“[39m[22m should reject POST requests with cookie auth only (mutation-strict)
       [2m[90mâ†“[39m[22m should allow anonymous access to public workflows
       [2m[90mâ†“[39m[22m should attach user info if authenticated on optional auth routes
       [2m[90mâ†“[39m[22m should refresh access token using refresh token
       [2m[90mâ†“[39m[22m should rotate refresh token on use
       [2m[90mâ†“[39m[22m should detect token reuse and revoke all user tokens
       [2m[90mâ†“[39m[22m should revoke refresh token on logout
       [2m[90mâ†“[39m[22m should clear refresh token cookie on logout
 [31mâ¯[39m tests/integration/datavault.autonumber.test.ts [2m([22m[2m5 tests[22m[2m | [22m[33m5 skipped[39m[2m)[22m[33m 3293[2mms[22m[39m
     [2m[90mâ†“[39m[22m should generate basic autonumber without prefix
     [2m[90mâ†“[39m[22m should generate autonumber with prefix
     [2m[90mâ†“[39m[22m should generate autonumber with yearly reset format
     [2m[90mâ†“[39m[22m should be atomic and prevent race conditions
     [2m[90mâ†“[39m[22m should prevent manual updates to autonumber values
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w45_v3
âœ… Current search_path: test_schema_w42_v3, public
â© Schema reused, skipping migrations.

 [31mâ¯[39m tests/integration/organizations-workflow.test.ts [2m([22m[2m23 tests[22m[2m | [22m[33m23 skipped[39m[2m)[22m[33m 3551[2mms[22m[39m
       [2m[90mâ†“[39m[22m Step 1: Create organization
       [2m[90mâ†“[39m[22m Step 2: Invite member via email
       [2m[90mâ†“[39m[22m Step 3: Accept invite
       [2m[90mâ†“[39m[22m Step 4: Create workflow owned by user
       [2m[90mâ†“[39m[22m Step 5: Transfer workflow to organization
       [2m[90mâ†“[39m[22m Step 6: Org member (user2) can access workflow
       [2m[90mâ†“[39m[22m Step 7: Org member (user2) can update workflow
       [2m[90mâ†“[39m[22m Step 8: Org admin (user1) can still access workflow after transfer
       [2m[90mâ†“[39m[22m Step 9: Non-member (user3) CANNOT access org workflow
       [2m[90mâ†“[39m[22m Step 10: Non-member (user3) CANNOT update org workflow
       [2m[90mâ†“[39m[22m Step 11: Non-member (user3) CANNOT transfer org workflow
       [2m[90mâ†“[39m[22m Step 12: Org member can see workflow in list
       [2m[90mâ†“[39m[22m Step 13: Non-member CANNOT see workflow in list
       [2m[90mâ†“[39m[22m Step 14: Remove member from org
       [2m[90mâ†“[39m[22m Step 15: Removed member (user2) can no longer access workflow
       [2m[90mâ†“[39m[22m Step 16: Re-add member and verify access restored
       [2m[90mâ†“[39m[22m Cannot invite same email twice (pending invite exists)
       [2m[90mâ†“[39m[22m Cannot accept expired invite
       [2m[90mâ†“[39m[22m Cannot transfer workflow to org user is not a member of
       [2m[90mâ†“[39m[22m Member cannot promote themselves to admin
       [2m[90mâ†“[39m[22m Member cannot remove admin
       [2m[90mâ†“[39m[22m Only members can view organization details
       [2m[90mâ†“[39m[22m Only members can view organization members list
{"level":30,"time":1768708984703,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708984704,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mðŸ“Š Schema test_schema_w49_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

 [31mâ¯[39m tests/integration/dynamic_options_workflow.test.ts [2m([22m[2m1 test[22m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 3426[2mms[22m[39m
     [2m[90mâ†“[39m[22m should successfully configure a workflow with Read Table -> Dynamic Choice
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.workflows.test.ts[2m > [22m[2mWorkflows API Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/api.workflows.test.ts[2m > [22m[2mWorkflows API Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768708985774,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768708985803,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.workflows.test.ts[2m > [22m[2mWorkflows API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w55_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708985786,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708985787,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708985796,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708985797,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708985802,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708985802,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708985803,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708985803,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w51_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w55_v3 (Reused: true)

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w51_v3 (Reused: true)

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w54_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w54_v3 (Reused: true)

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w50_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w50_v3 (Reused: true)

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w59_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w52_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w52_v3 (Reused: true)

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w59_v3 (Reused: true)

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mðŸ“Š Schema test_schema_w55_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768708986305,"env":"test","module":"user-credentials-repository","userId":"d54bf1a8-dbbd-4e76-ae91-3c56c5e8557d","msg":"User credentials created"}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mðŸ“Š Schema test_schema_w51_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768708986439,"env":"test","module":"email-queue","jobId":"465649a1-c985-42dd-ae8e-d7d4172ac2d0","to":"test-0_56x33ur496GsW92nsT_@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mðŸ“Š Schema test_schema_w54_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708986505,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708986506,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w49_v3\",public"}
{"level":30,"time":1768708986518,"env":"test","module":"auth-routes","userId":"d54bf1a8-dbbd-4e76-ae91-3c56c5e8557d","email":"test-0_56x33ur496GsW92nsT_@example.com","msg":"User registered"}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mðŸ“Š Schema test_schema_w50_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768708986571,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w49_v3\",public"}
{"level":30,"time":1768708986571,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mðŸ“Š Schema test_schema_w59_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mðŸ“Š Schema test_schema_w52_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708987291,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708987292,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w55_v3\",public"}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w49_v3, public
âœ… Enforced search_path: test_schema_w49_v3, public

{"level":30,"time":1768708987402,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w55_v3\",public"}
{"level":30,"time":1768708987402,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w49_v3
âœ… Current search_path: test_schema_w49_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708987520,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708987521,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w51_v3\",public"}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708987596,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708987598,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w54_v3\",public"}
{"level":30,"time":1768708987621,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w51_v3\",public"}
{"level":30,"time":1768708987621,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768708987668,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w54_v3\",public"}
{"level":30,"time":1768708987668,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708987696,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708987697,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w59_v3\",public"}
{"level":30,"time":1768708987765,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w59_v3\",public"}
{"level":30,"time":1768708987765,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w56_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708987841,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708987842,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w50_v3\",public"}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w56_v3 (Reused: true)

{"level":30,"time":1768708987901,"env":"test","module":"user-credentials-repository","userId":"8193896d-6694-476d-afef-c985e1fdea8b","msg":"User credentials created"}
{"level":30,"time":1768708987912,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w50_v3\",public"}
{"level":30,"time":1768708987912,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708987985,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708987987,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w52_v3\",public"}
{"level":30,"time":1768708988009,"env":"test","module":"email-queue","jobId":"19072016-11fa-4cd3-bc06-303c4b2a9d2a","to":"viewer-sua8Y5fRnMZaBK59TmGGd@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768708988044,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w52_v3\",public"}
{"level":30,"time":1768708988044,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708988059,"env":"test","module":"auth-routes","userId":"8193896d-6694-476d-afef-c985e1fdea8b","email":"viewer-sua8Y5fRnMZaBK59TmGGd@example.com","msg":"User registered"}
{"level":40,"time":1768708988163,"env":"test","module":"rbac-middleware","userId":"8193896d-6694-476d-afef-c985e1fdea8b","userRole":"viewer","permission":"workflow:create","path":"/projects/da41bae1-e641-41ac-871a-dd973bcb44c7/workflows","msg":"Permission denied"}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w62_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w55_v3, public
âœ… Enforced search_path: test_schema_w55_v3, public

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w62_v3 (Reused: true)

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w55_v3
âœ… Current search_path: test_schema_w55_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mðŸ“Š Schema test_schema_w56_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w51_v3, public
âœ… Enforced search_path: test_schema_w51_v3, public

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w54_v3, public
âœ… Enforced search_path: test_schema_w54_v3, public

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w51_v3
âœ… Current search_path: test_schema_w51_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w54_v3
âœ… Current search_path: test_schema_w54_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w61_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w59_v3, public
âœ… Enforced search_path: test_schema_w59_v3, public

{"level":30,"time":1768708988584,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w61_v3 (Reused: true)

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w59_v3
âœ… Current search_path: test_schema_w59_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mðŸ“Š Schema test_schema_w62_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w60_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w50_v3, public
âœ… Enforced search_path: test_schema_w50_v3, public

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w60_v3 (Reused: true)

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w57_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w52_v3, public
âœ… Enforced search_path: test_schema_w52_v3, public

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w50_v3
âœ… Current search_path: test_schema_w50_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w57_v3 (Reused: true)

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w52_v3
âœ… Current search_path: test_schema_w52_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w58_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mðŸ“Š Schema test_schema_w61_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w58_v3 (Reused: true)

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708989113,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708989114,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w56_v3\",public"}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mðŸ“Š Schema test_schema_w60_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":30,"time":1768708989170,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w56_v3\",public"}
{"level":30,"time":1768708989170,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mðŸ“Š Schema test_schema_w57_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708989406,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708989408,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w62_v3\",public"}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mðŸ“Š Schema test_schema_w58_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768708989457,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w62_v3\",public"}
{"level":30,"time":1768708989457,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould validate expression after debounce
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould return validation errors for invalid expression
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstderr[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx[2m > [22m[2mTableGridView - Drag & Drop[2m > [22m[2mrenders DndContext wrapper
[22m[39mWarning: validateDOMNesting(...): <th> cannot appear as a child of <div>.
    at th
    at SortableColumnHeader (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/SortableColumnHeader.tsx:12:33)
    at div
    at SortableContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:26:23)
    at tr
    at thead
    at table
    at div
    at DndContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:18:18)
    at div
    at div
    at TableGridView (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/TableGridView.tsx:32:26)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
Warning: validateDOMNesting(...): <div> cannot appear as a child of <tr>.
    at div
    at SortableContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:26:23)
    at tr
    at thead
    at table
    at div
    at DndContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:18:18)
    at div
    at div
    at TableGridView (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/TableGridView.tsx:32:26)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708989907,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708989909,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w61_v3\",public"}
[90mstdout[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould return validation errors for invalid expression
[22m[39mValidation Result DEBUG: {"ok":false,"errors":[{"message":"Unknown identifier: unknown_var","start":{"line":0,"col":0},"end":{"line":0,"col":11}}]}
IsValid DEBUG: [33mfalse[39m

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w56_v3, public
âœ… Enforced search_path: test_schema_w56_v3, public

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould debounce validation calls
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768708990001,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w61_v3\",public"}
{"level":30,"time":1768708990001,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w56_v3
âœ… Current search_path: test_schema_w56_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708990064,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708990065,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w60_v3\",public"}
{"level":30,"time":1768708990146,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w60_v3\",public"}
{"level":30,"time":1768708990147,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould not validate when workflowId or nodeId is missing
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould not validate when workflowId or nodeId is missing
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768708990182,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708990183,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w57_v3\",public"}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w62_v3, public
âœ… Enforced search_path: test_schema_w62_v3, public

{"level":30,"time":1768708990244,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w57_v3\",public"}
{"level":30,"time":1768708990244,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w62_v3
âœ… Current search_path: test_schema_w62_v3, public
â© Schema reused, skipping migrations.

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould validate helper functions in expressions
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708990420,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708990421,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w58_v3\",public"}
{"level":30,"time":1768708990481,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w58_v3\",public"}
{"level":30,"time":1768708990481,"env":"test","msg":"DB: initialized flag set."}
{"level":40,"time":1768708990514,"env":"test","error":{},"msg":"PDF conversion failed"}
{"level":30,"time":1768708990518,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708990519,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/docxRenderer.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 4776[2mms[22m[39m
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould validate complex expressions with multiple helpers
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w61_v3, public
âœ… Enforced search_path: test_schema_w61_v3, public

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould handle syntax errors
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768708990800,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708990801,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w61_v3
âœ… Current search_path: test_schema_w61_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708990894,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
 [32mâœ“[39m tests/unit/components/datavault/TableGridViewDragDrop.test.tsx [2m([22m[2m7 tests[22m[2m)[22m[33m 5292[2mms[22m[39m
     [33m[2mâœ“[22m[39m displays columns in order based on orderIndex [33m 402[2mms[22m[39m
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w60_v3, public
âœ… Enforced search_path: test_schema_w60_v3, public

{"level":30,"time":1768708990894,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768708991002,"env":"test","msg":"Master key validated successfully"}
{"level":30,"time":1768708991002,"env":"test","provider":"gemini","model":"gemini-2.0-flash","msg":"AI Service configured and ready"}
{"level":30,"time":1768708991002,"env":"test","msg":"Initializing database..."}
{"level":30,"time":1768708991002,"env":"test","msg":"Database initialized."}
{"level":30,"time":1768708991002,"env":"test","module":"email-queue","intervalMs":5000,"msg":"Starting email queue worker"}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w60_v3
âœ… Current search_path: test_schema_w60_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w57_v3, public
âœ… Enforced search_path: test_schema_w57_v3, public

[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mError Handling[2m > [22m[2mreverts value on save error
[22m[39mFailed to save cell: Error: Network error
    at C:/Users/scoot/poll/VaultLogic/tests/ui/datavault/EditableCell.test.tsx:206:36
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

Sourcemap for "C:/Users/scoot/poll/VaultLogic/node_modules/node-cron/dist/esm/node-cron.js" points to missing source files
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression Editor component behavior[2m > [22m[2mshould update validation when expression changes
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768708991102,"env":"test","module":"cron","msg":"Initializing cron jobs..."}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w57_v3
âœ… Current search_path: test_schema_w57_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708991183,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708991138,"env":"test","module":"cron","msg":"Cron jobs initialized"}
{"level":30,"time":1768708991140,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768708991152,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708991153,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708991172,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708991173,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708991182,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708991182,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708991182,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708991182,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768708991183,"env":"test","msg":"Loading Vite for development..."}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression Editor component behavior[2m > [22m[2mshould update validation when expression changes
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mError Handling[2m > [22m[2mdisplays error indicator on save failure
[22m[39mFailed to save cell: Error: Network error
    at C:/Users/scoot/poll/VaultLogic/tests/ui/datavault/EditableCell.test.tsx:222:36
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w58_v3, public
âœ… Enforced search_path: test_schema_w58_v3, public

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w58_v3
âœ… Current search_path: test_schema_w58_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708991391,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708991391,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/ui/expression-editor.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 6054[2mms[22m[39m
       [33m[2mâœ“[22m[39m should update validation when expression changes [33m 366[2mms[22m[39m
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":30,"time":1768708991515,"env":"test","source":"express","msg":"ðŸ“¦ vite.ts module loaded successfully"}
{"level":30,"time":1768708991515,"env":"test","msg":"Vite module loaded, calling setupVite..."}
{"level":30,"time":1768708991516,"env":"test","source":"express","msg":"ðŸ“ setupVite: Starting Vite setup..."}
{"level":30,"time":1768708991516,"env":"test","source":"express","msg":"ðŸ“ setupVite: Resolving Vite config..."}
{"level":30,"time":1768708991522,"env":"test","source":"express","msg":"ðŸ“ setupVite: Vite config resolved"}
{"level":30,"time":1768708991522,"env":"test","source":"express","msg":"ðŸ“ setupVite: Server options prepared, creating Vite server..."}
{"level":30,"time":1768708991597,"env":"test","source":"express","msg":"ðŸ“ setupVite: Vite server created successfully"}
{"level":30,"time":1768708991597,"env":"test","source":"express","msg":"ðŸ“ setupVite: Mounting Vite middlewares..."}
{"level":30,"time":1768708991597,"env":"test","source":"express","msg":"ðŸ“ setupVite: Vite middlewares mounted"}
{"level":30,"time":1768708991597,"env":"test","source":"express","msg":"ðŸ“ setupVite: Vite setup complete!"}
{"level":30,"time":1768708991597,"env":"test","msg":"Vite setup complete"}
{"level":30,"time":1768708991601,"env":"test","source":"express","msg":"serving on port 5000"}
{"level":30,"time":1768708991661,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
{"level":30,"time":1768708991661,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768708991664,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708991717,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK shut down successfully"}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mBoolean Type (Checkbox)[2m > [22m[2mshows loading spinner when saving checkbox
[22m[39mWarning: An update to EditableCell inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at EditableCell (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/EditableCell.tsx:12:25)

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768708991879,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
{"level":30,"time":1768708991880,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768708991880,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":40,"time":1768708991889,"env":"test","module":"metrics-routes","ip":"::ffff:127.0.0.1","msg":"Unauthorized metrics access attempt"}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708991916,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK shut down successfully"}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708991917,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708991920,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32mâœ“[39m tests/integration/metrics.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 4165[2mms[22m[39m
{"level":30,"time":1768708992176,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708992177,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w64_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w64_v3 (Reused: true)

 [32mâœ“[39m tests/unit/components/datavault/TableGridView.test.tsx [2m([22m[2m9 tests[22m[2m)[22m[33m 6759[2mms[22m[39m
     [33m[2mâœ“[22m[39m loads table schema and rows [33m 531[2mms[22m[39m
     [33m[2mâœ“[22m[39m enters edit mode on double click [33m 337[2mms[22m[39m
     [33m[2mâœ“[22m[39m updates cell value on blur [33m 584[2mms[22m[39m
     [33m[2mâœ“[22m[39m renders delete button for each row [33m 534[2mms[22m[39m
{"level":30,"time":1768708992419,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708992420,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708992532,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708992533,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/collab.client.test.tsx [2m([22m[2m17 tests[22m[2m)[22m[33m 6723[2mms[22m[39m
     [33m[2mâœ“[22m[39m should add a comment [33m 506[2mms[22m[39m
     [33m[2mâœ“[22m[39m should allow comment owner to delete their comment [33m 403[2mms[22m[39m
 [32mâœ“[39m tests/ui/datavault/EditableCell.test.tsx [2m([22m[2m29 tests[22m[2m)[22m[33m 8754[2mms[22m[39m
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mðŸ“Š Schema test_schema_w64_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708992716,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708992716,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768708992792,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708992792,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/ui/common/Breadcrumbs.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 4614[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

 [32mâœ“[39m tests/unit/components/datavault/SortableColumnHeader.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 4547[2mms[22m[39m
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768708993232,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708993232,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708993297,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708993297,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w66_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32mâœ“[39m tests/ui/datavault/TableCard.test.tsx [2m([22m[2m8 tests[22m[2m)[22m[33m 5966[2mms[22m[39m
     [33m[2mâœ“[22m[39m should call onDelete when delete button is clicked [33m 1495[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w66_v3 (Reused: true)

 [32mâœ“[39m tests/ui/runs.components.test.tsx [2m([22m[2m19 tests[22m[2m)[22m[33m 8010[2mms[22m[39m
       [33m[2mâœ“[22m[39m should show download options for successful runs [33m 1041[2mms[22m[39m
       [33m[2mâœ“[22m[39m should call onChange when status filter changes [33m 597[2mms[22m[39m
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w67_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w67_v3 (Reused: true)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mðŸ“Š Schema test_schema_w66_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768708993854,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708993854,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w63_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32mâœ“[39m tests/ui/datavault/DatabaseSettingsPage.test.tsx [2m([22m[2m7 tests[22m[2m)[22m[33m 5296[2mms[22m[39m
     [33m[2mâœ“[22m[39m should render database settings page with breadcrumbs [33m 563[2mms[22m[39m
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w63_v3 (Reused: true)

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708994001,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708994002,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w64_v3\",public"}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mðŸ“Š Schema test_schema_w67_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708994026,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708994027,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w69_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708994077,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w64_v3\",public"}
{"level":30,"time":1768708994078,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w69_v3 (Reused: true)

 [32mâœ“[39m tests/unit/components/datavault/CellRenderer.test.tsx [2m([22m[2m12 tests[22m[2m)[22m[33m 5633[2mms[22m[39m
     [33m[2mâœ“[22m[39m renders boolean value as Yes/No [33m 615[2mms[22m[39m
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w53_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w70_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w53_v3 (Reused: true)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w70_v3 (Reused: true)

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w71_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w71_v3 (Reused: true)

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mðŸ“Š Schema test_schema_w63_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mðŸ“Š Schema test_schema_w69_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w72_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w72_v3 (Reused: true)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mðŸ“Š Schema test_schema_w70_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w73_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mðŸ“Š Schema test_schema_w71_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w73_v3 (Reused: true)

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mðŸ“Š Schema test_schema_w53_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708994761,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708994762,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w53_v3\",public"}
{"level":30,"time":1768708994832,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w53_v3\",public"}
{"level":30,"time":1768708994832,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708994841,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708994842,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w66_v3\",public"}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w64_v3, public
âœ… Enforced search_path: test_schema_w64_v3, public

{"level":30,"time":1768708994921,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w66_v3\",public"}
{"level":30,"time":1768708994921,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w64_v3
âœ… Current search_path: test_schema_w64_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708994992,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708994994,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w67_v3\",public"}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mðŸ“Š Schema test_schema_w72_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768708995051,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w67_v3\",public"}
{"level":30,"time":1768708995051,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mðŸ“Š Schema test_schema_w73_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w74_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w75_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w74_v3 (Reused: true)

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w75_v3 (Reused: true)

{"level":50,"time":1768708995281,"env":"test","error":{},"workflowId":"b1406db3-c345-42be-8492-c44f54d06879","userId":"d54bf1a8-dbbd-4e76-ae91-3c56c5e8557d","projectId":"af7beeff-f75e-452f-b594-34e3cfdab62e","msg":"Error moving workflow"}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w65_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708995406,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708995407,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w63_v3\",public"}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w65_v3 (Reused: true)

{"level":30,"time":1768708995464,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w63_v3\",public"}
{"level":30,"time":1768708995464,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708995523,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708995524,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w69_v3\",public"}
{"level":30,"time":1768708995581,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w69_v3\",public"}
{"level":30,"time":1768708995581,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708995625,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mðŸ“Š Schema test_schema_w74_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w53_v3, public
âœ… Enforced search_path: test_schema_w53_v3, public

{"level":30,"time":1768708995627,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w70_v3\",public"}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708995639,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708995640,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w71_v3\",public"}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mðŸ“Š Schema test_schema_w75_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768708995683,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w70_v3\",public"}
{"level":30,"time":1768708995683,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708995696,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w71_v3\",public"}
{"level":30,"time":1768708995696,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w66_v3, public
âœ… Enforced search_path: test_schema_w66_v3, public

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w53_v3
âœ… Current search_path: test_schema_w53_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w66_v3
âœ… Current search_path: test_schema_w66_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mðŸ“Š Schema test_schema_w65_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w67_v3, public
âœ… Enforced search_path: test_schema_w67_v3, public

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w67_v3
âœ… Current search_path: test_schema_w67_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708995964,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708995965,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w72_v3\",public"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708996018,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708996019,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w73_v3\",public"}
{"level":30,"time":1768708996017,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w72_v3\",public"}
{"level":30,"time":1768708996017,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708996071,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w73_v3\",public"}
{"level":30,"time":1768708996071,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w63_v3, public
âœ… Enforced search_path: test_schema_w63_v3, public

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w68_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":50,"time":1768708996295,"env":"test","error":{},"workflowId":"8bea29ea-9330-45e6-901d-671b6fe1ac9b","userId":"d54bf1a8-dbbd-4e76-ae91-3c56c5e8557d","projectId":null,"msg":"Error moving workflow"}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w68_v3 (Reused: true)

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w63_v3
âœ… Current search_path: test_schema_w63_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708996418,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708996419,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w74_v3\",public"}
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w70_v3, public
âœ… Enforced search_path: test_schema_w70_v3, public

{"level":30,"time":1768708996463,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w74_v3\",public"}
{"level":30,"time":1768708996463,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w71_v3, public
âœ… Enforced search_path: test_schema_w71_v3, public

{"level":30,"time":1768708996469,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708996470,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w75_v3\",public"}
{"level":30,"time":1768708996506,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w75_v3\",public"}
{"level":30,"time":1768708996506,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w70_v3
âœ… Current search_path: test_schema_w70_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w71_v3
âœ… Current search_path: test_schema_w71_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708996629,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708996630,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w65_v3\",public"}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w69_v3, public
âœ… Enforced search_path: test_schema_w69_v3, public

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768708996673,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w65_v3\",public"}
{"level":30,"time":1768708996673,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mðŸ“Š Schema test_schema_w68_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w69_v3
âœ… Current search_path: test_schema_w69_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w72_v3, public
âœ… Enforced search_path: test_schema_w72_v3, public

{"level":30,"time":1768708996850,"env":"test","module":"email-queue","jobId":"208c49b9-a2e4-4f86-9061-0a890ed7f41f","msg":"Email job completed"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w73_v3, public
âœ… Enforced search_path: test_schema_w73_v3, public

{"level":40,"time":1768708996861,"env":"test","module":"tenant-middleware","userId":"d54bf1a8-dbbd-4e76-ae91-3c56c5e8557d","path":"/","msg":"User does not have an associated tenant"}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w72_v3
âœ… Current search_path: test_schema_w72_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w73_v3
âœ… Current search_path: test_schema_w73_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708996956,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708996957,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768708997012,"env":"test","error":{},"workflowId":"fa5929e5-6a2e-419c-802a-a87149ad51e6","userId":"d54bf1a8-dbbd-4e76-ae91-3c56c5e8557d","projectId":"00000000-0000-0000-0000-000000000000","msg":"Error moving workflow"}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w74_v3, public
âœ… Enforced search_path: test_schema_w74_v3, public

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w75_v3, public
âœ… Enforced search_path: test_schema_w75_v3, public

 [32mâœ“[39m tests/integration/api-docs.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 5951[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w74_v3
âœ… Current search_path: test_schema_w74_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w75_v3
âœ… Current search_path: test_schema_w75_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w65_v3, public
âœ… Enforced search_path: test_schema_w65_v3, public

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708997522,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708997523,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w68_v3\",public"}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w65_v3
âœ… Current search_path: test_schema_w65_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708997572,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w68_v3\",public"}
{"level":30,"time":1768708997572,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768708997594,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768708997965,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708997965,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708997990,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708997991,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/repeater.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 4829[2mms[22m[39m
 [32mâœ“[39m tests/unit/WorkflowChangeAnalyzer.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 4175[2mms[22m[39m
{"level":30,"time":1768708998054,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708998055,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w76_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32mâœ“[39m tests/ui/blocks/SendDataToTableBlockEditor.test.tsx [2m([22m[2m12 tests[22m[2m)[22m[33m 4793[2mms[22m[39m
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w76_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768708998218,"env":"test","status":401,"statusText":"Unauthorized","error":"Invalid client credentials","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768708998219,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768708998268,"env":"test","data":{"token_type":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768708998268,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768708998314,"env":"test","data":{"access_token":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768708998314,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708998337,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708998338,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w68_v3, public
âœ… Enforced search_path: test_schema_w68_v3, public

 [32mâœ“[39m tests/unit/utils/encryption.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 5418[2mms[22m[39m
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

{"level":50,"time":1768708998419,"env":"test","error":"Network error: ECONNREFUSED","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w68_v3
âœ… Current search_path: test_schema_w68_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mðŸ“Š Schema test_schema_w76_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

{"level":30,"time":1768708998602,"env":"test","module":"user-credentials-repository","userId":"3f719066-303b-4c2d-8edb-20d2e597c883","msg":"User credentials created"}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":30,"time":1768708998756,"env":"test","module":"email-queue","jobId":"2b346f94-2d3e-4abc-8804-17663428e948","to":"test-workflows-JTNCQFq9LaN8M3IUAsMD8@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstderr[2m | tests/unit/client/choice-utils.test.ts[2m > [22m[2mchoice-utils[2m > [22m[2mhandles missing content gracefully
[22m[39m[generateOptionsFromList] Invalid list data: [1mnull[22m

{"level":30,"time":1768708998839,"env":"test","module":"auth-routes","userId":"3f719066-303b-4c2d-8edb-20d2e597c883","email":"test-workflows-JTNCQFq9LaN8M3IUAsMD8@example.com","msg":"User registered"}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w78_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w78_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w77_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w79_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":50,"time":1768708998936,"env":"test","error":{},"workflowId":"fa99dc2d-2add-4f88-8133-0259d09015fd","userId":"3f719066-303b-4c2d-8edb-20d2e597c883","projectId":"abda8dc1-36cc-4c7f-96cb-4dfe8e0a72ef","msg":"Error moving workflow"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w77_v3 (Reused: true)

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w79_v3 (Reused: true)

{"level":50,"time":1768708998967,"env":"test","error":"Invalid credentials","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":30,"time":1768708998967,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708998968,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/client/choice-utils.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 4174[2mms[22m[39m
{"level":50,"time":1768708999019,"env":"test","error":"ECONNREFUSED","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":30,"time":1768708999084,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708999084,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w80_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708999093,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708999094,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708999110,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708999110,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/HelperLibrary.test.ts [2m([22m[2m60 tests[22m[2m)[22m[33m 7262[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w80_v3 (Reused: true)

 [32mâœ“[39m tests/integration/session.management.test.ts [2m([22m[2m22 tests[22m[2m)[22m[33m 4934[2mms[22m[39m
 [32mâœ“[39m tests/ui/datavault/TemplateCard.test.tsx [2m([22m[2m6 tests[22m[2m)[22m[33m 4152[2mms[22m[39m
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708999212,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708999213,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w76_v3\",public"}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708999261,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w76_v3\",public"}
{"level":30,"time":1768708999261,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768708999265,"env":"test","status":400,"statusText":"Bad Request","error":"Invalid grant_type","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768708999265,"env":"test","error":"OAuth2 token request failed: 400 Bad Request","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mðŸ“Š Schema test_schema_w78_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":50,"time":1768708999309,"env":"test","status":401,"statusText":"Unauthorized","error":"Client authentication failed","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768708999310,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

{"level":50,"time":1768708999358,"env":"test","status":403,"statusText":"Forbidden","error":"Access denied","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768708999358,"env":"test","error":"OAuth2 token request failed: 403 Forbidden","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mðŸ“Š Schema test_schema_w79_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mðŸ“Š Schema test_schema_w77_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":50,"time":1768708999408,"env":"test","status":500,"statusText":"Internal Server Error","error":"Server error","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768708999408,"env":"test","error":"OAuth2 token request failed: 500 Internal Server Error","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstderr[2m | tests/unit/shared/workflowLogic.test.ts[2m > [22m[2mworkflowLogic[2m > [22m[2mevaluateRules[2m > [22m[2mOperators[2m > [22m[2mUnknown operator[2m > [22m[2mshould return false and log warning for unknown operator
[22m[39mUnknown operator: unknown_operator

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

{"level":50,"time":1768708999457,"env":"test","error":"Unexpected token in JSON","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768708999511,"env":"test","error":"Request timeout","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768708999554,"env":"test","error":{"issues":[{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["projectId"]}],"name":"ZodError"},"workflowId":"d4aebdff-12c8-4c52-b367-e0bb02c1e7e6","userId":"d54bf1a8-dbbd-4e76-ae91-3c56c5e8557d","projectId":"invalid-uuid","msg":"Error moving workflow"}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mðŸ“Š Schema test_schema_w80_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768708999603,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708999604,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 5318[2mms[22m[39m
{"level":30,"time":1768708999796,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708999797,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/TemplateAnalysisService.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 5031[2mms[22m[39m
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w81_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w81_v3 (Reused: true)

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w82_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w84_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w76_v3, public
âœ… Enforced search_path: test_schema_w76_v3, public

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w84_v3 (Reused: true)

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w82_v3 (Reused: true)

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709000122,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709000123,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w78_v3\",public"}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w76_v3
âœ… Current search_path: test_schema_w76_v3, public
â© Schema reused, skipping migrations.

{"level":50,"time":1768709000156,"env":"test","error":{"issues":[{"code":"invalid_type","expected":"string","received":"undefined","path":["projectId"],"message":"Required"}],"name":"ZodError"},"workflowId":"e4e466ad-e928-42ff-835d-088352d50e9c","userId":"d54bf1a8-dbbd-4e76-ae91-3c56c5e8557d","msg":"Error moving workflow"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709000174,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709000175,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w77_v3\",public"}
{"level":30,"time":1768709000173,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w78_v3\",public"}
{"level":30,"time":1768709000173,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709000195,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709000196,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w79_v3\",public"}
{"level":30,"time":1768709000225,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w77_v3\",public"}
{"level":30,"time":1768709000225,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709000238,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w79_v3\",public"}
{"level":30,"time":1768709000238,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w83_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709000335,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709000336,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w80_v3\",public"}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w83_v3 (Reused: true)

{"level":30,"time":1768709000365,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w80_v3\",public"}
{"level":30,"time":1768709000365,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mðŸ“Š Schema test_schema_w81_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w85_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mðŸ“Š Schema test_schema_w82_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mðŸ“Š Schema test_schema_w84_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w85_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w86_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w86_v3 (Reused: true)

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mðŸ“Š Schema test_schema_w83_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768709000783,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709000784,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/shared/workflowLogic.test.ts [2m([22m[2m65 tests[22m[2m)[22m[33m 7013[2mms[22m[39m
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768709000913,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709000914,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mðŸ“Š Schema test_schema_w85_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w78_v3, public
âœ… Enforced search_path: test_schema_w78_v3, public

 [32mâœ“[39m tests/unit/workflows/validation.test.ts [2m([22m[2m66 tests[22m[2m)[22m[33m 7266[2mms[22m[39m
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w77_v3, public
âœ… Enforced search_path: test_schema_w77_v3, public

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709000996,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709000997,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w81_v3\",public"}
{"level":30,"time":1768709001008,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709001008,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w79_v3, public
âœ… Enforced search_path: test_schema_w79_v3, public

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w78_v3
âœ… Current search_path: test_schema_w78_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768709001048,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w81_v3\",public"}
{"level":30,"time":1768709001048,"env":"test","msg":"DB: initialized flag set."}
 [32mâœ“[39m tests/ui/datavault/ColumnTypeIcon.test.tsx [2m([22m[2m27 tests[22m[2m)[22m[33m 5176[2mms[22m[39m
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w77_v3
âœ… Current search_path: test_schema_w77_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768709001088,"env":"test","module":"user-credentials-repository","userId":"08e281ba-20cc-4af1-85ce-3ea5da44733d","msg":"User credentials created"}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w80_v3, public
âœ… Enforced search_path: test_schema_w80_v3, public

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mðŸ“Š Schema test_schema_w86_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w79_v3
âœ… Current search_path: test_schema_w79_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709001174,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709001175,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w82_v3\",public"}
{"level":30,"time":1768709001193,"env":"test","module":"email-queue","jobId":"46f2dd2f-5a67-448b-b90f-69e6335d31cc","to":"test-workflows-CFFgE5RvlhnmHmImtruw2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709001197,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709001198,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w84_v3\",public"}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w80_v3
âœ… Current search_path: test_schema_w80_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768709001234,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w82_v3\",public"}
{"level":30,"time":1768709001234,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709001244,"env":"test","module":"auth-routes","userId":"08e281ba-20cc-4af1-85ce-3ea5da44733d","email":"test-workflows-CFFgE5RvlhnmHmImtruw2@example.com","msg":"User registered"}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768709001259,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w84_v3\",public"}
{"level":30,"time":1768709001259,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709001423,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709001424,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

 [32mâœ“[39m tests/unit/engine/Performance.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 3714[2mms[22m[39m
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709001527,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709001527,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w83_v3\",public"}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768709001571,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w83_v3\",public"}
{"level":30,"time":1768709001571,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709001706,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709001706,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w85_v3\",public"}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w87_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709001743,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w85_v3\",public"}
{"level":30,"time":1768709001743,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w87_v3 (Reused: true)

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w81_v3, public
âœ… Enforced search_path: test_schema_w81_v3, public

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709001821,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709001821,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w86_v3\",public"}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w88_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768709001854,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w86_v3\",public"}
{"level":30,"time":1768709001854,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w88_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w81_v3
âœ… Current search_path: test_schema_w81_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768709001958,"env":"test","module":"auth-routes","userId":"08e281ba-20cc-4af1-85ce-3ea5da44733d","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w89_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w82_v3, public
âœ… Enforced search_path: test_schema_w82_v3, public

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w89_v3 (Reused: true)

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w84_v3, public
âœ… Enforced search_path: test_schema_w84_v3, public

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w82_v3
âœ… Current search_path: test_schema_w82_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w84_v3
âœ… Current search_path: test_schema_w84_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mðŸ“Š Schema test_schema_w87_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709002164,"env":"test","module":"audit-log-service","userId":"08e281ba-20cc-4af1-85ce-3ea5da44733d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w90_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w90_v3 (Reused: true)

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mðŸ“Š Schema test_schema_w88_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w83_v3, public
âœ… Enforced search_path: test_schema_w83_v3, public

{"level":30,"time":1768709002376,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709002377,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/WorkflowOptimizationService.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 3902[2mms[22m[39m
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mðŸ“Š Schema test_schema_w89_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w83_v3
âœ… Current search_path: test_schema_w83_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w85_v3, public
âœ… Enforced search_path: test_schema_w85_v3, public

{"level":50,"time":1768709002539,"env":"test","error":{},"workflowId":"84e37c76-e170-4fa1-9375-91bccba97f80","userId":"d54bf1a8-dbbd-4e76-ae91-3c56c5e8557d","projectId":"46e4c114-407b-4be3-a976-396e5efe5054","msg":"Error moving workflow"}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w85_v3
âœ… Current search_path: test_schema_w85_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w86_v3, public
âœ… Enforced search_path: test_schema_w86_v3, public

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mðŸ“Š Schema test_schema_w90_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709002713,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709002713,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w87_v3\",public"}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w86_v3
âœ… Current search_path: test_schema_w86_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768709002754,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w87_v3\",public"}
{"level":30,"time":1768709002754,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768709002864,"env":"test","module":"workflow-patch-service","error":{},"op":{"op":"step.create","sectionRef":"temp-section-1","type":"short_text","title":"Field 1","alias":"field1"},"msg":"Failed to apply operation"}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768709002939,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709002939,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709002941,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709002942,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w88_v3\",public"}
 [32mâœ“[39m tests/unit/client/list-choice-options.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 4402[2mms[22m[39m
{"level":30,"time":1768709002986,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w88_v3\",public"}
{"level":30,"time":1768709002986,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709003070,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709003071,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w89_v3\",public"}
{"level":50,"time":1768709003104,"env":"test","module":"workflow-patch-service","error":{},"op":{"op":"document.bindFields","id":"template-123","bindings":{"client_name":"nonExistentAlias"}},"msg":"Failed to apply operation"}
{"level":30,"time":1768709003111,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w89_v3\",public"}
{"level":30,"time":1768709003111,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709003123,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709003123,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w91_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768709003203,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709003204,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w91_v3 (Reused: true)

 [32mâœ“[39m tests/unit/services/WorkflowPatchService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 4675[2mms[22m[39m
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709003344,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709003345,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w90_v3\",public"}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mâœ… Applied failsafe schema fixes

 [31mâ¯[39m tests/integration/api.workflows.test.ts [2m([22m[2m17 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 20320[2mms[22m[39m
       [33m[2mâœ“[22m[39m should create a new draft workflow [33m 546[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject without permission [33m 766[2mms[22m[39m
       [33m[2mâœ“[22m[39m should list workflows [33m 628[2mms[22m[39m
       [33m[2mâœ“[22m[39m should filter by status [33m 594[2mms[22m[39m
       [33m[2mâœ“[22m[39m should search by name [33m 1028[2mms[22m[39m
       [33m[2mâœ“[22m[39m should update draft workflow [33m 847[2mms[22m[39m
       [33m[2mâœ“[22m[39m should not allow editing published workflow [33m 989[2mms[22m[39m
       [33m[2mâœ“[22m[39m should publish workflow [33m 838[2mms[22m[39m
       [33m[2mâœ“[22m[39m should list workflow versions [33m 1007[2mms[22m[39m
[31m       [31mÃ—[31m should move workflow to a project[39m[33m 1188[2mms[22m[39m
[31m       [31mÃ—[31m should move workflow to Main Folder (projectId = null)[39m[33m 1012[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject move to non-existent project [33m 717[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject move without authentication [33m 581[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject move of workflow user does not own [33m 1342[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject move with invalid projectId format [33m 618[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject move without projectId in body [33m 602[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject move to project user does not have access to [33m 2382[2mms[22m[39m
{"level":30,"time":1768709003394,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w90_v3\",public"}
{"level":30,"time":1768709003394,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w87_v3, public
âœ… Enforced search_path: test_schema_w87_v3, public

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w87_v3
âœ… Current search_path: test_schema_w87_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mðŸ“Š Schema test_schema_w91_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

{"level":50,"time":1768709003706,"env":"test","module":"intake-navigation","error":{},"pageId":"page1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating visibleIf condition"}
{"level":30,"time":1768709003725,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709003726,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w88_v3, public
âœ… Enforced search_path: test_schema_w88_v3, public

 [32mâœ“[39m tests/ui/blocks/SendDataBlockEditorRouting.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 4091[2mms[22m[39m
{"level":50,"time":1768709003760,"env":"test","module":"intake-navigation","error":{},"pageId":"page1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating skipIf condition"}
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w92_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w88_v3
âœ… Current search_path: test_schema_w88_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768709003852,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709003853,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w92_v3 (Reused: true)

{"level":30,"time":1768709003870,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709003870,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w89_v3, public
âœ… Enforced search_path: test_schema_w89_v3, public

{"level":30,"time":1768709003879,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709003879,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/intakeNavigation.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 4311[2mms[22m[39m
 [32mâœ“[39m tests/unit/shared/validation/PageValidator.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 3778[2mms[22m[39m
 [32mâœ“[39m tests/integration/api.ai.test.ts [2m([22m[2m32 tests[22m[2m)[22m[33m 5156[2mms[22m[39m
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w89_v3
âœ… Current search_path: test_schema_w89_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w93_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w93_v3 (Reused: true)

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w90_v3, public
âœ… Enforced search_path: test_schema_w90_v3, public

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w90_v3
âœ… Current search_path: test_schema_w90_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mðŸ“Š Schema test_schema_w92_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w94_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w94_v3 (Reused: true)

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768709004357,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709004357,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/utils/pagination.test.ts [2m([22m[2m24 tests[22m[2m)[22m[33m 4742[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709004405,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709004406,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w91_v3\",public"}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768709004442,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w91_v3\",public"}
{"level":30,"time":1768709004442,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768709004462,"env":"test","warnings":["Python code does not call emit(). Script will not produce output."],"msg":"Script validation warnings"}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mðŸ“Š Schema test_schema_w93_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w95_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w95_v3 (Reused: true)

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mðŸ“Š Schema test_schema_w94_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768709004745,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709004746,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w96_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w97_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w98_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32mâœ“[39m tests/unit/ScriptEngine.test.ts [2m([22m[2m26 tests[22m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 4838[2mms[22m[39m
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w96_v3 (Reused: true)

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w97_v3 (Reused: true)

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w98_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709004827,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709004828,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w92_v3\",public"}
{"level":30,"time":1768709004877,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w92_v3\",public"}
{"level":30,"time":1768709004878,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mðŸ“Š Schema test_schema_w95_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":30,"time":1768709005097,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709005097,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32mâœ“[39m tests/unit/utils/conditionalLogic-simple.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 3635[2mms[22m[39m
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709005140,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709005141,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w93_v3\",public"}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768709005194,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w93_v3\",public"}
{"level":30,"time":1768709005194,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w91_v3, public
âœ… Enforced search_path: test_schema_w91_v3, public

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mðŸ“Š Schema test_schema_w97_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mðŸ“Š Schema test_schema_w98_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mðŸ“Š Schema test_schema_w96_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w91_v3
âœ… Current search_path: test_schema_w91_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w99_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w99_v3 (Reused: true)

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709005416,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709005417,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w94_v3\",public"}
{"level":30,"time":1768709005467,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w94_v3\",public"}
{"level":30,"time":1768709005467,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w100_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w92_v3, public
âœ… Enforced search_path: test_schema_w92_v3, public

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w100_v3 (Reused: true)

{"level":30,"time":1768709005748,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709005749,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w92_v3
âœ… Current search_path: test_schema_w92_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709005774,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709005775,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w95_v3\",public"}
 [32mâœ“[39m tests/unit/services/docxHelpers.test.ts [2m([22m[2m39 tests[22m[2m)[22m[33m 5462[2mms[22m[39m
{"level":30,"time":1768709005825,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w95_v3\",public"}
{"level":30,"time":1768709005825,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mðŸ“Š Schema test_schema_w99_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709005933,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709005934,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w97_v3\",public"}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709005947,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709005948,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w96_v3\",public"}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w101_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709005987,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w97_v3\",public"}
{"level":30,"time":1768709005987,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w93_v3, public
âœ… Enforced search_path: test_schema_w93_v3, public

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709005997,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709005998,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w98_v3\",public"}
{"level":30,"time":1768709006000,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w96_v3\",public"}
{"level":30,"time":1768709006000,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w101_v3 (Reused: true)

{"level":30,"time":1768709006039,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w98_v3\",public"}
{"level":30,"time":1768709006039,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w93_v3
âœ… Current search_path: test_schema_w93_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mðŸ“Š Schema test_schema_w100_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w94_v3, public
âœ… Enforced search_path: test_schema_w94_v3, public

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w94_v3
âœ… Current search_path: test_schema_w94_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mðŸ“Š Schema test_schema_w101_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709006437,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709006438,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w99_v3\",public"}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768709006475,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w99_v3\",public"}
{"level":30,"time":1768709006475,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w95_v3, public
âœ… Enforced search_path: test_schema_w95_v3, public

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709006689,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w95_v3
âœ… Current search_path: test_schema_w95_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768709006690,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w100_v3\",public"}
{"level":30,"time":1768709006722,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w100_v3\",public"}
{"level":30,"time":1768709006722,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w97_v3, public
âœ… Enforced search_path: test_schema_w97_v3, public

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w96_v3, public
âœ… Enforced search_path: test_schema_w96_v3, public

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w98_v3, public
âœ… Enforced search_path: test_schema_w98_v3, public

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w97_v3
âœ… Current search_path: test_schema_w97_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w96_v3
âœ… Current search_path: test_schema_w96_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w98_v3
âœ… Current search_path: test_schema_w98_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mreviseWorkflow should delegate to revision service
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709006951,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709006952,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w101_v3\",public"}
[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mWorkflow Generation[2m > [22m[2mgenerateWorkflow should return a generated workflow
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w102_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709006982,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w101_v3\",public"}
{"level":30,"time":1768709006982,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mWorkflow Suggestions[2m > [22m[2msuggestWorkflowImprovements should return suggestions
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w102_v3 (Reused: true)

{"level":30,"time":1768709007056,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709007056,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mWorkflow Suggestions[2m > [22m[2msuggestTemplateBindings should return bindings
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

 [32mâœ“[39m tests/integration/auth.routes.test.ts [2m([22m[2m41 tests[22m[2m)[22m[33m 5472[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mWorkflow Suggestions[2m > [22m[2msuggestValues should return values
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mLogic Analysis[2m > [22m[2mgenerateLogic should return logic rules
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mLogic Analysis[2m > [22m[2mdebugLogic should return issues
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w99_v3, public
âœ… Enforced search_path: test_schema_w99_v3, public

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mLogic Analysis[2m > [22m[2mvisualizeLogic should return graph data
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

{"level":30,"time":1768709007263,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709007263,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/AIService.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 3826[2mms[22m[39m
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w99_v3
âœ… Current search_path: test_schema_w99_v3, public
â© Schema reused, skipping migrations.

[90mstderr[2m | tests/unit/shared/conditionEvaluator.test.ts[2m > [22m[2mconditionEvaluator[2m > [22m[2mComparison operators[2m > [22m[2mUnknown operator[2m > [22m[2mshould default to true and log warning
[22m[39mUnknown operator: unknown_operator

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mðŸ“Š Schema test_schema_w102_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w100_v3, public
âœ… Enforced search_path: test_schema_w100_v3, public

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w100_v3
âœ… Current search_path: test_schema_w100_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w103_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w101_v3, public
âœ… Enforced search_path: test_schema_w101_v3, public

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w103_v3 (Reused: true)

{"level":30,"time":1768709007836,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709007836,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768709007843,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709007843,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768709007852,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709007853,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/workflows/conditionTruthTable.test.ts [2m([22m[2m51 tests[22m[2m)[22m[33m 5975[2mms[22m[39m
 [32mâœ“[39m tests/unit/utils/conditionalLogic.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 5056[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w101_v3
âœ… Current search_path: test_schema_w101_v3, public
â© Schema reused, skipping migrations.

 [32mâœ“[39m tests/unit/shared/validation/stepConfigSchemas.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 3993[2mms[22m[39m
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709007937,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709007938,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w102_v3\",public"}
{"level":30,"time":1768709007988,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w102_v3\",public"}
{"level":30,"time":1768709007988,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709007995,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709007995,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w104_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32mâœ“[39m tests/ui/builder.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 3782[2mms[22m[39m
{"level":30,"time":1768709008069,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w104_v3 (Reused: true)

{"level":30,"time":1768709008069,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768709008100,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709008100,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/intake.portal.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 4420[2mms[22m[39m
{"level":30,"time":1768709008123,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709008124,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/shared/conditionEvaluator.test.ts [2m([22m[2m70 tests[22m[2m)[22m[33m 6788[2mms[22m[39m
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mâœ… Applied failsafe schema fixes

 [32mâœ“[39m tests/unit/workflow/QueryBlock.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 3757[2mms[22m[39m
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mðŸ“Š Schema test_schema_w103_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mðŸ“Š Schema test_schema_w104_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768709008544,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709008545,"env":"test","msg":"DB: pool closed."}
{"level":40,"time":1768709008565,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
 [32mâœ“[39m tests/unit/captcha.service.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 4161[2mms[22m[39m
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

{"level":40,"time":1768709008615,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

{"level":40,"time":1768709008662,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":40,"time":1768709008715,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w105_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":40,"time":1768709008765,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709008773,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709008773,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w105_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w102_v3, public
âœ… Enforced search_path: test_schema_w102_v3, public

 [32mâœ“[39m tests/unit/isolatedVmBridge.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 3817[2mms[22m[39m
{"level":30,"time":1768709008817,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709008817,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/RunExecutionCoordinator.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 3554[2mms[22m[39m
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w102_v3
âœ… Current search_path: test_schema_w102_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w108_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w109_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w108_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w109_v3 (Reused: true)

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w106_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w110_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709009089,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709009090,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w103_v3\",public"}
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w106_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w111_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w110_v3 (Reused: true)

{"level":30,"time":1768709009142,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w103_v3\",public"}
{"level":30,"time":1768709009142,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w111_v3 (Reused: true)

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mðŸ“Š Schema test_schema_w105_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709009292,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709009293,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w104_v3\",public"}
{"level":30,"time":1768709009338,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w104_v3\",public"}
{"level":30,"time":1768709009338,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mðŸ“Š Schema test_schema_w109_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mðŸ“Š Schema test_schema_w108_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mðŸ“Š Schema test_schema_w106_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mðŸ“Š Schema test_schema_w110_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mðŸ“Š Schema test_schema_w111_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

{"level":30,"time":1768709009672,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709009673,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mâœ… Applied failsafe schema fixes

 [32mâœ“[39m tests/unit/shared/validation/Validator.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 4123[2mms[22m[39m
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w103_v3, public
âœ… Enforced search_path: test_schema_w103_v3, public

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w103_v3
âœ… Current search_path: test_schema_w103_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w104_v3, public
âœ… Enforced search_path: test_schema_w104_v3, public

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w104_v3
âœ… Current search_path: test_schema_w104_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w112_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w112_v3 (Reused: true)

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709010368,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709010369,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w108_v3\",public"}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709010391,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709010392,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w109_v3\",public"}
{"level":30,"time":1768709010418,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w108_v3\",public"}
{"level":30,"time":1768709010418,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709010429,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709010430,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w106_v3\",public"}
{"level":30,"time":1768709010445,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w109_v3\",public"}
{"level":30,"time":1768709010445,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709010480,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709010481,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w111_v3\",public"}
{"level":30,"time":1768709010482,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w106_v3\",public"}
{"level":30,"time":1768709010482,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709010492,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709010493,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w110_v3\",public"}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w113_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709010531,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w111_v3\",public"}
{"level":30,"time":1768709010531,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709010544,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w110_v3\",public"}
{"level":30,"time":1768709010544,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w113_v3 (Reused: true)

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mðŸ“Š Schema test_schema_w112_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709010766,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709010767,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w112_v3\",public"}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768709010812,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w112_v3\",public"}
{"level":30,"time":1768709010812,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w105_v3, public
âœ… Enforced search_path: test_schema_w105_v3, public

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w105_v3
âœ… Current search_path: test_schema_w105_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mðŸ“Š Schema test_schema_w113_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709010983,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709010983,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w113_v3\",public"}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768709011019,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w113_v3\",public"}
{"level":30,"time":1768709011019,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w114_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w108_v3, public
âœ… Enforced search_path: test_schema_w108_v3, public

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w114_v3 (Reused: true)

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w109_v3, public
âœ… Enforced search_path: test_schema_w109_v3, public

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w106_v3, public
âœ… Enforced search_path: test_schema_w106_v3, public

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w108_v3
âœ… Current search_path: test_schema_w108_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w115_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w111_v3, public
âœ… Enforced search_path: test_schema_w111_v3, public

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w110_v3, public
âœ… Enforced search_path: test_schema_w110_v3, public

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w106_v3
âœ… Current search_path: test_schema_w106_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w109_v3
âœ… Current search_path: test_schema_w109_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768709011339,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709011339,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w115_v3 (Reused: true)

 [32mâœ“[39m tests/unit/services/docxRenderer2.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 4734[2mms[22m[39m
{"level":30,"time":1768709011404,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709011404,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w111_v3
âœ… Current search_path: test_schema_w111_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w110_v3
âœ… Current search_path: test_schema_w110_v3, public
â© Schema reused, skipping migrations.

 [32mâœ“[39m tests/unit/listPipeline.semantics.test.ts [2m([22m[2m70 tests[22m[2m)[22m[33m 7020[2mms[22m[39m
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w112_v3, public
âœ… Enforced search_path: test_schema_w112_v3, public

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mðŸ“Š Schema test_schema_w114_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709011691,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709011692,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w114_v3\",public"}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w113_v3
âœ… Current search_path: test_schema_w113_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768709011734,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w114_v3\",public"}
{"level":30,"time":1768709011734,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mðŸ“Š Schema test_schema_w115_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w113_v3, public
âœ… Enforced search_path: test_schema_w113_v3, public

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709011836,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709011837,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w115_v3\",public"}
{"level":30,"time":1768709011879,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w115_v3\",public"}
{"level":30,"time":1768709011879,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w113_v3
âœ… Current search_path: test_schema_w113_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768709012085,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709012085,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32mâœ“[39m tests/unit/utils/variableResolver.test.ts [2m([22m[2m20 tests[22m[2m)[22m[33m 4688[2mms[22m[39m
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/BlockRunner.validate.test.ts [2m([22m[2m7 tests[22m[2m)[22m[33m 4061[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w114_v3, public
âœ… Enforced search_path: test_schema_w114_v3, public

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768709012540,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709012541,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

{"level":30,"time":1768709012565,"env":"test","module":"workflow-quality-validator","overall":99,"breakdown":{"aliases":100,"types":100,"structure":100,"ux":95,"completeness":100,"validation":100},"issuesCount":1,"passed":true,"msg":"Workflow quality validation completed"}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768709012566,"env":"test","module":"workflow-generation-service","duration":6,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":99,"qualityBreakdown":{"aliases":100,"types":100,"structure":100,"ux":95,"completeness":100,"validation":100},"qualityPassed":true,"issuesCount":1,"msg":"AI workflow generation succeeded"}
 [32mâœ“[39m tests/unit/engine.expr.test.ts [2m([22m[2m26 tests[22m[2m)[22m[33m 4916[2mms[22m[39m
{"level":50,"time":1768709012614,"env":"test","module":"workflow-generation-service","error":{"code":"VALIDATION_ERROR","message":"","retryable":false},"duration":2,"msg":"AI workflow generation failed"}
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w113_v3
âœ… Current search_path: test_schema_w42_v3, public
â© Schema reused, skipping migrations.

{"level":50,"time":1768709012667,"env":"test","module":"workflow-generation-service","error":{"code":"VALIDATION_ERROR","message":"","retryable":false},"duration":0,"msg":"AI workflow generation failed"}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w115_v3, public
âœ… Enforced search_path: test_schema_w115_v3, public

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":50,"time":1768709012718,"env":"test","module":"workflow-generation-service","error":{"code":"VALIDATION_ERROR","message":"","retryable":false},"duration":1,"msg":"AI workflow generation failed"}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768709012762,"env":"test","module":"workflow-generation-service","error":{"status":429,"code":"rate_limit_exceeded"},"duration":0,"msg":"AI workflow generation failed"}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w115_v3
âœ… Current search_path: test_schema_w115_v3, public
â© Schema reused, skipping migrations.

{"level":50,"time":1768709012813,"env":"test","module":"workflow-generation-service","error":{},"duration":0,"msg":"AI workflow generation failed"}
{"level":30,"time":1768709012824,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w117_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709012916,"env":"test","module":"workflow-quality-validator","overall":100,"breakdown":{"aliases":100,"types":100,"structure":100,"ux":100,"completeness":100,"validation":100},"issuesCount":0,"passed":true,"msg":"Workflow quality validation completed"}
{"level":30,"time":1768709012917,"env":"test","module":"workflow-generation-service","duration":1,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":100,"qualityBreakdown":{"aliases":100,"types":100,"structure":100,"ux":100,"completeness":100,"validation":100},"qualityPassed":true,"issuesCount":0,"msg":"AI workflow generation succeeded"}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w117_v3 (Reused: true)

{"level":30,"time":1768709012969,"env":"test","module":"workflow-quality-validator","overall":96,"breakdown":{"aliases":100,"types":100,"structure":80,"ux":100,"completeness":90,"validation":100},"issuesCount":2,"passed":true,"msg":"Workflow quality validation completed"}
{"level":30,"time":1768709012969,"env":"test","module":"workflow-generation-service","duration":1,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":96,"qualityBreakdown":{"aliases":100,"types":100,"structure":80,"ux":100,"completeness":90,"validation":100},"qualityPassed":true,"issuesCount":2,"msg":"AI workflow generation succeeded"}
{"level":40,"time":1768709012973,"env":"test","module":"rbac-middleware","path":"/api/workflows","permission":"workflow:create","msg":"Unauthenticated user attempted to access protected resource"}
{"level":30,"time":1768709013019,"env":"test","module":"workflow-suggestion-service","duration":1,"suggestionsCount":1,"msg":"AI binding suggestion succeeded"}
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":40,"time":1768709013022,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","permission":"workflow:create","path":"/api/workflows","msg":"Permission denied"}
{"level":30,"time":1768709013020,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709013021,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

 [32mâœ“[39m tests/unit/ai.service.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 4348[2mms[22m[39m
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts[2m > [22m[2mIntakeQuestionVisibilityService[2m > [22m[2mHelper methods[2m > [22m[2mshould get visible question count
[22m[39mMOCK SETUP DONE. Mock questions: [
  {
    id: [32m'q1'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q1'[39m,
    order: [33m0[39m,
    isVirtual: [33mfalse[39m,
    alias: [32m'show'[39m,
    visibleIf: [1mnull[22m
  },
  {
    id: [32m'q2'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q2'[39m,
    order: [33m1[39m,
    isVirtual: [33mfalse[39m,
    visibleIf: { op: [32m'equals'[39m, left: [36m[Object][39m, right: [36m[Object][39m }
  },
  {
    id: [32m'q3'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q3'[39m,
    order: [33m2[39m,
    isVirtual: [33mfalse[39m,
    visibleIf: [1mnull[22m
  }
]
Calling getVisibleQuestionCount...

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts[2m > [22m[2mIntakeQuestionVisibilityService[2m > [22m[2mHelper methods[2m > [22m[2mshould get visible question count
[22m[39mCOUNT RESULT: [33m0[39m
Mock called times: [33m1[39m
Mock last call args: [ [ [32m'section1'[39m ] ]

{"level":40,"time":1768709013166,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":null,"permission":"workflow:view","path":"/api/workflows","msg":"Permission denied"}
{"level":40,"time":1768709013261,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","permissions":["workflow:create","workflow:edit","workflow:delete"],"path":"/api/workflows","msg":"Permission denied (none of required permissions)"}
{"level":30,"time":1768709013314,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709013314,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/mfa.flow.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 4701[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mðŸ“Š Schema test_schema_w117_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709013364,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709013364,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w117_v3\",public"}
{"level":50,"time":1768709013373,"env":"test","module":"intake-question-visibility","error":{},"questionId":"q1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating visibleIf condition"}
{"level":40,"time":1768709013398,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"builder","permissions":["workflow:edit","workflow:delete"],"path":"/api/workflows","msg":"Permission denied (missing some required permissions)"}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768709013423,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w117_v3\",public"}
{"level":30,"time":1768709013426,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709013423,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709013427,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mDEBUG: Existing functions: []

 [32mâœ“[39m tests/unit/services/intakeQuestionVisibility.test.ts [2m([22m[2m19 tests[22m[2m)[22m[33m 4695[2mms[22m[39m
{"level":30,"time":1768709013513,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709013514,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mâœ… Applied failsafe schema fixes

 [32mâœ“[39m tests/integration/conditions/conditionEvaluation.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 4819[2mms[22m[39m
{"level":40,"time":1768709013581,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","requiredRoles":["owner","builder"],"path":"/api/admin","msg":"Role check failed"}
{"level":30,"time":1768709013584,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709013585,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mDEBUG: Existing functions: []

 [32mâœ“[39m tests/integration/analytics_preservation.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 3679[2mms[22m[39m
     [33m[2mâœ“[22m[39m should preserve lifetime user count when a user is deleted [33m 715[2mms[22m[39m
{"level":40,"time":1768709013632,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":null,"requiredRoles":["owner"],"path":"/api/admin","msg":"Role check failed"}
{"level":40,"time":1768709013724,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"builder","requiredRoles":["owner"],"path":"/api/test","msg":"Role check failed"}
{"level":30,"time":1768709013807,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709013808,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768709013820,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w118_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32mâœ“[39m tests/unit/repositories/DocumentTemplateRepository.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 3696[2mms[22m[39m
{"level":30,"time":1768709013859,"env":"test","module":"ai-controller","userId":"user-123","workflowId":"123e4567-e89b-12d3-a456-426614174000","descriptionLength":26,"msg":"AI logic generation requested"}
{"level":40,"time":1768709013865,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"runner","requiredRoles":["owner","builder"],"path":"/api/test","msg":"Role check failed"}
{"level":30,"time":1768709013860,"env":"test","module":"ai-controller","userId":"user-123","workflowId":"123e4567-e89b-12d3-a456-426614174000","duration":2,"changeCount":0,"msg":"AI logic generation succeeded"}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w118_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768709013922,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768709013982,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768709013991,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709013992,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":40,"time":1768709014051,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","requiredRoles":["owner","builder","runner"],"path":"/api/test","msg":"Role check failed"}
 [32mâœ“[39m tests/unit/api.ai.logic.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 3199[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w117_v3, public
âœ… Enforced search_path: test_schema_w117_v3, public

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mðŸ“Š Schema test_schema_w118_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w114_v3
âœ… Current search_path: test_schema_w114_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768709014306,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709014307,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w118_v3\",public"}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

{"level":40,"time":1768709014367,"env":"test","module":"rbac-middleware","path":"/api/test","permission":"workflow:view","msg":"Unauthenticated user attempted to access protected resource"}
{"level":30,"time":1768709014367,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w118_v3\",public"}
{"level":30,"time":1768709014367,"env":"test","msg":"DB: initialized flag set."}
{"level":40,"time":1768709014413,"env":"test","module":"rbac-middleware","userId":"user-123","permission":"workflow:view","path":"/api/test","msg":"Permission denied"}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w120_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":40,"time":1768709014460,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"invalid-role","permission":"workflow:view","path":"/api/test","msg":"Permission denied"}
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709014461,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709014461,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w120_v3 (Reused: true)

 [32mâœ“[39m tests/unit/middleware/rbac.test.ts [2m([22m[2m44 tests[22m[2m)[22m[33m 5876[2mms[22m[39m
[90mstdout[2m | tests/ListTools.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mðŸ“Š Schema test_schema_w120_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709014914,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709014915,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w120_v3\",public"}
{"level":30,"time":1768709014972,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w120_v3\",public"}
{"level":30,"time":1768709014972,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w121_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w121_v3 (Reused: true)

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w118_v3, public
âœ… Enforced search_path: test_schema_w118_v3, public

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w118_v3
âœ… Current search_path: test_schema_w118_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mðŸ“Š Schema test_schema_w121_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709015547,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

{"level":30,"time":1768709015547,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts[2m > [22m[2mDatavaultColumnsService[2m > [22m[2mgetColumns[2m > [22m[2mshould throw 404 if table not found
[22m[39m[DEBUG] Table not found: 660e8400-e29b-41d4-a716-446655440001

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709015593,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709015594,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w121_v3\",public"}
 [32mâœ“[39m tests/unit/schema/collections.test.ts [2m([22m[2m34 tests[22m[2m)[22m[33m 4602[2mms[22m[39m
{"level":30,"time":1768709015663,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w121_v3\",public"}
{"level":30,"time":1768709015663,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w122_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w122_v3 (Reused: true)

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w120_v3, public
âœ… Enforced search_path: test_schema_w120_v3, public

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w117_v3
âœ… Current search_path: test_schema_w117_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w125_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w107_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w125_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w107_v3 (Reused: true)

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w123_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w123_v3 (Reused: true)

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mðŸ“Š Schema test_schema_w122_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709016165,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709016166,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w122_v3\",public"}
{"level":30,"time":1768709016215,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w122_v3\",public"}
{"level":30,"time":1768709016215,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w126_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709016300,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709016300,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w119_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w126_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mðŸ“Š Schema test_schema_w125_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709016335,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709016335,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w125_v3\",public"}
 [32mâœ“[39m tests/unit/services/DatavaultColumnsService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 3795[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mðŸ“Š Schema test_schema_w107_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709016347,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709016348,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w107_v3\",public"}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w119_v3 (Reused: true)

{"level":30,"time":1768709016386,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w125_v3\",public"}
{"level":30,"time":1768709016386,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709016397,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w107_v3\",public"}
{"level":30,"time":1768709016397,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mðŸ“Š Schema test_schema_w123_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709016436,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709016437,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w123_v3\",public"}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w121_v3, public
âœ… Enforced search_path: test_schema_w121_v3, public

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

{"level":30,"time":1768709016484,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w123_v3\",public"}
{"level":30,"time":1768709016484,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w128_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w121_v3
âœ… Current search_path: test_schema_w121_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w128_v3 (Reused: true)

{"level":30,"time":1768709016667,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768709016667,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/lib/queries/QueryRunner.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 3205[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mðŸ“Š Schema test_schema_w126_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709016723,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709016724,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w126_v3\",public"}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mðŸ“Š Schema test_schema_w119_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709016773,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709016774,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w119_v3\",public"}
{"level":30,"time":1768709016777,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w126_v3\",public"}
{"level":30,"time":1768709016777,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709016826,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w119_v3\",public"}
{"level":30,"time":1768709016826,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709016896,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mðŸ“Š Schema test_schema_w128_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w122_v3, public
âœ… Enforced search_path: test_schema_w122_v3, public

{"level":30,"time":1768709017012,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709017013,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w128_v3\",public"}
{"level":30,"time":1768709017055,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w128_v3\",public"}
{"level":30,"time":1768709017055,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w123_v3
âœ… Current search_path: test_schema_w120_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w125_v3, public
âœ… Enforced search_path: test_schema_w125_v3, public

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w107_v3, public
âœ… Enforced search_path: test_schema_w107_v3, public

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w124_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w126_v3
âœ… Current search_path: test_schema_w119_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w126_v3
âœ… Current search_path: test_schema_w120_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w124_v3 (Reused: true)

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w123_v3, public
âœ… Enforced search_path: test_schema_w123_v3, public

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w129_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w129_v3 (Reused: true)

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w126_v3
âœ… Current search_path: test_schema_w120_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[DEBUG] BaseRepository.update datavault_columns: id=770e8400-e29b-41d4-a716-446655440002, updates={"name":"Mobile Phone","required":true,"updatedAt":"2026-01-18T04:03:37.476Z"}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w126_v3, public
âœ… Enforced search_path: test_schema_w126_v3, public

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w119_v3, public
âœ… Enforced search_path: test_schema_w119_v3, public

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w127_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w120_v3
âœ… Current search_path: test_schema_w120_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768709017677,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709017678,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mðŸ“Š Schema test_schema_w124_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w127_v3 (Reused: true)

{"level":30,"time":1768709017695,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709017696,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w124_v3\",public"}
 [32mâœ“[39m tests/unit/repositories/DatavaultColumnsRepository.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 3625[2mms[22m[39m
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w120_v3
âœ… Current search_path: test_schema_w120_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768709017748,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w124_v3\",public"}
{"level":30,"time":1768709017748,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mðŸ“Š Schema test_schema_w129_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709017800,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709017801,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w129_v3\",public"}
{"level":30,"time":1768709017839,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w129_v3\",public"}
{"level":30,"time":1768709017839,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w128_v3, public
âœ… Enforced search_path: test_schema_w128_v3, public

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w107_v3
âœ… Current search_path: test_schema_w123_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mðŸ“Š Schema test_schema_w127_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709018092,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709018093,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w127_v3\",public"}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768709018136,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w127_v3\",public"}
{"level":30,"time":1768709018136,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w131_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w131_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w130_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w130_v3 (Reused: true)

{"level":30,"time":1768709018429,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts[2m > [22m[2mPersonalization API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768709018439,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768709018439,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768709018445,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768709018445,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w124_v3, public
âœ… Enforced search_path: test_schema_w124_v3, public

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709018581,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w129_v3, public
âœ… Enforced search_path: test_schema_w129_v3, public

{"level":30,"time":1768709018608,"env":"test","module":"ai-controller","userId":"user-123","workflowId":"123e4567-e89b-12d3-a456-426614174000","msg":"AI workflow revision job enqueued"}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w125_v3
âœ… Current search_path: test_schema_w125_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768709018664,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":50,"time":1768709018669,"env":"test","module":"ai-controller","error":{"issues":[{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["workflowId"]},{"code":"invalid_type","expected":"object","received":"undefined","path":["currentWorkflow"],"message":"Required"},{"code":"invalid_type","expected":"string","received":"undefined","path":["userInstruction"],"message":"Required"}],"name":"ZodError"},"msg":"Failed to enqueue AI revision job"}
{"level":30,"time":1768709018672,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709018672,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mðŸ“Š Schema test_schema_w131_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709018688,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709018689,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w131_v3\",public"}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w125_v3
âœ… Current search_path: test_schema_w125_v3, public
â© Schema reused, skipping migrations.

 [32mâœ“[39m tests/unit/api.ai.revise.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 3112[2mms[22m[39m
{"level":30,"time":1768709018721,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709018722,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768709018723,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w131_v3\",public"}
{"level":30,"time":1768709018723,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mðŸ“Š Schema test_schema_w130_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709018763,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709018763,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w130_v3\",public"}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768709018793,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w130_v3\",public"}
{"level":30,"time":1768709018793,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w127_v3, public
âœ… Enforced search_path: test_schema_w127_v3, public

{"level":30,"time":1768709018905,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709018906,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/api.ai.personalization.test.ts [2m([22m[2m3 tests[22m[2m | [22m[33m3 skipped[39m[2m)[22m[33m 3253[2mms[22m[39m
       [2m[90mâ†“[39m[22m should rewrite text based on user settings
       [2m[90mâ†“[39m[22m should generate help text
       [2m[90mâ†“[39m[22m should update user settings
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w116_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32mâœ“[39m tests/unit/services/DocumentTemplateService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 3666[2mms[22m[39m
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w119_v3
âœ… Current search_path: test_schema_w119_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w132_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w116_v3 (Reused: true)

{"level":30,"time":1768709019007,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709019008,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w132_v3 (Reused: true)

 [32mâœ“[39m tests/unit/services/DatavaultTablesService.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 3566[2mms[22m[39m
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768709019225,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709019226,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/schema/documentEngine.test.ts [2m([22m[2m33 tests[22m[2m)[22m[33m 4562[2mms[22m[39m
[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould skip question when condition is false
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: false. Context keys: 3

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute question when condition is true
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: true. Context keys: 4

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute question when condition is true
[22m[39m[DEBUG Question] Node q2 executed. Key: code, Value: ABC123. Context keys: 5

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mðŸ“Š Schema test_schema_w116_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709019408,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709019409,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w116_v3\",public"}
[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould skip compute node when condition is false
[22m[39m[DEBUG Question] Node q1 executed. Key: amount, Value: 0. Context keys: 3

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mðŸ“Š Schema test_schema_w132_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709019434,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709019435,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w132_v3\",public"}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768709019463,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w116_v3\",public"}
{"level":30,"time":1768709019463,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute compute node when condition is true
[22m[39m[DEBUG Question] Node q1 executed. Key: amount, Value: 100. Context keys: 3

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768709019482,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w132_v3\",public"}
{"level":30,"time":1768709019482,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w131_v3, public
âœ… Enforced search_path: test_schema_w131_v3, public

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould handle complex workflow with multiple conditions
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: false. Context keys: 4

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould handle complex workflow with multiple conditions
[22m[39m[DEBUG Question] Node q3 executed. Key: amount, Value: 1000. Context keys: 5

[DEBUG] BaseRepository.update datavault_tables: id=660e8400-e29b-41d4-a716-446655440001, updates={"name":"Updated Table","description":"Updated description","updatedAt":"2026-01-18T04:03:39.527Z"}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w130_v3, public
âœ… Enforced search_path: test_schema_w130_v3, public

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w128_v3
âœ… Current search_path: test_schema_w128_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w126_v3
âœ… Current search_path: test_schema_w128_v3, public
â© Schema reused, skipping migrations.

{"level":40,"time":1768709019647,"env":"test","sourceListVar":"nonexistent_list","inputKey":"nonexistent_list","msg":"Input list not found, treating as empty array"}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768709019678,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709019678,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/repositories/DatavaultTablesRepository.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 3553[2mms[22m[39m
{"level":30,"time":1768709019696,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709019697,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/ListTools.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 3840[2mms[22m[39m
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstderr[2m | tests/unit/debugging/Lineage.test.ts[2m > [22m[2mDebug & Lineage[2m > [22m[2mshould generate execution trace with lineage
[22m[39m[DEBUG Question] Node q1 executed. Key: userName, Value: Alice. Context keys: 3

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768709019861,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709019861,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mDebug Mode[2m > [22m[2mshould return trace when debug is enabled
[22m[39m[DEBUG Question] Node q1 executed. Key: name, Value: John. Context keys: 3

 [32mâœ“[39m tests/unit/debugging/Lineage.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 3009[2mms[22m[39m
[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mDebug Mode[2m > [22m[2mshould not return trace when debug is disabled
[22m[39m[DEBUG Question] Node q1 executed. Key: name, Value: John. Context keys: 3

{"level":30,"time":1768709020035,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709020036,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

 [32mâœ“[39m tests/unit/engine.run-conditions.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 4115[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return trace when debug is enabled [33m 408[2mms[22m[39m
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w116_v3, public
âœ… Enforced search_path: test_schema_w116_v3, public

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w132_v3, public
âœ… Enforced search_path: test_schema_w132_v3, public

{"level":30,"time":1768709020289,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709020289,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w127_v3
âœ… Current search_path: test_schema_w129_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w127_v3
âœ… Current search_path: test_schema_w129_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

 [32mâœ“[39m tests/unit/workflow/PreviewExecution.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 3018[2mms[22m[39m
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709020546,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709020546,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

 [32mâœ“[39m tests/unit/services/StepService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 3592[2mms[22m[39m
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w134_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w134_v3 (Reused: true)

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w136_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w136_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mðŸ“Š Schema test_schema_w134_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709021106,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709021107,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w134_v3\",public"}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w137_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w133_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768709021156,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w134_v3\",public"}
{"level":30,"time":1768709021156,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w137_v3 (Reused: true)

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w133_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mðŸ“Š Schema test_schema_w136_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709021260,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709021261,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w136_v3\",public"}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709021309,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w136_v3\",public"}
{"level":30,"time":1768709021309,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w142_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w142_v3 (Reused: true)

{"level":30,"time":1768709021505,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768709021529,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts[2m > [22m[2mAI Document Assistant API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768709021515,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768709021516,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768709021522,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768709021523,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768709021529,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768709021529,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768709021529,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768709021529,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768709021542,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709021543,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

 [32mâœ“[39m tests/unit/services/RecordService.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 3695[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mðŸ“Š Schema test_schema_w133_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709021590,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709021592,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709021591,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w133_v3\",public"}
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709021593,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w138_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":40,"time":1768709021605,"env":"test","error":{},"msg":"Deterministic DOCX extraction failed"}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mðŸ“Š Schema test_schema_w137_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709021608,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709021609,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w137_v3\",public"}
{"level":30,"time":1768709021644,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w133_v3\",public"}
{"level":30,"time":1768709021644,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w138_v3 (Reused: true)

{"level":30,"time":1768709021659,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w137_v3\",public"}
{"level":30,"time":1768709021659,"env":"test","msg":"DB: initialized flag set."}
 [32mâœ“[39m tests/integration/datavault.api-tokens.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 3655[2mms[22m[39m
[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mðŸ“Š Schema test_schema_w142_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":30,"time":1768709021796,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709021796,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w134_v3, public
âœ… Enforced search_path: test_schema_w134_v3, public

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w141_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w141_v3 (Reused: true)

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w132_v3
âœ… Current search_path: test_schema_w133_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mðŸ“Š Schema test_schema_w138_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709022062,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709022063,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w138_v3\",public"}
 [32mâœ“[39m tests/integration/api.ai.doc.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 3224[2mms[22m[39m
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w136_v3, public
âœ… Enforced search_path: test_schema_w136_v3, public

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w139_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768709022114,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w138_v3\",public"}
{"level":30,"time":1768709022114,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w139_v3 (Reused: true)

{"level":30,"time":1768709022180,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709022180,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w132_v3
âœ… Current search_path: test_schema_w132_v3, public
â© Schema reused, skipping migrations.

 [32mâœ“[39m tests/unit/services/CollectionService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 3573[2mms[22m[39m
[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w143_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w143_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mâš ï¸ Could not set database-level search_path (expected in cloud DBs): tuple concurrently updated
âœ… Enforced search_path: test_schema_w137_v3, public

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mðŸ“Š Schema test_schema_w141_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w133_v3, public
âœ… Enforced search_path: test_schema_w133_v3, public

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w132_v3
âœ… Current search_path: test_schema_w138_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w138_v3
âœ… Current search_path: test_schema_w127_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mðŸ“Š Schema test_schema_w139_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709022545,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709022546,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w139_v3\",public"}
[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

{"level":30,"time":1768709022592,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w139_v3\",public"}
{"level":30,"time":1768709022592,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w145_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w145_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

{"level":30,"time":1768709022687,"env":"test","workflowId":"123e4567-e89b-12d3-a456-426614174000","userId":"user-123","sectionsCount":2,"stepsCount":0,"logicRulesCount":1,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mðŸ“Š Schema test_schema_w143_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

 [32mâœ“[39m tests/unit/services/WorkflowService.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 1778[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return workflow if user is the creator [33m 920[2mms[22m[39m
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mDEBUG: Existing functions: []

 [32mâœ“[39m tests/unit/services/PortalAuthService.test.ts [2m([22m[2m42 tests[22m[2m)[22m[33m 983[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w138_v3, public
âœ… Enforced search_path: test_schema_w138_v3, public

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w139_v3
âœ… Current search_path: test_schema_w139_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w135_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mðŸ“Š Schema test_schema_w145_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstderr[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): Error: [vitest] No "closeDatabase" export is defined on the "../../../server/db" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

    at VitestMocker.createError [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:311:17[90m)[39m
    at Object.get [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:384:16[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:177:34
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m {
  codeFrame: [32m'vi.mock(import("../../../server/db"), async (importOriginal) => {\n'[39m +
    [32m'  const actual = await importOriginal()\n'[39m +
    [32m'  return {\n'[39m +
    [32m'    ...actual,\n'[39m +
    [32m'    // your mocked methods\n'[39m +
    [32m'  }\n'[39m +
    [32m'})'[39m
}

{"level":30,"time":1768709023087,"env":"test","module":"write-runner","operation":"write_start","mode":"create","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"create","columnMappings":[{"columnId":"col-first","value":"{{ firstName }}"},{"columnId":"col-last","value":"Doe"},{"columnId":"col-age","value":"{{ age }}"}]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":30,"time":1768709023097,"env":"test","module":"write-runner","operation":"write_start","mode":"create","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"create","columnMappings":[]},"tableId":"table-users","preview":true,"msg":"Starting write execution"}
[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w135_v3 (Reused: true)

{"level":30,"time":1768709023097,"env":"test","module":"write-runner","operation":"write_preview_simulated","values":{},"msg":"Simulating write in preview mode"}
{"level":30,"time":1768709023099,"env":"test","module":"write-runner","operation":"write_start","mode":"update","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"test@example.com","columnMappings":[{"columnId":"col-status","value":"Active"}]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":30,"time":1768709023100,"env":"test","module":"write-runner","operation":"write_start","mode":"update","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"missing@example.com","columnMappings":[]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":50,"time":1768709023101,"env":"test","module":"write-runner","error":{},"config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"missing@example.com","columnMappings":[]},"msg":"Write execution failed"}
 [32mâœ“[39m tests/unit/writes/WriteRunner.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 898[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w144_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w144_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w139_v3, public
âœ… Enforced search_path: test_schema_w139_v3, public

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w136_v3
âœ… Current search_path: test_schema_w136_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mðŸ“Š Schema test_schema_w135_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709023522,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709023523,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w135_v3\",public"}
[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768709023568,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w135_v3\",public"}
{"level":30,"time":1768709023568,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/services/MfaService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 2046[2mms[22m[39m
[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mðŸ“Š Schema test_schema_w144_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/engine/FinalBlockSnapshot.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 860[2mms[22m[39m
{"level":30,"time":1768709023746,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709023746,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w146_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32mâœ“[39m tests/unit/debug_import.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 3008[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w146_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w147_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w147_v3 (Reused: true)

{"level":30,"time":1768709023928,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709023929,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768709023957,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709023958,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/services/BrandingService.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 3706[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w140_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32mâœ“[39m tests/services/EmailTemplateMetadataService.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 3564[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w140_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mðŸ“Š Schema test_schema_w146_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/services/BrandingService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 888[2mms[22m[39m
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mðŸ“Š Schema test_schema_w147_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w135_v3, public
âœ… Enforced search_path: test_schema_w135_v3, public

 [32mâœ“[39m tests/unit/services/EmailTemplateMetadataService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 903[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w148_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mðŸ“Š Schema test_schema_w140_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709024455,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709024456,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w140_v3\",public"}
[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w148_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w137_v3
âœ… Current search_path: test_schema_w137_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768709024511,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w140_v3\",public"}
{"level":30,"time":1768709024511,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768709024580,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709024580,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/DataSourceService.test.ts [2m([22m[2m9 tests[22m[2m)[22m[33m 3387[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w149_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w149_v3 (Reused: true)

[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

{"level":30,"time":1768709024790,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709024791,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w153_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32mâœ“[39m tests/unit/services/CollectionFieldService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 4056[2mms[22m[39m
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w153_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mðŸ“Š Schema test_schema_w148_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/services/DatavaultReferenceColumns.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 889[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mðŸ“Š Schema test_schema_w149_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w150_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32mâœ“[39m tests/unit/services/DatavaultRowsService.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 871[2mms[22m[39m
[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w150_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w154_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w154_v3 (Reused: true)

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mðŸ“Š Schema test_schema_w153_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":30,"time":1768709025284,"env":"test","msg":"External Send Completed","destination":"My Webhook","success":true,"status":200}
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709025289,"env":"test","msg":"Simulating External Send","destination":"Test","payload":{}}
[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w151_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32mâœ“[39m tests/unit/external/ExternalSendRunner.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 870[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w140_v3, public
âœ… Enforced search_path: test_schema_w140_v3, public

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w151_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w139_v3
âœ… Current search_path: test_schema_w139_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w152_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w152_v3 (Reused: true)

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mðŸ“Š Schema test_schema_w150_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":40,"time":1768709025568,"env":"test","hookId":"hook-1","hookName":"Hook 1","error":"Test error","msg":"LifecycleHookService: Hook execution failed"}
[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":50,"time":1768709025571,"env":"test","error":{},"workflowId":"workflow-1","runId":"run-1","phase":"beforePage","msg":"LifecycleHookService: Failed to execute hooks for phase"}
{"level":30,"time":1768709025573,"env":"test","hookId":"hook-1","workflowId":"workflow-1","phase":"beforePage","msg":"LifecycleHookService: Created lifecycle hook"}
{"level":30,"time":1768709025578,"env":"test","hookId":"hook-1","workflowId":"workflow-1","msg":"LifecycleHookService: Updated lifecycle hook"}
{"level":30,"time":1768709025580,"env":"test","hookId":"hook-1","workflowId":"workflow-1","msg":"LifecycleHookService: Deleted lifecycle hook"}
[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w155_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

 [32mâœ“[39m tests/unit/LifecycleHookService.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 865[2mms[22m[39m
[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709025636,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709025637,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w155_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mðŸ“Š Schema test_schema_w154_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

 [32mâœ“[39m tests/integration/branding.routes.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 3952[2mms[22m[39m
[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/services/Guardrail.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 861[2mms[22m[39m
[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mðŸ“Š Schema test_schema_w151_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

 [2m[90mâ†“[39m[22m tests/unit/collab.server.test.ts [2m([22m[2m14 tests[22m[2m | [22m[33m14 skipped[39m[2m)[22m
[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/services/AccountLockoutService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 861[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mðŸ“Š Schema test_schema_w152_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/repositories/DatavaultRowsRepository.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 864[2mms[22m[39m
[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mðŸ“Š Schema test_schema_w155_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/services/AuditLogService.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 864[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768709026202,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709026202,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mDEBUG: Existing functions: []

 [32mâœ“[39m tests/integration/datavault.row-notes.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 3535[2mms[22m[39m
{"level":30,"time":1768709027845,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709027846,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/datavault.routes.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 4258[2mms[22m[39m
Failed to parse file:///C:/Users/scoot/poll/VaultLogic/client/src/components/builder/cards/ChoiceCardEditor.tsx. Excluding it from coverage.
 Error [RollupError]: Expected ',', got 'UniversalBlock'
    at getRollupError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/rollup/dist/es/shared/parseAst.js:401:41)
    at convertProgram (file:///C:/Users/scoot/poll/VaultLogic/node_modules/rollup/dist/es/shared/parseAst.js:1098:26)
    at parseAstAsync (file:///C:/Users/scoot/poll/VaultLogic/node_modules/rollup/dist/es/shared/parseAst.js:2084:106)
    at V8CoverageProvider.remapCoverage (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/coverage-v8/dist/provider.js:135:10)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/coverage-v8/dist/provider.js:121:23
    at async Promise.all (index 7)
    at V8CoverageProvider.getCoverageMapForUncoveredFiles (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/coverage-v8/dist/provider.js:111:4)
    at V8CoverageProvider.generateCoverage (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/coverage-v8/dist/provider.js:59:29)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/cli-api.BKg19Fvw.js:12546:23
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/cli-api.BKg19Fvw.js:12559:11 {
  code: 'PARSE_ERROR',
  pos: 1537
}

[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Failed Suites 27 [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m

[41m[1m FAIL [22m[49m tests/integration/api.ai.personalization.test.ts[2m > [22mPersonalization API Integration Tests
[31m[1mError[22m: Failed query: insert into "user_personalization_settings" ("user_id", "reading_level", "tone", "verbosity", "language", "allow_adaptive_prompts", "allow_ai_clarification", "created_at", "updated_at") values ($1, $2, $3, default, $4, default, default, default, default)
params: test-user-id-integration,simple,friendly,es[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/api.ai.personalization.test.ts:[2m74:9[22m[39m
    [90m 72| [39m
    [90m 73| [39m        [90m// Insert Settings[39m
    [90m 74| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(userPersonalizationSettings)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 75| [39m            userId[33m:[39m [33mTEST_USER_ID[39m[33m,[39m
    [90m 76| [39m            tone[33m:[39m [32m'friendly'[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "user_personalization_settings" violates foreign key constraint "user_personalization_settings_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/api.ai.personalization.test.ts:[2m74:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 388, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(test-user-id-integration) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w125_v3', table: 'user_personalization_settings', dataType: undefined, constraint: 'user_personalization_settings_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[1/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.dataSources.native.test.ts[2m > [22mData Sources API - Native Catalog
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/api.dataSources.native.test.ts:[2m20:15[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[2/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.dataSources.native.test.ts[2m > [22mData Sources API - Native Catalog
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/api.dataSources.native.test.ts:[2m30:19[22m[39m
    [90m 28| [39m
    [90m 29| [39m    [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 30| [39m        [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m 31| [39m    })[33m;[39m
    [90m 32| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[3/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.expression-validation.test.ts[2m > [22mExpression Validation API Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/api.expression-validation.test.ts:[2m20:11[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[4/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.expression-validation.test.ts[2m > [22mExpression Validation API Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/api.expression-validation.test.ts:[2m76:15[22m[39m
    [90m 74| [39m
    [90m 75| [39m  [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 76| [39m    [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m              [31m^[39m
    [90m 77| [39m  })[33m;[39m
    [90m 78| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[5/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.projects.test.ts[2m > [22mProjects API Integration Tests
[31m[1mError[22m: expected 201 "Created", got 500 "Internal Server Error"[39m
[36m [2mâ¯[22m tests/integration/api.projects.test.ts:[2m66:8[22m[39m
    [90m 64| [39m        lastName[33m:[39m [32m"User"[39m[33m,[39m
    [90m 65| [39m      })
    [90m 66| [39m      [33m.[39m[34mexpect[39m([34m201[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m 67| [39m
    [90m 68| [39m    authToken [33m=[39m registerResponse[33m.[39mbody[33m.[39mtoken[33m;[39m
[90m [2mâ¯[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2mâ¯[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2mâ¯[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2mâ¯[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m156:7[22m[39m
[90m [2mâ¯[22m Test.Request.callback node_modules/superagent/lib/node/index.js:[2m857:3[22m[39m
[90m [2mâ¯[22m node_modules/superagent/lib/node/index.js:[2m1102:18[22m[39m
[90m [2mâ¯[22m IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:[2m21:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[6/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.runs.docx.test.ts[2m > [22mRuns API - DOCX Generation Integration Tests
[31m[1mError[22m: expected 201 "Created", got 500 "Internal Server Error"[39m
[36m [2mâ¯[22m tests/integration/api.runs.docx.test.ts:[2m113:8[22m[39m
    [90m111| [39m      [33m.[39m[34mpost[39m([32m'/api/auth/register'[39m)
    [90m112| [39m      [33m.[39m[34msend[39m({ email[33m,[39m password[33m:[39m [32m'TestPassword123!@#Strong'[39m })
    [90m113| [39m      [33m.[39m[34mexpect[39m([34m201[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m114| [39m
    [90m115| [39m    authToken [33m=[39m registerResponse[33m.[39mbody[33m.[39mtoken[33m;[39m
[90m [2mâ¯[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2mâ¯[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2mâ¯[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2mâ¯[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m156:7[22m[39m
[90m [2mâ¯[22m Test.Request.callback node_modules/superagent/lib/node/index.js:[2m857:3[22m[39m
[90m [2mâ¯[22m node_modules/superagent/lib/node/index.js:[2m1102:18[22m[39m
[90m [2mâ¯[22m IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:[2m21:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[7/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.runs.graph.test.ts[2m > [22mStage 8: Runs API Integration Tests
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "email" = $6, "tenant_id" = $7, "role" = $8, "tenant_role" = $9
params: test-user-runs-stage8,test-runs-stage8-iodSjRsUPRxiCz2zuQP6x@example.com,fb93acf3-a519-4520-9255-8ebb3c0ff147,admin,owner,test-runs-stage8-iodSjRsUPRxiCz2zuQP6x@example.com,fb93acf3-a519-4520-9255-8ebb3c0ff147,admin,owner[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/api.runs.graph.test.ts:[2m123:5[22m[39m
    [90m121| [39m    userId [33m=[39m [32m"test-user-runs-stage8"[39m[33m;[39m
    [90m122| [39m
    [90m123| [39m    [35mawait[39m db[33m.[39m[34minsert[39m(schema[33m.[39musers)[33m.[39m[34mvalues[39m({
    [90m   | [39m    [31m^[39m
    [90m124| [39m      id[33m:[39m userId[33m,[39m
    [90m125| [39m      email[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/api.runs.graph.test.ts:[2m123:5[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(fb93acf3-a519-4520-9255-8ebb3c0ff147) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w43_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[8/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.templates-runs.test.ts[2m > [22mTemplates and Runs API Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m Module.setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/api.templates-runs.test.ts:[2m59:11[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[9/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.templates-runs.test.ts[2m > [22mTemplates and Runs API Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/api.templates-runs.test.ts:[2m85:15[22m[39m
    [90m 83| [39m
    [90m 84| [39m  [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 85| [39m    [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m              [31m^[39m
    [90m 86| [39m  })[33m;[39m
    [90m 87| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[10/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, default, $7, $8, $9, default, default, $10, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: test-user-collections-e2e,test-collections-e2e@example.com,Collections E2E Test User,Collections,E2E Test User,84bafec8-a2a3-4ab0-9aca-c36db93af842,owner,local,easy,[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/collections.e2e.test.ts:[2m34:20[22m[39m
    [90m 32| [39m
    [90m 33| [39m    [90m// Create test user[39m
    [90m 34| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 35| [39m      id[33m:[39m [32m'test-user-collections-e2e'[39m[33m,[39m
    [90m 36| [39m      email[33m:[39m [32m'test-collections-e2e@example.com'[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/collections.e2e.test.ts:[2m34:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(84bafec8-a2a3-4ab0-9aca-c36db93af842) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[11/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/dataBlocks.test.ts[2m > [22mData Block Integration Tests
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, $6, default, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 590438d3-4a40-467a-9208-9d0639ed0132,datablock-test@example.com,2b27fc12-2014-4e82-abaf-a3387dff28ad,admin,owner,google[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/dataBlocks.test.ts:[2m49:24[22m[39m
    [90m 47| [39m        tenantId [33m=[39m tenant[33m.[39mid[33m;[39m
    [90m 48| [39m
    [90m 49| [39m        [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                       [31m^[39m
    [90m 50| [39m            id[33m:[39m [34muuidv4[39m()[33m,[39m
    [90m 51| [39m            email[33m:[39m testEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/dataBlocks.test.ts:[2m49:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(2b27fc12-2014-4e82-abaf-a3387dff28ad) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w22_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[12/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault-v4-regression.test.ts[2m > [22mDataVault v4 Regression Tests
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, $6, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $7, "role" = $8, "tenant_role" = $9
params: google-user-id,testuser@example.com,33ea36e6-25c8-424e-8ea4-8e176b3dcc6a,admin,owner,google,33ea36e6-25c8-424e-8ea4-8e176b3dcc6a,admin,owner[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/datavault-v4-regression.test.ts:[2m90:5[22m[39m
    [90m 88| [39m    [90m// Create test user manually with correct tenant and admin role[39m
    [90m 89| [39m    testUserId [33m=[39m [32m'google-user-id'[39m[33m;[39m
    [90m 90| [39m    [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m    [31m^[39m
    [90m 91| [39m      id[33m:[39m testUserId[33m,[39m
    [90m 92| [39m      email[33m:[39m [32m'testuser@example.com'[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/datavault-v4-regression.test.ts:[2m90:5[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(33ea36e6-25c8-424e-8ea4-8e176b3dcc6a) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w31_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[13/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.autonumber.test.ts[2m > [22mDataVault Autonumber Integration Tests
[31m[1mError[22m: Failed query: insert into "datavault_tables" ("id", "tenant_id", "owner_user_id", "database_id", "name", "slug", "description", "created_at", "updated_at") values (default, $1, $2, default, $3, $4, $5, default, default) returning "id", "tenant_id", "owner_user_id", "database_id", "name", "slug", "description", "created_at", "updated_at"
params: 315c3324-62a2-460c-b924-e1b2b26fc2a2,,Autonumber Test Table,autonumber_test_table,Testing autonumber functionality[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m DatavaultTablesRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
    [90m 88| [39m    [35mconst[39m database [33m=[39m [35mthis[39m[33m.[39m[34mgetDb[39m(tx)[33m;[39m
    [90m 89| [39m
    [90m 90| [39m    [35mconst[39m [record] [33m=[39m [35mawait[39m database
    [90m   | [39m                     [31m^[39m
    [90m 91| [39m      [33m.[39m[34minsert[39m([35mthis[39m[33m.[39mtable [35mas[39m any)
    [90m 92| [39m      [33m.[39m[34mvalues[39m(data [35mas[39m any)
[90m [2mâ¯[22m DatavaultTablesService.createTable server/services/DatavaultTablesService.ts:[2m171:19[22m[39m
[90m [2mâ¯[22m tests/integration/datavault.autonumber.test.ts:[2m29:19[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "datavault_tables" violates foreign key constraint "datavault_tables_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m DatavaultTablesRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
[90m [2mâ¯[22m DatavaultTablesService.createTable server/services/DatavaultTablesService.ts:[2m171:19[22m[39m
[90m [2mâ¯[22m tests/integration/datavault.autonumber.test.ts:[2m29:19[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 359, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(315c3324-62a2-460c-b924-e1b2b26fc2a2) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w42_v3', table: 'datavault_tables', dataType: undefined, constraint: 'datavault_tables_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[14/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.permissions.test.ts[2m > [22mDataVault Table Permissions API (v4 Micro-Phase 6)
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/datavault.permissions.test.ts:[2m22:11[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[15/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.permissions.test.ts[2m > [22mDataVault Table Permissions API (v4 Micro-Phase 6)
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/datavault.permissions.test.ts:[2m66:15[22m[39m
    [90m 64| [39m
    [90m 65| [39m  [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 66| [39m    [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m              [31m^[39m
    [90m 67| [39m  })[33m;[39m
    [90m 68| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[16/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/dynamic_options_workflow.test.ts[2m > [22mDynamic Options Integration Flow
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, default, default, default, default, default, default, default, default, $5, $6, $7, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Dynamic Options Test,Testing read -> choice flow,0469a3d3-243b-4348-8f92-906f638e83fd,0469a3d3-243b-4348-8f92-906f638e83fd,draft,user,0469a3d3-243b-4348-8f92-906f638e83fd[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m WorkflowRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
    [90m 88| [39m    [35mconst[39m database [33m=[39m [35mthis[39m[33m.[39m[34mgetDb[39m(tx)[33m;[39m
    [90m 89| [39m
    [90m 90| [39m    [35mconst[39m [record] [33m=[39m [35mawait[39m database
    [90m   | [39m                     [31m^[39m
    [90m 91| [39m      [33m.[39m[34minsert[39m([35mthis[39m[33m.[39mtable [35mas[39m any)
    [90m 92| [39m      [33m.[39m[34mvalues[39m(data [35mas[39m any)
[90m [2mâ¯[22m WorkflowRepository.create server/repositories/WorkflowRepository.ts:[2m25:22[22m[39m
[90m [2mâ¯[22m server/services/WorkflowService.ts:[2m173:24[22m[39m
[90m [2mâ¯[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2mâ¯[22m tests/integration/dynamic_options_workflow.test.ts:[2m41:26[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m WorkflowRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
[90m [2mâ¯[22m WorkflowRepository.create server/repositories/WorkflowRepository.ts:[2m25:22[22m[39m
[90m [2mâ¯[22m server/services/WorkflowService.ts:[2m173:24[22m[39m
[90m [2mâ¯[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2mâ¯[22m tests/integration/dynamic_options_workflow.test.ts:[2m41:26[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(0469a3d3-243b-4348-8f92-906f638e83fd) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w47_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[17/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/externalSends.test.ts[2m > [22mExternal Send Block Integration
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, default, $3, $4, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Ex Send,External Send Project,6e94c007-39e0-49ec-9eec-41ee55c3253a,932590fa-b1cf-4070-be7d-d4179d76711f,6e94c007-39e0-49ec-9eec-41ee55c3253a,6e94c007-39e0-49ec-9eec-41ee55c3253a[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/externalSends.test.ts:[2m61:27[22m[39m
    [90m 59| [39m
    [90m 60| [39m        [90m// 3. Setup Project[39m
    [90m 61| [39m        [35mconst[39m [project] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(projects)[33m.[39m[34mvalues[39m({
    [90m   | [39m                          [31m^[39m
    [90m 62| [39m            name[33m:[39m [32m'External Send Project'[39m[33m,[39m
    [90m 63| [39m            title[33m:[39m [32m'Ex Send'[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/externalSends.test.ts:[2m61:27[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(6e94c007-39e0-49ec-9eec-41ee55c3253a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w44_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[18/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/intake.workflow.test.ts[2m > [22mIntake Workflow Integration Tests
[31m[1mError[22m: Project creation failed: {"message":"Tenant required","error":"no_tenant","details":"Your account is not associated with any tenant. Please contact support."}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m153:15[22m[39m
    [90m151| [39m
    [90m152| [39m      [35mif[39m (projectResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m153| [39m        throw new Error(`Project creation failed: ${JSON.stringify(proâ€¦
    [90m   | [39m              [31m^[39m
    [90m154| [39m      }
    [90m155| [39m
[90m [2mâ¯[22m tests/integration/intake.workflow.test.ts:[2m11:15[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[19/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/intake.workflow.test.ts[2m > [22mIntake Workflow Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/intake.workflow.test.ts:[2m21:19[22m[39m
    [90m 19| [39m
    [90m 20| [39m    [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 21| [39m        [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m 22| [39m    })[33m;[39m
    [90m 23| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[20/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/js_helpers.test.ts[2m > [22mDetailed Verification: JS Helper Availability
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values (default, $1, default, default, default, default, $2, $3, $4, default, default, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: test-0UtCW53xa3TK0PMWSzP0m@example.com,66e5540b-3eae-4851-82d6-485954fbc2cf,admin,owner[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/js_helpers.test.ts:[2m92:24[22m[39m
    [90m 90| [39m
    [90m 91| [39m        [90m// Setup User[39m
    [90m 92| [39m        [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                       [31m^[39m
    [90m 93| [39m            email[33m:[39m [32m`test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m,[39m
    [90m 94| [39m            tenantId[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/js_helpers.test.ts:[2m92:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(66e5540b-3eae-4851-82d6-485954fbc2cf) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w24_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[21/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/lifecycle-hooks-execution.test.ts[2m > [22mLifecycle Hooks Execution
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/lifecycle-hooks-execution.test.ts:[2m41:11[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/lifecycle-hooks-execution.test.ts[2m > [22mLifecycle Hooks Execution
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/lifecycle-hooks-execution.test.ts:[2m89:15[22m[39m
    [90m 87| [39m
    [90m 88| [39m  [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 89| [39m    [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m              [31m^[39m
    [90m 90| [39m  })[33m;[39m
    [90m 91| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[23/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-audit-fixes.test.ts[2m > [22mOrganization Audit Fixes
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict do nothing
params: 38aa66b8-213d-47ad-8772-6407b526e6be,audit-user1@test.com,Audit User 1,682e53b7-d448-41d2-8e49-d7e9e635dd2d,6403aea7-6b75-42e9-8c98-b88fea9d6481,audit-user2@test.com,Audit User 2,682e53b7-d448-41d2-8e49-d7e9e635dd2d[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizations-audit-fixes.test.ts:[2m42:5[22m[39m
    [90m 40| [39m
    [90m 41| [39m    [90m// Create test users[39m
    [90m 42| [39m    [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m    [31m^[39m
    [90m 43| [39m      {
    [90m 44| [39m        id[33m:[39m user1Id[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizations-audit-fixes.test.ts:[2m42:5[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(682e53b7-d448-41d2-8e49-d7e9e635dd2d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w27_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[24/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-workflow.test.ts[2m > [22mOrganization Workflow Integration Tests
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default), ($9, $10, $11, default, default, default, $12, default, default, default, default, default, default, default, default, default, default, default) on conflict do nothing
params: c364f2d6-d26f-47bc-bf97-bd472cca3227,org-owner@test.com,Org Owner,79c6eb02-2ce1-4504-99fc-30d6cd8a0023,3d91550b-2290-4e32-8173-7e24192ea613,org-member@test.com,Org Member,79c6eb02-2ce1-4504-99fc-30d6cd8a0023,7ce32199-9256-47a6-9640-d9780abe7ee4,non-member@test.com,Non Member,79c6eb02-2ce1-4504-99fc-30d6cd8a0023[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizations-workflow.test.ts:[2m50:5[22m[39m
    [90m 48| [39m
    [90m 49| [39m    [90m// Create test users[39m
    [90m 50| [39m    [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m    [31m^[39m
    [90m 51| [39m      {
    [90m 52| [39m        id[33m:[39m user1Id[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizations-workflow.test.ts:[2m50:5[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(79c6eb02-2ce1-4504-99fc-30d6cd8a0023) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w47_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[25/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, default, default, $3, default, $4, $5, default, default, default, default, default, default)
params: ef4cfc41-1ca7-4f4e-b172-c2bbc0817ff8,Regression Project,a814c7b0-4bd5-41ed-b232-a70775412096,a814c7b0-4bd5-41ed-b232-a70775412096,a814c7b0-4bd5-41ed-b232-a70775412096[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/regression-REG-1.test.ts:[2m74:9[22m[39m
    [90m 72| [39m
    [90m 73| [39m        projectId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 74| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(projects)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 75| [39m            id[33m:[39m projectId[33m,[39m
    [90m 76| [39m            title[33m:[39m [32m"Regression Project"[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/regression-REG-1.test.ts:[2m74:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(a814c7b0-4bd5-41ed-b232-a70775412096) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w48_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[26/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/workflow_versioning.test.ts[2m > [22mWorkflow Versioning & Lineage
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values (default, $1, $2, default, default, default, $3, $4, $5, default, default, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: test_versioning_1768708981622@example.com,Versioning Tester,597a033f-4092-4fc1-9287-28247c705ba6,admin,owner[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/workflow_versioning.test.ts:[2m27:24[22m[39m
    [90m 25| [39m
    [90m 26| [39m        [90m// Create User (Needed for Project creator/owner)[39m
    [90m 27| [39m        [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                       [31m^[39m
    [90m 28| [39m            email[33m:[39m [32m`test_versioning_[39m[36m${[39m[33mDate[39m[33m.[39m[34mnow[39m()[36m}[39m[32m@example.com`[39m[33m,[39m
    [90m 29| [39m            fullName[33m:[39m [32m"Versioning Tester"[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/workflow_versioning.test.ts:[2m27:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(597a033f-4092-4fc1-9287-28247c705ba6) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w45_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[27/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for integration tests,656c1af7-66df-48a9-9e94-c6897459a89a,5ec03881-fb6c-4551-b8bd-0870cc9cfdc2,656c1af7-66df-48a9-9e94-c6897459a89a,656c1af7-66df-48a9-9e94-c6897459a89a[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/ai/workflowEdit.test.ts:[2m123:23[22m[39m
    [90m121| [39m
    [90m122| [39m    [90m// Create test project[39m
    [90m123| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(projects)[33m.[39m[34mvalues[39m({
    [90m   | [39m                      [31m^[39m
    [90m124| [39m      title[33m:[39m [32m'Test Project'[39m[33m,[39m
    [90m125| [39m      name[33m:[39m [32m'Test Project'[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/ai/workflowEdit.test.ts:[2m123:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(656c1af7-66df-48a9-9e94-c6897459a89a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[28/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m > [22mAuth Middleware Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/auth/auth.middleware.integration.test.ts:[2m35:15[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[29/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m > [22mAuth Middleware Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/auth/auth.middleware.integration.test.ts:[2m45:19[22m[39m
    [90m 43| [39m
    [90m 44| [39m    [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 45| [39m        [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m 46| [39m    })[33m;[39m
    [90m 47| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[30/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/jwt.authentication.test.ts[2m > [22mJWT Authentication Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/auth/jwt.authentication.test.ts:[2m31:15[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[31/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/jwt.authentication.test.ts[2m > [22mJWT Authentication Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/auth/jwt.authentication.test.ts:[2m40:19[22m[39m
    [90m 38| [39m
    [90m 39| [39m    [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 40| [39m        [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m 41| [39m    })[33m;[39m
    [90m 42| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[32/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/protected.routes.test.ts[2m > [22mProtected Routes Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/auth/protected.routes.test.ts:[2m31:15[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[33/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/session.management.integration.test.ts[2m > [22mSession Management Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/auth/session.management.integration.test.ts:[2m31:15[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[34/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/session.management.integration.test.ts[2m > [22mSession Management Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/auth/session.management.integration.test.ts:[2m40:19[22m[39m
    [90m 38| [39m
    [90m 39| [39m    [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 40| [39m        [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m 41| [39m    })[33m;[39m
    [90m 42| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[35/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/workflows/runtime-pipelines.test.ts[2m > [22mRuntime Pipelines Integration Tests
[31m[1mError[22m: Failed query: insert into "datavault_columns" ("id", "table_id", "name", "slug", "type", "description", "width_px", "required", "is_primary_key", "is_unique", "order_index", "auto_number_start", "autonumber_prefix", "autonumber_padding", "autonumber_reset_policy", "reference_table_id", "reference_display_column_slug", "options", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, default, $6, default, $7, $8, default, default, default, default, $9, $10, $11, default, default) returning "id", "table_id", "name", "slug", "type", "description", "width_px", "required", "is_primary_key", "is_unique", "order_index", "auto_number_start", "autonumber_prefix", "autonumber_padding", "autonumber_reset_policy", "reference_table_id", "reference_display_column_slug", "options", "created_at", "updated_at"
params: dd348d5c-c253-4662-9173-a258c19a0c05,Phone,phone,text,,false,false,2,,,[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m DatavaultColumnsRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
    [90m 88| [39m    [35mconst[39m database [33m=[39m [35mthis[39m[33m.[39m[34mgetDb[39m(tx)[33m;[39m
    [90m 89| [39m
    [90m 90| [39m    [35mconst[39m [record] [33m=[39m [35mawait[39m database
    [90m   | [39m                     [31m^[39m
    [90m 91| [39m      [33m.[39m[34minsert[39m([35mthis[39m[33m.[39mtable [35mas[39m any)
    [90m 92| [39m      [33m.[39m[34mvalues[39m(data [35mas[39m any)
[90m [2mâ¯[22m tests/integration/workflows/runtime-pipelines.test.ts:[2m174:25[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "datavault_columns" violates foreign key constraint "datavault_columns_table_id_datavault_tables_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m DatavaultColumnsRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
[90m [2mâ¯[22m tests/integration/workflows/runtime-pipelines.test.ts:[2m174:25[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 387, severity: 'ERROR', code: '23503', detail: 'Key (table_id)=(dd348d5c-c253-4662-9173-a258c19a0c05) is not present in table "datavault_tables".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w37_v3', table: 'datavault_columns', dataType: undefined, constraint: 'datavault_columns_table_id_datavault_tables_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[36/322]âŽ¯[22m[39m


[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Failed Tests 286 [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m

[41m[1m FAIL [22m[49m tests/integration/analytics_service.test.ts[2m > [22mAnalytics Service Integration[2m > [22mshould generate events and metrics on run completion
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- true[39m
[31m+ false[39m

[36m [2mâ¯[22m tests/integration/analytics_service.test.ts:[2m92:66[22m[39m
    [90m 90| [39m        [90m// 4. Verify Events (workflow.complete)[39m
    [90m 91| [39m        const events = await db.select().from(workflowRunEvents).whereâ€¦
    [90m 92| [39m        expect(events.some(e => e.type === 'workflow.complete')).toBe(â€¦
    [90m   | [39m                                                                 [31m^[39m
    [90m 93| [39m
    [90m 94| [39m        [90m// 5. Verify Metrics Aggregation[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[37/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.snapshots.test.ts[2m > [22mStage 13: Workflow Snapshots & Versioning[2m > [22mshould maintain immutability of runs across versions
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, $3, $4, $5, default, default, default, $6, default, default, default, default, default, default, default, default, default, $7, $8, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: 7dec05d1-8495-430f-9256-7306e4142267,Versioning Test Workflow,Generated by graphFactory,test-user-id,test-user-id,f4227fb1-5e14-479b-9b8f-0f9a634ee572,2026-01-18T04:02:52.622Z,2026-01-18T04:02:52.622Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/api.snapshots.test.ts:[2m178:28[22m[39m
    [90m176| [39m        }[33m,[39m graphV1)[33m;[39m
    [90m177| [39m
    [90m178| [39m        const [workflow] = await db.insert(schema.workflows).values(wfâ€¦
    [90m   | [39m                           [31m^[39m
    [90m179| [39m        workflowId [33m=[39m workflow[33m.[39mid[33m;[39m
    [90m180| [39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/api.snapshots.test.ts:[2m178:28[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 304, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(test-user-id) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w23_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[38/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.workflows.test.ts[2m > [22mWorkflows API Integration Tests[2m > [22mPUT /api/workflows/:id/move[2m > [22mshould move workflow to a project
[31m[1mError[22m: expected 200 "OK", got 404 "Not Found"[39m
[36m [2mâ¯[22m tests/integration/api.workflows.test.ts:[2m272:10[22m[39m
    [90m270| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mctx[33m.[39mauthToken[36m}[39m[32m`[39m)
    [90m271| [39m        [33m.[39m[34msend[39m({ projectId[33m:[39m targetProjectId })
    [90m272| [39m        [33m.[39m[34mexpect[39m([34m200[39m)[33m;[39m
    [90m   | [39m         [31m^[39m
    [90m273| [39m
    [90m274| [39m      [34mexpect[39m(response[33m.[39mbody)[33m.[39m[34mtoHaveProperty[39m([32m"id"[39m[33m,[39m workflowId)[33m;[39m
[90m [2mâ¯[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2mâ¯[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2mâ¯[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2mâ¯[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m156:7[22m[39m
[90m [2mâ¯[22m Test.Request.callback node_modules/superagent/lib/node/index.js:[2m857:3[22m[39m
[90m [2mâ¯[22m node_modules/superagent/lib/node/index.js:[2m1102:18[22m[39m
[90m [2mâ¯[22m IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:[2m21:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.workflows.test.ts[2m > [22mWorkflows API Integration Tests[2m > [22mPUT /api/workflows/:id/move[2m > [22mshould move workflow to Main Folder (projectId = null)
[31m[1mError[22m: expected 200 "OK", got 404 "Not Found"[39m
[36m [2mâ¯[22m tests/integration/api.workflows.test.ts:[2m298:10[22m[39m
    [90m296| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mctx[33m.[39mauthToken[36m}[39m[32m`[39m)
    [90m297| [39m        [33m.[39m[34msend[39m({ projectId[33m:[39m [35mnull[39m })
    [90m298| [39m        [33m.[39m[34mexpect[39m([34m200[39m)[33m;[39m
    [90m   | [39m         [31m^[39m
    [90m299| [39m
    [90m300| [39m      [34mexpect[39m(response[33m.[39mbody)[33m.[39m[34mtoHaveProperty[39m([32m"id"[39m[33m,[39m workflowId)[33m;[39m
[90m [2mâ¯[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2mâ¯[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2mâ¯[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2mâ¯[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m156:7[22m[39m
[90m [2mâ¯[22m Test.Request.callback node_modules/superagent/lib/node/index.js:[2m857:3[22m[39m
[90m [2mâ¯[22m node_modules/superagent/lib/node/index.js:[2m1102:18[22m[39m
[90m [2mâ¯[22m IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:[2m21:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[40/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mComplete Registration â†’ Login Flow[2m > [22mshould complete registration, verify email, then login
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m73:39[22m[39m
    [90m 71| [39m        })[33m;[39m
    [90m 72| [39m
    [90m 73| [39m      [34mexpect[39m(registerResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                                      [31m^[39m
    [90m 74| [39m      [34mexpect[39m(registerResponse[33m.[39mbody[33m.[39muser[33m.[39memailVerified)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
    [90m 75| [39m      [34mtrackUser[39m(registerResponse[33m.[39mbody[33m.[39muser[33m.[39mid)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[41/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mAccount Lockout Flow[2m > [22mshould lock account after 5 failed attempts, then unlock after waiting
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: fe106530d13f5121607106a270b41303,$2b$12$mjIyucEiHSl6MBLol7hr/eMi7a3O3luhB5/ale6wjfyky7bsz1bKG,2026-01-18T04:02:29.747Z,2026-01-18T04:02:29.747Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m105:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m105:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(fe106530d13f5121607106a270b41303) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[42/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mAccount Lockout Flow[2m > [22mshould record all login attempts
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 182c47aaa49f4615a55aacf78bdffda4,$2b$12$Rx49Y58UXqYuATZIq03nNOT5yWm1EyelUD0djqecnPoBa8WbDZE9q,2026-01-18T04:02:30.454Z,2026-01-18T04:02:30.455Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m161:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m161:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(182c47aaa49f4615a55aacf78bdffda4) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[43/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mMFA Enrollment and Login Flow[2m > [22mshould complete MFA setup and login with TOTP
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 5b2a3bb859de96e1c6cbd6477dd585c6,$2b$12$9pryHuwfGY4RMiBYaSEVgeGC7YrTS50iO4bQmouQ5IVp22kJ/urh6,2026-01-18T04:02:31.194Z,2026-01-18T04:02:31.194Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m182:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m182:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(5b2a3bb859de96e1c6cbd6477dd585c6) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[44/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mMFA Enrollment and Login Flow[2m > [22mshould login with backup code when TOTP unavailable
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 53ad51c3b0059df16c2792b069590115,$2b$12$KqH6TPrMos/XqN5tf0f7eOhjStPOPQcMXY9W4Z0gaQCcB26ClgNGm,2026-01-18T04:02:31.916Z,2026-01-18T04:02:31.916Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m253:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m253:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(53ad51c3b0059df16c2792b069590115) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[45/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mPassword Reset Flow[2m > [22mshould complete full password reset flow
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 1b671332cb15c417d671ef8f46e561d7,$2b$12$RmBXuI4KWoBqFRCDoc.Ogu2I8yOwzq1w2I3rFl.ZkgCog3vSPD1RK,2026-01-18T04:02:32.855Z,2026-01-18T04:02:32.855Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m324:56[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m324:56[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(1b671332cb15c417d671ef8f46e561d7) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w2_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[46/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mPassword Reset Flow[2m > [22mshould invalidate all sessions after password reset
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: ef590f8ed9f99888cce3c6395f97f40f,$2b$12$IwnouV2iDcUz6tSCo.Fbm.zrCmxs3ZZhGCrmagvjlaRwv/ckZbbMi,2026-01-18T04:02:33.794Z,2026-01-18T04:02:33.794Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m383:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m383:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(ef590f8ed9f99888cce3c6395f97f40f) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[47/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mToken Refresh Flow[2m > [22mshould rotate refresh token on each use
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m439:40[22m[39m
    [90m437| [39m
    [90m438| [39m      const cookies = loginResponse.headers['set-cookie'] as unknown aâ€¦
    [90m439| [39m      let refreshTokenCookie = cookies.find(c => c.startsWith('refreshâ€¦
    [90m   | [39m                                       [31m^[39m
    [90m440| [39m
    [90m441| [39m      [34mexpect[39m(refreshTokenCookie)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[48/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mToken Refresh Flow[2m > [22mshould detect and prevent refresh token reuse (token theft)
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 9d916894126b4df5381ae56c214fffd0,$2b$12$lZ.jXwF00zYvJu6XxIUhROpjUF.zYzutIf0pRUklyCscOwtEMwIU2,2026-01-18T04:02:35.877Z,2026-01-18T04:02:35.878Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m464:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m464:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(9d916894126b4df5381ae56c214fffd0) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[49/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mSession Management Flow[2m > [22mshould list all active sessions
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: b65717f6bdf49d6ece35de2a1322bcac,$2b$12$3HT9Iank2lPHC573E6Yw6OesJqtKzThijYdcWWRtNGXyJ9E51p.sq,2026-01-18T04:02:36.570Z,2026-01-18T04:02:36.570Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m507:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m507:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(b65717f6bdf49d6ece35de2a1322bcac) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[50/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mSession Management Flow[2m > [22mshould revoke specific session
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 3b3c7e296197712cc67c36e94962203a,$2b$12$Z6ur.JIxLwox42RCOtNleOdDGNHfUo.7Kp./ipf1wGvtJ/xK03YFK,2026-01-18T04:02:37.262Z,2026-01-18T04:02:37.262Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m534:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m534:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(3b3c7e296197712cc67c36e94962203a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[51/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/register[2m > [22mshould register a new user successfully
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m78:31[22m[39m
    [90m 76| [39m        })[33m;[39m
    [90m 77| [39m
    [90m 78| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m 79| [39m      expect((response.body).message).toContain("Registration successfâ€¦
    [90m 80| [39m      [34mexpect[39m((response[33m.[39mbody)[33m.[39mtoken)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[52/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/register[2m > [22mshould return 409 for duplicate email
[31m[1mAssertionError[22m: expected 500 to be 409 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 409[39m
[31m+ 500[39m

[36m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m139:31[22m[39m
    [90m137| [39m        [33m.[39m[34msend[39m({ email[33m,[39m password[33m,[39m firstName[33m:[39m [32m"Second"[39m })[33m;[39m
    [90m138| [39m
    [90m139| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m409[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m140| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"already exists"[39m)[33m;[39m
    [90m141| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[53/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/register[2m > [22mshould set httpOnly refresh token cookie
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m151:31[22m[39m
    [90m149| [39m        [33m.[39m[34msend[39m({ email[33m,[39m password[33m,[39m firstName[33m:[39m [32m"Test"[39m })[33m;[39m
    [90m150| [39m
    [90m151| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m152| [39m      [34mexpect[39m(response[33m.[39mheaders[[32m'set-cookie'[39m])[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m153| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[54/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould login with valid credentials
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 8261ad2b57c51a3be68a543a61e1f497,$2b$12$daGDffpweIrh5FCzo0Y92OUBtG1i7FL/rfI6FaKADYmFbZmaztKbO,2026-01-18T04:02:32.232Z,2026-01-18T04:02:32.232Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m164:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m164:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(8261ad2b57c51a3be68a543a61e1f497) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[55/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould return 401 for invalid password
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: bf989d1fdfca5872da3fb734f7163d62,$2b$12$ezpHtAbK5w8811lO4JWVQuuUv4fGC96stVurB3x6R.KtxYxBJjmfO,2026-01-18T04:02:34.441Z,2026-01-18T04:02:34.441Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m185:33[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m185:33[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(bf989d1fdfca5872da3fb734f7163d62) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[56/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould return 403 for unverified email
[31m[1mAssertionError[22m: expected 401 to be 403 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 403[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m226:31[22m[39m
    [90m224| [39m        [33m.[39m[34msend[39m({ email[33m,[39m password })[33m;[39m
    [90m225| [39m
    [90m226| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m403[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m227| [39m      expect(response.body.message || response.body.error).toBeDefinedâ€¦
    [90m228| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[57/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould record failed login attempt
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 49258010d28a83d4bbebc1e51c566e58,$2b$12$Z2xjqABl/17mT3dzyjYGou943LI4VvJE0woFMfFFpDFxTT/iRIC1G,2026-01-18T04:02:36.744Z,2026-01-18T04:02:36.744Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m231:33[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m231:33[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(49258010d28a83d4bbebc1e51c566e58) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[58/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould return requiresMfa=true for MFA-enabled users
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: f6969cf34c9f54b9075a8c98a94422e3,$2b$12$DqUZG4VC7EUyaYzOm.W4p.QCCWB59m35BhJWAll.jOXbYcK731zqq,2026-01-18T04:02:37.938Z,2026-01-18T04:02:37.938Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m252:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m252:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(f6969cf34c9f54b9075a8c98a94422e3) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[59/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould lock account after 5 failed attempts
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: cf4baf6d0614b5944a58726d91d3c07a,$2b$12$bPn3hkFnVkwEGUvx2LuIUO8MdfWGqbWZGma4mB/bDftXskNCm9hU.,2026-01-18T04:02:38.642Z,2026-01-18T04:02:38.642Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m266:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m266:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(cf4baf6d0614b5944a58726d91d3c07a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[60/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/logout[2m > [22mshould logout and clear refresh token cookie
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 8dd0b4a7dfb490dce590fe78cadcf7e8,$2b$12$9ZyYa49iS1aRGs3bfwK0duJLnd5.Kjr60YDGKr8OASR1KUBi6veM2,2026-01-18T04:02:39.352Z,2026-01-18T04:02:39.352Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m295:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m295:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(8dd0b4a7dfb490dce590fe78cadcf7e8) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[61/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould refresh access token with valid refresh token
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 99b3e34cd974b81d510a13d94ea9e88a,$2b$12$5ONfyx4BH7bLQjQHUGiwJ.VMjAX.7GbdXGZsGBC4YBq5E7.2CCXPq,2026-01-18T04:02:40.063Z,2026-01-18T04:02:40.063Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m325:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m325:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(99b3e34cd974b81d510a13d94ea9e88a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[62/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould rotate refresh token after use
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 2ddceff4db0b51b4508adb1c6536f975,$2b$12$LD6lKJ7rOlYFCR8L7GvSIOAih0E2QYxecDRUDo/8HWXdD2x5vTQi2,2026-01-18T04:02:40.849Z,2026-01-18T04:02:40.849Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m364:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m364:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(2ddceff4db0b51b4508adb1c6536f975) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w15_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[63/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/forgot-password[2m > [22mshould send password reset email for existing user
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: bdd4332b2b39c8dcf870904a9e75c8fd,$2b$12$DcZnBPC8J3zGrvAKrIyJPejx6BY5qhPlBWilN2yQ22XGFefv7NA7m,2026-01-18T04:02:41.598Z,2026-01-18T04:02:41.598Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m399:33[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m399:33[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(bdd4332b2b39c8dcf870904a9e75c8fd) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[64/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/reset-password[2m > [22mshould reset password with valid token
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: e8426b558725eb04669481f5ad2de9e5,$2b$12$9Nj7AFoW01w8a0hZwFGjmuuJRJ8pE/wttz7JcoJ60zodNnVpgMAJa,2026-01-18T04:02:42.425Z,2026-01-18T04:02:42.425Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m423:56[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m423:56[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(e8426b558725eb04669481f5ad2de9e5) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[65/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/reset-password[2m > [22mshould return 400 for weak new password
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 3d0df1f8d7a229c34a108970bbd873fa,$2b$12$HMa10027XrsKuINMJwHdWezn47w50QVCFhWKMGm5NjwYE0fAPIEYe,2026-01-18T04:02:43.266Z,2026-01-18T04:02:43.266Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m469:33[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m469:33[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(3d0df1f8d7a229c34a108970bbd873fa) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w18_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[66/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mGET /api/auth/me[2m > [22mshould return current user for valid token
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m500:31[22m[39m
    [90m498| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m499| [39m
    [90m500| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m501| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39memail)[33m.[39m[34mtoBe[39m(email)[33m;[39m
    [90m502| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mid)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[67/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mMFA Routes[2m > [22mPOST /api/auth/mfa/verify-login[2m > [22mshould complete MFA login with valid TOTP code
[31m[1mError[22m: [TEST UTILS] MFA Secret verification failed for 99387e41d1fff3a2c7323ea40daeb08f[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m228:22[22m[39m
    [90m226| [39m    where[33m:[39m [34meq[39m(mfaSecrets[33m.[39muserId[33m,[39m userData[33m.[39muserId)
    [90m227| [39m  })[33m;[39m
    [90m228| [39m  if (!check) {throw new Error(`[TEST UTILS] MFA Secret verification fâ€¦
    [90m   | [39m                     [31m^[39m
    [90m229| [39m  if (!check.enabled) {throw new Error(`[TEST UTILS] MFA Secret enableâ€¦
    [90m230| [39m  console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}â€¦
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m523:57[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[68/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mMFA Routes[2m > [22mPOST /api/auth/mfa/verify-login[2m > [22mshould reject invalid MFA code
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: eac1c6fd9202c4e3caee97851f787c79,$2b$12$TXE0N630znq2JBl3RmYjI.L1dYarRQuUYeSu/ve./NN0EG.zZOyIS,2026-01-18T04:02:46.706Z,2026-01-18T04:02:46.706Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m549:28[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m549:28[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(eac1c6fd9202c4e3caee97851f787c79) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[69/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould complete full MFA setup flow
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: ce25c20bfca08f150af7058d484fa516,$2b$12$IKlZLQNmV1/BqofnnYoSwOOkWwdfTBZOIbMiE9F9l5msW93UAiOka,2026-01-18T04:02:29.030Z,2026-01-18T04:02:29.030Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m59:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m59:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(ce25c20bfca08f150af7058d484fa516) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[70/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould reject invalid TOTP code during setup
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 20c21c7cb3c410ab39a15d68827bf672,$2b$12$IiGtxbLj/hCX3rv9NdwcY.wh0y2hgJ8.k/z/kTyaiYMFR1NYXbUNe,2026-01-18T04:02:29.741Z,2026-01-18T04:02:29.741Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m125:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m125:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(20c21c7cb3c410ab39a15d68827bf672) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[71/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould not allow MFA setup if already enabled
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: afe5875d0a33a67efcf9a72b3294e969,$2b$12$18P2jPYXzGu9vtYVUVRhZuDf.xk9dW0nNVe6Qx0uGN7.kbgP47abi,2026-01-18T04:02:30.451Z,2026-01-18T04:02:30.451Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m157:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m157:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(afe5875d0a33a67efcf9a72b3294e969) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[72/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould generate unique backup codes
[31m[1mAssertionError[22m: expected +0 to be 10 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 10[39m
[31m+ 0[39m

[36m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m186:32[22m[39m
    [90m184| [39m      [90m// All codes should be unique[39m
    [90m185| [39m      [35mconst[39m uniqueCodes [33m=[39m [35mnew[39m [33mSet[39m(backupCodes)[33m;[39m
    [90m186| [39m      [34mexpect[39m(uniqueCodes[33m.[39msize)[33m.[39m[34mtoBe[39m([34m10[39m)[33m;[39m
    [90m   | [39m                               [31m^[39m
    [90m187| [39m    })[33m;[39m
    [90m188| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[73/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould store hashed backup codes
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: b3fa2ee14c4769c1bc80bf86eed3b68c,$2b$12$kKPClRYAdrkXpfBC1BjpsOhvd1bpr7vYRfsOd476PKVsjmzJv5txm,2026-01-18T04:02:32.365Z,2026-01-18T04:02:32.365Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m190:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m190:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(b3fa2ee14c4769c1bc80bf86eed3b68c) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w14_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[74/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Login Flow[2m > [22mshould require MFA for enabled users
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 045c48ce44e19a568b211bfab0147c68,$2b$12$OaPPkFUQy6yK7EaiEd/j9u53Ixd1BRrd.oPn6LDN4/gELp9iNj2Ya,2026-01-18T04:02:33.584Z,2026-01-18T04:02:33.584Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m220:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m220:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(045c48ce44e19a568b211bfab0147c68) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[75/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Login Flow[2m > [22mshould complete MFA login with valid TOTP
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: aa1a4fee0c1ea0c7c226861cf98da207,NE7TQPR7PU3TERBKOERW2IZVIZ4CI6DCINDG6JB2KFKWMOSVIQ2Q,true,2026-01-18T04:02:34.438Z,2026-01-18T04:02:34.438Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m234:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m234:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(aa1a4fee0c1ea0c7c226861cf98da207) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[76/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Login Flow[2m > [22mshould reject invalid TOTP during login
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: f5a6ba293db1708f6d230acff59aa3fc,H5NFI2KVIQ4W6LZ4PU4U24CJPVBHSUJ6GBOTS5JVI5OWW6BTJQZA,true,2026-01-18T04:02:35.282Z,2026-01-18T04:02:35.282Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m268:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m268:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 322, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(f5a6ba293db1708f6d230acff59aa3fc) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[77/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Login Flow[2m > [22mshould accept TOTP codes within 60-second window
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 7be4cdbb71d4ccd04fb872586d5f68b7,$2b$12$tW3Qgv0kj8Fj8XveLV8FYO2mTy0mwsIJG/tjiT9Wu2FCLcPyGRcH6,2026-01-18T04:02:36.038Z,2026-01-18T04:02:36.038Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m286:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m286:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(7be4cdbb71d4ccd04fb872586d5f68b7) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[78/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould login with valid backup code
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: f2da5c5e83ae7f56f03a3f9be8aee9cf,$2b$12$6Gk/0f4284QBsHs9bWZCVOzuRVQydgNhUX7k1uETVx4g/h9Sf8eWm,2026-01-18T04:02:36.730Z,2026-01-18T04:02:36.730Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m318:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m318:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(f2da5c5e83ae7f56f03a3f9be8aee9cf) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[79/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould mark backup code as used
[31m[1mError[22m: [TEST UTILS] MFA Secret verification failed for 142289fbb2623ade099ac85d9168b7fb[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m228:22[22m[39m
    [90m226| [39m    where[33m:[39m [34meq[39m(mfaSecrets[33m.[39muserId[33m,[39m userData[33m.[39muserId)
    [90m227| [39m  })[33m;[39m
    [90m228| [39m  if (!check) {throw new Error(`[TEST UTILS] MFA Secret verification fâ€¦
    [90m   | [39m                     [31m^[39m
    [90m229| [39m  if (!check.enabled) {throw new Error(`[TEST UTILS] MFA Secret enableâ€¦
    [90m230| [39m  console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}â€¦
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m370:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[80/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould prevent backup code reuse
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'id')[39m
[36m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m410:44[22m[39m
    [90m408| [39m
    [90m409| [39m      [35mconst[39m mfaSecret [33m=[39m [35mawait[39m db[33m.[39mquery[33m.[39mmfaSecrets[33m.[39m[34mfindFirst[39m({
    [90m410| [39m        where[33m:[39m [34meq[39m(mfaSecrets[33m.[39muserId[33m,[39m user[33m![39m[33m.[39mid)[33m,[39m
    [90m   | [39m                                           [31m^[39m
    [90m411| [39m      })[33m;[39m
    [90m412| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[81/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould try TOTP before backup code
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 09fb9182df478bce9db6d3dd9d1596e4,$2b$12$hx9roGbataROni8kSo3WLe3rNGfGB1udCgiAJFikSNHF88qkrZyl2,2026-01-18T04:02:39.156Z,2026-01-18T04:02:39.156Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m452:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m452:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(09fb9182df478bce9db6d3dd9d1596e4) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[82/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Status[2m > [22mshould return MFA status for user
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m486:37[22m[39m
    [90m484| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mloginResponse[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m485| [39m
    [90m486| [39m      [34mexpect[39m(statusResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m487| [39m      [34mexpect[39m(statusResponse[33m.[39mbody[33m.[39mmfaEnabled)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
    [90m488| [39m      [34mexpect[39m(statusResponse[33m.[39mbody[33m.[39mbackupCodesRemaining)[33m.[39m[34mtoBe[39m([34m0[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[83/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Status[2m > [22mshould return backup codes count for MFA users
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 163e8308ba794f429fbae9eca78b85ee,$2b$12$haFEUnQDOExoQMOInXf83ehJ5dpI6B3cEd774KA7XujQeZi1xyo4u,2026-01-18T04:02:41.033Z,2026-01-18T04:02:41.033Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m492:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m492:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(163e8308ba794f429fbae9eca78b85ee) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w2_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[84/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Disable Flow[2m > [22mshould disable MFA with password verification
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: ca48f5c89bb2965b393e6fd7501da3de,$2b$12$mYRl6LLTOH/vc7YiY62gyOKNM14o.UKiNmKvVy/dSueFDWZ1Rdxw2,2026-01-18T04:02:41.753Z,2026-01-18T04:02:41.753Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m529:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m529:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(ca48f5c89bb2965b393e6fd7501da3de) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[85/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Disable Flow[2m > [22mshould require correct password to disable MFA
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 545e8d4b5b5d90a7248d39252343c1e7,$2b$12$NpoiMWjWm6obVnxPNutmluqeJgpw9g0/UIVusLHDU5CwMHDEI33cu,2026-01-18T04:02:42.468Z,2026-01-18T04:02:42.468Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m579:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m579:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(545e8d4b5b5d90a7248d39252343c1e7) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[86/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Regeneration[2m > [22mshould regenerate backup codes
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 503e6e232e9b8273c05d5b90a10a6cd4,$2b$12$GQYvAYj0meoR0PA33kBuO..rOP/IAwbfH5YBneVAEQm8aWyXpmSPC,2026-01-18T04:02:43.251Z,2026-01-18T04:02:43.251Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m613:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m613:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(503e6e232e9b8273c05d5b90a10a6cd4) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[87/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Regeneration[2m > [22mshould return error if MFA not enabled
[31m[1mAssertionError[22m: expected 401 to be 400 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 400[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m657:31[22m[39m
    [90m655| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mloginResponse[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m656| [39m
    [90m657| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m400[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m658| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"not enabled"[39m)[33m;[39m
    [90m659| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[88/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mTenant-Level MFA Enforcement[2m > [22mshould enforce MFA for tenant users when required by tenant
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m684:36[22m[39m
    [90m682| [39m        [33m.[39m[34msend[39m({ email[33m,[39m password })[33m;[39m
    [90m683| [39m
    [90m684| [39m      [34mexpect[39m(loginResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                   [31m^[39m
    [90m685| [39m      [34mexpect[39m(loginResponse[33m.[39mbody[33m.[39mrequiresMfa)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m686| [39m      [34mexpect[39m(loginResponse[33m.[39mbody[33m.[39muserId)[33m.[39m[34mtoBe[39m(userId)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[89/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould create placeholder user for non-existent email
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould prevent inviting existing members
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould set expiry to 7 days from now
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould convert placeholder user to real user on accept
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould reject expired invite
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould reject invalid token
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mgetPendingInvitesForUser[2m > [22mshould not return accepted invites
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mrevokeInvite[2m > [22mshould prevent accepting revoked invite
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default)
params: 00000000-0000-0000-0000-000000000021,admin@test.com,Admin User,00000000-0000-0000-0000-000000000098,00000000-0000-0000-0000-000000000022,existing_1768708943603@test.com,Existing User,00000000-0000-0000-0000-000000000098[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m46:9[22m[39m
    [90m 44| [39m        await db.delete(users).where(inArray(users.id, [adminUserId, eâ€¦
    [90m 45| [39m
    [90m 46| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 47| [39m            { id: adminUserId, email: 'admin@test.com', fullName: 'Admâ€¦
    [90m 48| [39m            { id: existingUserId, email: existingUserEmail, fullName: â€¦

[31m[1mCaused by: error[22m: duplicate key value violates unique constraint "users_pkey"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m46:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 227, severity: 'ERROR', code: '23505', detail: 'Key (id)=(00000000-0000-0000-0000-000000000021) already exists.', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'users', dataType: undefined, constraint: 'users_pkey', file: 'nbtinsert.c', routine: '_bt_check_unique' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[90/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould create invite for existing user without creating placeholder
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m438:5[22m[39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m100:28[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[91/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould prevent duplicate pending invites
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould verify email matches invite
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mrevokeInvite[2m > [22mshould allow admin to revoke invite
[31m[1mError[22m: User must belong to a tenant to create organizations[39m
[36m [2mâ¯[22m OrganizationService.createOrganization server/services/OrganizationService.ts:[2m49:13[22m[39m
    [90m 47| [39m
    [90m 48| [39m    [35mif[39m ([33m![39muser[33m?.[39mtenantId) {
    [90m 49| [39m      throw new Error('User must belong to a tenant to create organizaâ€¦
    [90m   | [39m            [31m^[39m
    [90m 50| [39m    }
    [90m 51| [39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m53:21[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[92/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould accept invite and create membership
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m438:5[22m[39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m165:34[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[93/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould reject already accepted invite
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m438:5[22m[39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m241:34[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[94/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mgetPendingInvitesForUser[2m > [22mshould return pending invites for user email
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m438:5[22m[39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m278:34[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[95/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mgetPendingInvitesForUser[2m > [22mshould not return expired invites
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m438:5[22m[39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m294:34[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[96/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mcreateOrganization[2m > [22mshould create organization and auto-create admin membership
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,f0d854a7-c2e3-4317-b131-4029731c6662,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,f0d854a7-c2e3-4317-b131-4029731c6662,f0d854a7-c2e3-4317-b131-4029731c6662[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f0d854a7-c2e3-4317-b131-4029731c6662) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w14_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[97/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mgetUserOrganizations[2m > [22mshould return all organizations for user
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,32624688-20d2-4f42-97a5-5a60df0ac22a,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,32624688-20d2-4f42-97a5-5a60df0ac22a,32624688-20d2-4f42-97a5-5a60df0ac22a[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(32624688-20d2-4f42-97a5-5a60df0ac22a) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[98/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mgetUserOrganizations[2m > [22mshould return empty array for user with no memberships
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,f7ec710b-2690-4ed6-aa20-8a4844eb45db,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,f7ec710b-2690-4ed6-aa20-8a4844eb45db,f7ec710b-2690-4ed6-aa20-8a4844eb45db[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f7ec710b-2690-4ed6-aa20-8a4844eb45db) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w14_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[99/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mupdateOrganization[2m > [22mshould allow admin to update organization
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,e5a100dd-1cac-4ef0-8c6c-f3d1d70afd27,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,e5a100dd-1cac-4ef0-8c6c-f3d1d70afd27,e5a100dd-1cac-4ef0-8c6c-f3d1d70afd27[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(e5a100dd-1cac-4ef0-8c6c-f3d1d70afd27) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[100/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mupdateOrganization[2m > [22mshould deny non-admin from updating organization
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,4de1ff9f-e60c-4064-b2a1-37e5c71166c3,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,4de1ff9f-e60c-4064-b2a1-37e5c71166c3,4de1ff9f-e60c-4064-b2a1-37e5c71166c3[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(4de1ff9f-e60c-4064-b2a1-37e5c71166c3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[101/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mgetOrganizationMembers[2m > [22mshould return all members of organization
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,4465f46e-1dde-402f-bf66-350902877e22,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,4465f46e-1dde-402f-bf66-350902877e22,4465f46e-1dde-402f-bf66-350902877e22[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(4465f46e-1dde-402f-bf66-350902877e22) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[102/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mpromoteMember[2m > [22mshould allow admin to promote member
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,35dd0eb3-65a3-428d-a9fb-ff875f4bca6d,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,35dd0eb3-65a3-428d-a9fb-ff875f4bca6d,35dd0eb3-65a3-428d-a9fb-ff875f4bca6d[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(35dd0eb3-65a3-428d-a9fb-ff875f4bca6d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[103/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mdemoteMember[2m > [22mshould allow admin to demote other admin
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,75f6d6ec-769a-483f-adda-ffc53a7d76db,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,75f6d6ec-769a-483f-adda-ffc53a7d76db,75f6d6ec-769a-483f-adda-ffc53a7d76db[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(75f6d6ec-769a-483f-adda-ffc53a7d76db) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[104/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mdemoteMember[2m > [22mshould prevent self-demotion
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,b4764533-0c4f-4bb9-8bb5-83aa46962294,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,b4764533-0c4f-4bb9-8bb5-83aa46962294,b4764533-0c4f-4bb9-8bb5-83aa46962294[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b4764533-0c4f-4bb9-8bb5-83aa46962294) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[105/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mremoveMember[2m > [22mshould allow admin to remove member
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,bd113ba0-797f-4098-bf43-add88e5ef982,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,bd113ba0-797f-4098-bf43-add88e5ef982,bd113ba0-797f-4098-bf43-add88e5ef982[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(bd113ba0-797f-4098-bf43-add88e5ef982) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[106/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mremoveMember[2m > [22mshould prevent self-removal
[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mleaveOrganization[2m > [22mshould allow admin to leave organization
[31m[1mError[22m: Test setup failed: User 00000000-0000-0000-0000-000000000011 missing tenantId[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m54:19[22m[39m
    [90m 52| [39m        [35mif[39m ([33m![39muserCheck[33m?.[39mtenantId) {
    [90m 53| [39m            console.error('CRITICAL: User lookup failed validation in â€¦
    [90m 54| [39m            throw new Error(`Test setup failed: User ${testUserId1} miâ€¦
    [90m   | [39m                  [31m^[39m
    [90m 55| [39m        }
    [90m 56| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[107/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mleaveOrganization[2m > [22mshould allow member to leave organization
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,c2cc8acd-d109-4937-8dad-a0640f82204c,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,c2cc8acd-d109-4937-8dad-a0640f82204c,c2cc8acd-d109-4937-8dad-a0640f82204c[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(c2cc8acd-d109-4937-8dad-a0640f82204c) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[108/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mcanAccessAsset[2m > [22mshould allow access to org-owned asset by org member
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- true[39m
[31m+ false[39m

[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m87:25[22m[39m
    [90m 85| [39m
    [90m 86| [39m      [35mconst[39m hasAccess [33m=[39m [35mawait[39m [34mcanAccessAsset[39m(userId1[33m,[39m [32m'org'[39m[33m,[39m orgId1)[33m;[39m
    [90m 87| [39m      [34mexpect[39m(hasAccess)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m   | [39m                        [31m^[39m
    [90m 88| [39m    })[33m;[39m
    [90m 89| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[109/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22misOrgMember[2m > [22mshould return true for org member
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- true[39m
[31m+ false[39m

[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m110:24[22m[39m
    [90m108| [39m
    [90m109| [39m      [35mconst[39m isMember [33m=[39m [35mawait[39m [34misOrgMember[39m(userId1[33m,[39m orgId1)[33m;[39m
    [90m110| [39m      [34mexpect[39m(isMember)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m111| [39m    })[33m;[39m
    [90m112| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[110/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22misOrgMember[2m > [22mshould return true for org admin
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- true[39m
[31m+ false[39m

[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m126:24[22m[39m
    [90m124| [39m
    [90m125| [39m      [35mconst[39m isMember [33m=[39m [35mawait[39m [34misOrgMember[39m(userId1[33m,[39m orgId1)[33m;[39m
    [90m126| [39m      [34mexpect[39m(isMember)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m127| [39m    })[33m;[39m
    [90m128| [39m  })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[111/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mgetUserOrgIds[2m > [22mshould return all org IDs for a user
[31m[1mError[22m: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default), (default, $4, $5, $6, default)
params: 10000000-0000-0000-0000-000000000001,00000000-0000-0000-0000-000000000001,member,10000000-0000-0000-0000-000000000002,00000000-0000-0000-0000-000000000001,admin[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m161:7[22m[39m
    [90m159| [39m  [34mdescribe[39m([32m'getUserOrgIds'[39m[33m,[39m () [33m=>[39m {
    [90m160| [39m    [34mit[39m([32m'should return all org IDs for a user'[39m[33m,[39m [35masync[39m () [33m=>[39m {
    [90m161| [39m      [35mawait[39m db[33m.[39m[34minsert[39m(organizationMemberships)[33m.[39m[34mvalues[39m([
    [90m   | [39m      [31m^[39m
    [90m162| [39m        { orgId[33m:[39m orgId1[33m,[39m userId[33m:[39m userId1[33m,[39m role[33m:[39m [32m'member'[39m }[33m,[39m
    [90m163| [39m        { orgId[33m:[39m orgId2[33m,[39m userId[33m:[39m userId1[33m,[39m role[33m:[39m [32m'admin'[39m }[33m,[39m

[31m[1mCaused by: error[22m: duplicate key value violates unique constraint "org_membership_unique_idx"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m161:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 327, severity: 'ERROR', code: '23505', detail: 'Key (org_id, user_id)=(10000000-0000-0000-0000-000000000001, 00000000-0000-0000-0000-000000000001) already exists.', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w18_v3', table: 'organization_memberships', dataType: undefined, constraint: 'org_membership_unique_idx', file: 'nbtinsert.c', routine: '_bt_check_unique' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[112/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mCross-org Access Control[2m > [22mshould not allow member of org1 to access org2-owned assets
[31m[1mError[22m: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 10000000-0000-0000-0000-000000000001,00000000-0000-0000-0000-000000000001,member[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m208:7[22m[39m
    [90m206| [39m  [34mdescribe[39m([32m'Cross-org Access Control'[39m[33m,[39m () [33m=>[39m {
    [90m207| [39m    it('should not allow member of org1 to access org2-owned assets', â€¦
    [90m208| [39m      [35mawait[39m db[33m.[39m[34minsert[39m(organizationMemberships)[33m.[39m[34mvalues[39m({
    [90m   | [39m      [31m^[39m
    [90m209| [39m        orgId[33m:[39m orgId1[33m,[39m
    [90m210| [39m        userId[33m:[39m userId1[33m,[39m

[31m[1mCaused by: error[22m: duplicate key value violates unique constraint "org_membership_unique_idx"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m208:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 327, severity: 'ERROR', code: '23505', detail: 'Key (org_id, user_id)=(10000000-0000-0000-0000-000000000001, 00000000-0000-0000-0000-000000000001) already exists.', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w18_v3', table: 'organization_memberships', dataType: undefined, constraint: 'org_membership_unique_idx', file: 'nbtinsert.c', routine: '_bt_check_unique' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[113/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mCross-org Access Control[2m > [22mshould allow member of multiple orgs to access all their org assets
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- true[39m
[31m+ false[39m

[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m227:26[22m[39m
    [90m225| [39m      [35mconst[39m hasAccess2 [33m=[39m [35mawait[39m [34mcanAccessAsset[39m(userId1[33m,[39m [32m'org'[39m[33m,[39m orgId2)[33m;[39m
    [90m226| [39m
    [90m227| [39m      [34mexpect[39m(hasAccess1)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m228| [39m      [34mexpect[39m(hasAccess2)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m229| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[114/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould list all active sessions for current user
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 5099bd8ca173d56f792bcf883b9abcac,$2b$12$Y.S8pTzcPbhWEE1o91dTcuS23MjvJHPbXJjVoyt.fnS6RomPmwsKy,2026-01-18T04:02:28.974Z,2026-01-18T04:02:28.974Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m57:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m57:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(5099bd8ca173d56f792bcf883b9abcac) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[115/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould mark current session correctly
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 79937f01641178466411224092a924cf,$2b$12$DpZMYvOitrDy30iFo9oH5eElNJJ2GHv7eEcxGZFuBBgbS.1aMSoPK,2026-01-18T04:02:29.695Z,2026-01-18T04:02:29.695Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m105:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m105:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(79937f01641178466411224092a924cf) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[116/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould exclude revoked sessions
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'id')[39m
[36m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m155:50[22m[39m
    [90m153| [39m        [33m.[39m[34mupdate[39m(refreshTokens)
    [90m154| [39m        [33m.[39m[35mset[39m({ revoked[33m:[39m [35mtrue[39m })
    [90m155| [39m        [33m.[39m[34mwhere[39m([34meq[39m(refreshTokens[33m.[39mid[33m,[39m allTokens[[34m0[39m][33m.[39mid))[33m;[39m
    [90m   | [39m                                                 [31m^[39m
    [90m156| [39m
    [90m157| [39m      [90m// List sessions[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[117/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould order sessions by last used (most recent first)
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: a5b1489e6885df8e3cca82c46d4e6a3a,$2b$12$kuYoCaq1HQSMQHDcNMVyCe7V.ILH1PBoO4yo7J/jHVTCbq6dEl2QS,2026-01-18T04:02:31.905Z,2026-01-18T04:02:31.905Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m167:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m167:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(a5b1489e6885df8e3cca82c46d4e6a3a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[118/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould filter sessions by current user only
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 65c7e87a879b31eb328b79d410be4800,$2b$12$f9BrtjHWZyeZmznKYzYZWOKABpAHRREfan47PAsQhwCMwJL.IVo/.,2026-01-18T04:02:32.587Z,2026-01-18T04:02:32.587Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m198:21[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m198:21[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(65c7e87a879b31eb328b79d410be4800) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w2_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[119/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould revoke specific session
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 0cab5fec3a4f33903f99c51b00f9061f,$2b$12$8cjCbYUjSXbTlQ2jLZdTKe3u/Flf5sMAoImMCWJdqGNv.Z4qusK12,2026-01-18T04:02:33.348Z,2026-01-18T04:02:33.348Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m234:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m234:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(0cab5fec3a4f33903f99c51b00f9061f) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[120/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould prevent revoking current session
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: b3a30a0e3455e6d67d04586092521588,$2b$12$fkGT0uBkt36saSYj2x5YEez3LhbX3lyOa3FBcPOpgeXAvzCLxP91W,2026-01-18T04:02:35.544Z,2026-01-18T04:02:35.544Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m280:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m280:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(b3a30a0e3455e6d67d04586092521588) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[121/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould return 404 for non-existent session
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: c9d158bd51b95466b65396f9e69cfc34,$2b$12$cJIGjGbXhcUIqj1aMrydUORle74kWq7J.ItLk7Yrw/Lgxtk5t9A1S,2026-01-18T04:02:36.238Z,2026-01-18T04:02:36.238Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m312:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m312:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(c9d158bd51b95466b65396f9e69cfc34) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[122/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould prevent revoking other user's session
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 522c935316620ed85224491525e74c5d,$2b$12$rgYAlSYe7zqR16qdmQ/tgeDmRh.1xGVVkKoIy3ssnFGqqd4arOwLy,2026-01-18T04:02:36.933Z,2026-01-18T04:02:36.933Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m327:21[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m327:21[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(522c935316620ed85224491525e74c5d) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[123/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould revoke all other sessions
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m374:30[22m[39m
    [90m372| [39m      [35mconst[39m token [33m=[39m currentLogin[33m.[39mbody[33m.[39mtoken[33m;[39m
    [90m373| [39m      const cookies = (currentLogin.headers as any)["set-cookie"] as sâ€¦
    [90m374| [39m      const cookie = cookies.find((c) => c.startsWith("refresh_token="â€¦
    [90m   | [39m                             [31m^[39m
    [90m375| [39m
    [90m376| [39m      [90m// Revoke all except current[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[124/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould keep current session active
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m406:30[22m[39m
    [90m404| [39m      [35mconst[39m token [33m=[39m currentLogin[33m.[39mbody[33m.[39mtoken[33m;[39m
    [90m405| [39m      const cookies = (currentLogin.headers as any)["set-cookie"] as sâ€¦
    [90m406| [39m      const cookie = cookies.find((c) => c.startsWith("refresh_token="â€¦
    [90m   | [39m                             [31m^[39m
    [90m407| [39m
    [90m408| [39m      [90m// Revoke all others[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[125/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould return 400 if no active session found
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: fe9fb475bac69024aa949f194ab1d586,$2b$12$rLUVcomiUPJk68iCgqkW3eBt9jJ0lJ84HBXMSRBBVNAXCfgxPBHea,2026-01-18T04:02:40.908Z,2026-01-18T04:02:40.908Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m430:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m430:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(fe9fb475bac69024aa949f194ab1d586) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[126/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould revoke all trusted devices
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m458:30[22m[39m
    [90m456| [39m      [35mconst[39m token [33m=[39m login[33m.[39mbody[33m.[39mtoken[33m;[39m
    [90m457| [39m      [35mconst[39m cookies [33m=[39m (login[33m.[39mheaders [35mas[39m any)[[32m"set-cookie"[39m] [35mas[39m string[][33m;[39m
    [90m458| [39m      const cookie = cookies.find((c) => c.startsWith("refresh_token="â€¦
    [90m   | [39m                             [31m^[39m
    [90m459| [39m
    [90m460| [39m      [90m// Trust a device[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[127/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould handle user with single session gracefully
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 482542255dbc350e3a8480258b1da6ce,$2b$12$poU1Ae2WVz5i3G2tZv6NJuv7B.1PAFOR7UfZMPv/XrChfN1QAm3nW,2026-01-18T04:02:42.766Z,2026-01-18T04:02:42.766Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m481:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m481:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(482542255dbc350e3a8480258b1da6ce) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w21_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[128/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mSession Security[2m > [22mshould include device metadata in sessions
[31m[1mTypeError[22m: Cannot read properties of undefined (reading '0')[39m
[36m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m526:37[22m[39m
    [90m524| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m525| [39m
    [90m526| [39m      [35mconst[39m session [33m=[39m response[33m.[39mbody[33m.[39msessions[[34m0[39m][33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m527| [39m
    [90m528| [39m      [34mexpect[39m(session[33m.[39mdeviceName)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[129/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mSession Security[2m > [22mshould not expose sensitive token data
[31m[1mTypeError[22m: Cannot read properties of undefined (reading '0')[39m
[36m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m544:37[22m[39m
    [90m542| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mlogin[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m543| [39m
    [90m544| [39m      [35mconst[39m session [33m=[39m response[33m.[39mbody[33m.[39msessions[[34m0[39m][33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m545| [39m
    [90m546| [39m      [90m// Should NOT include token hash or metadata[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[130/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mSession Security[2m > [22mshould track session activity timestamps
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 6974b0212e3054f1c4d6cdc365247fab,$2b$12$ubhCLXyJj0uBlJyltFJx/ex3XaOSktFTYMKbMsEnJWML22Vjc4qcG,2026-01-18T04:02:45.938Z,2026-01-18T04:02:45.938Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m552:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m552:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(6974b0212e3054f1c4d6cdc365247fab) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w18_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[131/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mProject Transfer[2m > [22mshould transfer user-owned project to org
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mProject Transfer[2m > [22mshould prevent transfer to org if user is not a member
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mProject Transfer[2m > [22mshould allow org member to transfer org-owned project to another org they belong to
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mWorkflow Transfer[2m > [22mshould detach workflow from project when transferring to different owner
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mWorkflow Transfer[2m > [22mshould keep workflow in project when transferring to same owner
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mWorkflow Transfer[2m > [22mshould prevent non-member from transferring org workflow
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mDatabase Transfer[2m > [22mshould transfer database ownership
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mDatabase Transfer[2m > [22mshould allow org member to transfer org database
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mDatabase Transfer[2m > [22mshould prevent transfer to org if user is not a member
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mTransfer Validation[2m > [22mshould only allow transfer to self when targetOwnerType is user
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mTransfer Validation[2m > [22mshould allow transfer from user to self (org member transferring org asset to themselves)
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.addMember server/services/OrganizationService.ts:[2m410:5[22m[39m
[90m [2mâ¯[22m tests/integration/transferOwnership.test.ts:[2m64:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[132/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mPOST /api/auth/trust-device[2m > [22mshould trust current device
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 2998f9c92838d602b3922ad41fd21ac8,KFBCQNJEKYWHMVDRNMYT6MB4EN5GMYLWKZ6WYWT2JRUFEMD3LN4Q,true,2026-01-18T04:02:29.096Z,2026-01-18T04:02:29.096Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m58:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m58:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(2998f9c92838d602b3922ad41fd21ac8) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w14_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[133/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mPOST /api/auth/trust-device[2m > [22mshould set trust expiry to 30 days
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: c10f50e9988ae44721f268fe506eb4b0,$2b$12$xCwIZ7sNpf3DmosYu4IryeNxgEMSK8tzp9yjnIIii8ch2fv0OmYOi,2026-01-18T04:02:29.935Z,2026-01-18T04:02:29.935Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m97:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m97:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(c10f50e9988ae44721f268fe506eb4b0) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[134/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mPOST /api/auth/trust-device[2m > [22mshould update expiry if device already trusted
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 66f096f3239a85df9340b266e1b52f6a,$2b$12$SZKL00WD6Egyy3/woDwPG.oQbZrk5UoteK9e/fzl4lV7FGqub52Hy,2026-01-18T04:02:30.687Z,2026-01-18T04:02:30.687Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m124:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m124:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(66f096f3239a85df9340b266e1b52f6a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[135/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould list all trusted devices
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 193ab8ae2e371a6f3fdc6a9c777f224e,HZHDMPRQHZPD6SKHGVEUAZJ4M55EERRPGV6UU6ZVNBBWWMK6HZ5Q,true,2026-01-18T04:02:31.640Z,2026-01-18T04:02:31.640Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m183:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m183:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(193ab8ae2e371a6f3fdc6a9c777f224e) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[136/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould mark current device
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: c8ee1c28740d9479207e0e806099f69b,$2b$12$./3205O1DqzUzhjaMemlmeufCDwozGP/b48ZRdHQ5TdPbS5QrzYPi,2026-01-18T04:02:32.381Z,2026-01-18T04:02:32.381Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m240:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m240:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(c8ee1c28740d9479207e0e806099f69b) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[137/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould exclude revoked devices
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 3b42ce86a030f2285ce753458fc87002,PFVU23TXNEZU4QKXHFCVKVTXOQZG42JOIFBFCSJBJB5UW3ZDNQRQ,true,2026-01-18T04:02:33.198Z,2026-01-18T04:02:33.198Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m272:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m272:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(3b42ce86a030f2285ce753458fc87002) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[138/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould exclude expired devices
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 19063b5645782f10b104ed1ed983c7c6,EFITIVZROJCF24R4KRHESMJUNRIEIVJYI5SDAURMIRKD4VCSMZWA,true,2026-01-18T04:02:34.268Z,2026-01-18T04:02:34.268Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m305:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m305:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 322, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(19063b5645782f10b104ed1ed983c7c6) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[139/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould revoke specific device
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: e8d571252b2d29d567bd31e8e5f65461,$2b$12$6CiM1M0i/VC/hKlrsEHklOBfK5UbunJ2KcPaDgJcVUdWYVieGX7rG,2026-01-18T04:02:35.012Z,2026-01-18T04:02:35.012Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m341:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m341:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(e8d571252b2d29d567bd31e8e5f65461) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[140/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould return 404 for non-existent device
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 6d7e7af91949efec3745ff2532945308,$2b$12$8NmuNYVDctbu3M/EwSMTr.b7pekOzBxWSFA9vOWh/GGbNuKWJVEwa,2026-01-18T04:02:35.720Z,2026-01-18T04:02:35.720Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m391:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m391:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(6d7e7af91949efec3745ff2532945308) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[141/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould prevent revoking other user's device
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 42046a4806f1dfddc44901331b487ac3,$2b$12$PEfR7QdiJeabD5vDDmWaquCOWVv4HlwEwpyDC015M2XPX7EYodflq,2026-01-18T04:02:36.410Z,2026-01-18T04:02:36.410Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m410:21[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m410:21[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(42046a4806f1dfddc44901331b487ac3) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w2_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[142/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDevice Trust with MFA Login[2m > [22mshould skip MFA for trusted device
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 49ec308b52b07fe2a7f2d4cb343f85f6,$2b$12$uWTZLR9fLfbH/XwoUdvQgexttO2lVbgNTN0nQ/3qUaZcSxtf8ZbyK,2026-01-18T04:02:37.114Z,2026-01-18T04:02:37.114Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m459:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m459:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(49ec308b52b07fe2a7f2d4cb343f85f6) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[143/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDevice Trust with MFA Login[2m > [22mshould require MFA for untrusted device
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 3b11a4184cf92408f92f4ed4dd1cb27b,$2b$12$oX1RlaPl.I/HLN9oTvu0xeBN.gNazOuHZrOTYhMZTvCsDtTrbVqfa,2026-01-18T04:02:37.870Z,2026-01-18T04:02:37.870Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m497:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m497:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(3b11a4184cf92408f92f4ed4dd1cb27b) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[144/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDevice Trust with MFA Login[2m > [22mshould update lastUsedAt on trusted device login
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 082e76de997475d700a844a431395bc5,$2b$12$YGprNTdcjqGvTBITAcjlqOgwAVutffpeuIEL6K1Y8MdekPNFtGgPG,2026-01-18T04:02:38.575Z,2026-01-18T04:02:38.575Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m528:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m528:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(082e76de997475d700a844a431395bc5) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[145/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mREPRO: ScriptEngine fails to resolve alias 'input_variable' when aliasMap is NOT provided
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 3aa4e109-52bc-4f10-ba38-d8005ac13e90,Safety Workflow,ce5be8bf-7948-43a4-af58-a57c720c0c3c,ce5be8bf-7948-43a4-af58-a57c720c0c3c,c36b3e02-e866-4d44-92c1-f272d35ba86c,ee15b81b-a5fa-4530-9551-51a842ae29e3[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m
    [90m 73| [39m        workflowId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 74| [39m        versionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 75| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(workflowsSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 76| [39m            id[33m:[39m workflowId[33m,[39m
    [90m 77| [39m            projectId[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(ce5be8bf-7948-43a4-af58-a57c720c0c3c) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w15_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[146/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mScriptEngine resolves alias 'input_variable' when aliasMap is provided
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, $6, default, default, default, default, default, default, default, default)
params: 5218f419-c317-4c51-9e32-725394c73938,safety - 10bbe84d-0374-4fdd-9c47-5aa62c528694 @example.com,114695da-449b-4b74-905a-ebdab5854ac6,admin,owner,local[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m51:9[22m[39m
    [90m 49| [39m
    [90m 50| [39m        userId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 51| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(usersSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 52| [39m            id[33m:[39m userId[33m,[39m
    [90m 53| [39m            email[33m:[39m [32m`safety - [39m[36m${[39m[34muuidv4[39m()[36m}[39m[32m @example.com`[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m51:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(114695da-449b-4b74-905a-ebdab5854ac6) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[147/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mREPRO: BlockRunner fails to resolve alias in CreateRecordConfig
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, $6, default, default, default, default, default, default, default, default)
params: ecc8aebb-4d55-4c86-85b1-9d0b369fc2fb,safety - 7f0f531e-af28-4280-be23-e44395c36d5d @example.com,24bb7993-73b7-4df9-b83a-d77aac92fc5c,admin,owner,local[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m51:9[22m[39m
    [90m 49| [39m
    [90m 50| [39m        userId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 51| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(usersSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 52| [39m            id[33m:[39m userId[33m,[39m
    [90m 53| [39m            email[33m:[39m [32m`safety - [39m[36m${[39m[34muuidv4[39m()[36m}[39m[32m @example.com`[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m51:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(24bb7993-73b7-4df9-b83a-d77aac92fc5c) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w15_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[148/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mBlockRunner logic resolves alias with aliasMap
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, $6, default, default, default, default, default, default, default, default)
params: 9d05476b-6574-41c9-82f5-8047a0b29b1a,safety - 96ac1a91-e106-4f7f-ad61-10f10c06221a @example.com,5fc6a175-2858-45b2-ab59-6b76e7a08470,admin,owner,local[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m51:9[22m[39m
    [90m 49| [39m
    [90m 50| [39m        userId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 51| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(usersSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 52| [39m            id[33m:[39m userId[33m,[39m
    [90m 53| [39m            email[33m:[39m [32m`safety - [39m[36m${[39m[34muuidv4[39m()[36m}[39m[32m @example.com`[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m51:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5fc6a175-2858-45b2-ab59-6b76e7a08470) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w18_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[149/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Authorization Flow Initiation[2m > [22mshould initiate OAuth2 3-legged flow and generate authorization URL
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2mâ¯[22m tests/integration/auth/oauth2.callback.test.ts:[2m125:37[22m[39m
    [90m123| [39m        })[33m;[39m
    [90m124| [39m
    [90m125| [39m      [34mexpect[39m(createResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m126| [39m      testConnectionId [33m=[39m createResponse[33m.[39mbody[33m.[39mid[33m;[39m
    [90m127| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[150/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Connection Status[2m > [22mshould track OAuth2 connection status
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2mâ¯[22m tests/integration/auth/oauth2.callback.test.ts:[2m309:37[22m[39m
    [90m307| [39m        })[33m;[39m
    [90m308| [39m
    [90m309| [39m      [34mexpect[39m(createResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m310| [39m      [35mconst[39m connectionId [33m=[39m createResponse[33m.[39mbody[33m.[39mid[33m;[39m
    [90m311| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[151/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould successfully authenticate with valid Google ID token
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth/oauth2.google.test.ts:[2m91:31[22m[39m
    [90m 89| [39m
    [90m 90| [39m      [90m// Verify response[39m
    [90m 91| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m 92| [39m      [34mexpect[39m(response[33m.[39mbody)[33m.[39m[34mtoMatchObject[39m({
    [90m 93| [39m        message[33m:[39m [32m'Authentication successful'[39m[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[152/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould update existing user on subsequent logins
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default)
params: google-user-existing,existing@example.com,Old Name,Old,Name,b1b79390-76d2-4d60-8cc2-97b8209a55b6,creator,viewer,google,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.google.test.ts:[2m218:7[22m[39m
    [90m216| [39m
    [90m217| [39m      [90m// Create existing user[39m
    [90m218| [39m      [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m      [31m^[39m
    [90m219| [39m        id[33m:[39m userId[33m,[39m
    [90m220| [39m        email[33m:[39m [32m'existing@example.com'[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.google.test.ts:[2m218:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b1b79390-76d2-4d60-8cc2-97b8209a55b6) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w15_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[153/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould create refresh token record in database
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth/oauth2.google.test.ts:[2m297:31[22m[39m
    [90m295| [39m        })[33m;[39m
    [90m296| [39m
    [90m297| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m298| [39m
    [90m299| [39m      [90m// Verify refresh token exists in database[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[154/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould support both "token" and "idToken" fields
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth/oauth2.google.test.ts:[2m332:31[22m[39m
    [90m330| [39m        })[33m;[39m
    [90m331| [39m
    [90m332| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m333| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoBe[39m([32m'Authentication successful'[39m)[33m;[39m
    [90m334| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[155/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould handle missing profile information gracefully
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth/oauth2.google.test.ts:[2m395:31[22m[39m
    [90m393| [39m        })[33m;[39m
    [90m394| [39m
    [90m395| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m396| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39muser)[33m.[39m[34mtoMatchObject[39m({
    [90m397| [39m        email[33m:[39m [32m'minimal@example.com'[39m[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[156/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould list all active sessions for current user
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 8oPlpZLVDNQ76ubNOO1kM,session-test-G7EVlJmDF66mXgDlOpvDY@example.com,Session Test,Session,Test,5ea72ac0-c4e5-480f-ac40-fbaf6c608f00,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5ea72ac0-c4e5-480f-ac40-fbaf6c608f00) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[157/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould mark current session as current
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: fgNjIljNUcZL5qEPKkXpO,session-test-QaoUsR6uLCEF36Sfztk7G@example.com,Session Test,Session,Test,5ea72ac0-c4e5-480f-ac40-fbaf6c608f00,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5ea72ac0-c4e5-480f-ac40-fbaf6c608f00) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w14_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[158/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould return empty array when user has no active sessions
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, default, default) returning "id", "user_id", "password_hash", "created_at", "updated_at"
params: mRW3u5GTV6d0k6U3EeoDf,$2b$12$ogk7kUa44yRX7Wp8VHlhYOE6pkbp3JfCIKpzYII9IfbtXXFxaN0vq[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:[2m42:29[22m[39m
    [90m 40| [39m
    [90m 41| [39m    [35mtry[39m {
    [90m 42| [39m      [35mconst[39m [credentials] [33m=[39m [35mawait[39m database
    [90m   | [39m                            [31m^[39m
    [90m 43| [39m        [33m.[39m[34minsert[39m(userCredentials)
    [90m 44| [39m        [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m70:5[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:[2m42:29[22m[39m
[90m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m70:5[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 332, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(mRW3u5GTV6d0k6U3EeoDf) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[159/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould not include expired sessions
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: PUR0_-aJoDm8a7ByF0E_U,session-test-rFoJDXOFJpcliSWO2MTon@example.com,Session Test,Session,Test,5ea72ac0-c4e5-480f-ac40-fbaf6c608f00,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5ea72ac0-c4e5-480f-ac40-fbaf6c608f00) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[160/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould not include revoked sessions
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 2Ni1orqqCZQvUijgg_yj5,session-test-I4dAuLTigcmNvYFp5NvaM@example.com,Session Test,Session,Test,5ea72ac0-c4e5-480f-ac40-fbaf6c608f00,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5ea72ac0-c4e5-480f-ac40-fbaf6c608f00) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[161/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould parse device name from user agent
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: DtNPAs3LLhNS2Xil5sUMr,session-test-_GszdIA--SDkkZ6j7lqF3@example.com,Session Test,Session,Test,5ea72ac0-c4e5-480f-ac40-fbaf6c608f00,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5ea72ac0-c4e5-480f-ac40-fbaf6c608f00) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[162/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould return 401 for unauthenticated request
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: khohyYJor8by0Yvyda5cB,session-test-Ca4dg27rhgRysrN8zYAnA@example.com,Session Test,Session,Test,5ea72ac0-c4e5-480f-ac40-fbaf6c608f00,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5ea72ac0-c4e5-480f-ac40-fbaf6c608f00) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[163/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould revoke a specific session
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: VgqJuyw1TPmvnCjeXx-Mm,session-test-YjkgEbqSSRIwOCoWHSFpg@example.com,Session Test,Session,Test,5ea72ac0-c4e5-480f-ac40-fbaf6c608f00,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5ea72ac0-c4e5-480f-ac40-fbaf6c608f00) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w14_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[164/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould return 404 for non-existent session
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: pyL2EKAIVnsQhMvuNd_CH,session-test-EfROOPHs0HfOhrLbW2F3G@example.com,Session Test,Session,Test,5ea72ac0-c4e5-480f-ac40-fbaf6c608f00,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5ea72ac0-c4e5-480f-ac40-fbaf6c608f00) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[165/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould prevent revoking current session
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: sWgQ8yVjbf2-tsB1iuzhy,session-test-MH1oDyOtxqwD_BxGH566a@example.com,Session Test,Session,Test,5ea72ac0-c4e5-480f-ac40-fbaf6c608f00,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5ea72ac0-c4e5-480f-ac40-fbaf6c608f00) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[166/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould prevent revoking another user's session
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: wlJb_4CrYHek2caABuCLQ,session-test-vjZbjFs07HS6PRJWPY_ae@example.com,Session Test,Session,Test,5ea72ac0-c4e5-480f-ac40-fbaf6c608f00,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5ea72ac0-c4e5-480f-ac40-fbaf6c608f00) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[167/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould return 401 for unauthenticated request
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: SJrljOBWvyyMwVuLvNMTn,session-test-3_8gwGHWRN1g-uvI2HPZ5@example.com,Session Test,Session,Test,5ea72ac0-c4e5-480f-ac40-fbaf6c608f00,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5ea72ac0-c4e5-480f-ac40-fbaf6c608f00) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[168/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould revoke all sessions except current
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, default, default) returning "id", "user_id", "password_hash", "created_at", "updated_at"
params: k4Bz5SAPR0OY2cNsMeQO_,$2b$12$p3PNctsq9ObN9Sd6apRNZOcqbqLGOv4mrZ6z43HjOfTkkqt0fgNmK[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:[2m42:29[22m[39m
    [90m 40| [39m
    [90m 41| [39m    [35mtry[39m {
    [90m 42| [39m      [35mconst[39m [credentials] [33m=[39m [35mawait[39m database
    [90m   | [39m                            [31m^[39m
    [90m 43| [39m        [33m.[39m[34minsert[39m(userCredentials)
    [90m 44| [39m        [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m70:5[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:[2m42:29[22m[39m
[90m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m70:5[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 331, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(k4Bz5SAPR0OY2cNsMeQO_) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[169/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould revoke all trusted devices
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: QLZO6OHyYnqcfIA0QLRFW,session-test-_pXffmWUIwqpl2c6slhGf@example.com,Session Test,Session,Test,5ea72ac0-c4e5-480f-ac40-fbaf6c608f00,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5ea72ac0-c4e5-480f-ac40-fbaf6c608f00) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[170/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould return 400 when no active session found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: fY8sRqGD8tOoaAJUqQz-R,session-test-bscUOVDg6rDFQ-eQFmUn-@example.com,Session Test,Session,Test,5ea72ac0-c4e5-480f-ac40-fbaf6c608f00,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5ea72ac0-c4e5-480f-ac40-fbaf6c608f00) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[171/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould return 401 for unauthenticated request
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: UtMML6PYLk9Sim54A0nNj,session-test-4Vi7-4bvha-9KXJnBpZo9@example.com,Session Test,Session,Test,5ea72ac0-c4e5-480f-ac40-fbaf6c608f00,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5ea72ac0-c4e5-480f-ac40-fbaf6c608f00) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w15_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[172/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mPOST /api/auth/trust-device[2m > [22mshould mark current device as trusted
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: qAoWIzjaQ33PfAx_jtQPu,session-test-4jeJxJ5CxVrj9n5ZsmVNX@example.com,Session Test,Session,Test,5ea72ac0-c4e5-480f-ac40-fbaf6c608f00,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5ea72ac0-c4e5-480f-ac40-fbaf6c608f00) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[173/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mPOST /api/auth/trust-device[2m > [22mshould update existing trusted device expiry
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: lJBxIVfw6UMpUA-niltui,session-test-uw9U3xkX_AXvEHo6f1Z1t@example.com,Session Test,Session,Test,5ea72ac0-c4e5-480f-ac40-fbaf6c608f00,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5ea72ac0-c4e5-480f-ac40-fbaf6c608f00) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[174/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould list all trusted devices
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: sQpKBi4vG1BNnsDkBT-U4,session-test-67ofAtErkEneW4feeJLRa@example.com,Session Test,Session,Test,5ea72ac0-c4e5-480f-ac40-fbaf6c608f00,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5ea72ac0-c4e5-480f-ac40-fbaf6c608f00) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[175/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould not include revoked devices
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 8aIr-RIIRvlDRyNl2MPK0,session-test-y3idgFmMoJysqaQIpQ6AQ@example.com,Session Test,Session,Test,5ea72ac0-c4e5-480f-ac40-fbaf6c608f00,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5ea72ac0-c4e5-480f-ac40-fbaf6c608f00) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[176/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould revoke a trusted device
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: T_GI4KNF2J0iot5ZZVlto,session-test-GC9g2YONd23rmldDb8O2A@example.com,Session Test,Session,Test,5ea72ac0-c4e5-480f-ac40-fbaf6c608f00,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5ea72ac0-c4e5-480f-ac40-fbaf6c608f00) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[177/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould return 404 for non-existent device
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 1CtDbSLT8DfdBHwAFXMgY,session-test-hNHY_zF-v4EW5_f_r2Rti@example.com,Session Test,Session,Test,5ea72ac0-c4e5-480f-ac40-fbaf6c608f00,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5ea72ac0-c4e5-480f-ac40-fbaf6c608f00) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[178/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mSession Metadata Tracking[2m > [22mshould track IP address for sessions
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: Fn8sUgcI_JdnH5aaA0eLx,session-test-IxWcS5ramHrNJgkjxdoZv@example.com,Session Test,Session,Test,5ea72ac0-c4e5-480f-ac40-fbaf6c608f00,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5ea72ac0-c4e5-480f-ac40-fbaf6c608f00) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[179/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mSession Metadata Tracking[2m > [22mshould track user agent for sessions
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: I79BXeSaZo7Oe2FpjL1Db,session-test-ur17OIaPytYCvWa1YrVNw@example.com,Session Test,Session,Test,5ea72ac0-c4e5-480f-ac40-fbaf6c608f00,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5ea72ac0-c4e5-480f-ac40-fbaf6c608f00) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[180/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mSession Metadata Tracking[2m > [22mshould update lastUsedAt on token refresh
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: myP7-Qo40HAk2MG3dIefx,session-test-L8ILbVp9Vs2OiiKgoZXjX@example.com,Session Test,Session,Test,5ea72ac0-c4e5-480f-ac40-fbaf6c608f00,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5ea72ac0-c4e5-480f-ac40-fbaf6c608f00) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w18_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[181/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould refresh access token with valid refresh token
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: h556dmfkSR-RTuZlW3k_d,refresh-test-hQHXDG_i5PAPeB4wrJDv2@example.com,Refresh Test,Refresh,Test,da167fcc-ab97-44be-bcd1-563c07ba9de3,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(da167fcc-ab97-44be-bcd1-563c07ba9de3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[182/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould rotate refresh token after use
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, default, default) returning "id", "user_id", "password_hash", "created_at", "updated_at"
params: TZslFbBjlxWCLhS0k0ALq,$2b$12$5YtylsvBlR4saU//w1rew.kk8YFP4/0jILPTGBZpu1DjFEL3jzLMC[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:[2m42:29[22m[39m
    [90m 40| [39m
    [90m 41| [39m    [35mtry[39m {
    [90m 42| [39m      [35mconst[39m [credentials] [33m=[39m [35mawait[39m database
    [90m   | [39m                            [31m^[39m
    [90m 43| [39m        [33m.[39m[34minsert[39m(userCredentials)
    [90m 44| [39m        [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m72:5[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:[2m42:29[22m[39m
[90m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m72:5[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 331, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(TZslFbBjlxWCLhS0k0ALq) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[183/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 when refresh token is missing
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: oqf8QkCS0Xr0G63rKyDSo,refresh-test-Tc9YahE-wOk_SU4i_bj3Z@example.com,Refresh Test,Refresh,Test,da167fcc-ab97-44be-bcd1-563c07ba9de3,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(da167fcc-ab97-44be-bcd1-563c07ba9de3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[184/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 for invalid refresh token
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: M4tDkAnekzGZ45B1MhING,refresh-test-dE2S9cnkUqABgyA-kICcP@example.com,Refresh Test,Refresh,Test,da167fcc-ab97-44be-bcd1-563c07ba9de3,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(da167fcc-ab97-44be-bcd1-563c07ba9de3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[185/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 for expired refresh token
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: fu2s1U8kyvOcEyyJmmEqZ,refresh-test-5zvNVEDJ94-0UPn5t-OVP@example.com,Refresh Test,Refresh,Test,da167fcc-ab97-44be-bcd1-563c07ba9de3,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(da167fcc-ab97-44be-bcd1-563c07ba9de3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[186/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 for revoked refresh token
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 465eOKMFtRnYCJw9QKRkW,refresh-test-FZk0gPEdMIC8KRU2DlaqZ@example.com,Refresh Test,Refresh,Test,da167fcc-ab97-44be-bcd1-563c07ba9de3,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(da167fcc-ab97-44be-bcd1-563c07ba9de3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[187/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 when user is not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: ZZcR9zwTDRGD4Sgk_TAx0,refresh-test-d7U4P83CrndvKy03Xqs3B@example.com,Refresh Test,Refresh,Test,da167fcc-ab97-44be-bcd1-563c07ba9de3,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(da167fcc-ab97-44be-bcd1-563c07ba9de3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[188/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould update refresh token metadata on rotation
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: dlbRw0BVr-8IYnSgFceMd,refresh-test-xXQ5AWli8xayuIKth6hgX@example.com,Refresh Test,Refresh,Test,da167fcc-ab97-44be-bcd1-563c07ba9de3,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(da167fcc-ab97-44be-bcd1-563c07ba9de3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[189/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould handle concurrent refresh token requests (token reuse detection)
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: cKbWalL6RYIRO-TPv2120,refresh-test-Qbzp1MN6sDN1xXnYcqmEY@example.com,Refresh Test,Refresh,Test,da167fcc-ab97-44be-bcd1-563c07ba9de3,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(da167fcc-ab97-44be-bcd1-563c07ba9de3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w2_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[190/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould set secure cookie in production
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: PvJlJtr0M-a9ctiXtx96i,refresh-test-1fmAS7S-uOLZlDlki4Luo@example.com,Refresh Test,Refresh,Test,da167fcc-ab97-44be-bcd1-563c07ba9de3,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(da167fcc-ab97-44be-bcd1-563c07ba9de3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[191/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould set proper cookie attributes
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: qoz2To_5kbRePqTnpHXHI,refresh-test--7i_qGNStsWJy0D64_j6p@example.com,Refresh Test,Refresh,Test,da167fcc-ab97-44be-bcd1-563c07ba9de3,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(da167fcc-ab97-44be-bcd1-563c07ba9de3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[192/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould include user role information in response
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: PRteaBQoMxtVyCmbtbRUH,refresh-test-fibwgW-a9_XYCeMyZgFd_@example.com,Refresh Test,Refresh,Test,da167fcc-ab97-44be-bcd1-563c07ba9de3,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(da167fcc-ab97-44be-bcd1-563c07ba9de3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[193/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould create refresh token on login
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: AU8lo9Hvn4mTVYtKHofL0,refresh-test-OblCMDJYk4kffjKz5Qp-z@example.com,Refresh Test,Refresh,Test,da167fcc-ab97-44be-bcd1-563c07ba9de3,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(da167fcc-ab97-44be-bcd1-563c07ba9de3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[194/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould revoke refresh token on logout
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: UPsU29FhD1dEpA6yDnc61,refresh-test-Z1PP3sQQnhyhSnMs-WuE3@example.com,Refresh Test,Refresh,Test,da167fcc-ab97-44be-bcd1-563c07ba9de3,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(da167fcc-ab97-44be-bcd1-563c07ba9de3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[195/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould handle logout without refresh token gracefully
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: QbWp0amzilP6BzVYDGgYC,refresh-test-bV7Csf70DESRcLEHfTtrw@example.com,Refresh Test,Refresh,Test,da167fcc-ab97-44be-bcd1-563c07ba9de3,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(da167fcc-ab97-44be-bcd1-563c07ba9de3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[196/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould support multiple active refresh tokens per user
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 6oeVQkHvTAfiXui_mcUUX,refresh-test-gB1URm_Fv0-dwVRcWPWPi@example.com,Refresh Test,Refresh,Test,da167fcc-ab97-44be-bcd1-563c07ba9de3,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(da167fcc-ab97-44be-bcd1-563c07ba9de3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[197/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould revoke all user tokens on password reset
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: -JNVR5TWSpLVAU_MBEbLc,refresh-test-PV6jfJSczhivCF99Qm5kl@example.com,Refresh Test,Refresh,Test,da167fcc-ab97-44be-bcd1-563c07ba9de3,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(da167fcc-ab97-44be-bcd1-563c07ba9de3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[198/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Security[2m > [22mshould use cryptographically strong random tokens
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 3I7EyRECaYqYO5qy6HMnZ,refresh-test-FnWwVvey_yxCOPjcqyj_t@example.com,Refresh Test,Refresh,Test,da167fcc-ab97-44be-bcd1-563c07ba9de3,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(da167fcc-ab97-44be-bcd1-563c07ba9de3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[199/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Security[2m > [22mshould hash refresh tokens before storing in database
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: lduoWwhoUSnvOs4Q4DXfl,refresh-test-buk3Rd2SFaM97pNKFrfwS@example.com,Refresh Test,Refresh,Test,da167fcc-ab97-44be-bcd1-563c07ba9de3,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(da167fcc-ab97-44be-bcd1-563c07ba9de3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[200/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Security[2m > [22mshould prevent refresh token reuse after rotation
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: mhxaHlKc1cpHpN_b4W9dR,refresh-test-f4WxYeGVaPzZXJ4PfFKdj@example.com,Refresh Test,Refresh,Test,da167fcc-ab97-44be-bcd1-563c07ba9de3,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(da167fcc-ab97-44be-bcd1-563c07ba9de3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[201/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Security[2m > [22mshould validate token ownership
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: oodzQOcARdzh61flNEraE,refresh-test-KstQSL4UNSiqLLOqUqcqZ@example.com,Refresh Test,Refresh,Test,da167fcc-ab97-44be-bcd1-563c07ba9de3,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(da167fcc-ab97-44be-bcd1-563c07ba9de3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[202/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mCookie Security[2m > [22mshould set HttpOnly flag to prevent XSS
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 2YL01NOIqIgdsxt3MA7zP,refresh-test-SS0VQ19_dD-_AyidvMcsZ@example.com,Refresh Test,Refresh,Test,da167fcc-ab97-44be-bcd1-563c07ba9de3,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(da167fcc-ab97-44be-bcd1-563c07ba9de3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[203/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mCookie Security[2m > [22mshould set SameSite=Strict to prevent CSRF
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 0ltzhXLI-IYn8Fp9K1URN,refresh-test-sVFFS_JKF3UI9v7qk3sM_@example.com,Refresh Test,Refresh,Test,da167fcc-ab97-44be-bcd1-563c07ba9de3,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(da167fcc-ab97-44be-bcd1-563c07ba9de3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[204/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mCookie Security[2m > [22mshould set proper cookie path
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: HIzp9QEfdDih6lIWdR8oA,refresh-test-lWvvRZnLge8Cx2JP8bFmz@example.com,Refresh Test,Refresh,Test,da167fcc-ab97-44be-bcd1-563c07ba9de3,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(da167fcc-ab97-44be-bcd1-563c07ba9de3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[205/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mCookie Security[2m > [22mshould set appropriate expiry (30 days)
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: YnWEAVQMRvHjJZPlOckQ1,refresh-test-tvXzzuRArfsgXAGXz1Lz8@example.com,Refresh Test,Refresh,Test,da167fcc-ab97-44be-bcd1-563c07ba9de3,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(da167fcc-ab97-44be-bcd1-563c07ba9de3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[206/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mTemplate Key Resolution (New Path)[2m > [22mshould resolve template by key from workflowTemplates mapping
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: 5e72a27b-d193-4651-92e1-a67cb087573d,Test Project,Test Project,Test project for integration tests,c1596cd7-73be-48a0-a4c9-3622de6371b0,9040d1d5-4c09-45c7-83e3-2d8ae83c5544,c1596cd7-73be-48a0-a4c9-3622de6371b0,c1596cd7-73be-48a0-a4c9-3622de6371b0[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(c1596cd7-73be-48a0-a4c9-3622de6371b0) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[207/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mTemplate Key Resolution (New Path)[2m > [22mshould throw error if template key not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: f4320318-272f-4473-83ad-e44bf31a4ea6,test-1768708947540@example.com,Test User,Test,User,08ce49f4-a424-482c-951c-64789667cc77,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(08ce49f4-a424-482c-951c-64789667cc77) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[208/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mTemplate Key Resolution (New Path)[2m > [22mshould store output in runOutputs table
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: ed186d51-20aa-43be-bf39-d7cc73f79b21,test-1768708948122@example.com,Test User,Test,User,9cb3e2d6-b782-4db9-84b9-a9e2a5e264c0,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(9cb3e2d6-b782-4db9-84b9-a9e2a5e264c0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[209/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mLegacy Template ID Path (Backward Compatibility)[2m > [22mshould resolve template by templateId directly
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 443bc6ea-6263-4722-80db-5a48c6e4a4e3,test-1768708948809@example.com,Test User,Test,User,c9c98703-dd5b-42b4-84c9-c24ef57243f4,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(c9c98703-dd5b-42b4-84c9-c24ef57243f4) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[210/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mLegacy Template ID Path (Backward Compatibility)[2m > [22mshould throw error if templateId not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 3c2b9765-2331-45ed-b211-7d95734326b9,test-1768708949384@example.com,Test User,Test,User,024864ea-75e7-4490-8cc3-8656807274a6,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(024864ea-75e7-4490-8cc3-8656807274a6) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[211/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mRendering Engine Selection[2m > [22mshould use docxRenderer2 by default (v2 engine)
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: 65388ac1-9a2d-4cf7-846d-aff5a9a95ab1,Test Project,Test Project,Test project for integration tests,f93d8271-3652-4fa3-bf88-f0203cdfa4d6,6179d187-b747-4505-9098-639428d238b6,f93d8271-3652-4fa3-bf88-f0203cdfa4d6,f93d8271-3652-4fa3-bf88-f0203cdfa4d6[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(f93d8271-3652-4fa3-bf88-f0203cdfa4d6) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[212/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mRendering Engine Selection[2m > [22mshould use legacy engine when engine="legacy"
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 32f0f775-2e0a-461e-8b38-d5a49a6a075c,test-1768708950605@example.com,Test User,Test,User,bb36c165-c894-4d89-8fbe-e66852cfee4c,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(bb36c165-c894-4d89-8fbe-e66852cfee4c) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[213/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mPDF Generation[2m > [22mshould generate PDF when toPdf=true
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 48a71bd5-e016-40ca-a708-7c1b186801a0,test-1768708951194@example.com,Test User,Test,User,68358e05-0564-4235-bcf7-3d77f68cda52,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(68358e05-0564-4235-bcf7-3d77f68cda52) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w2_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[214/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mPDF Generation[2m > [22mshould default to DOCX when toPdf=false
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 0330d16f-d78d-4474-b9af-42e3878099ee,test-1768708951775@example.com,Test User,Test,User,9ae3fd7f-29bd-4954-b772-a652aba2389a,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(9ae3fd7f-29bd-4954-b772-a652aba2389a) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[215/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mConditional Execution[2m > [22mshould skip execution when condition evaluates to false
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: da97140b-d9e6-493f-b52c-86d1f2575047,test-1768708952353@example.com,Test User,Test,User,9d051156-4bc6-4dbf-8956-f457c0f8fecd,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(9d051156-4bc6-4dbf-8956-f457c0f8fecd) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w14_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[216/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mConditional Execution[2m > [22mshould execute when condition evaluates to true
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: e77ccb9b-0f3d-4416-8977-55b87097a7fc,test-1768708953413@example.com,Test User,Test,User,372beb5f-c95e-4cfe-8b36-22911a989757,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(372beb5f-c95e-4cfe-8b36-22911a989757) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w2_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[217/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mBinding Resolution[2m > [22mshould resolve simple bindings
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 2c9213f3-f2fe-43e9-a568-a6f059674c85,test-1768708954214@example.com,Test User,Test,User,eece71a9-ce5b-4b08-88b9-2496f367a3c2,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(eece71a9-ce5b-4b08-88b9-2496f367a3c2) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[218/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mBinding Resolution[2m > [22mshould handle binding resolution errors gracefully
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 33f90a19-ee91-418a-8694-72c6b07805f7,test-1768708955302@example.com,Test User,Test,User,0e716430-7ac0-402e-9583-9c1b9f396284,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(0e716430-7ac0-402e-9583-9c1b9f396284) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[219/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mError Handling[2m > [22mshould record failed output in runOutputs table
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: f3bf1c6d-4f30-41c1-b319-326ca4dc4145,test-1768708955944@example.com,Test User,Test,User,27c32577-766c-4b38-86fe-11879ed39123,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(27c32577-766c-4b38-86fe-11879ed39123) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[220/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mError Handling[2m > [22mshould not throw errors (should return error in result)
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, $3, $4, $5, default, $6, default, $7, default, default, default, default, default, default, $8, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: b7d0c5cf-23d8-4534-93e9-777ee68942d4,Test Workflow,Test workflow,79592938-bae8-4bec-878d-0951d6f67492,79592938-bae8-4bec-878d-0951d6f67492,test-workflow-2f7ae362-1c05-4405-8b40-753f06801720,cc1fb926-fd6b-40c6-9b80-3b11cf531e41,draft[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
    [90m149| [39m    }
    [90m150| [39m  )[33m:[39m [33mPromise[39m[33m<[39m[33mTestWorkflow[39m[33m>[39m {
    [90m151| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                       [31m^[39m
    [90m152| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mworkflows)
    [90m153| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m87:35[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m87:35[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 327, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(79592938-bae8-4bec-878d-0951d6f67492) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[221/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mTenant Access Control[2m > [22mshould deny access to templates from different tenant
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 5ef6f154-75db-42d7-80cd-21bded3f9fe2,test-1768708957543@example.com,Test User,Test,User,38162224-e561-4118-ac23-cfc383071f5c,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(38162224-e561-4118-ac23-cfc383071f5c) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[222/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mValidation[2m > [22mshould require either templateKey or templateId
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 3b250be3-3704-4e5b-b2dc-e59e87ea7dd8,test-1768708958129@example.com,Test User,Test,User,42f172b8-f61a-4579-ae25-607e43cd2f60,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(42f172b8-f61a-4579-ae25-607e43cd2f60) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[223/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22mhybridAuth[2m > [22mshould authenticate with JWT Bearer token
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m238:24[22m[39m
    [90m236| [39m      await hybridAuth(mockReq as unknown as Request, mockRes as unknoâ€¦
    [90m237| [39m
    [90m238| [39m      [34mexpect[39m(mockNext)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m239| [39m      [35mconst[39m authReq [33m=[39m mockReq [35mas[39m unknown [35mas[39m [33mAuthRequest[39m[33m;[39m
    [90m240| [39m      [34mexpect[39m(authReq[33m.[39muserId)[33m.[39m[34mtoBe[39m(mockUser[33m.[39mid)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[224/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22mhybridAuth[2m > [22mshould authenticate with refresh token cookie for GET requests
[31m[1mAssertionError[22m: expected "vi.fn()" to be called with arguments: [ 'user-123' ][90m

Number of calls: [1m0[22m
[31m[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m256:39[22m[39m
    [90m254| [39m
    [90m255| [39m      expect(authService.validateRefreshToken).toHaveBeenCalledWith(reâ€¦
    [90m256| [39m      expect(userRepository.findById).toHaveBeenCalledWith(mockUser.idâ€¦
    [90m   | [39m                                      [31m^[39m
    [90m257| [39m      [34mexpect[39m(mockNext)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m258| [39m      [35mconst[39m authReq [33m=[39m mockReq [35mas[39m unknown [35mas[39m [33mAuthRequest[39m[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[225/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22mhybridAuth[2m > [22mshould reject cookie auth for POST requests
[31m[1mAssertionError[22m: expected "vi.fn()" to be called with arguments: [ 401 ][90m

Number of calls: [1m0[22m
[31m[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m272:26[22m[39m
    [90m270| [39m
    [90m271| [39m      [34mexpect[39m(mockNext)[33m.[39mnot[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m272| [39m      [34mexpect[39m(statusMock)[33m.[39m[34mtoHaveBeenCalledWith[39m([34m401[39m)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m273| [39m      expect(authService.validateRefreshToken).not.toHaveBeenCalled();â€¦
    [90m274| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[226/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22mhybridAuth[2m > [22mshould prioritize JWT over cookie when both present
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m296:24[22m[39m
    [90m294| [39m      await hybridAuth(mockReq as unknown as Request, mockRes as unknoâ€¦
    [90m295| [39m
    [90m296| [39m      [34mexpect[39m(mockNext)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m297| [39m      [35mconst[39m authReq [33m=[39m mockReq [35mas[39m unknown [35mas[39m [33mAuthRequest[39m[33m;[39m
    [90m298| [39m      [90m// Should use JWT (mockUser), not cookie (mockUser2)[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[227/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22mhybridAuth[2m > [22mshould allow cookie auth only for safe methods
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m324:22[22m[39m
    [90m322| [39m
    [90m323| [39m        await hybridAuth(req as unknown as Request, res as unknown as â€¦
    [90m324| [39m        [34mexpect[39m(next)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                     [31m^[39m
    [90m325| [39m        expect(authService.validateRefreshToken).toHaveBeenCalledWith(â€¦
    [90m326| [39m        expect(userRepository.findById).toHaveBeenCalledWith(mockUser.â€¦

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[228/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22mhybridAuth[2m > [22mshould return 401 when no auth provided
[31m[1mAssertionError[22m: expected "vi.fn()" to be called with arguments: [ 401 ][90m

Number of calls: [1m0[22m
[31m[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m364:26[22m[39m
    [90m362| [39m
    [90m363| [39m      [34mexpect[39m(mockNext)[33m.[39mnot[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m364| [39m      [34mexpect[39m(statusMock)[33m.[39m[34mtoHaveBeenCalledWith[39m([34m401[39m)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m365| [39m    })[33m;[39m
    [90m366| [39m  })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[229/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22moptionalHybridAuth[2m > [22mshould authenticate with JWT
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m381:24[22m[39m
    [90m379| [39m      await optionalHybridAuth(mockReq as unknown as Request, mockRes â€¦
    [90m380| [39m
    [90m381| [39m      [34mexpect[39m(mockNext)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m382| [39m      [35mconst[39m authReq [33m=[39m mockReq [35mas[39m unknown [35mas[39m [33mAuthRequest[39m[33m;[39m
    [90m383| [39m      [34mexpect[39m(authReq[33m.[39muserId)[33m.[39m[34mtoBe[39m(mockUser[33m.[39mid)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[230/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22moptionalHybridAuth[2m > [22mshould authenticate with cookie for GET
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m400:24[22m[39m
    [90m398| [39m      await optionalHybridAuth(mockReq as unknown as Request, mockRes â€¦
    [90m399| [39m
    [90m400| [39m      [34mexpect[39m(mockNext)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m401| [39m      [35mconst[39m authReq [33m=[39m mockReq [35mas[39m unknown [35mas[39m [33mAuthRequest[39m[33m;[39m
    [90m402| [39m      [34mexpect[39m(authReq[33m.[39muserId)[33m.[39m[34mtoBe[39m(mockUser[33m.[39mid)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[231/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22moptionalHybridAuth[2m > [22mshould proceed without auth when none provided
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m413:24[22m[39m
    [90m411| [39m      await optionalHybridAuth(mockReq as unknown as Request, mockRes â€¦
    [90m412| [39m
    [90m413| [39m      [34mexpect[39m(mockNext)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m414| [39m      [35mconst[39m authReq [33m=[39m mockReq [35mas[39m unknown [35mas[39m [33mAuthRequest[39m[33m;[39m
    [90m415| [39m      [34mexpect[39m(authReq[33m.[39muserId)[33m.[39m[34mtoBeUndefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[232/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22moptionalHybridAuth[2m > [22mshould proceed even with invalid auth
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m435:24[22m[39m
    [90m433| [39m      await optionalHybridAuth(mockReq as unknown as Request, mockRes â€¦
    [90m434| [39m
    [90m435| [39m      [34mexpect[39m(mockNext)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m436| [39m      [35mconst[39m authReq [33m=[39m mockReq [35mas[39m unknown [35mas[39m [33mAuthRequest[39m[33m;[39m
    [90m437| [39m      [34mexpect[39m(authReq[33m.[39muserId)[33m.[39m[34mtoBeUndefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[233/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22mSecurity Edge Cases[2m > [22mshould not allow cookie auth for mutations (CSRF protection)
[31m[1mAssertionError[22m: expected "vi.fn()" to be called with arguments: [ 401 ][90m

Number of calls: [1m0[22m
[31m[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m479:28[22m[39m
    [90m477| [39m
    [90m478| [39m        [34mexpect[39m(next)[33m.[39mnot[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m479| [39m        [34mexpect[39m(res[33m.[39mstatus)[33m.[39m[34mtoHaveBeenCalledWith[39m([34m401[39m)[33m;[39m
    [90m   | [39m                           [31m^[39m
    [90m480| [39m        expect(authService.validateRefreshToken).not.toHaveBeenCalled(â€¦
    [90m481| [39m        vi[33m.[39m[34mclearAllMocks[39m()[33m;[39m [90m// Clear mocks for next iteration[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[234/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mcreate[2m > [22mshould create a workflow template mapping
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,424b033f-7970-4f77-811b-89744d80bb79,424b033f-7970-4f77-811b-89744d80bb79,424b033f-7970-4f77-811b-89744d80bb79[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 325, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(424b033f-7970-4f77-811b-89744d80bb79) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w125_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[235/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mcreate[2m > [22mshould create non-primary mapping by default
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,a61bf923-0c92-48bc-a080-642ee3ba2366,a61bf923-0c92-48bc-a080-642ee3ba2366,a61bf923-0c92-48bc-a080-642ee3ba2366[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(a61bf923-0c92-48bc-a080-642ee3ba2366) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[236/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionId[2m > [22mshould find all templates for a workflow version
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,c96bb448-a86b-4892-8f32-e121f97a7e09,c96bb448-a86b-4892-8f32-e121f97a7e09,c96bb448-a86b-4892-8f32-e121f97a7e09[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(c96bb448-a86b-4892-8f32-e121f97a7e09) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[237/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionId[2m > [22mshould return empty array for version with no templates
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,0b567647-9caf-4041-8a00-eaa7e0b4c694,0b567647-9caf-4041-8a00-eaa7e0b4c694,0b567647-9caf-4041-8a00-eaa7e0b4c694[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(0b567647-9caf-4041-8a00-eaa7e0b4c694) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[238/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionId[2m > [22mshould order by createdAt desc (newest first)
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,c44128c4-871f-4894-854b-01d9064dd001,c44128c4-871f-4894-854b-01d9064dd001,c44128c4-871f-4894-854b-01d9064dd001[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(c44128c4-871f-4894-854b-01d9064dd001) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[239/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionAndKey[2m > [22mshould find mapping by workflow version and key
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, default, $5, default, default, default, default, default, default, $6, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,f6f479f2-a5ce-4d61-83d1-95a1579b50c2,f6f479f2-a5ce-4d61-83d1-95a1579b50c2,92093409-6b85-4af4-b933-2e992f414bc6,draft[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m
    [90m 50| [39m
    [90m 51| [39m    [90m// Create test workflow[39m
    [90m 52| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m db
    [90m   | [39m                       [31m^[39m
    [90m 53| [39m      [33m.[39m[34minsert[39m(workflows)
    [90m 54| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(f6f479f2-a5ce-4d61-83d1-95a1579b50c2) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[240/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionAndKey[2m > [22mshould return undefined for non-existent key
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,d63cb973-9603-4ec5-8814-fee4a7e699be,d63cb973-9603-4ec5-8814-fee4a7e699be,d63cb973-9603-4ec5-8814-fee4a7e699be[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(d63cb973-9603-4ec5-8814-fee4a7e699be) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w2_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[241/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindPrimaryByWorkflowVersionId[2m > [22mshould find primary template for workflow version
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,5ee97019-5596-4a7f-a4ef-f7d5fa17a15d,5ee97019-5596-4a7f-a4ef-f7d5fa17a15d,5ee97019-5596-4a7f-a4ef-f7d5fa17a15d[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(5ee97019-5596-4a7f-a4ef-f7d5fa17a15d) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[242/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindPrimaryByWorkflowVersionId[2m > [22mshould return undefined when no primary template exists
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, default, $5, default, default, default, default, default, default, $6, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,d474fadc-489c-4dbe-a4bb-d720f13174c3,d474fadc-489c-4dbe-a4bb-d720f13174c3,8304ac68-b231-4d6d-8115-e6bfb578c77b,draft[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m
    [90m 50| [39m
    [90m 51| [39m    [90m// Create test workflow[39m
    [90m 52| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m db
    [90m   | [39m                       [31m^[39m
    [90m 53| [39m      [33m.[39m[34minsert[39m(workflows)
    [90m 54| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 327, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(d474fadc-489c-4dbe-a4bb-d720f13174c3) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[243/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22msetPrimary[2m > [22mshould set a template as primary and unset others
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,56dd6f2a-7a78-4f22-9fb2-af4dfde2c4e6,56dd6f2a-7a78-4f22-9fb2-af4dfde2c4e6,56dd6f2a-7a78-4f22-9fb2-af4dfde2c4e6[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(56dd6f2a-7a78-4f22-9fb2-af4dfde2c4e6) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[244/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22msetPrimary[2m > [22mshould handle setting primary when none existed before
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,2eb60144-e40f-405d-88ae-afaed3ed2155,2eb60144-e40f-405d-88ae-afaed3ed2155,2eb60144-e40f-405d-88ae-afaed3ed2155[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(2eb60144-e40f-405d-88ae-afaed3ed2155) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[245/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22msetPrimary[2m > [22mshould not delete mapping if workflow version does not match
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,1663a338-e6b9-48f2-b39e-0a96a9b77ba2,1663a338-e6b9-48f2-b39e-0a96a9b77ba2,1663a338-e6b9-48f2-b39e-0a96a9b77ba2[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(1663a338-e6b9-48f2-b39e-0a96a9b77ba2) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[246/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mexistsByKey[2m > [22mshould return true if key exists in workflow version
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,70113aea-e1b8-421c-b1e1-b14393132fc6,70113aea-e1b8-421c-b1e1-b14393132fc6,70113aea-e1b8-421c-b1e1-b14393132fc6[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(70113aea-e1b8-421c-b1e1-b14393132fc6) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[247/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mexistsByKey[2m > [22mshould return false if key does not exist
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,3149a586-80c7-4adf-bb67-91824444f054,3149a586-80c7-4adf-bb67-91824444f054,3149a586-80c7-4adf-bb67-91824444f054[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(3149a586-80c7-4adf-bb67-91824444f054) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[248/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mexistsByKey[2m > [22mshould exclude specified id when checking existence
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,f634f873-2efa-417c-87fc-8ba932604d26,f634f873-2efa-417c-87fc-8ba932604d26,f634f873-2efa-417c-87fc-8ba932604d26[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(f634f873-2efa-417c-87fc-8ba932604d26) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[249/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mexistsByKey[2m > [22mshould return true if key exists on different mapping
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,44a25492-b33d-4664-8ee0-d24f27b8960a,44a25492-b33d-4664-8ee0-d24f27b8960a,44a25492-b33d-4664-8ee0-d24f27b8960a[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(44a25492-b33d-4664-8ee0-d24f27b8960a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[250/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mupdate[2m > [22mshould update mapping fields
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,cec471a7-51dd-414e-8f00-64ef9e0f8efd,cec471a7-51dd-414e-8f00-64ef9e0f8efd,cec471a7-51dd-414e-8f00-64ef9e0f8efd[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(cec471a7-51dd-414e-8f00-64ef9e0f8efd) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[251/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindById[2m > [22mshould find mapping by id
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, default, $5, default, default, default, default, default, default, $6, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,0ea6e502-ee8f-4fcf-b320-f7757f7c3fb4,0ea6e502-ee8f-4fcf-b320-f7757f7c3fb4,88eab2bc-d207-4034-a4e9-a7198d7a60c0,draft[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m
    [90m 50| [39m
    [90m 51| [39m    [90m// Create test workflow[39m
    [90m 52| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m db
    [90m   | [39m                       [31m^[39m
    [90m 53| [39m      [33m.[39m[34minsert[39m(workflows)
    [90m 54| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 327, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(0ea6e502-ee8f-4fcf-b320-f7757f7c3fb4) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[252/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindById[2m > [22mshould return undefined for non-existent id
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,64804412-b8bb-4c97-8d00-e607b6f8cd53,64804412-b8bb-4c97-8d00-e607b6f8cd53,64804412-b8bb-4c97-8d00-e607b6f8cd53[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(64804412-b8bb-4c97-8d00-e607b6f8cd53) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[253/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mPassword Reset[2m > [22mgeneratePasswordResetToken()[2m > [22mshould generate password reset token for existing user
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.generatePasswordResetToken server/services/AuthService.ts:[2m508:9[22m[39m
    [90m506| [39m
    [90m507| [39m        [35mawait[39m [34msendPasswordResetEmail[39m(email[33m,[39m plainToken)[33m;[39m
    [90m508| [39m        log[33m.[39m[34minfo[39m({ email }[33m,[39m [32m'Password reset email sent'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m509| [39m
    [90m510| [39m        [35mreturn[39m plainToken[33m;[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m671:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[254/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mPassword Reset[2m > [22mgeneratePasswordResetToken()[2m > [22mshould invalidate previous reset tokens
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.generatePasswordResetToken server/services/AuthService.ts:[2m508:9[22m[39m
    [90m506| [39m
    [90m507| [39m        [35mawait[39m [34msendPasswordResetEmail[39m(email[33m,[39m plainToken)[33m;[39m
    [90m508| [39m        log[33m.[39m[34minfo[39m({ email }[33m,[39m [32m'Password reset email sent'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m509| [39m
    [90m510| [39m        [35mreturn[39m plainToken[33m;[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m695:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[255/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mRefresh Token Management[2m > [22mrotateRefreshToken()[2m > [22mshould rotate valid token and return new one
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.rotateRefreshToken server/services/AuthService.ts:[2m396:9[22m[39m
    [90m394| [39m        [90m// DEBUG LOG[39m
    [90m395| [39m        [90m// logger is available as 'log' from imports[39m
    [90m396| [39m        log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEBâ€¦
    [90m   | [39m        [31m^[39m
    [90m397| [39m
    [90m398| [39m        [90m// Find token purely by hash to detect state[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m901:42[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[256/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mRefresh Token Management[2m > [22mrotateRefreshToken()[2m > [22mshould return null for unknown token
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.rotateRefreshToken server/services/AuthService.ts:[2m396:9[22m[39m
    [90m394| [39m        [90m// DEBUG LOG[39m
    [90m395| [39m        [90m// logger is available as 'log' from imports[39m
    [90m396| [39m        log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEBâ€¦
    [90m   | [39m        [31m^[39m
    [90m397| [39m
    [90m398| [39m        [90m// Find token purely by hash to detect state[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m914:42[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[257/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mRefresh Token Management[2m > [22mrotateRefreshToken()[2m > [22mshould revoke all tokens on reuse detection
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.rotateRefreshToken server/services/AuthService.ts:[2m396:9[22m[39m
    [90m394| [39m        [90m// DEBUG LOG[39m
    [90m395| [39m        [90m// logger is available as 'log' from imports[39m
    [90m396| [39m        log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEBâ€¦
    [90m   | [39m        [31m^[39m
    [90m397| [39m
    [90m398| [39m        [90m// Find token purely by hash to detect state[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m933:42[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[258/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mRefresh Token Management[2m > [22mrotateRefreshToken()[2m > [22mshould return null for expired token
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.rotateRefreshToken server/services/AuthService.ts:[2m396:9[22m[39m
    [90m394| [39m        [90m// DEBUG LOG[39m
    [90m395| [39m        [90m// logger is available as 'log' from imports[39m
    [90m396| [39m        log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEBâ€¦
    [90m   | [39m        [31m^[39m
    [90m397| [39m
    [90m398| [39m        [90m// Find token purely by hash to detect state[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m950:42[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[259/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mToken Cleanup[2m > [22mcleanupExpiredTokens()[2m > [22mshould cleanup expired refresh tokens
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.cleanupExpiredTokens server/services/AuthService.ts:[2m593:9[22m[39m
    [90m591| [39m        [35mawait[39m accountLockoutService[33m.[39m[34mcleanupOldAttempts[39m()[33m;[39m
    [90m592| [39m
    [90m593| [39m        log[33m.[39m[34minfo[39m([32m'Cleaned up expired tokens and old login attempts'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m594| [39m    }
    [90m595| [39m}
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m977:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[260/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mToken Cleanup[2m > [22mcleanupExpiredTokens()[2m > [22mshould cleanup expired password reset tokens
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.cleanupExpiredTokens server/services/AuthService.ts:[2m593:9[22m[39m
    [90m591| [39m        [35mawait[39m accountLockoutService[33m.[39m[34mcleanupOldAttempts[39m()[33m;[39m
    [90m592| [39m
    [90m593| [39m        log[33m.[39m[34minfo[39m([32m'Cleaned up expired tokens and old login attempts'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m594| [39m    }
    [90m595| [39m}
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m982:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[261/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mToken Cleanup[2m > [22mcleanupExpiredTokens()[2m > [22mshould cleanup expired email verification tokens
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.cleanupExpiredTokens server/services/AuthService.ts:[2m593:9[22m[39m
    [90m591| [39m        [35mawait[39m accountLockoutService[33m.[39m[34mcleanupOldAttempts[39m()[33m;[39m
    [90m592| [39m
    [90m593| [39m        log[33m.[39m[34minfo[39m([32m'Cleaned up expired tokens and old login attempts'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m594| [39m    }
    [90m595| [39m}
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m987:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[262/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mToken Cleanup[2m > [22mcleanupExpiredTokens()[2m > [22mshould cleanup old login attempts via accountLockoutService
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.cleanupExpiredTokens server/services/AuthService.ts:[2m593:9[22m[39m
    [90m591| [39m        [35mawait[39m accountLockoutService[33m.[39m[34mcleanupOldAttempts[39m()[33m;[39m
    [90m592| [39m
    [90m593| [39m        log[33m.[39m[34minfo[39m([32m'Cleaned up expired tokens and old login attempts'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m594| [39m    }
    [90m595| [39m}
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m993:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[263/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mIntegration Scenarios[2m > [22mComplete Authentication Flow[2m > [22mshould support full user authentication lifecycle
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.rotateRefreshToken server/services/AuthService.ts:[2m396:9[22m[39m
    [90m394| [39m        [90m// DEBUG LOG[39m
    [90m395| [39m        [90m// logger is available as 'log' from imports[39m
    [90m396| [39m        log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEBâ€¦
    [90m   | [39m        [31m^[39m
    [90m397| [39m
    [90m398| [39m        [90m// Find token purely by hash to detect state[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m1239:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[264/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mIntegration Scenarios[2m > [22mPassword Reset Flow[2m > [22mshould support complete password reset workflow
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.generatePasswordResetToken server/services/AuthService.ts:[2m508:9[22m[39m
    [90m506| [39m
    [90m507| [39m        [35mawait[39m [34msendPasswordResetEmail[39m(email[33m,[39m plainToken)[33m;[39m
    [90m508| [39m        log[33m.[39m[34minfo[39m({ email }[33m,[39m [32m'Password reset email sent'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m509| [39m
    [90m510| [39m        [35mreturn[39m plainToken[33m;[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m1259:28[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[265/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mIntegration Scenarios[2m > [22mPassword Reset Flow[2m > [22mshould prevent reuse of password reset tokens
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.generatePasswordResetToken server/services/AuthService.ts:[2m508:9[22m[39m
    [90m506| [39m
    [90m507| [39m        [35mawait[39m [34msendPasswordResetEmail[39m(email[33m,[39m plainToken)[33m;[39m
    [90m508| [39m        log[33m.[39m[34minfo[39m({ email }[33m,[39m [32m'Password reset email sent'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m509| [39m
    [90m510| [39m        [35mreturn[39m plainToken[33m;[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m1296:28[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[266/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22menqueue[2m > [22mshould enqueue a PDF conversion job
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,95974e54-3bce-4ede-845a-48a40ec8f822,a4dcf38b-ba48-4e5f-8f5d-0aa586e7d97b,95974e54-3bce-4ede-845a-48a40ec8f822,95974e54-3bce-4ede-845a-48a40ec8f822[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(95974e54-3bce-4ede-845a-48a40ec8f822) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w14_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[267/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22menqueue[2m > [22mshould create output with empty storagePath initially
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,f13126a3-ce4c-49f6-86cf-341d06d4fc6d,18cc6da9-7511-4cdc-b505-9a019a4883b8,f13126a3-ce4c-49f6-86cf-341d06d4fc6d,f13126a3-ce4c-49f6-86cf-341d06d4fc6d[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(f13126a3-ce4c-49f6-86cf-341d06d4fc6d) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[268/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mgetJobStatus[2m > [22mshould return job status for pending job
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,00142e77-48b5-42cb-8456-a7bccfc236fe,41783788-2abd-46ac-a858-ff8c49b8bbe6,00142e77-48b5-42cb-8456-a7bccfc236fe,00142e77-48b5-42cb-8456-a7bccfc236fe[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(00142e77-48b5-42cb-8456-a7bccfc236fe) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[269/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mgetJobStatus[2m > [22mshould return null for non-existent job
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,bc4e1265-efbf-409d-8541-df4612bc8166,17c8f238-6e3c-484e-8581-63b7c7566d44,bc4e1265-efbf-409d-8541-df4612bc8166,bc4e1265-efbf-409d-8541-df4612bc8166[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(bc4e1265-efbf-409d-8541-df4612bc8166) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[270/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mgetJobStatus[2m > [22mshould parse attempt count from error field
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,e10f9ca4-f217-42fd-8424-a34ecfaa4bfa,4265d7f3-dae0-47ea-98ea-df86863c72bd,e10f9ca4-f217-42fd-8424-a34ecfaa4bfa,e10f9ca4-f217-42fd-8424-a34ecfaa4bfa[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(e10f9ca4-f217-42fd-8424-a34ecfaa4bfa) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[271/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mconvertImmediate[2m > [22mshould convert DOCX to PDF immediately
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,3f378e80-ab09-4ae4-b58e-26afc810276e,aee70341-0cca-48d7-94b8-f16e3ddeeb93,3f378e80-ab09-4ae4-b58e-26afc810276e,3f378e80-ab09-4ae4-b58e-26afc810276e[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(3f378e80-ab09-4ae4-b58e-26afc810276e) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[272/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mconvertImmediate[2m > [22mshould handle conversion errors gracefully
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,fc7abc2e-b1c1-4a6c-ab5e-b7846a420333,83cb9650-7395-4837-95dd-15ea5f42c394,fc7abc2e-b1c1-4a6c-ab5e-b7846a420333,fc7abc2e-b1c1-4a6c-ab5e-b7846a420333[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(fc7abc2e-b1c1-4a6c-ab5e-b7846a420333) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[273/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mService Lifecycle[2m > [22mshould start and stop service
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,25aede39-d7b5-4eb5-be23-617f9f00d23b,afa80590-7488-4d5e-9144-a30ac577803b,25aede39-d7b5-4eb5-be23-617f9f00d23b,25aede39-d7b5-4eb5-be23-617f9f00d23b[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(25aede39-d7b5-4eb5-be23-617f9f00d23b) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[274/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mService Lifecycle[2m > [22mshould not start if already running
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,bf0ee927-7e94-4d11-badf-1972b2996a07,49e8cb81-4c68-4dac-b2a5-2303cc8cb80c,bf0ee927-7e94-4d11-badf-1972b2996a07,bf0ee927-7e94-4d11-badf-1972b2996a07[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(bf0ee927-7e94-4d11-badf-1972b2996a07) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[275/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mService Lifecycle[2m > [22mshould handle stop when not running
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,beff1b9b-33ae-4f44-ba85-c8bf69fdc486,f72d166c-10f1-43f3-ac14-af22d717907a,beff1b9b-33ae-4f44-ba85-c8bf69fdc486,beff1b9b-33ae-4f44-ba85-c8bf69fdc486[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(beff1b9b-33ae-4f44-ba85-c8bf69fdc486) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[276/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mQueue Processing[2m > [22mshould process pending jobs when queue is processed
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,f1f1b808-9b44-4efc-a478-7892ffedfa92,155054a8-50e9-48b8-aa65-21a89d7ce317,f1f1b808-9b44-4efc-a478-7892ffedfa92,f1f1b808-9b44-4efc-a478-7892ffedfa92[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(f1f1b808-9b44-4efc-a478-7892ffedfa92) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[277/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mQueue Processing[2m > [22mshould process multiple jobs in batch
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,2b2187b9-e693-4f87-aeaa-156ce1977abf,87f30984-3e21-48ca-9b41-43b0250d6562,2b2187b9-e693-4f87-aeaa-156ce1977abf,2b2187b9-e693-4f87-aeaa-156ce1977abf[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(2b2187b9-e693-4f87-aeaa-156ce1977abf) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[278/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mError Handling[2m > [22mshould handle missing DOCX output gracefully
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,6c5fb629-76d9-4b6c-a948-b1c3cbe7eb45,fb79ec91-5052-4d31-a5fa-79627abf8e95,6c5fb629-76d9-4b6c-a948-b1c3cbe7eb45,6c5fb629-76d9-4b6c-a948-b1c3cbe7eb45[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(6c5fb629-76d9-4b6c-a948-b1c3cbe7eb45) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[279/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mTransaction Support[2m > [22mshould support enqueue within transaction
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,bb4be8fd-f4db-447b-9993-64b2bc26859f,5b1025f1-dadd-49c1-93ff-781c96ce234b,bb4be8fd-f4db-447b-9993-64b2bc26859f,bb4be8fd-f4db-447b-9993-64b2bc26859f[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(bb4be8fd-f4db-447b-9993-64b2bc26859f) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[280/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mTransaction Support[2m > [22mshould support convertImmediate within transaction
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,3bf7fa79-2d03-4ed8-9d7f-4b16a4433c68,172e298d-d8d1-4d2e-8c98-a05b400a7c00,3bf7fa79-2d03-4ed8-9d7f-4b16a4433c68,3bf7fa79-2d03-4ed8-9d7f-4b16a4433c68[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(3bf7fa79-2d03-4ed8-9d7f-4b16a4433c68) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[281/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mshould throw error if template belongs to different project
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 43cec11e-97ee-4af6-86fe-d68ff503a8d1,test-1768708946465@example.com,Test User,Test,User,62b651b3-8ec8-421f-81f7-514d4a0b1891,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(62b651b3-8ec8-421f-81f7-514d4a0b1891) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[282/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mshould automatically unset other primaries when setting new primary
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: cd7971ab-cd9f-4b4c-92b3-6e267e8170d7,test-1768708947083@example.com,Test User,Test,User,bab82494-865a-45fa-97e4-a0db712a7fb3,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(bab82494-865a-45fa-97e4-a0db712a7fb3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[283/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mlistTemplates[2m > [22mshould list all templates for workflow version
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 241b83cd-effe-422f-aa97-e11142e22d9b,test-1768708947703@example.com,Test User,Test,User,cfa88055-d2fd-4809-8504-f9ed0b1828e9,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(cfa88055-d2fd-4809-8504-f9ed0b1828e9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[284/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mlistTemplates[2m > [22mshould return empty array for version with no templates
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: a9194f5c-4c21-457e-b348-78744d452720,test-1768708948278@example.com,Test User,Test,User,af499bec-c61f-4ca7-8f6b-291311422e33,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(af499bec-c61f-4ca7-8f6b-291311422e33) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[285/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetTemplateMapping[2m > [22mshould get template mapping by id and version
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 4dbc6f9d-5877-44b8-b109-7aa172aa497e,test-1768708948871@example.com,Test User,Test,User,0e3df798-192e-4828-9eaa-31675c9701b9,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(0e3df798-192e-4828-9eaa-31675c9701b9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[286/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetTemplateMapping[2m > [22mshould throw error if mapping not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 31b13a88-6344-4d10-8c1e-9438eeb6b396,test-1768708949427@example.com,Test User,Test,User,718c54bb-b2f4-43d5-815f-02f4a10b8fb0,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(718c54bb-b2f4-43d5-815f-02f4a10b8fb0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w14_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[287/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetTemplateByKey[2m > [22mshould get template by key
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: ac8c813a-7721-4e25-863e-c2f1794b1c9c,Test Project,Test Project,Test project for integration tests,8e8d9947-a591-42ce-b051-48de223e6416,e69d83b6-3eab-4499-b2cb-bffdde6e2aeb,8e8d9947-a591-42ce-b051-48de223e6416,8e8d9947-a591-42ce-b051-48de223e6416[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(8e8d9947-a591-42ce-b051-48de223e6416) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w14_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[288/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetTemplateByKey[2m > [22mshould throw error if key not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: d666c69d-fcc6-4c9c-93c6-ce853e018056,test-1768708950673@example.com,Test User,Test,User,947ea2ff-6603-41f9-8e2f-58c91912b16d,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(947ea2ff-6603-41f9-8e2f-58c91912b16d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w14_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[289/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetPrimaryTemplate[2m > [22mshould get primary template for workflow version
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: cf8f568d-6b29-4d89-b042-187221d0884c,test-1768708951257@example.com,Test User,Test,User,93559f83-8d7f-441b-94de-b64078a66b81,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(93559f83-8d7f-441b-94de-b64078a66b81) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[290/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetPrimaryTemplate[2m > [22mshould return null when no primary template exists
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: 39efd113-5b09-4d33-9097-105aef97af4f,Test Project,Test Project,Test project for integration tests,4a3910d3-d10e-407b-b1ee-c70e46005d01,f9c54394-b1c9-4f27-969b-e4117703c563,4a3910d3-d10e-407b-b1ee-c70e46005d01,4a3910d3-d10e-407b-b1ee-c70e46005d01[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(4a3910d3-d10e-407b-b1ee-c70e46005d01) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w2_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[291/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould update mapping key
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: a4e1ed2d-574b-4a7f-a1fd-5a6fa54e8fe8,test-1768708952478@example.com,Test User,Test,User,88a9a57a-dce8-469c-ab47-1af8a3756aeb,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(88a9a57a-dce8-469c-ab47-1af8a3756aeb) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[292/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould update isPrimary flag
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 253981b5-0ad0-46a0-bc17-9fd04a6f5a27,test-1768708953310@example.com,Test User,Test,User,0311f6c6-1393-4e3f-a8fe-04706c27e5b0,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(0311f6c6-1393-4e3f-a8fe-04706c27e5b0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[293/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould throw error if new key already exists
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: c57c6613-6417-4193-9e1d-912b0b0c1fad,test-1768708953882@example.com,Test User,Test,User,ae0ec5f4-6dc3-456a-9f0d-7a99f5b22e18,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(ae0ec5f4-6dc3-456a-9f0d-7a99f5b22e18) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[294/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould throw error if mapping not found
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, $3, $4, $5, default, $6, $7, $8, default, default, default, default, default, default, $9, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: 83b40fb2-aef1-4910-a0a2-60d9194e926b,Test Workflow,Test workflow,9df52cdc-3ba4-446a-bec3-bc26102c6252,9df52cdc-3ba4-446a-bec3-bc26102c6252,test-workflow-7e394ecd-d258-4b33-a58c-3be87f68c9bc,Test Workflow,26718d42-38ff-4f60-be19-df0a3c246128,draft[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
    [90m149| [39m    }
    [90m150| [39m  )[33m:[39m [33mPromise[39m[33m<[39m[33mTestWorkflow[39m[33m>[39m {
    [90m151| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                       [31m^[39m
    [90m152| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mworkflows)
    [90m153| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m53:35[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m53:35[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 327, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(9df52cdc-3ba4-446a-bec3-bc26102c6252) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[295/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould unset other primaries when setting isPrimary to true
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: a27e0b1c-3e00-4ddb-bb2f-462d2be60598,test-1768708955735@example.com,Test User,Test,User,71c175d8-4eec-4be2-9bd9-fbf9d1442590,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(71c175d8-4eec-4be2-9bd9-fbf9d1442590) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[296/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mdetachTemplate[2m > [22mshould detach template from workflow version
[31m[1mError[22m: Failed query: insert into "workflow_versions" ("id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at") values ($1, $2, default, $3, default, $4, default, default, default, default, $5, default, default, default, default) returning "id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at"
params: 1f849aa2-a465-47ab-9782-fc5dadf9cc0e,8eccae3e-f205-4057-9378-1ee843f9344e,1,{},f4c11750-744d-46ce-ab71-b5ab07877375[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m166:23[22m[39m
    [90m164| [39m      [33m.[39m[34mreturning[39m()[33m;[39m
    [90m165| [39m
    [90m166| [39m    [35mconst[39m [version] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m167| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mworkflowVersions)
    [90m168| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m53:35[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "workflow_versions" violates foreign key constraint "workflow_versions_workflow_id_workflows_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m166:23[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m53:35[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 374, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(8eccae3e-f205-4057-9378-1ee843f9344e) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'workflow_versions', dataType: undefined, constraint: 'workflow_versions_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[297/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mdetachTemplate[2m > [22mshould throw error if mapping not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 9e4906d2-1b85-45c0-a164-4b24792d8a3a,test-1768708957284@example.com,Test User,Test,User,a20e362a-482f-4f68-8e9d-12cb70e56aef,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(a20e362a-482f-4f68-8e9d-12cb70e56aef) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[298/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22msetPrimaryTemplate[2m > [22mshould set template as primary
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 1e7f26f6-fefd-4365-9774-0a83e89c07f1,test-1768708958119@example.com,Test User,Test,User,f929d8b9-6cd5-4156-9b5f-71c67b7fc492,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f929d8b9-6cd5-4156-9b5f-71c67b7fc492) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[299/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22msetPrimaryTemplate[2m > [22mshould throw error if mapping not found
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: 76c940cf-e939-417a-93ff-14ecf3698376,Test Project,Test Project,Test project for integration tests,25b3ba57-7924-454a-828b-be8e3fdb6ece,c48db966-1937-4c3e-b6cd-a20b7b014a36,25b3ba57-7924-454a-828b-be8e3fdb6ece,25b3ba57-7924-454a-828b-be8e3fdb6ece[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(25b3ba57-7924-454a-828b-be8e3fdb6ece) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[300/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mtransaction support[2m > [22mshould support operations within a transaction
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: d941a279-beca-4596-91b6-d69c1d6f6a24,test-1768708959446@example.com,Test User,Test,User,bba01035-ebf9-4d9e-b75d-78436095859f,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(bba01035-ebf9-4d9e-b75d-78436095859f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[301/322]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mtransaction support[2m > [22mshould rollback on transaction error
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 9339abad-79ac-4d35-a8df-ab4398355a08,test-1768708960017@example.com,Test User,Test,User,1e4a65d5-c585-4ba4-a261-3af2f6a51305,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1e4a65d5-c585-4ba4-a261-3af2f6a51305) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w2_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[302/322]âŽ¯[22m[39m


[2m Test Files [22m [1m[31m50 failed[39m[22m[2m | [22m[1m[32m106 passed[39m[22m[2m | [22m[33m1 skipped[39m[90m (157)[39m
[2m      Tests [22m [1m[31m286 failed[39m[22m[2m | [22m[1m[32m2020 passed[39m[22m[2m | [22m[33m334 skipped[39m[90m (2640)[39m
[2m   Start at [22m 22:02:20
[2m   Duration [22m 95.93s[2m (transform 23.16s, setup 19.51s, import 300.53s, tests 845.20s, environment 27.04s)[22m

