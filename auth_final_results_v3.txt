npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w10_70636467

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w10_70636467

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w11_c9a00710

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w11_c9a00710

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768249961996,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768249962068,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768249962208,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768249962253,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w8_fa6519f2

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w8_fa6519f2

{"level":30,"time":1768249964258,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768249964298,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w9_5da0c77b

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w9_5da0c77b

{"level":30,"time":1768249965013,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768249965052,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768249965246,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768249965255,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768249965275,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768249965292,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768249965324,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768249965366,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768249965405,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768249965450,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w7_122761a6

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w3_9c566755

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w6_6247497e

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w7_122761a6

{"level":30,"time":1768249965824,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w3_9c566755

{"level":30,"time":1768249965846,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w5_56211a6b

{"level":30,"time":1768249965866,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768249965886,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w6_6247497e

{"level":30,"time":1768249965960,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768249966000,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w5_56211a6b

{"level":30,"time":1768249966016,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768249966062,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

stderr | tests/integration/auth/oauth2.client-credentials.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: relation "global_recipients" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 115,
  severity: 'ERROR',
  code: '42P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'namespace.c',
  line: '637',
  routine: 'RangeVarGetRelidExtended'
}

{"level":50,"time":1768249970473,"env":"test","status":401,"statusText":"Unauthorized","error":"Invalid client credentials","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768249970473,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768249970474,"env":"test","data":{"token_type":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768249970474,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768249970475,"env":"test","data":{"access_token":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768249970475,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768249970477,"env":"test","error":"Network error: ECONNREFUSED","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768249970605,"env":"test","error":"Invalid credentials","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":50,"time":1768249970606,"env":"test","error":"ECONNREFUSED","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768249970608,"env":"test","status":400,"statusText":"Bad Request","error":"Invalid grant_type","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768249970608,"env":"test","error":"OAuth2 token request failed: 400 Bad Request","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768249970608,"env":"test","status":401,"statusText":"Unauthorized","error":"Client authentication failed","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768249970608,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768249970609,"env":"test","status":403,"statusText":"Forbidden","error":"Access denied","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768249970609,"env":"test","error":"OAuth2 token request failed: 403 Forbidden","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768249970609,"env":"test","status":500,"statusText":"Internal Server Error","error":"Server error","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768249970609,"env":"test","error":"OAuth2 token request failed: 500 Internal Server Error","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768249970609,"env":"test","error":"Unexpected token in JSON","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768249970612,"env":"test","error":"Request timeout","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":30,"time":1768249970613,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768249970614,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w11_c9a00710

 [32mÎ“Â£Ã´[39m tests/integration/auth/oauth2.client-credentials.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 10630[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w1_b0d9d333

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w0_b640dbfc

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w4_c99239b9

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w2_3833785b

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_b640dbfc

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w4_c99239b9

{"level":30,"time":1768249973114,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768249973113,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w2_3833785b

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w1_b0d9d333

{"level":30,"time":1768249973116,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768249973117,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768249973155,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768249973158,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768249973159,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768249973162,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

stderr | tests/integration/auth.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: relation "global_recipients" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 115,
  severity: 'ERROR',
  code: '42P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'namespace.c',
  line: '637',
  routine: 'RangeVarGetRelidExtended'
}

{"level":30,"time":1768249975951,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768249975952,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w10_70636467

 [32mÎ“Â£Ã´[39m tests/integration/auth.routes.test.ts [2m([22m[2m41 tests[22m[2m)[22m[33m 16588[2mms[22m[39m
stderr | tests/integration/auth/oauth2.google.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: relation "global_recipients" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 115,
  severity: 'ERROR',
  code: '42P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'namespace.c',
  line: '637',
  routine: 'RangeVarGetRelidExtended'
}

{"level":30,"time":1768249981772,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":50,"time":1768249982004,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:165:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
{"level":50,"time":1768249982005,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:165:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google authentication failed"}
{"level":40,"time":1768249982062,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768249982062,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:89:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:155:23"},"msg":"Google token verification failed"}
{"level":50,"time":1768249982062,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:89:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:155:23"},"msg":"Google authentication failed"}
{"level":30,"time":1768249982474,"env":"test","module":"auth","email":"existing@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768249982897,"env":"test","module":"auth","email":"refresh@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768249983295,"env":"test","module":"auth","email":"idtoken@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768249983701,"env":"test","module":"auth","email":"minimal@example.com","msg":"OAuth2 login successful"}
{"level":50,"time":1768249983799,"env":"test","module":"auth","err":{"type":"Error","message":"Token verification failed","stack":"Error: Token verification failed\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:425:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
{"level":40,"time":1768249983848,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768249983848,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:89:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
{"level":50,"time":1768249983895,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token payload","stack":"Error: Invalid token payload\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:85:25)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
{"level":30,"time":1768249983953,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768249983953,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w8_fa6519f2

 [32mÎ“Â£Ã´[39m tests/integration/auth/oauth2.google.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 20691[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should successfully authenticate with valid Google ID token [33m 546[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update existing user on subsequent logins [33m 465[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should create refresh token record in database [33m 420[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should support both "token" and "idToken" fields [33m 348[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle missing profile information gracefully [33m 358[2mms[22m[39m
stderr | tests/integration/auth/oauth2.callback.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: relation "global_recipients" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 115,
  severity: 'ERROR',
  code: '42P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'namespace.c',
  line: '637',
  routine: 'RangeVarGetRelidExtended'
}

{"level":30,"time":1768249987058,"env":"test","connectionId":"73018b84-cda3-419a-86a5-ae1708cc6e37","projectId":"c560df49-3b9f-4488-97e7-3cd547df7670","name":"Test OAuth2 Connection","type":"oauth2_3leg","msg":"Connection created:"}
{"level":30,"time":1768249988159,"env":"test","connectionId":"2eaf36f3-cfe6-4392-9109-27079cd45e65","projectId":"c560df49-3b9f-4488-97e7-3cd547df7670","name":"Status Test Connection","type":"oauth2_3leg","msg":"Connection created:"}
{"level":30,"time":1768249988869,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768249988870,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w9_5da0c77b

 [32mÎ“Â£Ã´[39m tests/integration/auth/oauth2.callback.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 24850[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should initiate OAuth2 3-legged flow and generate authorization URL [33m 343[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should track OAuth2 connection status [33m 356[2mms[22m[39m
stderr | tests/integration/auth.flows.real.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: relation "global_recipients" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 115,
  severity: 'ERROR',
  code: '42P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'namespace.c',
  line: '637',
  routine: 'RangeVarGetRelidExtended'
}

{"level":30,"time":1768249992634,"env":"test","module":"user-credentials-repository","userId":"abe0027e-2779-4ab4-b57e-8e77271e1aae","msg":"User credentials created"}
{"level":30,"time":1768249992729,"env":"test","module":"email-queue","jobId":"e8351f42-a26a-4627-8da8-00e9b3ff5f0e","to":"test-1768249992240-02w0zs@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249992785,"env":"test","module":"auth-routes","userId":"abe0027e-2779-4ab4-b57e-8e77271e1aae","email":"test-1768249992240-02w0zs@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mComplete Registration Î“Ã¥Ã† Login Flow[2m > [22m[2mshould complete registration, verify email, then login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768249993176,"env":"test","module":"auth-routes","userId":"abe0027e-2779-4ab4-b57e-8e77271e1aae","email":"test-1768249992240-02w0zs@example.com","msg":"Login blocked: email not verified"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Complete Registration Î“Ã¥Ã† Login Flow > should complete registration, verify email, then login
Login Failed DEBUG: EmailNotVerifiedError: Please verify your email before logging in. Check your inbox for the verification link.
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:86:11)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_006',
  statusCode: 403,
  isOperational: true
}

{"level":50,"time":1768249993177,"env":"test","module":"auth-routes","error":{"name":"EmailNotVerifiedError","code":"AUTH_006","statusCode":403,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mComplete Registration Î“Ã¥Ã† Login Flow[2m > [22m[2mshould complete registration, verify email, then login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249993694,"env":"test","module":"auth-routes","userId":"abe0027e-2779-4ab4-b57e-8e77271e1aae","msg":"User logged in successfully"}
{"level":30,"time":1768249993744,"env":"test","module":"audit-log-service","userId":"abe0027e-2779-4ab4-b57e-8e77271e1aae","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249994844,"env":"test","module":"auth-routes","email":"test-1768249994128-y632f@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768249994945,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249995322,"env":"test","module":"auth-routes","email":"test-1768249994128-y632f@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768249995425,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249995790,"env":"test","module":"auth-routes","email":"test-1768249994128-y632f@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768249995895,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249996265,"env":"test","module":"auth-routes","email":"test-1768249994128-y632f@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768249996358,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249996717,"env":"test","module":"auth-routes","email":"test-1768249994128-y632f@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
stderr | tests/integration/auth/oauth2.sessions.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: relation "global_recipients" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 115,
  severity: 'ERROR',
  code: '42P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'namespace.c',
  line: '637',
  routine: 'RangeVarGetRelidExtended'
}

{"level":40,"time":1768249996909,"env":"test","module":"account-lockout","userId":"2de3672c4813a4f31dffd7f3d153e1f2","email":"test-1768249994128-y632f@example.com","lockedUntil":"2026-01-12T20:48:16.860Z","msg":"Account locked due to too many failed attempts"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768249996909,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768249997006,"env":"test","module":"auth-routes","userId":"2de3672c4813a4f31dffd7f3d153e1f2","email":"test-1768249994128-y632f@example.com","msg":"Login blocked: account locked"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: AccountLockedError: Account is locked until 2026-01-12T20:48:16.860Z
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:58:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_005',
  statusCode: 423,
  isOperational: true,
  lockedUntil: 2026-01-12T20:48:16.860Z,
  remainingMinutes: 15
}

{"level":50,"time":1768249997006,"env":"test","module":"auth-routes","error":{"name":"AccountLockedError","code":"AUTH_005","statusCode":423,"isOperational":true,"lockedUntil":"2026-01-12T20:48:16.860Z","remainingMinutes":15},"msg":"Login failed"}
{"level":30,"time":1768249997468,"env":"test","module":"user-credentials-repository","userId":"CHmLefnwr1kHDTYIwyvw5","msg":"User credentials created"}
{"level":30,"time":1768249997654,"env":"test","module":"auth-routes","userId":"CHmLefnwr1kHDTYIwyvw5","sessionCount":2,"msg":"Listed active sessions"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249997981,"env":"test","module":"user-credentials-repository","userId":"-TEHeoIMNksiyP4WIAyq_","msg":"User credentials created"}
{"level":30,"time":1768249998083,"env":"test","module":"auth-routes","userId":"-TEHeoIMNksiyP4WIAyq_","sessionCount":1,"msg":"Listed active sessions"}
{"level":50,"time":1768249998328,"env":"test","module":"auth-routes","email":"test-1768249997584-nwgojh@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768249998403,"env":"test","module":"user-credentials-repository","userId":"eHtl3TrmMUXuocOZi0fey","msg":"User credentials created"}
{"level":50,"time":1768249998422,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should record all login attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249998508,"env":"test","module":"auth-routes","userId":"eHtl3TrmMUXuocOZi0fey","sessionCount":0,"msg":"Listed active sessions"}
{"level":50,"time":1768249998789,"env":"test","module":"auth-routes","email":"test-1768249997584-nwgojh@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768249998828,"env":"test","module":"user-credentials-repository","userId":"_Yc4Ev4sRypYL5cp4DAvT","msg":"User credentials created"}
{"level":50,"time":1768249998883,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should record all login attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249998931,"env":"test","module":"auth-routes","userId":"_Yc4Ev4sRypYL5cp4DAvT","sessionCount":0,"msg":"Listed active sessions"}
{"level":30,"time":1768249999247,"env":"test","module":"user-credentials-repository","userId":"k5ptVQtlOcoxjZCaFR5l3","msg":"User credentials created"}
{"level":30,"time":1768249999345,"env":"test","module":"auth-routes","userId":"3a669b222ce06cfc379e91695921f214","msg":"User logged in successfully"}
{"level":30,"time":1768249999408,"env":"test","module":"auth-routes","userId":"k5ptVQtlOcoxjZCaFR5l3","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768249999407,"env":"test","module":"audit-log-service","userId":"3a669b222ce06cfc379e91695921f214","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249999725,"env":"test","module":"user-credentials-repository","userId":"aSn1t2j0mY1XSInA_ksw2","msg":"User credentials created"}
{"level":30,"time":1768249999829,"env":"test","module":"auth-routes","userId":"aSn1t2j0mY1XSInA_ksw2","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768250000150,"env":"test","module":"user-credentials-repository","userId":"9XgBv8qqIR1EoWByAvpJU","msg":"User credentials created"}
{"level":50,"time":1768250000153,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould complete MFA setup and login with TOTP
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250000477,"env":"test","module":"user-credentials-repository","userId":"DTnL7cvUCYRsw8DtOKCn0","msg":"User credentials created"}
{"level":30,"time":1768250000684,"env":"test","module":"auth-routes","userId":"8333b87dc2492db7b9be70ce1c8cb2ed","msg":"User logged in successfully"}
{"level":30,"time":1768250000718,"env":"test","module":"auth-routes","userId":"DTnL7cvUCYRsw8DtOKCn0","sessionId":"b2f18a48-c624-4e27-ae14-93392b5196b7","msg":"Session revoked"}
{"level":30,"time":1768250000731,"env":"test","module":"audit-log-service","userId":"8333b87dc2492db7b9be70ce1c8cb2ed","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250001082,"env":"test","module":"user-credentials-repository","userId":"7ShM1okt22NO-GSkKSSPZ","msg":"User credentials created"}
{"level":30,"time":1768250001175,"env":"test","module":"mfa-service","userId":"8333b87dc2492db7b9be70ce1c8cb2ed","count":10,"msg":"Stored backup codes"}
{"level":30,"time":1768250001175,"env":"test","module":"mfa-service","userId":"8333b87dc2492db7b9be70ce1c8cb2ed","msg":"Generated TOTP secret"}
{"level":30,"time":1768250001175,"env":"test","module":"auth-routes","userId":"8333b87dc2492db7b9be70ce1c8cb2ed","msg":"MFA setup initiated"}
{"level":30,"time":1768250001403,"env":"test","module":"user-credentials-repository","userId":"J1cM-ropTLq3Q7yN5iwVf","msg":"User credentials created"}
{"level":30,"time":1768250001468,"env":"test","module":"mfa-service","userId":"8333b87dc2492db7b9be70ce1c8cb2ed","msg":"MFA enabled successfully"}
{"level":30,"time":1768250001468,"env":"test","module":"auth-routes","userId":"8333b87dc2492db7b9be70ce1c8cb2ed","msg":"MFA enabled successfully"}
{"level":30,"time":1768250001514,"env":"test","module":"audit-log-service","userId":"8333b87dc2492db7b9be70ce1c8cb2ed","eventType":"mfa_enabled","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould complete MFA setup and login with TOTP
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250001927,"env":"test","module":"user-credentials-repository","userId":"f1jRJJyIUCoWvaKd21Oyd","msg":"User credentials created"}
{"level":30,"time":1768250002056,"env":"test","module":"auth-routes","userId":"8333b87dc2492db7b9be70ce1c8cb2ed","msg":"Login requires MFA verification"}
{"level":30,"time":1768250002162,"env":"test","module":"mfa-service","userId":"8333b87dc2492db7b9be70ce1c8cb2ed","msg":"TOTP verification successful"}
{"level":30,"time":1768250002214,"env":"test","module":"auth-routes","userId":"8333b87dc2492db7b9be70ce1c8cb2ed","msg":"MFA login successful"}
stderr | tests/integration/auth/oauth2.token-refresh.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: relation "global_recipients" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 115,
  severity: 'ERROR',
  code: '42P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'namespace.c',
  line: '637',
  routine: 'RangeVarGetRelidExtended'
}

{"level":30,"time":1768250002536,"env":"test","module":"user-credentials-repository","userId":"_GE9y0GfPDkYiidlnIQ4P","msg":"User credentials created"}
{"level":50,"time":1768250002542,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250002932,"env":"test","module":"user-credentials-repository","userId":"9oseyOAliAsQXJFeFOdkX","msg":"User credentials created"}
{"level":30,"time":1768250002997,"env":"test","module":"user-credentials-repository","userId":"Oz4rTFyp0lVxRZQRCAsLC","msg":"User credentials created"}
{"level":30,"time":1768250003084,"env":"test","module":"auth-service","tokenHash":"5db795317bf08fd91cb3fdd09dd2467fece83ddede9cc1aecdf52b44cc68e579","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould login with backup code when TOTP unavailable
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250003429,"env":"test","module":"auth-routes","userId":"9oseyOAliAsQXJFeFOdkX","msg":"All other sessions revoked"}
{"level":30,"time":1768250003482,"env":"test","module":"audit-log-service","userId":"9oseyOAliAsQXJFeFOdkX","eventType":"all_sessions_revoked","ipAddress":"::ffff:127.0.0.1","hasMetadata":false,"msg":"Security event logged"}
{"level":30,"time":1768250003635,"env":"test","module":"auth-routes","userId":"056efb6c79edc4fd8a613b0429342821","msg":"User logged in successfully"}
{"level":30,"time":1768250003682,"env":"test","module":"audit-log-service","userId":"056efb6c79edc4fd8a613b0429342821","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250003716,"env":"test","module":"user-credentials-repository","userId":"d0MqfhDya4dNk4uvTo7d5","msg":"User credentials created"}
{"level":30,"time":1768250003776,"env":"test","module":"auth-service","tokenHash":"545e957824542cf31c643340c7b4ef78dbb274c7507bbadc3129f822b2118f56","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250003904,"env":"test","module":"user-credentials-repository","userId":"ykpyxIbq7Vv9R7FqCYA0k","msg":"User credentials created"}
{"level":30,"time":1768250004116,"env":"test","module":"auth-routes","userId":"ykpyxIbq7Vv9R7FqCYA0k","msg":"All other sessions revoked"}
{"level":30,"time":1768250004133,"env":"test","module":"mfa-service","userId":"056efb6c79edc4fd8a613b0429342821","count":10,"msg":"Stored backup codes"}
{"level":30,"time":1768250004133,"env":"test","module":"mfa-service","userId":"056efb6c79edc4fd8a613b0429342821","msg":"Generated TOTP secret"}
{"level":30,"time":1768250004133,"env":"test","module":"auth-routes","userId":"056efb6c79edc4fd8a613b0429342821","msg":"MFA setup initiated"}
{"level":30,"time":1768250004165,"env":"test","module":"audit-log-service","userId":"ykpyxIbq7Vv9R7FqCYA0k","eventType":"all_sessions_revoked","ipAddress":"::ffff:127.0.0.1","hasMetadata":false,"msg":"Security event logged"}
{"level":30,"time":1768250004434,"env":"test","module":"mfa-service","userId":"056efb6c79edc4fd8a613b0429342821","msg":"MFA enabled successfully"}
{"level":30,"time":1768250004434,"env":"test","module":"auth-routes","userId":"056efb6c79edc4fd8a613b0429342821","msg":"MFA enabled successfully"}
{"level":30,"time":1768250004450,"env":"test","module":"user-credentials-repository","userId":"mh6fw8ZyLUhkM8zFn92qh","msg":"User credentials created"}
{"level":30,"time":1768250004479,"env":"test","module":"audit-log-service","userId":"056efb6c79edc4fd8a613b0429342821","eventType":"mfa_enabled","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould login with backup code when TOTP unavailable
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250004554,"env":"test","module":"user-credentials-repository","userId":"StkWt2wjNknKazl92LL1y","msg":"User credentials created"}
{"level":30,"time":1768250004895,"env":"test","module":"user-credentials-repository","userId":"lefloVA-8tkc4Q44gZ48A","msg":"User credentials created"}
{"level":30,"time":1768250004930,"env":"test","module":"user-credentials-repository","userId":"t-7oAaPWY53ZwnwuYld2e","msg":"User credentials created"}
{"level":50,"time":1768250004933,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250004952,"env":"test","module":"auth-service","tokenHash":"2fe6f7ff0fa9bd1ee1eb2b4de4567a52a13546270f31f9607e884393806b0e0c","plainTokenLen":19,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250005003,"env":"test","module":"auth-service","tokenHash":"2fe6f7ff0fa9bd1ee1eb2b4de4567a52a13546270f31f9607e884393806b0e0c","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768250005003,"env":"test","module":"auth-routes","userId":"056efb6c79edc4fd8a613b0429342821","msg":"Login requires MFA verification"}
{"level":30,"time":1768250005108,"env":"test","module":"auth-service","allTokensCount":13,"sampleToken":"6901d860f351943cc44701fe057fa87a8ccf4d4f4b7f9b3bb418d307aaad0e9d","msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768250005216,"env":"test","module":"mfa-service","userId":"056efb6c79edc4fd8a613b0429342821","msg":"Backup code verified and consumed"}
{"level":30,"time":1768250005265,"env":"test","module":"auth-routes","userId":"056efb6c79edc4fd8a613b0429342821","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould login with backup code when TOTP unavailable
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250005286,"env":"test","module":"user-credentials-repository","userId":"P7PoznxpC7z07ME7vIksp","msg":"User credentials created"}
{"level":30,"time":1768250005396,"env":"test","module":"auth-routes","userId":"P7PoznxpC7z07ME7vIksp","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Device marked as trusted"}
{"level":30,"time":1768250005478,"env":"test","module":"user-credentials-repository","userId":"P4fIEsRGHLnPu6IKJE0vS","msg":"User credentials created"}
{"level":30,"time":1768250005600,"env":"test","module":"auth-service","tokenHash":"719d4f34fd9de961e8180db389d381f3f2fb25ec3f7287005acb16280bd0a506","plainTokenLen":17,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250005647,"env":"test","module":"auth-service","tokenHash":"719d4f34fd9de961e8180db389d381f3f2fb25ec3f7287005acb16280bd0a506","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768250005705,"env":"test","module":"auth-service","allTokensCount":14,"sampleToken":"6901d860f351943cc44701fe057fa87a8ccf4d4f4b7f9b3bb418d307aaad0e9d","msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768250005762,"env":"test","module":"auth-routes","userId":"056efb6c79edc4fd8a613b0429342821","msg":"Login requires MFA verification"}
{"level":30,"time":1768250005834,"env":"test","module":"user-credentials-repository","userId":"EJSmINdfC-LrbN6yEhMvr","msg":"User credentials created"}
{"level":30,"time":1768250005943,"env":"test","module":"auth-routes","userId":"EJSmINdfC-LrbN6yEhMvr","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Device marked as trusted"}
{"level":30,"time":1768250006067,"env":"test","module":"user-credentials-repository","userId":"NuOKcdJcwo2tdrLGNZtdm","msg":"User credentials created"}
{"level":30,"time":1768250006100,"env":"test","module":"auth-routes","userId":"EJSmINdfC-LrbN6yEhMvr","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Trusted device expiry updated"}
{"level":30,"time":1768250006168,"env":"test","module":"auth-service","tokenHash":"00a007fd5bccbb8e78d360824ac3768930f173dbc11a991ec9f79e4165de37e0","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250006214,"env":"test","module":"auth-service","userId":"NuOKcdJcwo2tdrLGNZtdm","tokenHash":"00a007fd5bccbb8e78d360824ac3768930f173dbc11a991ec9f79e4165de37e0","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250006579,"env":"test","module":"user-credentials-repository","userId":"TJMoI0Sa2_XESsIgmZ6C_","msg":"User credentials created"}
{"level":30,"time":1768250006690,"env":"test","module":"auth-routes","userId":"TJMoI0Sa2_XESsIgmZ6C_","deviceCount":2,"msg":"Listed trusted devices"}
{"level":30,"time":1768250006755,"env":"test","module":"user-credentials-repository","userId":"0y_1fcdYbZCUPBIXc4Ods","msg":"User credentials created"}
{"level":30,"time":1768250006873,"env":"test","module":"auth-service","tokenHash":"cc445263cd8bd696a546d085df7ee4e10dce7ae0f1c41e14702e8fdf61a18ea4","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250006925,"env":"test","module":"auth-service","tokenHash":"cc445263cd8bd696a546d085df7ee4e10dce7ae0f1c41e14702e8fdf61a18ea4","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768250007021,"env":"test","module":"auth-service","allTokensCount":9,"sampleToken":"00a007fd5bccbb8e78d360824ac3768930f173dbc11a991ec9f79e4165de37e0","msg":"DEBUG: Tokens in DB"}
{"level":40,"time":1768250007153,"env":"test","module":"mfa-service","userId":"056efb6c79edc4fd8a613b0429342821","msg":"Invalid backup code provided"}
{"level":40,"time":1768250007153,"env":"test","module":"auth-routes","userId":"056efb6c79edc4fd8a613b0429342821","msg":"MFA verification failed during login"}
{"level":30,"time":1768250007179,"env":"test","module":"user-credentials-repository","userId":"IWM7qHCJ48cnbtsOEbTmo","msg":"User credentials created"}
{"level":30,"time":1768250007286,"env":"test","module":"auth-routes","userId":"IWM7qHCJ48cnbtsOEbTmo","deviceCount":0,"msg":"Listed trusted devices"}
{"level":30,"time":1768250007470,"env":"test","module":"user-credentials-repository","userId":"3PFLLXhemkItmduOTOWCu","msg":"User credentials created"}
{"level":30,"time":1768250007531,"env":"test","module":"auth-service","tokenHash":"bb206775f85cd4bfaf1abce241e1b435d0adaefa5f633eff173cb6955e616f1f","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250007579,"env":"test","module":"auth-service","tokenHash":"bb206775f85cd4bfaf1abce241e1b435d0adaefa5f633eff173cb6955e616f1f","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768250007630,"env":"test","module":"auth-service","allTokensCount":0,"msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768250007696,"env":"test","module":"user-credentials-repository","userId":"oZan-gJtQQl9QitU7Sk4u","msg":"User credentials created"}
stderr | tests/integration/auth.routes.real.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: relation "global_recipients" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 115,
  severity: 'ERROR',
  code: '42P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'namespace.c',
  line: '637',
  routine: 'RangeVarGetRelidExtended'
}

{"level":30,"time":1768250008224,"env":"test","module":"email-queue","jobId":"e3be09ca-cd05-4cca-b5b2-be93999d6ae1","to":"test-1768250007597-k1n2ke@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250008225,"env":"test","module":"auth-service","email":"test-1768250007597-k1n2ke@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768250008247,"env":"test","module":"user-credentials-repository","userId":"_coibS1DJfYjQSjjLuA9o","msg":"User credentials created"}
{"level":30,"time":1768250008282,"env":"test","module":"user-credentials-repository","userId":"MRs7W-PAQWrNKP2wW22mD","msg":"User credentials created"}
{"level":30,"time":1768250008306,"env":"test","module":"auth-service","tokenHash":"4c8593fc09ad18a96fa495bdde9cf49e72e8306da1f7e8970830985b451b712e","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250008307,"env":"test","module":"auth-service","tokenHash":"4c8593fc09ad18a96fa495bdde9cf49e72e8306da1f7e8970830985b451b712e","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250008536,"env":"test","module":"email-queue","jobId":"8a04ba17-6bfd-4cba-9985-31dc3a99b13b","to":"test-1768250007597-k1n2ke@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250008536,"env":"test","module":"auth-service","email":"test-1768250007597-k1n2ke@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768250008692,"env":"test","module":"user-credentials-repository","userId":"6Jj38SACTstGZVU8bDEoE","msg":"User credentials created"}
{"level":40,"time":1768250008696,"env":"test","module":"auth-service","tokenHash":"4c8593fc09ad18a96fa495bdde9cf49e72e8306da1f7e8970830985b451b712e","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768250008750,"env":"test","module":"auth-service","allTokensCount":2,"sampleToken":"7e554d08d357b5cb4c60a46e303012fdda0237b0b47b7956a4d71721e7453063","msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768250008877,"env":"test","module":"user-credentials-repository","userId":"b41f1d69-0bae-408d-b3c7-d9ec58df79b5","msg":"User credentials created"}
{"level":50,"time":1768250008972,"env":"test","module":"user-credentials-repository","error":{},"userId":"38cad927f60f4bd37a4da7448611aba9","msg":"Failed to update user password"}
{"level":50,"time":1768250008972,"env":"test","module":"auth-routes","error":{},"msg":"Reset password error"}
{"level":30,"time":1768250008982,"env":"test","module":"email-queue","jobId":"dc9ebdae-e63b-43f8-8f17-e83168e14b3e","to":"test-1768250008371-sen9hw@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250009039,"env":"test","module":"auth-routes","userId":"b41f1d69-0bae-408d-b3c7-d9ec58df79b5","email":"test-1768250008371-sen9hw@example.com","msg":"User registered"}
{"level":30,"time":1768250009196,"env":"test","module":"user-credentials-repository","userId":"xz4x_euM_UU6Bih_qHOiD","msg":"User credentials created"}
{"level":30,"time":1768250009201,"env":"test","module":"user-credentials-repository","userId":"sLzm7cLExbq1tM16MwLs-","msg":"User credentials created"}
{"level":30,"time":1768250009255,"env":"test","module":"auth-service","tokenHash":"5a2d26575072ce9596f86f03f865a06cd2c7fa175f07f92299c2347bcb8b6e44","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250009304,"env":"test","module":"auth-service","tokenHash":"5a2d26575072ce9596f86f03f865a06cd2c7fa175f07f92299c2347bcb8b6e44","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768250009646,"env":"test","module":"user-credentials-repository","userId":"I4hyH2Hq3HM4kIniry-ap","msg":"User credentials created"}
{"level":30,"time":1768250009679,"env":"test","module":"user-credentials-repository","userId":"UOfCVs-bfKJveMtYe-zUr","msg":"User credentials created"}
{"level":30,"time":1768250009740,"env":"test","module":"auth-service","tokenHash":"2fd8411fd4090c259d9fcfb74c9e0a8239970093ca445d7c8462066da41429a8","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mPassword Reset Flow[2m > [22m[2mshould invalidate all sessions after password reset
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768250009834,"env":"test","module":"auth-service","userId":"UOfCVs-bfKJveMtYe-zUr","tokenHash":"2fd8411fd4090c259d9fcfb74c9e0a8239970093ca445d7c8462066da41429a8","msg":"Security: REUSED REFRESH TOKEN DETECTED (Concurrent). Revoking all sessions."}
{"level":30,"time":1768250009852,"env":"test","module":"auth-service","tokenHash":"19b44d661fe8da7a508d17944fedfd02e133e28c910afb62fd4957035531832d","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250009904,"env":"test","module":"auth-service","tokenHash":"19b44d661fe8da7a508d17944fedfd02e133e28c910afb62fd4957035531832d","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":50,"time":1768250009945,"env":"test","module":"auth-routes","userId":"97bbf1eeecc18846379ea9f7ea726747","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250009955,"env":"test","module":"auth-service","allTokensCount":1,"sampleToken":"d4ef2c99f43b27b0de5c0ee12669b52ca57143953321a4c49f898438086caf5b","msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768250010013,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250010013,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768250010045,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Password Reset Flow > should invalidate all sessions after password reset
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250010254,"env":"test","module":"email-queue","jobId":"1cc6554b-b875-4a85-92f8-bb08477cb6f3","to":"test-1768250009378-n88dj6@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250010254,"env":"test","module":"auth-service","email":"test-1768250009378-n88dj6@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768250010281,"env":"test","module":"user-credentials-repository","userId":"E3RaDJGWc7qWMiwiWmDAy","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w7_122761a6

{"level":30,"time":1768250010335,"env":"test","module":"auth-service","tokenHash":"299ec95dd330694c334bb2d1ecc09a0b256f5e0abaa1aab7e0e71589b03a13e0","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250010386,"env":"test","module":"auth-service","tokenHash":"299ec95dd330694c334bb2d1ecc09a0b256f5e0abaa1aab7e0e71589b03a13e0","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768250010434,"env":"test","module":"auth-service","allTokensCount":0,"msg":"DEBUG: Tokens in DB"}
 [31mÎ“Â¥Â»[39m tests/integration/auth/oauth2.sessions.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m3 failed[39m[2m)[22m[33m 45155[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should list all active sessions for current user [33m 511[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should mark current session as current [33m 423[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return empty array when user has no active sessions [33m 425[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not include expired sessions [33m 422[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not include revoked sessions [33m 478[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should parse device name from user agent [33m 421[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for unauthenticated request [33m 323[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke a specific session [33m 609[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 404 for non-existent session [33m 324[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prevent revoking current session [33m 478[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prevent revoking another user's session [33m 590[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for unauthenticated request [33m 389[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke all sessions except current [33m 988[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke all trusted devices [33m 682[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 400 when no active session found [33m 346[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for unauthenticated request [33m 374[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should mark current device as trusted [33m 515[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should update existing trusted device expiry [33m 709[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should list all trusted devices [33m 533[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should not include revoked devices [33m 595[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should revoke a trusted device[39m[33m 521[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should return 404 for non-existent device [33m 480[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should track IP address for sessions [33m 511[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should track user agent for sessions[39m[33m 500[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update lastUsedAt on token refresh[39m[33m 712[2mms[22m[39m
{"level":50,"time":1768250010691,"env":"test","module":"user-credentials-repository","error":{},"userId":"97bbf1eeecc18846379ea9f7ea726747","msg":"Failed to update user password"}
{"level":50,"time":1768250010691,"env":"test","module":"auth-routes","error":{},"msg":"Reset password error"}
{"level":50,"time":1768250010698,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250010861,"env":"test","module":"user-credentials-repository","userId":"HeqW8rlclqP5nuwUo-IM6","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22m[2mOAuth2 Token Refresh Flow[2m > [22m[2mRefresh Token Lifecycle[2m > [22m[2mshould create refresh token on login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250011096,"env":"test","module":"auth-routes","userId":"HeqW8rlclqP5nuwUo-IM6","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250011211,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > Refresh Token Lifecycle > should create refresh token on login
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250011580,"env":"test","module":"user-credentials-repository","userId":"lYfQbYRCcSClMr3VD4CR-","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould rotate refresh token on each use
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250011750,"env":"test","module":"auth-routes","userId":"c799dfb0f320716370a995a93e8b23b4","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250011842,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Token Refresh Flow > should rotate refresh token on each use
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250012053,"env":"test","module":"user-credentials-repository","userId":"1f3ae43b-2fc0-4669-9016-e4284dcf0706","msg":"User credentials created"}
{"level":30,"time":1768250012132,"env":"test","module":"user-credentials-repository","userId":"d4K1toHdbVfHKtikXpl--","msg":"User credentials created"}
{"level":30,"time":1768250012164,"env":"test","module":"email-queue","jobId":"6146fe50-57a8-43ab-aad7-9ea2e4151ae6","to":"test-1768250011584-crm9iq@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250012218,"env":"test","module":"auth-routes","userId":"1f3ae43b-2fc0-4669-9016-e4284dcf0706","email":"test-1768250011584-crm9iq@example.com","msg":"User registered"}
{"level":30,"time":1768250012578,"env":"test","module":"user-credentials-repository","userId":"s-MCZJAYsbQh0YatGJYwE","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould detect and prevent refresh token reuse (token theft)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250012802,"env":"test","module":"auth-routes","userId":"8f5fc120c277116ce7ef6f39eb0b678f","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250012903,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Token Refresh Flow > should detect and prevent refresh token reuse (token theft)
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250013131,"env":"test","module":"user-credentials-repository","userId":"GyA2DGfT45V30v8mtEMng","msg":"User credentials created"}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: relation "global_recipients" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 115,
  severity: 'ERROR',
  code: '42P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'namespace.c',
  line: '637',
  routine: 'RangeVarGetRelidExtended'
}

{"level":30,"time":1768250013339,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39m[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768250013360,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768250013349,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768250013349,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768250013355,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768250013359,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768250013359,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768250013360,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768250013360,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768250013538,"env":"test","module":"user-credentials-repository","userId":"3a6b87bd-9399-4d08-9bbb-6c2f800a221b","msg":"User credentials created"}
{"level":30,"time":1768250013633,"env":"test","module":"email-queue","jobId":"d2474145-7d97-4497-a65b-1421f80c09b7","to":"test-1768250013106-4zbew@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250013684,"env":"test","module":"auth-routes","userId":"3a6b87bd-9399-4d08-9bbb-6c2f800a221b","email":"test-1768250013106-4zbew@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250013751,"env":"test","module":"user-credentials-repository","userId":"iiR-mfbGchQ5dxqm1gf8L","msg":"User credentials created"}
{"level":50,"time":1768250013887,"env":"test","module":"auth-routes","userId":"6bd0d21d6d3e53344d8bd5eb7ddf3bfa","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250013901,"env":"test","module":"user-credentials-repository","userId":"925f1776-ccf1-4a5a-9829-47f0e8f8dfa8","msg":"User credentials created"}
{"level":50,"time":1768250013996,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Session Management Flow > should list all active sessions
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250014004,"env":"test","module":"email-queue","jobId":"ceb66af0-7693-4ebe-8d6d-536017028e42","to":"test-MSnO2MR6Fy7Q2Vyrx9slG@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250014061,"env":"test","module":"auth-routes","userId":"925f1776-ccf1-4a5a-9829-47f0e8f8dfa8","email":"test-MSnO2MR6Fy7Q2Vyrx9slG@example.com","msg":"User registered"}
{"level":50,"time":1768250014157,"env":"test","module":"auth-routes","userId":"6bd0d21d6d3e53344d8bd5eb7ddf3bfa","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250014261,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Session Management Flow > should list all active sessions
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250014267,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250014774,"env":"test","module":"user-credentials-repository","userId":"ee3b1601-d93f-45d0-91f3-2a0520e870ec","msg":"User credentials created"}
{"level":30,"time":1768250014870,"env":"test","module":"email-queue","jobId":"8767280c-4b45-41f4-b4a9-f620b65cffd3","to":"protected-test-UoLyPkKrsoKsBzJENy_uc@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250014921,"env":"test","module":"auth-routes","userId":"ee3b1601-d93f-45d0-91f3-2a0520e870ec","email":"protected-test-UoLyPkKrsoKsBzJENy_uc@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould login with valid credentials
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould allow access with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250015083,"env":"test","module":"auth-routes","userId":"eb73c60398932a6716e2b10f518fa592","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250015168,"env":"test","module":"auth-routes","userId":"ee3b1601-d93f-45d0-91f3-2a0520e870ec","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250015180,"env":"test","module":"auth-routes","userId":"17e729f70b2a54a99824110cc75a8173","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250015182,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should login with valid credentials
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250015272,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250015284,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Session Management Flow > should revoke specific session
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250015443,"env":"test","module":"auth-routes","userId":"17e729f70b2a54a99824110cc75a8173","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250015540,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Session Management Flow > should revoke specific session
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250015545,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250015547,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250015547,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768250015663,"env":"test","module":"user-credentials-repository","userId":"4832d419-fd4b-4d23-a1cf-a4c443ef9d14","msg":"User credentials created"}
{"level":30,"time":1768250015762,"env":"test","module":"email-queue","jobId":"6c5cef1b-5dc0-44ee-975d-e937b8015e96","to":"protected-test-EGJzicKdfIIHfkoRUfnE2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250015810,"env":"test","module":"auth-routes","userId":"4832d419-fd4b-4d23-a1cf-a4c443ef9d14","email":"protected-test-EGJzicKdfIIHfkoRUfnE2@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w3_9c566755

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould reject access without Authorization header
[22m[39mDEBUG: LOGIN HANDLER HIT

 [31mÎ“Â¥Â»[39m tests/integration/auth.flows.real.test.ts [2m([22m[2m11 tests[22m[2m | [22m[31m5 failed[39m[2m)[22m[33m 50604[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should complete registration, verify email, then login [33m 1888[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should lock account after 5 failed attempts, then unlock after waiting [33m 3462[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should record all login attempts [33m 2244[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should complete MFA setup and login with TOTP [33m 2763[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should login with backup code when TOTP unavailable [33m 4968[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should complete full password reset flow[39m[33m 1791[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should invalidate all sessions after password reset [33m 1820[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should rotate refresh token on each use[39m[33m 1043[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should detect and prevent refresh token reuse (token theft)[39m[33m 1060[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all active sessions[39m[33m 1363[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific session[39m[33m 1277[2mms[22m[39m
{"level":50,"time":1768250016061,"env":"test","module":"auth-routes","userId":"4832d419-fd4b-4d23-a1cf-a4c443ef9d14","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250016156,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for invalid password
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250016533,"env":"test","module":"auth-routes","userId":"56f4d26ad9d07918e2f6d68807bc1737","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250016584,"env":"test","module":"user-credentials-repository","userId":"5064af6a-9fe5-425f-8835-2fa218c57228","msg":"User credentials created"}
{"level":50,"time":1768250016634,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should return 401 for invalid password
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250016682,"env":"test","module":"email-queue","jobId":"11a45d74-9c63-4a4e-a76f-5f48f42f0752","to":"protected-test-tTU56yw7ru2AWN9FIVXEN@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250016730,"env":"test","module":"auth-routes","userId":"5064af6a-9fe5-425f-8835-2fa218c57228","email":"protected-test-tTU56yw7ru2AWN9FIVXEN@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould reject access with empty Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250016983,"env":"test","module":"auth-routes","userId":"5064af6a-9fe5-425f-8835-2fa218c57228","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250017081,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with empty Bearer token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for non-existent user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250017495,"env":"test","module":"user-credentials-repository","userId":"6bf44e7e-102e-46e5-bc9c-be84127a1d38","msg":"User credentials created"}
{"level":50,"time":1768250017495,"env":"test","module":"auth-routes","email":"nonexistent@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":30,"time":1768250017592,"env":"test","module":"email-queue","jobId":"0e13936c-59a5-42e4-9f69-66e995e5e910","to":"protected-test--BcLUTmaIvLVTwo4vIWzT@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768250017593,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should return 401 for non-existent user
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:51:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250017646,"env":"test","module":"auth-routes","userId":"6bf44e7e-102e-46e5-bc9c-be84127a1d38","email":"protected-test--BcLUTmaIvLVTwo4vIWzT@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould reject access with malformed Authorization header
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250017896,"env":"test","module":"auth-routes","userId":"6bf44e7e-102e-46e5-bc9c-be84127a1d38","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250017996,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with malformed Authorization header
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250018381,"env":"test","module":"user-credentials-repository","userId":"930bedc7-54d6-4d1e-ba75-7b20b7bcdee8","msg":"User credentials created"}
{"level":30,"time":1768250018483,"env":"test","module":"email-queue","jobId":"0ea1fa75-1ea9-439c-b353-924ba7de2c88","to":"protected-test-GC0VWNcl2Ylaxh_1DoTGt@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250018530,"env":"test","module":"auth-routes","userId":"930bedc7-54d6-4d1e-ba75-7b20b7bcdee8","email":"protected-test-GC0VWNcl2Ylaxh_1DoTGt@example.com","msg":"User registered"}
stderr | tests/integration/auth/jwt.authentication.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: relation "global_recipients" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 115,
  severity: 'ERROR',
  code: '42P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'namespace.c',
  line: '637',
  routine: 'RangeVarGetRelidExtended'
}

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould reject access with wrong token type
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250018728,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768250018745,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39m[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768250018737,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768250018737,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768250018741,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768250018745,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768250018745,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768250018745,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768250018745,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":50,"time":1768250018780,"env":"test","module":"auth-routes","userId":"930bedc7-54d6-4d1e-ba75-7b20b7bcdee8","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250018783,"env":"test","module":"user-credentials-repository","userId":"639a5f60-2071-4416-9a31-f22a108f43f1","msg":"User credentials created"}
{"level":50,"time":1768250018872,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250018885,"env":"test","module":"email-queue","jobId":"19bba859-4cd1-449f-a057-aea2651f8ebe","to":"test-1768250018394-f8k3t@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250018937,"env":"test","module":"auth-routes","userId":"639a5f60-2071-4416-9a31-f22a108f43f1","email":"test-1768250018394-f8k3t@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 403 for unverified email
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250019088,"env":"test","module":"auth-routes","userId":"639a5f60-2071-4416-9a31-f22a108f43f1","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250019187,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should return 403 for unverified email
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250019222,"env":"test","module":"user-credentials-repository","userId":"75245955-2175-423e-9b51-0dc4795948cd","msg":"User credentials created"}
{"level":30,"time":1768250019262,"env":"test","module":"user-credentials-repository","userId":"d5df610a-679f-4754-9d81-1530c7eabe19","msg":"User credentials created"}
{"level":30,"time":1768250019308,"env":"test","module":"user-credentials-repository","userId":"J7blIGDtSmMm1GndhgRhG","msg":"User credentials created"}
{"level":30,"time":1768250019320,"env":"test","module":"email-queue","jobId":"937e4a72-34b9-4310-8a4d-ef57d22b7a03","to":"test-gTUrN47dHJkTsKutE0UUC@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250019364,"env":"test","module":"email-queue","jobId":"df759684-63e2-4d20-b095-f229da8c2683","to":"protected-test-O-nQXpzwFpOrMoh6zGZNm@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250019369,"env":"test","module":"auth-routes","userId":"75245955-2175-423e-9b51-0dc4795948cd","email":"test-gTUrN47dHJkTsKutE0UUC@example.com","msg":"User registered"}
{"level":30,"time":1768250019415,"env":"test","module":"auth-routes","userId":"d5df610a-679f-4754-9d81-1530c7eabe19","email":"protected-test-O-nQXpzwFpOrMoh6zGZNm@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPOST Protected Routes[2m > [22m[2mshould allow POST with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250019661,"env":"test","module":"auth-routes","userId":"d5df610a-679f-4754-9d81-1530c7eabe19","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250019763,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250019799,"env":"test","module":"user-credentials-repository","userId":"YYf86BLC49cTTyveNl505","msg":"User credentials created"}
{"level":30,"time":1768250019855,"env":"test","module":"auth-service","tokenHash":"d635a073c23225e97eab39f52fa79edb3ae13c779e4e127f96805c3e91a63319","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250019902,"env":"test","module":"auth-service","tokenHash":"d635a073c23225e97eab39f52fa79edb3ae13c779e4e127f96805c3e91a63319","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768250019958,"env":"test","module":"auth-service","allTokensCount":1,"sampleToken":"fdc29f7fef1b91ff7a3158db7728650e2be18ed0b82ce3c088185bc86916d321","msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768250020016,"env":"test","module":"user-credentials-repository","userId":"ee7fe4a4-bb87-4e5f-9dab-d51608528241","msg":"User credentials created"}
{"level":30,"time":1768250020117,"env":"test","module":"email-queue","jobId":"9f5eb53f-4c6c-40c3-9fd6-ccca397fa1b7","to":"jwt-test-BlIU0K2OuhH-Df02Uc_kR@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250020142,"env":"test","module":"user-credentials-repository","userId":"aede8cc1-33a8-4081-823f-a67be8e3afb3","msg":"User credentials created"}
{"level":30,"time":1768250020165,"env":"test","module":"auth-routes","userId":"ee7fe4a4-bb87-4e5f-9dab-d51608528241","email":"jwt-test-BlIU0K2OuhH-Df02Uc_kR@example.com","msg":"User registered"}
{"level":30,"time":1768250020246,"env":"test","module":"email-queue","jobId":"10940a58-94bc-4883-9f3a-fecc4cd02514","to":"protected-test-2QtuMqb3u84pOGZY1A4FI@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Generation[2m > [22m[2mshould generate valid JWT token on successful login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250020297,"env":"test","module":"auth-routes","userId":"aede8cc1-33a8-4081-823f-a67be8e3afb3","email":"protected-test-2QtuMqb3u84pOGZY1A4FI@example.com","msg":"User registered"}
{"level":30,"time":1768250020337,"env":"test","module":"user-credentials-repository","userId":"QC7W6209yYZm0FjGqgaih","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPOST Protected Routes[2m > [22m[2mshould reject POST without Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould record failed login attempt
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250020428,"env":"test","module":"auth-routes","userId":"ee7fe4a4-bb87-4e5f-9dab-d51608528241","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250020533,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > JWT Token Generation > should generate valid JWT token on successful login
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250020544,"env":"test","module":"auth-routes","userId":"aede8cc1-33a8-4081-823f-a67be8e3afb3","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250020560,"env":"test","module":"auth-routes","userId":"887e00f57774db5323e667910af8ca29","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250020651,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250020660,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should record failed login attempt
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250020821,"env":"test","module":"user-credentials-repository","userId":"QgicQVA2CHNZoEDnGK2Za","msg":"User credentials created"}
{"level":30,"time":1768250020879,"env":"test","module":"auth-service","tokenHash":"452b9bb5ceeabb2e81da37a532a78c54880ea3bad4056e29affdd0a10afbb017","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250020931,"env":"test","module":"user-credentials-repository","userId":"663ba9ea-d25f-45ec-a15a-439c061188be","msg":"User credentials created"}
{"level":40,"time":1768250020981,"env":"test","module":"auth-service","userId":"QgicQVA2CHNZoEDnGK2Za","tokenHash":"452b9bb5ceeabb2e81da37a532a78c54880ea3bad4056e29affdd0a10afbb017","msg":"Security: REUSED REFRESH TOKEN DETECTED (Concurrent). Revoking all sessions."}
{"level":30,"time":1768250021027,"env":"test","module":"email-queue","jobId":"bc776693-5217-43a3-9873-3cad6b55c930","to":"jwt-test-ad4hneUshAPHkgO7H39eX@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250021039,"env":"test","module":"user-credentials-repository","userId":"3e457a86-440c-4ae4-9f47-14507aab8f62","msg":"User credentials created"}
{"level":30,"time":1768250021080,"env":"test","module":"auth-routes","userId":"663ba9ea-d25f-45ec-a15a-439c061188be","email":"jwt-test-ad4hneUshAPHkgO7H39eX@example.com","msg":"User registered"}
{"level":30,"time":1768250021133,"env":"test","module":"email-queue","jobId":"1b823e40-ac8d-4b53-95bc-dfe4434cb875","to":"protected-test-aI3AyF4T-qz_aYZUywwLk@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Generation[2m > [22m[2mshould include correct payload in JWT token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250021184,"env":"test","module":"auth-routes","userId":"3e457a86-440c-4ae4-9f47-14507aab8f62","email":"protected-test-aI3AyF4T-qz_aYZUywwLk@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPOST Protected Routes[2m > [22m[2mshould reject POST with invalid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250021290,"env":"test","module":"auth-routes","userId":"663ba9ea-d25f-45ec-a15a-439c061188be","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250021355,"env":"test","module":"user-credentials-repository","userId":"3AxSxsWVpnPVlTXusI6Xa","msg":"User credentials created"}
{"level":50,"time":1768250021392,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > JWT Token Generation > should include correct payload in JWT token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250021410,"env":"test","module":"auth-service","tokenHash":"d93e6550244ac774619e0b5931996dd99e3f225f0cfe41d8cd2db41e17ecc108","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768250021426,"env":"test","module":"auth-routes","userId":"3e457a86-440c-4ae4-9f47-14507aab8f62","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250021522,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250021797,"env":"test","module":"user-credentials-repository","userId":"002c9baf-eb09-4189-a95f-c23285fc9c94","msg":"User credentials created"}
{"level":30,"time":1768250021899,"env":"test","module":"email-queue","jobId":"99ae4924-5fae-4491-9620-6f4f3f99484c","to":"jwt-test-0cOowvAy6NMyR23sIjE2V@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250021916,"env":"test","module":"user-credentials-repository","userId":"9c51dc2e-6d82-4423-80c8-d7bf4456e68d","msg":"User credentials created"}
{"level":30,"time":1768250021946,"env":"test","module":"auth-routes","userId":"002c9baf-eb09-4189-a95f-c23285fc9c94","email":"jwt-test-0cOowvAy6NMyR23sIjE2V@example.com","msg":"User registered"}
{"level":30,"time":1768250021962,"env":"test","module":"user-credentials-repository","userId":"38oZdtFwPPAxBycYfOaw3","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Generation[2m > [22m[2mshould set JWT expiry to 15 minutes
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return requiresMfa=true for MFA-enabled users
[22m[39m[TEST UTILS] MFA Secret verified for e0d9b217acbf1ed11d2962842fc63c11

{"level":30,"time":1768250022015,"env":"test","module":"email-queue","jobId":"08bdc4f2-d4c7-4de5-bb05-9bb9e645728a","to":"protected-test-jK2rQk3wgp_5KeW--AGqU@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250022016,"env":"test","module":"auth-service","tokenHash":"6920f38c392826dfb47664e542d659c6ea59d383bd0cd53d20fe07ffa1523dac","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250022064,"env":"test","module":"auth-routes","userId":"9c51dc2e-6d82-4423-80c8-d7bf4456e68d","email":"protected-test-jK2rQk3wgp_5KeW--AGqU@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPUT Protected Routes[2m > [22m[2mshould allow PUT with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return requiresMfa=true for MFA-enabled users
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250022495,"env":"test","module":"auth-routes","userId":"e0d9b217acbf1ed11d2962842fc63c11","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250022527,"env":"test","module":"auth-routes","userId":"002c9baf-eb09-4189-a95f-c23285fc9c94","msg":"User logged in successfully"}
{"level":30,"time":1768250022573,"env":"test","module":"user-credentials-repository","userId":"FVNRHbWP6jr3ecVWw5Zvj","msg":"User credentials created"}
{"level":30,"time":1768250022578,"env":"test","module":"audit-log-service","userId":"002c9baf-eb09-4189-a95f-c23285fc9c94","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250022597,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should return requiresMfa=true for MFA-enabled users
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250022626,"env":"test","module":"auth-service","tokenHash":"0a723de90b8b3c2240a4ad2ea83a9adac33115c60b19d725920d1fd989e9f8b6","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250022697,"env":"test","module":"auth-routes","userId":"9c51dc2e-6d82-4423-80c8-d7bf4456e68d","msg":"User logged in successfully"}
{"level":40,"time":1768250022733,"env":"test","module":"auth-service","userId":"FVNRHbWP6jr3ecVWw5Zvj","tokenHash":"0a723de90b8b3c2240a4ad2ea83a9adac33115c60b19d725920d1fd989e9f8b6","msg":"Security: REUSED REFRESH TOKEN DETECTED (Concurrent). Revoking all sessions."}
{"level":30,"time":1768250022753,"env":"test","module":"audit-log-service","userId":"9c51dc2e-6d82-4423-80c8-d7bf4456e68d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250022977,"env":"test","module":"user-credentials-repository","userId":"9e3b1cc2-ef14-46b3-923e-3b26bec3b29e","msg":"User credentials created"}
{"level":30,"time":1768250023055,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250023055,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768250023076,"env":"test","module":"email-queue","jobId":"45c63542-1d64-4377-bea3-6971d2a004ec","to":"jwt-test-eybF9KZRh9dSngYIEs7tq@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250023131,"env":"test","module":"auth-routes","userId":"9e3b1cc2-ef14-46b3-923e-3b26bec3b29e","email":"jwt-test-eybF9KZRh9dSngYIEs7tq@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Validation[2m > [22m[2mshould accept valid JWT token on protected routes
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250023337,"env":"test","module":"auth-routes","userId":"9e3b1cc2-ef14-46b3-923e-3b26bec3b29e","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w6_6247497e

{"level":30,"time":1768250023376,"env":"test","module":"user-credentials-repository","userId":"8fb6db9f-beb9-4bea-99cd-cd09e30b4e11","msg":"User credentials created"}
{"level":50,"time":1768250023439,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > JWT Token Validation > should accept valid JWT token on protected routes
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250023448,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768250023454,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
 [31mÎ“Â¥Â»[39m tests/integration/auth/oauth2.token-refresh.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m8 failed[39m[2m)[22m[33m 58010[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should refresh access token with valid refresh token [33m 747[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should rotate refresh token after use [33m 772[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 when refresh token is missing [33m 404[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for invalid refresh token [33m 604[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for expired refresh token [33m 596[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for revoked refresh token [33m 562[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 when user is not found [33m 754[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update refresh token metadata on rotation[39m[33m 615[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle concurrent refresh token requests (token reuse detection) [33m 1115[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set secure cookie in production[39m[33m 556[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set proper cookie attributes[39m[33m 578[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should include user role information in response[39m[33m 551[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should create refresh token on login[39m[33m 782[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke refresh token on logout [33m 515[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle logout without refresh token gracefully [33m 454[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should support multiple active refresh tokens per user[39m[33m 591[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke all user tokens on password reset [33m 609[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should use cryptographically strong random tokens [33m 5577[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should hash refresh tokens before storing in database [33m 500[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent refresh token reuse after rotation[39m[33m 493[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should validate token ownership [33m 536[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set HttpOnly flag to prevent XSS [33m 535[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set SameSite=Strict to prevent CSRF [33m 588[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set proper cookie path [33m 600[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set appropriate expiry (30 days)[39m[33m 567[2mms[22m[39m
{"level":30,"time":1768250023480,"env":"test","module":"email-queue","jobId":"7bde297d-8a0e-49c1-a96e-47b82fa77acd","to":"protected-test-TlpcrDeAlUBCGBlLZ9yj0@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250023531,"env":"test","module":"auth-routes","userId":"8fb6db9f-beb9-4bea-99cd-cd09e30b4e11","email":"protected-test-TlpcrDeAlUBCGBlLZ9yj0@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPUT Protected Routes[2m > [22m[2mshould reject PUT without Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250023780,"env":"test","module":"auth-routes","userId":"8fb6db9f-beb9-4bea-99cd-cd09e30b4e11","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250023855,"env":"test","module":"user-credentials-repository","userId":"b951b587-0324-45c2-b995-a9ca74da37d6","msg":"User credentials created"}
{"level":50,"time":1768250023881,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should reject PUT without Bearer token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250023957,"env":"test","module":"email-queue","jobId":"f1954dca-2806-4153-9da6-a155a029567a","to":"jwt-test-xoaq3G4F8pyGV1NNNPdFj@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768250023988,"env":"test","module":"auth-routes","userId":"49cd707a596fac9215dd6abff79333be","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250024007,"env":"test","module":"auth-routes","userId":"b951b587-0324-45c2-b995-a9ca74da37d6","email":"jwt-test-xoaq3G4F8pyGV1NNNPdFj@example.com","msg":"User registered"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: relation "global_recipients" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 115,
  severity: 'ERROR',
  code: '42P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'namespace.c',
  line: '637',
  routine: 'RangeVarGetRelidExtended'
}

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Validation[2m > [22m[2mshould accept request with missing Bearer prefix (lenient)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250024089,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250024202,"env":"test","module":"auth-routes","userId":"b951b587-0324-45c2-b995-a9ca74da37d6","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250024240,"env":"test","module":"auth-routes","userId":"49cd707a596fac9215dd6abff79333be","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250024264,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768250024279,"env":"test","module":"user-credentials-repository","userId":"2463930a-7048-4ba6-a681-dd4ece7a962b","msg":"User credentials created"}
{"level":30,"time":1768250024281,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests
[22m[39m[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768250024271,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768250024272,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768250024275,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768250024281,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768250024281,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768250024281,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768250024281,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":50,"time":1768250024297,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > JWT Token Validation > should accept request with missing Bearer prefix (lenient)
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768250024302,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250024302,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768250024344,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250024386,"env":"test","module":"email-queue","jobId":"33879f3a-2091-46c0-9ef1-0ed2d9007a2f","to":"protected-test-gP7XIH-U4FcSRwPIP8CQ5@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250024434,"env":"test","module":"auth-routes","userId":"2463930a-7048-4ba6-a681-dd4ece7a962b","email":"protected-test-gP7XIH-U4FcSRwPIP8CQ5@example.com","msg":"User registered"}
{"level":50,"time":1768250024500,"env":"test","module":"auth-routes","userId":"49cd707a596fac9215dd6abff79333be","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mDELETE Protected Routes[2m > [22m[2mshould allow DELETE with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250024604,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250024687,"env":"test","module":"auth-routes","userId":"2463930a-7048-4ba6-a681-dd4ece7a962b","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250024761,"env":"test","module":"auth-routes","userId":"49cd707a596fac9215dd6abff79333be","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250024760,"env":"test","module":"user-credentials-repository","userId":"f0637451-efdc-4a50-9279-a59cd104522e","msg":"User credentials created"}
{"level":50,"time":1768250024777,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should allow DELETE with valid Bearer token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250024867,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768250024868,"env":"test","module":"email-queue","jobId":"6692f99c-c04b-4f9a-b94d-07ee175f0afb","to":"test-nJug3lODIcEgulQgH2lQF@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250024926,"env":"test","module":"auth-routes","userId":"f0637451-efdc-4a50-9279-a59cd104522e","email":"test-nJug3lODIcEgulQgH2lQF@example.com","msg":"User registered"}
{"level":50,"time":1768250025029,"env":"test","module":"auth-routes","userId":"49cd707a596fac9215dd6abff79333be","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250025129,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250025162,"env":"test","module":"user-credentials-repository","userId":"3db014d5-5f7b-4b0b-8422-c2dd2e0e5042","msg":"User credentials created"}
{"level":30,"time":1768250025258,"env":"test","module":"email-queue","jobId":"9936a1a8-fb32-4e94-a127-7b38e24a990c","to":"protected-test-Rr6-wVvJbpcunzQrYrmqW@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768250025291,"env":"test","module":"auth-routes","userId":"49cd707a596fac9215dd6abff79333be","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250025307,"env":"test","module":"auth-routes","userId":"3db014d5-5f7b-4b0b-8422-c2dd2e0e5042","email":"protected-test-Rr6-wVvJbpcunzQrYrmqW@example.com","msg":"User registered"}
{"level":50,"time":1768250025391,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768250025406,"env":"test","module":"auth-middleware","error":{"name":"TokenExpiredError","code":"AUTH_002","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250025406,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mDELETE Protected Routes[2m > [22m[2mshould reject DELETE without Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250025560,"env":"test","module":"auth-routes","userId":"3db014d5-5f7b-4b0b-8422-c2dd2e0e5042","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250025599,"env":"test","module":"user-credentials-repository","userId":"45fa0115-efd6-4da8-bfe9-24a35b8debff","msg":"User credentials created"}
{"level":50,"time":1768250025656,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should reject DELETE without Bearer token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250025697,"env":"test","module":"email-queue","jobId":"e0e6bf65-97ee-495d-ada2-3cc24b7f7543","to":"middleware-test-NP_c-KNmYT3xTFmCKRlOT@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250025748,"env":"test","module":"auth-routes","userId":"45fa0115-efd6-4da8-bfe9-24a35b8debff","email":"middleware-test-NP_c-KNmYT3xTFmCKRlOT@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould allow access with valid JWT Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250025957,"env":"test","module":"auth-routes","userId":"45fa0115-efd6-4da8-bfe9-24a35b8debff","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250026057,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should allow access with valid JWT Bearer token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should allow access with valid JWT Bearer token
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:33:46.060Z'
  }
}

{"level":30,"time":1768250026103,"env":"test","module":"user-credentials-repository","userId":"25276682-ea12-4b3c-ac30-40fa4af6c2d5","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould allow access with valid JWT Bearer token
[22m[39mUser in DB: {
  id: [32m'45fa0115-efd6-4da8-bfe9-24a35b8debff'[39m,
  email: [32m'middleware-test-NP_c-KNmYT3xTFmCKRlOT@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:33:48.482Z[39m,
  updatedAt: [35m2026-01-12T20:33:48.482Z[39m
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould allow access with valid JWT Bearer token
[22m[39mCreds in DB: [90mundefined[39m

{"level":30,"time":1768250026226,"env":"test","module":"email-queue","jobId":"780cf1a0-9a66-4f94-aa5e-26cf8784fe11","to":"protected-test-G1Y8Cn2R7ATaGGwblhaqO@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250026273,"env":"test","module":"auth-routes","userId":"25276682-ea12-4b3c-ac30-40fa4af6c2d5","email":"protected-test-G1Y8Cn2R7ATaGGwblhaqO@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPATCH Protected Routes[2m > [22m[2mshould allow PATCH with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768250026512,"env":"test","module":"auth-middleware","error":{"name":"TokenExpiredError","code":"AUTH_002","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250026512,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768250026521,"env":"test","module":"auth-routes","userId":"25276682-ea12-4b3c-ac30-40fa4af6c2d5","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250026556,"env":"test","module":"user-credentials-repository","userId":"a6e27cdc-9d73-4b05-a3d5-45626781e5d2","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/logout[2m > [22m[2mshould logout and clear refresh token cookie
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250026624,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should allow PATCH with valid Bearer token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250026662,"env":"test","module":"email-queue","jobId":"3e6d697d-07cd-420b-980e-d52583a02a05","to":"middleware-test-jigQhWtxWYL2jxu12oo8q@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250026720,"env":"test","module":"auth-routes","userId":"a6e27cdc-9d73-4b05-a3d5-45626781e5d2","email":"middleware-test-jigQhWtxWYL2jxu12oo8q@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 when no token provided
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250027005,"env":"test","module":"user-credentials-repository","userId":"d75b658e-673b-482a-9241-6068c36860dc","msg":"User credentials created"}
{"level":30,"time":1768250027069,"env":"test","module":"auth-routes","userId":"1132c442920060e83e7e171443b78463","msg":"User logged in successfully"}
{"level":30,"time":1768250027102,"env":"test","module":"email-queue","jobId":"59e989f6-a9a4-48c3-9195-c7caea2116f0","to":"protected-test-6FRYjH8dvXXHB3lCfDS8R@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250027120,"env":"test","module":"audit-log-service","userId":"1132c442920060e83e7e171443b78463","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250027149,"env":"test","module":"auth-routes","userId":"d75b658e-673b-482a-9241-6068c36860dc","email":"protected-test-6FRYjH8dvXXHB3lCfDS8R@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPATCH Protected Routes[2m > [22m[2mshould reject PATCH without Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250027263,"env":"test","module":"auth-routes","userId":"a6e27cdc-9d73-4b05-a3d5-45626781e5d2","msg":"User logged in successfully"}
{"level":30,"time":1768250027316,"env":"test","module":"audit-log-service","userId":"a6e27cdc-9d73-4b05-a3d5-45626781e5d2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250027321,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768250027395,"env":"test","module":"auth-routes","userId":"d75b658e-673b-482a-9241-6068c36860dc","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250027466,"env":"test","module":"user-credentials-repository","userId":"bc7794d4-5a01-46ae-bf5f-94cd995cb27e","msg":"User credentials created"}
{"level":50,"time":1768250027493,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should reject PATCH without Bearer token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250027565,"env":"test","module":"email-queue","jobId":"8a4f706c-ef95-4e08-be5e-e693f7b914a3","to":"jwt-test-8kmH-3iDHXF4Ar5yX0PHW@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250027617,"env":"test","module":"auth-routes","userId":"bc7794d4-5a01-46ae-bf5f-94cd995cb27e","email":"jwt-test-8kmH-3iDHXF4Ar5yX0PHW@example.com","msg":"User registered"}
{"level":30,"time":1768250027730,"env":"test","module":"user-credentials-repository","userId":"db13493f-f187-4475-ae8b-2677dc3003ea","msg":"User credentials created"}
{"level":50,"time":1768250027781,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250027830,"env":"test","module":"email-queue","jobId":"4df89572-02ec-4ed2-ad07-848b05ef4755","to":"middleware-test-2XhciyHM1uGhaXymYFbFL@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250027879,"env":"test","module":"user-credentials-repository","userId":"14c3e10f-f2ee-4234-8906-fc8d8c301a58","msg":"User credentials created"}
{"level":30,"time":1768250027881,"env":"test","module":"auth-routes","userId":"db13493f-f187-4475-ae8b-2677dc3003ea","email":"middleware-test-2XhciyHM1uGhaXymYFbFL@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 with invalid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250027971,"env":"test","module":"email-queue","jobId":"b10621db-ab46-4ca9-a116-12911f063c1b","to":"protected-test-EQwbbuBwSa19mURU2qCxM@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250028022,"env":"test","module":"auth-routes","userId":"14c3e10f-f2ee-4234-8906-fc8d8c301a58","email":"protected-test-EQwbbuBwSa19mURU2qCxM@example.com","msg":"User registered"}
{"level":50,"time":1768250028095,"env":"test","module":"auth-routes","userId":"db13493f-f187-4475-ae8b-2677dc3003ea","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle Bearer token with extra spaces
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250028176,"env":"test","module":"user-credentials-repository","userId":"705df5ed-b9f8-4bf2-8389-46aaf19b6381","msg":"User credentials created"}
{"level":50,"time":1768250028196,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should return 401 with invalid token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should return 401 with invalid token
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:33:48.196Z'
  }
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 with invalid token
[22m[39mUser in DB: {
  id: [32m'db13493f-f187-4475-ae8b-2677dc3003ea'[39m,
  email: [32m'middleware-test-2XhciyHM1uGhaXymYFbFL@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:33:50.604Z[39m,
  updatedAt: [35m2026-01-12T20:33:50.604Z[39m
}

{"level":30,"time":1768250028278,"env":"test","module":"email-queue","jobId":"c0f5f1fc-623b-47a8-8d43-62b07db3e61e","to":"user1-s-qdFy6Udom6MA_B_mIcj@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768250028285,"env":"test","module":"auth-routes","userId":"14c3e10f-f2ee-4234-8906-fc8d8c301a58","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 with invalid token
[22m[39mCreds in DB: [90mundefined[39m

{"level":30,"time":1768250028325,"env":"test","module":"auth-routes","userId":"705df5ed-b9f8-4bf2-8389-46aaf19b6381","email":"user1-s-qdFy6Udom6MA_B_mIcj@example.com","msg":"User registered"}
{"level":50,"time":1768250028387,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould refresh access token with valid refresh token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250028676,"env":"test","module":"user-credentials-repository","userId":"207e56a9-a8ee-4169-a8a0-464ced9035a5","msg":"User credentials created"}
{"level":30,"time":1768250028712,"env":"test","module":"user-credentials-repository","userId":"23538132-42d2-4960-a6da-2e6f583841bf","msg":"User credentials created"}
{"level":30,"time":1768250028773,"env":"test","module":"user-credentials-repository","userId":"139f47ed-b685-4e20-bac1-9f382d2a0aa8","msg":"User credentials created"}
{"level":30,"time":1768250028775,"env":"test","module":"email-queue","jobId":"33103ffb-2dba-4f15-af85-390df52a859f","to":"middleware-test-f_vgP7bZkWja9S99ihsuA@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250028813,"env":"test","module":"email-queue","jobId":"9ea45c9e-2bcd-416f-831f-3d7fd986930e","to":"user2-v9tm3hf5ttILBXly_dK-D@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250028827,"env":"test","module":"auth-routes","userId":"207e56a9-a8ee-4169-a8a0-464ced9035a5","email":"middleware-test-f_vgP7bZkWja9S99ihsuA@example.com","msg":"User registered"}
{"level":30,"time":1768250028858,"env":"test","module":"auth-routes","userId":"23538132-42d2-4960-a6da-2e6f583841bf","email":"user2-v9tm3hf5ttILBXly_dK-D@example.com","msg":"User registered"}
{"level":30,"time":1768250028871,"env":"test","module":"email-queue","jobId":"ba2a4cc4-604a-44a7-a556-6225c8eec335","to":"protected-test-hFTNTwSaLQp8oeUmPQssr@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250028879,"env":"test","module":"auth-routes","userId":"4c4b5a8e3b92655c10f687398474e393","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 with expired token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250028922,"env":"test","module":"auth-routes","userId":"139f47ed-b685-4e20-bac1-9f382d2a0aa8","email":"protected-test-hFTNTwSaLQp8oeUmPQssr@example.com","msg":"User registered"}
{"level":30,"time":1768250028931,"env":"test","module":"audit-log-service","userId":"4c4b5a8e3b92655c10f687398474e393","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250028935,"env":"test","module":"auth-service","tokenHash":"761568786d5f786ae146d970deb359286ad45543c97d83a0f6898647f215b478","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle very long invalid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250029029,"env":"test","module":"auth-routes","userId":"207e56a9-a8ee-4169-a8a0-464ced9035a5","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250029124,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should return 401 with expired token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should return 401 with expired token
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:33:49.125Z'
  }
}

{"level":50,"time":1768250029173,"env":"test","module":"auth-routes","userId":"139f47ed-b685-4e20-bac1-9f382d2a0aa8","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 with expired token
[22m[39mUser in DB: {
  id: [32m'207e56a9-a8ee-4169-a8a0-464ced9035a5'[39m,
  email: [32m'middleware-test-f_vgP7bZkWja9S99ihsuA@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:33:51.569Z[39m,
  updatedAt: [35m2026-01-12T20:33:51.569Z[39m
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 with expired token
[22m[39mCreds in DB: [90mundefined[39m

{"level":50,"time":1768250029273,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250029333,"env":"test","module":"user-credentials-repository","userId":"b8bd7ddf-8947-43fd-a74b-4d3142362e3d","msg":"User credentials created"}
{"level":30,"time":1768250029432,"env":"test","module":"email-queue","jobId":"c7368a64-9017-4017-bec9-b834ee8ffcae","to":"jwt-test-CJtGfLtbYvHwbby6qLcAN@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250029483,"env":"test","module":"auth-routes","userId":"b8bd7ddf-8947-43fd-a74b-4d3142362e3d","email":"jwt-test-CJtGfLtbYvHwbby6qLcAN@example.com","msg":"User registered"}
{"level":50,"time":1768250029486,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250029605,"env":"test","module":"user-credentials-repository","userId":"03de246d-3a9a-4720-857d-30213d33b867","msg":"User credentials created"}
stderr | tests/integration/auth/session.management.integration.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: relation "global_recipients" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 115,
  severity: 'ERROR',
  code: '42P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'namespace.c',
  line: '637',
  routine: 'RangeVarGetRelidExtended'
}

{"level":30,"time":1768250029655,"env":"test","module":"user-credentials-repository","userId":"71436c49-37e1-461c-ba8e-32608e0535e1","msg":"User credentials created"}
{"level":30,"time":1768250029711,"env":"test","module":"email-queue","jobId":"19fab15b-46f1-4fff-a89e-14467277826b","to":"middleware-test-3k_voWuAVTQOPCNxNv9Fk@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250029751,"env":"test","module":"email-queue","jobId":"9cb1a741-ce42-43e9-b11c-2367667d758c","to":"protected-test-jm7uj3g2NfJP2OXc6MyLP@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250029772,"env":"test","module":"auth-routes","userId":"03de246d-3a9a-4720-857d-30213d33b867","email":"middleware-test-3k_voWuAVTQOPCNxNv9Fk@example.com","msg":"User registered"}
{"level":30,"time":1768250029800,"env":"test","module":"auth-routes","userId":"71436c49-37e1-461c-ba8e-32608e0535e1","email":"protected-test-jm7uj3g2NfJP2OXc6MyLP@example.com","msg":"User registered"}
{"level":30,"time":1768250029804,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768250029823,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39m[Routes] E-Signature routes registered at /api/esign

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould authenticate with JWT Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250029813,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768250029813,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768250029817,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768250029822,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768250029822,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768250029823,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768250029823,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768250029856,"env":"test","module":"user-credentials-repository","userId":"688f5bd2-80dd-47eb-a5fb-4b43a1b03392","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle empty Authorization header
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250029960,"env":"test","module":"email-queue","jobId":"9100c633-aa66-4292-aae8-b817a268e3b6","to":"jwt-test-dgZjjRgoG6vlLH-YmbhNu@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768250029971,"env":"test","module":"auth-routes","userId":"03de246d-3a9a-4720-857d-30213d33b867","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250030012,"env":"test","module":"auth-routes","userId":"688f5bd2-80dd-47eb-a5fb-4b43a1b03392","email":"jwt-test-dgZjjRgoG6vlLH-YmbhNu@example.com","msg":"User registered"}
{"level":50,"time":1768250030041,"env":"test","module":"auth-routes","userId":"71436c49-37e1-461c-ba8e-32608e0535e1","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mHybrid Authentication Strategy[2m > [22m[2mshould allow GET requests with cookie auth only
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250030075,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should authenticate with JWT Bearer token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should authenticate with JWT Bearer token
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:33:50.076Z'
  }
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould authenticate with JWT Bearer token
[22m[39mUser in DB: {
  id: [32m'03de246d-3a9a-4720-857d-30213d33b867'[39m,
  email: [32m'middleware-test-3k_voWuAVTQOPCNxNv9Fk@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:33:52.501Z[39m,
  updatedAt: [35m2026-01-12T20:33:52.501Z[39m
}

{"level":50,"time":1768250030138,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle empty Authorization header
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould authenticate with JWT Bearer token
[22m[39mCreds in DB: [90mundefined[39m

{"level":50,"time":1768250030212,"env":"test","module":"auth-routes","userId":"688f5bd2-80dd-47eb-a5fb-4b43a1b03392","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250030300,"env":"test","module":"user-credentials-repository","userId":"da9ddf29-7928-4e79-b995-8489771bfefa","msg":"User credentials created"}
{"level":50,"time":1768250030309,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > Hybrid Authentication Strategy > should allow GET requests with cookie auth only
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250030407,"env":"test","module":"email-queue","jobId":"d496b068-dc73-4064-bbbc-9861988811cd","to":"test--BvYgX81qHchawpp8rYYk@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250030459,"env":"test","module":"auth-routes","userId":"da9ddf29-7928-4e79-b995-8489771bfefa","email":"test--BvYgX81qHchawpp8rYYk@example.com","msg":"User registered"}
{"level":30,"time":1768250030517,"env":"test","module":"user-credentials-repository","userId":"2bb0ddd8-ecf8-4469-85a6-ae0954831daf","msg":"User credentials created"}
{"level":30,"time":1768250030564,"env":"test","module":"user-credentials-repository","userId":"91f45c33-0c01-4ece-b366-79e69889714a","msg":"User credentials created"}
{"level":30,"time":1768250030615,"env":"test","module":"email-queue","jobId":"846f4720-6fe8-4d6c-9436-423dc87e390d","to":"protected-test-DFmb1v86tj8g6xNqgW9gR@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250030662,"env":"test","module":"email-queue","jobId":"a9f4e367-707c-4346-bf35-f66571413c7d","to":"middleware-test-VRPc--zkh2x207IebjPsk@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250030667,"env":"test","module":"auth-routes","userId":"2bb0ddd8-ecf8-4469-85a6-ae0954831daf","email":"protected-test-DFmb1v86tj8g6xNqgW9gR@example.com","msg":"User registered"}
{"level":30,"time":1768250030687,"env":"test","module":"user-credentials-repository","userId":"176ab7da-586a-4cb4-bc24-eb2391439221","msg":"User credentials created"}
{"level":30,"time":1768250030715,"env":"test","module":"auth-routes","userId":"91f45c33-0c01-4ece-b366-79e69889714a","email":"middleware-test-VRPc--zkh2x207IebjPsk@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould authenticate with refresh token cookie (GET only)
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle Authorization header with only Bearer
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250030786,"env":"test","module":"email-queue","jobId":"de637d5a-801a-4aa9-be71-73590c1e8949","to":"jwt-test-yTuDIaXpf4Bx_mqhE68BH@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250030833,"env":"test","module":"auth-routes","userId":"176ab7da-586a-4cb4-bc24-eb2391439221","email":"jwt-test-yTuDIaXpf4Bx_mqhE68BH@example.com","msg":"User registered"}
{"level":50,"time":1768250030836,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768250030914,"env":"test","module":"auth-routes","userId":"91f45c33-0c01-4ece-b366-79e69889714a","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250030918,"env":"test","module":"auth-routes","userId":"2bb0ddd8-ecf8-4469-85a6-ae0954831daf","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250031008,"env":"test","module":"user-credentials-repository","userId":"1058cc5a-b129-4431-81cb-39035d1439e0","msg":"User credentials created"}
{"level":50,"time":1768250031014,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should authenticate with refresh token cookie (GET only)
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should authenticate with refresh token cookie (GET only)
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:33:51.014Z'
  }
}

{"level":50,"time":1768250031017,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould authenticate with refresh token cookie (GET only)
[22m[39mUser in DB: {
  id: [32m'91f45c33-0c01-4ece-b366-79e69889714a'[39m,
  email: [32m'middleware-test-VRPc--zkh2x207IebjPsk@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:33:53.455Z[39m,
  updatedAt: [35m2026-01-12T20:33:53.455Z[39m
}

{"level":30,"time":1768250031108,"env":"test","module":"email-queue","jobId":"b6d1506e-7875-4c04-a0df-754f39a3f6af","to":"session-test-HoJH5Zii_4u2YBxCvOLUS@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould authenticate with refresh token cookie (GET only)
[22m[39mCreds in DB: [90mundefined[39m

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould rotate refresh token after use
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250031163,"env":"test","module":"auth-routes","userId":"1058cc5a-b129-4431-81cb-39035d1439e0","email":"session-test-HoJH5Zii_4u2YBxCvOLUS@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Creation and Tracking[2m > [22m[2mshould create refresh token on login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250031402,"env":"test","module":"user-credentials-repository","userId":"64e4a8b3-29db-438f-83d2-9d9d710a09a7","msg":"User credentials created"}
{"level":50,"time":1768250031416,"env":"test","module":"auth-routes","userId":"1058cc5a-b129-4431-81cb-39035d1439e0","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250031500,"env":"test","module":"email-queue","jobId":"f85a6c1e-22cf-471f-82da-f8201f2d7107","to":"protected-test-r0wzREkOHuoBvOJli0VbS@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250031508,"env":"test","module":"user-credentials-repository","userId":"c5338ae4-bb4b-40de-8e10-4d37783f90d3","msg":"User credentials created"}
{"level":50,"time":1768250031515,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Session Creation and Tracking > should create refresh token on login
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250031548,"env":"test","module":"auth-routes","userId":"64e4a8b3-29db-438f-83d2-9d9d710a09a7","email":"protected-test-r0wzREkOHuoBvOJli0VbS@example.com","msg":"User registered"}
{"level":30,"time":1768250031603,"env":"test","module":"email-queue","jobId":"68bc94df-1a0c-43e8-8faa-de5ae7da4764","to":"middleware-test-4lOpI9eB1N1PSBwhiQLze@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250031618,"env":"test","module":"auth-routes","userId":"83755b60cda6d01a265ce7d800180dd2","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle multiple Authorization headers
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250031655,"env":"test","module":"auth-routes","userId":"c5338ae4-bb4b-40de-8e10-4d37783f90d3","email":"middleware-test-4lOpI9eB1N1PSBwhiQLze@example.com","msg":"User registered"}
{"level":30,"time":1768250031672,"env":"test","module":"audit-log-service","userId":"83755b60cda6d01a265ce7d800180dd2","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250031676,"env":"test","module":"auth-service","tokenHash":"971b97ea5f1c0776b55dd224d8b04475a7fd925b2f597e4a066007336ff63dae","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for POST requests (mutation-strict)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768250031725,"env":"test","module":"auth-service","tokenHash":"971b97ea5f1c0776b55dd224d8b04475a7fd925b2f597e4a066007336ff63dae","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768250031772,"env":"test","module":"auth-service","allTokensCount":1,"sampleToken":"127d56a3e26d63e1cc55e128e2f1cd414f1e31fcb18ac735eeb3c1e7ef5b7b90","msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768250031776,"env":"test","module":"auth-service","tokenHash":"971b97ea5f1c0776b55dd224d8b04475a7fd925b2f597e4a066007336ff63dae","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768250031801,"env":"test","module":"auth-routes","userId":"64e4a8b3-29db-438f-83d2-9d9d710a09a7","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":40,"time":1768250031823,"env":"test","module":"auth-service","tokenHash":"971b97ea5f1c0776b55dd224d8b04475a7fd925b2f597e4a066007336ff63dae","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":50,"time":1768250031857,"env":"test","module":"auth-routes","userId":"c5338ae4-bb4b-40de-8e10-4d37783f90d3","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250031871,"env":"test","module":"auth-service","allTokensCount":2,"sampleToken":"0deb6ec0dc6b6c8aae6d8b0b3dfc5e06c3f4d1954bd9f458474f9d2ea111638c","msg":"DEBUG: Tokens in DB"}
{"level":50,"time":1768250031900,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle multiple Authorization headers
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250031907,"env":"test","module":"user-credentials-repository","userId":"23b18541-679c-41ab-975e-509a910713fe","msg":"User credentials created"}
{"level":50,"time":1768250031964,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should reject cookie auth for POST requests (mutation-strict)
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should reject cookie auth for POST requests (mutation-strict)
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:33:51.965Z'
  }
}

{"level":30,"time":1768250032010,"env":"test","module":"email-queue","jobId":"6eba101d-d728-4940-a054-496abf08551c","to":"session-test-9sfne79j0yP1zsqx69NLn@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for POST requests (mutation-strict)
[22m[39mUser in DB: {
  id: [32m'c5338ae4-bb4b-40de-8e10-4d37783f90d3'[39m,
  email: [32m'middleware-test-4lOpI9eB1N1PSBwhiQLze@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:33:54.400Z[39m,
  updatedAt: [35m2026-01-12T20:33:54.400Z[39m
}

{"level":30,"time":1768250032063,"env":"test","module":"auth-routes","userId":"23b18541-679c-41ab-975e-509a910713fe","email":"session-test-9sfne79j0yP1zsqx69NLn@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for POST requests (mutation-strict)
[22m[39mCreds in DB: [90mundefined[39m

{"level":30,"time":1768250032117,"env":"test","module":"user-credentials-repository","userId":"7d9e4de4-b8d5-460d-b144-9bbad2eccfb0","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Creation and Tracking[2m > [22m[2mshould track device metadata in session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250032219,"env":"test","module":"email-queue","jobId":"176fbe7a-8e33-4eab-a656-d6253a09b8fe","to":"jwt-test-xIldmiF-cQs6G-AA8LM2v@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250032265,"env":"test","module":"auth-routes","userId":"7d9e4de4-b8d5-460d-b144-9bbad2eccfb0","email":"jwt-test-xIldmiF-cQs6G-AA8LM2v@example.com","msg":"User registered"}
{"level":30,"time":1768250032273,"env":"test","module":"user-credentials-repository","userId":"5b1c35af-832c-4afa-9933-fdb93c19ac0a","msg":"User credentials created"}
{"level":50,"time":1768250032316,"env":"test","module":"auth-routes","userId":"23b18541-679c-41ab-975e-509a910713fe","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould refresh access token using refresh token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250032376,"env":"test","module":"email-queue","jobId":"88488dd4-a7e6-43ed-b608-408bc44cbfe2","to":"protected-test-QbBbdHbNcTCq0g-JXkL95@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768250032408,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Session Creation and Tracking > should track device metadata in session
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250032427,"env":"test","module":"auth-routes","userId":"5b1c35af-832c-4afa-9933-fdb93c19ac0a","email":"protected-test-QbBbdHbNcTCq0g-JXkL95@example.com","msg":"User registered"}
{"level":30,"time":1768250032441,"env":"test","module":"user-credentials-repository","userId":"17947e69-6ada-4bd8-a4eb-835082cd9487","msg":"User credentials created"}
{"level":50,"time":1768250032458,"env":"test","module":"auth-routes","userId":"7d9e4de4-b8d5-460d-b144-9bbad2eccfb0","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould reject token with SQL injection attempt
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250032540,"env":"test","module":"email-queue","jobId":"332b85c1-cb1f-48b6-93e8-b6170afce383","to":"middleware-test-hJAY3mfYJdNyrE5UGhVW3@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768250032556,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > Token Refresh Flow > should refresh access token using refresh token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250032591,"env":"test","module":"auth-routes","userId":"17947e69-6ada-4bd8-a4eb-835082cd9487","email":"middleware-test-hJAY3mfYJdNyrE5UGhVW3@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for PUT requests
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250032673,"env":"test","module":"auth-routes","userId":"5b1c35af-832c-4afa-9933-fdb93c19ac0a","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250032773,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with SQL injection attempt
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250032783,"env":"test","module":"user-credentials-repository","userId":"3219ed43-8300-4453-b78b-84229b860b36","msg":"User credentials created"}
{"level":50,"time":1768250032793,"env":"test","module":"auth-routes","userId":"17947e69-6ada-4bd8-a4eb-835082cd9487","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250032883,"env":"test","module":"email-queue","jobId":"ec5305f6-0297-4d1d-bbfb-48190f44ccac","to":"session-test-cXxhFtAh8dhlG2QzUsCuE@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768250032893,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should reject cookie auth for PUT requests
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should reject cookie auth for PUT requests
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:33:52.893Z'
  }
}

{"level":30,"time":1768250032923,"env":"test","module":"user-credentials-repository","userId":"c6cdf738-0899-4abd-90f3-7f38c0a37d9e","msg":"User credentials created"}
{"level":30,"time":1768250032931,"env":"test","module":"auth-routes","userId":"3219ed43-8300-4453-b78b-84229b860b36","email":"session-test-cXxhFtAh8dhlG2QzUsCuE@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for PUT requests
[22m[39mUser in DB: {
  id: [32m'17947e69-6ada-4bd8-a4eb-835082cd9487'[39m,
  email: [32m'middleware-test-hJAY3mfYJdNyrE5UGhVW3@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:33:55.343Z[39m,
  updatedAt: [35m2026-01-12T20:33:55.343Z[39m
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for PUT requests
[22m[39mCreds in DB: [90mundefined[39m

{"level":30,"time":1768250033023,"env":"test","module":"email-queue","jobId":"0d890d10-ac3f-4b80-a92a-bcf67daf26a5","to":"jwt-test-8pmNPF95pfXx7eBBN9-6e@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Creation and Tracking[2m > [22m[2mshould create separate sessions for multiple device logins
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250033076,"env":"test","module":"auth-routes","userId":"c6cdf738-0899-4abd-90f3-7f38c0a37d9e","email":"jwt-test-8pmNPF95pfXx7eBBN9-6e@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould rotate refresh token on use
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250033134,"env":"test","module":"user-credentials-repository","userId":"c5ceb1e6-b96a-4ce5-b226-787e472603dc","msg":"User credentials created"}
{"level":50,"time":1768250033182,"env":"test","module":"auth-routes","userId":"3219ed43-8300-4453-b78b-84229b860b36","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250033231,"env":"test","module":"email-queue","jobId":"52a594b2-0b11-4ee4-a931-716f5421efbc","to":"protected-test-cLnEEUhfd2Gk74oyaB8Xk@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250033248,"env":"test","module":"email-queue","jobId":"54d8a625-b82b-42fb-8b95-7d64db8552ef","to":"test-1768250032669-ngjhvn@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250033248,"env":"test","module":"auth-service","email":"test-1768250032669-ngjhvn@example.com","msg":"Password reset email sent"}
{"level":50,"time":1768250033279,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Session Creation and Tracking > should create separate sessions for multiple device logins
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250033282,"env":"test","module":"auth-routes","userId":"c5ceb1e6-b96a-4ce5-b226-787e472603dc","email":"protected-test-cLnEEUhfd2Gk74oyaB8Xk@example.com","msg":"User registered"}
{"level":30,"time":1768250033366,"env":"test","module":"user-credentials-repository","userId":"aabdf1de-c988-4442-b7f2-b9847cf9cc8d","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould reject token with XSS attempt
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250033466,"env":"test","module":"email-queue","jobId":"5d69a303-5f36-4d0d-a842-724d72ba9e74","to":"middleware-test-xJeVGvZlffaF1N0TD7Sg4@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250033520,"env":"test","module":"auth-routes","userId":"aabdf1de-c988-4442-b7f2-b9847cf9cc8d","email":"middleware-test-xJeVGvZlffaF1N0TD7Sg4@example.com","msg":"User registered"}
{"level":50,"time":1768250033524,"env":"test","module":"auth-routes","userId":"c5ceb1e6-b96a-4ce5-b226-787e472603dc","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for DELETE requests
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250033599,"env":"test","module":"auth-routes","userId":"c6cdf738-0899-4abd-90f3-7f38c0a37d9e","msg":"User logged in successfully"}
{"level":50,"time":1768250033624,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250033646,"env":"test","module":"audit-log-service","userId":"c6cdf738-0899-4abd-90f3-7f38c0a37d9e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250033650,"env":"test","module":"auth-service","tokenHash":"f36cc81e4d1d0ccaf5640cdb336b4e6e9598de4b0e13cc5da146b9ebdf06ce94","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250033662,"env":"test","module":"user-credentials-repository","userId":"04cf22ea-2a95-465d-87b7-2eb1e1cdddea","msg":"User credentials created"}
{"level":40,"time":1768250033696,"env":"test","module":"auth-service","tokenHash":"f36cc81e4d1d0ccaf5640cdb336b4e6e9598de4b0e13cc5da146b9ebdf06ce94","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":50,"time":1768250033723,"env":"test","module":"auth-routes","userId":"aabdf1de-c988-4442-b7f2-b9847cf9cc8d","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250033749,"env":"test","module":"auth-service","allTokensCount":0,"msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768250033766,"env":"test","module":"email-queue","jobId":"8a53bd29-893f-48b7-bb03-63d03499459a","to":"session-test-DlhQWJQVnTzA7vEhjTDh8@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250033814,"env":"test","module":"auth-routes","userId":"04cf22ea-2a95-465d-87b7-2eb1e1cdddea","email":"session-test-DlhQWJQVnTzA7vEhjTDh8@example.com","msg":"User registered"}
{"level":50,"time":1768250033820,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should reject cookie auth for DELETE requests
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should reject cookie auth for DELETE requests
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:33:53.820Z'
  }
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for DELETE requests
[22m[39mUser in DB: {
  id: [32m'aabdf1de-c988-4442-b7f2-b9847cf9cc8d'[39m,
  email: [32m'middleware-test-xJeVGvZlffaF1N0TD7Sg4@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:33:56.263Z[39m,
  updatedAt: [35m2026-01-12T20:33:56.263Z[39m
}

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for user
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for DELETE requests
[22m[39mCreds in DB: [90mundefined[39m

{"level":30,"time":1768250034012,"env":"test","module":"user-credentials-repository","userId":"70934102-df13-482a-810e-af7c0671ad03","msg":"User credentials created"}
{"level":50,"time":1768250034072,"env":"test","module":"auth-routes","userId":"04cf22ea-2a95-465d-87b7-2eb1e1cdddea","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250034116,"env":"test","module":"email-queue","jobId":"80e8ce17-9fc0-4a6f-9e3c-e63656e69a1b","to":"protected-test-WIlb9NjYKnmhWSULOnGEy@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250034140,"env":"test","module":"user-credentials-repository","userId":"c9842513-19d5-4403-b950-2f4f2fc4b8ed","msg":"User credentials created"}
{"level":30,"time":1768250034164,"env":"test","module":"auth-routes","userId":"70934102-df13-482a-810e-af7c0671ad03","email":"protected-test-WIlb9NjYKnmhWSULOnGEy@example.com","msg":"User registered"}
{"level":50,"time":1768250034176,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should list all active sessions for user
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250034237,"env":"test","module":"email-queue","jobId":"6cf449e6-7f8c-4c7c-98d0-dd916844ec21","to":"jwt-test-tW3UBa76bwJtLXdMMq85a@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Payload Validation[2m > [22m[2mshould reject token with missing userId
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250034293,"env":"test","module":"auth-routes","userId":"c9842513-19d5-4403-b950-2f4f2fc4b8ed","email":"jwt-test-tW3UBa76bwJtLXdMMq85a@example.com","msg":"User registered"}
{"level":30,"time":1768250034310,"env":"test","module":"user-credentials-repository","userId":"18cfecc4-dd93-480e-b8dc-c68c27ae8155","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould detect token reuse and revoke all user tokens
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250034405,"env":"test","module":"email-queue","jobId":"0830ca1e-fbe7-4ded-8886-eb857ad89935","to":"middleware-test-pHJi-wlSzZdtbkuYs_oFg@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768250034417,"env":"test","module":"auth-routes","userId":"70934102-df13-482a-810e-af7c0671ad03","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250034454,"env":"test","module":"auth-routes","userId":"18cfecc4-dd93-480e-b8dc-c68c27ae8155","email":"middleware-test-pHJi-wlSzZdtbkuYs_oFg@example.com","msg":"User registered"}
{"level":50,"time":1768250034487,"env":"test","module":"auth-routes","userId":"c9842513-19d5-4403-b950-2f4f2fc4b8ed","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250034513,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould allow cookie auth for HEAD requests
[22m[39mDEBUG: LOGIN HANDLER HIT

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250034560,"env":"test","module":"user-credentials-repository","userId":"5838ba10-6e85-4973-9f58-c4c51fd54e8d","msg":"User credentials created"}
{"level":50,"time":1768250034589,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > Token Refresh Flow > should detect token reuse and revoke all user tokens
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250034662,"env":"test","module":"auth-routes","userId":"18cfecc4-dd93-480e-b8dc-c68c27ae8155","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250034663,"env":"test","module":"email-queue","jobId":"e24e4f80-e94c-4881-a18c-081376e28588","to":"session-test-I60kAJCx7twScLt6UO7DS@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250034712,"env":"test","module":"auth-routes","userId":"5838ba10-6e85-4973-9f58-c4c51fd54e8d","email":"session-test-I60kAJCx7twScLt6UO7DS@example.com","msg":"User registered"}
{"level":50,"time":1768250034756,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should allow cookie auth for HEAD requests
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should allow cookie auth for HEAD requests
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:33:54.757Z'
  }
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould allow cookie auth for HEAD requests
[22m[39mUser in DB: {
  id: [32m'18cfecc4-dd93-480e-b8dc-c68c27ae8155'[39m,
  email: [32m'middleware-test-pHJi-wlSzZdtbkuYs_oFg@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:33:57.202Z[39m,
  updatedAt: [35m2026-01-12T20:33:57.202Z[39m
}

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould allow cookie auth for HEAD requests
[22m[39mCreds in DB: [90mundefined[39m

{"level":30,"time":1768250034891,"env":"test","module":"user-credentials-repository","userId":"c6f39680-ff57-44a5-af3c-494a8e14de4b","msg":"User credentials created"}
{"level":50,"time":1768250034958,"env":"test","module":"auth-routes","userId":"5838ba10-6e85-4973-9f58-c4c51fd54e8d","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250034964,"env":"test","module":"user-credentials-repository","userId":"0231e6b0-db69-4dd3-8c29-03aa90dfe622","msg":"User credentials created"}
{"level":30,"time":1768250034986,"env":"test","module":"email-queue","jobId":"75dd8a92-a0d2-4c79-a29e-9ed4dc175e0f","to":"protected-test-90ipimFZKfl1tz5RDZVcf@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250035032,"env":"test","module":"auth-routes","userId":"c6f39680-ff57-44a5-af3c-494a8e14de4b","email":"protected-test-90ipimFZKfl1tz5RDZVcf@example.com","msg":"User registered"}
{"level":50,"time":1768250035053,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should mark current session correctly
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250035058,"env":"test","module":"email-queue","jobId":"3d6212c4-efcd-4f04-a29f-c4d1d5b52b2f","to":"jwt-test-oo4Evzmt5SmWNnZZOguCJ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250035109,"env":"test","module":"auth-routes","userId":"0231e6b0-db69-4dd3-8c29-03aa90dfe622","email":"jwt-test-oo4Evzmt5SmWNnZZOguCJ@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Payload Validation[2m > [22m[2mshould reject token with non-existent userId
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mLogout Flow[2m > [22m[2mshould revoke refresh token on logout
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250035231,"env":"test","module":"user-credentials-repository","userId":"5e9446f5-5ae8-4ff7-a584-a9bdda0a5ca9","msg":"User credentials created"}
{"level":50,"time":1768250035278,"env":"test","module":"auth-routes","userId":"c6f39680-ff57-44a5-af3c-494a8e14de4b","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250035311,"env":"test","module":"auth-routes","userId":"0231e6b0-db69-4dd3-8c29-03aa90dfe622","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250035342,"env":"test","module":"email-queue","jobId":"dadecc7f-3b76-4aa6-86d8-9b8ca90cbfa7","to":"middleware-test-ArSMNwZCQKJkqhne0VlGa@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768250035381,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250035396,"env":"test","module":"auth-routes","userId":"5e9446f5-5ae8-4ff7-a584-a9bdda0a5ca9","email":"middleware-test-ArSMNwZCQKJkqhne0VlGa@example.com","msg":"User registered"}
{"level":50,"time":1768250035407,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > Logout Flow > should revoke refresh token on logout
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250035433,"env":"test","module":"user-credentials-repository","userId":"33ff503d-2b7f-4c7b-8f8d-b82dbb4babff","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould prioritize JWT over cookie when both present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250035461,"env":"test","module":"email-queue","jobId":"6e2d6735-803e-4bbe-b8c0-fe5104b29347","to":"test-1768250034870-mmnziq@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250035461,"env":"test","module":"auth-service","email":"test-1768250034870-mmnziq@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768250035534,"env":"test","module":"email-queue","jobId":"494567d7-1f35-49dc-a36b-af0515ff13bd","to":"session-test-m-D1PlUa6FgHY37RNhilD@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250035582,"env":"test","module":"auth-routes","userId":"33ff503d-2b7f-4c7b-8f8d-b82dbb4babff","email":"session-test-m-D1PlUa6FgHY37RNhilD@example.com","msg":"User registered"}
{"level":50,"time":1768250035602,"env":"test","module":"auth-routes","userId":"5e9446f5-5ae8-4ff7-a584-a9bdda0a5ca9","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould not include revoked sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250035701,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should prioritize JWT over cookie when both present
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should prioritize JWT over cookie when both present
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:33:55.701Z'
  }
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould prioritize JWT over cookie when both present
[22m[39mUser in DB: {
  id: [32m'5e9446f5-5ae8-4ff7-a584-a9bdda0a5ca9'[39m,
  email: [32m'middleware-test-ArSMNwZCQKJkqhne0VlGa@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:33:58.120Z[39m,
  updatedAt: [35m2026-01-12T20:33:58.120Z[39m
}

{"level":30,"time":1768250035764,"env":"test","module":"user-credentials-repository","userId":"a282e15c-28e4-427b-9472-284255e35dde","msg":"User credentials created"}
{"level":30,"time":1768250035791,"env":"test","module":"user-credentials-repository","userId":"b0331e0b-f562-45a5-842c-3afd17b2b46e","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould prioritize JWT over cookie when both present
[22m[39mCreds in DB: [90mundefined[39m

{"level":50,"time":1768250035846,"env":"test","module":"user-credentials-repository","error":{},"userId":"15fb4608c4af22e08ee329de64c2dde4","msg":"Failed to update user password"}
{"level":50,"time":1768250035846,"env":"test","module":"auth-routes","error":{},"msg":"Reset password error"}
{"level":50,"time":1768250035853,"env":"test","module":"auth-routes","userId":"33ff503d-2b7f-4c7b-8f8d-b82dbb4babff","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250035871,"env":"test","module":"email-queue","jobId":"061f458c-5779-45a3-8d50-41ed881d4add","to":"protected-test-re_Xc5vmyoQSJ-x08S0Wl@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250035900,"env":"test","module":"email-queue","jobId":"e83a0332-2001-45a1-9165-d043ff0b53f9","to":"jwt-test-PLDZ-EWaozEN7avbrMV0j@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250035922,"env":"test","module":"auth-routes","userId":"a282e15c-28e4-427b-9472-284255e35dde","email":"protected-test-re_Xc5vmyoQSJ-x08S0Wl@example.com","msg":"User registered"}
{"level":30,"time":1768250035951,"env":"test","module":"auth-routes","userId":"b0331e0b-f562-45a5-842c-3afd17b2b46e","email":"jwt-test-PLDZ-EWaozEN7avbrMV0j@example.com","msg":"User registered"}
{"level":50,"time":1768250035961,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should not include revoked sessions
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mLogout Flow[2m > [22m[2mshould clear refresh token cookie on logout
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mCross-User Authorization[2m > [22m[2mshould not allow user to access another user's resources
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250036198,"env":"test","module":"user-credentials-repository","userId":"b275200c-9892-498b-9908-956166ceae4f","msg":"User credentials created"}
{"level":30,"time":1768250036300,"env":"test","module":"email-queue","jobId":"7fbefffe-5792-4144-afbe-dd07da1c60f0","to":"middleware-test-PcJwQmZsQBku6yCorS9dA@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250036348,"env":"test","module":"auth-routes","userId":"b275200c-9892-498b-9908-956166ceae4f","email":"middleware-test-PcJwQmZsQBku6yCorS9dA@example.com","msg":"User registered"}
{"level":30,"time":1768250036373,"env":"test","module":"user-credentials-repository","userId":"600d48fc-ca90-4746-abe2-33e90b1ad810","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould return 401 when no auth provided
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250036475,"env":"test","module":"email-queue","jobId":"dbe9487e-bcca-43ca-96ff-7069702288bd","to":"session-test-QzH7UevOMURQt8NSSIiv2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250036504,"env":"test","module":"auth-routes","userId":"b0331e0b-f562-45a5-842c-3afd17b2b46e","msg":"User logged in successfully"}
{"level":30,"time":1768250036532,"env":"test","module":"auth-routes","userId":"600d48fc-ca90-4746-abe2-33e90b1ad810","email":"session-test-QzH7UevOMURQt8NSSIiv2@example.com","msg":"User registered"}
{"level":50,"time":1768250036546,"env":"test","module":"auth-routes","userId":"b275200c-9892-498b-9908-956166ceae4f","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250036552,"env":"test","module":"audit-log-service","userId":"b0331e0b-f562-45a5-842c-3afd17b2b46e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250036589,"env":"test","module":"auth-routes","userId":"a282e15c-28e4-427b-9472-284255e35dde","msg":"User logged in successfully"}
{"level":30,"time":1768250036638,"env":"test","module":"audit-log-service","userId":"a282e15c-28e4-427b-9472-284255e35dde","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250036646,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should return 401 when no auth provided
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should return 401 when no auth provided
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:33:56.646Z'
  }
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould return 401 when no auth provided
[22m[39mUser in DB: {
  id: [32m'b275200c-9892-498b-9908-956166ceae4f'[39m,
  email: [32m'middleware-test-PcJwQmZsQBku6yCorS9dA@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:33:59.079Z[39m,
  updatedAt: [35m2026-01-12T20:33:59.079Z[39m
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould return 401 when no auth provided
[22m[39mCreds in DB: [90mundefined[39m

{"level":50,"time":1768250036795,"env":"test","module":"auth-routes","userId":"600d48fc-ca90-4746-abe2-33e90b1ad810","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250036874,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250036874,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768250036888,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should order sessions by last used (most recent first)
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250037015,"env":"test","module":"user-credentials-repository","userId":"9ce2a623-68f9-4e1b-b23b-b9fa4c1ef71a","msg":"User credentials created"}
{"level":30,"time":1768250037112,"env":"test","module":"email-queue","jobId":"fb82d940-e04b-464c-8a03-cbb6869f4772","to":"user2-6j8FUsa_3BKWTiAuzaMZ8@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250037137,"env":"test","module":"user-credentials-repository","userId":"fb28c16b-df35-46f2-9e4e-591fd06ad309","msg":"User credentials created"}
{"level":30,"time":1768250037157,"env":"test","module":"auth-routes","userId":"9ce2a623-68f9-4e1b-b23b-b9fa4c1ef71a","email":"user2-6j8FUsa_3BKWTiAuzaMZ8@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w0_b640dbfc

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mCross-User Authorization[2m > [22m[2mshould not allow user to access another user's resources
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250037237,"env":"test","module":"email-queue","jobId":"fe51ad65-85d9-4767-8a5b-121f8cd77705","to":"middleware-test-uhIzIb2BEUQK1-FJKqKZS@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250037269,"env":"test","module":"user-credentials-repository","userId":"1d00c57b-ff90-4e52-bf95-e4c0cf161a10","msg":"User credentials created"}
{"level":30,"time":1768250037286,"env":"test","module":"auth-routes","userId":"fb28c16b-df35-46f2-9e4e-591fd06ad309","email":"middleware-test-uhIzIb2BEUQK1-FJKqKZS@example.com","msg":"User registered"}
 [31mÎ“Â¥Â»[39m tests/integration/auth/jwt.authentication.test.ts [2m([22m[2m27 tests[22m[2m | [22m[31m9 failed[39m[2m)[22m[33m 64715[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should generate valid JWT token on successful login[39m[33m 906[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should include correct payload in JWT token[39m[33m 854[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set JWT expiry to 15 minutes [33m 1186[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should accept valid JWT token on protected routes[39m[33m 861[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject request without authorization header[32m 9[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject request with malformed token[32m 5[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should accept request with missing Bearer prefix (lenient)[39m[33m 844[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject token with invalid signature[32m 4[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject expired JWT token [33m 1104[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return token_expired error code for expired tokens [33m 1107[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should authenticate with Bearer token in Authorization header[32m 111[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should work with Bearer token on POST requests[32m 0[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should work with Bearer token on PUT requests[32m 208[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should work with Bearer token on DELETE requests[32m 264[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should exchange valid session cookie for JWT token [33m 681[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject token exchange without valid cookie[32m 4[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prefer Bearer token over cookie when both present [33m 1176[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should fall back to cookie if Bearer token is invalid [33m 528[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow GET requests with cookie auth only[39m[33m 825[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject POST requests with cookie auth only (mutation-strict) [33m 526[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow anonymous access to public workflows [33m 444[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should attach user info if authenticated on optional auth routes [33m 436[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should refresh access token using refresh token[39m[33m 840[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should rotate refresh token on use[39m[33m 1192[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should detect token reuse and revoke all user tokens[39m[33m 841[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke refresh token on logout[39m[33m 817[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should clear refresh token cookie on logout [33m 1194[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould return 401 when both JWT and cookie are invalid
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250037341,"env":"test","module":"auth-routes","userId":"9ce2a623-68f9-4e1b-b23b-b9fa4c1ef71a","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250037368,"env":"test","module":"email-queue","jobId":"603bdfd2-a71d-4657-99b4-05f349ecc587","to":"session-test-EolDnyhlqUwOn4wchnm_M@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250037417,"env":"test","module":"auth-routes","userId":"1d00c57b-ff90-4e52-bf95-e4c0cf161a10","email":"session-test-EolDnyhlqUwOn4wchnm_M@example.com","msg":"User registered"}
{"level":50,"time":1768250037442,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250037519,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250037811,"env":"test","module":"auth-routes","userId":"fb28c16b-df35-46f2-9e4e-591fd06ad309","msg":"User logged in successfully"}
{"level":30,"time":1768250037820,"env":"test","module":"user-credentials-repository","userId":"eaef3358-e8c8-437e-8b16-0b03879fc57c","msg":"User credentials created"}
{"level":30,"time":1768250037859,"env":"test","module":"audit-log-service","userId":"fb28c16b-df35-46f2-9e4e-591fd06ad309","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250037863,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250037906,"env":"test","module":"user-credentials-repository","userId":"02b734a7-d287-4532-bdc3-a5fbdea5b5e2","msg":"User credentials created"}
{"level":30,"time":1768250037923,"env":"test","module":"email-queue","jobId":"19924883-dce0-4bd7-ac0c-b201e314fa1d","to":"protected-test-8mONcWCBHnZVh1FiguTtX@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250037971,"env":"test","module":"auth-routes","userId":"eaef3358-e8c8-437e-8b16-0b03879fc57c","email":"protected-test-8mONcWCBHnZVh1FiguTtX@example.com","msg":"User registered"}
{"level":30,"time":1768250037999,"env":"test","module":"email-queue","jobId":"1da39bdf-a01a-448c-a496-a757b296c816","to":"session-test-BuK_LjC59M1rIycRM9zSE@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250038047,"env":"test","module":"auth-routes","userId":"02b734a7-d287-4532-bdc3-a5fbdea5b5e2","email":"session-test-BuK_LjC59M1rIycRM9zSE@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mUser Context Injection[2m > [22m[2mshould inject userId into request context
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250038085,"env":"test","module":"email-queue","jobId":"ce355656-6ec5-44c1-8865-48f054d4d466","to":"test-1768250037506-mbluin@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250038085,"env":"test","module":"auth-service","email":"test-1768250037506-mbluin@example.com","msg":"Password reset email sent"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250038204,"env":"test","module":"auth-routes","userId":"eaef3358-e8c8-437e-8b16-0b03879fc57c","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250038238,"env":"test","module":"user-credentials-repository","userId":"74aafed6-f2b9-4c07-8e95-6d0d813741d9","msg":"User credentials created"}
{"level":50,"time":1768250038301,"env":"test","module":"auth-routes","userId":"02b734a7-d287-4532-bdc3-a5fbdea5b5e2","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250038305,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250038346,"env":"test","module":"email-queue","jobId":"93c816a7-adce-40d8-b2fc-8119d60998f4","to":"middleware-test-UFcIBshRtD8Z3beD2d6ds@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250038394,"env":"test","module":"auth-routes","userId":"74aafed6-f2b9-4c07-8e95-6d0d813741d9","email":"middleware-test-UFcIBshRtD8Z3beD2d6ds@example.com","msg":"User registered"}
{"level":50,"time":1768250038399,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/:sessionId > should revoke specific session
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould authenticate with JWT if provided
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250038593,"env":"test","module":"auth-routes","userId":"74aafed6-f2b9-4c07-8e95-6d0d813741d9","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250038678,"env":"test","module":"user-credentials-repository","userId":"a8ef063e-2e5e-4c98-aaf6-a05f0e6760d6","msg":"User credentials created"}
{"level":50,"time":1768250038691,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > optionalHybridAuth Middleware > should authenticate with JWT if provided
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > optionalHybridAuth Middleware > should authenticate with JWT if provided
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:33:58.692Z'
  }
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould authenticate with JWT if provided
[22m[39mUser in DB: {
  id: [32m'74aafed6-f2b9-4c07-8e95-6d0d813741d9'[39m,
  email: [32m'middleware-test-UFcIBshRtD8Z3beD2d6ds@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:34:01.134Z[39m,
  updatedAt: [35m2026-01-12T20:34:01.134Z[39m
}

{"level":30,"time":1768250038773,"env":"test","module":"user-credentials-repository","userId":"3f25b4f7-b3e0-45ad-a3e6-ef6acd99424c","msg":"User credentials created"}
{"level":30,"time":1768250038776,"env":"test","module":"email-queue","jobId":"27655703-f632-4bf5-9e20-3cfc66e5c8d8","to":"protected-test-Y67RB3wvGYqad8I5uE_6X@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould authenticate with JWT if provided
[22m[39mCreds in DB: [90mundefined[39m

{"level":30,"time":1768250038824,"env":"test","module":"auth-routes","userId":"a8ef063e-2e5e-4c98-aaf6-a05f0e6760d6","email":"protected-test-Y67RB3wvGYqad8I5uE_6X@example.com","msg":"User registered"}
{"level":30,"time":1768250038871,"env":"test","module":"email-queue","jobId":"95c67895-57c5-4496-a09a-d011dfd279a9","to":"session-test-PcWkbiuR0gDFsH8miDmWq@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250038922,"env":"test","module":"auth-routes","userId":"3f25b4f7-b3e0-45ad-a3e6-ef6acd99424c","email":"session-test-PcWkbiuR0gDFsH8miDmWq@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mUser Context Injection[2m > [22m[2mshould inject tenantId into request context
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking current session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250039068,"env":"test","module":"auth-routes","userId":"a8ef063e-2e5e-4c98-aaf6-a05f0e6760d6","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250039165,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject tenantId into request context
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250039167,"env":"test","module":"auth-routes","userId":"3f25b4f7-b3e0-45ad-a3e6-ef6acd99424c","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250039186,"env":"test","module":"user-credentials-repository","userId":"14d34909-7cf2-433e-84ea-b08128048c65","msg":"User credentials created"}
{"level":50,"time":1768250039272,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/:sessionId > should prevent revoking current session
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250039292,"env":"test","module":"email-queue","jobId":"bc2b2097-66d5-46bf-a0f7-ec00d0de024e","to":"middleware-test-X2-Hcrj64mLhNfxkXL7-f@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mGET /api/auth/me[2m > [22m[2mshould return current user for valid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250039347,"env":"test","module":"auth-routes","userId":"14d34909-7cf2-433e-84ea-b08128048c65","email":"middleware-test-X2-Hcrj64mLhNfxkXL7-f@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould authenticate with cookie if JWT not provided
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250039482,"env":"test","module":"auth-routes","userId":"c066ffb5a54d4b0a6c09ac34a2f2e027","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250039532,"env":"test","module":"user-credentials-repository","userId":"807cf78a-cb39-48af-8f11-6f69630b9348","msg":"User credentials created"}
{"level":50,"time":1768250039546,"env":"test","module":"auth-routes","userId":"14d34909-7cf2-433e-84ea-b08128048c65","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250039583,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > GET /api/auth/me > should return current user for valid token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250039588,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250039627,"env":"test","module":"email-queue","jobId":"0ec8614d-c427-440b-a496-a6648e6f2cc3","to":"protected-test-ERFRL2oJldtubM_u1P--F@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768250039651,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > optionalHybridAuth Middleware > should authenticate with cookie if JWT not provided
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > optionalHybridAuth Middleware > should authenticate with cookie if JWT not provided
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:33:59.651Z'
  }
}

{"level":30,"time":1768250039661,"env":"test","module":"user-credentials-repository","userId":"a9788180-c213-4299-aa98-c935fc22cbf8","msg":"User credentials created"}
{"level":30,"time":1768250039672,"env":"test","module":"auth-routes","userId":"807cf78a-cb39-48af-8f11-6f69630b9348","email":"protected-test-ERFRL2oJldtubM_u1P--F@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould authenticate with cookie if JWT not provided
[22m[39mUser in DB: {
  id: [32m'14d34909-7cf2-433e-84ea-b08128048c65'[39m,
  email: [32m'middleware-test-X2-Hcrj64mLhNfxkXL7-f@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:34:02.066Z[39m,
  updatedAt: [35m2026-01-12T20:34:02.066Z[39m
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould authenticate with cookie if JWT not provided
[22m[39mCreds in DB: [90mundefined[39m

{"level":30,"time":1768250039763,"env":"test","module":"email-queue","jobId":"c80219d0-a1a8-44b5-83d0-da1dd2be6f86","to":"session-test-wkr6Rtwo614YaYkqJGeQW@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mUser Context Injection[2m > [22m[2mshould inject role into request context
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250039830,"env":"test","module":"auth-routes","userId":"a9788180-c213-4299-aa98-c935fc22cbf8","email":"session-test-wkr6Rtwo614YaYkqJGeQW@example.com","msg":"User registered"}
{"level":50,"time":1768250039919,"env":"test","module":"auth-routes","userId":"807cf78a-cb39-48af-8f11-6f69630b9348","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250040008,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject role into request context
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250040119,"env":"test","module":"user-credentials-repository","userId":"8b7853c7-36e6-4a2a-aba2-24d336d8e72e","msg":"User credentials created"}
{"level":30,"time":1768250040221,"env":"test","module":"email-queue","jobId":"90b57dbf-95f0-49ed-82f7-166b40488c74","to":"middleware-test-CNkebfiWtkzN2nzOC4jMX@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250040268,"env":"test","module":"auth-routes","userId":"8b7853c7-36e6-4a2a-aba2-24d336d8e72e","email":"middleware-test-CNkebfiWtkzN2nzOC4jMX@example.com","msg":"User registered"}
{"level":30,"time":1768250040310,"env":"test","module":"user-credentials-repository","userId":"e29b5070-a3ed-46dc-8c8c-a1675448ea6e","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould proceed anonymously if no auth provided
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250040361,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250040374,"env":"test","module":"user-credentials-repository","userId":"5abda7ab-aa5a-489f-93c5-5659bb0f39a3","msg":"User credentials created"}
{"level":30,"time":1768250040404,"env":"test","module":"email-queue","jobId":"dfb4dfb1-3feb-44cc-b527-b1477176e472","to":"user2-7VHWNQXsZlo0Nm66SURw4@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250040451,"env":"test","module":"auth-routes","userId":"e29b5070-a3ed-46dc-8c8c-a1675448ea6e","email":"user2-7VHWNQXsZlo0Nm66SURw4@example.com","msg":"User registered"}
{"level":50,"time":1768250040469,"env":"test","module":"auth-routes","userId":"8b7853c7-36e6-4a2a-aba2-24d336d8e72e","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250040488,"env":"test","module":"email-queue","jobId":"7920ab80-7535-43b7-8ebf-d36682d3d9ea","to":"protected-test-PrSuhalXqBvBYSYpE6Mv9@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould not allow revoking other users sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250040532,"env":"test","module":"auth-routes","userId":"5abda7ab-aa5a-489f-93c5-5659bb0f39a3","email":"protected-test-PrSuhalXqBvBYSYpE6Mv9@example.com","msg":"User registered"}
{"level":50,"time":1768250040568,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > optionalHybridAuth Middleware > should proceed anonymously if no auth provided
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > optionalHybridAuth Middleware > should proceed anonymously if no auth provided
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:34:00.568Z'
  }
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould proceed anonymously if no auth provided
[22m[39mUser in DB: {
  id: [32m'8b7853c7-36e6-4a2a-aba2-24d336d8e72e'[39m,
  email: [32m'middleware-test-CNkebfiWtkzN2nzOC4jMX@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:34:03.021Z[39m,
  updatedAt: [35m2026-01-12T20:34:03.021Z[39m
}

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mRate Limiting on Protected Routes[2m > [22m[2mshould not apply general rate limiting to authenticated requests
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250040640,"env":"test","module":"auth-routes","userId":"e29b5070-a3ed-46dc-8c8c-a1675448ea6e","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould proceed anonymously if no auth provided
[22m[39mCreds in DB: [90mundefined[39m

{"level":50,"time":1768250040741,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/:sessionId > should not allow revoking other users sessions
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250040789,"env":"test","module":"auth-routes","userId":"5abda7ab-aa5a-489f-93c5-5659bb0f39a3","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250040884,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Rate Limiting on Protected Routes > should not apply general rate limiting to authenticated requests
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250041044,"env":"test","module":"user-credentials-repository","userId":"dd2ae85c-ca5d-4741-a3f4-8dd7f39f89e9","msg":"User credentials created"}
{"level":30,"time":1768250041121,"env":"test","module":"user-credentials-repository","userId":"99121cb1-1ca7-4681-aa13-29a906edfef9","msg":"User credentials created"}
{"level":50,"time":1768250041136,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250041152,"env":"test","module":"email-queue","jobId":"95d128f4-4d73-4829-8edd-d6779ded40e4","to":"middleware-test-IccGtk_8ECge_Xotbu_jL@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250041201,"env":"test","module":"auth-routes","userId":"dd2ae85c-ca5d-4741-a3f4-8dd7f39f89e9","email":"middleware-test-IccGtk_8ECge_Xotbu_jL@example.com","msg":"User registered"}
{"level":30,"time":1768250041226,"env":"test","module":"email-queue","jobId":"9c405f1b-c56c-4d20-8e53-5d4317c6ff93","to":"session-test-XjcdHEzrQfXrF8rBPeukw@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250041257,"env":"test","module":"user-credentials-repository","userId":"d28eee6a-ca19-4a7d-9d1a-a1ddf0e705b1","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould proceed anonymously if both JWT and cookie are invalid
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250041279,"env":"test","module":"auth-routes","userId":"99121cb1-1ca7-4681-aa13-29a906edfef9","email":"session-test-XjcdHEzrQfXrF8rBPeukw@example.com","msg":"User registered"}
{"level":30,"time":1768250041352,"env":"test","module":"email-queue","jobId":"20b4ebbd-56cf-4247-890b-b3135b179158","to":"protected-test-o-qlP2ma0tvhKFslwzdk7@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould return 404 for non-existent session ID
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250041399,"env":"test","module":"auth-routes","userId":"d28eee6a-ca19-4a7d-9d1a-a1ddf0e705b1","email":"protected-test-o-qlP2ma0tvhKFslwzdk7@example.com","msg":"User registered"}
{"level":50,"time":1768250041406,"env":"test","module":"auth-routes","userId":"dd2ae85c-ca5d-4741-a3f4-8dd7f39f89e9","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould handle request with both Bearer token and cookies
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250041505,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > optionalHybridAuth Middleware > should proceed anonymously if both JWT and cookie are invalid
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > optionalHybridAuth Middleware > should proceed anonymously if both JWT and cookie are invalid
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:34:01.505Z'
  }
}

{"level":50,"time":1768250041528,"env":"test","module":"auth-routes","userId":"99121cb1-1ca7-4681-aa13-29a906edfef9","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould proceed anonymously if both JWT and cookie are invalid
[22m[39mUser in DB: {
  id: [32m'dd2ae85c-ca5d-4741-a3f4-8dd7f39f89e9'[39m,
  email: [32m'middleware-test-IccGtk_8ECge_Xotbu_jL@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:34:03.943Z[39m,
  updatedAt: [35m2026-01-12T20:34:03.943Z[39m
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould proceed anonymously if both JWT and cookie are invalid
[22m[39mCreds in DB: [90mundefined[39m

{"level":50,"time":1768250041626,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/:sessionId > should return 404 for non-existent session ID
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250041644,"env":"test","module":"auth-routes","userId":"d28eee6a-ca19-4a7d-9d1a-a1ddf0e705b1","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250041748,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250042012,"env":"test","module":"user-credentials-repository","userId":"0a636c34-1f1a-409d-9a0a-5a8aeef5b059","msg":"User credentials created"}
{"level":30,"time":1768250042017,"env":"test","module":"user-credentials-repository","userId":"3269e344-378c-42a1-b148-de072f95e57b","msg":"User credentials created"}
{"level":30,"time":1768250042111,"env":"test","module":"email-queue","jobId":"b1473807-ba2c-4ae9-9797-0208927e1899","to":"middleware-test-oi7D6ga_MBZ7C4h2kgoeb@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250042122,"env":"test","module":"user-credentials-repository","userId":"c5d005c2-6365-44d7-8800-798ce75b8e7d","msg":"User credentials created"}
{"level":30,"time":1768250042127,"env":"test","module":"email-queue","jobId":"9bf6d4e3-601a-4aea-8712-a6861c6d1a6f","to":"session-test-Q2dd_aMDmkrSgzLcsrM9Y@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250042160,"env":"test","module":"auth-routes","userId":"0a636c34-1f1a-409d-9a0a-5a8aeef5b059","email":"middleware-test-oi7D6ga_MBZ7C4h2kgoeb@example.com","msg":"User registered"}
{"level":30,"time":1768250042177,"env":"test","module":"auth-routes","userId":"3269e344-378c-42a1-b148-de072f95e57b","email":"session-test-Q2dd_aMDmkrSgzLcsrM9Y@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mCookie Strategy Security[2m > [22m[2mshould only allow safe methods for cookie auth
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250042218,"env":"test","module":"email-queue","jobId":"22de4e83-84b1-4528-a76a-05c8dd201281","to":"protected-test-VlzdaDxwnjIEZDLuDB-bc@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250042272,"env":"test","module":"auth-routes","userId":"c5d005c2-6365-44d7-8800-798ce75b8e7d","email":"protected-test-VlzdaDxwnjIEZDLuDB-bc@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all sessions except current
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250042349,"env":"test","module":"auth-routes","userId":"0a636c34-1f1a-409d-9a0a-5a8aeef5b059","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould prioritize Bearer token over cookie when both present
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould complete MFA login with valid TOTP code
[22m[39m[TEST UTILS] MFA Secret verified for f8ae4fd7b3184d04815f8913cdc91822

{"level":50,"time":1768250042429,"env":"test","module":"auth-routes","userId":"3269e344-378c-42a1-b148-de072f95e57b","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250042447,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > Cookie Strategy Security > should only allow safe methods for cookie auth
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > Cookie Strategy Security > should only allow safe methods for cookie auth
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:34:02.447Z'
  }
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mCookie Strategy Security[2m > [22m[2mshould only allow safe methods for cookie auth
[22m[39mUser in DB: {
  id: [32m'0a636c34-1f1a-409d-9a0a-5a8aeef5b059'[39m,
  email: [32m'middleware-test-oi7D6ga_MBZ7C4h2kgoeb@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:34:04.872Z[39m,
  updatedAt: [35m2026-01-12T20:34:04.872Z[39m
}

{"level":50,"time":1768250042506,"env":"test","module":"auth-routes","userId":"c5d005c2-6365-44d7-8800-798ce75b8e7d","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250042530,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/all > should revoke all sessions except current
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mCookie Strategy Security[2m > [22m[2mshould only allow safe methods for cookie auth
[22m[39mCreds in DB: [90mundefined[39m

{"level":50,"time":1768250042601,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould complete MFA login with valid TOTP code
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250042797,"env":"test","module":"auth-routes","userId":"f8ae4fd7b3184d04815f8913cdc91822","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250042895,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > MFA Routes > POST /api/auth/mfa/verify-login > should complete MFA login with valid TOTP code
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250042901,"env":"test","module":"user-credentials-repository","userId":"ead781c4-3a3e-4909-89b2-d7975b5809d3","msg":"User credentials created"}
{"level":30,"time":1768250042914,"env":"test","module":"user-credentials-repository","userId":"52d956ae-2f4b-4341-a867-ecea396c0d00","msg":"User credentials created"}
{"level":30,"time":1768250042966,"env":"test","module":"user-credentials-repository","userId":"e8a0d6a4-5d58-4709-9065-36a73dcc4437","msg":"User credentials created"}
{"level":30,"time":1768250042994,"env":"test","module":"email-queue","jobId":"93752edc-66ed-43e7-9fea-a3e0fce618a1","to":"session-test-S1f8x89UziwifsaEHU7lA@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250043011,"env":"test","module":"email-queue","jobId":"52a70dc7-1de9-4a95-9063-1bb27dadd275","to":"middleware-test-48jyBPCWlDEric8fGgEa9@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250043040,"env":"test","module":"auth-routes","userId":"ead781c4-3a3e-4909-89b2-d7975b5809d3","email":"session-test-S1f8x89UziwifsaEHU7lA@example.com","msg":"User registered"}
{"level":30,"time":1768250043061,"env":"test","module":"auth-routes","userId":"52d956ae-2f4b-4341-a867-ecea396c0d00","email":"middleware-test-48jyBPCWlDEric8fGgEa9@example.com","msg":"User registered"}
{"level":30,"time":1768250043065,"env":"test","module":"email-queue","jobId":"7d9dd39f-bdb9-4c16-8875-1fdb9ee3acef","to":"protected-test-1urra_kesbZeFkJlZPPyD@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mCookie Strategy Security[2m > [22m[2mshould ignore cookies when Bearer token present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250043113,"env":"test","module":"auth-routes","userId":"e8a0d6a4-5d58-4709-9065-36a73dcc4437","email":"protected-test-1urra_kesbZeFkJlZPPyD@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all trusted devices
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mOptional Auth Routes[2m > [22m[2mshould allow unauthenticated access to optional auth routes
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250043291,"env":"test","module":"auth-routes","userId":"ead781c4-3a3e-4909-89b2-d7975b5809d3","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250043353,"env":"test","module":"auth-routes","userId":"e8a0d6a4-5d58-4709-9065-36a73dcc4437","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250043393,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/all > should revoke all trusted devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250043445,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should allow unauthenticated access to optional auth routes
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250043574,"env":"test","module":"auth-routes","userId":"52d956ae-2f4b-4341-a867-ecea396c0d00","msg":"User logged in successfully"}
{"level":30,"time":1768250043626,"env":"test","module":"audit-log-service","userId":"52d956ae-2f4b-4341-a867-ecea396c0d00","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250043770,"env":"test","module":"user-credentials-repository","userId":"25b654b0-98bf-44e2-bd6c-a0bd4d9b799b","msg":"User credentials created"}
{"level":30,"time":1768250043823,"env":"test","module":"user-credentials-repository","userId":"3b08cdba-edc1-4bfd-b6bb-229df5ac71e5","msg":"User credentials created"}
{"level":30,"time":1768250043865,"env":"test","module":"email-queue","jobId":"20049670-7c77-49e5-b368-2a326c07119d","to":"session-test-dIwZhBm0TQaU_fZCDIDRX@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250043913,"env":"test","module":"auth-routes","userId":"25b654b0-98bf-44e2-bd6c-a0bd4d9b799b","email":"session-test-dIwZhBm0TQaU_fZCDIDRX@example.com","msg":"User registered"}
{"level":30,"time":1768250043917,"env":"test","module":"email-queue","jobId":"7aee2fc3-0bf7-4caf-8cdf-b7bde2ea60bc","to":"protected-test-ki9svzbz69QwrMeVws6gu@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250043966,"env":"test","module":"auth-routes","userId":"3b08cdba-edc1-4bfd-b6bb-229df5ac71e5","email":"protected-test-ki9svzbz69QwrMeVws6gu@example.com","msg":"User registered"}
{"level":30,"time":1768250043990,"env":"test","module":"user-credentials-repository","userId":"dbdb34aa-00ff-4a89-85d9-bc1e7de11594","msg":"User credentials created"}
{"level":50,"time":1768250044014,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mOptional Auth Routes[2m > [22m[2mshould enhance optional auth routes with user context when authenticated
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250044083,"env":"test","module":"email-queue","jobId":"1ed529e7-183e-4cad-b93a-6b9622bb4870","to":"cookie-test-YH03BFDWEXkMSJLHPmAWw@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould reject invalid MFA code
[22m[39m[TEST UTILS] MFA Secret verified for 2483f760848b58c4bc81aeb6daa641ee

{"level":30,"time":1768250044133,"env":"test","module":"auth-routes","userId":"dbdb34aa-00ff-4a89-85d9-bc1e7de11594","email":"cookie-test-YH03BFDWEXkMSJLHPmAWw@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mCookie Strategy Security[2m > [22m[2mshould ignore cookies when Bearer token present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250044214,"env":"test","module":"auth-routes","userId":"3b08cdba-edc1-4bfd-b6bb-229df5ac71e5","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250044307,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250044340,"env":"test","module":"auth-routes","userId":"dbdb34aa-00ff-4a89-85d9-bc1e7de11594","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250044434,"env":"test","module":"user-credentials-repository","userId":"253c8dc9-d478-407c-9e4a-43b4f81c2b6f","msg":"User credentials created"}
{"level":50,"time":1768250044439,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > Cookie Strategy Security > should ignore cookies when Bearer token present
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768250044517,"env":"test","module":"mfa-service","userId":"2483f760848b58c4bc81aeb6daa641ee","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768250044517,"env":"test","module":"auth-routes","userId":"2483f760848b58c4bc81aeb6daa641ee","msg":"MFA verification failed during login"}
{"level":30,"time":1768250044530,"env":"test","module":"email-queue","jobId":"46e56972-864e-4b82-9248-e7c557452015","to":"session-test-0xs5bAemsK89iMAS10do3@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250044581,"env":"test","module":"auth-routes","userId":"253c8dc9-d478-407c-9e4a-43b4f81c2b6f","email":"session-test-0xs5bAemsK89iMAS10do3@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Expiration[2m > [22m[2mshould reject refresh token after 30 days
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250044713,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250044714,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768250044816,"env":"test","module":"user-credentials-repository","userId":"21dfb996-fcb3-4d8a-aa30-d3a7e8c55499","msg":"User credentials created"}
{"level":50,"time":1768250044838,"env":"test","module":"auth-routes","userId":"253c8dc9-d478-407c-9e4a-43b4f81c2b6f","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250044897,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250044897,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768250044910,"env":"test","module":"email-queue","jobId":"8069a70d-e2f5-4b82-9c54-04c84436fecb","to":"middleware-test-ExoVU0odo-VOdzPfJO61S@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768250044931,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Session Expiration > should reject refresh token after 30 days
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250044959,"env":"test","module":"auth-routes","userId":"21dfb996-fcb3-4d8a-aa30-d3a7e8c55499","email":"middleware-test-ExoVU0odo-VOdzPfJO61S@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mUser Context Attachment[2m > [22m[2mshould attach userId to request
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w1_b0d9d333

 [31mÎ“Â¥Â»[39m tests/integration/auth/protected.routes.test.ts [2m([22m[2m33 tests[22m[2m | [22m[31m31 failed[39m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 72546[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow access with valid Bearer token[39m[33m 953[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject access without Authorization header[39m[33m 879[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject access with empty Bearer token[39m[33m 926[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject access with malformed Authorization header[39m[33m 915[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject access with wrong token type[39m[33m 876[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow POST with valid Bearer token[39m[33m 891[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject POST without Bearer token[39m[33m 888[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject POST with invalid token[39m[33m 870[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow PUT with valid Bearer token [33m 1389[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject PUT without Bearer token[39m[33m 971[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow DELETE with valid Bearer token[39m[33m 896[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject DELETE without Bearer token[39m[33m 879[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow PATCH with valid Bearer token[39m[33m 968[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject PATCH without Bearer token[39m[33m 871[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should handle Bearer token with extra spaces[39m[33m 891[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should handle token with newlines
[31m       [31mâ”œÃ¹[31m should handle very long invalid token[39m[33m 887[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should handle empty Authorization header[39m[33m 865[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should handle Authorization header with only Bearer[39m[33m 880[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should handle multiple Authorization headers[39m[33m 883[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject token with SQL injection attempt[39m[33m 872[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject token with XSS attempt[39m[33m 851[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject token with missing userId[39m[33m 889[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject token with non-existent userId[39m[33m 868[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should not allow user to access another user's resources[39m[33m 2062[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should inject userId into request context[39m[33m 862[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should inject tenantId into request context[39m[33m 860[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should inject role into request context[39m[33m 842[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should not apply general rate limiting to authenticated requests[39m[33m 876[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should handle request with both Bearer token and cookies[39m[33m 864[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prioritize Bearer token over cookie when both present[39m[33m 853[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow unauthenticated access to optional auth routes[39m[33m 846[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should enhance optional auth routes with user context when authenticated[39m[33m 861[2mms[22m[39m
{"level":50,"time":1768250045160,"env":"test","module":"auth-routes","userId":"21dfb996-fcb3-4d8a-aa30-d3a7e8c55499","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w5_56211a6b

{"level":50,"time":1768250045259,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > User Context Attachment > should attach userId to request
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > User Context Attachment > should attach userId to request
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:34:05.259Z'
  }
}

{"level":30,"time":1768250045296,"env":"test","module":"user-credentials-repository","userId":"7a3a72ea-87e6-45f0-9a84-3529356fcc69","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mUser Context Attachment[2m > [22m[2mshould attach userId to request
[22m[39mUser in DB: {
  id: [32m'21dfb996-fcb3-4d8a-aa30-d3a7e8c55499'[39m,
  email: [32m'middleware-test-ExoVU0odo-VOdzPfJO61S@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:34:07.720Z[39m,
  updatedAt: [35m2026-01-12T20:34:07.720Z[39m
}

 [31mÎ“Â¥Â»[39m tests/integration/auth.routes.real.test.ts [2m([22m[2m26 tests[22m[2m | [22m[31m7 failed[39m[2m)[22m[33m 79824[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should register a new user successfully [33m 1532[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 400 for invalid email format [33m 857[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 400 for weak password [33m 836[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 409 for duplicate email [33m 1504[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set httpOnly refresh token cookie [33m 1394[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should login with valid credentials[39m[33m 1505[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for invalid password [33m 1439[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for non-existent user [33m 968[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 403 for unverified email[39m[33m 1586[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should record failed login attempt [33m 1517[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return requiresMfa=true for MFA-enabled users[39m[33m 1908[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should lock account after 5 failed attempts[39m[33m 2776[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should logout and clear refresh token cookie [33m 1791[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should refresh access token with valid refresh token [33m 1967[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for missing refresh token [33m 811[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should rotate refresh token after use [33m 1911[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should send password reset email for existing user [33m 1359[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not reveal if email exists (security) [33m 846[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reset password with valid token[39m[33m 1781[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 400 for invalid token [33m 854[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 400 for weak new password [33m 1454[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return current user for valid token[39m[33m 1406[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for missing token [33m 772[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for invalid token [33m 781[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should complete MFA login with valid TOTP code[39m[33m 1745[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should reject invalid MFA code [33m 1623[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mUser Context Attachment[2m > [22m[2mshould attach userId to request
[22m[39mCreds in DB: [90mundefined[39m

{"level":30,"time":1768250045390,"env":"test","module":"email-queue","jobId":"48cefc85-139a-4d8f-9f86-bdc1cc126fa9","to":"session-test-FekJSMfpbUyKgNZI3GOBm@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250045440,"env":"test","module":"auth-routes","userId":"7a3a72ea-87e6-45f0-9a84-3529356fcc69","email":"session-test-FekJSMfpbUyKgNZI3GOBm@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mConcurrent Session Handling[2m > [22m[2mshould handle multiple concurrent logins
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mConcurrent Session Handling[2m > [22m[2mshould handle multiple concurrent logins
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mConcurrent Session Handling[2m > [22m[2mshould handle multiple concurrent logins
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250045736,"env":"test","module":"user-credentials-repository","userId":"3975c1d4-a5ba-42c0-a02f-ae5d8f1bfed0","msg":"User credentials created"}
{"level":30,"time":1768250045831,"env":"test","module":"email-queue","jobId":"ec0f4645-d830-4341-abd5-43bad90159ce","to":"middleware-test-tJO-yzsigxyNZxN1NlGoj@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250045880,"env":"test","module":"auth-routes","userId":"3975c1d4-a5ba-42c0-a02f-ae5d8f1bfed0","email":"middleware-test-tJO-yzsigxyNZxN1NlGoj@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mUser Context Attachment[2m > [22m[2mshould attach userEmail to request
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250046010,"env":"test","module":"auth-routes","userId":"7a3a72ea-87e6-45f0-9a84-3529356fcc69","msg":"User logged in successfully"}
{"level":30,"time":1768250046057,"env":"test","module":"audit-log-service","userId":"7a3a72ea-87e6-45f0-9a84-3529356fcc69","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250046333,"env":"test","module":"auth-routes","userId":"7a3a72ea-87e6-45f0-9a84-3529356fcc69","msg":"User logged in successfully"}
{"level":30,"time":1768250046361,"env":"test","module":"auth-routes","userId":"7a3a72ea-87e6-45f0-9a84-3529356fcc69","msg":"User logged in successfully"}
{"level":30,"time":1768250046380,"env":"test","module":"audit-log-service","userId":"7a3a72ea-87e6-45f0-9a84-3529356fcc69","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250046395,"env":"test","module":"auth-routes","userId":"3975c1d4-a5ba-42c0-a02f-ae5d8f1bfed0","msg":"User logged in successfully"}
{"level":30,"time":1768250046409,"env":"test","module":"audit-log-service","userId":"7a3a72ea-87e6-45f0-9a84-3529356fcc69","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250046441,"env":"test","module":"audit-log-service","userId":"3975c1d4-a5ba-42c0-a02f-ae5d8f1bfed0","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250046846,"env":"test","module":"user-credentials-repository","userId":"50729cd8-e5de-4f3c-9660-95b5d85c5089","msg":"User credentials created"}
{"level":30,"time":1768250046911,"env":"test","module":"user-credentials-repository","userId":"c86b288b-bf18-489e-81d5-ea482a671790","msg":"User credentials created"}
{"level":30,"time":1768250046941,"env":"test","module":"email-queue","jobId":"a5594aa0-acc1-4fc8-944f-217068f6e010","to":"session-test-bRd7J4R8UPc3_FFylG-BL@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250046989,"env":"test","module":"auth-routes","userId":"50729cd8-e5de-4f3c-9660-95b5d85c5089","email":"session-test-bRd7J4R8UPc3_FFylG-BL@example.com","msg":"User registered"}
{"level":30,"time":1768250047011,"env":"test","module":"email-queue","jobId":"01fdbfd0-c7d5-4948-8abc-7cb2060816e1","to":"middleware-test-lZ5yeP0obO19KcADtAe0a@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250047060,"env":"test","module":"auth-routes","userId":"c86b288b-bf18-489e-81d5-ea482a671790","email":"middleware-test-lZ5yeP0obO19KcADtAe0a@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mConcurrent Session Handling[2m > [22m[2mshould handle concurrent token refreshes
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould return consistent error format for missing token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250047247,"env":"test","module":"auth-routes","userId":"50729cd8-e5de-4f3c-9660-95b5d85c5089","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250047252,"env":"test","module":"auth-routes","userId":"c86b288b-bf18-489e-81d5-ea482a671790","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250047346,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Concurrent Session Handling > should handle concurrent token refreshes
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250047351,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > Error Handling > should return consistent error format for missing token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > Error Handling > should return consistent error format for missing token
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:34:07.352Z'
  }
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould return consistent error format for missing token
[22m[39mUser in DB: {
  id: [32m'c86b288b-bf18-489e-81d5-ea482a671790'[39m,
  email: [32m'middleware-test-lZ5yeP0obO19KcADtAe0a@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:34:09.815Z[39m,
  updatedAt: [35m2026-01-12T20:34:09.815Z[39m
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould return consistent error format for missing token
[22m[39mCreds in DB: [90mundefined[39m

{"level":30,"time":1768250047627,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250047627,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768250047827,"env":"test","module":"user-credentials-repository","userId":"8dff8a08-f5de-490c-af58-d2549738b2f4","msg":"User credentials created"}
{"level":30,"time":1768250047923,"env":"test","module":"email-queue","jobId":"41f0b440-9a33-467b-8694-1b442a4f9ac3","to":"middleware-test-Jk22w0j3IqpUlrbghX-zI@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w4_c99239b9

{"level":30,"time":1768250047971,"env":"test","module":"auth-routes","userId":"8dff8a08-f5de-490c-af58-d2549738b2f4","email":"middleware-test-Jk22w0j3IqpUlrbghX-zI@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould return consistent error format for invalid token
[22m[39mDEBUG: LOGIN HANDLER HIT

 [31mÎ“Â¥Â»[39m tests/integration/auth/session.management.integration.test.ts [2m([22m[2m18 tests[22m[2m | [22m[31m16 failed[39m[2m)[22m[33m 75447[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should create refresh token on login[39m[33m 904[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should track device metadata in session[39m[33m 890[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should create separate sessions for multiple device logins[39m[33m 871[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all active sessions for user[39m[33m 896[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should mark current session correctly[39m[33m 877[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should not include revoked sessions[39m[33m 908[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should order sessions by last used (most recent first)[39m[33m 927[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 631[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific session[39m[33m 880[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking current session[39m[33m 873[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should not allow revoking other users sessions[39m[33m 1468[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 404 for non-existent session ID[39m[33m 886[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke all sessions except current[39m[33m 903[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke all trusted devices[39m[33m 864[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require active session [33m 620[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject refresh token after 30 days[39m[33m 917[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should handle multiple concurrent logins[39m[33m 1538[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should handle concurrent token refreshes[39m[33m 878[2mms[22m[39m
{"level":30,"time":1768250048479,"env":"test","module":"auth-routes","userId":"8dff8a08-f5de-490c-af58-d2549738b2f4","msg":"User logged in successfully"}
{"level":30,"time":1768250048526,"env":"test","module":"audit-log-service","userId":"8dff8a08-f5de-490c-af58-d2549738b2f4","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250048530,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250048895,"env":"test","module":"user-credentials-repository","userId":"0f06e3a1-0d20-4c44-86d4-20e22b5c54ef","msg":"User credentials created"}
{"level":30,"time":1768250048997,"env":"test","module":"email-queue","jobId":"7f0007c4-56bc-4f6e-8cad-81179ef01f4a","to":"middleware-test-rYnMy8KyDB2-wh5uRurOt@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250049044,"env":"test","module":"auth-routes","userId":"0f06e3a1-0d20-4c44-86d4-20e22b5c54ef","email":"middleware-test-rYnMy8KyDB2-wh5uRurOt@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould return consistent error format for expired token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250049559,"env":"test","module":"auth-routes","userId":"0f06e3a1-0d20-4c44-86d4-20e22b5c54ef","msg":"User logged in successfully"}
{"level":30,"time":1768250049612,"env":"test","module":"audit-log-service","userId":"0f06e3a1-0d20-4c44-86d4-20e22b5c54ef","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768250050718,"env":"test","module":"auth-middleware","error":{"name":"TokenExpiredError","code":"AUTH_002","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250050718,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250051086,"env":"test","module":"user-credentials-repository","userId":"0dbc9ac9-9da8-4390-833c-8c7e7713ec07","msg":"User credentials created"}
{"level":30,"time":1768250051189,"env":"test","module":"email-queue","jobId":"847bbea7-6cfd-45ae-9d36-08801aaad066","to":"middleware-test-N6D17taGjwkQjLgeJRW5v@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250051237,"env":"test","module":"auth-routes","userId":"0dbc9ac9-9da8-4390-833c-8c7e7713ec07","email":"middleware-test-N6D17taGjwkQjLgeJRW5v@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould handle malformed JWT gracefully
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250051740,"env":"test","module":"auth-routes","userId":"0dbc9ac9-9da8-4390-833c-8c7e7713ec07","msg":"User logged in successfully"}
{"level":30,"time":1768250051787,"env":"test","module":"audit-log-service","userId":"0dbc9ac9-9da8-4390-833c-8c7e7713ec07","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768250051790,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250051791,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250052151,"env":"test","module":"user-credentials-repository","userId":"596b82fb-ac9d-45b8-b3dd-9965318d9f89","msg":"User credentials created"}
{"level":30,"time":1768250052249,"env":"test","module":"email-queue","jobId":"38a7b6f6-8fbd-45bf-a4b9-40833d205475","to":"middleware-test-SOfQQDgez5zRRvt-uFg6o@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250052298,"env":"test","module":"auth-routes","userId":"596b82fb-ac9d-45b8-b3dd-9965318d9f89","email":"middleware-test-SOfQQDgez5zRRvt-uFg6o@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould handle JWT with wrong algorithm
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250052802,"env":"test","module":"auth-routes","userId":"596b82fb-ac9d-45b8-b3dd-9965318d9f89","msg":"User logged in successfully"}
{"level":30,"time":1768250052851,"env":"test","module":"audit-log-service","userId":"596b82fb-ac9d-45b8-b3dd-9965318d9f89","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768250052855,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250052855,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250053120,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250053120,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w2_3833785b

 [31mÎ“Â¥Â»[39m tests/integration/auth/auth.middleware.integration.test.ts [2m([22m[2m27 tests[22m[2m | [22m[31m19 failed[39m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 80936[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow access with valid JWT Bearer token[39m[33m 977[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 when no token provided [33m 1141[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 401 with invalid token[39m[33m 975[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 401 with expired token[39m[33m 932[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should proceed without authentication if no token provided
[31m       [31mâ”œÃ¹[31m should authenticate with JWT Bearer token[39m[33m 949[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should authenticate with refresh token cookie (GET only)[39m[33m 943[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject cookie auth for POST requests (mutation-strict)[39m[33m 947[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject cookie auth for PUT requests[39m[33m 923[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject cookie auth for DELETE requests[39m[33m 934[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow cookie auth for HEAD requests[39m[33m 927[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prioritize JWT over cookie when both present[39m[33m 955[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 401 when no auth provided[39m[33m 942[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 when both JWT and cookie are invalid [33m 1113[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should authenticate with JWT if provided[39m[33m 924[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should authenticate with cookie if JWT not provided[39m[33m 968[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should proceed anonymously if no auth provided[39m[33m 913[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should proceed anonymously if both JWT and cookie are invalid[39m[33m 935[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should only allow safe methods for cookie auth[39m[33m 942[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should ignore cookies when Bearer token present[39m[33m 1897[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should attach userId to request[39m[33m 912[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should attach userEmail to request [33m 1192[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return consistent error format for missing token[39m[33m 905[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return consistent error format for invalid token [33m 1079[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return consistent error format for expired token [33m 2189[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle malformed JWT gracefully [33m 1072[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle JWT with wrong algorithm [33m 1065[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 98 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Password Reset Flow > should complete full password reset flow
AssertionError: expected 500 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 500

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:332:36
    330|         });
    331| 
    332|       expect(resetResponse.status).toBe(200);
       |                                    ^
    333| 
    334|       // Step 4: Verify old password no longer works

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/98]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Token Refresh Flow > should rotate refresh token on each use
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:405:40
    403| 
    404|       let cookies = loginResponse.headers['set-cookie'] as unknown as Î“Ã‡Âª
    405|       let refreshTokenCookie = cookies.find(c => c.startsWith('refreshÎ“Ã‡Âª
       |                                        ^
    406| 
    407|       expect(refreshTokenCookie).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/98]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Token Refresh Flow > should detect and prevent refresh token reuse (token theft)
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:438:44
    436| 
    437|       const cookies = loginResponse.headers['set-cookie'] as unknown aÎ“Ã‡Âª
    438|       const originalRefreshToken = cookies.find(c => c.startsWith('refÎ“Ã‡Âª
       |                                            ^
    439| 
    440|       // Use token once (rotation happens)

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/98]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Session Management Flow > should list all active sessions
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:492:39
    490|         .set("Authorization", `Bearer ${token}`);
    491| 
    492|       expect(sessionsResponse.status).toBe(200);
       |                                       ^
    493|       expect(sessionsResponse.body.sessions).toBeDefined();
    494|       expect(sessionsResponse.body.sessions.length).toBeGreaterThanOrEÎ“Ã‡Âª

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/98]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Session Management Flow > should revoke specific session
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:517:40
    515| 
    516|       const sessions = sessionsResponse.body.sessions;
    517|       const sessionToRevoke = sessions.find((s: any) => !s.current);
       |                                        ^
    518| 
    519|       // Revoke first session

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/98]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should login with valid credentials
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:138:31
    136|         .send({ email, password });
    137| 
    138|       expect(response.status).toBe(200);
       |                               ^
    139|       expect((response.body as any).message).toBe("Login successful");
    140|       expect((response.body as any).token).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/98]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should return 403 for unverified email
AssertionError: expected 401 to be 403 // Object.is equality

- Expected
+ Received

- 403
+ 401

 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:192:31
    190|         .send({ email, password });
    191| 
    192|       expect(response.status).toBe(403);
       |                               ^
    193|       expect(response.body.message || response.body.error).toBeDefinedÎ“Ã‡Âª
    194|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/98]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should return requiresMfa=true for MFA-enabled users
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:223:31
    221|         .send({ email, password });
    222| 
    223|       expect(response.status).toBe(200);
       |                               ^
    224|       expect(response.body.requiresMfa).toBe(true);
    225|       expect(response.body.userId).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/98]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
AssertionError: expected 401 to be 423 // Object.is equality

- Expected
+ Received

- 423
+ 401

 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:250:31
    248|         });
    249| 
    250|       expect(response.status).toBe(423);
       |                               ^
    251|       expect(response.body).toBeDefined();
    252|       expect(response.body.error || response.body.message).toBeDefinedÎ“Ã‡Âª

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/98]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/reset-password > should reset password with valid token
AssertionError: expected 500 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 500

 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:397:31
    395|         });
    396| 
    397|       expect(response.status).toBe(200);
       |                               ^
    398|       expect(response.body.message).toContain("Password updated");
    399| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/98]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > GET /api/auth/me > should return current user for valid token
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:456:31
    454|         .set("Authorization", `Bearer ${token}`);
    455| 
    456|       expect(response.status).toBe(200);
       |                               ^
    457|       expect(response.body.email).toBe(email);
    458|       expect(response.body.id).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[11/98]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > MFA Routes > POST /api/auth/mfa/verify-login > should complete MFA login with valid TOTP code
AssertionError: expected undefined to be true // Object.is equality

- Expected: 
true

+ Received: 
undefined

 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:486:48
    484|           .send({ email, password });
    485| 
    486|         expect(loginResponse.body.requiresMfa).toBe(true);
       |                                                ^
    487| 
    488|         // Step 2: Verify MFA

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[12/98]Î“Ã„Â»

 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should allow access with valid JWT Bearer token
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should return 401 with invalid token
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should return 401 with expired token
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should authenticate with JWT Bearer token
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should authenticate with refresh token cookie (GET only)
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should reject cookie auth for POST requests (mutation-strict)
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should reject cookie auth for PUT requests
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should reject cookie auth for DELETE requests
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should allow cookie auth for HEAD requests
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should prioritize JWT over cookie when both present
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should return 401 when no auth provided
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > optionalHybridAuth Middleware > should authenticate with JWT if provided
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > optionalHybridAuth Middleware > should authenticate with cookie if JWT not provided
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > optionalHybridAuth Middleware > should proceed anonymously if no auth provided
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > optionalHybridAuth Middleware > should proceed anonymously if both JWT and cookie are invalid
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > Cookie Strategy Security > should only allow safe methods for cookie auth
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > User Context Attachment > should attach userId to request
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > Error Handling > should return consistent error format for missing token
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth/auth.middleware.integration.test.ts:82:33
     80|         }
     81| 
     82|         expect(loginRes.status).toBe(200);
       |                                 ^
     83| 
     84|         userToken = loginRes.body.token;

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[13/98]Î“Ã„Â»

 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > Cookie Strategy Security > should ignore cookies when Bearer token present
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/auth.middleware.integration.test.ts:401:18
    399|                     password: user2.password,
    400|                 })
    401|                 .expect(200);
       |                  ^
    402| 
    403|             // Use user2's Bearer token with user1's cookie
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[14/98]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > JWT Token Generation > should generate valid JWT token on successful login
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:74:18
     72|                     password: testUser.password,
     73|                 })
     74|                 .expect(200);
       |                  ^
     75| 
     76|             expect(loginRes.body.token).toBeDefined();
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[15/98]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > JWT Token Generation > should include correct payload in JWT token
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:103:18
    101|                     password: testUser.password,
    102|                 })
    103|                 .expect(200);
       |                  ^
    104| 
    105|             // Decode token (without verification for inspection)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[16/98]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > JWT Token Validation > should accept valid JWT token on protected routes
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:162:18
    160|                     password: testUser.password,
    161|                 })
    162|                 .expect(200);
       |                  ^
    163| 
    164|             const meRes = await request(ctx.baseURL)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[17/98]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > JWT Token Validation > should accept request with missing Bearer prefix (lenient)
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:201:18
    199|                     password: testUser.password,
    200|                 })
    201|                 .expect(200);
       |                  ^
    202| 
    203|             await request(ctx.baseURL)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[18/98]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > Hybrid Authentication Strategy > should allow GET requests with cookie auth only
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:408:18
    406|                     password: testUser.password,
    407|                 })
    408|                 .expect(200);
       |                  ^
    409| 
    410|             const cookies = loginRes.headers['set-cookie'];
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[19/98]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > Token Refresh Flow > should refresh access token using refresh token
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:521:18
    519|                     password: testUser.password,
    520|                 })
    521|                 .expect(200);
       |                  ^
    522| 
    523|             const cookies = loginRes.headers['set-cookie'];
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[20/98]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > Token Refresh Flow > should rotate refresh token on use
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:566:18
    564|                 .post("/api/auth/refresh-token")
    565|                 .set("Cookie", oldCookies)
    566|                 .expect(200);
       |                  ^
    567| 
    568|             const newCookies = refreshRes1.headers['set-cookie'];
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[21/98]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > Token Refresh Flow > should detect token reuse and revoke all user tokens
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:599:18
    597|                     password: testUser.password,
    598|                 })
    599|                 .expect(200);
       |                  ^
    600| 
    601|             const cookies = loginRes.headers['set-cookie'];
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[22/98]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > Logout Flow > should revoke refresh token on logout
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:650:18
    648|                     password: testUser.password,
    649|                 })
    650|                 .expect(200);
       |                  ^
    651| 
    652|             const cookies = loginRes.headers['set-cookie'];
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[23/98]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > Trusted Devices Management > DELETE /api/auth/trusted-devices/:deviceId > should revoke a trusted device
AssertionError: expected 404 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 404

 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:521:33
    519|           .set('Authorization', `Bearer ${authToken}`);
    520| 
    521|         expect(response.status).toBe(200);
       |                                 ^
    522|         expect(response.body.message).toBe('Device revoked successfullÎ“Ã‡Âª
    523| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[24/98]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > Session Metadata Tracking > should track user agent for sessions
AssertionError: expected undefined to be 'Mozilla/5.0 (Windows NT 10.0; Win64; Î“Ã‡Âª' // Object.is equality

- Expected: 
"Mozilla/5.0 (Windows NT 10.0; Win64; x64)"

+ Received: 
undefined

 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:565:35
    563| 
    564|       const metadata = session?.metadata as any;
    565|       expect(metadata?.userAgent).toBe(userAgent);
       |                                   ^
    566|     });
    567| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[25/98]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > Session Metadata Tracking > should update lastUsedAt on token refresh
AssertionError: expected +0 to be 1 // Object.is equality

- Expected
+ Received

- 1
+ 0

 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:590:31
    588|         ));
    589| 
    590|       expect(sessions.length).toBe(1);
       |                               ^
    591|       expect(sessions[0].lastUsedAt).toBeDefined();
    592|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[26/98]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > POST /api/auth/refresh-token > should update refresh token metadata on rotation
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:225:31
    223|         .set('X-Forwarded-For', '192.168.1.100');
    224| 
    225|       expect(response.status).toBe(200);
       |                               ^
    226| 
    227|       // Check new token has updated metadata

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[27/98]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > POST /api/auth/refresh-token > should set secure cookie in production
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:267:33
    265|           .set('Cookie', `refresh_token=${testRefreshToken}`);
    266| 
    267|         expect(response.status).toBe(200);
       |                                 ^
    268| 
    269|         const setCookieHeader = response.headers['set-cookie']?.[0];

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[28/98]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > POST /api/auth/refresh-token > should set proper cookie attributes
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:283:31
    281|         .set('Cookie', `refresh_token=${testRefreshToken}`);
    282| 
    283|       expect(response.status).toBe(200);
       |                               ^
    284| 
    285|       const setCookieHeader = response.headers['set-cookie']?.[0];

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[29/98]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > POST /api/auth/refresh-token > should include user role information in response
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:298:31
    296|         .set('Cookie', `refresh_token=${testRefreshToken}`);
    297| 
    298|       expect(response.status).toBe(200);
       |                               ^
    299|       expect(response.body.user).toMatchObject({
    300|         id: testUserId,

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[30/98]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > Refresh Token Lifecycle > should create refresh token on login
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:316:31
    314|         });
    315| 
    316|       expect(response.status).toBe(200);
       |                               ^
    317| 
    318|       // Verify refresh token cookie is set

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[31/98]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > Refresh Token Lifecycle > should support multiple active refresh tokens per user
AssertionError: expected 2 to be greater than or equal to 3
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:378:35
    376|         ));
    377| 
    378|       expect(activeTokens.length).toBeGreaterThanOrEqual(3);
       |                                   ^
    379|     });
    380| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[32/98]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > Refresh Token Security > should prevent refresh token reuse after rotation
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:442:36
    440|         .set('Cookie', `refresh_token=${testRefreshToken}`);
    441| 
    442|       expect(firstResponse.status).toBe(200);
       |                                    ^
    443| 
    444|       // Try to reuse old token

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[33/98]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > Cookie Security > should set appropriate expiry (30 days)
AssertionError: expected 'refresh_token=; Max-Age=0; Path=/; HtÎ“Ã‡Âª' to contain 'Max-Age=2592000'

Expected: "Max-Age=2592000"
Received: "refresh_token=; Max-Age=0; Path=/; HttpOnly; SameSite=Strict"

 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:515:31
    513|       const setCookieHeader = response.headers['set-cookie']?.[0];
    514|       // 30 days = 2592000 seconds
    515|       expect(setCookieHeader).toContain('Max-Age=2592000');
       |                               ^
    516|     });
    517|   });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[34/98]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with empty Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with malformed Authorization header
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should reject PUT without Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should allow DELETE with valid Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should reject DELETE without Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should allow PATCH with valid Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should reject PATCH without Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle empty Authorization header
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle multiple Authorization headers
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with SQL injection attempt
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject tenantId into request context
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject role into request context
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Rate Limiting on Protected Routes > should not apply general rate limiting to authenticated requests
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should allow unauthenticated access to optional auth routes
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:80:14
     78|                 password: testUser.password,
     79|             })
     80|             .expect(200);
       |              ^
     81| 
     82|         userToken = loginRes.body.token;
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[35/98]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:341:18
    339|                     password: user2.password,
    340|                 })
    341|                 .expect(200);
       |                  ^
    342| 
    343|             const user2Token = user2LoginRes.body.token;
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[36/98]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Session Creation and Tracking > should create refresh token on login
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:74:18
     72|                     password: testUser.password,
     73|                 })
     74|                 .expect(200);
       |                  ^
     75| 
     76|             expect(loginRes.headers['set-cookie']).toBeDefined();
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[37/98]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Session Creation and Tracking > should track device metadata in session
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:100:18
     98|                     password: testUser.password,
     99|                 })
    100|                 .expect(200);
       |                  ^
    101| 
    102|             const tokens = await db.query.refreshTokens.findMany({
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[38/98]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Session Creation and Tracking > should create separate sessions for multiple device logins
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:120:18
    118|                     password: testUser.password,
    119|                 })
    120|                 .expect(200);
       |                  ^
    121| 
    122|             // Login from device 2
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[39/98]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should list all active sessions for user
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:163:18
    161|                     password: testUser.password,
    162|                 })
    163|                 .expect(200);
       |                  ^
    164| 
    165|             await request(ctx.baseURL)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[40/98]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should mark current session correctly
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:208:18
    206|                     password: testUser.password,
    207|                 })
    208|                 .expect(200);
       |                  ^
    209| 
    210|             await request(ctx.baseURL)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[41/98]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should not include revoked sessions
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:237:18
    235|                     password: testUser.password,
    236|                 })
    237|                 .expect(200);
       |                  ^
    238| 
    239|             const session2 = await request(ctx.baseURL)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[42/98]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should order sessions by last used (most recent first)
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:282:18
    280|                     password: testUser.password,
    281|                 })
    282|                 .expect(200);
       |                  ^
    283| 
    284|             await new Promise(resolve => setTimeout(resolve, 100));
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[43/98]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/:sessionId > should revoke specific session
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:332:18
    330|                     password: testUser.password,
    331|                 })
    332|                 .expect(200);
       |                  ^
    333| 
    334|             const session2 = await request(ctx.baseURL)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[44/98]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/:sessionId > should prevent revoking current session
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:373:18
    371|                     password: testUser.password,
    372|                 })
    373|                 .expect(200);
       |                  ^
    374| 
    375|             const sessionsRes = await request(ctx.baseURL)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[45/98]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/:sessionId > should not allow revoking other users sessions
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:417:18
    415|                     password: user2.password,
    416|                 })
    417|                 .expect(200);
       |                  ^
    418| 
    419|             // User1 tries to get user2's sessions
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[46/98]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/:sessionId > should return 404 for non-existent session ID
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:452:18
    450|                     password: testUser.password,
    451|                 })
    452|                 .expect(200);
       |                  ^
    453| 
    454|             await request(ctx.baseURL)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[47/98]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/all > should revoke all sessions except current
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:471:18
    469|                     password: testUser.password,
    470|                 })
    471|                 .expect(200);
       |                  ^
    472| 
    473|             const session2 = await request(ctx.baseURL)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[48/98]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/all > should revoke all trusted devices
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:523:18
    521|                     password: testUser.password,
    522|                 })
    523|                 .expect(200);
       |                  ^
    524| 
    525|             // Trust device
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[49/98]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Session Expiration > should reject refresh token after 30 days
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:564:18
    562|                     password: testUser.password,
    563|                 })
    564|                 .expect(200);
       |                  ^
    565| 
    566|             // Get the refresh token from database (non-revoked only)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[50/98]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Concurrent Session Handling > should handle multiple concurrent logins
AssertionError: expected +0 to be 3 // Object.is equality

- Expected
+ Received

- 3
+ 0

 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:621:35
    619|             });
    620| 
    621|             expect(tokens.length).toBe(3);
       |                                   ^
    622|         });
    623| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[51/98]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Concurrent Session Handling > should handle concurrent token refreshes
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:631:18
    629|                     password: testUser.password,
    630|                 })
    631|                 .expect(200);
       |                  ^
    632| 
    633|             const cookies = session.headers['set-cookie'];
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[52/98]Î“Ã„Â»


[2m Test Files [22m [1m[31m8 failed[39m[22m[2m | [22m[1m[32m4 passed[39m[22m[90m (12)[39m
[2m      Tests [22m [1m[31m98 failed[39m[22m[2m | [22m[1m[32m192 passed[39m[22m[2m | [22m[33m2 skipped[39m[90m (292)[39m
[2m   Start at [22m 14:32:37
[2m   Duration [22m 95.80s[2m (transform 37.08s, setup 5.23s, import 86.36s, tests 600.00s, environment 2ms)[22m

