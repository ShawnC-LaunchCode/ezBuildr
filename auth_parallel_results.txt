npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w11_3bc9733e

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w10_05118e60

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w11_3bc9733e

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w10_05118e60

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768249279189,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768249279229,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768249279232,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768249279269,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w9_67ac680e

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w9_67ac680e

{"level":30,"time":1768249280153,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768249280203,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w8_b49588c6

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w8_b49588c6

{"level":30,"time":1768249280533,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768249280577,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768249281147,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768249281146,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768249281147,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768249281148,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768249281150,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768249281150,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768249281151,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768249281152,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w6_a749da58

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w7_81596842

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w4_75e616d0

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w0_f96da1d2

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w6_a749da58

{"level":30,"time":1768249281640,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w7_81596842

{"level":30,"time":1768249281665,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768249281668,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w4_75e616d0

{"level":30,"time":1768249281679,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_f96da1d2

{"level":30,"time":1768249281681,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768249281703,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768249281717,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768249281717,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

stderr | tests/integration/auth.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: enum label "skip_to" already exists
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 93,
  severity: 'ERROR',
  code: '42710',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'pg_enum.c',
  line: '348',
  routine: 'AddEnumLabel'
}

stderr | tests/integration/auth/oauth2.client-credentials.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: enum label "skip_to" already exists
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 93,
  severity: 'ERROR',
  code: '42710',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'pg_enum.c',
  line: '348',
  routine: 'AddEnumLabel'
}

{"level":30,"time":1768249282253,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768249282253,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768249282263,"env":"test","status":401,"statusText":"Unauthorized","error":"Invalid client credentials","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768249282263,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768249282265,"env":"test","data":{"token_type":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768249282265,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768249282266,"env":"test","data":{"access_token":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768249282266,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768249282267,"env":"test","error":"Network error: ECONNREFUSED","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768249282372,"env":"test","error":"Invalid credentials","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":50,"time":1768249282372,"env":"test","error":"ECONNREFUSED","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768249282374,"env":"test","status":400,"statusText":"Bad Request","error":"Invalid grant_type","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768249282374,"env":"test","error":"OAuth2 token request failed: 400 Bad Request","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768249282374,"env":"test","status":401,"statusText":"Unauthorized","error":"Client authentication failed","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768249282374,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768249282375,"env":"test","status":403,"statusText":"Forbidden","error":"Access denied","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768249282375,"env":"test","error":"OAuth2 token request failed: 403 Forbidden","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768249282375,"env":"test","status":500,"statusText":"Internal Server Error","error":"Server error","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768249282375,"env":"test","error":"OAuth2 token request failed: 500 Internal Server Error","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768249282375,"env":"test","error":"Unexpected token in JSON","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768249282376,"env":"test","error":"Request timeout","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":30,"time":1768249282377,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768249282377,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w11_3bc9733e

 [32mÎ“Â£Ã´[39m tests/integration/auth.routes.test.ts [2m([22m[2m41 tests[22m[2m)[22m[33m 4810[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w10_05118e60

 [32mÎ“Â£Ã´[39m tests/integration/auth/oauth2.client-credentials.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 4819[2mms[22m[39m
stderr | tests/integration/auth/oauth2.callback.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: enum label "skip_to" already exists
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 93,
  severity: 'ERROR',
  code: '42710',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'pg_enum.c',
  line: '348',
  routine: 'AddEnumLabel'
}

stderr | tests/integration/auth/oauth2.google.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: enum label "skip_to" already exists
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 93,
  severity: 'ERROR',
  code: '42710',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'pg_enum.c',
  line: '348',
  routine: 'AddEnumLabel'
}

{"level":30,"time":1768249283575,"env":"test","connectionId":"d509461b-4b0b-44b5-93bc-f167ed11421b","projectId":"093d522d-5383-4245-951d-97707d911813","name":"Test OAuth2 Connection","type":"oauth2_3leg","msg":"Connection created:"}
{"level":30,"time":1768249284161,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
stderr | tests/integration/auth.routes.real.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: enum label "skip_to" already exists
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 93,
  severity: 'ERROR',
  code: '42710',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'pg_enum.c',
  line: '348',
  routine: 'AddEnumLabel'
}

{"level":50,"time":1768249284402,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:165:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
{"level":50,"time":1768249284403,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:165:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google authentication failed"}
stderr | tests/integration/auth/oauth2.token-refresh.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: enum label "skip_to" already exists
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 93,
  severity: 'ERROR',
  code: '42710',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'pg_enum.c',
  line: '348',
  routine: 'AddEnumLabel'
}

{"level":40,"time":1768249284455,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768249284455,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:89:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:155:23"},"msg":"Google token verification failed"}
{"level":50,"time":1768249284456,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:89:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:155:23"},"msg":"Google authentication failed"}
stderr | tests/integration/auth/oauth2.sessions.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: enum label "skip_to" already exists
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 93,
  severity: 'ERROR',
  code: '42710',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'pg_enum.c',
  line: '348',
  routine: 'AddEnumLabel'
}

stderr | tests/integration/auth.flows.real.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: enum label "skip_to" already exists
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 93,
  severity: 'ERROR',
  code: '42710',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'pg_enum.c',
  line: '348',
  routine: 'AddEnumLabel'
}

{"level":30,"time":1768249284669,"env":"test","connectionId":"b2389670-f623-41dc-88c6-7d208fb7ba9c","projectId":"093d522d-5383-4245-951d-97707d911813","name":"Status Test Connection","type":"oauth2_3leg","msg":"Connection created:"}
{"level":30,"time":1768249284853,"env":"test","module":"auth","email":"existing@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768249285020,"env":"test","module":"user-credentials-repository","userId":"YAoL5Q391K0XQZsLHqm6e","msg":"User credentials created"}
{"level":30,"time":1768249285057,"env":"test","module":"user-credentials-repository","userId":"QTh6pZmGjTYCVyypE3SGG","msg":"User credentials created"}
{"level":30,"time":1768249285100,"env":"test","module":"auth-service","tokenHash":"e7545241f68279c87568533db0416a1b82586c15256b4e314cf9bc8ee1af1951","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768249285262,"env":"test","module":"auth-routes","userId":"QTh6pZmGjTYCVyypE3SGG","sessionCount":2,"msg":"Listed active sessions"}
{"level":30,"time":1768249285274,"env":"test","module":"auth","email":"refresh@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768249285323,"env":"test","module":"user-credentials-repository","userId":"d8e01451-6341-4b31-8f45-bfb7d5b4726c","msg":"User credentials created"}
{"level":30,"time":1768249285374,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768249285375,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768249285427,"env":"test","module":"email-queue","jobId":"30acc51f-36dd-490f-9e60-ecc5c62611dd","to":"test-1768249284907-5bggoh@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249285464,"env":"test","module":"user-credentials-repository","userId":"d8959078-8fa8-41c9-820d-a240d3b88b34","msg":"User credentials created"}
{"level":30,"time":1768249285478,"env":"test","module":"auth-routes","userId":"d8e01451-6341-4b31-8f45-bfb7d5b4726c","email":"test-1768249284907-5bggoh@example.com","msg":"User registered"}
{"level":30,"time":1768249285594,"env":"test","module":"user-credentials-repository","userId":"ZUOFT-3GYkYKi1IwwOLlP","msg":"User credentials created"}
{"level":30,"time":1768249285595,"env":"test","module":"email-queue","jobId":"d2e86288-520e-496f-8c5d-3bbcc3d0e977","to":"test-1768249285062-b955zs@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249285649,"env":"test","module":"user-credentials-repository","userId":"CLPXA0Ugb3JG1TZoR-wOW","msg":"User credentials created"}
{"level":30,"time":1768249285649,"env":"test","module":"auth-routes","userId":"d8959078-8fa8-41c9-820d-a240d3b88b34","email":"test-1768249285062-b955zs@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mComplete Registration Î“Ã¥Ã† Login Flow[2m > [22m[2mshould complete registration, verify email, then login
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w9_67ac680e

{"level":30,"time":1768249285704,"env":"test","module":"auth","email":"idtoken@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768249285705,"env":"test","module":"auth-routes","userId":"ZUOFT-3GYkYKi1IwwOLlP","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768249285710,"env":"test","module":"auth-service","tokenHash":"b953ec7748ec8ce0922feb97598df34397c3b74b96a7b7fdd1fb74aa440480d9","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
 [32mÎ“Â£Ã´[39m tests/integration/auth/oauth2.callback.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 6130[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should initiate OAuth2 3-legged flow and generate authorization URL [33m 328[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should track OAuth2 connection status [33m 351[2mms[22m[39m
{"level":30,"time":1768249286032,"env":"test","module":"user-credentials-repository","userId":"IfcYjf-9sPIetEf5-Ljdj","msg":"User credentials created"}
{"level":40,"time":1768249286040,"env":"test","module":"auth-routes","userId":"d8959078-8fa8-41c9-820d-a240d3b88b34","email":"test-1768249285062-b955zs@example.com","msg":"Login blocked: email not verified"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Complete Registration Î“Ã¥Ã† Login Flow > should complete registration, verify email, then login
Login Failed DEBUG: EmailNotVerifiedError: Please verify your email before logging in. Check your inbox for the verification link.
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:86:11)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_006',
  statusCode: 403,
  isOperational: true
}

{"level":50,"time":1768249286040,"env":"test","module":"auth-routes","error":{"name":"EmailNotVerifiedError","code":"AUTH_006","statusCode":403,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mComplete Registration Î“Ã¥Ã† Login Flow[2m > [22m[2mshould complete registration, verify email, then login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249286116,"env":"test","module":"auth","email":"minimal@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768249286132,"env":"test","module":"auth-routes","userId":"IfcYjf-9sPIetEf5-Ljdj","sessionCount":0,"msg":"Listed active sessions"}
{"level":50,"time":1768249286212,"env":"test","module":"auth","err":{"type":"Error","message":"Token verification failed","stack":"Error: Token verification failed\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:425:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
{"level":50,"time":1768249286245,"env":"test","module":"auth-routes","userId":"d8959078-8fa8-41c9-820d-a240d3b88b34","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":40,"time":1768249286259,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768249286259,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:89:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
{"level":30,"time":1768249286278,"env":"test","module":"user-credentials-repository","userId":"NEw-vG1M-wy5nbUrR-k0G","msg":"User credentials created"}
{"level":50,"time":1768249286310,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token payload","stack":"Error: Invalid token payload\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:85:25)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
{"level":50,"time":1768249286346,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Complete Registration Î“Ã¥Ã† Login Flow > should complete registration, verify email, then login
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w1_61772983

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w5_24318c60

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w2_6e401245

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w3_4c523371

{"level":30,"time":1768249286375,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768249286376,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768249286450,"env":"test","module":"user-credentials-repository","userId":"NbCTcWqu0mTWFsAiqTKVN","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w2_6e401245

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w5_24318c60

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w1_61772983

{"level":30,"time":1768249286508,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768249286508,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768249286507,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w3_4c523371

{"level":30,"time":1768249286515,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768249286535,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768249286536,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768249286539,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768249286546,"env":"test","module":"auth-routes","userId":"NbCTcWqu0mTWFsAiqTKVN","sessionCount":0,"msg":"Listed active sessions"}
{"level":30,"time":1768249286548,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768249286643,"env":"test","module":"user-credentials-repository","userId":"k85-nvkGIxZs-N7qfYt_L","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w8_b49588c6

{"level":30,"time":1768249286694,"env":"test","module":"auth-service","tokenHash":"2fe6f7ff0fa9bd1ee1eb2b4de4567a52a13546270f31f9607e884393806b0e0c","plainTokenLen":19,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768249286743,"env":"test","module":"auth-service","tokenHash":"2fe6f7ff0fa9bd1ee1eb2b4de4567a52a13546270f31f9607e884393806b0e0c","msg":"Security: Unknown refresh token used (Not Found in DB)"}
 [32mÎ“Â£Ã´[39m tests/integration/auth/oauth2.google.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 6750[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should successfully authenticate with valid Google ID token [33m 544[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update existing user on subsequent logins [33m 445[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should create refresh token record in database [33m 423[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should support both "token" and "idToken" fields [33m 380[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle missing profile information gracefully [33m 364[2mms[22m[39m
{"level":30,"time":1768249286794,"env":"test","module":"auth-service","allTokensCount":1,"sampleToken":"6fb1232387e69d3e62664da098175242c5b98e74a4ea4b51f9bcac9db910644b","msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768249286857,"env":"test","module":"user-credentials-repository","userId":"XWwH662M7iEUcVTP9mg6W","msg":"User credentials created"}
{"level":30,"time":1768249287012,"env":"test","module":"auth-routes","userId":"XWwH662M7iEUcVTP9mg6W","sessionCount":0,"msg":"Listed active sessions"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249287110,"env":"test","module":"user-credentials-repository","userId":"c9GUyTn0aDEW8TowgTnO_","msg":"User credentials created"}
{"level":30,"time":1768249287226,"env":"test","module":"auth-service","tokenHash":"719d4f34fd9de961e8180db389d381f3f2fb25ec3f7287005acb16280bd0a506","plainTokenLen":17,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768249287265,"env":"test","module":"auth-routes","userId":"f75a34f4cba862623e013c6a60fb3f94","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":40,"time":1768249287279,"env":"test","module":"auth-service","tokenHash":"719d4f34fd9de961e8180db389d381f3f2fb25ec3f7287005acb16280bd0a506","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768249287325,"env":"test","module":"user-credentials-repository","userId":"bVejHc2aTtcadJiBVb2t4","msg":"User credentials created"}
{"level":30,"time":1768249287328,"env":"test","module":"auth-service","allTokensCount":2,"sampleToken":"c83a93c7e23ab7f5a490d1934c069ffa109c04978b6d25a2a2c3018c347702ef","msg":"DEBUG: Tokens in DB"}
{"level":50,"time":1768249287359,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249287426,"env":"test","module":"auth-routes","userId":"bVejHc2aTtcadJiBVb2t4","sessionCount":1,"msg":"Listed active sessions"}
{"level":50,"time":1768249287518,"env":"test","module":"auth-routes","userId":"f75a34f4cba862623e013c6a60fb3f94","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249287611,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249287646,"env":"test","module":"user-credentials-repository","userId":"gHZS9tTEch2gk8q5Tjz3e","msg":"User credentials created"}
{"level":30,"time":1768249287739,"env":"test","module":"user-credentials-repository","userId":"B-XOYKE7mmGig5D75RxRM","msg":"User credentials created"}
{"level":50,"time":1768249287742,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249287747,"env":"test","module":"auth-service","tokenHash":"64182035b5607867b657cb9559dc27b64cbcae9cc40ec158c4222b92688940f1","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768249287755,"env":"test","module":"auth-routes","userId":"f75a34f4cba862623e013c6a60fb3f94","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":40,"time":1768249287795,"env":"test","module":"auth-service","tokenHash":"64182035b5607867b657cb9559dc27b64cbcae9cc40ec158c4222b92688940f1","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768249287855,"env":"test","module":"auth-service","allTokensCount":0,"msg":"DEBUG: Tokens in DB"}
{"level":50,"time":1768249287854,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249288014,"env":"test","module":"auth-routes","userId":"f75a34f4cba862623e013c6a60fb3f94","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768249288063,"env":"test","module":"user-credentials-repository","userId":"u4dv24ChwsxQfr2P-DJ_Z","msg":"User credentials created"}
{"level":50,"time":1768249288114,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249288190,"env":"test","module":"user-credentials-repository","userId":"pHeRsmezcQI_rxwLmsYOD","msg":"User credentials created"}
{"level":30,"time":1768249288194,"env":"test","module":"user-credentials-repository","userId":"a9577ff0-84dd-4b0f-be94-d8d56c9d9105","msg":"User credentials created"}
{"level":50,"time":1768249288266,"env":"test","module":"auth-routes","userId":"f75a34f4cba862623e013c6a60fb3f94","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768249288275,"env":"test","module":"auth-routes","userId":"u4dv24ChwsxQfr2P-DJ_Z","sessionId":"1ac43d46-f112-40e8-9c30-71fbabeae53c","msg":"Session revoked"}
{"level":30,"time":1768249288290,"env":"test","module":"email-queue","jobId":"469b805f-5d85-4bf0-b1b4-b78045120367","to":"test-1768249287823-06jbg@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249288311,"env":"test","module":"auth-service","tokenHash":"0d3192bb7479d1fd03e74127c8177c88106b0c20c8d62583e105a98d4dffb36b","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768249288336,"env":"test","module":"auth-routes","userId":"a9577ff0-84dd-4b0f-be94-d8d56c9d9105","email":"test-1768249287823-06jbg@example.com","msg":"User registered"}
{"level":40,"time":1768249288366,"env":"test","module":"auth-service","tokenHash":"0d3192bb7479d1fd03e74127c8177c88106b0c20c8d62583e105a98d4dffb36b","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":50,"time":1768249288369,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249288415,"env":"test","module":"auth-service","allTokensCount":2,"sampleToken":"1c3a1ffa82eed88cd7589c64fe526a8498b84ac1ad9599e09b459507ce054afd","msg":"DEBUG: Tokens in DB"}
{"level":50,"time":1768249288518,"env":"test","module":"auth-routes","userId":"f75a34f4cba862623e013c6a60fb3f94","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249288610,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768249288644,"env":"test","module":"user-credentials-repository","userId":"Ij3aeSHbP3ZldOtEOop6z","msg":"User credentials created"}
{"level":30,"time":1768249288732,"env":"test","module":"user-credentials-repository","userId":"4GQQsd5l5voIZLLB-xanN","msg":"User credentials created"}
{"level":30,"time":1768249288788,"env":"test","module":"auth-service","tokenHash":"29f87745eff95c89467e94fbce1e00aa0d67651bf1b57e37854a98b42f629d5e","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768249288967,"env":"test","module":"user-credentials-repository","userId":"F6894Yo7UwXt7X7b05a3J","msg":"User credentials created"}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: enum label "skip_to" already exists
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 93,
  severity: 'ERROR',
  code: '42710',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'pg_enum.c',
  line: '348',
  routine: 'AddEnumLabel'
}

stderr | tests/integration/auth/jwt.authentication.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: enum label "skip_to" already exists
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 93,
  severity: 'ERROR',
  code: '42710',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'pg_enum.c',
  line: '348',
  routine: 'AddEnumLabel'
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: enum label "skip_to" already exists
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 93,
  severity: 'ERROR',
  code: '42710',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'pg_enum.c',
  line: '348',
  routine: 'AddEnumLabel'
}

stderr | tests/integration/auth/session.management.integration.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: enum label "skip_to" already exists
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 93,
  severity: 'ERROR',
  code: '42710',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'pg_enum.c',
  line: '348',
  routine: 'AddEnumLabel'
}

{"level":30,"time":1768249289358,"env":"test","module":"user-credentials-repository","userId":"FFl4gqHgC1lz59b3iYss0","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249289375,"env":"test","module":"user-credentials-repository","userId":"2mk1hzxc1nJHo2eWDeroU","msg":"User credentials created"}
{"level":30,"time":1768249289408,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768249289407,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768249289419,"env":"test","module":"auth-service","tokenHash":"1bc9dc54377bd984e27cd1a98b95ab8d39a93e284c2601ff2dc4eeb6a3270117","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768249289420,"env":"test","module":"auth-service","tokenHash":"1bc9dc54377bd984e27cd1a98b95ab8d39a93e284c2601ff2dc4eeb6a3270117","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768249289422,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39m[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768249289424,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39m[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768249289413,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768249289414,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768249289418,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768249289421,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768249289422,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768249289422,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768249289422,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768249289414,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768249289415,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768249289419,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768249289423,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768249289423,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768249289424,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768249289424,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768249289452,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768249289470,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests
[22m[39m[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768249289460,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768249289460,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768249289464,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768249289469,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768249289469,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768249289470,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768249289470,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768249289496,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768249289498,"env":"test","module":"user-credentials-repository","userId":"9b630b1c-69c0-4fb2-9fc0-dd487c1acc1e","msg":"User credentials created"}
{"level":30,"time":1768249289512,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39m[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768249289503,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768249289503,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768249289508,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768249289511,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768249289511,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768249289512,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768249289512,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768249289587,"env":"test","module":"email-queue","jobId":"c23d3ade-dd5a-4fa8-9eb4-7cf27ae30a15","to":"test-1768249289129-cz2pd@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249289638,"env":"test","module":"auth-routes","userId":"9b630b1c-69c0-4fb2-9fc0-dd487c1acc1e","email":"test-1768249289129-cz2pd@example.com","msg":"User registered"}
{"level":50,"time":1768249289731,"env":"test","module":"auth-routes","email":"test-1768249288991-htl1rc@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":40,"time":1768249289787,"env":"test","module":"auth-service","userId":"FFl4gqHgC1lz59b3iYss0","tokenHash":"1bc9dc54377bd984e27cd1a98b95ab8d39a93e284c2601ff2dc4eeb6a3270117","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":50,"time":1768249289832,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should record all login attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249289880,"env":"test","module":"user-credentials-repository","userId":"3d83c9bf-284c-46c8-84f6-9f47a5b9a087","msg":"User credentials created"}
{"level":30,"time":1768249289886,"env":"test","module":"user-credentials-repository","userId":"2ded59d7-989a-4f74-bb4d-50557d6b2f17","msg":"User credentials created"}
{"level":30,"time":1768249289914,"env":"test","module":"user-credentials-repository","userId":"xEvMstb0ab9Lh0_q_-eKt","msg":"User credentials created"}
{"level":50,"time":1768249289917,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249289925,"env":"test","module":"user-credentials-repository","userId":"02b3effc-6cd8-4162-9a80-eade426afc48","msg":"User credentials created"}
{"level":30,"time":1768249289959,"env":"test","module":"user-credentials-repository","userId":"75919891-5785-4268-94b8-16e35fd59ee4","msg":"User credentials created"}
{"level":30,"time":1768249289983,"env":"test","module":"email-queue","jobId":"60279b40-abca-4858-a7be-598088748433","to":"test-6fGVAjlnAiZuRwtxz_q8Q@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249289988,"env":"test","module":"email-queue","jobId":"7ee2ffd0-6810-4fa8-9131-02597d2c11eb","to":"test-At4UT6x_J0ZAnEdbhPiNh@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249290029,"env":"test","module":"email-queue","jobId":"18f37e69-3584-443b-ae27-3dc6c275289b","to":"test-qsD_Ggu3r4L5P-O8pGsnZ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249290035,"env":"test","module":"auth-routes","userId":"3d83c9bf-284c-46c8-84f6-9f47a5b9a087","email":"test-6fGVAjlnAiZuRwtxz_q8Q@example.com","msg":"User registered"}
{"level":30,"time":1768249290040,"env":"test","module":"auth-routes","userId":"2ded59d7-989a-4f74-bb4d-50557d6b2f17","email":"test-At4UT6x_J0ZAnEdbhPiNh@example.com","msg":"User registered"}
{"level":30,"time":1768249290057,"env":"test","module":"email-queue","jobId":"f745adac-ef67-4659-869f-37319bf80a0a","to":"test-I-MoiDr1Y-8M-bGXS0ppM@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249290080,"env":"test","module":"auth-routes","userId":"02b3effc-6cd8-4162-9a80-eade426afc48","email":"test-qsD_Ggu3r4L5P-O8pGsnZ@example.com","msg":"User registered"}
{"level":30,"time":1768249290109,"env":"test","module":"auth-routes","userId":"75919891-5785-4268-94b8-16e35fd59ee4","email":"test-I-MoiDr1Y-8M-bGXS0ppM@example.com","msg":"User registered"}
{"level":30,"time":1768249290158,"env":"test","module":"user-credentials-repository","userId":"B-DIrh5rSWW5-8a1rYeVz","msg":"User credentials created"}
{"level":50,"time":1768249290198,"env":"test","module":"auth-routes","email":"test-1768249288991-htl1rc@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768249290214,"env":"test","module":"auth-service","tokenHash":"f4c7c8ad51ca06646ea7258698ed4e43f3b97f7ddffd2bfff15625986551c45e","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768249290233,"env":"test","module":"user-credentials-repository","userId":"zkMp5MB4lnXdOjNmAtZe5","msg":"User credentials created"}
{"level":50,"time":1768249290293,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should record all login attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768249290307,"env":"test","module":"auth-service","userId":"B-DIrh5rSWW5-8a1rYeVz","tokenHash":"f4c7c8ad51ca06646ea7258698ed4e43f3b97f7ddffd2bfff15625986551c45e","msg":"Security: REUSED REFRESH TOKEN DETECTED (Concurrent). Revoking all sessions."}
{"level":50,"time":1768249290448,"env":"test","module":"auth-routes","userId":"49f44b99cca25347848f8cf69bf70950","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249290547,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should record all login attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768249290680,"env":"test","module":"auth-routes","userId":"zkMp5MB4lnXdOjNmAtZe5","msg":"All other sessions revoked"}
{"level":30,"time":1768249290680,"env":"test","module":"user-credentials-repository","userId":"b0d51b4f-05fd-4a88-b3c4-e45c25b8c569","msg":"User credentials created"}
{"level":30,"time":1768249290685,"env":"test","module":"user-credentials-repository","userId":"4f53be6e-e658-40da-a28c-4f34d0f90274","msg":"User credentials created"}
{"level":30,"time":1768249290691,"env":"test","module":"user-credentials-repository","userId":"da59d52b-6613-472f-af40-6396b3868167","msg":"User credentials created"}
{"level":30,"time":1768249290692,"env":"test","module":"user-credentials-repository","userId":"PQth_2xSUBwfd44SE2LCc","msg":"User credentials created"}
{"level":30,"time":1768249290729,"env":"test","module":"audit-log-service","userId":"zkMp5MB4lnXdOjNmAtZe5","eventType":"all_sessions_revoked","ipAddress":"::ffff:127.0.0.1","hasMetadata":false,"msg":"Security event logged"}
{"level":30,"time":1768249290737,"env":"test","module":"user-credentials-repository","userId":"3811f94b-7aca-4087-a2f9-cbe53bf56ae4","msg":"User credentials created"}
{"level":30,"time":1768249290745,"env":"test","module":"auth-service","tokenHash":"5ea5f33037dfde0a1a9e28e6395e6f4781fb992384ba132477a305cca06a8229","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould login with valid credentials
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249290784,"env":"test","module":"email-queue","jobId":"55e02ae9-9dd1-42e8-9c1c-ba211a74e355","to":"protected-test-xLGEDQRAwIpaoXjcRTwXC@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249290786,"env":"test","module":"email-queue","jobId":"e3653aec-0f94-437c-a30a-5d154e13a088","to":"session-test-0K9-2YmP8miDG8LTifZCN@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249290793,"env":"test","module":"email-queue","jobId":"79cd38a3-2f50-4868-84c6-40185a70a0d4","to":"jwt-test-HJwkCouONYt8sARwLC5qP@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249290836,"env":"test","module":"auth-routes","userId":"4f53be6e-e658-40da-a28c-4f34d0f90274","email":"protected-test-xLGEDQRAwIpaoXjcRTwXC@example.com","msg":"User registered"}
{"level":30,"time":1768249290838,"env":"test","module":"email-queue","jobId":"0f52d3a5-9809-4aba-8637-551eb12c2af9","to":"middleware-test-r_7t5TUgDPyHHsAF84SND@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249290838,"env":"test","module":"auth-routes","userId":"b0d51b4f-05fd-4a88-b3c4-e45c25b8c569","email":"session-test-0K9-2YmP8miDG8LTifZCN@example.com","msg":"User registered"}
{"level":30,"time":1768249290843,"env":"test","module":"auth-routes","userId":"da59d52b-6613-472f-af40-6396b3868167","email":"jwt-test-HJwkCouONYt8sARwLC5qP@example.com","msg":"User registered"}
{"level":30,"time":1768249290892,"env":"test","module":"auth-routes","userId":"3811f94b-7aca-4087-a2f9-cbe53bf56ae4","email":"middleware-test-r_7t5TUgDPyHHsAF84SND@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould allow access with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Generation[2m > [22m[2mshould generate valid JWT token on successful login
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Creation and Tracking[2m > [22m[2mshould create refresh token on login
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould allow access with valid JWT Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249291086,"env":"test","module":"auth-routes","userId":"4f53be6e-e658-40da-a28c-4f34d0f90274","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249291092,"env":"test","module":"auth-routes","userId":"da59d52b-6613-472f-af40-6396b3868167","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768249291100,"env":"test","module":"user-credentials-repository","userId":"bQgQjYSPDFMZ-hf77jf2w","msg":"User credentials created"}
{"level":50,"time":1768249291106,"env":"test","module":"auth-routes","userId":"b0d51b4f-05fd-4a88-b3c4-e45c25b8c569","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249291108,"env":"test","module":"auth-routes","userId":"3811f94b-7aca-4087-a2f9-cbe53bf56ae4","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249291181,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768249291189,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > JWT Token Generation > should generate valid JWT token on successful login
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768249291202,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Session Creation and Tracking > should create refresh token on login
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768249291210,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should allow access with valid JWT Bearer token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should allow access with valid JWT Bearer token
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:21:31.212Z'
  }
}

{"level":30,"time":1768249291233,"env":"test","module":"auth-routes","userId":"07beb8f8af6e32501177c45a89aabda8","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould allow access with valid JWT Bearer token
[22m[39mUser in DB: {
  id: [32m'3811f94b-7aca-4087-a2f9-cbe53bf56ae4'[39m,
  email: [32m'middleware-test-r_7t5TUgDPyHHsAF84SND@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:21:33.602Z[39m,
  updatedAt: [35m2026-01-12T20:21:33.602Z[39m
}

{"level":30,"time":1768249291280,"env":"test","module":"audit-log-service","userId":"07beb8f8af6e32501177c45a89aabda8","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249291286,"env":"test","module":"user-credentials-repository","userId":"2vuo28SXLPJSy5pEnx1cF","msg":"User credentials created"}
{"level":30,"time":1768249291305,"env":"test","module":"auth-routes","userId":"bQgQjYSPDFMZ-hf77jf2w","msg":"All other sessions revoked"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould allow access with valid JWT Bearer token
[22m[39mCreds in DB: [90mundefined[39m

{"level":30,"time":1768249291342,"env":"test","module":"auth-service","tokenHash":"0360c5de1d234a891f0f3aa8bda4886ef4d0798fc57049248841feb60e748fcb","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768249291355,"env":"test","module":"audit-log-service","userId":"bQgQjYSPDFMZ-hf77jf2w","eventType":"all_sessions_revoked","ipAddress":"::ffff:127.0.0.1","hasMetadata":false,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould complete MFA setup and login with TOTP
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249291560,"env":"test","module":"user-credentials-repository","userId":"36c2fd5e-8b98-4321-b34f-a7be5e4cd04a","msg":"User credentials created"}
{"level":30,"time":1768249291568,"env":"test","module":"user-credentials-repository","userId":"1a804842-a30d-49ec-bfa6-cc2b48abb55d","msg":"User credentials created"}
{"level":30,"time":1768249291598,"env":"test","module":"user-credentials-repository","userId":"0dc87cd6-df03-459c-887a-0bd2e8c3a164","msg":"User credentials created"}
{"level":30,"time":1768249291657,"env":"test","module":"email-queue","jobId":"275c72b5-6033-4c74-bc12-661887089bbb","to":"protected-test--8FOnrE69UnXBKFQrNTmG@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249291666,"env":"test","module":"email-queue","jobId":"fcdee538-7e1e-4bd4-8c50-ce64a507ee0f","to":"jwt-test-Wr5kNXF6EMgSuWpO6RveI@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249291698,"env":"test","module":"user-credentials-repository","userId":"9754cded-16db-43b3-bfa8-32c496750fc2","msg":"User credentials created"}
{"level":30,"time":1768249291697,"env":"test","module":"email-queue","jobId":"03838166-5421-4cad-8835-250ebf32fdda","to":"session-test-8d1djJWna1akOKJCwQ61F@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249291704,"env":"test","module":"auth-routes","userId":"36c2fd5e-8b98-4321-b34f-a7be5e4cd04a","email":"protected-test--8FOnrE69UnXBKFQrNTmG@example.com","msg":"User registered"}
{"level":30,"time":1768249291711,"env":"test","module":"auth-routes","userId":"1a804842-a30d-49ec-bfa6-cc2b48abb55d","email":"jwt-test-Wr5kNXF6EMgSuWpO6RveI@example.com","msg":"User registered"}
{"level":30,"time":1768249291726,"env":"test","module":"user-credentials-repository","userId":"mdJgjsKb7CdKThSRr5dz0","msg":"User credentials created"}
{"level":30,"time":1768249291748,"env":"test","module":"auth-routes","userId":"0dc87cd6-df03-459c-887a-0bd2e8c3a164","email":"session-test-8d1djJWna1akOKJCwQ61F@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Generation[2m > [22m[2mshould include correct payload in JWT token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249291793,"env":"test","module":"email-queue","jobId":"ea9e04c9-fefd-47e4-b8d4-eb489ad50b22","to":"middleware-test-3fn_--MovFb7CLTCokR5b@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould reject access without Authorization header
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249291842,"env":"test","module":"auth-routes","userId":"9754cded-16db-43b3-bfa8-32c496750fc2","email":"middleware-test-3fn_--MovFb7CLTCokR5b@example.com","msg":"User registered"}
{"level":30,"time":1768249291845,"env":"test","module":"auth-routes","userId":"6ad5a7de2b022ba7028e284d08385216","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Creation and Tracking[2m > [22m[2mshould track device metadata in session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249291852,"env":"test","module":"user-credentials-repository","userId":"DFzfMiSh5Ux2f6R2Ym_JN","msg":"User credentials created"}
{"level":30,"time":1768249291892,"env":"test","module":"audit-log-service","userId":"6ad5a7de2b022ba7028e284d08385216","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 when no token provided
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249291905,"env":"test","module":"auth-routes","userId":"1a804842-a30d-49ec-bfa6-cc2b48abb55d","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22m[2mOAuth2 Token Refresh Flow[2m > [22m[2mRefresh Token Lifecycle[2m > [22m[2mshould create refresh token on login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249291949,"env":"test","module":"auth-routes","userId":"36c2fd5e-8b98-4321-b34f-a7be5e4cd04a","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249291998,"env":"test","module":"auth-routes","userId":"0dc87cd6-df03-459c-887a-0bd2e8c3a164","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249292004,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > JWT Token Generation > should include correct payload in JWT token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768249292046,"env":"test","module":"user-credentials-repository","userId":"UoMB1GBdN1ZfT6z004GJz","msg":"User credentials created"}
{"level":50,"time":1768249292049,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768249292049,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768249292051,"env":"test","module":"auth-routes","userId":"9754cded-16db-43b3-bfa8-32c496750fc2","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249292058,"env":"test","module":"auth-routes","userId":"DFzfMiSh5Ux2f6R2Ym_JN","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249292105,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Session Creation and Tracking > should track device metadata in session
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768249292148,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should return 401 when no token provided
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should return 401 when no token provided
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:21:32.149Z'
  }
}

{"level":50,"time":1768249292161,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > Refresh Token Lifecycle > should create refresh token on login
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 when no token provided
[22m[39mUser in DB: {
  id: [32m'9754cded-16db-43b3-bfa8-32c496750fc2'[39m,
  email: [32m'middleware-test-3fn_--MovFb7CLTCokR5b@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:21:34.577Z[39m,
  updatedAt: [35m2026-01-12T20:21:34.577Z[39m
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 when no token provided
[22m[39mCreds in DB: [90mundefined[39m

{"level":30,"time":1768249292337,"env":"test","module":"mfa-service","userId":"6ad5a7de2b022ba7028e284d08385216","count":10,"msg":"Stored backup codes"}
{"level":30,"time":1768249292337,"env":"test","module":"mfa-service","userId":"6ad5a7de2b022ba7028e284d08385216","msg":"Generated TOTP secret"}
{"level":30,"time":1768249292337,"env":"test","module":"auth-routes","userId":"6ad5a7de2b022ba7028e284d08385216","msg":"MFA setup initiated"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for invalid password
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249292374,"env":"test","module":"user-credentials-repository","userId":"YOSU9R9NeFlfcAf6odanN","msg":"User credentials created"}
{"level":30,"time":1768249292381,"env":"test","module":"user-credentials-repository","userId":"c513b0e3-778c-4fed-ad84-427d8cdeae7a","msg":"User credentials created"}
{"level":30,"time":1768249292429,"env":"test","module":"user-credentials-repository","userId":"14d0547a-5487-4030-9844-90c808dc2536","msg":"User credentials created"}
{"level":30,"time":1768249292477,"env":"test","module":"email-queue","jobId":"7a5bc93b-06a1-4b9b-9629-0b3bd1bd1943","to":"jwt-test-P-yZt942UBs291F9G8FMo@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249292481,"env":"test","module":"auth-routes","userId":"YOSU9R9NeFlfcAf6odanN","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Device marked as trusted"}
{"level":30,"time":1768249292484,"env":"test","module":"user-credentials-repository","userId":"487e34d6-7f81-4aca-bc98-6b69d0892cca","msg":"User credentials created"}
{"level":30,"time":1768249292495,"env":"test","module":"user-credentials-repository","userId":"Zi8ULnqJVK8jEJl8_VQY-","msg":"User credentials created"}
{"level":30,"time":1768249292523,"env":"test","module":"email-queue","jobId":"13ac9b8a-fdc5-4a7e-8968-0dfbaf44efe9","to":"protected-test-o-6qJn8hhv5wsetDelq-B@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249292529,"env":"test","module":"auth-routes","userId":"c513b0e3-778c-4fed-ad84-427d8cdeae7a","email":"jwt-test-P-yZt942UBs291F9G8FMo@example.com","msg":"User registered"}
{"level":30,"time":1768249292570,"env":"test","module":"auth-routes","userId":"14d0547a-5487-4030-9844-90c808dc2536","email":"protected-test-o-6qJn8hhv5wsetDelq-B@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Generation[2m > [22m[2mshould set JWT expiry to 15 minutes
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249292589,"env":"test","module":"email-queue","jobId":"ed7ef869-6d23-4282-ac6e-e03991d8b8d7","to":"session-test-QTDEymYi_EoRzh1-cyUcA@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249292615,"env":"test","module":"user-credentials-repository","userId":"9f850d6e-bcb3-46dd-bd0b-788c9d353e41","msg":"User credentials created"}
{"level":30,"time":1768249292633,"env":"test","module":"mfa-service","userId":"6ad5a7de2b022ba7028e284d08385216","msg":"MFA enabled successfully"}
{"level":30,"time":1768249292634,"env":"test","module":"auth-routes","userId":"6ad5a7de2b022ba7028e284d08385216","msg":"MFA enabled successfully"}
{"level":30,"time":1768249292640,"env":"test","module":"auth-routes","userId":"487e34d6-7f81-4aca-bc98-6b69d0892cca","email":"session-test-QTDEymYi_EoRzh1-cyUcA@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould reject access with empty Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249292685,"env":"test","module":"audit-log-service","userId":"6ad5a7de2b022ba7028e284d08385216","eventType":"mfa_enabled","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould complete MFA setup and login with TOTP
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249292714,"env":"test","module":"email-queue","jobId":"15a865a4-2772-493e-bd19-a287dd4b9797","to":"middleware-test-iiioSf3Sm0RPs-iuleQUf@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768249292724,"env":"test","module":"auth-routes","email":"test-1768249292003-vb7s0g@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Creation and Tracking[2m > [22m[2mshould create separate sessions for multiple device logins
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249292765,"env":"test","module":"auth-routes","userId":"9f850d6e-bcb3-46dd-bd0b-788c9d353e41","email":"middleware-test-iiioSf3Sm0RPs-iuleQUf@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 with invalid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249292824,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should return 401 for invalid password
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768249292838,"env":"test","module":"auth-routes","userId":"6ad5a7de2b022ba7028e284d08385216","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768249292852,"env":"test","module":"user-credentials-repository","userId":"tR3EpQ7GMj_DYKyp6miyl","msg":"User credentials created"}
{"level":50,"time":1768249292956,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > MFA Enrollment and Login Flow > should complete MFA setup and login with TOTP
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768249292965,"env":"test","module":"auth-routes","userId":"tR3EpQ7GMj_DYKyp6miyl","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Device marked as trusted"}
{"level":30,"time":1768249292965,"env":"test","module":"user-credentials-repository","userId":"x25p0CrCMpWRX0jNTw0Tk","msg":"User credentials created"}
{"level":30,"time":1768249293046,"env":"test","module":"auth-routes","userId":"c513b0e3-778c-4fed-ad84-427d8cdeae7a","msg":"User logged in successfully"}
{"level":30,"time":1768249293097,"env":"test","module":"audit-log-service","userId":"c513b0e3-778c-4fed-ad84-427d8cdeae7a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249293116,"env":"test","module":"auth-routes","userId":"tR3EpQ7GMj_DYKyp6miyl","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Device marked as trusted"}
{"level":30,"time":1768249293194,"env":"test","module":"auth-routes","userId":"14d0547a-5487-4030-9844-90c808dc2536","msg":"User logged in successfully"}
{"level":30,"time":1768249293237,"env":"test","module":"auth-routes","userId":"487e34d6-7f81-4aca-bc98-6b69d0892cca","msg":"User logged in successfully"}
{"level":30,"time":1768249293242,"env":"test","module":"audit-log-service","userId":"14d0547a-5487-4030-9844-90c808dc2536","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768249293246,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249293290,"env":"test","module":"audit-log-service","userId":"487e34d6-7f81-4aca-bc98-6b69d0892cca","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Creation and Tracking[2m > [22m[2mshould create separate sessions for multiple device logins
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249293297,"env":"test","module":"auth-routes","userId":"9f850d6e-bcb3-46dd-bd0b-788c9d353e41","msg":"User logged in successfully"}
{"level":30,"time":1768249293329,"env":"test","module":"user-credentials-repository","userId":"sA5pTXKltHPifbJfK3s5L","msg":"User credentials created"}
{"level":30,"time":1768249293349,"env":"test","module":"audit-log-service","userId":"9f850d6e-bcb3-46dd-bd0b-788c9d353e41","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768249293353,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768249293451,"env":"test","module":"auth-routes","userId":"487e34d6-7f81-4aca-bc98-6b69d0892cca","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768249293477,"env":"test","module":"user-credentials-repository","userId":"10a32837-d6e6-4210-a130-fb3af2f2be04","msg":"User credentials created"}
{"level":30,"time":1768249293483,"env":"test","module":"user-credentials-repository","userId":"q3CQpcjoT74S-REPCb86H","msg":"User credentials created"}
{"level":50,"time":1768249293559,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Session Creation and Tracking > should create separate sessions for multiple device logins
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768249293577,"env":"test","module":"email-queue","jobId":"0fb37d59-3007-4cd6-b8d8-4353e47ffdba","to":"jwt-test-4qZxmY1zNiaWYlzxulKhX@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249293595,"env":"test","module":"auth-routes","userId":"q3CQpcjoT74S-REPCb86H","deviceCount":2,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for non-existent user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249293617,"env":"test","module":"user-credentials-repository","userId":"8eb8ae3c-5eee-4adb-9275-7a07901a14bc","msg":"User credentials created"}
{"level":30,"time":1768249293625,"env":"test","module":"auth-routes","userId":"10a32837-d6e6-4210-a130-fb3af2f2be04","email":"jwt-test-4qZxmY1zNiaWYlzxulKhX@example.com","msg":"User registered"}
{"level":50,"time":1768249293655,"env":"test","module":"auth-routes","email":"nonexistent@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Validation[2m > [22m[2mshould accept valid JWT token on protected routes
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould login with backup code when TOTP unavailable
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249293712,"env":"test","module":"email-queue","jobId":"cde401a4-9101-4e6d-861f-d31b9efb206d","to":"protected-test-8VicZSE26KSOMJrY7i8Va@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249293727,"env":"test","module":"user-credentials-repository","userId":"ae03a263-895c-4067-a7c6-af27c44846a9","msg":"User credentials created"}
{"level":50,"time":1768249293755,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should return 401 for non-existent user
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:51:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768249293761,"env":"test","module":"auth-routes","userId":"8eb8ae3c-5eee-4adb-9275-7a07901a14bc","email":"protected-test-8VicZSE26KSOMJrY7i8Va@example.com","msg":"User registered"}
{"level":30,"time":1768249293825,"env":"test","module":"email-queue","jobId":"9c805f32-fc9a-47cb-bd57-434d6bb3c51b","to":"middleware-test-ZGIIne0fWKItfHU3MnK8w@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768249293828,"env":"test","module":"auth-routes","userId":"10a32837-d6e6-4210-a130-fb3af2f2be04","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768249293851,"env":"test","module":"user-credentials-repository","userId":"hXsmNcBh44RbEPfPFzEOH","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould reject access with malformed Authorization header
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249293876,"env":"test","module":"auth-routes","userId":"ae03a263-895c-4067-a7c6-af27c44846a9","email":"middleware-test-ZGIIne0fWKItfHU3MnK8w@example.com","msg":"User registered"}
{"level":30,"time":1768249293922,"env":"test","module":"user-credentials-repository","userId":"WLjigviFuYQAra-Moiyys","msg":"User credentials created"}
{"level":50,"time":1768249293926,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > JWT Token Validation > should accept valid JWT token on protected routes
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 with expired token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249293931,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768249293936,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249293955,"env":"test","module":"user-credentials-repository","userId":"f23fe829-60f0-4018-861c-e5d4004ba8b7","msg":"User credentials created"}
{"level":30,"time":1768249294022,"env":"test","module":"auth-routes","userId":"WLjigviFuYQAra-Moiyys","deviceCount":0,"msg":"Listed trusted devices"}
{"level":30,"time":1768249294071,"env":"test","module":"email-queue","jobId":"a600c465-5d81-49ae-b20b-1238c41e75b0","to":"session-test-OeHAO54jzDXVewfjtQ8GS@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249294125,"env":"test","module":"auth-routes","userId":"f23fe829-60f0-4018-861c-e5d4004ba8b7","email":"session-test-OeHAO54jzDXVewfjtQ8GS@example.com","msg":"User registered"}
{"level":30,"time":1768249294172,"env":"test","module":"auth-routes","userId":"fb56bffe8595320e129ff1edd929d9db","msg":"User logged in successfully"}
{"level":30,"time":1768249294218,"env":"test","module":"audit-log-service","userId":"fb56bffe8595320e129ff1edd929d9db","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249294310,"env":"test","module":"user-credentials-repository","userId":"30452714-668e-4229-8800-ad998bd3f319","msg":"User credentials created"}
{"level":30,"time":1768249294351,"env":"test","module":"user-credentials-repository","userId":"Yang1X5Sg9QCFyvvwgjeC","msg":"User credentials created"}
{"level":30,"time":1768249294379,"env":"test","module":"auth-routes","userId":"8eb8ae3c-5eee-4adb-9275-7a07901a14bc","msg":"User logged in successfully"}
{"level":50,"time":1768249294391,"env":"test","module":"auth-routes","userId":"f23fe829-60f0-4018-861c-e5d4004ba8b7","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768249294409,"env":"test","module":"auth-routes","userId":"ae03a263-895c-4067-a7c6-af27c44846a9","msg":"User logged in successfully"}
{"level":30,"time":1768249294415,"env":"test","module":"email-queue","jobId":"01ea83c6-b30a-4971-8bd3-111d9c4fffe6","to":"jwt-test-wak8GaQWIofXzQDwjW_1Z@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249294428,"env":"test","module":"user-credentials-repository","userId":"SIpujgeItrkK6Pw28oW_p","msg":"User credentials created"}
{"level":30,"time":1768249294433,"env":"test","module":"audit-log-service","userId":"8eb8ae3c-5eee-4adb-9275-7a07901a14bc","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768249294439,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249294463,"env":"test","module":"audit-log-service","userId":"ae03a263-895c-4067-a7c6-af27c44846a9","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249294467,"env":"test","module":"auth-routes","userId":"30452714-668e-4229-8800-ad998bd3f319","email":"jwt-test-wak8GaQWIofXzQDwjW_1Z@example.com","msg":"User registered"}
{"level":50,"time":1768249294491,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should list all active sessions for user
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768249294506,"env":"test","module":"auth-routes","userId":"Yang1X5Sg9QCFyvvwgjeC","deviceId":"ba61bc63-5144-4298-bead-f249db55102b","msg":"Trusted device revoked"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Validation[2m > [22m[2mshould accept request with missing Bearer prefix (lenient)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249294648,"env":"test","module":"mfa-service","userId":"fb56bffe8595320e129ff1edd929d9db","count":10,"msg":"Stored backup codes"}
{"level":30,"time":1768249294648,"env":"test","module":"mfa-service","userId":"fb56bffe8595320e129ff1edd929d9db","msg":"Generated TOTP secret"}
{"level":30,"time":1768249294648,"env":"test","module":"auth-routes","userId":"fb56bffe8595320e129ff1edd929d9db","msg":"MFA setup initiated"}
{"level":50,"time":1768249294663,"env":"test","module":"auth-routes","userId":"30452714-668e-4229-8800-ad998bd3f319","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249294756,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > JWT Token Validation > should accept request with missing Bearer prefix (lenient)
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768249294761,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768249294762,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249294820,"env":"test","module":"user-credentials-repository","userId":"2c8b012e-ccd6-44eb-b227-6dc5e89c02da","msg":"User credentials created"}
{"level":30,"time":1768249294869,"env":"test","module":"user-credentials-repository","userId":"de010a5b-d11b-47ba-ba4c-d314e845f40a","msg":"User credentials created"}
{"level":30,"time":1768249294883,"env":"test","module":"user-credentials-repository","userId":"rw4SiLStSY4PAsklbVejX","msg":"User credentials created"}
{"level":30,"time":1768249294893,"env":"test","module":"user-credentials-repository","userId":"07ac2a32-3ca4-44fb-b7a9-a1d53e54ad6d","msg":"User credentials created"}
{"level":30,"time":1768249294914,"env":"test","module":"email-queue","jobId":"9cfbbd97-7b1a-4210-b451-48daed123565","to":"protected-test-75SlZK7L_L8L7_xPAUKGl@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249294960,"env":"test","module":"auth-routes","userId":"2c8b012e-ccd6-44eb-b227-6dc5e89c02da","email":"protected-test-75SlZK7L_L8L7_xPAUKGl@example.com","msg":"User registered"}
{"level":30,"time":1768249294968,"env":"test","module":"email-queue","jobId":"5042b968-7923-4c41-95c2-8f12450ca12d","to":"session-test-i4rdlf7QlzY2pH-PZZhYJ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249294994,"env":"test","module":"email-queue","jobId":"41a2fac4-9478-496d-ba49-c0a7bb651073","to":"test-1768249294524-icqp3w@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249295016,"env":"test","module":"auth-routes","userId":"de010a5b-d11b-47ba-ba4c-d314e845f40a","email":"session-test-i4rdlf7QlzY2pH-PZZhYJ@example.com","msg":"User registered"}
{"level":30,"time":1768249295040,"env":"test","module":"auth-routes","userId":"07ac2a32-3ca4-44fb-b7a9-a1d53e54ad6d","email":"test-1768249294524-icqp3w@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 403 for unverified email
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould reject access with wrong token type
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249295191,"env":"test","module":"auth-routes","userId":"07ac2a32-3ca4-44fb-b7a9-a1d53e54ad6d","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249295206,"env":"test","module":"auth-routes","userId":"2c8b012e-ccd6-44eb-b227-6dc5e89c02da","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768249295218,"env":"test","module":"user-credentials-repository","userId":"4wvIBiTRbbun8UVHXLjXa","msg":"User credentials created"}
{"level":50,"time":1768249295280,"env":"test","module":"auth-routes","userId":"de010a5b-d11b-47ba-ba4c-d314e845f40a","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249295290,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should return 403 for unverified email
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768249295300,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768249295379,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should mark current session correctly
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768249295569,"env":"test","module":"auth-middleware","error":{"name":"TokenExpiredError","code":"AUTH_002","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768249295569,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249295634,"env":"test","module":"user-credentials-repository","userId":"2rGYcnDaMVpdjkd8Tk6yl","msg":"User credentials created"}
{"level":30,"time":1768249295676,"env":"test","module":"user-credentials-repository","userId":"04ecbca7-feec-438a-bdf0-49ec71045e36","msg":"User credentials created"}
{"level":30,"time":1768249295690,"env":"test","module":"email-queue","jobId":"930db203-0a0b-4e8f-a02c-bab1ca0ca45a","to":"test-1768249295124-hzpqv@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249295690,"env":"test","module":"auth-service","email":"test-1768249295124-hzpqv@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768249295759,"env":"test","module":"user-credentials-repository","userId":"1ab06f24-04b5-4b26-8003-e9b39347330c","msg":"User credentials created"}
{"level":30,"time":1768249295772,"env":"test","module":"email-queue","jobId":"2c73cae8-969f-4b08-9431-bc491a900005","to":"protected-test-N1x3MLOCGAZry30ISZZQh@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249295823,"env":"test","module":"auth-routes","userId":"04ecbca7-feec-438a-bdf0-49ec71045e36","email":"protected-test-N1x3MLOCGAZry30ISZZQh@example.com","msg":"User registered"}
{"level":30,"time":1768249295861,"env":"test","module":"email-queue","jobId":"5fd196de-8e22-4558-bc44-da0f35845b86","to":"session-test-ue5eqozATXQDcPmjsl2d1@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":40,"time":1768249295865,"env":"test","module":"auth-middleware","error":{"name":"TokenExpiredError","code":"AUTH_002","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768249295865,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249295909,"env":"test","module":"auth-routes","userId":"1ab06f24-04b5-4b26-8003-e9b39347330c","email":"session-test-ue5eqozATXQDcPmjsl2d1@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPOST Protected Routes[2m > [22m[2mshould allow POST with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249295940,"env":"test","module":"user-credentials-repository","userId":"8e161060-99af-4e33-b25b-f452a6f06436","msg":"User credentials created"}
{"level":30,"time":1768249295973,"env":"test","module":"email-queue","jobId":"b99365b8-62fb-4df9-8c7a-dcd93315ba01","to":"test-1768249295124-hzpqv@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249295973,"env":"test","module":"auth-service","email":"test-1768249295124-hzpqv@example.com","msg":"Password reset email sent"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould not include revoked sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249296041,"env":"test","module":"email-queue","jobId":"6d0ab3a9-e0b3-4613-996e-7d1b69b02ddf","to":"middleware-test-UdXI0sXMmxnijTQPCjqE0@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249296048,"env":"test","module":"user-credentials-repository","userId":"JOJodnHgwPjuQm1-ztVl5","msg":"User credentials created"}
{"level":50,"time":1768249296065,"env":"test","module":"auth-routes","userId":"04ecbca7-feec-438a-bdf0-49ec71045e36","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768249296090,"env":"test","module":"auth-routes","userId":"8e161060-99af-4e33-b25b-f452a6f06436","email":"middleware-test-UdXI0sXMmxnijTQPCjqE0@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould authenticate with JWT Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249296161,"env":"test","module":"auth-routes","userId":"1ab06f24-04b5-4b26-8003-e9b39347330c","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249296175,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768249296256,"env":"test","module":"auth-service","tokenHash":"ebd4c4b0aea158be9e1f092673737c3105d98aba54ad42b0b03b6ec5791cbe04","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768249296256,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should not include revoked sessions
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768249296287,"env":"test","module":"auth-routes","userId":"8e161060-99af-4e33-b25b-f452a6f06436","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249296368,"env":"test","module":"user-credentials-repository","error":{},"userId":"99d4edf3f07b7b4704e9f8dd111dbd4f","msg":"Failed to update user password"}
{"level":50,"time":1768249296368,"env":"test","module":"auth-routes","error":{},"msg":"Reset password error"}
{"level":50,"time":1768249296386,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should authenticate with JWT Bearer token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should authenticate with JWT Bearer token
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:21:36.386Z'
  }
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould record failed login attempt
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould authenticate with JWT Bearer token
[22m[39mUser in DB: {
  id: [32m'8e161060-99af-4e33-b25b-f452a6f06436'[39m,
  email: [32m'middleware-test-UdXI0sXMmxnijTQPCjqE0@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:21:38.831Z[39m,
  updatedAt: [35m2026-01-12T20:21:38.831Z[39m
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould authenticate with JWT Bearer token
[22m[39mCreds in DB: [90mundefined[39m

{"level":30,"time":1768249296507,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768249296508,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768249296547,"env":"test","module":"user-credentials-repository","userId":"835335e3-cb5f-4441-8247-001d1cb41107","msg":"User credentials created"}
{"level":30,"time":1768249296647,"env":"test","module":"email-queue","jobId":"d5a37ba0-eb80-457d-bd56-ba3e89fb05f4","to":"protected-test-5LK59qXVls_82wdjEs1Rb@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249296649,"env":"test","module":"user-credentials-repository","userId":"29248bba-bd90-4ec1-b69e-12427cff3286","msg":"User credentials created"}
{"level":30,"time":1768249296696,"env":"test","module":"auth-routes","userId":"835335e3-cb5f-4441-8247-001d1cb41107","email":"protected-test-5LK59qXVls_82wdjEs1Rb@example.com","msg":"User registered"}
{"level":30,"time":1768249296744,"env":"test","module":"email-queue","jobId":"8e295adc-ca46-42ba-837f-31e3a507a452","to":"session-test-S4ZBI42dBHd8cuO7iSG3R@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768249296784,"env":"test","module":"auth-routes","email":"test-1768249296045-hezg7c@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768249296794,"env":"test","module":"auth-routes","userId":"29248bba-bd90-4ec1-b69e-12427cff3286","email":"session-test-S4ZBI42dBHd8cuO7iSG3R@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPOST Protected Routes[2m > [22m[2mshould reject POST without Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w7_81596842

{"level":30,"time":1768249296857,"env":"test","module":"user-credentials-repository","userId":"b25357c5-b686-497f-bcb7-bced74ffe4b4","msg":"User credentials created"}
{"level":50,"time":1768249296875,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should record failed login attempt
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

 [31mÎ“Â¥Â»[39m tests/integration/auth/oauth2.sessions.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 15748[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should list all active sessions for current user [33m 544[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should mark current session as current [33m 436[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return empty array when user has no active sessions [33m 428[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not include expired sessions [33m 413[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not include revoked sessions [33m 466[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should parse device name from user agent [33m 414[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for unauthenticated request [33m 317[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke a specific session [33m 581[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 404 for non-existent session [33m 324[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking current session[39m[33m 417[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prevent revoking another user's session [33m 517[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for unauthenticated request [33m 334[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke all sessions except current [33m 862[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke all trusted devices [33m 627[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 400 when no active session found [33m 323[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for unauthenticated request [33m 320[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should mark current device as trusted [33m 483[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should update existing trusted device expiry[39m[33m 633[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should list all trusted devices [33m 431[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should not include revoked devices [33m 427[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should revoke a trusted device [33m 534[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should return 404 for non-existent device [33m 330[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should track IP address for sessions [33m 427[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should track user agent for sessions [33m 412[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update lastUsedAt on token refresh [33m 779[2mms[22m[39m
{"level":50,"time":1768249296945,"env":"test","module":"auth-routes","userId":"835335e3-cb5f-4441-8247-001d1cb41107","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768249296955,"env":"test","module":"email-queue","jobId":"d4fcc93e-56bd-4f48-b03a-20a55579fe84","to":"middleware-test-2abmS4MiYiLofdEQmG4K_@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":40,"time":1768249296970,"env":"test","module":"auth-middleware","error":{"name":"TokenExpiredError","code":"AUTH_002","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768249296970,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249297010,"env":"test","module":"auth-routes","userId":"b25357c5-b686-497f-bcb7-bced74ffe4b4","email":"middleware-test-2abmS4MiYiLofdEQmG4K_@example.com","msg":"User registered"}
{"level":50,"time":1768249297039,"env":"test","module":"auth-routes","userId":"29248bba-bd90-4ec1-b69e-12427cff3286","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249297045,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould authenticate with refresh token cookie (GET only)
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mPassword Reset Flow[2m > [22m[2mshould invalidate all sessions after password reset
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249297141,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should order sessions by last used (most recent first)
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768249297410,"env":"test","module":"user-credentials-repository","userId":"f561a1ba-f88c-4743-b546-5cca12d8bad2","msg":"User credentials created"}
{"level":30,"time":1768249297511,"env":"test","module":"email-queue","jobId":"35b23602-f90d-4c80-a0b8-ab331ef5a753","to":"protected-test-b7sKbNfOstnvh_Lgr--RE@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249297513,"env":"test","module":"user-credentials-repository","userId":"a9a773a9-2044-48a5-a3d1-14124a507f96","msg":"User credentials created"}
{"level":30,"time":1768249297527,"env":"test","module":"auth-routes","userId":"b25357c5-b686-497f-bcb7-bced74ffe4b4","msg":"User logged in successfully"}
{"level":30,"time":1768249297560,"env":"test","module":"auth-routes","userId":"f561a1ba-f88c-4743-b546-5cca12d8bad2","email":"protected-test-b7sKbNfOstnvh_Lgr--RE@example.com","msg":"User registered"}
{"level":30,"time":1768249297580,"env":"test","module":"audit-log-service","userId":"b25357c5-b686-497f-bcb7-bced74ffe4b4","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249297588,"env":"test","module":"auth-routes","userId":"a96e74cbb639fc26290e75d70c706f41","msg":"User logged in successfully"}
{"level":30,"time":1768249297615,"env":"test","module":"email-queue","jobId":"8d37d9ac-4801-4ec5-bd7d-52cf33af7719","to":"session-test-DOgYl99mmsg4SG0AuenbT@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":40,"time":1768249297631,"env":"test","module":"auth-middleware","msg":"Cookie strategy: Invalid refresh token"}
{"level":50,"time":1768249297631,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249297636,"env":"test","module":"audit-log-service","userId":"a96e74cbb639fc26290e75d70c706f41","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPOST Protected Routes[2m > [22m[2mshould reject POST with invalid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249297665,"env":"test","module":"auth-routes","userId":"a9a773a9-2044-48a5-a3d1-14124a507f96","email":"session-test-DOgYl99mmsg4SG0AuenbT@example.com","msg":"User registered"}
{"level":50,"time":1768249297767,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768249297793,"env":"test","module":"auth-routes","userId":"f561a1ba-f88c-4743-b546-5cca12d8bad2","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768249297834,"env":"test","module":"email-queue","jobId":"628ac9c0-54f4-49b9-ad7a-93cd23aba309","to":"test-1768249296766-8mwfxf@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249297834,"env":"test","module":"auth-service","email":"test-1768249296766-8mwfxf@example.com","msg":"Password reset email sent"}
{"level":50,"time":1768249297896,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768249297903,"env":"test","module":"user-credentials-repository","userId":"d9923ec6-3591-4796-8510-e54a293a0ba6","msg":"User credentials created"}
{"level":30,"time":1768249298004,"env":"test","module":"email-queue","jobId":"9c5816f7-5f69-4911-ba41-7bd5989db25c","to":"jwt-test-gEjezIQH7D--mYoMUw3da@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249298006,"env":"test","module":"user-credentials-repository","userId":"d37e75f2-b124-4aae-bcb0-28b0eedff0bf","msg":"User credentials created"}
{"level":30,"time":1768249298058,"env":"test","module":"auth-routes","userId":"d9923ec6-3591-4796-8510-e54a293a0ba6","email":"jwt-test-gEjezIQH7D--mYoMUw3da@example.com","msg":"User registered"}
{"level":30,"time":1768249298110,"env":"test","module":"email-queue","jobId":"b92c0a0d-3e7b-4dc7-95e4-9437df35e851","to":"middleware-test-Ndbx9bxc5d0e-SVSeeA13@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249298138,"env":"test","module":"user-credentials-repository","userId":"f7e453a1-204b-44f1-aa41-383c134d8a17","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return requiresMfa=true for MFA-enabled users
[22m[39m[TEST UTILS] MFA Secret verified for 5174e7c0c4d3cf63be97ccbc9832ec08

{"level":30,"time":1768249298161,"env":"test","module":"auth-routes","userId":"d37e75f2-b124-4aae-bcb0-28b0eedff0bf","email":"middleware-test-Ndbx9bxc5d0e-SVSeeA13@example.com","msg":"User registered"}
{"level":50,"time":1768249298197,"env":"test","module":"user-credentials-repository","error":{},"userId":"a96e74cbb639fc26290e75d70c706f41","msg":"Failed to update user password"}
{"level":50,"time":1768249298197,"env":"test","module":"auth-routes","error":{},"msg":"Reset password error"}
{"level":50,"time":1768249298208,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for POST requests (mutation-strict)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249298234,"env":"test","module":"email-queue","jobId":"6754c69a-5433-4cdd-acb7-7337e485e253","to":"session-test-7tZYGqwaaPtbRdu4NiJmP@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249298267,"env":"test","module":"user-credentials-repository","userId":"dd4cc472-a896-4c84-b7ed-99d505371d99","msg":"User credentials created"}
{"level":30,"time":1768249298287,"env":"test","module":"auth-routes","userId":"f7e453a1-204b-44f1-aa41-383c134d8a17","email":"session-test-7tZYGqwaaPtbRdu4NiJmP@example.com","msg":"User registered"}
{"level":30,"time":1768249298365,"env":"test","module":"email-queue","jobId":"4d3eb28e-1f5d-45a9-8a75-0f85ac30adff","to":"protected-test-e8izZmQ_E8DShnY3BIC1I@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return requiresMfa=true for MFA-enabled users
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249298417,"env":"test","module":"auth-routes","userId":"dd4cc472-a896-4c84-b7ed-99d505371d99","email":"protected-test-e8izZmQ_E8DShnY3BIC1I@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPUT Protected Routes[2m > [22m[2mshould allow PUT with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249298578,"env":"test","module":"user-credentials-repository","userId":"0f2d6606-a9c1-44c9-b6ff-86bd8ad868e2","msg":"User credentials created"}
{"level":30,"time":1768249298675,"env":"test","module":"email-queue","jobId":"b5adfcee-3383-404f-9962-dc170fb5279b","to":"user1-NV9eeiGntgB84_-D0ubfk@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249298682,"env":"test","module":"auth-routes","userId":"d37e75f2-b124-4aae-bcb0-28b0eedff0bf","msg":"User logged in successfully"}
{"level":30,"time":1768249298723,"env":"test","module":"auth-routes","userId":"0f2d6606-a9c1-44c9-b6ff-86bd8ad868e2","email":"user1-NV9eeiGntgB84_-D0ubfk@example.com","msg":"User registered"}
{"level":30,"time":1768249298728,"env":"test","module":"audit-log-service","userId":"d37e75f2-b124-4aae-bcb0-28b0eedff0bf","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768249298732,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249298861,"env":"test","module":"auth-routes","userId":"f7e453a1-204b-44f1-aa41-383c134d8a17","msg":"User logged in successfully"}
{"level":30,"time":1768249298864,"env":"test","module":"auth-routes","userId":"5174e7c0c4d3cf63be97ccbc9832ec08","msg":"Login requires MFA verification"}
{"level":30,"time":1768249298909,"env":"test","module":"audit-log-service","userId":"f7e453a1-204b-44f1-aa41-383c134d8a17","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249299019,"env":"test","module":"auth-routes","userId":"dd4cc472-a896-4c84-b7ed-99d505371d99","msg":"User logged in successfully"}
{"level":50,"time":1768249299064,"env":"test","module":"auth-routes","userId":"f7e453a1-204b-44f1-aa41-383c134d8a17","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768249299066,"env":"test","module":"audit-log-service","userId":"dd4cc472-a896-4c84-b7ed-99d505371d99","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249299089,"env":"test","module":"user-credentials-repository","userId":"af4d7c40-98c4-4633-b3a2-c51a04c4ba5c","msg":"User credentials created"}
{"level":30,"time":1768249299105,"env":"test","module":"user-credentials-repository","userId":"4904a975-69a3-4d80-9c72-bd376eeb58f3","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould rotate refresh token on each use
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249299171,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/:sessionId > should revoke specific session
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768249299186,"env":"test","module":"email-queue","jobId":"89dc9a1b-5716-4fb5-bab5-7d82411f3b34","to":"user2-L1TRlB0gd9XhSCjXwJG-q@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249299205,"env":"test","module":"email-queue","jobId":"be5fc8dc-ada3-434f-b4aa-a3211a70ee51","to":"middleware-test-Nh8oDvJQ6s5fCAE041Lcv@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249299240,"env":"test","module":"auth-routes","userId":"af4d7c40-98c4-4633-b3a2-c51a04c4ba5c","email":"user2-L1TRlB0gd9XhSCjXwJG-q@example.com","msg":"User registered"}
{"level":30,"time":1768249299254,"env":"test","module":"auth-routes","userId":"4904a975-69a3-4d80-9c72-bd376eeb58f3","email":"middleware-test-Nh8oDvJQ6s5fCAE041Lcv@example.com","msg":"User registered"}
{"level":50,"time":1768249299269,"env":"test","module":"auth-routes","userId":"7993baeb0b4bd930b017ce8de7d33b62","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for PUT requests
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249299365,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Token Refresh Flow > should rotate refresh token on each use
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768249299455,"env":"test","module":"auth-routes","userId":"4904a975-69a3-4d80-9c72-bd376eeb58f3","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249299549,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should reject cookie auth for PUT requests
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should reject cookie auth for PUT requests
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:21:39.550Z'
  }
}

{"level":30,"time":1768249299555,"env":"test","module":"user-credentials-repository","userId":"e30f6450-8f2e-4c5b-860e-bf6f1d5263f3","msg":"User credentials created"}
{"level":30,"time":1768249299592,"env":"test","module":"user-credentials-repository","userId":"89fb9c99-d844-45f8-afe4-f84c5e480865","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for PUT requests
[22m[39mUser in DB: {
  id: [32m'4904a975-69a3-4d80-9c72-bd376eeb58f3'[39m,
  email: [32m'middleware-test-Nh8oDvJQ6s5fCAE041Lcv@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:21:41.989Z[39m,
  updatedAt: [35m2026-01-12T20:21:41.989Z[39m
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for PUT requests
[22m[39mCreds in DB: [90mundefined[39m

{"level":30,"time":1768249299658,"env":"test","module":"email-queue","jobId":"3a622a9b-95e5-4d27-954f-6346126cc9cc","to":"session-test-b6nShMrmdaa--zb6zLI01@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249299688,"env":"test","module":"email-queue","jobId":"d87736de-d5fd-4e13-918a-65f48e2c6155","to":"protected-test-MdJ83z5E4kkcure_cTKJA@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249299723,"env":"test","module":"user-credentials-repository","userId":"8056c670-0340-46cb-88ab-9336a149db0f","msg":"User credentials created"}
{"level":30,"time":1768249299723,"env":"test","module":"auth-routes","userId":"e30f6450-8f2e-4c5b-860e-bf6f1d5263f3","email":"session-test-b6nShMrmdaa--zb6zLI01@example.com","msg":"User registered"}
{"level":30,"time":1768249299735,"env":"test","module":"auth-routes","userId":"89fb9c99-d844-45f8-afe4-f84c5e480865","email":"protected-test-MdJ83z5E4kkcure_cTKJA@example.com","msg":"User registered"}
{"level":30,"time":1768249299781,"env":"test","module":"user-credentials-repository","userId":"AfxBeG9QjvINCopsLrqV8","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking current session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249299836,"env":"test","module":"email-queue","jobId":"add3679a-e5a5-4ac3-903c-aa173d8ea6c6","to":"jwt-test-AvdT5Z-VASZPhWUCEtVyl@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPUT Protected Routes[2m > [22m[2mshould reject PUT without Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249299889,"env":"test","module":"auth-routes","userId":"8056c670-0340-46cb-88ab-9336a149db0f","email":"jwt-test-AvdT5Z-VASZPhWUCEtVyl@example.com","msg":"User registered"}
{"level":50,"time":1768249299892,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768249299976,"env":"test","module":"auth-routes","userId":"e30f6450-8f2e-4c5b-860e-bf6f1d5263f3","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249299982,"env":"test","module":"auth-routes","userId":"89fb9c99-d844-45f8-afe4-f84c5e480865","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249300022,"env":"test","module":"user-credentials-repository","userId":"19cdc16a-6bfb-4534-b5eb-796e4f19f879","msg":"User credentials created"}
{"level":50,"time":1768249300073,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/:sessionId > should prevent revoking current session
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768249300078,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should reject PUT without Bearer token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768249300123,"env":"test","module":"email-queue","jobId":"c09d452b-a2c3-4be7-bc42-917f076fef7c","to":"middleware-test-Y8DtNyAINlv9X0BMWKjXu@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould detect and prevent refresh token reuse (token theft)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249300171,"env":"test","module":"auth-routes","userId":"19cdc16a-6bfb-4534-b5eb-796e4f19f879","email":"middleware-test-Y8DtNyAINlv9X0BMWKjXu@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for DELETE requests
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249300256,"env":"test","module":"user-credentials-repository","userId":"rSbW7hOKR_AxFXa3o2k0B","msg":"User credentials created"}
{"level":30,"time":1768249300260,"env":"test","module":"user-credentials-repository","userId":"c5b4438b-f6c7-469c-81cf-d3f09c069b74","msg":"User credentials created"}
{"level":30,"time":1768249300308,"env":"test","module":"auth-service","tokenHash":"2b35a65611fd5905b75e50891078e6958f3a1643501767d4867fb49239305eeb","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768249300356,"env":"test","module":"auth-routes","email":"test-1768249299622-446iuq@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768249300360,"env":"test","module":"email-queue","jobId":"3c01b314-6d52-4da3-bdb7-46b6b830796b","to":"jwt-test-e8-H_P7TQ5T6DpEktmxhe@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249300409,"env":"test","module":"auth-routes","userId":"c5b4438b-f6c7-469c-81cf-d3f09c069b74","email":"jwt-test-e8-H_P7TQ5T6DpEktmxhe@example.com","msg":"User registered"}
{"level":50,"time":1768249300458,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768249300460,"env":"test","module":"user-credentials-repository","userId":"97449dd0-60a5-4eab-af1a-28b5023812ec","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mHybrid Authentication Strategy[2m > [22m[2mshould allow GET requests with cookie auth only
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249300468,"env":"test","module":"user-credentials-repository","userId":"70293881-9f35-438f-9e31-3360e488215d","msg":"User credentials created"}
{"level":30,"time":1768249300512,"env":"test","module":"auth-service","tokenHash":"2b35a65611fd5905b75e50891078e6958f3a1643501767d4867fb49239305eeb","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768249300562,"env":"test","module":"email-queue","jobId":"6fdf66fb-8906-4424-9328-10f211cab816","to":"protected-test-pt2bWpnhvPEBuRwNvZJDo@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":40,"time":1768249300563,"env":"test","module":"auth-service","userId":"rSbW7hOKR_AxFXa3o2k0B","tokenHash":"2b35a65611fd5905b75e50891078e6958f3a1643501767d4867fb49239305eeb","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768249300570,"env":"test","module":"email-queue","jobId":"244d5481-1739-4f87-b8f9-03d3a605a0f0","to":"session-test-I8vtDA2sXPPbKEGiixI6E@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249300610,"env":"test","module":"auth-routes","userId":"97449dd0-60a5-4eab-af1a-28b5023812ec","email":"protected-test-pt2bWpnhvPEBuRwNvZJDo@example.com","msg":"User registered"}
{"level":30,"time":1768249300611,"env":"test","module":"auth-routes","userId":"384e2c8fe95510ca7313f2402515f119","msg":"User logged in successfully"}
{"level":30,"time":1768249300625,"env":"test","module":"auth-routes","userId":"70293881-9f35-438f-9e31-3360e488215d","email":"session-test-I8vtDA2sXPPbKEGiixI6E@example.com","msg":"User registered"}
{"level":30,"time":1768249300663,"env":"test","module":"audit-log-service","userId":"384e2c8fe95510ca7313f2402515f119","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249300667,"env":"test","module":"auth-service","tokenHash":"7b1c0ca1b78024c1f8098721e4ede8f44df3a7b1026869025a1bc0d16102a838","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768249300685,"env":"test","module":"auth-routes","userId":"19cdc16a-6bfb-4534-b5eb-796e4f19f879","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mDELETE Protected Routes[2m > [22m[2mshould allow DELETE with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249300737,"env":"test","module":"audit-log-service","userId":"19cdc16a-6bfb-4534-b5eb-796e4f19f879","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768249300742,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768249300826,"env":"test","module":"auth-routes","email":"test-1768249299622-446iuq@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768249300865,"env":"test","module":"auth-service","tokenHash":"7b1c0ca1b78024c1f8098721e4ede8f44df3a7b1026869025a1bc0d16102a838","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768249300913,"env":"test","module":"auth-service","userId":"384e2c8fe95510ca7313f2402515f119","tokenHash":"7b1c0ca1b78024c1f8098721e4ede8f44df3a7b1026869025a1bc0d16102a838","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":50,"time":1768249300919,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249300927,"env":"test","module":"auth-routes","userId":"c5b4438b-f6c7-469c-81cf-d3f09c069b74","msg":"User logged in successfully"}
{"level":30,"time":1768249300934,"env":"test","module":"user-credentials-repository","userId":"ejL7xY65LoH0P5Q7bvpzV","msg":"User credentials created"}
{"level":30,"time":1768249300978,"env":"test","module":"audit-log-service","userId":"c5b4438b-f6c7-469c-81cf-d3f09c069b74","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249301107,"env":"test","module":"user-credentials-repository","userId":"9d11030d-9a67-4f6c-b39c-491bf9576e98","msg":"User credentials created"}
{"level":30,"time":1768249301114,"env":"test","module":"user-credentials-repository","userId":"c9dd74b4-7ee1-4da8-abfe-26aeadd3a54c","msg":"User credentials created"}
{"level":30,"time":1768249301211,"env":"test","module":"email-queue","jobId":"5f369a45-2a80-489b-a28b-d8b09ea1bc92","to":"user2-zBwhHyYL_zxeMWTIoKoDi@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249301222,"env":"test","module":"email-queue","jobId":"be278845-08cc-4d33-bf90-948cc96d2e6e","to":"middleware-test-HZ83zVnjal79lgsCtsUyj@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249301221,"env":"test","module":"auth-routes","userId":"97449dd0-60a5-4eab-af1a-28b5023812ec","msg":"User logged in successfully"}
{"level":30,"time":1768249301258,"env":"test","module":"auth-routes","userId":"9d11030d-9a67-4f6c-b39c-491bf9576e98","email":"user2-zBwhHyYL_zxeMWTIoKoDi@example.com","msg":"User registered"}
{"level":30,"time":1768249301274,"env":"test","module":"audit-log-service","userId":"97449dd0-60a5-4eab-af1a-28b5023812ec","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249301275,"env":"test","module":"auth-routes","userId":"c9dd74b4-7ee1-4da8-abfe-26aeadd3a54c","email":"middleware-test-HZ83zVnjal79lgsCtsUyj@example.com","msg":"User registered"}
{"level":50,"time":1768249301282,"env":"test","module":"auth-routes","email":"test-1768249299622-446iuq@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould not allow revoking other users sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould allow cookie auth for HEAD requests
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249301380,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249301409,"env":"test","module":"user-credentials-repository","userId":"hvqb0ywExMciDa_eqF87G","msg":"User credentials created"}
{"level":30,"time":1768249301462,"env":"test","module":"auth-service","tokenHash":"2795a014e16b2982e5e39db870a424364199232c43fb083621ce8d9764db3777","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768249301464,"env":"test","module":"auth-routes","userId":"9d11030d-9a67-4f6c-b39c-491bf9576e98","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249301490,"env":"test","module":"auth-routes","userId":"c9dd74b4-7ee1-4da8-abfe-26aeadd3a54c","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768249301518,"env":"test","module":"user-credentials-repository","userId":"2733873c-8f51-47d1-9d38-54b8140671e8","msg":"User credentials created"}
{"level":50,"time":1768249301529,"env":"test","module":"auth-routes","userId":"f07245688105b510e0cb56801094afa2","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249301563,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/:sessionId > should not allow revoking other users sessions
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768249301599,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should allow cookie auth for HEAD requests
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should allow cookie auth for HEAD requests
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:21:41.599Z'
  }
}

{"level":30,"time":1768249301622,"env":"test","module":"email-queue","jobId":"f75c578d-3c12-4748-b476-e24210738f1d","to":"jwt-test-rJtwJOB5oNX-S5S4bzjxa@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768249301625,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould allow cookie auth for HEAD requests
[22m[39mUser in DB: {
  id: [32m'c9dd74b4-7ee1-4da8-abfe-26aeadd3a54c'[39m,
  email: [32m'middleware-test-HZ83zVnjal79lgsCtsUyj@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:21:43.997Z[39m,
  updatedAt: [35m2026-01-12T20:21:43.997Z[39m
}

{"level":30,"time":1768249301674,"env":"test","module":"auth-routes","userId":"2733873c-8f51-47d1-9d38-54b8140671e8","email":"jwt-test-rJtwJOB5oNX-S5S4bzjxa@example.com","msg":"User registered"}
{"level":50,"time":1768249301677,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould allow cookie auth for HEAD requests
[22m[39mCreds in DB: [90mundefined[39m

{"level":50,"time":1768249301767,"env":"test","module":"auth-routes","userId":"f07245688105b510e0cb56801094afa2","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249301847,"env":"test","module":"user-credentials-repository","userId":"b0ec4f36-5286-4bd0-af1d-9ad6624507a4","msg":"User credentials created"}
{"level":50,"time":1768249301865,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249301946,"env":"test","module":"email-queue","jobId":"13b6136e-d2f8-4b6d-8d38-e851859e8f0b","to":"protected-test-dBw-RHc8rYFl88c2jPrGX@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249301954,"env":"test","module":"user-credentials-repository","userId":"4c82603a-6694-47a6-aee8-25ec68a09a77","msg":"User credentials created"}
{"level":30,"time":1768249301993,"env":"test","module":"user-credentials-repository","userId":"v2-nO8p5Pw_ZeLFf9a-lW","msg":"User credentials created"}
{"level":30,"time":1768249301997,"env":"test","module":"auth-routes","userId":"b0ec4f36-5286-4bd0-af1d-9ad6624507a4","email":"protected-test-dBw-RHc8rYFl88c2jPrGX@example.com","msg":"User registered"}
{"level":50,"time":1768249302009,"env":"test","module":"auth-routes","userId":"f07245688105b510e0cb56801094afa2","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768249302047,"env":"test","module":"auth-service","tokenHash":"b3ce07ded24bd62fb8f93b58a3c65090d9e224e779e7982f563dfca6e892da6a","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768249302057,"env":"test","module":"email-queue","jobId":"fea27560-cf5e-4368-9d76-cb4af4b489ac","to":"session-test-IKNwRvxEGIYHRERM7B4dm@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249302109,"env":"test","module":"user-credentials-repository","userId":"a6470fb4-4472-43a9-97da-152538301c40","msg":"User credentials created"}
{"level":50,"time":1768249302110,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mDELETE Protected Routes[2m > [22m[2mshould reject DELETE without Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249302112,"env":"test","module":"auth-routes","userId":"4c82603a-6694-47a6-aee8-25ec68a09a77","email":"session-test-IKNwRvxEGIYHRERM7B4dm@example.com","msg":"User registered"}
{"level":30,"time":1768249302205,"env":"test","module":"email-queue","jobId":"83193500-7bb2-4a14-a046-9fd489aff87c","to":"middleware-test-5k37I_VElHHLdfmGcvts1@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould return 404 for non-existent session ID
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249302252,"env":"test","module":"auth-routes","userId":"a6470fb4-4472-43a9-97da-152538301c40","email":"middleware-test-5k37I_VElHHLdfmGcvts1@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould prioritize JWT over cookie when both present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249302307,"env":"test","module":"auth-routes","userId":"96ad1d7e3cd4007b7e0caabd75844b1c","msg":"User logged in successfully"}
{"level":30,"time":1768249302358,"env":"test","module":"audit-log-service","userId":"96ad1d7e3cd4007b7e0caabd75844b1c","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249302508,"env":"test","module":"auth-routes","userId":"96ad1d7e3cd4007b7e0caabd75844b1c","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768249302566,"env":"test","module":"user-credentials-repository","userId":"DuLo4Mhb6RDf7aG6BdBTf","msg":"User credentials created"}
{"level":50,"time":1768249302613,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Session Management Flow > should list all active sessions
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768249302617,"env":"test","module":"auth-routes","userId":"b0ec4f36-5286-4bd0-af1d-9ad6624507a4","msg":"User logged in successfully"}
{"level":50,"time":1768249302619,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249302621,"env":"test","module":"auth-service","tokenHash":"850309712c911fb353ace2cbb2199b5544aa3642d44eeae3cc948ebb3278d8f8","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768249302669,"env":"test","module":"audit-log-service","userId":"b0ec4f36-5286-4bd0-af1d-9ad6624507a4","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768249302674,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249302683,"env":"test","module":"auth-routes","userId":"4c82603a-6694-47a6-aee8-25ec68a09a77","msg":"User logged in successfully"}
{"level":30,"time":1768249302735,"env":"test","module":"audit-log-service","userId":"4c82603a-6694-47a6-aee8-25ec68a09a77","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249302771,"env":"test","module":"auth-routes","userId":"a6470fb4-4472-43a9-97da-152538301c40","msg":"User logged in successfully"}
{"level":30,"time":1768249302821,"env":"test","module":"audit-log-service","userId":"a6470fb4-4472-43a9-97da-152538301c40","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249302937,"env":"test","module":"user-credentials-repository","userId":"c5051834-412b-469b-aed0-05d4deeea9ba","msg":"User credentials created"}
{"level":30,"time":1768249303034,"env":"test","module":"email-queue","jobId":"315b34c2-25fb-4907-93df-27a37c890cc8","to":"jwt-test-tKqRC1UEyld9ffyxHP9Ri@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249303039,"env":"test","module":"user-credentials-repository","userId":"cdf7f8f9-b349-47d7-ad54-6e1211ff2db1","msg":"User credentials created"}
{"level":30,"time":1768249303082,"env":"test","module":"auth-routes","userId":"c5051834-412b-469b-aed0-05d4deeea9ba","email":"jwt-test-tKqRC1UEyld9ffyxHP9Ri@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould refresh access token using refresh token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249303140,"env":"test","module":"email-queue","jobId":"178f349c-26c8-4ca6-a06d-ea6764d04ec6","to":"protected-test-kGScrphW29TydrcC37C-H@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249303146,"env":"test","module":"user-credentials-repository","userId":"tUSNDX_4ZGJHIhcH4CHL2","msg":"User credentials created"}
{"level":30,"time":1768249303164,"env":"test","module":"user-credentials-repository","userId":"f630b1d6-609c-45ee-a3ff-f7bf448f4644","msg":"User credentials created"}
{"level":30,"time":1768249303187,"env":"test","module":"auth-routes","userId":"cdf7f8f9-b349-47d7-ad54-6e1211ff2db1","email":"protected-test-kGScrphW29TydrcC37C-H@example.com","msg":"User registered"}
{"level":30,"time":1768249303198,"env":"test","module":"auth-service","tokenHash":"d374c46038c5fb9d5b424b344d851fca4f205d3a643b002696c5deac8ed41941","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768249303200,"env":"test","module":"user-credentials-repository","userId":"76e04184-27a6-41ec-9a09-6a2f3d07860e","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/logout[2m > [22m[2mshould logout and clear refresh token cookie
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249303264,"env":"test","module":"email-queue","jobId":"f9672e74-612e-40bb-99c7-d5de54c343d3","to":"session-test-m4SbdENwr-sZLnLo0JvQa@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768249303279,"env":"test","module":"auth-routes","userId":"c5051834-412b-469b-aed0-05d4deeea9ba","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPATCH Protected Routes[2m > [22m[2mshould allow PATCH with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249303302,"env":"test","module":"email-queue","jobId":"96397fe2-33e0-4c27-8141-addf08ab4477","to":"user2-02PO-5MwRQQHI33Q0stVd@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249303314,"env":"test","module":"auth-routes","userId":"f630b1d6-609c-45ee-a3ff-f7bf448f4644","email":"session-test-m4SbdENwr-sZLnLo0JvQa@example.com","msg":"User registered"}
{"level":30,"time":1768249303356,"env":"test","module":"auth-routes","userId":"76e04184-27a6-41ec-9a09-6a2f3d07860e","email":"user2-02PO-5MwRQQHI33Q0stVd@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249303370,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > Token Refresh Flow > should refresh access token using refresh token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould prioritize JWT over cookie when both present
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all sessions except current
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249303646,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768249303646,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768249303704,"env":"test","module":"auth-routes","userId":"d032ab57c40bd60a1f2c35fb9b4c095f","msg":"User logged in successfully"}
{"level":30,"time":1768249303741,"env":"test","module":"user-credentials-repository","userId":"d194eb39-d2de-442c-b7fd-77583d0435b8","msg":"User credentials created"}
{"level":30,"time":1768249303752,"env":"test","module":"audit-log-service","userId":"d032ab57c40bd60a1f2c35fb9b4c095f","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249303798,"env":"test","module":"auth-routes","userId":"cdf7f8f9-b349-47d7-ad54-6e1211ff2db1","msg":"User logged in successfully"}
{"level":30,"time":1768249303810,"env":"test","module":"auth-routes","userId":"adf5deb11db16398902fd36d975aa767","msg":"User logged in successfully"}
{"level":30,"time":1768249303833,"env":"test","module":"email-queue","jobId":"a1421357-25b7-442c-a673-511a18214a9a","to":"jwt-test-VjFb_eSU-q5PhjGsknyQg@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249303850,"env":"test","module":"audit-log-service","userId":"cdf7f8f9-b349-47d7-ad54-6e1211ff2db1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249303863,"env":"test","module":"audit-log-service","userId":"adf5deb11db16398902fd36d975aa767","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249303871,"env":"test","module":"auth-routes","userId":"76e04184-27a6-41ec-9a09-6a2f3d07860e","msg":"User logged in successfully"}
{"level":30,"time":1768249303877,"env":"test","module":"auth-routes","userId":"f630b1d6-609c-45ee-a3ff-f7bf448f4644","msg":"User logged in successfully"}
{"level":30,"time":1768249303883,"env":"test","module":"auth-routes","userId":"d194eb39-d2de-442c-b7fd-77583d0435b8","email":"jwt-test-VjFb_eSU-q5PhjGsknyQg@example.com","msg":"User registered"}
{"level":30,"time":1768249303924,"env":"test","module":"audit-log-service","userId":"76e04184-27a6-41ec-9a09-6a2f3d07860e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249303928,"env":"test","module":"audit-log-service","userId":"f630b1d6-609c-45ee-a3ff-f7bf448f4644","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all sessions except current
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould rotate refresh token on use
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w6_a749da58

 [31mÎ“Â¥Â»[39m tests/integration/auth/oauth2.token-refresh.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m5 failed[39m[2m)[22m[33m 22876[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should refresh access token with valid refresh token [33m 636[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should rotate refresh token after use[39m[33m 636[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 when refresh token is missing [33m 362[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for invalid refresh token [33m 466[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for expired refresh token [33m 534[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for revoked refresh token [33m 527[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 when user is not found [33m 560[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update refresh token metadata on rotation[39m[33m 620[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle concurrent refresh token requests (token reuse detection) [33m 806[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set secure cookie in production[39m[33m 516[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set proper cookie attributes [33m 610[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should include user role information in response [33m 567[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should create refresh token on login[39m[33m 632[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke refresh token on logout [33m 477[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle logout without refresh token gracefully [33m 371[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should support multiple active refresh tokens per user[39m[33m 510[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke all user tokens on password reset [33m 576[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should use cryptographically strong random tokens [33m 5362[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should hash refresh tokens before storing in database [33m 473[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prevent refresh token reuse after rotation [33m 675[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should validate token ownership [33m 475[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set HttpOnly flag to prevent XSS [33m 576[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set SameSite=Strict to prevent CSRF [33m 579[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set proper cookie path [33m 578[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set appropriate expiry (30 days) [33m 586[2mms[22m[39m
{"level":30,"time":1768249304321,"env":"test","module":"auth-routes","userId":"adf5deb11db16398902fd36d975aa767","msg":"User logged in successfully"}
{"level":30,"time":1768249304370,"env":"test","module":"audit-log-service","userId":"adf5deb11db16398902fd36d975aa767","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249304396,"env":"test","module":"user-credentials-repository","userId":"11b1c5ea-f117-47d7-b082-3a8d6f56bb1a","msg":"User credentials created"}
{"level":30,"time":1768249304405,"env":"test","module":"auth-routes","userId":"f630b1d6-609c-45ee-a3ff-f7bf448f4644","msg":"User logged in successfully"}
{"level":30,"time":1768249304411,"env":"test","module":"auth-routes","userId":"d194eb39-d2de-442c-b7fd-77583d0435b8","msg":"User logged in successfully"}
{"level":30,"time":1768249304456,"env":"test","module":"audit-log-service","userId":"f630b1d6-609c-45ee-a3ff-f7bf448f4644","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all sessions except current
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249304462,"env":"test","module":"audit-log-service","userId":"d194eb39-d2de-442c-b7fd-77583d0435b8","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249304465,"env":"test","module":"auth-service","tokenHash":"c3e5bb49a52680ed2afcbcc114073e8f0f886ffaf832852ccbef096a98b3864a","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768249304474,"env":"test","module":"auth-routes","userId":"adf5deb11db16398902fd36d975aa767","sessionCount":0,"msg":"Listed active sessions"}
{"level":30,"time":1768249304476,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768249304476,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768249304495,"env":"test","module":"email-queue","jobId":"e5195e8b-e93e-448a-8184-54465efc372a","to":"middleware-test-FdIurTiC_hcpo4-vwhTXq@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":40,"time":1768249304513,"env":"test","module":"auth-service","tokenHash":"c3e5bb49a52680ed2afcbcc114073e8f0f886ffaf832852ccbef096a98b3864a","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768249304542,"env":"test","module":"auth-routes","userId":"11b1c5ea-f117-47d7-b082-3a8d6f56bb1a","email":"middleware-test-FdIurTiC_hcpo4-vwhTXq@example.com","msg":"User registered"}
{"level":30,"time":1768249304561,"env":"test","module":"auth-service","allTokensCount":1,"sampleToken":"9319ea5ec07d7a50e0979efc7753d9ca8c5198b56dade67b1ab27202680e0dcd","msg":"DEBUG: Tokens in DB"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould return 401 when no auth provided
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249304601,"env":"test","module":"auth-routes","userId":"f630b1d6-609c-45ee-a3ff-f7bf448f4644","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249304714,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/all > should revoke all sessions except current
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768249304754,"env":"test","module":"auth-routes","userId":"11b1c5ea-f117-47d7-b082-3a8d6f56bb1a","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w4_75e616d0

{"level":50,"time":1768249304846,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should return 401 when no auth provided
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should return 401 when no auth provided
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:21:44.847Z'
  }
}

 [31mÎ“Â¥Â»[39m tests/integration/auth.flows.real.test.ts [2m([22m[2m11 tests[22m[2m | [22m[31m9 failed[39m[2m)[22m[33m 23669[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should complete registration, verify email, then login[39m[33m 1686[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should lock account after 5 failed attempts, then unlock after waiting[39m[33m 2258[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should record all login attempts[39m[33m 1984[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should complete MFA setup and login with TOTP[39m[33m 2362[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should login with backup code when TOTP unavailable[39m[33m 1792[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should complete full password reset flow[39m[33m 1621[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should invalidate all sessions after password reset [33m 2023[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should rotate refresh token on each use[39m[33m 973[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should detect and prevent refresh token reuse (token theft) [33m 1685[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all active sessions[39m[33m 1568[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific session[39m[33m 1855[2mms[22m[39m
{"level":30,"time":1768249304863,"env":"test","module":"user-credentials-repository","userId":"04e7bb28-8351-4825-93ac-315b724d7633","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould return 401 when no auth provided
[22m[39mUser in DB: {
  id: [32m'11b1c5ea-f117-47d7-b082-3a8d6f56bb1a'[39m,
  email: [32m'middleware-test-FdIurTiC_hcpo4-vwhTXq@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:21:47.282Z[39m,
  updatedAt: [35m2026-01-12T20:21:47.282Z[39m
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould refresh access token with valid refresh token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249304927,"env":"test","module":"user-credentials-repository","userId":"daad746b-fa5f-43ca-a7f6-5b47cc93a5f9","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould return 401 when no auth provided
[22m[39mCreds in DB: [90mundefined[39m

{"level":30,"time":1768249304957,"env":"test","module":"email-queue","jobId":"936d1a30-46b5-48ec-8222-ad5ad7698d29","to":"protected-test-IVxLfjlbDrI8SXZI_5g_Q@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249305004,"env":"test","module":"auth-routes","userId":"04e7bb28-8351-4825-93ac-315b724d7633","email":"protected-test-IVxLfjlbDrI8SXZI_5g_Q@example.com","msg":"User registered"}
{"level":30,"time":1768249305024,"env":"test","module":"email-queue","jobId":"cd864b3e-daad-4b85-b6ab-64db3d49bfa6","to":"jwt-test-2FrUQMIKbbcvoauNjXvtW@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249305071,"env":"test","module":"auth-routes","userId":"daad746b-fa5f-43ca-a7f6-5b47cc93a5f9","email":"jwt-test-2FrUQMIKbbcvoauNjXvtW@example.com","msg":"User registered"}
{"level":30,"time":1768249305082,"env":"test","module":"user-credentials-repository","userId":"b4b9fd70-fa76-4dda-8f11-cf762467fd4a","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPATCH Protected Routes[2m > [22m[2mshould reject PATCH without Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould detect token reuse and revoke all user tokens
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249305177,"env":"test","module":"email-queue","jobId":"119e209a-b051-4aeb-8135-5dc1ec26ded0","to":"session-test-wEEQ7OEkj_AzHNSwHcxcU@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249305233,"env":"test","module":"auth-routes","userId":"b4b9fd70-fa76-4dda-8f11-cf762467fd4a","email":"session-test-wEEQ7OEkj_AzHNSwHcxcU@example.com","msg":"User registered"}
{"level":30,"time":1768249305311,"env":"test","module":"user-credentials-repository","userId":"b8b87e58-45b4-4089-b669-816f59e6b7fd","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all trusted devices
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249305368,"env":"test","module":"auth-routes","userId":"86388316599ffb607997ca2170d4a084","msg":"User logged in successfully"}
{"level":30,"time":1768249305427,"env":"test","module":"email-queue","jobId":"8e7de26d-aef4-4fd7-900f-334ca2024611","to":"middleware-test-wSaWOdjVMyUbHyUNi3Cz0@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249305427,"env":"test","module":"audit-log-service","userId":"86388316599ffb607997ca2170d4a084","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249305431,"env":"test","module":"auth-service","tokenHash":"4f075aca0177c5b9a568ece5cf0bbc743c279c3b444ac04bfc68392e3a168584","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768249305477,"env":"test","module":"auth-routes","userId":"b8b87e58-45b4-4089-b669-816f59e6b7fd","email":"middleware-test-wSaWOdjVMyUbHyUNi3Cz0@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould return 401 when both JWT and cookie are invalid
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249305569,"env":"test","module":"auth-routes","userId":"daad746b-fa5f-43ca-a7f6-5b47cc93a5f9","msg":"User logged in successfully"}
{"level":30,"time":1768249305608,"env":"test","module":"auth-routes","userId":"04e7bb28-8351-4825-93ac-315b724d7633","msg":"User logged in successfully"}
{"level":30,"time":1768249305615,"env":"test","module":"audit-log-service","userId":"daad746b-fa5f-43ca-a7f6-5b47cc93a5f9","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould detect token reuse and revoke all user tokens
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249305655,"env":"test","module":"audit-log-service","userId":"04e7bb28-8351-4825-93ac-315b724d7633","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768249305659,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249305797,"env":"test","module":"auth-routes","userId":"b4b9fd70-fa76-4dda-8f11-cf762467fd4a","msg":"User logged in successfully"}
{"level":30,"time":1768249305846,"env":"test","module":"audit-log-service","userId":"b4b9fd70-fa76-4dda-8f11-cf762467fd4a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249306001,"env":"test","module":"auth-routes","userId":"b4b9fd70-fa76-4dda-8f11-cf762467fd4a","deviceFingerprint":"377ad01217b8c93ca52518d515505c47ab7553fab66d6fddaa60af67802c5a4c","msg":"Device marked as trusted"}
{"level":30,"time":1768249306002,"env":"test","module":"auth-routes","userId":"b8b87e58-45b4-4089-b669-816f59e6b7fd","msg":"User logged in successfully"}
{"level":30,"time":1768249306023,"env":"test","module":"user-credentials-repository","userId":"c97b97f2-ff6c-46b6-a6c8-d6d1cbbb0a08","msg":"User credentials created"}
{"level":30,"time":1768249306050,"env":"test","module":"audit-log-service","userId":"b8b87e58-45b4-4089-b669-816f59e6b7fd","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768249306054,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249306077,"env":"test","module":"auth-routes","userId":"daad746b-fa5f-43ca-a7f6-5b47cc93a5f9","msg":"User logged in successfully"}
{"level":30,"time":1768249306114,"env":"test","module":"email-queue","jobId":"d5c0a6ba-e662-4e23-a680-bd47d64aba7b","to":"protected-test-M4FD8beikCKSAmftoqGwl@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249306123,"env":"test","module":"audit-log-service","userId":"daad746b-fa5f-43ca-a7f6-5b47cc93a5f9","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249306127,"env":"test","module":"auth-service","tokenHash":"f8494dd1eaca24109b08531f49b2d069437b85b9a0e18c2c2c7f2ef5ac6b20f0","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768249306155,"env":"test","module":"auth-routes","userId":"b4b9fd70-fa76-4dda-8f11-cf762467fd4a","msg":"All other sessions revoked"}
{"level":30,"time":1768249306165,"env":"test","module":"auth-routes","userId":"c97b97f2-ff6c-46b6-a6c8-d6d1cbbb0a08","email":"protected-test-M4FD8beikCKSAmftoqGwl@example.com","msg":"User registered"}
{"level":40,"time":1768249306178,"env":"test","module":"auth-service","tokenHash":"f8494dd1eaca24109b08531f49b2d069437b85b9a0e18c2c2c7f2ef5ac6b20f0","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768249306213,"env":"test","module":"audit-log-service","userId":"b4b9fd70-fa76-4dda-8f11-cf762467fd4a","eventType":"all_sessions_revoked","ipAddress":"::1","hasMetadata":false,"msg":"Security event logged"}
{"level":30,"time":1768249306229,"env":"test","module":"auth-service","allTokensCount":3,"sampleToken":"82b612f2e463b42b5d17db6bec91b5858da5d69f6e86773fc50fe585d565d25e","msg":"DEBUG: Tokens in DB"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle Bearer token with extra spaces
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249306321,"env":"test","module":"auth-routes","userId":"b4b9fd70-fa76-4dda-8f11-cf762467fd4a","deviceCount":0,"msg":"Listed trusted devices"}
{"level":50,"time":1768249306403,"env":"test","module":"auth-routes","userId":"c97b97f2-ff6c-46b6-a6c8-d6d1cbbb0a08","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768249306429,"env":"test","module":"user-credentials-repository","userId":"904a8e50-0d23-40c1-a766-d2a8bf758d38","msg":"User credentials created"}
{"level":50,"time":1768249306495,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768249306527,"env":"test","module":"email-queue","jobId":"c3d2fbc4-3b7d-4cb4-9d7d-c6c196e2e747","to":"middleware-test-Nexbl9GTwRJZKki4r7KCD@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249306575,"env":"test","module":"auth-routes","userId":"904a8e50-0d23-40c1-a766-d2a8bf758d38","email":"middleware-test-Nexbl9GTwRJZKki4r7KCD@example.com","msg":"User registered"}
{"level":30,"time":1768249306602,"env":"test","module":"user-credentials-repository","userId":"4e86621f-f29c-4a7e-8dbb-311bdd6a9a80","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould authenticate with JWT if provided
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249306693,"env":"test","module":"user-credentials-repository","userId":"0ee31c8f-e394-4847-84c1-63227298585f","msg":"User credentials created"}
{"level":30,"time":1768249306699,"env":"test","module":"email-queue","jobId":"bb571b36-c626-498e-a040-f3f1c2e1c20f","to":"jwt-test-XVTMaCadGr0B4OjSbb71_@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249306751,"env":"test","module":"auth-routes","userId":"4e86621f-f29c-4a7e-8dbb-311bdd6a9a80","email":"jwt-test-XVTMaCadGr0B4OjSbb71_@example.com","msg":"User registered"}
{"level":50,"time":1768249306768,"env":"test","module":"auth-routes","userId":"904a8e50-0d23-40c1-a766-d2a8bf758d38","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768249306800,"env":"test","module":"email-queue","jobId":"25a950cf-8d55-4505-b5a3-67b4c0752a4d","to":"session-test-O7ADLJOVl6AMPIrz3LNaC@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mLogout Flow[2m > [22m[2mshould revoke refresh token on logout
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249306849,"env":"test","module":"auth-routes","userId":"0ee31c8f-e394-4847-84c1-63227298585f","email":"session-test-O7ADLJOVl6AMPIrz3LNaC@example.com","msg":"User registered"}
{"level":50,"time":1768249306861,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > optionalHybridAuth Middleware > should authenticate with JWT if provided
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > optionalHybridAuth Middleware > should authenticate with JWT if provided
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:21:46.861Z'
  }
}

{"level":30,"time":1768249306866,"env":"test","module":"user-credentials-repository","userId":"0680bdea-7030-4ac3-85d1-900c5406aa53","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould authenticate with JWT if provided
[22m[39mUser in DB: {
  id: [32m'904a8e50-0d23-40c1-a766-d2a8bf758d38'[39m,
  email: [32m'middleware-test-Nexbl9GTwRJZKki4r7KCD@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:21:49.314Z[39m,
  updatedAt: [35m2026-01-12T20:21:49.314Z[39m
}

{"level":50,"time":1768249306945,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768249306948,"env":"test","module":"auth-routes","userId":"4e86621f-f29c-4a7e-8dbb-311bdd6a9a80","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768249306962,"env":"test","module":"email-queue","jobId":"f6d145fd-1f3e-4127-a582-3c042a3b875b","to":"protected-test-uf1Q6HOw30n0Ahi2zvcTE@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould authenticate with JWT if provided
[22m[39mCreds in DB: [90mundefined[39m

{"level":30,"time":1768249307008,"env":"test","module":"auth-routes","userId":"0680bdea-7030-4ac3-85d1-900c5406aa53","email":"protected-test-uf1Q6HOw30n0Ahi2zvcTE@example.com","msg":"User registered"}
{"level":50,"time":1768249307041,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > Logout Flow > should revoke refresh token on logout
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle very long invalid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249307258,"env":"test","module":"auth-routes","userId":"0680bdea-7030-4ac3-85d1-900c5406aa53","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768249307328,"env":"test","module":"user-credentials-repository","userId":"45276ff9-c153-45ec-b697-b6ee32d2d374","msg":"User credentials created"}
{"level":30,"time":1768249307336,"env":"test","module":"user-credentials-repository","userId":"31d702d0-a4ca-4939-b9ce-88031c737710","msg":"User credentials created"}
{"level":50,"time":1768249307348,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768249307411,"env":"test","module":"user-credentials-repository","userId":"db5ed0a0-3879-4ec9-986f-bcb88e545e54","msg":"User credentials created"}
{"level":30,"time":1768249307424,"env":"test","module":"email-queue","jobId":"640ffa80-0fcd-49e4-b0db-38e07ef7e0a3","to":"session-test-0Ai5UiJkJzDjDl8HUoeIy@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249307431,"env":"test","module":"email-queue","jobId":"cf1b4bae-75c8-41e4-934f-55848053a01c","to":"middleware-test-VT5Va6JMbZHf279mPulLz@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould rotate refresh token after use
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249307471,"env":"test","module":"auth-routes","userId":"45276ff9-c153-45ec-b697-b6ee32d2d374","email":"session-test-0Ai5UiJkJzDjDl8HUoeIy@example.com","msg":"User registered"}
{"level":30,"time":1768249307479,"env":"test","module":"auth-routes","userId":"31d702d0-a4ca-4939-b9ce-88031c737710","email":"middleware-test-VT5Va6JMbZHf279mPulLz@example.com","msg":"User registered"}
{"level":30,"time":1768249307506,"env":"test","module":"email-queue","jobId":"8c1c1da0-65ab-4105-be5e-6531d4a74f42","to":"jwt-test-udhtBHXj3miuHJxc9dx7T@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould authenticate with cookie if JWT not provided
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249307555,"env":"test","module":"auth-routes","userId":"db5ed0a0-3879-4ec9-986f-bcb88e545e54","email":"jwt-test-udhtBHXj3miuHJxc9dx7T@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Expiration[2m > [22m[2mshould reject refresh token after 30 days
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mLogout Flow[2m > [22m[2mshould clear refresh token cookie on logout
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249307711,"env":"test","module":"user-credentials-repository","userId":"7d081151-ba30-41f8-ad29-7618ecc7231e","msg":"User credentials created"}
{"level":30,"time":1768249307800,"env":"test","module":"email-queue","jobId":"511ab8d4-488b-4296-b73c-060cbcfc0fd8","to":"protected-test-aQJA1hrkgBmU-lfyEmRGl@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249307846,"env":"test","module":"auth-routes","userId":"7d081151-ba30-41f8-ad29-7618ecc7231e","email":"protected-test-aQJA1hrkgBmU-lfyEmRGl@example.com","msg":"User registered"}
{"level":30,"time":1768249307914,"env":"test","module":"auth-routes","userId":"40e3d4e693fbc182c866f05b19f95de3","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle empty Authorization header
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249307960,"env":"test","module":"audit-log-service","userId":"40e3d4e693fbc182c866f05b19f95de3","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249307963,"env":"test","module":"auth-service","tokenHash":"aaee4713ff9ba8c43d8fc12cad98d4df7f32e64ac7e874d183588fbe13176a13","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768249308000,"env":"test","module":"auth-routes","userId":"31d702d0-a4ca-4939-b9ce-88031c737710","msg":"User logged in successfully"}
{"level":30,"time":1768249308035,"env":"test","module":"auth-routes","userId":"45276ff9-c153-45ec-b697-b6ee32d2d374","msg":"User logged in successfully"}
{"level":30,"time":1768249308048,"env":"test","module":"audit-log-service","userId":"31d702d0-a4ca-4939-b9ce-88031c737710","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249308063,"env":"test","module":"auth-routes","userId":"db5ed0a0-3879-4ec9-986f-bcb88e545e54","msg":"User logged in successfully"}
{"level":30,"time":1768249308082,"env":"test","module":"audit-log-service","userId":"45276ff9-c153-45ec-b697-b6ee32d2d374","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249308115,"env":"test","module":"audit-log-service","userId":"db5ed0a0-3879-4ec9-986f-bcb88e545e54","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249308148,"env":"test","module":"auth-service","tokenHash":"aaee4713ff9ba8c43d8fc12cad98d4df7f32e64ac7e874d183588fbe13176a13","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768249308180,"env":"test","module":"auth-service","tokenHash":"424c23ab34eae8188fd72598004f6de8a047535436de1d3507c92388c46a80f7","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768249308193,"env":"test","module":"auth-service","userId":"40e3d4e693fbc182c866f05b19f95de3","tokenHash":"aaee4713ff9ba8c43d8fc12cad98d4df7f32e64ac7e874d183588fbe13176a13","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":40,"time":1768249308228,"env":"test","module":"auth-service","userId":"45276ff9-c153-45ec-b697-b6ee32d2d374","msg":"Security: Expired refresh token used"}
{"level":30,"time":1768249308427,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768249308428,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768249308447,"env":"test","module":"auth-routes","userId":"7d081151-ba30-41f8-ad29-7618ecc7231e","msg":"User logged in successfully"}
{"level":30,"time":1768249308493,"env":"test","module":"audit-log-service","userId":"7d081151-ba30-41f8-ad29-7618ecc7231e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768249308495,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249308582,"env":"test","module":"intake-service","runId":"5430bd5f-f8fd-42b9-a678-586c53b4f874","slug":"hybrid-cookie-pVNTDTjcjMIRV0lBPoPEG","msg":"Created intake run"}
{"level":30,"time":1768249308605,"env":"test","module":"user-credentials-repository","userId":"e59ca2ef-3f0e-4da1-ae56-f26e7e847910","msg":"User credentials created"}
{"level":30,"time":1768249308704,"env":"test","module":"email-queue","jobId":"42449385-eaf9-4f93-afea-3889f928e948","to":"session-test-kly0Y0NKxpcxxi5-d-7XZ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w5_24318c60

{"level":30,"time":1768249308752,"env":"test","module":"auth-routes","userId":"e59ca2ef-3f0e-4da1-ae56-f26e7e847910","email":"session-test-kly0Y0NKxpcxxi5-d-7XZ@example.com","msg":"User registered"}
 [31mÎ“Â¥Â»[39m tests/integration/auth/jwt.authentication.test.ts [2m([22m[2m27 tests[22m[2m | [22m[31m8 failed[39m[2m)[22m[33m 22785[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should generate valid JWT token on successful login[39m[33m 907[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should include correct payload in JWT token[39m[33m 813[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set JWT expiry to 15 minutes [33m 1093[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should accept valid JWT token on protected routes[39m[33m 829[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject request without authorization header[32m 5[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject request with malformed token[32m 4[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should accept request with missing Bearer prefix (lenient)[39m[33m 821[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject token with invalid signature[32m 4[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject expired JWT token [33m 1104[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return token_expired error code for expired tokens [33m 1104[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should authenticate with Bearer token in Authorization header[32m 99[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should work with Bearer token on POST requests[32m 0[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should work with Bearer token on PUT requests[32m 206[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should work with Bearer token on DELETE requests[32m 244[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should exchange valid session cookie for JWT token [33m 685[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject token exchange without valid cookie[32m 4[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prefer Bearer token over cookie when both present [33m 1139[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should fall back to cookie if Bearer token is invalid [33m 545[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow GET requests with cookie auth only [33m 1232[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject POST requests with cookie auth only (mutation-strict) [33m 553[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow anonymous access to public workflows [33m 441[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should attach user info if authenticated on optional auth routes [33m 458[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should refresh access token using refresh token[39m[33m 796[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should rotate refresh token on use[39m[33m 1190[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should detect token reuse and revoke all user tokens[39m[33m 1669[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke refresh token on logout[39m[33m 811[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should clear refresh token cookie on logout [33m 1121[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mConcurrent Session Handling[2m > [22m[2mshould handle multiple concurrent logins
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mConcurrent Session Handling[2m > [22m[2mshould handle multiple concurrent logins
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mConcurrent Session Handling[2m > [22m[2mshould handle multiple concurrent logins
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249308860,"env":"test","module":"user-credentials-repository","userId":"d2d4a89e-54c8-4bfc-b6ca-1b9575d5f967","msg":"User credentials created"}
{"level":30,"time":1768249308961,"env":"test","module":"user-credentials-repository","userId":"b68b861b-5d8e-412b-8ac3-f3e8630b90c0","msg":"User credentials created"}
{"level":30,"time":1768249308971,"env":"test","module":"email-queue","jobId":"437e0aa8-fd70-4779-b1a5-ac579cdf6929","to":"protected-test-URsLAa2Gd3xlILSGN_Cbc@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768249308995,"env":"test","module":"auth-routes","userId":"e59ca2ef-3f0e-4da1-ae56-f26e7e847910","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768249309017,"env":"test","module":"auth-routes","userId":"d2d4a89e-54c8-4bfc-b6ca-1b9575d5f967","email":"protected-test-URsLAa2Gd3xlILSGN_Cbc@example.com","msg":"User registered"}
{"level":30,"time":1768249309061,"env":"test","module":"email-queue","jobId":"c7e03023-d645-4020-9d7f-b64504a6f8cf","to":"middleware-test-WhLrXj10FGYAfZv5unjgi@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768249309096,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Concurrent Session Handling > should handle multiple concurrent logins
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768249309116,"env":"test","module":"auth-routes","userId":"b68b861b-5d8e-412b-8ac3-f3e8630b90c0","email":"middleware-test-WhLrXj10FGYAfZv5unjgi@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle Authorization header with only Bearer
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould proceed anonymously if no auth provided
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249309262,"env":"test","module":"auth-routes","userId":"d2d4a89e-54c8-4bfc-b6ca-1b9575d5f967","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249309293,"env":"test","module":"auth-routes","userId":"e59ca2ef-3f0e-4da1-ae56-f26e7e847910","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249309303,"env":"test","module":"auth-routes","userId":"e59ca2ef-3f0e-4da1-ae56-f26e7e847910","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249309317,"env":"test","module":"auth-routes","userId":"b68b861b-5d8e-412b-8ac3-f3e8630b90c0","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249309357,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768249309386,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Concurrent Session Handling > should handle multiple concurrent logins
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768249309400,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Concurrent Session Handling > should handle multiple concurrent logins
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768249309414,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > optionalHybridAuth Middleware > should proceed anonymously if no auth provided
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > optionalHybridAuth Middleware > should proceed anonymously if no auth provided
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:21:49.414Z'
  }
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould proceed anonymously if no auth provided
[22m[39mUser in DB: {
  id: [32m'b68b861b-5d8e-412b-8ac3-f3e8630b90c0'[39m,
  email: [32m'middleware-test-WhLrXj10FGYAfZv5unjgi@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:21:51.847Z[39m,
  updatedAt: [35m2026-01-12T20:21:51.847Z[39m
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould proceed anonymously if no auth provided
[22m[39mCreds in DB: [90mundefined[39m

{"level":30,"time":1768249309565,"env":"test","module":"email-queue","jobId":"b5c7e486-ea14-45f4-a8ac-7e1db411418b","to":"test-1768249309011-nen71j@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249309565,"env":"test","module":"auth-service","email":"test-1768249309011-nen71j@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768249309727,"env":"test","module":"user-credentials-repository","userId":"0f618fe3-ec03-40f0-a995-356ad375f351","msg":"User credentials created"}
{"level":30,"time":1768249309782,"env":"test","module":"user-credentials-repository","userId":"461d5d10-9e1f-4340-bb30-1acabd962dc1","msg":"User credentials created"}
{"level":30,"time":1768249309820,"env":"test","module":"email-queue","jobId":"81c5338b-9260-4738-8575-06078f27a9b2","to":"protected-test-2jiTuotEV4RAqBIyZxFJg@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249309866,"env":"test","module":"auth-routes","userId":"0f618fe3-ec03-40f0-a995-356ad375f351","email":"protected-test-2jiTuotEV4RAqBIyZxFJg@example.com","msg":"User registered"}
{"level":30,"time":1768249309880,"env":"test","module":"email-queue","jobId":"81923552-71fe-4324-b090-5cd37bc39cae","to":"session-test-Jn-8ONmFuBJPsP9r-dGp-@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249309887,"env":"test","module":"user-credentials-repository","userId":"9c6342c7-4f0c-44a2-8706-525b8f99e79c","msg":"User credentials created"}
{"level":30,"time":1768249309929,"env":"test","module":"auth-routes","userId":"461d5d10-9e1f-4340-bb30-1acabd962dc1","email":"session-test-Jn-8ONmFuBJPsP9r-dGp-@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle multiple Authorization headers
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249309984,"env":"test","module":"email-queue","jobId":"635113e4-8adb-4f3d-b961-523d1a2498c0","to":"middleware-test-2FMmnx2YCzddIHvuQ4nxC@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mConcurrent Session Handling[2m > [22m[2mshould handle concurrent token refreshes
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249310035,"env":"test","module":"auth-routes","userId":"9c6342c7-4f0c-44a2-8706-525b8f99e79c","email":"middleware-test-2FMmnx2YCzddIHvuQ4nxC@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould proceed anonymously if both JWT and cookie are invalid
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249310110,"env":"test","module":"auth-routes","userId":"0f618fe3-ec03-40f0-a995-356ad375f351","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249310172,"env":"test","module":"auth-routes","userId":"461d5d10-9e1f-4340-bb30-1acabd962dc1","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249310199,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle multiple Authorization headers
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768249310234,"env":"test","module":"auth-routes","userId":"9c6342c7-4f0c-44a2-8706-525b8f99e79c","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249310269,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Concurrent Session Handling > should handle concurrent token refreshes
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768249310328,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > optionalHybridAuth Middleware > should proceed anonymously if both JWT and cookie are invalid
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > optionalHybridAuth Middleware > should proceed anonymously if both JWT and cookie are invalid
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:21:50.329Z'
  }
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould proceed anonymously if both JWT and cookie are invalid
[22m[39mUser in DB: {
  id: [32m'9c6342c7-4f0c-44a2-8706-525b8f99e79c'[39m,
  email: [32m'middleware-test-2FMmnx2YCzddIHvuQ4nxC@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:21:52.774Z[39m,
  updatedAt: [35m2026-01-12T20:21:52.774Z[39m
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould proceed anonymously if both JWT and cookie are invalid
[22m[39mCreds in DB: [90mundefined[39m

{"level":30,"time":1768249310541,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768249310541,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768249310564,"env":"test","module":"user-credentials-repository","userId":"0b6e5ee6-261b-44fa-a0bd-2c77a77be44b","msg":"User credentials created"}
{"level":30,"time":1768249310658,"env":"test","module":"email-queue","jobId":"7119d8fb-3f09-4242-90bc-d5387d94937a","to":"protected-test-_GC_5CPCkAxPecyFZCjOJ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249310705,"env":"test","module":"auth-routes","userId":"0b6e5ee6-261b-44fa-a0bd-2c77a77be44b","email":"protected-test-_GC_5CPCkAxPecyFZCjOJ@example.com","msg":"User registered"}
{"level":30,"time":1768249310800,"env":"test","module":"user-credentials-repository","userId":"025a1a82-32a4-4bd3-89f4-3437b50468ba","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould reject token with SQL injection attempt
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w3_4c523371

{"level":30,"time":1768249310913,"env":"test","module":"email-queue","jobId":"65133dad-15bc-496a-8e76-02b294901a0e","to":"middleware-test-WUgWMQzdtqekm85GJcooI@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
 [31mÎ“Â¥Â»[39m tests/integration/auth/session.management.integration.test.ts [2m([22m[2m18 tests[22m[2m | [22m[31m13 failed[39m[2m)[22m[33m 24914[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should create refresh token on login[39m[33m 941[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should track device metadata in session[39m[33m 899[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should create separate sessions for multiple device logins[39m[33m 1455[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all active sessions for user[39m[33m 931[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should mark current session correctly[39m[33m 887[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should not include revoked sessions[39m[33m 879[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should order sessions by last used (most recent first)[39m[33m 883[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 625[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific session[39m[33m 1405[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking current session[39m[33m 902[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should not allow revoking other users sessions[39m[33m 1489[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 404 for non-existent session ID [33m 1226[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke all sessions except current[39m[33m 1925[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke all trusted devices [33m 1607[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require active session [33m 622[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject refresh token after 30 days [33m 1283[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should handle multiple concurrent logins[39m[33m 1176[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should handle concurrent token refreshes[39m[33m 865[2mms[22m[39m
{"level":50,"time":1768249310955,"env":"test","module":"auth-routes","userId":"0b6e5ee6-261b-44fa-a0bd-2c77a77be44b","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768249310967,"env":"test","module":"auth-routes","userId":"025a1a82-32a4-4bd3-89f4-3437b50468ba","email":"middleware-test-WUgWMQzdtqekm85GJcooI@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mCookie Strategy Security[2m > [22m[2mshould only allow safe methods for cookie auth
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249311047,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with SQL injection attempt
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768249311167,"env":"test","module":"auth-routes","userId":"025a1a82-32a4-4bd3-89f4-3437b50468ba","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249311265,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > Cookie Strategy Security > should only allow safe methods for cookie auth
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > Cookie Strategy Security > should only allow safe methods for cookie auth
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:21:51.265Z'
  }
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mCookie Strategy Security[2m > [22m[2mshould only allow safe methods for cookie auth
[22m[39mUser in DB: {
  id: [32m'025a1a82-32a4-4bd3-89f4-3437b50468ba'[39m,
  email: [32m'middleware-test-WUgWMQzdtqekm85GJcooI@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:21:53.686Z[39m,
  updatedAt: [35m2026-01-12T20:21:53.686Z[39m
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mCookie Strategy Security[2m > [22m[2mshould only allow safe methods for cookie auth
[22m[39mCreds in DB: [90mundefined[39m

{"level":30,"time":1768249311410,"env":"test","module":"user-credentials-repository","userId":"47010d25-ff6e-4a0a-a40b-3d957a370e51","msg":"User credentials created"}
{"level":30,"time":1768249311507,"env":"test","module":"email-queue","jobId":"1d600624-79bf-4f23-9870-0b6c786f8319","to":"protected-test-085Eb9Wh079PlxSH_da30@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249311554,"env":"test","module":"auth-routes","userId":"47010d25-ff6e-4a0a-a40b-3d957a370e51","email":"protected-test-085Eb9Wh079PlxSH_da30@example.com","msg":"User registered"}
{"level":30,"time":1768249311613,"env":"test","module":"email-queue","jobId":"2f709431-06f6-41a1-9932-31975d9665b3","to":"test-1768249311082-f89ps6@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249311614,"env":"test","module":"auth-service","email":"test-1768249311082-f89ps6@example.com","msg":"Password reset email sent"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould reject token with XSS attempt
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249311725,"env":"test","module":"user-credentials-repository","userId":"922f7c57-98d2-463b-b6b4-3672fa2a9c4f","msg":"User credentials created"}
{"level":30,"time":1768249311819,"env":"test","module":"email-queue","jobId":"cbfacdb4-8b99-4bf4-9760-7ec52de045b2","to":"middleware-test-V3FPSCyFXoI1vfdZNuJ_W@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249311865,"env":"test","module":"auth-routes","userId":"922f7c57-98d2-463b-b6b4-3672fa2a9c4f","email":"middleware-test-V3FPSCyFXoI1vfdZNuJ_W@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mCookie Strategy Security[2m > [22m[2mshould ignore cookies when Bearer token present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249311966,"env":"test","module":"user-credentials-repository","userId":"dd54d232d11cc33c854283b90723c56c","msg":"User password updated"}
{"level":30,"time":1768249312107,"env":"test","module":"audit-log-service","userId":"dd54d232d11cc33c854283b90723c56c","eventType":"password_reset","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/reset-password[2m > [22m[2mshould reset password with valid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249312147,"env":"test","module":"auth-routes","userId":"47010d25-ff6e-4a0a-a40b-3d957a370e51","msg":"User logged in successfully"}
{"level":30,"time":1768249312194,"env":"test","module":"audit-log-service","userId":"47010d25-ff6e-4a0a-a40b-3d957a370e51","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768249312197,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249312384,"env":"test","module":"auth-routes","userId":"922f7c57-98d2-463b-b6b4-3672fa2a9c4f","msg":"User logged in successfully"}
{"level":30,"time":1768249312432,"env":"test","module":"audit-log-service","userId":"922f7c57-98d2-463b-b6b4-3672fa2a9c4f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249312558,"env":"test","module":"user-credentials-repository","userId":"53d564cd-959b-478a-81f1-83a67cb87e9a","msg":"User credentials created"}
{"level":30,"time":1768249312579,"env":"test","module":"auth-routes","userId":"dd54d232d11cc33c854283b90723c56c","msg":"User logged in successfully"}
{"level":30,"time":1768249312625,"env":"test","module":"audit-log-service","userId":"dd54d232d11cc33c854283b90723c56c","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/reset-password[2m > [22m[2mshould reset password with valid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249312650,"env":"test","module":"email-queue","jobId":"22c5d08e-8a63-4131-a64b-b93ea366d60a","to":"protected-test-XYiO3rDm1XlYGB_qEDNjo@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249312698,"env":"test","module":"auth-routes","userId":"53d564cd-959b-478a-81f1-83a67cb87e9a","email":"protected-test-XYiO3rDm1XlYGB_qEDNjo@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Payload Validation[2m > [22m[2mshould reject token with missing userId
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249312799,"env":"test","module":"user-credentials-repository","userId":"60b27912-be92-4b13-a39c-9b72f6f167f8","msg":"User credentials created"}
{"level":30,"time":1768249312898,"env":"test","module":"email-queue","jobId":"32a7ec48-06de-4655-aa41-62ba29d5aef8","to":"cookie-test-gNv7K-xfZ7RQ6-YcMrFaf@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249312946,"env":"test","module":"auth-routes","userId":"60b27912-be92-4b13-a39c-9b72f6f167f8","email":"cookie-test-gNv7K-xfZ7RQ6-YcMrFaf@example.com","msg":"User registered"}
{"level":50,"time":1768249312985,"env":"test","module":"auth-routes","email":"test-1768249311082-f89ps6@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mCookie Strategy Security[2m > [22m[2mshould ignore cookies when Bearer token present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249313074,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/reset-password > should reset password with valid token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768249313292,"env":"test","module":"auth-routes","userId":"53d564cd-959b-478a-81f1-83a67cb87e9a","msg":"User logged in successfully"}
{"level":30,"time":1768249313337,"env":"test","module":"audit-log-service","userId":"53d564cd-959b-478a-81f1-83a67cb87e9a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249313456,"env":"test","module":"auth-routes","userId":"60b27912-be92-4b13-a39c-9b72f6f167f8","msg":"User logged in successfully"}
{"level":30,"time":1768249313504,"env":"test","module":"audit-log-service","userId":"60b27912-be92-4b13-a39c-9b72f6f167f8","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249313705,"env":"test","module":"user-credentials-repository","userId":"c55207b7-42ee-4028-b32a-9fb20f24cfef","msg":"User credentials created"}
{"level":30,"time":1768249313804,"env":"test","module":"email-queue","jobId":"86f83496-2a08-48ac-9dbf-e9e34dada823","to":"protected-test-5lEU2QmVWP-O7B4H5ukdm@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249313850,"env":"test","module":"auth-routes","userId":"c55207b7-42ee-4028-b32a-9fb20f24cfef","email":"protected-test-5lEU2QmVWP-O7B4H5ukdm@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Payload Validation[2m > [22m[2mshould reject token with non-existent userId
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249313980,"env":"test","module":"user-credentials-repository","userId":"d2f0c1d0-64ed-4c07-8eee-9bdeee206f6c","msg":"User credentials created"}
{"level":30,"time":1768249314078,"env":"test","module":"email-queue","jobId":"abe7c1c8-1cde-4cd2-aeec-389525ffc67a","to":"middleware-test-ZwgcLdKm7urGe9vXq1cR1@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768249314079,"env":"test","module":"auth-routes","userId":"c55207b7-42ee-4028-b32a-9fb20f24cfef","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768249314126,"env":"test","module":"auth-routes","userId":"d2f0c1d0-64ed-4c07-8eee-9bdeee206f6c","email":"middleware-test-ZwgcLdKm7urGe9vXq1cR1@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mUser Context Attachment[2m > [22m[2mshould attach userId to request
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249314177,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768249314323,"env":"test","module":"auth-routes","userId":"d2f0c1d0-64ed-4c07-8eee-9bdeee206f6c","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249314424,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > User Context Attachment > should attach userId to request
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > User Context Attachment > should attach userId to request
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:21:54.425Z'
  }
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mUser Context Attachment[2m > [22m[2mshould attach userId to request
[22m[39mUser in DB: {
  id: [32m'd2f0c1d0-64ed-4c07-8eee-9bdeee206f6c'[39m,
  email: [32m'middleware-test-ZwgcLdKm7urGe9vXq1cR1@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:21:56.866Z[39m,
  updatedAt: [35m2026-01-12T20:21:56.866Z[39m
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mUser Context Attachment[2m > [22m[2mshould attach userId to request
[22m[39mCreds in DB: [90mundefined[39m

{"level":30,"time":1768249314546,"env":"test","module":"user-credentials-repository","userId":"cf4584d0-197e-4f1d-80c7-e4f38d1f4ac3","msg":"User credentials created"}
{"level":30,"time":1768249314644,"env":"test","module":"email-queue","jobId":"972a2a90-d715-4417-949c-47b1fb5289b2","to":"protected-test-erY6ZGzs3WobSUom_hinb@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249314690,"env":"test","module":"auth-routes","userId":"cf4584d0-197e-4f1d-80c7-e4f38d1f4ac3","email":"protected-test-erY6ZGzs3WobSUom_hinb@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mCross-User Authorization[2m > [22m[2mshould not allow user to access another user's resources
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249314894,"env":"test","module":"user-credentials-repository","userId":"65819aae-df6f-451e-bece-8614813f9c5d","msg":"User credentials created"}
{"level":50,"time":1768249314929,"env":"test","module":"auth-routes","userId":"cf4584d0-197e-4f1d-80c7-e4f38d1f4ac3","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768249314990,"env":"test","module":"email-queue","jobId":"06cd2427-909b-49c1-9171-25cd9c526239","to":"middleware-test-Hnib5VsNzRjwhQTf01ysw@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768249315020,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768249315038,"env":"test","module":"auth-routes","userId":"65819aae-df6f-451e-bece-8614813f9c5d","email":"middleware-test-Hnib5VsNzRjwhQTf01ysw@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mUser Context Attachment[2m > [22m[2mshould attach userEmail to request
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249315119,"env":"test","module":"email-queue","jobId":"3e2a625c-b9f4-4c52-b588-04fbb4b8733d","to":"test-1768249314568-xsowyb@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249315120,"env":"test","module":"auth-service","email":"test-1768249314568-xsowyb@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768249315390,"env":"test","module":"user-credentials-repository","userId":"4fcd7763-be7b-4ea0-907c-9f3c28071a7d","msg":"User credentials created"}
{"level":30,"time":1768249315485,"env":"test","module":"email-queue","jobId":"e6bb10f3-564f-457a-8738-e1789cef6419","to":"protected-test-NqdHGAxr5zMJBvbKz-OvP@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249315532,"env":"test","module":"auth-routes","userId":"4fcd7763-be7b-4ea0-907c-9f3c28071a7d","email":"protected-test-NqdHGAxr5zMJBvbKz-OvP@example.com","msg":"User registered"}
{"level":30,"time":1768249315546,"env":"test","module":"auth-routes","userId":"65819aae-df6f-451e-bece-8614813f9c5d","msg":"User logged in successfully"}
{"level":30,"time":1768249315595,"env":"test","module":"audit-log-service","userId":"65819aae-df6f-451e-bece-8614813f9c5d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mUser Context Injection[2m > [22m[2mshould inject userId into request context
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249315762,"env":"test","module":"auth-routes","userId":"4fcd7763-be7b-4ea0-907c-9f3c28071a7d","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249315859,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768249316062,"env":"test","module":"user-credentials-repository","userId":"c7542e72-99fd-4620-898e-79f86f535bbb","msg":"User credentials created"}
{"level":30,"time":1768249316158,"env":"test","module":"email-queue","jobId":"0c183246-2ac2-4a14-8522-d5a2566c9cc5","to":"middleware-test-wHEvuFC7OP3_C9NrDDmSH@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249316206,"env":"test","module":"auth-routes","userId":"c7542e72-99fd-4620-898e-79f86f535bbb","email":"middleware-test-wHEvuFC7OP3_C9NrDDmSH@example.com","msg":"User registered"}
{"level":30,"time":1768249316235,"env":"test","module":"user-credentials-repository","userId":"fecc3c6b-b54a-46de-82c2-ced01c36e600","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould return consistent error format for missing token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249316338,"env":"test","module":"email-queue","jobId":"7b3f23f9-4f1f-4e2b-b721-7f8ac72d8338","to":"protected-test-Qr7ZJu4FvlZy-0tfpWkoI@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mGET /api/auth/me[2m > [22m[2mshould return current user for valid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249316388,"env":"test","module":"auth-routes","userId":"fecc3c6b-b54a-46de-82c2-ced01c36e600","email":"protected-test-Qr7ZJu4FvlZy-0tfpWkoI@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mUser Context Injection[2m > [22m[2mshould inject tenantId into request context
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249316720,"env":"test","module":"auth-routes","userId":"c7542e72-99fd-4620-898e-79f86f535bbb","msg":"User logged in successfully"}
{"level":30,"time":1768249316767,"env":"test","module":"audit-log-service","userId":"c7542e72-99fd-4620-898e-79f86f535bbb","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768249316771,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249316796,"env":"test","module":"auth-routes","userId":"78b3ffdadb8595250340c129da6bb3ed","msg":"User logged in successfully"}
{"level":30,"time":1768249316840,"env":"test","module":"audit-log-service","userId":"78b3ffdadb8595250340c129da6bb3ed","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249316994,"env":"test","module":"auth-routes","userId":"fecc3c6b-b54a-46de-82c2-ced01c36e600","msg":"User logged in successfully"}
{"level":30,"time":1768249317039,"env":"test","module":"audit-log-service","userId":"fecc3c6b-b54a-46de-82c2-ced01c36e600","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249317147,"env":"test","module":"user-credentials-repository","userId":"45448d78-cc20-4095-9577-8d29b869377b","msg":"User credentials created"}
{"level":30,"time":1768249317242,"env":"test","module":"email-queue","jobId":"84b46e29-e506-45c9-88c9-fa678ac5704d","to":"middleware-test-oZ_pwFZ55vtfIvRxti_84@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249317293,"env":"test","module":"auth-routes","userId":"45448d78-cc20-4095-9577-8d29b869377b","email":"middleware-test-oZ_pwFZ55vtfIvRxti_84@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould return consistent error format for invalid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249317460,"env":"test","module":"user-credentials-repository","userId":"0b9bfc9b-aafd-4511-a4c6-ea63c451d948","msg":"User credentials created"}
{"level":50,"time":1768249317488,"env":"test","module":"auth-routes","userId":"45448d78-cc20-4095-9577-8d29b869377b","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768249317550,"env":"test","module":"email-queue","jobId":"f8233bb2-282b-46d8-bcd6-8a25d7416f19","to":"protected-test-eOZJVvkscDWX3hktjqgpT@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768249317582,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > Error Handling > should return consistent error format for invalid token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > Error Handling > should return consistent error format for invalid token
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:21:57.583Z'
  }
}

{"level":30,"time":1768249317597,"env":"test","module":"auth-routes","userId":"0b9bfc9b-aafd-4511-a4c6-ea63c451d948","email":"protected-test-eOZJVvkscDWX3hktjqgpT@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould return consistent error format for invalid token
[22m[39mUser in DB: {
  id: [32m'45448d78-cc20-4095-9577-8d29b869377b'[39m,
  email: [32m'middleware-test-oZ_pwFZ55vtfIvRxti_84@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:22:00.031Z[39m,
  updatedAt: [35m2026-01-12T20:22:00.031Z[39m
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould return consistent error format for invalid token
[22m[39mCreds in DB: [90mundefined[39m

{"level":50,"time":1768249317686,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mUser Context Injection[2m > [22m[2mshould inject role into request context
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249317833,"env":"test","module":"auth-routes","userId":"0b9bfc9b-aafd-4511-a4c6-ea63c451d948","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768249317925,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject role into request context
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768249318052,"env":"test","module":"user-credentials-repository","userId":"ad67716f-7c2d-4f4a-bf7d-4cb1b6f99a57","msg":"User credentials created"}
{"level":30,"time":1768249318152,"env":"test","module":"email-queue","jobId":"f49a2046-5a21-4bf0-bfbe-aade451b5fd0","to":"middleware-test-oAd0DC8ysflCC1EBQJsuN@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249318199,"env":"test","module":"auth-routes","userId":"ad67716f-7c2d-4f4a-bf7d-4cb1b6f99a57","email":"middleware-test-oAd0DC8ysflCC1EBQJsuN@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould return consistent error format for expired token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249318286,"env":"test","module":"user-credentials-repository","userId":"bdc29046-9379-4f66-be44-39b883dbc648","msg":"User credentials created"}
{"level":30,"time":1768249318379,"env":"test","module":"email-queue","jobId":"d4ca1e85-010c-4000-97cd-2d45d5a42db3","to":"protected-test-dsugdI5P4Lo7cCCneu8ye@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768249318398,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249318426,"env":"test","module":"auth-routes","userId":"bdc29046-9379-4f66-be44-39b883dbc648","email":"protected-test-dsugdI5P4Lo7cCCneu8ye@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mRate Limiting on Protected Routes[2m > [22m[2mshould not apply general rate limiting to authenticated requests
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249318659,"env":"test","module":"auth-routes","userId":"bdc29046-9379-4f66-be44-39b883dbc648","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768249318703,"env":"test","module":"auth-routes","userId":"ad67716f-7c2d-4f4a-bf7d-4cb1b6f99a57","msg":"User logged in successfully"}
{"level":30,"time":1768249318752,"env":"test","module":"audit-log-service","userId":"ad67716f-7c2d-4f4a-bf7d-4cb1b6f99a57","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768249318754,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Rate Limiting on Protected Routes > should not apply general rate limiting to authenticated requests
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768249319129,"env":"test","module":"user-credentials-repository","userId":"8715fb8c-d7c7-4fe5-aa60-57d03306d742","msg":"User credentials created"}
{"level":30,"time":1768249319222,"env":"test","module":"email-queue","jobId":"63dbf710-9a87-42b2-ac43-dc4a0d0192d2","to":"protected-test-bHqMJgQTOsHss-fineP4c@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249319269,"env":"test","module":"auth-routes","userId":"8715fb8c-d7c7-4fe5-aa60-57d03306d742","email":"protected-test-bHqMJgQTOsHss-fineP4c@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould handle request with both Bearer token and cookies
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould complete MFA login with valid TOTP code
[22m[39m[TEST UTILS] MFA Secret verified for 08deba1b75a9948a2cdd6d6c79b59db5

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould complete MFA login with valid TOTP code
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768249319859,"env":"test","module":"auth-middleware","error":{"name":"TokenExpiredError","code":"AUTH_002","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768249319859,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249319864,"env":"test","module":"auth-routes","userId":"8715fb8c-d7c7-4fe5-aa60-57d03306d742","msg":"User logged in successfully"}
{"level":30,"time":1768249319919,"env":"test","module":"audit-log-service","userId":"8715fb8c-d7c7-4fe5-aa60-57d03306d742","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould handle request with both Bearer token and cookies
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249320241,"env":"test","module":"user-credentials-repository","userId":"9db50d03-0773-4071-aea9-b1591ce40142","msg":"User credentials created"}
{"level":30,"time":1768249320268,"env":"test","module":"auth-routes","userId":"08deba1b75a9948a2cdd6d6c79b59db5","msg":"Login requires MFA verification"}
{"level":30,"time":1768249320352,"env":"test","module":"email-queue","jobId":"523e9e76-41ad-429c-bff8-8411efa561de","to":"middleware-test-0SAoAgWziuK9bfhuCJ_wm@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249320368,"env":"test","module":"mfa-service","userId":"08deba1b75a9948a2cdd6d6c79b59db5","msg":"TOTP verification successful"}
{"level":30,"time":1768249320403,"env":"test","module":"auth-routes","userId":"9db50d03-0773-4071-aea9-b1591ce40142","email":"middleware-test-0SAoAgWziuK9bfhuCJ_wm@example.com","msg":"User registered"}
{"level":30,"time":1768249320415,"env":"test","module":"auth-routes","userId":"08deba1b75a9948a2cdd6d6c79b59db5","msg":"MFA login successful"}
{"level":30,"time":1768249320422,"env":"test","module":"auth-routes","userId":"8715fb8c-d7c7-4fe5-aa60-57d03306d742","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould handle malformed JWT gracefully
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249320469,"env":"test","module":"audit-log-service","userId":"8715fb8c-d7c7-4fe5-aa60-57d03306d742","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249320892,"env":"test","module":"user-credentials-repository","userId":"838372c6-4c1f-4349-8efe-2dd1494e3279","msg":"User credentials created"}
{"level":30,"time":1768249320910,"env":"test","module":"auth-routes","userId":"9db50d03-0773-4071-aea9-b1591ce40142","msg":"User logged in successfully"}
{"level":30,"time":1768249320959,"env":"test","module":"audit-log-service","userId":"9db50d03-0773-4071-aea9-b1591ce40142","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768249320962,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768249320962,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249320981,"env":"test","module":"email-queue","jobId":"837666d6-6fb7-492d-acaa-1b032b1408fb","to":"protected-test-GqF0L6QN5j4TSrmvYTCkt@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249321029,"env":"test","module":"auth-routes","userId":"838372c6-4c1f-4349-8efe-2dd1494e3279","email":"protected-test-GqF0L6QN5j4TSrmvYTCkt@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould prioritize Bearer token over cookie when both present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768249321271,"env":"test","module":"auth-routes","userId":"838372c6-4c1f-4349-8efe-2dd1494e3279","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768249321327,"env":"test","module":"user-credentials-repository","userId":"489b7598-213d-4355-8be9-3d42745bcf21","msg":"User credentials created"}
{"level":50,"time":1768249321364,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768249321427,"env":"test","module":"email-queue","jobId":"d83fd906-e717-40b9-adad-b8910fc7fc7c","to":"middleware-test-CW1DvSrAqm-DKA1FkvcZI@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249321482,"env":"test","module":"auth-routes","userId":"489b7598-213d-4355-8be9-3d42745bcf21","email":"middleware-test-CW1DvSrAqm-DKA1FkvcZI@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould handle JWT with wrong algorithm
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould reject invalid MFA code
[22m[39m[TEST UTILS] MFA Secret verified for a97f0837a4be33c3835016654307a2bc

{"level":30,"time":1768249321720,"env":"test","module":"user-credentials-repository","userId":"f53f3dec-04a8-47be-8783-9d0d4dbdab3d","msg":"User credentials created"}
{"level":30,"time":1768249321810,"env":"test","module":"email-queue","jobId":"e30f7db2-c29d-4688-83c2-13fd7a1f3048","to":"protected-test-9lqwXF2_uJR14SQsTAf-X@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249321864,"env":"test","module":"auth-routes","userId":"f53f3dec-04a8-47be-8783-9d0d4dbdab3d","email":"protected-test-9lqwXF2_uJR14SQsTAf-X@example.com","msg":"User registered"}
{"level":40,"time":1768249321961,"env":"test","module":"mfa-service","userId":"a97f0837a4be33c3835016654307a2bc","msg":"TOTP verification failed"}
{"level":40,"time":1768249321961,"env":"test","module":"auth-routes","userId":"a97f0837a4be33c3835016654307a2bc","msg":"MFA verification failed during login"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mOptional Auth Routes[2m > [22m[2mshould allow unauthenticated access to optional auth routes
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249321987,"env":"test","module":"auth-routes","userId":"489b7598-213d-4355-8be9-3d42745bcf21","msg":"User logged in successfully"}
{"level":30,"time":1768249322043,"env":"test","module":"audit-log-service","userId":"489b7598-213d-4355-8be9-3d42745bcf21","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768249322046,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768249322047,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249322310,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768249322310,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768249322346,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768249322346,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768249322470,"env":"test","module":"auth-routes","userId":"f53f3dec-04a8-47be-8783-9d0d4dbdab3d","msg":"User logged in successfully"}
{"level":30,"time":1768249322521,"env":"test","module":"audit-log-service","userId":"f53f3dec-04a8-47be-8783-9d0d4dbdab3d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w2_6e401245

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w0_f96da1d2

 [31mÎ“Â¥Â»[39m tests/integration/auth/auth.middleware.integration.test.ts [2m([22m[2m27 tests[22m[2m | [22m[31m13 failed[39m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 36681[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow access with valid JWT Bearer token[39m[33m 983[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 401 when no token provided[39m[33m 930[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 with invalid token [33m 1108[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 with expired token [33m 2216[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should proceed without authentication if no token provided
[31m       [31mâ”œÃ¹[31m should authenticate with JWT Bearer token[39m[33m 914[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should authenticate with refresh token cookie (GET only)[39m[33m 1147[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject cookie auth for POST requests (mutation-strict) [33m 1100[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject cookie auth for PUT requests[39m[33m 919[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject cookie auth for DELETE requests [33m 1092[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow cookie auth for HEAD requests[39m[33m 961[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prioritize JWT over cookie when both present [33m 2325[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 401 when no auth provided[39m[33m 913[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 when both JWT and cookie are invalid [33m 1112[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should authenticate with JWT if provided[39m[33m 910[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should authenticate with cookie if JWT not provided [33m 1619[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should proceed anonymously if no auth provided[39m[33m 931[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should proceed anonymously if both JWT and cookie are invalid[39m[33m 918[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should only allow safe methods for cookie auth[39m[33m 932[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should ignore cookies when Bearer token present [33m 2242[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should attach userId to request[39m[33m 913[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should attach userEmail to request [33m 1178[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return consistent error format for missing token [33m 1076[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return consistent error format for invalid token[39m[33m 913[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return consistent error format for expired token [33m 2174[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle malformed JWT gracefully [33m 1102[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle JWT with wrong algorithm [33m 1085[2mms[22m[39m
 [31mÎ“Â¥Â»[39m tests/integration/auth.routes.real.test.ts [2m([22m[2m26 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 41547[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should register a new user successfully [33m 1381[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 400 for invalid email format [33m 785[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 400 for weak password [33m 740[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 409 for duplicate email [33m 1313[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set httpOnly refresh token cookie [33m 1237[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should login with valid credentials [33m 1651[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for invalid password [33m 1585[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for non-existent user [33m 919[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 403 for unverified email[39m[33m 1521[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should record failed login attempt [33m 1645[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return requiresMfa=true for MFA-enabled users [33m 1925[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should lock account after 5 failed attempts[39m[33m 3261[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should logout and clear refresh token cookie [33m 1690[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should refresh access token with valid refresh token [33m 1802[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for missing refresh token [33m 734[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should rotate refresh token after use [33m 1901[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should send password reset email for existing user [33m 1304[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not reveal if email exists (security) [33m 778[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reset password with valid token [33m 2721[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 400 for invalid token [33m 760[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 400 for weak new password [33m 1407[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return current user for valid token [33m 1717[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for missing token [33m 725[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for invalid token [33m 719[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should complete MFA login with valid TOTP code [33m 2025[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should reject invalid MFA code [33m 1561[2mms[22m[39m
{"level":30,"time":1768249323008,"env":"test","module":"intake-service","runId":"5f304c86-b4eb-48a9-b71f-937974cf70d6","slug":"public-96TqrAToa4LBafAG37nRa","msg":"Created intake run"}
{"level":30,"time":1768249323401,"env":"test","module":"user-credentials-repository","userId":"c0f18d8c-8ce4-4434-a7d0-cc844db05f56","msg":"User credentials created"}
{"level":30,"time":1768249323496,"env":"test","module":"email-queue","jobId":"4ea06f49-b6b6-4381-8f89-607dfcc2a845","to":"protected-test-MpADvlKGPlFKq5QZln76O@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249323543,"env":"test","module":"auth-routes","userId":"c0f18d8c-8ce4-4434-a7d0-cc844db05f56","email":"protected-test-MpADvlKGPlFKq5QZln76O@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mOptional Auth Routes[2m > [22m[2mshould enhance optional auth routes with user context when authenticated
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249324120,"env":"test","module":"auth-routes","userId":"c0f18d8c-8ce4-4434-a7d0-cc844db05f56","msg":"User logged in successfully"}
{"level":30,"time":1768249324167,"env":"test","module":"audit-log-service","userId":"c0f18d8c-8ce4-4434-a7d0-cc844db05f56","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249324651,"env":"test","module":"intake-service","runId":"913ec839-0490-4380-895e-539eb9e3870c","slug":"optional-HhnqVrmIDxLaxNrdKybFp","userId":"c0f18d8c-8ce4-4434-a7d0-cc844db05f56","msg":"Created intake run"}
{"level":30,"time":1768249325156,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768249325156,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w1_61772983

 [31mÎ“Â¥Â»[39m tests/integration/auth/protected.routes.test.ts [2m([22m[2m33 tests[22m[2m | [22m[31m18 failed[39m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 39528[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow access with valid Bearer token[39m[33m 893[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject access without Authorization header[39m[33m 866[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject access with empty Bearer token [33m 1196[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject access with malformed Authorization header [33m 1193[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject access with wrong token type[39m[33m 861[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow POST with valid Bearer token[39m[33m 874[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject POST without Bearer token[39m[33m 870[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject POST with invalid token[39m[33m 851[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow PUT with valid Bearer token [33m 1321[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject PUT without Bearer token[39m[33m 861[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow DELETE with valid Bearer token [33m 1390[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject DELETE without Bearer token [33m 1205[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow PATCH with valid Bearer token [33m 1821[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject PATCH without Bearer token [33m 1163[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should handle Bearer token with extra spaces[39m[33m 838[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should handle token with newlines
[31m       [31mâ”œÃ¹[31m should handle very long invalid token[39m[33m 853[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle empty Authorization header [33m 1146[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should handle Authorization header with only Bearer[39m[33m 863[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should handle multiple Authorization headers[39m[33m 842[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject token with SQL injection attempt[39m[33m 848[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject token with XSS attempt [33m 1149[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject token with missing userId [33m 1145[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject token with non-existent userId[39m[33m 836[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should not allow user to access another user's resources[39m[33m 843[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should inject userId into request context[39m[33m 839[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should inject tenantId into request context [33m 1231[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should inject role into request context[39m[33m 835[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should not apply general rate limiting to authenticated requests[39m[33m 829[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle request with both Bearer token and cookies [33m 1765[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prioritize Bearer token over cookie when both present[39m[33m 845[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow unauthenticated access to optional auth routes [33m 1688[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should enhance optional auth routes with user context when authenticated [33m 1697[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 70 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Complete Registration Î“Ã¥Ã† Login Flow > should complete registration, verify email, then login
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:70:36
     68|         .send({ email, password });
     69| 
     70|       expect(loginAttempt2.status).toBe(200);
       |                                    ^
     71|       expect(loginAttempt2.body.token).toBeDefined();
     72|       expect(loginAttempt2.body.user.emailVerified).toBe(true);

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/70]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
AssertionError: expected 401 to be 423 // Object.is equality

- Expected
+ Received

- 423
+ 401

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:110:36
    108|         });
    109| 
    110|       expect(lockedAttempt.status).toBe(423);
       |                                    ^
    111|       expect(lockedAttempt.body.message || lockedAttempt.body.error).tÎ“Ã‡Âª
    112| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/70]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should record all login attempts
AssertionError: expected 2 to be 3 // Object.is equality

- Expected
+ Received

- 3
+ 2

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:145:31
    143|       });
    144| 
    145|       expect(attempts.length).toBe(3);
       |                               ^
    146|       expect(attempts.filter(a => !a.successful).length).toBe(2);
    147|       expect(attempts.filter(a => a.successful).length).toBe(1);

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/70]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > MFA Enrollment and Login Flow > should complete MFA setup and login with TOTP
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:203:37
    201|         .send({ email, password });
    202| 
    203|       expect(login2Response.status).toBe(200);
       |                                     ^
    204|       expect(login2Response.body.requiresMfa).toBe(true);
    205|       expect(login2Response.body.userId).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/70]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > MFA Enrollment and Login Flow > should login with backup code when TOTP unavailable
TypeError: Cannot read properties of undefined (reading 'secret')
 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:248:52
    246|       });
    247| 
    248|       const totpCode = generateTotpCode(mfaSecret!.secret);
       |                                                    ^
    249| 
    250|       await request(app)

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/70]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Password Reset Flow > should complete full password reset flow
AssertionError: expected 500 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 500

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:332:36
    330|         });
    331| 
    332|       expect(resetResponse.status).toBe(200);
       |                                    ^
    333| 
    334|       // Step 4: Verify old password no longer works

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/70]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Token Refresh Flow > should rotate refresh token on each use
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:405:40
    403| 
    404|       let cookies = loginResponse.headers['set-cookie'] as unknown as Î“Ã‡Âª
    405|       let refreshTokenCookie = cookies.find(c => c.startsWith('refreshÎ“Ã‡Âª
       |                                        ^
    406| 
    407|       expect(refreshTokenCookie).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/70]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Session Management Flow > should list all active sessions
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:492:39
    490|         .set("Authorization", `Bearer ${token}`);
    491| 
    492|       expect(sessionsResponse.status).toBe(200);
       |                                       ^
    493|       expect(sessionsResponse.body.sessions).toBeDefined();
    494|       expect(sessionsResponse.body.sessions.length).toBeGreaterThanOrEÎ“Ã‡Âª

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/70]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Session Management Flow > should revoke specific session
TypeError: Cannot read properties of undefined (reading 'id')
 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:521:55
    519|       // Revoke first session
    520|       const revokeResponse = await request(app)
    521|         .delete(`/api/auth/sessions/${sessionToRevoke.id}`)
       |                                                       ^
    522|         .set("Authorization", `Bearer ${token}`);
    523| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/70]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should return 403 for unverified email
AssertionError: expected 401 to be 403 // Object.is equality

- Expected
+ Received

- 403
+ 401

 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:192:31
    190|         .send({ email, password });
    191| 
    192|       expect(response.status).toBe(403);
       |                               ^
    193|       expect(response.body.message || response.body.error).toBeDefinedÎ“Ã‡Âª
    194|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/70]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
AssertionError: expected 401 to be 423 // Object.is equality

- Expected
+ Received

- 423
+ 401

 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:250:31
    248|         });
    249| 
    250|       expect(response.status).toBe(423);
       |                               ^
    251|       expect(response.body).toBeDefined();
    252|       expect(response.body.error || response.body.message).toBeDefinedÎ“Ã‡Âª

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[11/70]Î“Ã„Â»

 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should allow access with valid JWT Bearer token
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should return 401 when no token provided
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should authenticate with JWT Bearer token
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should reject cookie auth for PUT requests
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should allow cookie auth for HEAD requests
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should return 401 when no auth provided
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > optionalHybridAuth Middleware > should authenticate with JWT if provided
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > optionalHybridAuth Middleware > should proceed anonymously if no auth provided
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > optionalHybridAuth Middleware > should proceed anonymously if both JWT and cookie are invalid
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > Cookie Strategy Security > should only allow safe methods for cookie auth
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > User Context Attachment > should attach userId to request
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > Error Handling > should return consistent error format for invalid token
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth/auth.middleware.integration.test.ts:82:33
     80|         }
     81| 
     82|         expect(loginRes.status).toBe(200);
       |                                 ^
     83| 
     84|         userToken = loginRes.body.token;

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[12/70]Î“Ã„Â»

 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should authenticate with refresh token cookie (GET only)
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/auth.middleware.integration.test.ts:160:18
    158|                 .get("/api/auth/me")
    159|                 .set("Cookie", refreshCookie)
    160|                 .expect(200);
       |                  ^
    161| 
    162|             expect(res.body.email).toBe(testUser.email);
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[13/70]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > JWT Token Generation > should generate valid JWT token on successful login
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:74:18
     72|                     password: testUser.password,
     73|                 })
     74|                 .expect(200);
       |                  ^
     75| 
     76|             expect(loginRes.body.token).toBeDefined();
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[14/70]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > JWT Token Generation > should include correct payload in JWT token
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:103:18
    101|                     password: testUser.password,
    102|                 })
    103|                 .expect(200);
       |                  ^
    104| 
    105|             // Decode token (without verification for inspection)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[15/70]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > JWT Token Validation > should accept valid JWT token on protected routes
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:162:18
    160|                     password: testUser.password,
    161|                 })
    162|                 .expect(200);
       |                  ^
    163| 
    164|             const meRes = await request(ctx.baseURL)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[16/70]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > JWT Token Validation > should accept request with missing Bearer prefix (lenient)
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:201:18
    199|                     password: testUser.password,
    200|                 })
    201|                 .expect(200);
       |                  ^
    202| 
    203|             await request(ctx.baseURL)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[17/70]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > Token Refresh Flow > should refresh access token using refresh token
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:521:18
    519|                     password: testUser.password,
    520|                 })
    521|                 .expect(200);
       |                  ^
    522| 
    523|             const cookies = loginRes.headers['set-cookie'];
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[18/70]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > Token Refresh Flow > should rotate refresh token on use
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:566:18
    564|                 .post("/api/auth/refresh-token")
    565|                 .set("Cookie", oldCookies)
    566|                 .expect(200);
       |                  ^
    567| 
    568|             const newCookies = refreshRes1.headers['set-cookie'];
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[19/70]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > Token Refresh Flow > should detect token reuse and revoke all user tokens
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:616:18
    614|                 .post("/api/auth/refresh-token")
    615|                 .set("Cookie", cookies)
    616|                 .expect(200);
       |                  ^
    617| 
    618|             // Reuse first refresh token (should revoke all)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[20/70]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > Logout Flow > should revoke refresh token on logout
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:650:18
    648|                     password: testUser.password,
    649|                 })
    650|                 .expect(200);
       |                  ^
    651| 
    652|             const cookies = loginRes.headers['set-cookie'];
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[21/70]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > DELETE /api/auth/sessions/:sessionId - Revoke Session > should prevent revoking current session
TypeError: Cannot read properties of undefined (reading 'id')
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:259:54
    257| 
    258|       const response = await request(app)
    259|         .delete(`/api/auth/sessions/${sessionRecord!.id}`)
       |                                                      ^
    260|         .set('Authorization', `Bearer ${authToken}`)
    261|         .set('Cookie', `refresh_token=${token}`);

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[22/70]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > Trusted Devices Management > POST /api/auth/trust-device > should update existing trusted device expiry
TypeError: Cannot read properties of undefined (reading 'lastUsedAt')
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:439:26
    437|         // Expiry should be updated
    438|         expect(devices[0].lastUsedAt?.getTime()).toBeGreaterThan(
    439|           initialDevice!.lastUsedAt?.getTime() || 0
       |                          ^
    440|         );
    441|       });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[23/70]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > POST /api/auth/refresh-token > should rotate refresh token after use
AssertionError: expected undefined to be true // Object.is equality

- Expected: 
true

+ Received: 
undefined

 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:134:33
    132|         where: eq(refreshTokens.token, hashToken(testRefreshToken)),
    133|       });
    134|       expect(oldToken?.revoked).toBe(true);
       |                                 ^
    135| 
    136|       // New token should exist and not be revoked

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[24/70]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > POST /api/auth/refresh-token > should update refresh token metadata on rotation
AssertionError: expected undefined to be defined
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:235:24
    233|       });
    234| 
    235|       expect(newToken).toBeDefined();
       |                        ^
    236|       expect(newToken?.lastUsedAt).toBeDefined();
    237|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[25/70]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > POST /api/auth/refresh-token > should set secure cookie in production
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:267:33
    265|           .set('Cookie', `refresh_token=${testRefreshToken}`);
    266| 
    267|         expect(response.status).toBe(200);
       |                                 ^
    268| 
    269|         const setCookieHeader = response.headers['set-cookie']?.[0];

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[26/70]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > Refresh Token Lifecycle > should create refresh token on login
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:316:31
    314|         });
    315| 
    316|       expect(response.status).toBe(200);
       |                               ^
    317| 
    318|       // Verify refresh token cookie is set

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[27/70]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > Refresh Token Lifecycle > should support multiple active refresh tokens per user
AssertionError: expected 0 to be greater than or equal to 3
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:378:35
    376|         ));
    377| 
    378|       expect(activeTokens.length).toBeGreaterThanOrEqual(3);
       |                                   ^
    379|     });
    380| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[28/70]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should reject PUT without Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle multiple Authorization headers
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with SQL injection attempt
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject role into request context
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Rate Limiting on Protected Routes > should not apply general rate limiting to authenticated requests
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:80:14
     78|                 password: testUser.password,
     79|             })
     80|             .expect(200);
       |              ^
     81| 
     82|         userToken = loginRes.body.token;
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[29/70]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Session Creation and Tracking > should create refresh token on login
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:74:18
     72|                     password: testUser.password,
     73|                 })
     74|                 .expect(200);
       |                  ^
     75| 
     76|             expect(loginRes.headers['set-cookie']).toBeDefined();
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[30/70]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Session Creation and Tracking > should track device metadata in session
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:100:18
     98|                     password: testUser.password,
     99|                 })
    100|                 .expect(200);
       |                  ^
    101| 
    102|             const tokens = await db.query.refreshTokens.findMany({
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[31/70]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Session Creation and Tracking > should create separate sessions for multiple device logins
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:130:18
    128|                     password: testUser.password,
    129|                 })
    130|                 .expect(200);
       |                  ^
    131| 
    132|             // Login from device 3
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[32/70]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should list all active sessions for user
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:163:18
    161|                     password: testUser.password,
    162|                 })
    163|                 .expect(200);
       |                  ^
    164| 
    165|             await request(ctx.baseURL)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[33/70]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should mark current session correctly
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:208:18
    206|                     password: testUser.password,
    207|                 })
    208|                 .expect(200);
       |                  ^
    209| 
    210|             await request(ctx.baseURL)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[34/70]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should not include revoked sessions
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:237:18
    235|                     password: testUser.password,
    236|                 })
    237|                 .expect(200);
       |                  ^
    238| 
    239|             const session2 = await request(ctx.baseURL)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[35/70]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should order sessions by last used (most recent first)
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:282:18
    280|                     password: testUser.password,
    281|                 })
    282|                 .expect(200);
       |                  ^
    283| 
    284|             await new Promise(resolve => setTimeout(resolve, 100));
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[36/70]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/:sessionId > should revoke specific session
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:341:18
    339|                     password: testUser.password,
    340|                 })
    341|                 .expect(200);
       |                  ^
    342| 
    343|             // Get sessions to find session2's ID
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[37/70]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/:sessionId > should prevent revoking current session
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:373:18
    371|                     password: testUser.password,
    372|                 })
    373|                 .expect(200);
       |                  ^
    374| 
    375|             const sessionsRes = await request(ctx.baseURL)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[38/70]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/:sessionId > should not allow revoking other users sessions
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:417:18
    415|                     password: user2.password,
    416|                 })
    417|                 .expect(200);
       |                  ^
    418| 
    419|             // User1 tries to get user2's sessions
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[39/70]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/all > should revoke all sessions except current
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:489:18
    487|                     password: testUser.password,
    488|                 })
    489|                 .expect(200);
       |                  ^
    490| 
    491|             // Revoke all from session1
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[40/70]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Concurrent Session Handling > should handle multiple concurrent logins
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:610:36
    608| 
    609|             logins.forEach(res => {
    610|                 expect(res.status).toBe(200);
       |                                    ^
    611|                 expect(res.body.token).toBeDefined();
    612|             });
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:609:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[41/70]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Concurrent Session Handling > should handle concurrent token refreshes
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:631:18
    629|                     password: testUser.password,
    630|                 })
    631|                 .expect(200);
       |                  ^
    632| 
    633|             const cookies = session.headers['set-cookie'];
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[42/70]Î“Ã„Â»


[2m Test Files [22m [1m[31m8 failed[39m[22m[2m | [22m[1m[32m4 passed[39m[22m[90m (12)[39m
[2m      Tests [22m [1m[31m70 failed[39m[22m[2m | [22m[1m[32m220 passed[39m[22m[2m | [22m[33m2 skipped[39m[90m (292)[39m
[2m   Start at [22m 14:21:16
[2m   Duration [22m 48.74s[2m (transform 16.60s, setup 2.95s, import 51.65s, tests 250.25s, environment 2ms)[22m

