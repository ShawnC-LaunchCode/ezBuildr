npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w10_bb88b21f

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w10_bb88b21f

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w11_83fab7c6

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w11_83fab7c6

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768250260589,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768250260630,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768250260770,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768250260800,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w9_d4b8f309

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w9_d4b8f309

{"level":30,"time":1768250261503,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768250261551,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w8_a1dcef4c

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w8_a1dcef4c

{"level":30,"time":1768250261786,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768250261826,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768250262182,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768250262184,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768250262187,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768250262189,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768250262189,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768250262191,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768250262215,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768250262223,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w6_281c8a24

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w4_ba3e15c2

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w3_63bf0652

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w5_d7780fe8

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w6_281c8a24

{"level":30,"time":1768250262699,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w4_ba3e15c2

{"level":30,"time":1768250262715,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w3_63bf0652

{"level":30,"time":1768250262724,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w5_d7780fe8

{"level":30,"time":1768250262736,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768250262736,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768250262758,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768250262765,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768250262780,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w7_f64aaaae

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w0_edb5b18d

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w1_abf93980

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w2_1f52404a

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w7_f64aaaae

{"level":30,"time":1768250267222,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_edb5b18d

{"level":30,"time":1768250267234,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w1_abf93980

{"level":30,"time":1768250267240,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w2_1f52404a

{"level":30,"time":1768250267246,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768250267256,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768250267267,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768250267276,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768250267280,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

stderr | tests/integration/auth.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: constraint "users_email_unique" of relation "users" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 136,
  severity: 'ERROR',
  code: '42704',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'tablecmds.c',
  line: '12648',
  routine: 'ATExecDropConstraint'
}

{"level":30,"time":1768250269246,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250269246,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w10_bb88b21f

 [32mÎ“Â£Ã´[39m tests/integration/auth.routes.test.ts [2m([22m[2m41 tests[22m[2m)[22m[33m 10330[2mms[22m[39m
stderr | tests/integration/auth/oauth2.client-credentials.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: constraint "users_email_unique" of relation "users" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 136,
  severity: 'ERROR',
  code: '42704',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'tablecmds.c',
  line: '12648',
  routine: 'ATExecDropConstraint'
}

{"level":50,"time":1768250274730,"env":"test","status":401,"statusText":"Unauthorized","error":"Invalid client credentials","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768250274730,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250274732,"env":"test","data":{"token_type":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768250274732,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250274732,"env":"test","data":{"access_token":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768250274732,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250274733,"env":"test","error":"Network error: ECONNREFUSED","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250274838,"env":"test","error":"Invalid credentials","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":50,"time":1768250274839,"env":"test","error":"ECONNREFUSED","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250274841,"env":"test","status":400,"statusText":"Bad Request","error":"Invalid grant_type","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768250274841,"env":"test","error":"OAuth2 token request failed: 400 Bad Request","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250274841,"env":"test","status":401,"statusText":"Unauthorized","error":"Client authentication failed","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768250274841,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250274842,"env":"test","status":403,"statusText":"Forbidden","error":"Access denied","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768250274842,"env":"test","error":"OAuth2 token request failed: 403 Forbidden","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250274842,"env":"test","status":500,"statusText":"Internal Server Error","error":"Server error","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768250274842,"env":"test","error":"OAuth2 token request failed: 500 Internal Server Error","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250274843,"env":"test","error":"Unexpected token in JSON","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250274843,"env":"test","error":"Request timeout","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":30,"time":1768250274844,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768250274845,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w11_83fab7c6

 [32mÎ“Â£Ã´[39m tests/integration/auth/oauth2.client-credentials.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 15753[2mms[22m[39m
stderr | tests/integration/auth/oauth2.callback.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: constraint "users_email_unique" of relation "users" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 136,
  severity: 'ERROR',
  code: '42704',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'tablecmds.c',
  line: '12648',
  routine: 'ATExecDropConstraint'
}

{"level":30,"time":1768250280662,"env":"test","connectionId":"095923be-fb2c-40c9-9295-60bbd1ec4dce","projectId":"acdebba4-ad95-40c6-bcc5-1f0e979258c4","name":"Test OAuth2 Connection","type":"oauth2_3leg","msg":"Connection created:"}
{"level":30,"time":1768250281756,"env":"test","connectionId":"7d67ccab-f935-4efd-8ac5-af1a9bf5d20a","projectId":"acdebba4-ad95-40c6-bcc5-1f0e979258c4","name":"Status Test Connection","type":"oauth2_3leg","msg":"Connection created:"}
{"level":30,"time":1768250282454,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250282455,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w9_d4b8f309

 [32mÎ“Â£Ã´[39m tests/integration/auth/oauth2.callback.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 21865[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should initiate OAuth2 3-legged flow and generate authorization URL [33m 321[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should track OAuth2 connection status [33m 365[2mms[22m[39m
stderr | tests/integration/auth/oauth2.google.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: constraint "users_email_unique" of relation "users" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 136,
  severity: 'ERROR',
  code: '42704',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'tablecmds.c',
  line: '12648',
  routine: 'ATExecDropConstraint'
}

{"level":30,"time":1768250286074,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":50,"time":1768250286295,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:165:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
{"level":50,"time":1768250286296,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:165:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google authentication failed"}
{"level":40,"time":1768250286348,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768250286348,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:89:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:155:23"},"msg":"Google token verification failed"}
{"level":50,"time":1768250286348,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:89:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:155:23"},"msg":"Google authentication failed"}
{"level":30,"time":1768250286739,"env":"test","module":"auth","email":"existing@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768250287137,"env":"test","module":"auth","email":"refresh@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768250287531,"env":"test","module":"auth","email":"idtoken@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768250287933,"env":"test","module":"auth","email":"minimal@example.com","msg":"OAuth2 login successful"}
{"level":50,"time":1768250288036,"env":"test","module":"auth","err":{"type":"Error","message":"Token verification failed","stack":"Error: Token verification failed\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:425:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
{"level":40,"time":1768250288083,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768250288083,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:89:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
{"level":50,"time":1768250288129,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token payload","stack":"Error: Invalid token payload\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:85:25)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
{"level":30,"time":1768250288184,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250288185,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w8_a1dcef4c

 [32mÎ“Â£Ã´[39m tests/integration/auth/oauth2.google.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 27301[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should successfully authenticate with valid Google ID token [33m 534[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update existing user on subsequent logins [33m 439[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should create refresh token record in database [33m 398[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should support both "token" and "idToken" fields [33m 346[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle missing profile information gracefully [33m 354[2mms[22m[39m
stderr | tests/integration/auth.routes.real.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: constraint "users_email_unique" of relation "users" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 136,
  severity: 'ERROR',
  code: '42704',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'tablecmds.c',
  line: '12648',
  routine: 'ATExecDropConstraint'
}

{"level":30,"time":1768250291772,"env":"test","module":"user-credentials-repository","userId":"885c530f-544a-4ef7-92a6-403ddadc091f","msg":"User credentials created"}
{"level":30,"time":1768250291873,"env":"test","module":"email-queue","jobId":"3ef8d799-eced-4f8c-9c26-fe1a800575bd","to":"test-1768250291379-n4r71@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250291925,"env":"test","module":"auth-routes","userId":"885c530f-544a-4ef7-92a6-403ddadc091f","email":"test-1768250291379-n4r71@example.com","msg":"User registered"}
{"level":30,"time":1768250294695,"env":"test","module":"user-credentials-repository","userId":"0f986d7a-23de-4aa7-8e32-cddb0f8bacb5","msg":"User credentials created"}
{"level":30,"time":1768250294793,"env":"test","module":"email-queue","jobId":"1d7e5a4e-0bf4-4409-8ff5-e87da7f3deb4","to":"test-1768250294329-qg6x2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250294844,"env":"test","module":"auth-routes","userId":"0f986d7a-23de-4aa7-8e32-cddb0f8bacb5","email":"test-1768250294329-qg6x2@example.com","msg":"User registered"}
{"level":30,"time":1768250296044,"env":"test","module":"user-credentials-repository","userId":"0d9c35be-32d0-4154-be49-9aa9482807c3","msg":"User credentials created"}
{"level":30,"time":1768250296147,"env":"test","module":"email-queue","jobId":"bccc02ae-cb05-4991-91ae-9177b433b7a2","to":"test-1768250295682-zjlgw@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250296197,"env":"test","module":"auth-routes","userId":"0d9c35be-32d0-4154-be49-9aa9482807c3","email":"test-1768250295682-zjlgw@example.com","msg":"User registered"}
stderr | tests/integration/auth/oauth2.sessions.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: constraint "users_email_unique" of relation "users" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 136,
  severity: 'ERROR',
  code: '42704',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'tablecmds.c',
  line: '12648',
  routine: 'ATExecDropConstraint'
}

{"level":30,"time":1768250296792,"env":"test","module":"user-credentials-repository","userId":"uQCbyu3agK3WUs8V5oOBk","msg":"User credentials created"}
{"level":30,"time":1768250296979,"env":"test","module":"auth-routes","userId":"uQCbyu3agK3WUs8V5oOBk","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768250297306,"env":"test","module":"user-credentials-repository","userId":"eGMQGSdF62erlfriHOnxO","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould login with valid credentials
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250297406,"env":"test","module":"auth-routes","userId":"eGMQGSdF62erlfriHOnxO","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768250297721,"env":"test","module":"user-credentials-repository","userId":"kY1cUJBELRQvqjOK0zEaD","msg":"User credentials created"}
{"level":30,"time":1768250297790,"env":"test","module":"auth-routes","userId":"a15cfcef1892944950eb794b0e756b67","msg":"User logged in successfully"}
{"level":30,"time":1768250297822,"env":"test","module":"auth-routes","userId":"kY1cUJBELRQvqjOK0zEaD","sessionCount":0,"msg":"Listed active sessions"}
{"level":30,"time":1768250297841,"env":"test","module":"audit-log-service","userId":"a15cfcef1892944950eb794b0e756b67","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250298137,"env":"test","module":"user-credentials-repository","userId":"QK91uneuipxCADRi-NJoa","msg":"User credentials created"}
{"level":30,"time":1768250298235,"env":"test","module":"auth-routes","userId":"QK91uneuipxCADRi-NJoa","sessionCount":0,"msg":"Listed active sessions"}
{"level":30,"time":1768250298546,"env":"test","module":"user-credentials-repository","userId":"aFy0d8SAMjye95n3VcK8K","msg":"User credentials created"}
{"level":30,"time":1768250298703,"env":"test","module":"auth-routes","userId":"aFy0d8SAMjye95n3VcK8K","sessionCount":1,"msg":"Listed active sessions"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for invalid password
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250299015,"env":"test","module":"user-credentials-repository","userId":"VkJjZOvu55ndsMTnSIne5","msg":"User credentials created"}
{"level":30,"time":1768250299120,"env":"test","module":"auth-routes","userId":"VkJjZOvu55ndsMTnSIne5","sessionCount":1,"msg":"Listed active sessions"}
{"level":50,"time":1768250299355,"env":"test","module":"auth-routes","email":"test-1768250298632-xxufpf@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768250299435,"env":"test","module":"user-credentials-repository","userId":"IUzgejw2ElSflN4-wAcv2","msg":"User credentials created"}
{"level":50,"time":1768250299439,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768250299456,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should return 401 for invalid password
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250299769,"env":"test","module":"user-credentials-repository","userId":"_qPijhYQ3VX_6xXklxBRY","msg":"User credentials created"}
{"level":30,"time":1768250299972,"env":"test","module":"auth-routes","userId":"_qPijhYQ3VX_6xXklxBRY","sessionId":"568daf6d-853b-4594-adb5-0d9aff189551","msg":"Session revoked"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for non-existent user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250300306,"env":"test","module":"auth-routes","email":"nonexistent@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":30,"time":1768250300345,"env":"test","module":"user-credentials-repository","userId":"N0WzMCezXHcMTuXLqF-Ag","msg":"User credentials created"}
{"level":50,"time":1768250300405,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should return 401 for non-existent user
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:51:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250300662,"env":"test","module":"user-credentials-repository","userId":"PtqNm157yBG4VDLV4U93D","msg":"User credentials created"}
{"level":30,"time":1768250301070,"env":"test","module":"user-credentials-repository","userId":"BpbqzKpSR67LCIWPJfvPu","msg":"User credentials created"}
{"level":30,"time":1768250301572,"env":"test","module":"user-credentials-repository","userId":"ce70121c-bfe3-4250-950d-23c58339e1c4","msg":"User credentials created"}
{"level":30,"time":1768250301593,"env":"test","module":"user-credentials-repository","userId":"MkNWGwFNSi-Nls5gIp-Bf","msg":"User credentials created"}
{"level":50,"time":1768250301595,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250301685,"env":"test","module":"email-queue","jobId":"014a430d-d3aa-4ac8-bb6b-c81453fdceb7","to":"test-1768250301193-d09gb@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
stderr | tests/integration/auth/oauth2.token-refresh.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: constraint "users_email_unique" of relation "users" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 136,
  severity: 'ERROR',
  code: '42704',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'tablecmds.c',
  line: '12648',
  routine: 'ATExecDropConstraint'
}

{"level":30,"time":1768250301744,"env":"test","module":"auth-routes","userId":"ce70121c-bfe3-4250-950d-23c58339e1c4","email":"test-1768250301193-d09gb@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 403 for unverified email
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250301907,"env":"test","module":"user-credentials-repository","userId":"oDIL-pnyR2WXzv4SCDLfj","msg":"User credentials created"}
{"level":40,"time":1768250302121,"env":"test","module":"auth-routes","userId":"ce70121c-bfe3-4250-950d-23c58339e1c4","email":"test-1768250301193-d09gb@example.com","msg":"Login blocked: email not verified"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should return 403 for unverified email
Login Failed DEBUG: EmailNotVerifiedError: Please verify your email before logging in. Check your inbox for the verification link.
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:86:11)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_006',
  statusCode: 403,
  isOperational: true
}

{"level":50,"time":1768250302121,"env":"test","module":"auth-routes","error":{"name":"EmailNotVerifiedError","code":"AUTH_006","statusCode":403,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768250302289,"env":"test","module":"user-credentials-repository","userId":"clW1a2fado43N1nz_vpsl","msg":"User credentials created"}
{"level":30,"time":1768250302365,"env":"test","module":"auth-service","tokenHash":"d8eb73521cb34009b48ffc8a88473ff869ce6ac6522d065986aba7914cf872e7","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250302399,"env":"test","module":"auth-routes","userId":"oDIL-pnyR2WXzv4SCDLfj","msg":"All other sessions revoked"}
{"level":40,"time":1768250302422,"env":"test","module":"auth-service","tokenHash":"d8eb73521cb34009b48ffc8a88473ff869ce6ac6522d065986aba7914cf872e7","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768250302448,"env":"test","module":"audit-log-service","userId":"oDIL-pnyR2WXzv4SCDLfj","eventType":"all_sessions_revoked","ipAddress":"::ffff:127.0.0.1","hasMetadata":false,"msg":"Security event logged"}
{"level":30,"time":1768250302471,"env":"test","module":"auth-service","allTokensCount":0,"msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768250302800,"env":"test","module":"user-credentials-repository","userId":"p1l8-vz2eEsdunTwYdwIt","msg":"User credentials created"}
{"level":30,"time":1768250302821,"env":"test","module":"user-credentials-repository","userId":"EK7lLMri_F35cKHdyu9eb","msg":"User credentials created"}
{"level":30,"time":1768250302860,"env":"test","module":"auth-service","tokenHash":"356d371a71f37428c6e7e33a4e580621b3799a7f2087d62deff7c4ff4ab7b666","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250303018,"env":"test","module":"auth-routes","userId":"EK7lLMri_F35cKHdyu9eb","msg":"All other sessions revoked"}
{"level":30,"time":1768250303071,"env":"test","module":"audit-log-service","userId":"EK7lLMri_F35cKHdyu9eb","eventType":"all_sessions_revoked","ipAddress":"::ffff:127.0.0.1","hasMetadata":false,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould record failed login attempt
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250303435,"env":"test","module":"user-credentials-repository","userId":"EGxfqM3H9wCElCzTAbf3_","msg":"User credentials created"}
{"level":30,"time":1768250303479,"env":"test","module":"user-credentials-repository","userId":"B2a5g_X3LVUWb7RcjXlNN","msg":"User credentials created"}
{"level":50,"time":1768250303634,"env":"test","module":"auth-routes","email":"test-1768250302909-mffnx6@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768250303728,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should record failed login attempt
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250303750,"env":"test","module":"user-credentials-repository","userId":"3VsBUSGXp9VgZJ0mKnjGE","msg":"User credentials created"}
{"level":50,"time":1768250303752,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250303849,"env":"test","module":"user-credentials-repository","userId":"uSbNmN3f5VItR1nDnnTre","msg":"User credentials created"}
{"level":30,"time":1768250303908,"env":"test","module":"auth-service","tokenHash":"2fe6f7ff0fa9bd1ee1eb2b4de4567a52a13546270f31f9607e884393806b0e0c","plainTokenLen":19,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250303957,"env":"test","module":"auth-service","tokenHash":"2fe6f7ff0fa9bd1ee1eb2b4de4567a52a13546270f31f9607e884393806b0e0c","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768250304003,"env":"test","module":"auth-service","allTokensCount":5,"sampleToken":"989d8c98b706470cfe0975b2d5fe6eddf9b1d475694887b3b4c45aa6a62e1b41","msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768250304064,"env":"test","module":"user-credentials-repository","userId":"lG_VsYABscMasM6d65dyx","msg":"User credentials created"}
{"level":30,"time":1768250304162,"env":"test","module":"auth-routes","userId":"lG_VsYABscMasM6d65dyx","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Device marked as trusted"}
{"level":30,"time":1768250304319,"env":"test","module":"user-credentials-repository","userId":"3hmGu62zLtLZA4MmZP-4Y","msg":"User credentials created"}
{"level":30,"time":1768250304425,"env":"test","module":"auth-service","tokenHash":"719d4f34fd9de961e8180db389d381f3f2fb25ec3f7287005acb16280bd0a506","plainTokenLen":17,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250304474,"env":"test","module":"auth-service","tokenHash":"719d4f34fd9de961e8180db389d381f3f2fb25ec3f7287005acb16280bd0a506","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768250304521,"env":"test","module":"auth-service","allTokensCount":0,"msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768250304529,"env":"test","module":"user-credentials-repository","userId":"epC_Jnfn2F25Bn3ThdkOx","msg":"User credentials created"}
{"level":30,"time":1768250304629,"env":"test","module":"auth-routes","userId":"epC_Jnfn2F25Bn3ThdkOx","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Device marked as trusted"}
{"level":30,"time":1768250304779,"env":"test","module":"auth-routes","userId":"epC_Jnfn2F25Bn3ThdkOx","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Trusted device expiry updated"}
{"level":30,"time":1768250304843,"env":"test","module":"user-credentials-repository","userId":"d_uksvwixYgloQ4YAxpC_","msg":"User credentials created"}
{"level":30,"time":1768250304949,"env":"test","module":"auth-service","tokenHash":"c3222ee37430373605d4ef6fae90f5ccc64e3062d189c76e536fc4d3c0e3e4f3","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250304996,"env":"test","module":"auth-service","userId":"d_uksvwixYgloQ4YAxpC_","tokenHash":"c3222ee37430373605d4ef6fae90f5ccc64e3062d189c76e536fc4d3c0e3e4f3","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return requiresMfa=true for MFA-enabled users
[22m[39m[TEST UTILS] MFA Secret verified for 6f816c3f261e18afa4a5408797e06dab

{"level":30,"time":1768250305153,"env":"test","module":"user-credentials-repository","userId":"elyLAkiu961-GYDl92YRt","msg":"User credentials created"}
{"level":30,"time":1768250305271,"env":"test","module":"auth-routes","userId":"elyLAkiu961-GYDl92YRt","deviceCount":2,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return requiresMfa=true for MFA-enabled users
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250305376,"env":"test","module":"user-credentials-repository","userId":"c7fcCNGBKDS6iwTXYbSF0","msg":"User credentials created"}
{"level":30,"time":1768250305485,"env":"test","module":"auth-service","tokenHash":"70712f73c408749bc40ebb8c4eb99f0ed831c75673274ba41af4a7022e32a207","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250305541,"env":"test","module":"auth-service","tokenHash":"70712f73c408749bc40ebb8c4eb99f0ed831c75673274ba41af4a7022e32a207","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768250305590,"env":"test","module":"user-credentials-repository","userId":"oyD1z6aApJIVnIGaGZIo1","msg":"User credentials created"}
{"level":30,"time":1768250305593,"env":"test","module":"auth-service","allTokensCount":1,"sampleToken":"c3222ee37430373605d4ef6fae90f5ccc64e3062d189c76e536fc4d3c0e3e4f3","msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768250305689,"env":"test","module":"auth-routes","userId":"oyD1z6aApJIVnIGaGZIo1","deviceCount":0,"msg":"Listed trusted devices"}
{"level":30,"time":1768250305758,"env":"test","module":"auth-routes","userId":"6f816c3f261e18afa4a5408797e06dab","msg":"Login requires MFA verification"}
{"level":30,"time":1768250305910,"env":"test","module":"user-credentials-repository","userId":"BpH3Zdg1jfHxrboNGnBX9","msg":"User credentials created"}
{"level":30,"time":1768250305961,"env":"test","module":"auth-service","tokenHash":"93d553a220bea16898fd64cace55c3b63ffa834e7487fb3eef97699ddfa81325","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250306002,"env":"test","module":"user-credentials-repository","userId":"Dpi25bRVzEzFBU29SCQRx","msg":"User credentials created"}
{"level":40,"time":1768250306061,"env":"test","module":"auth-service","userId":"BpH3Zdg1jfHxrboNGnBX9","tokenHash":"93d553a220bea16898fd64cace55c3b63ffa834e7487fb3eef97699ddfa81325","msg":"Security: REUSED REFRESH TOKEN DETECTED (Concurrent). Revoking all sessions."}
{"level":30,"time":1768250306155,"env":"test","module":"auth-routes","userId":"Dpi25bRVzEzFBU29SCQRx","deviceId":"94342774-bb25-429b-a8e6-a4b1ee0afc34","msg":"Trusted device revoked"}
{"level":30,"time":1768250306527,"env":"test","module":"user-credentials-repository","userId":"_QSJGXPAx9CfYuhg8eCR5","msg":"User credentials created"}
{"level":30,"time":1768250306711,"env":"test","module":"user-credentials-repository","userId":"IQDH80lpwpeP_Ry3yNYbh","msg":"User credentials created"}
{"level":30,"time":1768250306764,"env":"test","module":"auth-service","tokenHash":"7bc8b01cc1ae206860879f00d0a8b02f919b7a34b66e727b9cb4a6720541dfc2","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250306765,"env":"test","module":"auth-service","tokenHash":"7bc8b01cc1ae206860879f00d0a8b02f919b7a34b66e727b9cb4a6720541dfc2","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250306854,"env":"test","module":"user-credentials-repository","userId":"OifNwhM7GiJ8-JBQhzfxX","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768250307128,"env":"test","module":"auth-service","userId":"IQDH80lpwpeP_Ry3yNYbh","tokenHash":"7bc8b01cc1ae206860879f00d0a8b02f919b7a34b66e727b9cb4a6720541dfc2","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250307267,"env":"test","module":"user-credentials-repository","userId":"741-FktMTOOW7LEo0CXGk","msg":"User credentials created"}
{"level":50,"time":1768250307298,"env":"test","module":"auth-routes","email":"test-1768250306554-cjort@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
stderr | tests/integration/auth.flows.real.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: constraint "users_email_unique" of relation "users" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 136,
  severity: 'ERROR',
  code: '42704',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'tablecmds.c',
  line: '12648',
  routine: 'ATExecDropConstraint'
}

{"level":50,"time":1768250307396,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250307496,"env":"test","module":"user-credentials-repository","userId":"ev1jbS2PC7R4bwE0wEiPV","msg":"User credentials created"}
{"level":30,"time":1768250307551,"env":"test","module":"auth-service","tokenHash":"3bf251ee4869bdecdacf95855c2b1e8e1c52fd9362c39327bc441bec41982d39","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250307693,"env":"test","module":"user-credentials-repository","userId":"WkQcl1mrtJZqKj6P8WGT9","msg":"User credentials created"}
{"level":50,"time":1768250307775,"env":"test","module":"auth-routes","email":"test-1768250306554-cjort@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768250307876,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250307894,"env":"test","module":"auth-service","tokenHash":"52700cdcd08079055e7dba15c3bf1ee194cb15cc2ed14d9df258cec78bde5170","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250307949,"env":"test","module":"auth-service","tokenHash":"52700cdcd08079055e7dba15c3bf1ee194cb15cc2ed14d9df258cec78bde5170","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768250307997,"env":"test","module":"auth-service","allTokensCount":0,"msg":"DEBUG: Tokens in DB"}
{"level":50,"time":1768250308029,"env":"test","module":"auth-routes","userId":"34bb7e39f8f735e9800bac71dd9be037","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250308047,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250308047,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768250308082,"env":"test","module":"user-credentials-repository","userId":"dxj4u_wPN88FjZY0_GDhv","msg":"User credentials created"}
{"level":50,"time":1768250308125,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250308135,"env":"test","module":"auth-service","tokenHash":"34eada4f8a358d85d119113439502a5f103d1d84a313c86a084a21871c4758fc","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768250308278,"env":"test","module":"auth-routes","userId":"34bb7e39f8f735e9800bac71dd9be037","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250308324,"env":"test","module":"user-credentials-repository","userId":"4c5d4b5b-990b-4018-8acc-c75484358377","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w6_281c8a24

{"level":50,"time":1768250308377,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250308422,"env":"test","module":"email-queue","jobId":"601b0330-adf9-4784-82d8-147f9583cdc9","to":"test-1768250307921-99jqs@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
 [31mÎ“Â¥Â»[39m tests/integration/auth/oauth2.sessions.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m4 failed[39m[2m)[22m[33m 46221[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all active sessions for current user[39m[33m 507[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should mark current session as current [33m 420[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return empty array when user has no active sessions [33m 417[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not include expired sessions [33m 413[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not include revoked sessions [33m 468[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should parse device name from user agent [33m 417[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for unauthenticated request [33m 319[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke a specific session [33m 586[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 404 for non-existent session [33m 323[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking current session[39m[33m 407[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prevent revoking another user's session [33m 513[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for unauthenticated request [33m 326[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke all sessions except current[39m[33m 903[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke all trusted devices [33m 622[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 400 when no active session found [33m 317[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for unauthenticated request [33m 315[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should mark current device as trusted [33m 458[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should update existing trusted device expiry [33m 626[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should list all trusted devices [33m 435[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should not include revoked devices [33m 418[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should revoke a trusted device [33m 516[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should return 404 for non-existent device [33m 326[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should track IP address for sessions [33m 420[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should track user agent for sessions [33m 419[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update lastUsedAt on token refresh[39m[33m 675[2mms[22m[39m
{"level":30,"time":1768250308474,"env":"test","module":"auth-routes","userId":"4c5d4b5b-990b-4018-8acc-c75484358377","email":"test-1768250307921-99jqs@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mComplete Registration Î“Ã¥Ã† Login Flow[2m > [22m[2mshould complete registration, verify email, then login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250308523,"env":"test","module":"auth-routes","userId":"34bb7e39f8f735e9800bac71dd9be037","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250308618,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250308646,"env":"test","module":"user-credentials-repository","userId":"sOOvimwqKLYiVLZ_F8mnw","msg":"User credentials created"}
{"level":30,"time":1768250308698,"env":"test","module":"auth-service","tokenHash":"eb76d317c32a2b33d29ff1481ff2321da8cc52e8aa00f1f61d3d470725f757ef","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768250308773,"env":"test","module":"auth-routes","userId":"34bb7e39f8f735e9800bac71dd9be037","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":40,"time":1768250308847,"env":"test","module":"auth-routes","userId":"4c5d4b5b-990b-4018-8acc-c75484358377","email":"test-1768250307921-99jqs@example.com","msg":"Login blocked: email not verified"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Complete Registration Î“Ã¥Ã† Login Flow > should complete registration, verify email, then login
Login Failed DEBUG: EmailNotVerifiedError: Please verify your email before logging in. Check your inbox for the verification link.
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:86:11)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_006',
  statusCode: 403,
  isOperational: true
}

{"level":50,"time":1768250308848,"env":"test","module":"auth-routes","error":{"name":"EmailNotVerifiedError","code":"AUTH_006","statusCode":403,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mComplete Registration Î“Ã¥Ã† Login Flow[2m > [22m[2mshould complete registration, verify email, then login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768250308969,"env":"test","module":"account-lockout","userId":"34bb7e39f8f735e9800bac71dd9be037","email":"test-1768250306554-cjort@example.com","lockedUntil":"2026-01-12T20:53:28.920Z","msg":"Account locked due to too many failed attempts"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250308969,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768250309221,"env":"test","module":"user-credentials-repository","userId":"r0iArhZd2cDttHwuWJn9J","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22m[2mOAuth2 Token Refresh Flow[2m > [22m[2mRefresh Token Lifecycle[2m > [22m[2mshould create refresh token on login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250309377,"env":"test","module":"auth-routes","userId":"4c5d4b5b-990b-4018-8acc-c75484358377","msg":"User logged in successfully"}
{"level":30,"time":1768250309426,"env":"test","module":"audit-log-service","userId":"4c5d4b5b-990b-4018-8acc-c75484358377","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250309436,"env":"test","module":"auth-routes","userId":"r0iArhZd2cDttHwuWJn9J","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250309546,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > Refresh Token Lifecycle > should create refresh token on login
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250309872,"env":"test","module":"user-credentials-repository","userId":"DMlTqDThIr-ElbLUL004c","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/logout[2m > [22m[2mshould logout and clear refresh token cookie
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250310348,"env":"test","module":"user-credentials-repository","userId":"Qj4X-6xuRwcoQa6sljf8a","msg":"User credentials created"}
{"level":50,"time":1768250310556,"env":"test","module":"auth-routes","email":"test-1768250309816-7pu9p9@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768250310587,"env":"test","module":"auth-routes","userId":"da6fb89218fbba5397cb94fa7289c263","msg":"User logged in successfully"}
{"level":30,"time":1768250310637,"env":"test","module":"audit-log-service","userId":"da6fb89218fbba5397cb94fa7289c263","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250310662,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250310718,"env":"test","module":"user-credentials-repository","userId":"O5LGU2GCJZFYK-RNtKw9F","msg":"User credentials created"}
{"level":50,"time":1768250311051,"env":"test","module":"auth-routes","email":"test-1768250309816-7pu9p9@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768250311154,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250311245,"env":"test","module":"user-credentials-repository","userId":"6EGsg6BY1UttAYETIraJt","msg":"User credentials created"}
{"level":50,"time":1768250311312,"env":"test","module":"auth-routes","userId":"8b456b31c16b86e408cc09faecf7e016","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250311411,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250311577,"env":"test","module":"auth-routes","userId":"8b456b31c16b86e408cc09faecf7e016","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250311678,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250311822,"env":"test","module":"user-credentials-repository","userId":"KJZVGgzU9rTDvETw3NtGc","msg":"User credentials created"}
{"level":50,"time":1768250311832,"env":"test","module":"auth-routes","userId":"8b456b31c16b86e408cc09faecf7e016","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould refresh access token with valid refresh token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250311933,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250312094,"env":"test","module":"auth-routes","userId":"8b456b31c16b86e408cc09faecf7e016","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250312193,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250312311,"env":"test","module":"auth-routes","userId":"98c52424fa49398bdc294c760df8d782","msg":"User logged in successfully"}
{"level":30,"time":1768250312364,"env":"test","module":"audit-log-service","userId":"98c52424fa49398bdc294c760df8d782","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250312368,"env":"test","module":"auth-service","tokenHash":"9d0eb8bbcb13034baef80bba4bf13fe9e936dca3228765ffaac586ac379f3b65","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
stderr | tests/integration/auth/session.management.integration.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: constraint "users_email_unique" of relation "users" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 136,
  severity: 'ERROR',
  code: '42704',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'tablecmds.c',
  line: '12648',
  routine: 'ATExecDropConstraint'
}

{"level":30,"time":1768250312869,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768250312887,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39m[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768250312876,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768250312877,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768250312882,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768250312886,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768250312886,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768250312886,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768250312887,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250313107,"env":"test","module":"auth-routes","userId":"c5f1edae30f8058ccf744f873e590f03","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250313209,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should record all login attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250313340,"env":"test","module":"user-credentials-repository","userId":"0ff37c92-7aa6-4da9-a58d-0bdfaa4b2d6e","msg":"User credentials created"}
{"level":50,"time":1768250313362,"env":"test","module":"auth-routes","userId":"c5f1edae30f8058ccf744f873e590f03","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250313438,"env":"test","module":"email-queue","jobId":"77a997e3-500d-4302-a634-76d8014040f0","to":"test-p6UNnnnGoVdGA8mkjPpzo@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768250313469,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should record all login attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250313487,"env":"test","module":"auth-routes","userId":"0ff37c92-7aa6-4da9-a58d-0bdfaa4b2d6e","email":"test-p6UNnnnGoVdGA8mkjPpzo@example.com","msg":"User registered"}
{"level":50,"time":1768250313624,"env":"test","module":"auth-routes","userId":"c5f1edae30f8058ccf744f873e590f03","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250313724,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should record all login attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250314008,"env":"test","module":"user-credentials-repository","userId":"2affe8c3-6a8c-41f4-a151-f7cc880c462f","msg":"User credentials created"}
{"level":30,"time":1768250314108,"env":"test","module":"email-queue","jobId":"64544ca8-3691-4125-a44d-be4e7cb1bd49","to":"session-test-tgiXK81_Q548cy-EFd5Z8@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250314156,"env":"test","module":"auth-routes","userId":"2affe8c3-6a8c-41f4-a151-f7cc880c462f","email":"session-test-tgiXK81_Q548cy-EFd5Z8@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Creation and Tracking[2m > [22m[2mshould create refresh token on login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250314403,"env":"test","module":"auth-routes","userId":"2affe8c3-6a8c-41f4-a151-f7cc880c462f","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250314501,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Session Creation and Tracking > should create refresh token on login
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould rotate refresh token after use
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould complete MFA setup and login with TOTP
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250314878,"env":"test","module":"user-credentials-repository","userId":"0d5c6f66-0779-4d29-8e94-c408fcfc6dd7","msg":"User credentials created"}
{"level":30,"time":1768250314974,"env":"test","module":"email-queue","jobId":"32de6b90-71bf-4a10-8f4a-1d786c677091","to":"session-test-xg4N6P6p4ODldNZJxDoy9@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250315000,"env":"test","module":"auth-routes","userId":"14fcf5ff2927d3e4e41ab2daeaaac9ed","msg":"User logged in successfully"}
{"level":30,"time":1768250315028,"env":"test","module":"auth-routes","userId":"0d5c6f66-0779-4d29-8e94-c408fcfc6dd7","email":"session-test-xg4N6P6p4ODldNZJxDoy9@example.com","msg":"User registered"}
{"level":30,"time":1768250315037,"env":"test","module":"auth-routes","userId":"90295c411faf5e94b6401b38318bc36e","msg":"User logged in successfully"}
{"level":30,"time":1768250315051,"env":"test","module":"audit-log-service","userId":"14fcf5ff2927d3e4e41ab2daeaaac9ed","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250315055,"env":"test","module":"auth-service","tokenHash":"535f4068012a23b580a8b333192703f712cedfe67028157c18945ed67e975ff9","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250315090,"env":"test","module":"audit-log-service","userId":"90295c411faf5e94b6401b38318bc36e","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Creation and Tracking[2m > [22m[2mshould track device metadata in session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250315264,"env":"test","module":"auth-service","tokenHash":"535f4068012a23b580a8b333192703f712cedfe67028157c18945ed67e975ff9","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250315314,"env":"test","module":"auth-service","userId":"14fcf5ff2927d3e4e41ab2daeaaac9ed","tokenHash":"535f4068012a23b580a8b333192703f712cedfe67028157c18945ed67e975ff9","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250315544,"env":"test","module":"mfa-service","userId":"90295c411faf5e94b6401b38318bc36e","count":10,"msg":"Stored backup codes"}
{"level":30,"time":1768250315544,"env":"test","module":"mfa-service","userId":"90295c411faf5e94b6401b38318bc36e","msg":"Generated TOTP secret"}
{"level":30,"time":1768250315544,"env":"test","module":"auth-routes","userId":"90295c411faf5e94b6401b38318bc36e","msg":"MFA setup initiated"}
{"level":30,"time":1768250315599,"env":"test","module":"auth-routes","userId":"0d5c6f66-0779-4d29-8e94-c408fcfc6dd7","msg":"User logged in successfully"}
{"level":30,"time":1768250315649,"env":"test","module":"audit-log-service","userId":"0d5c6f66-0779-4d29-8e94-c408fcfc6dd7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250316065,"env":"test","module":"user-credentials-repository","userId":"6d9bec73-2520-4d28-89f8-ffa174c7159e","msg":"User credentials created"}
{"level":30,"time":1768250316161,"env":"test","module":"email-queue","jobId":"32a2492a-c7a9-4111-b426-31871a8e3810","to":"session-test-TTYfA7GrDV7WxVntK5rkm@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250316208,"env":"test","module":"auth-routes","userId":"6d9bec73-2520-4d28-89f8-ffa174c7159e","email":"session-test-TTYfA7GrDV7WxVntK5rkm@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Creation and Tracking[2m > [22m[2mshould create separate sessions for multiple device logins
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould login with backup code when TOTP unavailable
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250316450,"env":"test","module":"auth-routes","userId":"6d9bec73-2520-4d28-89f8-ffa174c7159e","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250316546,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Session Creation and Tracking > should create separate sessions for multiple device logins
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250316723,"env":"test","module":"email-queue","jobId":"8fa4243d-ce34-47e4-9bb2-385e85e23ab2","to":"test-1768250316156-x02df9@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250316723,"env":"test","module":"auth-service","email":"test-1768250316156-x02df9@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768250316894,"env":"test","module":"auth-routes","userId":"a3ed288489288fca3c7f5ac911c9bc72","msg":"User logged in successfully"}
{"level":30,"time":1768250316909,"env":"test","module":"user-credentials-repository","userId":"8fea8c37-3bcf-473d-a51f-e1ed07f550ea","msg":"User credentials created"}
{"level":30,"time":1768250316946,"env":"test","module":"audit-log-service","userId":"a3ed288489288fca3c7f5ac911c9bc72","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250317007,"env":"test","module":"email-queue","jobId":"d6b7b36b-d6db-4a62-b9f3-984a1d584644","to":"session-test-X-wRGIWJFQe1uN4BX_YDK@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250317056,"env":"test","module":"auth-routes","userId":"8fea8c37-3bcf-473d-a51f-e1ed07f550ea","email":"session-test-X-wRGIWJFQe1uN4BX_YDK@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250317264,"env":"test","module":"user-credentials-repository","userId":"VY8m9qIaNSr6O68z6R4Tg","msg":"User credentials created"}
{"level":50,"time":1768250317294,"env":"test","module":"auth-routes","userId":"8fea8c37-3bcf-473d-a51f-e1ed07f550ea","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250317376,"env":"test","module":"mfa-service","userId":"a3ed288489288fca3c7f5ac911c9bc72","count":10,"msg":"Stored backup codes"}
{"level":30,"time":1768250317376,"env":"test","module":"mfa-service","userId":"a3ed288489288fca3c7f5ac911c9bc72","msg":"Generated TOTP secret"}
{"level":30,"time":1768250317376,"env":"test","module":"auth-routes","userId":"a3ed288489288fca3c7f5ac911c9bc72","msg":"MFA setup initiated"}
{"level":50,"time":1768250317389,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should list all active sessions for user
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250317739,"env":"test","module":"user-credentials-repository","userId":"bGn24c0GInev6bt1xaKjc","msg":"User credentials created"}
{"level":30,"time":1768250317756,"env":"test","module":"user-credentials-repository","userId":"b79ab480-5209-4227-81cb-94ce9cdf6ce6","msg":"User credentials created"}
{"level":30,"time":1768250317797,"env":"test","module":"auth-service","tokenHash":"4e3866c8c541d54fc68e072d6e258ca401430ff1e770ea72ed364ac6d262f210","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250317854,"env":"test","module":"email-queue","jobId":"2b43fe75-f67e-4c25-9e9f-2370f2126027","to":"session-test-rHUAlCvArydw7CTWtBANV@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":40,"time":1768250317897,"env":"test","module":"auth-service","userId":"bGn24c0GInev6bt1xaKjc","tokenHash":"4e3866c8c541d54fc68e072d6e258ca401430ff1e770ea72ed364ac6d262f210","msg":"Security: REUSED REFRESH TOKEN DETECTED (Concurrent). Revoking all sessions."}
{"level":30,"time":1768250317901,"env":"test","module":"auth-routes","userId":"b79ab480-5209-4227-81cb-94ce9cdf6ce6","email":"session-test-rHUAlCvArydw7CTWtBANV@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mDEBUG: LOGIN HANDLER HIT

stderr | tests/integration/auth/auth.middleware.integration.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: constraint "users_email_unique" of relation "users" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 136,
  severity: 'ERROR',
  code: '42704',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'tablecmds.c',
  line: '12648',
  routine: 'ATExecDropConstraint'
}

{"level":50,"time":1768250318149,"env":"test","module":"auth-routes","userId":"b79ab480-5209-4227-81cb-94ce9cdf6ce6","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250318243,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should mark current session correctly
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250318272,"env":"test","module":"user-credentials-repository","userId":"pI7XfCXMyoRhZa_8STYV4","msg":"User credentials created"}
{"level":30,"time":1768250318320,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768250318336,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests
[22m[39m[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768250318328,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768250318328,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768250318333,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768250318336,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768250318336,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768250318336,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768250318336,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768250318468,"env":"test","module":"email-queue","jobId":"c347edc4-cbf6-44bc-a60a-b2d5b06a47d4","to":"test-1768250317893-0ba3f@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250318468,"env":"test","module":"auth-service","email":"test-1768250317893-0ba3f@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768250318602,"env":"test","module":"user-credentials-repository","userId":"35733b1f-4f4f-4295-a394-3220acdb32cd","msg":"User credentials created"}
{"level":30,"time":1768250318712,"env":"test","module":"email-queue","jobId":"d68b2ba4-5c33-4101-bfd4-b9e94a29a12d","to":"session-test-ZVwFBM4iwj3q2-fdu1moU@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250318747,"env":"test","module":"user-credentials-repository","userId":"rArwj87T6N-n2ZTtcVhKF","msg":"User credentials created"}
{"level":30,"time":1768250318760,"env":"test","module":"auth-routes","userId":"35733b1f-4f4f-4295-a394-3220acdb32cd","email":"session-test-ZVwFBM4iwj3q2-fdu1moU@example.com","msg":"User registered"}
{"level":30,"time":1768250318778,"env":"test","module":"email-queue","jobId":"031e46b8-0aae-4b23-9010-9250da6320ca","to":"test-1768250317893-0ba3f@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250318778,"env":"test","module":"auth-service","email":"test-1768250317893-0ba3f@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768250318797,"env":"test","module":"auth-service","tokenHash":"bd3697dc4b9ee92533faac57a87a0d30f689f8022d1c4d83abd40037b3547245","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250318802,"env":"test","module":"user-credentials-repository","userId":"5a0f9318-4cf9-4913-8f68-9fc5e3aa4daf","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould not include revoked sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250318907,"env":"test","module":"email-queue","jobId":"82efb051-d145-493a-af3d-f0fff5ae94d4","to":"test-XxqZJkXEuNEt8hfa7Gvtx@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250318935,"env":"test","module":"email-queue","jobId":"17c75bdb-ce54-477c-a872-ca12391e2faa","to":"test-1768250318360-7tf7j9@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250318935,"env":"test","module":"auth-service","email":"test-1768250318360-7tf7j9@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768250318962,"env":"test","module":"auth-routes","userId":"5a0f9318-4cf9-4913-8f68-9fc5e3aa4daf","email":"test-XxqZJkXEuNEt8hfa7Gvtx@example.com","msg":"User registered"}
{"level":50,"time":1768250319153,"env":"test","module":"user-credentials-repository","error":{},"userId":"704da9a2781d04dea338ac358ccc7c9b","msg":"Failed to update user password"}
{"level":50,"time":1768250319153,"env":"test","module":"auth-routes","error":{},"msg":"Reset password error"}
{"level":30,"time":1768250319313,"env":"test","module":"user-credentials-repository","userId":"1503e3c6b4241d0c76b97c13de2493cc","msg":"User password updated"}
{"level":30,"time":1768250319313,"env":"test","module":"user-credentials-repository","userId":"-KpIN4mkXMzB17MeqGOEL","msg":"User credentials created"}
{"level":30,"time":1768250319329,"env":"test","module":"auth-routes","userId":"35733b1f-4f4f-4295-a394-3220acdb32cd","msg":"User logged in successfully"}
{"level":30,"time":1768250319369,"env":"test","module":"auth-service","tokenHash":"b62aa5b6df76b8c4011ff49ad4d76f244831a2c09377a3629a19680f2828d8ed","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250319375,"env":"test","module":"audit-log-service","userId":"35733b1f-4f4f-4295-a394-3220acdb32cd","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould not include revoked sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250319466,"env":"test","module":"audit-log-service","userId":"1503e3c6b4241d0c76b97c13de2493cc","eventType":"password_reset","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/reset-password[2m > [22m[2mshould reset password with valid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768250319471,"env":"test","module":"auth-service","userId":"-KpIN4mkXMzB17MeqGOEL","tokenHash":"b62aa5b6df76b8c4011ff49ad4d76f244831a2c09377a3629a19680f2828d8ed","msg":"Security: REUSED REFRESH TOKEN DETECTED (Concurrent). Revoking all sessions."}
{"level":30,"time":1768250319615,"env":"test","module":"user-credentials-repository","userId":"8f9fe43c-1092-4a46-8926-59ac786aff8b","msg":"User credentials created"}
{"level":50,"time":1768250319621,"env":"test","module":"auth-routes","userId":"1503e3c6b4241d0c76b97c13de2493cc","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250319716,"env":"test","module":"email-queue","jobId":"66e7d65e-0111-4d02-98c0-a131c7cb688e","to":"middleware-test-SCfa0f1ox4h35fwcu1S5s@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768250319721,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/reset-password > should reset password with valid token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250319766,"env":"test","module":"auth-routes","userId":"8f9fe43c-1092-4a46-8926-59ac786aff8b","email":"middleware-test-SCfa0f1ox4h35fwcu1S5s@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould allow access with valid JWT Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250319839,"env":"test","module":"auth-routes","userId":"35733b1f-4f4f-4295-a394-3220acdb32cd","msg":"User logged in successfully"}
{"level":30,"time":1768250319846,"env":"test","module":"user-credentials-repository","userId":"AM92YWRKHzkohYqO27bbL","msg":"User credentials created"}
{"level":30,"time":1768250319887,"env":"test","module":"audit-log-service","userId":"35733b1f-4f4f-4295-a394-3220acdb32cd","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250319898,"env":"test","module":"auth-service","tokenHash":"20a6f3361bbd706ac471023e2afdf73852705ae8b3f776aa8fba7a99ba7ce52a","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mPassword Reset Flow[2m > [22m[2mshould invalidate all sessions after password reset
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250319991,"env":"test","module":"auth-routes","userId":"35733b1f-4f4f-4295-a394-3220acdb32cd","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768250320301,"env":"test","module":"auth-routes","userId":"8f9fe43c-1092-4a46-8926-59ac786aff8b","msg":"User logged in successfully"}
{"level":30,"time":1768250320351,"env":"test","module":"audit-log-service","userId":"8f9fe43c-1092-4a46-8926-59ac786aff8b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250320420,"env":"test","module":"auth-routes","userId":"16c9ea7c304599e81f3f48e2627543f7","msg":"User logged in successfully"}
{"level":30,"time":1768250320434,"env":"test","module":"user-credentials-repository","userId":"Mkf9ywGHwbf1AMVSifzHS","msg":"User credentials created"}
{"level":30,"time":1768250320475,"env":"test","module":"user-credentials-repository","userId":"630ba616-ebca-43f8-b3f3-9ed997015b3e","msg":"User credentials created"}
{"level":30,"time":1768250320480,"env":"test","module":"audit-log-service","userId":"16c9ea7c304599e81f3f48e2627543f7","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250320490,"env":"test","module":"auth-service","tokenHash":"47b013b96e204b48b43f7650543eea245bd4925ea8331ebadcad01a98939e8d0","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250320571,"env":"test","module":"email-queue","jobId":"d0262aee-ce19-4e6d-bca1-d77724994084","to":"session-test-09dTEI6hd0JwgU9WOBozU@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250320617,"env":"test","module":"auth-routes","userId":"630ba616-ebca-43f8-b3f3-9ed997015b3e","email":"session-test-09dTEI6hd0JwgU9WOBozU@example.com","msg":"User registered"}
{"level":30,"time":1768250320688,"env":"test","module":"email-queue","jobId":"8b751d2d-32a4-4ba0-8fed-c0c1b597aa7c","to":"test-1768250319562-ol1pt@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250320688,"env":"test","module":"auth-service","email":"test-1768250319562-ol1pt@example.com","msg":"Password reset email sent"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250320828,"env":"test","module":"user-credentials-repository","userId":"c25aa960-5ede-4481-a04f-342ef8d9a35c","msg":"User credentials created"}
{"level":50,"time":1768250320859,"env":"test","module":"auth-routes","userId":"630ba616-ebca-43f8-b3f3-9ed997015b3e","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250320926,"env":"test","module":"email-queue","jobId":"14547fdd-b447-4b85-91ae-9a9c7fe9bfcd","to":"middleware-test-PuQ_X4Y2J8PLea1VUt19O@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768250320960,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should order sessions by last used (most recent first)
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250320975,"env":"test","module":"auth-routes","userId":"c25aa960-5ede-4481-a04f-342ef8d9a35c","email":"middleware-test-PuQ_X4Y2J8PLea1VUt19O@example.com","msg":"User registered"}
{"level":30,"time":1768250320993,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250320993,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 when no token provided
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250321065,"env":"test","module":"user-credentials-repository","error":{},"userId":"16c9ea7c304599e81f3f48e2627543f7","msg":"Failed to update user password"}
{"level":50,"time":1768250321065,"env":"test","module":"auth-routes","error":{},"msg":"Reset password error"}
{"level":50,"time":1768250321176,"env":"test","module":"auth-routes","userId":"c25aa960-5ede-4481-a04f-342ef8d9a35c","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250321286,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should return 401 when no token provided
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should return 401 when no token provided
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:38:41.289Z'
  }
}

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w4_ba3e15c2

{"level":30,"time":1768250321327,"env":"test","module":"user-credentials-repository","userId":"fb663169-2cf5-4cd5-9156-99c1188d95cd","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 when no token provided
[22m[39mUser in DB: {
  id: [32m'c25aa960-5ede-4481-a04f-342ef8d9a35c'[39m,
  email: [32m'middleware-test-PuQ_X4Y2J8PLea1VUt19O@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:38:43.740Z[39m,
  updatedAt: [35m2026-01-12T20:38:43.740Z[39m
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 when no token provided
[22m[39mCreds in DB: [90mundefined[39m

{"level":30,"time":1768250321422,"env":"test","module":"email-queue","jobId":"fecee804-83c5-440c-8f67-7f4ddf87ee3e","to":"session-test-PFt5aXtJZl1gzaEqEHxUD@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
 [31mÎ“Â¥Â»[39m tests/integration/auth/oauth2.token-refresh.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m4 failed[39m[2m)[22m[33m 59196[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should refresh access token with valid refresh token[39m[33m 520[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should rotate refresh token after use [33m 680[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 when refresh token is missing [33m 368[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for invalid refresh token [33m 474[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for expired refresh token [33m 518[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for revoked refresh token [33m 528[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 when user is not found [33m 544[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update refresh token metadata on rotation[39m[33m 519[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle concurrent refresh token requests (token reuse detection) [33m 1064[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set secure cookie in production [33m 572[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set proper cookie attributes [33m 585[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should include user role information in response [33m 570[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should create refresh token on login[39m[33m 647[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke refresh token on logout [33m 480[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle logout without refresh token gracefully [33m 369[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should support multiple active refresh tokens per user [33m 523[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke all user tokens on password reset [33m 578[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should use cryptographically strong random tokens [33m 5441[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should hash refresh tokens before storing in database [33m 475[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent refresh token reuse after rotation[39m[33m 535[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should validate token ownership [33m 477[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set HttpOnly flag to prevent XSS [33m 569[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set SameSite=Strict to prevent CSRF [33m 529[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set proper cookie path [33m 575[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set appropriate expiry (30 days) [33m 592[2mms[22m[39m
{"level":30,"time":1768250321474,"env":"test","module":"auth-routes","userId":"fb663169-2cf5-4cd5-9156-99c1188d95cd","email":"session-test-PFt5aXtJZl1gzaEqEHxUD@example.com","msg":"User registered"}
{"level":50,"time":1768250321577,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250321772,"env":"test","module":"user-credentials-repository","userId":"68611f92-cd53-474f-b919-ef416a2dc8c9","msg":"User credentials created"}
{"level":30,"time":1768250321873,"env":"test","module":"email-queue","jobId":"d6bf495b-3b1a-4d65-a653-7bdb6d864451","to":"middleware-test-kvTtiShUrRvdhaScCeTJT@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250321924,"env":"test","module":"auth-routes","userId":"68611f92-cd53-474f-b919-ef416a2dc8c9","email":"middleware-test-kvTtiShUrRvdhaScCeTJT@example.com","msg":"User registered"}
{"level":30,"time":1768250321944,"env":"test","module":"user-credentials-repository","userId":"82102210-4d9b-4330-96a3-9e101e653ac1","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 with invalid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250321986,"env":"test","module":"email-queue","jobId":"813904f3-9bbd-4366-869b-69ad69aa5c88","to":"test-1768250321413-z89tv4@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250321986,"env":"test","module":"auth-service","email":"test-1768250321413-z89tv4@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768250322040,"env":"test","module":"email-queue","jobId":"0fd49bf8-078b-417c-b460-5c0efe4c81db","to":"session-test-F-ZoM37YENVQSVDvSXZ_Y@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250322087,"env":"test","module":"auth-routes","userId":"82102210-4d9b-4330-96a3-9e101e653ac1","email":"session-test-F-ZoM37YENVQSVDvSXZ_Y@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould rotate refresh token on each use
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250322439,"env":"test","module":"auth-routes","userId":"68611f92-cd53-474f-b919-ef416a2dc8c9","msg":"User logged in successfully"}
{"level":30,"time":1768250322488,"env":"test","module":"audit-log-service","userId":"68611f92-cd53-474f-b919-ef416a2dc8c9","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250322493,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250322562,"env":"test","module":"auth-routes","userId":"684125d3f79b7be5848d5ca8124dc1c1","msg":"User logged in successfully"}
{"level":30,"time":1768250322614,"env":"test","module":"audit-log-service","userId":"684125d3f79b7be5848d5ca8124dc1c1","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250322617,"env":"test","module":"auth-service","tokenHash":"b1864e81ef5204dacdc7bc647b16bb0685385e40e8d4d0cfc183f23b5663a179","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250322654,"env":"test","module":"auth-routes","userId":"82102210-4d9b-4330-96a3-9e101e653ac1","msg":"User logged in successfully"}
{"level":30,"time":1768250322702,"env":"test","module":"audit-log-service","userId":"82102210-4d9b-4330-96a3-9e101e653ac1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250322821,"env":"test","module":"auth-service","tokenHash":"5c449f1007c78af8de2a630c6ff3e1b1c699d3c4efc652a36a8457f3676416ab","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768250322849,"env":"test","module":"auth-routes","userId":"82102210-4d9b-4330-96a3-9e101e653ac1","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250322869,"env":"test","module":"user-credentials-repository","userId":"1917e9ef-8b7c-4993-838d-ea40e8c2c392","msg":"User credentials created"}
{"level":40,"time":1768250322874,"env":"test","module":"auth-service","tokenHash":"5c449f1007c78af8de2a630c6ff3e1b1c699d3c4efc652a36a8457f3676416ab","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768250322928,"env":"test","module":"auth-service","allTokensCount":0,"msg":"DEBUG: Tokens in DB"}
{"level":50,"time":1768250322939,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/:sessionId > should revoke specific session
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250322971,"env":"test","module":"email-queue","jobId":"f67752d6-7dc2-471f-bd6f-33de56009bc5","to":"middleware-test-gRCK3VOuR1fGvgrDd7fKe@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250323031,"env":"test","module":"auth-routes","userId":"1917e9ef-8b7c-4993-838d-ea40e8c2c392","email":"middleware-test-gRCK3VOuR1fGvgrDd7fKe@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 with expired token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250323230,"env":"test","module":"auth-routes","userId":"1917e9ef-8b7c-4993-838d-ea40e8c2c392","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mGET /api/auth/me[2m > [22m[2mshould return current user for valid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250323309,"env":"test","module":"user-credentials-repository","userId":"ae6f64ee-6f08-4e28-8c10-4ffce60bad5b","msg":"User credentials created"}
{"level":50,"time":1768250323326,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should return 401 with expired token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should return 401 with expired token
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:38:43.327Z'
  }
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 with expired token
[22m[39mUser in DB: {
  id: [32m'1917e9ef-8b7c-4993-838d-ea40e8c2c392'[39m,
  email: [32m'middleware-test-gRCK3VOuR1fGvgrDd7fKe@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:38:45.772Z[39m,
  updatedAt: [35m2026-01-12T20:38:45.772Z[39m
}

{"level":50,"time":1768250323406,"env":"test","module":"auth-routes","userId":"22249ab382dbdede2bb29ab54d79f21d","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250323411,"env":"test","module":"email-queue","jobId":"0caf0f5c-862c-4914-acc3-acc1224dd695","to":"session-test-lJ7J5hSqeLAsxQBNQOhz_@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 with expired token
[22m[39mCreds in DB: [90mundefined[39m

{"level":30,"time":1768250323465,"env":"test","module":"auth-routes","userId":"ae6f64ee-6f08-4e28-8c10-4ffce60bad5b","email":"session-test-lJ7J5hSqeLAsxQBNQOhz_@example.com","msg":"User registered"}
{"level":50,"time":1768250323512,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > GET /api/auth/me > should return current user for valid token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250323516,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: constraint "users_email_unique" of relation "users" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 136,
  severity: 'ERROR',
  code: '42704',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'tablecmds.c',
  line: '12648',
  routine: 'ATExecDropConstraint'
}

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking current session
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould detect and prevent refresh token reuse (token theft)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250323717,"env":"test","module":"auth-routes","userId":"ae6f64ee-6f08-4e28-8c10-4ffce60bad5b","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250323784,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768250323792,"env":"test","module":"user-credentials-repository","userId":"2bef4d84-46e0-4eb1-862b-fd2bb66d7efc","msg":"User credentials created"}
{"level":30,"time":1768250323802,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39m[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768250323792,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768250323792,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768250323797,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768250323802,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768250323802,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768250323802,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768250323802,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":50,"time":1768250323808,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/:sessionId > should prevent revoking current session
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250323888,"env":"test","module":"email-queue","jobId":"3a845d5d-f7aa-4a9e-9dab-b79bac416fd6","to":"middleware-test-PatSNxRIKGZcHJJzDqc8q@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250323939,"env":"test","module":"auth-routes","userId":"2bef4d84-46e0-4eb1-862b-fd2bb66d7efc","email":"middleware-test-PatSNxRIKGZcHJJzDqc8q@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould authenticate with JWT Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250324139,"env":"test","module":"auth-routes","userId":"2bef4d84-46e0-4eb1-862b-fd2bb66d7efc","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250324157,"env":"test","module":"auth-routes","userId":"fbe6b2520c411ec162b42ef43dffa815","msg":"User logged in successfully"}
{"level":30,"time":1768250324184,"env":"test","module":"user-credentials-repository","userId":"92d0e7b0-0418-4db0-9146-811701f05025","msg":"User credentials created"}
{"level":30,"time":1768250324207,"env":"test","module":"audit-log-service","userId":"fbe6b2520c411ec162b42ef43dffa815","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250324210,"env":"test","module":"auth-service","tokenHash":"c831ff52842aa4a9af28baa75f0dfe78aceacd5eba824fec04f06cc30c05f92e","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768250324239,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should authenticate with JWT Bearer token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should authenticate with JWT Bearer token
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:38:44.239Z'
  }
}

{"level":40,"time":1768250324259,"env":"test","module":"auth-service","tokenHash":"c831ff52842aa4a9af28baa75f0dfe78aceacd5eba824fec04f06cc30c05f92e","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768250324273,"env":"test","module":"user-credentials-repository","userId":"b1418042-fd34-4b37-8e7c-f8b26b2715f1","msg":"User credentials created"}
{"level":30,"time":1768250324282,"env":"test","module":"email-queue","jobId":"11aa372e-6d90-4008-9605-d19f7b72698c","to":"session-test-ICAR3hDiiC1cZAUP6gSFw@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould authenticate with JWT Bearer token
[22m[39mUser in DB: {
  id: [32m'2bef4d84-46e0-4eb1-862b-fd2bb66d7efc'[39m,
  email: [32m'middleware-test-PatSNxRIKGZcHJJzDqc8q@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:38:46.699Z[39m,
  updatedAt: [35m2026-01-12T20:38:46.699Z[39m
}

{"level":30,"time":1768250324307,"env":"test","module":"auth-service","allTokensCount":0,"msg":"DEBUG: Tokens in DB"}
{"level":50,"time":1768250324330,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250324330,"env":"test","module":"auth-routes","userId":"92d0e7b0-0418-4db0-9146-811701f05025","email":"session-test-ICAR3hDiiC1cZAUP6gSFw@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould authenticate with JWT Bearer token
[22m[39mCreds in DB: [90mundefined[39m

{"level":30,"time":1768250324371,"env":"test","module":"email-queue","jobId":"f2fbaa92-11d3-448d-a4bb-6dc367de8413","to":"test-13iUOvkh2-10hNW1iDn3v@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250324422,"env":"test","module":"auth-routes","userId":"b1418042-fd34-4b37-8e7c-f8b26b2715f1","email":"test-13iUOvkh2-10hNW1iDn3v@example.com","msg":"User registered"}
{"level":30,"time":1768250324716,"env":"test","module":"user-credentials-repository","userId":"dac4fac9-f934-4caf-9514-215ca8dc6c88","msg":"User credentials created"}
{"level":30,"time":1768250324809,"env":"test","module":"user-credentials-repository","userId":"91694b56-77bd-4e95-b468-cfb1d538a6cd","msg":"User credentials created"}
{"level":30,"time":1768250324819,"env":"test","module":"email-queue","jobId":"18a46397-d8c9-47a5-83b8-1b68a24531f4","to":"middleware-test-OyvSSmz1zB2P1lHenVbzy@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250324868,"env":"test","module":"auth-routes","userId":"dac4fac9-f934-4caf-9514-215ca8dc6c88","email":"middleware-test-OyvSSmz1zB2P1lHenVbzy@example.com","msg":"User registered"}
{"level":30,"time":1768250324914,"env":"test","module":"email-queue","jobId":"8372dd28-1e81-4f61-b011-1471c349ba6b","to":"user2-Yo-eUHlQvMpmUFlE_AeBX@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould authenticate with refresh token cookie (GET only)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250324966,"env":"test","module":"auth-routes","userId":"91694b56-77bd-4e95-b468-cfb1d538a6cd","email":"user2-Yo-eUHlQvMpmUFlE_AeBX@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould not allow revoking other users sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250325066,"env":"test","module":"user-credentials-repository","userId":"f6df1a85-559f-4aae-807f-9ecc4bb6948b","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250325075,"env":"test","module":"auth-routes","userId":"dac4fac9-f934-4caf-9514-215ca8dc6c88","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250325137,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768250325168,"env":"test","module":"auth-routes","userId":"91694b56-77bd-4e95-b468-cfb1d538a6cd","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250325171,"env":"test","module":"email-queue","jobId":"fbc1c2de-5aab-4f30-808c-7ac91e68b5d1","to":"protected-test-P4z4CNc7YMqmezXYSxC8r@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768250325176,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should authenticate with refresh token cookie (GET only)
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should authenticate with refresh token cookie (GET only)
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:38:45.177Z'
  }
}

{"level":50,"time":1768250325223,"env":"test","module":"auth-routes","userId":"bf4a287361c64e8a3fce95f813ddcd5e","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250325223,"env":"test","module":"auth-routes","userId":"f6df1a85-559f-4aae-807f-9ecc4bb6948b","email":"protected-test-P4z4CNc7YMqmezXYSxC8r@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould authenticate with refresh token cookie (GET only)
[22m[39mUser in DB: {
  id: [32m'dac4fac9-f934-4caf-9514-215ca8dc6c88'[39m,
  email: [32m'middleware-test-OyvSSmz1zB2P1lHenVbzy@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:38:47.624Z[39m,
  updatedAt: [35m2026-01-12T20:38:47.624Z[39m
}

{"level":50,"time":1768250325270,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/:sessionId > should not allow revoking other users sessions
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould authenticate with refresh token cookie (GET only)
[22m[39mCreds in DB: [90mundefined[39m

{"level":50,"time":1768250325332,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Session Management Flow > should list all active sessions
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould allow access with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250325487,"env":"test","module":"auth-routes","userId":"f6df1a85-559f-4aae-807f-9ecc4bb6948b","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250325488,"env":"test","module":"auth-routes","userId":"bf4a287361c64e8a3fce95f813ddcd5e","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250325587,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250325593,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Session Management Flow > should list all active sessions
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250325596,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250325637,"env":"test","module":"user-credentials-repository","userId":"2cc2c4be-f2c1-4874-938d-218dbd5bb195","msg":"User credentials created"}
{"level":30,"time":1768250325665,"env":"test","module":"user-credentials-repository","userId":"b3027c2c-26a9-4eeb-8825-ce7590aa5d46","msg":"User credentials created"}
{"level":30,"time":1768250325733,"env":"test","module":"email-queue","jobId":"273ca59f-7881-4f11-a78e-492200fd651d","to":"session-test-FC7JEY9cW1yGhksbrk1US@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250325769,"env":"test","module":"email-queue","jobId":"9106d85f-76e4-46e3-8ac4-974a48706030","to":"middleware-test-_Hx_bqbrOWqvm81lVKbR_@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250325780,"env":"test","module":"auth-routes","userId":"2cc2c4be-f2c1-4874-938d-218dbd5bb195","email":"session-test-FC7JEY9cW1yGhksbrk1US@example.com","msg":"User registered"}
{"level":30,"time":1768250325818,"env":"test","module":"auth-routes","userId":"b3027c2c-26a9-4eeb-8825-ce7590aa5d46","email":"middleware-test-_Hx_bqbrOWqvm81lVKbR_@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for POST requests (mutation-strict)
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould return 404 for non-existent session ID
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250325963,"env":"test","module":"user-credentials-repository","userId":"0dab7b5a-e8b2-4e35-a1df-9f89ce34129d","msg":"User credentials created"}
{"level":50,"time":1768250326017,"env":"test","module":"auth-routes","userId":"b3027c2c-26a9-4eeb-8825-ce7590aa5d46","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250326030,"env":"test","module":"auth-routes","userId":"2cc2c4be-f2c1-4874-938d-218dbd5bb195","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250326059,"env":"test","module":"email-queue","jobId":"de05c60f-ccf1-4dfc-9eed-f55cffb6e290","to":"protected-test-WR3M2wbxO1DzJKzalGHOB@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250326107,"env":"test","module":"auth-routes","userId":"0dab7b5a-e8b2-4e35-a1df-9f89ce34129d","email":"protected-test-WR3M2wbxO1DzJKzalGHOB@example.com","msg":"User registered"}
{"level":50,"time":1768250326115,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should reject cookie auth for POST requests (mutation-strict)
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should reject cookie auth for POST requests (mutation-strict)
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:38:46.116Z'
  }
}

{"level":50,"time":1768250326121,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/:sessionId > should return 404 for non-existent session ID
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for POST requests (mutation-strict)
[22m[39mUser in DB: {
  id: [32m'b3027c2c-26a9-4eeb-8825-ce7590aa5d46'[39m,
  email: [32m'middleware-test-_Hx_bqbrOWqvm81lVKbR_@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:38:48.563Z[39m,
  updatedAt: [35m2026-01-12T20:38:48.563Z[39m
}

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould reject access without Authorization header
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for POST requests (mutation-strict)
[22m[39mCreds in DB: [90mundefined[39m

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250326371,"env":"test","module":"auth-routes","userId":"0dab7b5a-e8b2-4e35-a1df-9f89ce34129d","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould complete MFA login with valid TOTP code
[22m[39m[TEST UTILS] MFA Secret verified for 5fe6c324ffddd20aa2ea8d48d74006b0

{"level":50,"time":1768250326467,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250326483,"env":"test","module":"user-credentials-repository","userId":"d66ff89c-e48a-4960-ae1d-c7fdc20b7b6b","msg":"User credentials created"}
{"level":30,"time":1768250326585,"env":"test","module":"email-queue","jobId":"02f84e65-a818-4b26-bc4f-13191bf60241","to":"session-test-54hpjuAAm0sUw027tYPml@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250326596,"env":"test","module":"user-credentials-repository","userId":"fbfb0098-49ae-433e-809b-d7ae1b3b1fc3","msg":"User credentials created"}
{"level":30,"time":1768250326631,"env":"test","module":"auth-routes","userId":"d66ff89c-e48a-4960-ae1d-c7fdc20b7b6b","email":"session-test-54hpjuAAm0sUw027tYPml@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould complete MFA login with valid TOTP code
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250326696,"env":"test","module":"email-queue","jobId":"74f13967-35a0-4193-8dae-ae443827e619","to":"middleware-test-jopd5RpGMmrWJ5iv9GlRt@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all sessions except current
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250326750,"env":"test","module":"auth-routes","userId":"fbfb0098-49ae-433e-809b-d7ae1b3b1fc3","email":"middleware-test-jopd5RpGMmrWJ5iv9GlRt@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for PUT requests
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250326827,"env":"test","module":"auth-routes","userId":"1d3cd9f97c11eb10e5271384343d5a36","msg":"User logged in successfully"}
{"level":30,"time":1768250326856,"env":"test","module":"user-credentials-repository","userId":"383d301d-5880-45d2-90cf-e42ec21dfeed","msg":"User credentials created"}
{"level":30,"time":1768250326876,"env":"test","module":"audit-log-service","userId":"1d3cd9f97c11eb10e5271384343d5a36","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250326958,"env":"test","module":"email-queue","jobId":"ae8055cf-3986-4c0d-a011-1b4a4d4cd9e7","to":"protected-test-2HIWtI_C1IMFfS-SsaKTz@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250327011,"env":"test","module":"auth-routes","userId":"383d301d-5880-45d2-90cf-e42ec21dfeed","email":"protected-test-2HIWtI_C1IMFfS-SsaKTz@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould reject access with empty Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250327129,"env":"test","module":"auth-routes","userId":"5fe6c324ffddd20aa2ea8d48d74006b0","msg":"Login requires MFA verification"}
{"level":30,"time":1768250327195,"env":"test","module":"auth-routes","userId":"d66ff89c-e48a-4960-ae1d-c7fdc20b7b6b","msg":"User logged in successfully"}
{"level":30,"time":1768250327237,"env":"test","module":"mfa-service","userId":"5fe6c324ffddd20aa2ea8d48d74006b0","msg":"TOTP verification successful"}
{"level":30,"time":1768250327241,"env":"test","module":"audit-log-service","userId":"d66ff89c-e48a-4960-ae1d-c7fdc20b7b6b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all sessions except current
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250327278,"env":"test","module":"auth-routes","userId":"fbfb0098-49ae-433e-809b-d7ae1b3b1fc3","msg":"User logged in successfully"}
{"level":30,"time":1768250327285,"env":"test","module":"auth-routes","userId":"5fe6c324ffddd20aa2ea8d48d74006b0","msg":"MFA login successful"}
{"level":30,"time":1768250327326,"env":"test","module":"audit-log-service","userId":"fbfb0098-49ae-433e-809b-d7ae1b3b1fc3","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250327330,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250327340,"env":"test","module":"auth-routes","userId":"1d3cd9f97c11eb10e5271384343d5a36","msg":"User logged in successfully"}
{"level":30,"time":1768250327389,"env":"test","module":"audit-log-service","userId":"1d3cd9f97c11eb10e5271384343d5a36","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250327499,"env":"test","module":"auth-routes","userId":"1d3cd9f97c11eb10e5271384343d5a36","sessionCount":2,"msg":"Listed active sessions"}
{"level":30,"time":1768250327608,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250327608,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768250327634,"env":"test","module":"auth-routes","userId":"383d301d-5880-45d2-90cf-e42ec21dfeed","msg":"User logged in successfully"}
{"level":30,"time":1768250327689,"env":"test","module":"audit-log-service","userId":"383d301d-5880-45d2-90cf-e42ec21dfeed","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250327693,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250327701,"env":"test","module":"auth-routes","userId":"d66ff89c-e48a-4960-ae1d-c7fdc20b7b6b","msg":"User logged in successfully"}
{"level":30,"time":1768250327713,"env":"test","module":"user-credentials-repository","userId":"2c78e68c-fe3c-4d64-9b7d-66f8a06dbee9","msg":"User credentials created"}
{"level":30,"time":1768250327750,"env":"test","module":"audit-log-service","userId":"d66ff89c-e48a-4960-ae1d-c7fdc20b7b6b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all sessions except current
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250327815,"env":"test","module":"email-queue","jobId":"f3597481-1334-46da-ad68-38e6c79505e0","to":"middleware-test-8gKZ2YVkl7a-7wNzrfwF6@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250327865,"env":"test","module":"auth-routes","userId":"2c78e68c-fe3c-4d64-9b7d-66f8a06dbee9","email":"middleware-test-8gKZ2YVkl7a-7wNzrfwF6@example.com","msg":"User registered"}
{"level":50,"time":1768250327892,"env":"test","module":"auth-routes","userId":"d66ff89c-e48a-4960-ae1d-c7fdc20b7b6b","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w5_d7780fe8

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for DELETE requests
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250327987,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/all > should revoke all sessions except current
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

 [31mÎ“Â¥Â»[39m tests/integration/auth.flows.real.test.ts [2m([22m[2m11 tests[22m[2m | [22m[31m9 failed[39m[2m)[22m[33m 65777[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should complete registration, verify email, then login [33m 1897[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should lock account after 5 failed attempts, then unlock after waiting[39m[33m 2771[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should record all login attempts[39m[33m 1582[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should complete MFA setup and login with TOTP[39m[33m 1862[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should login with backup code when TOTP unavailable[39m[33m 1839[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should complete full password reset flow[39m[33m 1673[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should invalidate all sessions after password reset [33m 2121[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should rotate refresh token on each use[39m[33m 1654[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should detect and prevent refresh token reuse (token theft)[39m[33m 1379[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all active sessions[39m[33m 1289[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific session[39m[33m 2010[2mms[22m[39m
{"level":30,"time":1768250328060,"env":"test","module":"user-credentials-repository","userId":"013569fc-2b9e-48df-9f4b-6f963708a375","msg":"User credentials created"}
{"level":30,"time":1768250328165,"env":"test","module":"email-queue","jobId":"3f6347e7-cd4a-4c18-9703-c6bd6da28d35","to":"protected-test-lsqNJn5BQSKjckjruriIp@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250328215,"env":"test","module":"auth-routes","userId":"013569fc-2b9e-48df-9f4b-6f963708a375","email":"protected-test-lsqNJn5BQSKjckjruriIp@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould reject access with malformed Authorization header
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250328355,"env":"test","module":"user-credentials-repository","userId":"b792f4ce-8b9f-4ddb-b667-a3dd0e1f4635","msg":"User credentials created"}
{"level":30,"time":1768250328389,"env":"test","module":"auth-routes","userId":"2c78e68c-fe3c-4d64-9b7d-66f8a06dbee9","msg":"User logged in successfully"}
{"level":30,"time":1768250328437,"env":"test","module":"audit-log-service","userId":"2c78e68c-fe3c-4d64-9b7d-66f8a06dbee9","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250328442,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250328456,"env":"test","module":"email-queue","jobId":"910bad20-565c-442d-b025-a974ca4b7d7b","to":"session-test-THyyLb3q5E_Sk5Rd0HD5M@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768250328461,"env":"test","module":"auth-routes","userId":"013569fc-2b9e-48df-9f4b-6f963708a375","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250328505,"env":"test","module":"auth-routes","userId":"b792f4ce-8b9f-4ddb-b667-a3dd0e1f4635","email":"session-test-THyyLb3q5E_Sk5Rd0HD5M@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould reject invalid MFA code
[22m[39m[TEST UTILS] MFA Secret verified for fa9b62d20765dc5f2b5bcb718d872bdf

{"level":50,"time":1768250328560,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with malformed Authorization header
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all trusted devices
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250328826,"env":"test","module":"user-credentials-repository","userId":"745066bb-51fd-46b6-915e-3b4d4ce4f970","msg":"User credentials created"}
{"level":40,"time":1768250328929,"env":"test","module":"mfa-service","userId":"fa9b62d20765dc5f2b5bcb718d872bdf","msg":"TOTP verification failed"}
{"level":40,"time":1768250328929,"env":"test","module":"auth-routes","userId":"fa9b62d20765dc5f2b5bcb718d872bdf","msg":"MFA verification failed during login"}
{"level":30,"time":1768250328930,"env":"test","module":"email-queue","jobId":"a4ef7c6a-4ef2-4720-a334-a5e6c181a895","to":"middleware-test-Se9hJtGLOJc2m6PnuFYlB@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250328935,"env":"test","module":"user-credentials-repository","userId":"1f5bd8ec-e205-4082-9c2e-ea8d2a83eb4d","msg":"User credentials created"}
{"level":30,"time":1768250328980,"env":"test","module":"auth-routes","userId":"745066bb-51fd-46b6-915e-3b4d4ce4f970","email":"middleware-test-Se9hJtGLOJc2m6PnuFYlB@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould allow cookie auth for HEAD requests
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250329040,"env":"test","module":"email-queue","jobId":"edaedbb6-3bfd-4e00-b127-b622c3ea6399","to":"protected-test-euygicdXOQk3R2BXtP_Qk@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250329066,"env":"test","module":"auth-routes","userId":"b792f4ce-8b9f-4ddb-b667-a3dd0e1f4635","msg":"User logged in successfully"}
{"level":30,"time":1768250329093,"env":"test","module":"auth-routes","userId":"1f5bd8ec-e205-4082-9c2e-ea8d2a83eb4d","email":"protected-test-euygicdXOQk3R2BXtP_Qk@example.com","msg":"User registered"}
{"level":30,"time":1768250329112,"env":"test","module":"audit-log-service","userId":"b792f4ce-8b9f-4ddb-b667-a3dd0e1f4635","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stderr | tests/integration/auth/jwt.authentication.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: constraint "users_email_unique" of relation "users" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 136,
  severity: 'ERROR',
  code: '42704',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'tablecmds.c',
  line: '12648',
  routine: 'ATExecDropConstraint'
}

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould reject access with wrong token type
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250329264,"env":"test","module":"auth-routes","userId":"b792f4ce-8b9f-4ddb-b667-a3dd0e1f4635","deviceFingerprint":"377ad01217b8c93ca52518d515505c47ab7553fab66d6fddaa60af67802c5a4c","msg":"Device marked as trusted"}
{"level":30,"time":1768250329328,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250329328,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768250329353,"env":"test","module":"auth-routes","userId":"1f5bd8ec-e205-4082-9c2e-ea8d2a83eb4d","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250329399,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768250329406,"env":"test","module":"auth-routes","userId":"b792f4ce-8b9f-4ddb-b667-a3dd0e1f4635","msg":"All other sessions revoked"}
{"level":30,"time":1768250329416,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39m[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768250329407,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768250329408,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768250329412,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768250329416,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768250329416,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768250329416,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768250329416,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":50,"time":1768250329453,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250329457,"env":"test","module":"audit-log-service","userId":"b792f4ce-8b9f-4ddb-b667-a3dd0e1f4635","eventType":"all_sessions_revoked","ipAddress":"::1","hasMetadata":false,"msg":"Security event logged"}
{"level":30,"time":1768250329496,"env":"test","module":"auth-routes","userId":"745066bb-51fd-46b6-915e-3b4d4ce4f970","msg":"User logged in successfully"}
{"level":30,"time":1768250329545,"env":"test","module":"audit-log-service","userId":"745066bb-51fd-46b6-915e-3b4d4ce4f970","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250329560,"env":"test","module":"auth-routes","userId":"b792f4ce-8b9f-4ddb-b667-a3dd0e1f4635","deviceCount":0,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w3_63bf0652

 [31mÎ“Â¥Â»[39m tests/integration/auth.routes.real.test.ts [2m([22m[2m26 tests[22m[2m | [22m[31m3 failed[39m[2m)[22m[33m 67484[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should register a new user successfully [33m 1383[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 400 for invalid email format [33m 775[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 400 for weak password [33m 802[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 409 for duplicate email [33m 1346[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set httpOnly refresh token cookie [33m 1289[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should login with valid credentials [33m 1665[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for invalid password [33m 1616[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for non-existent user [33m 946[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 403 for unverified email [33m 1706[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should record failed login attempt [33m 1649[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return requiresMfa=true for MFA-enabled users [33m 1982[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should lock account after 5 failed attempts[39m[33m 3213[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should logout and clear refresh token cookie [33m 1732[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should refresh access token with valid refresh token [33m 1878[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for missing refresh token [33m 785[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should rotate refresh token after use [33m 2012[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should send password reset email for existing user [33m 1353[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not reveal if email exists (security) [33m 841[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reset password with valid token[39m[33m 2177[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 400 for invalid token [33m 866[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 400 for weak new password [33m 1488[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return current user for valid token[39m[33m 1426[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for missing token [33m 804[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for invalid token [33m 805[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should complete MFA login with valid TOTP code [33m 2152[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should reject invalid MFA code [33m 1647[2mms[22m[39m
{"level":30,"time":1768250329823,"env":"test","module":"user-credentials-repository","userId":"717097ef-5e21-44a2-85a5-387e61257561","msg":"User credentials created"}
{"level":30,"time":1768250329876,"env":"test","module":"user-credentials-repository","userId":"b6c6bf18-23b6-4bbc-9fc9-541cc67897b8","msg":"User credentials created"}
{"level":30,"time":1768250329923,"env":"test","module":"email-queue","jobId":"dc465ecb-f5e4-41ab-ae41-9147b2d37c97","to":"protected-test-gtjetBBiw_8Tg5D-2YkCD@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250329928,"env":"test","module":"user-credentials-repository","userId":"e703891e-b860-4f33-a128-945870bd106d","msg":"User credentials created"}
{"level":30,"time":1768250329971,"env":"test","module":"auth-routes","userId":"717097ef-5e21-44a2-85a5-387e61257561","email":"protected-test-gtjetBBiw_8Tg5D-2YkCD@example.com","msg":"User registered"}
{"level":30,"time":1768250329984,"env":"test","module":"email-queue","jobId":"79a0b530-d50b-492a-9a6e-9a0b74e4acd8","to":"test-t5wSdJxGkuGLDxLzpQ_T4@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250330034,"env":"test","module":"email-queue","jobId":"818c2bc3-becb-4dd0-a968-10bc22ce4df2","to":"session-test-hbP1fyruWYUMnw7HMqL1k@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250330044,"env":"test","module":"auth-routes","userId":"b6c6bf18-23b6-4bbc-9fc9-541cc67897b8","email":"test-t5wSdJxGkuGLDxLzpQ_T4@example.com","msg":"User registered"}
{"level":30,"time":1768250330068,"env":"test","module":"user-credentials-repository","userId":"9ed6da9f-16cb-4144-9753-8e72e027ea4a","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPOST Protected Routes[2m > [22m[2mshould allow POST with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250330079,"env":"test","module":"auth-routes","userId":"e703891e-b860-4f33-a128-945870bd106d","email":"session-test-hbP1fyruWYUMnw7HMqL1k@example.com","msg":"User registered"}
{"level":30,"time":1768250330167,"env":"test","module":"email-queue","jobId":"3637197c-4dfb-4fe5-8a00-5da4ccafab89","to":"middleware-test-XlpLNLXPLiihiL4hqr2vq@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768250330180,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250330215,"env":"test","module":"auth-routes","userId":"9ed6da9f-16cb-4144-9753-8e72e027ea4a","email":"middleware-test-XlpLNLXPLiihiL4hqr2vq@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould prioritize JWT over cookie when both present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250330543,"env":"test","module":"user-credentials-repository","userId":"772e8dbd-d80c-402d-84ab-1ab8d3569f52","msg":"User credentials created"}
{"level":30,"time":1768250330591,"env":"test","module":"auth-routes","userId":"717097ef-5e21-44a2-85a5-387e61257561","msg":"User logged in successfully"}
{"level":30,"time":1768250330635,"env":"test","module":"email-queue","jobId":"415ea6b0-3b15-4584-855e-a5234256f3ba","to":"session-test-GC3FST61K5qg5ZVs0rnIv@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250330644,"env":"test","module":"audit-log-service","userId":"717097ef-5e21-44a2-85a5-387e61257561","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250330681,"env":"test","module":"auth-routes","userId":"772e8dbd-d80c-402d-84ab-1ab8d3569f52","email":"session-test-GC3FST61K5qg5ZVs0rnIv@example.com","msg":"User registered"}
{"level":30,"time":1768250330690,"env":"test","module":"user-credentials-repository","userId":"14009e25-282e-4e77-97d9-902edeb39c7d","msg":"User credentials created"}
{"level":30,"time":1768250330738,"env":"test","module":"auth-routes","userId":"9ed6da9f-16cb-4144-9753-8e72e027ea4a","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Expiration[2m > [22m[2mshould reject refresh token after 30 days
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250330786,"env":"test","module":"audit-log-service","userId":"9ed6da9f-16cb-4144-9753-8e72e027ea4a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250330793,"env":"test","module":"email-queue","jobId":"c56d66d0-c6df-46c2-88bd-d4eb30a01fb9","to":"jwt-test-_lGgEx5RMxNdv9ePXb7ZQ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250330846,"env":"test","module":"auth-routes","userId":"14009e25-282e-4e77-97d9-902edeb39c7d","email":"jwt-test-_lGgEx5RMxNdv9ePXb7ZQ@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Generation[2m > [22m[2mshould generate valid JWT token on successful login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250331071,"env":"test","module":"user-credentials-repository","userId":"aa58131f-fd64-4fdf-a9a2-5f61cc3c1e8a","msg":"User credentials created"}
{"level":30,"time":1768250331155,"env":"test","module":"user-credentials-repository","userId":"002aff26-26b9-4517-a86d-cd660475f02f","msg":"User credentials created"}
{"level":30,"time":1768250331172,"env":"test","module":"email-queue","jobId":"b252884e-438a-473f-8778-fd3df983f589","to":"protected-test-8BDCEUa1iKMy-GmUV7Twi@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250331222,"env":"test","module":"auth-routes","userId":"aa58131f-fd64-4fdf-a9a2-5f61cc3c1e8a","email":"protected-test-8BDCEUa1iKMy-GmUV7Twi@example.com","msg":"User registered"}
{"level":30,"time":1768250331228,"env":"test","module":"auth-routes","userId":"772e8dbd-d80c-402d-84ab-1ab8d3569f52","msg":"User logged in successfully"}
{"level":30,"time":1768250331255,"env":"test","module":"email-queue","jobId":"56ab3cc6-2c5f-4c27-8ff6-8143f9e83e9b","to":"user2-GDVVItS1xgNqT_DJ_7CJ-@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250331276,"env":"test","module":"audit-log-service","userId":"772e8dbd-d80c-402d-84ab-1ab8d3569f52","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250331303,"env":"test","module":"auth-routes","userId":"002aff26-26b9-4517-a86d-cd660475f02f","email":"user2-GDVVItS1xgNqT_DJ_7CJ-@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPOST Protected Routes[2m > [22m[2mshould reject POST without Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould prioritize JWT over cookie when both present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250331384,"env":"test","module":"auth-service","tokenHash":"342b1cd5cf952d3cfccab5e7c637a549855ad840d8ea710f84e34af67138e67d","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250331430,"env":"test","module":"auth-service","userId":"772e8dbd-d80c-402d-84ab-1ab8d3569f52","msg":"Security: Expired refresh token used"}
{"level":30,"time":1768250331450,"env":"test","module":"auth-routes","userId":"14009e25-282e-4e77-97d9-902edeb39c7d","msg":"User logged in successfully"}
{"level":30,"time":1768250331507,"env":"test","module":"audit-log-service","userId":"14009e25-282e-4e77-97d9-902edeb39c7d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250331800,"env":"test","module":"user-credentials-repository","userId":"a9d78a60-183f-4187-af90-a615928ee8b5","msg":"User credentials created"}
{"level":30,"time":1768250331819,"env":"test","module":"auth-routes","userId":"002aff26-26b9-4517-a86d-cd660475f02f","msg":"User logged in successfully"}
{"level":30,"time":1768250331843,"env":"test","module":"auth-routes","userId":"aa58131f-fd64-4fdf-a9a2-5f61cc3c1e8a","msg":"User logged in successfully"}
{"level":30,"time":1768250331867,"env":"test","module":"audit-log-service","userId":"002aff26-26b9-4517-a86d-cd660475f02f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250331881,"env":"test","module":"user-credentials-repository","userId":"9bb9d444-f6c7-4b2b-a2e9-2874cad7b7cb","msg":"User credentials created"}
{"level":30,"time":1768250331893,"env":"test","module":"audit-log-service","userId":"aa58131f-fd64-4fdf-a9a2-5f61cc3c1e8a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250331896,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250331897,"env":"test","module":"email-queue","jobId":"bd678b59-6505-4b99-9bef-b17f9301688e","to":"session-test-0T0P136blJEkpRI6ECd2p@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250331947,"env":"test","module":"auth-routes","userId":"a9d78a60-183f-4187-af90-a615928ee8b5","email":"session-test-0T0P136blJEkpRI6ECd2p@example.com","msg":"User registered"}
{"level":30,"time":1768250331983,"env":"test","module":"email-queue","jobId":"c9ab7647-f106-44bc-85f6-59481e43353b","to":"jwt-test-kdIsmtgmjyv0If1qAorp6@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250332034,"env":"test","module":"auth-routes","userId":"9bb9d444-f6c7-4b2b-a2e9-2874cad7b7cb","email":"jwt-test-kdIsmtgmjyv0If1qAorp6@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mConcurrent Session Handling[2m > [22m[2mshould handle multiple concurrent logins
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mConcurrent Session Handling[2m > [22m[2mshould handle multiple concurrent logins
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mConcurrent Session Handling[2m > [22m[2mshould handle multiple concurrent logins
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Generation[2m > [22m[2mshould include correct payload in JWT token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250332266,"env":"test","module":"user-credentials-repository","userId":"108c5d9b-c4ef-41a0-9229-76aa3fd924ef","msg":"User credentials created"}
{"level":30,"time":1768250332341,"env":"test","module":"user-credentials-repository","userId":"b860dc25-cb75-4957-9da4-f1bbc8c95c7e","msg":"User credentials created"}
{"level":30,"time":1768250332367,"env":"test","module":"email-queue","jobId":"9407b053-8e10-4c7b-a4e9-412c82116a34","to":"protected-test-F4ApOhbonrFmwCxLNr0zi@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250332418,"env":"test","module":"auth-routes","userId":"108c5d9b-c4ef-41a0-9229-76aa3fd924ef","email":"protected-test-F4ApOhbonrFmwCxLNr0zi@example.com","msg":"User registered"}
{"level":30,"time":1768250332451,"env":"test","module":"email-queue","jobId":"82da9106-b4e7-4fd1-bd72-123bfbe5aca3","to":"middleware-test-ncn2hyBp6_oDYbIfpYrOe@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250332500,"env":"test","module":"auth-routes","userId":"b860dc25-cb75-4957-9da4-f1bbc8c95c7e","email":"middleware-test-ncn2hyBp6_oDYbIfpYrOe@example.com","msg":"User registered"}
{"level":30,"time":1768250332505,"env":"test","module":"auth-routes","userId":"a9d78a60-183f-4187-af90-a615928ee8b5","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPOST Protected Routes[2m > [22m[2mshould reject POST with invalid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250332537,"env":"test","module":"auth-routes","userId":"9bb9d444-f6c7-4b2b-a2e9-2874cad7b7cb","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould return 401 when no auth provided
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250332552,"env":"test","module":"audit-log-service","userId":"a9d78a60-183f-4187-af90-a615928ee8b5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250332586,"env":"test","module":"audit-log-service","userId":"9bb9d444-f6c7-4b2b-a2e9-2874cad7b7cb","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250332830,"env":"test","module":"auth-routes","userId":"a9d78a60-183f-4187-af90-a615928ee8b5","msg":"User logged in successfully"}
{"level":30,"time":1768250332839,"env":"test","module":"auth-routes","userId":"a9d78a60-183f-4187-af90-a615928ee8b5","msg":"User logged in successfully"}
{"level":30,"time":1768250332888,"env":"test","module":"audit-log-service","userId":"a9d78a60-183f-4187-af90-a615928ee8b5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250332889,"env":"test","module":"audit-log-service","userId":"a9d78a60-183f-4187-af90-a615928ee8b5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250332959,"env":"test","module":"user-credentials-repository","userId":"e0083ff3-ac6b-49ba-9809-2a2f2474ae32","msg":"User credentials created"}
{"level":30,"time":1768250333018,"env":"test","module":"auth-routes","userId":"b860dc25-cb75-4957-9da4-f1bbc8c95c7e","msg":"User logged in successfully"}
{"level":30,"time":1768250333049,"env":"test","module":"auth-routes","userId":"108c5d9b-c4ef-41a0-9229-76aa3fd924ef","msg":"User logged in successfully"}
{"level":30,"time":1768250333063,"env":"test","module":"email-queue","jobId":"48b882c8-fba9-4c6e-bcea-7501509c51f1","to":"jwt-test-gdA8xcjdIT6K-L9EiIwqp@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250333068,"env":"test","module":"audit-log-service","userId":"b860dc25-cb75-4957-9da4-f1bbc8c95c7e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250333071,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250333098,"env":"test","module":"audit-log-service","userId":"108c5d9b-c4ef-41a0-9229-76aa3fd924ef","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250333101,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250333117,"env":"test","module":"auth-routes","userId":"e0083ff3-ac6b-49ba-9809-2a2f2474ae32","email":"jwt-test-gdA8xcjdIT6K-L9EiIwqp@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Generation[2m > [22m[2mshould set JWT expiry to 15 minutes
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250333323,"env":"test","module":"user-credentials-repository","userId":"f5792dff-18fc-4df1-a4dc-4cfe57d692d0","msg":"User credentials created"}
{"level":30,"time":1768250333419,"env":"test","module":"email-queue","jobId":"15a3a358-6cab-44bb-a957-f24cf8834e02","to":"session-test-FFEMNQ-xj09rdLgLBeVcJ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250333440,"env":"test","module":"user-credentials-repository","userId":"12738b67-ea9e-4029-83a4-fddbb8a6a8f0","msg":"User credentials created"}
{"level":30,"time":1768250333470,"env":"test","module":"auth-routes","userId":"f5792dff-18fc-4df1-a4dc-4cfe57d692d0","email":"session-test-FFEMNQ-xj09rdLgLBeVcJ@example.com","msg":"User registered"}
{"level":30,"time":1768250333474,"env":"test","module":"user-credentials-repository","userId":"53edc30a-3472-4857-a3cd-0ea1a14d4200","msg":"User credentials created"}
{"level":30,"time":1768250333554,"env":"test","module":"email-queue","jobId":"2c7d6ef1-0e09-4f60-9d44-c1339f4456f8","to":"middleware-test-MNWnvCRoN6_eAbNrz07Ay@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250333577,"env":"test","module":"email-queue","jobId":"cc906ad3-7fa3-41ad-9a8b-155d6c9ff3b9","to":"protected-test-aTrcyXQe94-vZrFAYOCaE@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mConcurrent Session Handling[2m > [22m[2mshould handle concurrent token refreshes
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250333612,"env":"test","module":"auth-routes","userId":"12738b67-ea9e-4029-83a4-fddbb8a6a8f0","email":"middleware-test-MNWnvCRoN6_eAbNrz07Ay@example.com","msg":"User registered"}
{"level":30,"time":1768250333632,"env":"test","module":"auth-routes","userId":"53edc30a-3472-4857-a3cd-0ea1a14d4200","email":"protected-test-aTrcyXQe94-vZrFAYOCaE@example.com","msg":"User registered"}
{"level":30,"time":1768250333646,"env":"test","module":"auth-routes","userId":"e0083ff3-ac6b-49ba-9809-2a2f2474ae32","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould return 401 when both JWT and cookie are invalid
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250333697,"env":"test","module":"audit-log-service","userId":"e0083ff3-ac6b-49ba-9809-2a2f2474ae32","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPUT Protected Routes[2m > [22m[2mshould allow PUT with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250334056,"env":"test","module":"auth-routes","userId":"f5792dff-18fc-4df1-a4dc-4cfe57d692d0","msg":"User logged in successfully"}
{"level":30,"time":1768250334075,"env":"test","module":"user-credentials-repository","userId":"bfddc46c-1107-4085-83e9-f5b0d80396f6","msg":"User credentials created"}
{"level":30,"time":1768250334105,"env":"test","module":"audit-log-service","userId":"f5792dff-18fc-4df1-a4dc-4cfe57d692d0","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250334108,"env":"test","module":"auth-service","tokenHash":"d9e8cb233478f8a022629428c3e5eb3f814355a4c527ed515c692945ba2dac73","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250334143,"env":"test","module":"auth-routes","userId":"12738b67-ea9e-4029-83a4-fddbb8a6a8f0","msg":"User logged in successfully"}
{"level":30,"time":1768250334182,"env":"test","module":"email-queue","jobId":"92058ab4-2300-4f1a-a694-6590bfa58ba0","to":"jwt-test-NySizLwMpfoDUUnSJTMyX@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250334192,"env":"test","module":"audit-log-service","userId":"12738b67-ea9e-4029-83a4-fddbb8a6a8f0","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250334195,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250334232,"env":"test","module":"auth-routes","userId":"bfddc46c-1107-4085-83e9-f5b0d80396f6","email":"jwt-test-NySizLwMpfoDUUnSJTMyX@example.com","msg":"User registered"}
{"level":30,"time":1768250334271,"env":"test","module":"auth-routes","userId":"53edc30a-3472-4857-a3cd-0ea1a14d4200","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Validation[2m > [22m[2mshould accept valid JWT token on protected routes
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250334312,"env":"test","module":"auth-service","tokenHash":"d9e8cb233478f8a022629428c3e5eb3f814355a4c527ed515c692945ba2dac73","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250334322,"env":"test","module":"audit-log-service","userId":"53edc30a-3472-4857-a3cd-0ea1a14d4200","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768250334360,"env":"test","module":"auth-service","userId":"f5792dff-18fc-4df1-a4dc-4cfe57d692d0","tokenHash":"d9e8cb233478f8a022629428c3e5eb3f814355a4c527ed515c692945ba2dac73","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250334417,"env":"test","module":"auth-service","tokenHash":"292917fee97593258be02376acb20915bd6b0fad46dc6b8fe107fc9e0e442f89","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250334464,"env":"test","module":"auth-service","userId":"f5792dff-18fc-4df1-a4dc-4cfe57d692d0","tokenHash":"292917fee97593258be02376acb20915bd6b0fad46dc6b8fe107fc9e0e442f89","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250334564,"env":"test","module":"user-credentials-repository","userId":"3c95d881-afbe-4fda-844b-6313ef5b6f78","msg":"User credentials created"}
{"level":30,"time":1768250334667,"env":"test","module":"email-queue","jobId":"19302047-dbbf-4c8b-9807-03ae0cd9ad01","to":"middleware-test-1GBguf14W-zTof5FLCdv1@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250334715,"env":"test","module":"auth-routes","userId":"3c95d881-afbe-4fda-844b-6313ef5b6f78","email":"middleware-test-1GBguf14W-zTof5FLCdv1@example.com","msg":"User registered"}
{"level":30,"time":1768250334755,"env":"test","module":"auth-routes","userId":"bfddc46c-1107-4085-83e9-f5b0d80396f6","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould authenticate with JWT if provided
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250334784,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250334785,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768250334804,"env":"test","module":"audit-log-service","userId":"bfddc46c-1107-4085-83e9-f5b0d80396f6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250334858,"env":"test","module":"user-credentials-repository","userId":"3bbf6fea-8361-4608-8801-be8bb52c0aac","msg":"User credentials created"}
{"level":50,"time":1768250334917,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768250334922,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250334967,"env":"test","module":"email-queue","jobId":"1f3e22a9-09e7-4c64-96ea-567889a23e5c","to":"protected-test--1JV4X8RQ9Yx8SEPG4XQi@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250335018,"env":"test","module":"auth-routes","userId":"3bbf6fea-8361-4608-8801-be8bb52c0aac","email":"protected-test--1JV4X8RQ9Yx8SEPG4XQi@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w2_1f52404a

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPUT Protected Routes[2m > [22m[2mshould reject PUT without Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

 [31mÎ“Â¥Â»[39m tests/integration/auth/session.management.integration.test.ts [2m([22m[2m18 tests[22m[2m | [22m[31m12 failed[39m[2m)[22m[33m 68428[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should create refresh token on login[39m[33m 865[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should track device metadata in session[39m[33m 1188[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should create separate sessions for multiple device logins[39m[33m 851[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all active sessions for user[39m[33m 843[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should mark current session correctly[39m[33m 854[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should not include revoked sessions[39m[33m 1852[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should order sessions by last used (most recent first)[39m[33m 865[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 617[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific session[39m[33m 1363[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking current session[39m[33m 868[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should not allow revoking other users sessions[39m[33m 1462[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 404 for non-existent session ID[39m[33m 851[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke all sessions except current[39m[33m 1866[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke all trusted devices [33m 1573[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require active session [33m 619[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject refresh token after 30 days [33m 1250[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle multiple concurrent logins [33m 1512[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle concurrent token refreshes [33m 1573[2mms[22m[39m
{"level":30,"time":1768250335252,"env":"test","module":"auth-routes","userId":"3c95d881-afbe-4fda-844b-6313ef5b6f78","msg":"User logged in successfully"}
{"level":30,"time":1768250335306,"env":"test","module":"audit-log-service","userId":"3c95d881-afbe-4fda-844b-6313ef5b6f78","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250335306,"env":"test","module":"user-credentials-repository","userId":"2bcc28f0-b04d-401d-8a17-14ee27eda3ab","msg":"User credentials created"}
{"level":30,"time":1768250335406,"env":"test","module":"email-queue","jobId":"84e534e1-51c0-4316-a25d-b2e7e97c6b5c","to":"jwt-test-S0PdgA1wUDjUU-s05GZKS@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250335457,"env":"test","module":"auth-routes","userId":"2bcc28f0-b04d-401d-8a17-14ee27eda3ab","email":"jwt-test-S0PdgA1wUDjUU-s05GZKS@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Validation[2m > [22m[2mshould accept request with missing Bearer prefix (lenient)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250335636,"env":"test","module":"auth-routes","userId":"3bbf6fea-8361-4608-8801-be8bb52c0aac","msg":"User logged in successfully"}
{"level":30,"time":1768250335684,"env":"test","module":"audit-log-service","userId":"3bbf6fea-8361-4608-8801-be8bb52c0aac","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250335687,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250335875,"env":"test","module":"intake-service","runId":"68f20f15-9593-494f-91c2-18f7bd90b3b8","slug":"hybrid-jwt-jEUE5A9zeDMrI9suJDoUZ","userId":"3c95d881-afbe-4fda-844b-6313ef5b6f78","msg":"Created intake run"}
{"level":30,"time":1768250335991,"env":"test","module":"auth-routes","userId":"2bcc28f0-b04d-401d-8a17-14ee27eda3ab","msg":"User logged in successfully"}
{"level":30,"time":1768250336041,"env":"test","module":"audit-log-service","userId":"2bcc28f0-b04d-401d-8a17-14ee27eda3ab","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250336052,"env":"test","module":"user-credentials-repository","userId":"a674309c-fa1b-4a5d-99bb-5bf67adea41d","msg":"User credentials created"}
{"level":40,"time":1768250336154,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250336154,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250336160,"env":"test","module":"email-queue","jobId":"64650054-7f96-4bea-9e60-7b7aacc0cf75","to":"protected-test-eC3p06d912W2MCszxsyKy@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250336211,"env":"test","module":"auth-routes","userId":"a674309c-fa1b-4a5d-99bb-5bf67adea41d","email":"protected-test-eC3p06d912W2MCszxsyKy@example.com","msg":"User registered"}
{"level":30,"time":1768250336255,"env":"test","module":"user-credentials-repository","userId":"94d6861d-fa6b-46fe-b2d8-64a3501a44f2","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mDELETE Protected Routes[2m > [22m[2mshould allow DELETE with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250336358,"env":"test","module":"email-queue","jobId":"812d5078-8164-4d8e-aff6-0f6a57b35488","to":"middleware-test-cfYrn6XxustPEfG1JxtuX@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250336406,"env":"test","module":"auth-routes","userId":"94d6861d-fa6b-46fe-b2d8-64a3501a44f2","email":"middleware-test-cfYrn6XxustPEfG1JxtuX@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould authenticate with cookie if JWT not provided
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250336830,"env":"test","module":"auth-routes","userId":"a674309c-fa1b-4a5d-99bb-5bf67adea41d","msg":"User logged in successfully"}
{"level":30,"time":1768250336878,"env":"test","module":"audit-log-service","userId":"a674309c-fa1b-4a5d-99bb-5bf67adea41d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250336913,"env":"test","module":"auth-routes","userId":"94d6861d-fa6b-46fe-b2d8-64a3501a44f2","msg":"User logged in successfully"}
{"level":30,"time":1768250336973,"env":"test","module":"audit-log-service","userId":"94d6861d-fa6b-46fe-b2d8-64a3501a44f2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768250337259,"env":"test","module":"auth-middleware","error":{"name":"TokenExpiredError","code":"AUTH_002","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250337259,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250337408,"env":"test","module":"user-credentials-repository","userId":"76765948-423f-4930-a090-3e0cd8a7461a","msg":"User credentials created"}
{"level":30,"time":1768250337484,"env":"test","module":"intake-service","runId":"92937ad3-4a00-4d93-8136-ffb9920bab1d","slug":"hybrid-cookie-FURaV79m60-piyKF96_3N","msg":"Created intake run"}
{"level":30,"time":1768250337504,"env":"test","module":"email-queue","jobId":"e4f0b549-c335-4d64-94aa-a60851b73ee6","to":"protected-test-K4mG1HKDDCd5HkCA8lXy5@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250337551,"env":"test","module":"auth-routes","userId":"76765948-423f-4930-a090-3e0cd8a7461a","email":"protected-test-K4mG1HKDDCd5HkCA8lXy5@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mDELETE Protected Routes[2m > [22m[2mshould reject DELETE without Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250337848,"env":"test","module":"user-credentials-repository","userId":"b6760932-8915-4019-bdc6-07c44545a356","msg":"User credentials created"}
{"level":30,"time":1768250337949,"env":"test","module":"email-queue","jobId":"5e66c1bb-6bb2-470b-a3f3-b57496708245","to":"middleware-test-yxVLaJ4_PaO8BF4q94wXf@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250337996,"env":"test","module":"auth-routes","userId":"b6760932-8915-4019-bdc6-07c44545a356","email":"middleware-test-yxVLaJ4_PaO8BF4q94wXf@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould proceed anonymously if no auth provided
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250338156,"env":"test","module":"auth-routes","userId":"76765948-423f-4930-a090-3e0cd8a7461a","msg":"User logged in successfully"}
{"level":30,"time":1768250338203,"env":"test","module":"audit-log-service","userId":"76765948-423f-4930-a090-3e0cd8a7461a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250338206,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768250338362,"env":"test","module":"auth-middleware","error":{"name":"TokenExpiredError","code":"AUTH_002","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250338362,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250338506,"env":"test","module":"auth-routes","userId":"b6760932-8915-4019-bdc6-07c44545a356","msg":"User logged in successfully"}
{"level":30,"time":1768250338554,"env":"test","module":"audit-log-service","userId":"b6760932-8915-4019-bdc6-07c44545a356","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250338573,"env":"test","module":"user-credentials-repository","userId":"f8054680-f628-4157-9f4c-26bb1d8215bd","msg":"User credentials created"}
{"level":30,"time":1768250338670,"env":"test","module":"email-queue","jobId":"1cb3aeac-5ca4-4307-9fbd-4db318108143","to":"protected-test-M_deOPbFjN0FR4lDXmp-w@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250338722,"env":"test","module":"auth-routes","userId":"f8054680-f628-4157-9f4c-26bb1d8215bd","email":"protected-test-M_deOPbFjN0FR4lDXmp-w@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPATCH Protected Routes[2m > [22m[2mshould allow PATCH with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250339057,"env":"test","module":"intake-service","runId":"e72274cb-001b-4fbb-bc8e-42fb28e9c9f8","slug":"hybrid-anon-X40wDvktVU6DnqAoHjwUd","msg":"Created intake run"}
{"level":30,"time":1768250339297,"env":"test","module":"user-credentials-repository","userId":"09c3b4e6-88bd-42ca-906b-a42c93f8ad24","msg":"User credentials created"}
{"level":30,"time":1768250339336,"env":"test","module":"auth-routes","userId":"f8054680-f628-4157-9f4c-26bb1d8215bd","msg":"User logged in successfully"}
{"level":30,"time":1768250339386,"env":"test","module":"audit-log-service","userId":"f8054680-f628-4157-9f4c-26bb1d8215bd","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250339400,"env":"test","module":"email-queue","jobId":"48a09e5b-f4b7-43ba-b1dd-e26778c06dd9","to":"jwt-test-xM6SHQI9TftPu77Lz8p_J@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250339426,"env":"test","module":"user-credentials-repository","userId":"b5f7fd8d-2521-4a83-999d-43bcb45b4e8d","msg":"User credentials created"}
{"level":30,"time":1768250339448,"env":"test","module":"auth-routes","userId":"09c3b4e6-88bd-42ca-906b-a42c93f8ad24","email":"jwt-test-xM6SHQI9TftPu77Lz8p_J@example.com","msg":"User registered"}
{"level":30,"time":1768250339531,"env":"test","module":"email-queue","jobId":"bda4ed16-dd44-4d7f-9adf-3ac7b0c25042","to":"middleware-test-LgcjpbvsUuR45Jz2I0jP-@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250339580,"env":"test","module":"auth-routes","userId":"b5f7fd8d-2521-4a83-999d-43bcb45b4e8d","email":"middleware-test-LgcjpbvsUuR45Jz2I0jP-@example.com","msg":"User registered"}
{"level":50,"time":1768250339603,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould proceed anonymously if both JWT and cookie are invalid
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250339968,"env":"test","module":"user-credentials-repository","userId":"61cc6fc4-f302-4bc8-9d20-6ba56ab8133e","msg":"User credentials created"}
{"level":30,"time":1768250340065,"env":"test","module":"email-queue","jobId":"f7b8dc08-d9f0-4f3e-95d2-b3d4de39795c","to":"user1-aixysb-Pq2ifeyV4Zz9IT@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250340090,"env":"test","module":"auth-routes","userId":"b5f7fd8d-2521-4a83-999d-43bcb45b4e8d","msg":"User logged in successfully"}
{"level":30,"time":1768250340113,"env":"test","module":"auth-routes","userId":"61cc6fc4-f302-4bc8-9d20-6ba56ab8133e","email":"user1-aixysb-Pq2ifeyV4Zz9IT@example.com","msg":"User registered"}
{"level":30,"time":1768250340138,"env":"test","module":"audit-log-service","userId":"b5f7fd8d-2521-4a83-999d-43bcb45b4e8d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250340413,"env":"test","module":"user-credentials-repository","userId":"4b75903c-e065-485e-987a-fb3e7bbc80be","msg":"User credentials created"}
{"level":30,"time":1768250340481,"env":"test","module":"user-credentials-repository","userId":"6c4d02ad-8fa9-49d5-8d8e-960653656998","msg":"User credentials created"}
{"level":30,"time":1768250340509,"env":"test","module":"email-queue","jobId":"9d032cde-e615-4cfc-9b2f-1ca550a81ee5","to":"protected-test-IqtMqIEVnJc8xi0Cgwfla@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250340557,"env":"test","module":"auth-routes","userId":"4b75903c-e065-485e-987a-fb3e7bbc80be","email":"protected-test-IqtMqIEVnJc8xi0Cgwfla@example.com","msg":"User registered"}
{"level":30,"time":1768250340581,"env":"test","module":"email-queue","jobId":"e9e3a46e-7f84-4029-8de6-424db820c2ff","to":"user2-PRGL3VZxlWltDGSBuqxEQ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250340630,"env":"test","module":"auth-routes","userId":"6c4d02ad-8fa9-49d5-8d8e-960653656998","email":"user2-PRGL3VZxlWltDGSBuqxEQ@example.com","msg":"User registered"}
{"level":30,"time":1768250340643,"env":"test","module":"intake-service","runId":"e70c1259-342f-49f8-961f-42f4403bf512","slug":"hybrid-invalid-_eDjpiSeRxX5q_Y2o-TIf","msg":"Created intake run"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPATCH Protected Routes[2m > [22m[2mshould reject PATCH without Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250341015,"env":"test","module":"user-credentials-repository","userId":"66c4d673-4c96-4f64-a0ed-c307ef881298","msg":"User credentials created"}
{"level":30,"time":1768250341101,"env":"test","module":"user-credentials-repository","userId":"4f092597-cc07-4106-8047-fdc84e87c559","msg":"User credentials created"}
{"level":30,"time":1768250341116,"env":"test","module":"email-queue","jobId":"024f53c3-63c9-494b-a016-4df3c8e4d74d","to":"middleware-test-ZRwMiIBnIU-Mcc-dlKaD2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250341174,"env":"test","module":"auth-routes","userId":"66c4d673-4c96-4f64-a0ed-c307ef881298","email":"middleware-test-ZRwMiIBnIU-Mcc-dlKaD2@example.com","msg":"User registered"}
{"level":30,"time":1768250341174,"env":"test","module":"auth-routes","userId":"4b75903c-e065-485e-987a-fb3e7bbc80be","msg":"User logged in successfully"}
{"level":30,"time":1768250341206,"env":"test","module":"email-queue","jobId":"c83851b1-f97b-479a-916a-01bf86a70921","to":"jwt-test-kZZRNDYAOCl48vXwrG_Wd@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250341222,"env":"test","module":"audit-log-service","userId":"4b75903c-e065-485e-987a-fb3e7bbc80be","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250341225,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mCookie Strategy Security[2m > [22m[2mshould only allow safe methods for cookie auth
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250341256,"env":"test","module":"auth-routes","userId":"4f092597-cc07-4106-8047-fdc84e87c559","email":"jwt-test-kZZRNDYAOCl48vXwrG_Wd@example.com","msg":"User registered"}
{"level":50,"time":1768250341259,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250341614,"env":"test","module":"user-credentials-repository","userId":"3840e3c2-ae14-41a8-bfa8-8d65106b14cf","msg":"User credentials created"}
{"level":30,"time":1768250341640,"env":"test","module":"user-credentials-repository","userId":"89e5e9f3-4792-4926-b31c-939b9bdfaa6c","msg":"User credentials created"}
{"level":30,"time":1768250341700,"env":"test","module":"auth-routes","userId":"66c4d673-4c96-4f64-a0ed-c307ef881298","msg":"User logged in successfully"}
{"level":30,"time":1768250341709,"env":"test","module":"email-queue","jobId":"6493aa7f-6230-461d-83da-e9c0c1b36b94","to":"protected-test--IipUnKdNSxlWwjVug5wj@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250341743,"env":"test","module":"email-queue","jobId":"ac960719-9125-474d-bd0b-3ed6985b8f16","to":"jwt-test-uuCOXniB3N54s0NmTKm7n@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250341748,"env":"test","module":"audit-log-service","userId":"66c4d673-4c96-4f64-a0ed-c307ef881298","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250341757,"env":"test","module":"auth-routes","userId":"3840e3c2-ae14-41a8-bfa8-8d65106b14cf","email":"protected-test--IipUnKdNSxlWwjVug5wj@example.com","msg":"User registered"}
{"level":30,"time":1768250341791,"env":"test","module":"auth-routes","userId":"89e5e9f3-4792-4926-b31c-939b9bdfaa6c","email":"jwt-test-uuCOXniB3N54s0NmTKm7n@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mHybrid Authentication Strategy[2m > [22m[2mshould allow GET requests with cookie auth only
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle Bearer token with extra spaces
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250341902,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250342284,"env":"test","module":"user-credentials-repository","userId":"9d85812d-cc6d-483f-9df6-247dc52135a8","msg":"User credentials created"}
{"level":30,"time":1768250342319,"env":"test","module":"auth-routes","userId":"89e5e9f3-4792-4926-b31c-939b9bdfaa6c","msg":"User logged in successfully"}
{"level":30,"time":1768250342368,"env":"test","module":"audit-log-service","userId":"89e5e9f3-4792-4926-b31c-939b9bdfaa6c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250342376,"env":"test","module":"auth-routes","userId":"3840e3c2-ae14-41a8-bfa8-8d65106b14cf","msg":"User logged in successfully"}
{"level":30,"time":1768250342383,"env":"test","module":"email-queue","jobId":"806676c8-d263-43c8-9d9c-7b12f6e32416","to":"middleware-test-5FjMNWyAviQeQJzpYafRY@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250342440,"env":"test","module":"auth-routes","userId":"9d85812d-cc6d-483f-9df6-247dc52135a8","email":"middleware-test-5FjMNWyAviQeQJzpYafRY@example.com","msg":"User registered"}
{"level":30,"time":1768250342440,"env":"test","module":"audit-log-service","userId":"3840e3c2-ae14-41a8-bfa8-8d65106b14cf","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768250342445,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250342445,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mCookie Strategy Security[2m > [22m[2mshould ignore cookies when Bearer token present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250342815,"env":"test","module":"user-credentials-repository","userId":"5d80b0cd-b47c-4d0c-8db6-fdef945af5ac","msg":"User credentials created"}
{"level":30,"time":1768250342889,"env":"test","module":"user-credentials-repository","userId":"f6f11c97-d07e-48cc-9013-246cd2b4f32c","msg":"User credentials created"}
{"level":30,"time":1768250342912,"env":"test","module":"email-queue","jobId":"5a192626-e331-44ca-87d2-871c1b0c107a","to":"protected-test-y8B_YXvPI5zt_7RQ9nDB5@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250342947,"env":"test","module":"auth-routes","userId":"9d85812d-cc6d-483f-9df6-247dc52135a8","msg":"User logged in successfully"}
{"level":30,"time":1768250342960,"env":"test","module":"auth-routes","userId":"5d80b0cd-b47c-4d0c-8db6-fdef945af5ac","email":"protected-test-y8B_YXvPI5zt_7RQ9nDB5@example.com","msg":"User registered"}
{"level":30,"time":1768250342987,"env":"test","module":"email-queue","jobId":"04845730-193d-4ba9-8139-668e6cecd7e8","to":"jwt-test-ouZMlZDQ2RuPT5sDApOg1@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250342996,"env":"test","module":"audit-log-service","userId":"9d85812d-cc6d-483f-9df6-247dc52135a8","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250343036,"env":"test","module":"auth-routes","userId":"f6f11c97-d07e-48cc-9013-246cd2b4f32c","email":"jwt-test-ouZMlZDQ2RuPT5sDApOg1@example.com","msg":"User registered"}
{"level":50,"time":1768250343039,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle very long invalid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250343370,"env":"test","module":"user-credentials-repository","userId":"c77851b5-4378-40ad-a9b1-c4efdd8fe194","msg":"User credentials created"}
{"level":30,"time":1768250343465,"env":"test","module":"email-queue","jobId":"78494c14-3c6f-4ed9-9712-30550c5bc19e","to":"cookie-test-YKHa6Bqxdco7_dwlq1lz0@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250343515,"env":"test","module":"auth-routes","userId":"c77851b5-4378-40ad-a9b1-c4efdd8fe194","email":"cookie-test-YKHa6Bqxdco7_dwlq1lz0@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mCookie Strategy Security[2m > [22m[2mshould ignore cookies when Bearer token present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250343573,"env":"test","module":"auth-routes","userId":"5d80b0cd-b47c-4d0c-8db6-fdef945af5ac","msg":"User logged in successfully"}
{"level":30,"time":1768250343621,"env":"test","module":"audit-log-service","userId":"5d80b0cd-b47c-4d0c-8db6-fdef945af5ac","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250343624,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250343995,"env":"test","module":"user-credentials-repository","userId":"7475fb4a-2abe-4f97-894c-e82025e33ace","msg":"User credentials created"}
{"level":30,"time":1768250344019,"env":"test","module":"auth-routes","userId":"c77851b5-4378-40ad-a9b1-c4efdd8fe194","msg":"User logged in successfully"}
{"level":30,"time":1768250344068,"env":"test","module":"audit-log-service","userId":"c77851b5-4378-40ad-a9b1-c4efdd8fe194","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250344097,"env":"test","module":"email-queue","jobId":"a6a8d5bc-31ce-4165-a665-452fb85f5f3b","to":"protected-test-oVHKc4Y66hZ3JT_3bZ_ng@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250344145,"env":"test","module":"auth-routes","userId":"7475fb4a-2abe-4f97-894c-e82025e33ace","email":"protected-test-oVHKc4Y66hZ3JT_3bZ_ng@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle empty Authorization header
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250344330,"env":"test","module":"user-credentials-repository","userId":"a4328e75-fc2e-4c3d-9636-cecf3cd2c74a","msg":"User credentials created"}
{"level":30,"time":1768250344427,"env":"test","module":"email-queue","jobId":"cc74fad3-0dce-4cb5-8dd5-c36aa65823dc","to":"jwt-test-FsmefhuxPPoB-Y3HTl30A@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250344474,"env":"test","module":"auth-routes","userId":"a4328e75-fc2e-4c3d-9636-cecf3cd2c74a","email":"jwt-test-FsmefhuxPPoB-Y3HTl30A@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould refresh access token using refresh token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250344528,"env":"test","module":"user-credentials-repository","userId":"71ce3dd8-b4e5-4b86-8327-1310b0edcd78","msg":"User credentials created"}
{"level":30,"time":1768250344633,"env":"test","module":"email-queue","jobId":"a1d9b769-7d12-49af-bd20-4193cecf66a4","to":"middleware-test-kgmuBfi9jqtcn_iMkwq6L@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250344681,"env":"test","module":"auth-routes","userId":"71ce3dd8-b4e5-4b86-8327-1310b0edcd78","email":"middleware-test-kgmuBfi9jqtcn_iMkwq6L@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mUser Context Attachment[2m > [22m[2mshould attach userId to request
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250344748,"env":"test","module":"auth-routes","userId":"7475fb4a-2abe-4f97-894c-e82025e33ace","msg":"User logged in successfully"}
{"level":30,"time":1768250344796,"env":"test","module":"audit-log-service","userId":"7475fb4a-2abe-4f97-894c-e82025e33ace","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250344799,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250344992,"env":"test","module":"auth-routes","userId":"a4328e75-fc2e-4c3d-9636-cecf3cd2c74a","msg":"User logged in successfully"}
{"level":30,"time":1768250345041,"env":"test","module":"audit-log-service","userId":"a4328e75-fc2e-4c3d-9636-cecf3cd2c74a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250345162,"env":"test","module":"user-credentials-repository","userId":"0f157d98-1d73-4b0a-92af-69e186110b9b","msg":"User credentials created"}
{"level":30,"time":1768250345190,"env":"test","module":"auth-routes","userId":"71ce3dd8-b4e5-4b86-8327-1310b0edcd78","msg":"User logged in successfully"}
{"level":30,"time":1768250345240,"env":"test","module":"audit-log-service","userId":"71ce3dd8-b4e5-4b86-8327-1310b0edcd78","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250345258,"env":"test","module":"email-queue","jobId":"7bf8b526-aacf-44ae-a8ab-1b63df68104d","to":"protected-test-Q-tUKE6j8pPHNHPdDrWLH@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250345305,"env":"test","module":"auth-routes","userId":"0f157d98-1d73-4b0a-92af-69e186110b9b","email":"protected-test-Q-tUKE6j8pPHNHPdDrWLH@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle Authorization header with only Bearer
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250345710,"env":"test","module":"user-credentials-repository","userId":"556d08f9-73a6-414b-8d46-f193aad42d70","msg":"User credentials created"}
{"level":30,"time":1768250345812,"env":"test","module":"email-queue","jobId":"db8240ff-cd2c-472e-b668-b42f92ce3812","to":"middleware-test-Ub-VNaWDU9ej8pY4OQxMw@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250345867,"env":"test","module":"auth-routes","userId":"556d08f9-73a6-414b-8d46-f193aad42d70","email":"middleware-test-Ub-VNaWDU9ej8pY4OQxMw@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mUser Context Attachment[2m > [22m[2mshould attach userEmail to request
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250345922,"env":"test","module":"auth-routes","userId":"0f157d98-1d73-4b0a-92af-69e186110b9b","msg":"User logged in successfully"}
{"level":30,"time":1768250345974,"env":"test","module":"audit-log-service","userId":"0f157d98-1d73-4b0a-92af-69e186110b9b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250345977,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250346045,"env":"test","module":"auth-service","tokenHash":"1bfe2844172bdc1f4cd1dfc76be35b7b68ea9b742d051cb3037f3dbf231ae351","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250346357,"env":"test","module":"user-credentials-repository","userId":"c9ee3176-cfc7-4fa4-9e7b-4c59b6bde15a","msg":"User credentials created"}
{"level":30,"time":1768250346374,"env":"test","module":"auth-routes","userId":"556d08f9-73a6-414b-8d46-f193aad42d70","msg":"User logged in successfully"}
{"level":30,"time":1768250346422,"env":"test","module":"audit-log-service","userId":"556d08f9-73a6-414b-8d46-f193aad42d70","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250346451,"env":"test","module":"email-queue","jobId":"a767cc69-dbea-4ceb-82a2-dc75fa8022d6","to":"protected-test-CKj6oWi5T8hWiaplV0yxT@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250346499,"env":"test","module":"auth-routes","userId":"c9ee3176-cfc7-4fa4-9e7b-4c59b6bde15a","email":"protected-test-CKj6oWi5T8hWiaplV0yxT@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle multiple Authorization headers
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250346613,"env":"test","module":"user-credentials-repository","userId":"965853c0-2039-41e4-a133-eda7b0143de5","msg":"User credentials created"}
{"level":30,"time":1768250346717,"env":"test","module":"email-queue","jobId":"514464e1-b69b-4fba-abef-d1279cd9a7ef","to":"jwt-test-JJ0R6KUY2pPowMJ5Qb0aR@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250346769,"env":"test","module":"auth-routes","userId":"965853c0-2039-41e4-a133-eda7b0143de5","email":"jwt-test-JJ0R6KUY2pPowMJ5Qb0aR@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould rotate refresh token on use
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250346884,"env":"test","module":"user-credentials-repository","userId":"6870fa8e-9617-4966-b3bf-c398a5c339fd","msg":"User credentials created"}
{"level":30,"time":1768250346986,"env":"test","module":"email-queue","jobId":"b1248f95-e6e1-433a-abe9-737753043f3c","to":"middleware-test-iskHUXCMDVGvVP2QPBFeL@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250347036,"env":"test","module":"auth-routes","userId":"6870fa8e-9617-4966-b3bf-c398a5c339fd","email":"middleware-test-iskHUXCMDVGvVP2QPBFeL@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould return consistent error format for missing token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250347120,"env":"test","module":"auth-routes","userId":"c9ee3176-cfc7-4fa4-9e7b-4c59b6bde15a","msg":"User logged in successfully"}
{"level":30,"time":1768250347169,"env":"test","module":"audit-log-service","userId":"c9ee3176-cfc7-4fa4-9e7b-4c59b6bde15a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250347172,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250347290,"env":"test","module":"auth-routes","userId":"965853c0-2039-41e4-a133-eda7b0143de5","msg":"User logged in successfully"}
{"level":30,"time":1768250347339,"env":"test","module":"audit-log-service","userId":"965853c0-2039-41e4-a133-eda7b0143de5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250347342,"env":"test","module":"auth-service","tokenHash":"d7130c3d21a4325ef35f35580a778ce15df1f3118abdbfca91fbe77d739fad6f","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250347542,"env":"test","module":"user-credentials-repository","userId":"288b8be3-b785-4810-bf0a-85c40db0505e","msg":"User credentials created"}
{"level":30,"time":1768250347551,"env":"test","module":"auth-service","tokenHash":"d7130c3d21a4325ef35f35580a778ce15df1f3118abdbfca91fbe77d739fad6f","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250347555,"env":"test","module":"auth-routes","userId":"6870fa8e-9617-4966-b3bf-c398a5c339fd","msg":"User logged in successfully"}
{"level":40,"time":1768250347601,"env":"test","module":"auth-service","userId":"965853c0-2039-41e4-a133-eda7b0143de5","tokenHash":"d7130c3d21a4325ef35f35580a778ce15df1f3118abdbfca91fbe77d739fad6f","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250347607,"env":"test","module":"audit-log-service","userId":"6870fa8e-9617-4966-b3bf-c398a5c339fd","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250347610,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250347642,"env":"test","module":"email-queue","jobId":"b4f7132a-bfa5-458c-adb5-cc7c7e2f3302","to":"protected-test-avOBlPzsitc0NLSLB5Sel@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250347659,"env":"test","module":"auth-service","tokenHash":"b856d54d9c7a42eac5fd576f90a65588e640c322fe13fbaab811edc39aab3710","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250347690,"env":"test","module":"auth-routes","userId":"288b8be3-b785-4810-bf0a-85c40db0505e","email":"protected-test-avOBlPzsitc0NLSLB5Sel@example.com","msg":"User registered"}
{"level":40,"time":1768250347706,"env":"test","module":"auth-service","userId":"965853c0-2039-41e4-a133-eda7b0143de5","tokenHash":"b856d54d9c7a42eac5fd576f90a65588e640c322fe13fbaab811edc39aab3710","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould reject token with SQL injection attempt
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250347977,"env":"test","module":"user-credentials-repository","userId":"a403d1e1-a9dc-49a2-9861-d2b39e7b60b1","msg":"User credentials created"}
{"level":30,"time":1768250348080,"env":"test","module":"email-queue","jobId":"957be754-1d43-43d0-bc35-2d27f158d7b2","to":"middleware-test-Rqq1zCbowBPivJBjKmuvW@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250348126,"env":"test","module":"user-credentials-repository","userId":"c9142914-ab5c-4391-8bcc-aee97902548e","msg":"User credentials created"}
{"level":30,"time":1768250348132,"env":"test","module":"auth-routes","userId":"a403d1e1-a9dc-49a2-9861-d2b39e7b60b1","email":"middleware-test-Rqq1zCbowBPivJBjKmuvW@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould return consistent error format for invalid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250348222,"env":"test","module":"email-queue","jobId":"5ae0bd3e-e02b-42cb-990a-07932255acf6","to":"jwt-test-LW2-WzBPlHdPz5jAKBsCO@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250348272,"env":"test","module":"auth-routes","userId":"c9142914-ab5c-4391-8bcc-aee97902548e","email":"jwt-test-LW2-WzBPlHdPz5jAKBsCO@example.com","msg":"User registered"}
{"level":30,"time":1768250348293,"env":"test","module":"auth-routes","userId":"288b8be3-b785-4810-bf0a-85c40db0505e","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould detect token reuse and revoke all user tokens
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250348342,"env":"test","module":"audit-log-service","userId":"288b8be3-b785-4810-bf0a-85c40db0505e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250348345,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250348641,"env":"test","module":"auth-routes","userId":"a403d1e1-a9dc-49a2-9861-d2b39e7b60b1","msg":"User logged in successfully"}
{"level":30,"time":1768250348692,"env":"test","module":"audit-log-service","userId":"a403d1e1-a9dc-49a2-9861-d2b39e7b60b1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250348695,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250348713,"env":"test","module":"user-credentials-repository","userId":"c3d7bd07-2064-4f3c-8c1b-3ce1459b4ccf","msg":"User credentials created"}
{"level":30,"time":1768250348796,"env":"test","module":"auth-routes","userId":"c9142914-ab5c-4391-8bcc-aee97902548e","msg":"User logged in successfully"}
{"level":30,"time":1768250348812,"env":"test","module":"email-queue","jobId":"9ca7a57f-0e11-4f42-9201-235b0fbbacf5","to":"protected-test-v2HV_T67QFcbynvoAGGSD@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250348846,"env":"test","module":"audit-log-service","userId":"c9142914-ab5c-4391-8bcc-aee97902548e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould detect token reuse and revoke all user tokens
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250348861,"env":"test","module":"auth-routes","userId":"c3d7bd07-2064-4f3c-8c1b-3ce1459b4ccf","email":"protected-test-v2HV_T67QFcbynvoAGGSD@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould reject token with XSS attempt
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250349062,"env":"test","module":"user-credentials-repository","userId":"b914e32d-130d-4981-bf0d-4d3e3cc5e097","msg":"User credentials created"}
{"level":30,"time":1768250349163,"env":"test","module":"email-queue","jobId":"215f0221-000c-4a9e-a256-5e65259a3ee9","to":"middleware-test-LLpGSyFa9G-3J-2nYi2Wl@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250349214,"env":"test","module":"auth-routes","userId":"b914e32d-130d-4981-bf0d-4d3e3cc5e097","email":"middleware-test-LLpGSyFa9G-3J-2nYi2Wl@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould return consistent error format for expired token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250349326,"env":"test","module":"auth-routes","userId":"c9142914-ab5c-4391-8bcc-aee97902548e","msg":"User logged in successfully"}
{"level":30,"time":1768250349374,"env":"test","module":"audit-log-service","userId":"c9142914-ab5c-4391-8bcc-aee97902548e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250349376,"env":"test","module":"auth-service","tokenHash":"5c3a3038482e4427760687185e66d3c532737cd95a83d7936f83dba0f882376f","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250349486,"env":"test","module":"auth-routes","userId":"c3d7bd07-2064-4f3c-8c1b-3ce1459b4ccf","msg":"User logged in successfully"}
{"level":30,"time":1768250349536,"env":"test","module":"audit-log-service","userId":"c3d7bd07-2064-4f3c-8c1b-3ce1459b4ccf","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250349540,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250349584,"env":"test","module":"auth-service","tokenHash":"5c3a3038482e4427760687185e66d3c532737cd95a83d7936f83dba0f882376f","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250349631,"env":"test","module":"auth-service","userId":"c9142914-ab5c-4391-8bcc-aee97902548e","tokenHash":"5c3a3038482e4427760687185e66d3c532737cd95a83d7936f83dba0f882376f","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250349689,"env":"test","module":"auth-service","tokenHash":"2bf22ade0ab67fc52fd6c6ca96bb41e8f0a473fa89f18f2b0a74306f65bd363b","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250349722,"env":"test","module":"auth-routes","userId":"b914e32d-130d-4981-bf0d-4d3e3cc5e097","msg":"User logged in successfully"}
{"level":40,"time":1768250349740,"env":"test","module":"auth-service","userId":"c9142914-ab5c-4391-8bcc-aee97902548e","tokenHash":"2bf22ade0ab67fc52fd6c6ca96bb41e8f0a473fa89f18f2b0a74306f65bd363b","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250349783,"env":"test","module":"audit-log-service","userId":"b914e32d-130d-4981-bf0d-4d3e3cc5e097","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250349915,"env":"test","module":"user-credentials-repository","userId":"c4e13ab1-054a-49a9-815a-5152c1f0317f","msg":"User credentials created"}
{"level":30,"time":1768250350010,"env":"test","module":"email-queue","jobId":"ee8fb174-684c-489f-8b5e-9372b9b87237","to":"protected-test-Zi4frno_V6MxCt7XI68C2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250350058,"env":"test","module":"auth-routes","userId":"c4e13ab1-054a-49a9-815a-5152c1f0317f","email":"protected-test-Zi4frno_V6MxCt7XI68C2@example.com","msg":"User registered"}
{"level":30,"time":1768250350151,"env":"test","module":"user-credentials-repository","userId":"03c8af67-4904-44f7-89c7-720e1775daff","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Payload Validation[2m > [22m[2mshould reject token with missing userId
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250350249,"env":"test","module":"email-queue","jobId":"cc3becca-09ab-4c17-a0ad-982399019c0d","to":"jwt-test-cWdzawoiacuMgz6yY8BgV@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250350297,"env":"test","module":"auth-routes","userId":"03c8af67-4904-44f7-89c7-720e1775daff","email":"jwt-test-cWdzawoiacuMgz6yY8BgV@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mLogout Flow[2m > [22m[2mshould revoke refresh token on logout
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250350667,"env":"test","module":"auth-routes","userId":"c4e13ab1-054a-49a9-815a-5152c1f0317f","msg":"User logged in successfully"}
{"level":30,"time":1768250350716,"env":"test","module":"audit-log-service","userId":"c4e13ab1-054a-49a9-815a-5152c1f0317f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250350806,"env":"test","module":"auth-routes","userId":"03c8af67-4904-44f7-89c7-720e1775daff","msg":"User logged in successfully"}
{"level":30,"time":1768250350856,"env":"test","module":"audit-log-service","userId":"03c8af67-4904-44f7-89c7-720e1775daff","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768250350887,"env":"test","module":"auth-middleware","error":{"name":"TokenExpiredError","code":"AUTH_002","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250350888,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250350909,"env":"test","module":"auth-service","tokenHash":"9b6ece29945532f5e7089d68f5de9221f02d2c0478c3697ebb8cf61c26e699a9","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250350962,"env":"test","module":"auth-service","userId":"03c8af67-4904-44f7-89c7-720e1775daff","tokenHash":"9b6ece29945532f5e7089d68f5de9221f02d2c0478c3697ebb8cf61c26e699a9","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250351092,"env":"test","module":"user-credentials-repository","userId":"4851a118-3152-4a44-93e0-8896db325b73","msg":"User credentials created"}
{"level":30,"time":1768250351193,"env":"test","module":"email-queue","jobId":"97e18952-f457-4b30-9e8c-a348fd86a961","to":"protected-test-gyNB7QSu1ugM8GrQ7m66k@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250351243,"env":"test","module":"auth-routes","userId":"4851a118-3152-4a44-93e0-8896db325b73","email":"protected-test-gyNB7QSu1ugM8GrQ7m66k@example.com","msg":"User registered"}
{"level":30,"time":1768250351255,"env":"test","module":"user-credentials-repository","userId":"817f6332-8a30-404f-b1e8-71648aaee8b4","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Payload Validation[2m > [22m[2mshould reject token with non-existent userId
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250351351,"env":"test","module":"email-queue","jobId":"c554ef71-2b4b-4d47-bb7b-417f2077d5c0","to":"middleware-test-KOqTUb7gDW65gODJfIpvR@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250351381,"env":"test","module":"user-credentials-repository","userId":"939fa3be-6eb4-45a8-912c-1678c1f3854c","msg":"User credentials created"}
{"level":30,"time":1768250351405,"env":"test","module":"auth-routes","userId":"817f6332-8a30-404f-b1e8-71648aaee8b4","email":"middleware-test-KOqTUb7gDW65gODJfIpvR@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould handle malformed JWT gracefully
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250351481,"env":"test","module":"email-queue","jobId":"31f94b28-1487-412c-9b94-cccb3e5e4d1a","to":"jwt-test-zXYDjgDIq5CWUrtn2JCC5@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250351530,"env":"test","module":"auth-routes","userId":"939fa3be-6eb4-45a8-912c-1678c1f3854c","email":"jwt-test-zXYDjgDIq5CWUrtn2JCC5@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mLogout Flow[2m > [22m[2mshould clear refresh token cookie on logout
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250351872,"env":"test","module":"auth-routes","userId":"4851a118-3152-4a44-93e0-8896db325b73","msg":"User logged in successfully"}
{"level":30,"time":1768250351924,"env":"test","module":"audit-log-service","userId":"4851a118-3152-4a44-93e0-8896db325b73","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250351929,"env":"test","module":"auth-routes","userId":"817f6332-8a30-404f-b1e8-71648aaee8b4","msg":"User logged in successfully"}
{"level":30,"time":1768250351983,"env":"test","module":"audit-log-service","userId":"817f6332-8a30-404f-b1e8-71648aaee8b4","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768250351986,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250351986,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250352048,"env":"test","module":"auth-routes","userId":"939fa3be-6eb4-45a8-912c-1678c1f3854c","msg":"User logged in successfully"}
{"level":30,"time":1768250352103,"env":"test","module":"audit-log-service","userId":"939fa3be-6eb4-45a8-912c-1678c1f3854c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250352365,"env":"test","module":"user-credentials-repository","userId":"83b1a9ec-c1fb-4b50-a684-69f071212edf","msg":"User credentials created"}
{"level":30,"time":1768250352407,"env":"test","module":"user-credentials-repository","userId":"1af159a1-54da-45dd-b352-7a693ee7596e","msg":"User credentials created"}
{"level":30,"time":1768250352429,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250352429,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768250352480,"env":"test","module":"email-queue","jobId":"bb36eee2-a680-4b95-b981-28bcad49f113","to":"middleware-test-cRSA9KQBGMc_7G24nVawU@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250352511,"env":"test","module":"email-queue","jobId":"a6022320-7c50-4b8d-8211-a07cb1b3b8bf","to":"protected-test-se-Fsx_xG-Y1_WcE4eDNY@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250352534,"env":"test","module":"auth-routes","userId":"83b1a9ec-c1fb-4b50-a684-69f071212edf","email":"middleware-test-cRSA9KQBGMc_7G24nVawU@example.com","msg":"User registered"}
{"level":30,"time":1768250352561,"env":"test","module":"auth-routes","userId":"1af159a1-54da-45dd-b352-7a693ee7596e","email":"protected-test-se-Fsx_xG-Y1_WcE4eDNY@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould handle JWT with wrong algorithm
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mCross-User Authorization[2m > [22m[2mshould not allow user to access another user's resources
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w7_f64aaaae

 [32mÎ“Â£Ã´[39m tests/integration/auth/jwt.authentication.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 86101[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should generate valid JWT token on successful login [33m 1206[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should include correct payload in JWT token [33m 1077[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set JWT expiry to 15 minutes [33m 1111[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should accept valid JWT token on protected routes [33m 1215[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should accept request with missing Bearer prefix (lenient) [33m 1226[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject expired JWT token [33m 1105[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return token_expired error code for expired tokens [33m 1103[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should exchange valid session cookie for JWT token [33m 680[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prefer Bearer token over cookie when both present [33m 1125[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should fall back to cookie if Bearer token is invalid [33m 531[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow GET requests with cookie auth only [33m 1259[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject POST requests with cookie auth only (mutation-strict) [33m 520[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow anonymous access to public workflows [33m 455[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should attach user info if authenticated on optional auth routes [33m 467[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should refresh access token using refresh token [33m 2283[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should rotate refresh token on use [33m 1513[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should detect token reuse and revoke all user tokens [33m 2032[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke refresh token on logout [33m 1224[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should clear refresh token cookie on logout [33m 1144[2mms[22m[39m
{"level":30,"time":1768250353040,"env":"test","module":"auth-routes","userId":"83b1a9ec-c1fb-4b50-a684-69f071212edf","msg":"User logged in successfully"}
{"level":30,"time":1768250353094,"env":"test","module":"audit-log-service","userId":"83b1a9ec-c1fb-4b50-a684-69f071212edf","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768250353097,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250353097,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250353202,"env":"test","module":"auth-routes","userId":"1af159a1-54da-45dd-b352-7a693ee7596e","msg":"User logged in successfully"}
{"level":30,"time":1768250353255,"env":"test","module":"audit-log-service","userId":"1af159a1-54da-45dd-b352-7a693ee7596e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250353373,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250353374,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768250353615,"env":"test","module":"user-credentials-repository","userId":"ed22dd2a-a00e-4cfe-835e-94238c5126fa","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w1_abf93980

{"level":30,"time":1768250353712,"env":"test","module":"email-queue","jobId":"f95586b9-95d7-451e-ba42-9bb74a25d8ca","to":"user2-dCbQcapXE1pDhmrcseTBH@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250353760,"env":"test","module":"auth-routes","userId":"ed22dd2a-a00e-4cfe-835e-94238c5126fa","email":"user2-dCbQcapXE1pDhmrcseTBH@example.com","msg":"User registered"}
 [31mÎ“Â¥Â»[39m tests/integration/auth/auth.middleware.integration.test.ts [2m([22m[2m27 tests[22m[2m | [22m[31m5 failed[39m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 87030[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow access with valid JWT Bearer token [33m 1222[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 401 when no token provided[39m[33m 946[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 with invalid token [33m 1093[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 401 with expired token[39m[33m 933[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should proceed without authentication if no token provided
[31m       [31mâ”œÃ¹[31m should authenticate with JWT Bearer token[39m[33m 915[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should authenticate with refresh token cookie (GET only)[39m[33m 942[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject cookie auth for POST requests (mutation-strict)[39m[33m 934[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject cookie auth for PUT requests [33m 1113[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject cookie auth for DELETE requests [33m 1112[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow cookie auth for HEAD requests [33m 1257[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prioritize JWT over cookie when both present [33m 2267[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 when no auth provided [33m 1105[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 when both JWT and cookie are invalid [33m 1123[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should authenticate with JWT if provided [33m 1681[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should authenticate with cookie if JWT not provided [33m 1609[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should proceed anonymously if no auth provided [33m 1573[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should proceed anonymously if both JWT and cookie are invalid [33m 1586[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should only allow safe methods for cookie auth [33m 1259[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should ignore cookies when Bearer token present [33m 2265[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should attach userId to request [33m 1174[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should attach userEmail to request [33m 1180[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return consistent error format for missing token [33m 1089[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return consistent error format for invalid token [33m 1084[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return consistent error format for expired token [33m 2194[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle malformed JWT gracefully [33m 1098[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle JWT with wrong algorithm [33m 1111[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mCross-User Authorization[2m > [22m[2mshould not allow user to access another user's resources
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250354317,"env":"test","module":"auth-routes","userId":"ed22dd2a-a00e-4cfe-835e-94238c5126fa","msg":"User logged in successfully"}
{"level":30,"time":1768250354364,"env":"test","module":"audit-log-service","userId":"ed22dd2a-a00e-4cfe-835e-94238c5126fa","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768250354418,"env":"test","module":"rbac-middleware","userId":"ed22dd2a-a00e-4cfe-835e-94238c5126fa","userRole":"viewer","permission":"project:delete","path":"/cd301e65-b443-444c-8f8d-85bb5fc2f719","msg":"Permission denied"}
{"level":30,"time":1768250354787,"env":"test","module":"user-credentials-repository","userId":"d08f29fc-847a-4b8f-85a0-4d8b73db55cc","msg":"User credentials created"}
{"level":30,"time":1768250354890,"env":"test","module":"email-queue","jobId":"1b2e6e5f-f354-4b9a-8e6c-23a4e7a1f640","to":"protected-test-Zoh1lyYAHjamw-GT2t4t-@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250354938,"env":"test","module":"auth-routes","userId":"d08f29fc-847a-4b8f-85a0-4d8b73db55cc","email":"protected-test-Zoh1lyYAHjamw-GT2t4t-@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mUser Context Injection[2m > [22m[2mshould inject userId into request context
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250355560,"env":"test","module":"auth-routes","userId":"d08f29fc-847a-4b8f-85a0-4d8b73db55cc","msg":"User logged in successfully"}
{"level":30,"time":1768250355608,"env":"test","module":"audit-log-service","userId":"d08f29fc-847a-4b8f-85a0-4d8b73db55cc","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250356027,"env":"test","module":"user-credentials-repository","userId":"9db142b2-4e7c-440d-be88-214be7cf0f3f","msg":"User credentials created"}
{"level":30,"time":1768250356122,"env":"test","module":"email-queue","jobId":"de3053c6-9e9b-46a7-aefd-70695f6e4d00","to":"protected-test-33KiRaQG6RhGT6ETE6nx8@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250356170,"env":"test","module":"auth-routes","userId":"9db142b2-4e7c-440d-be88-214be7cf0f3f","email":"protected-test-33KiRaQG6RhGT6ETE6nx8@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mUser Context Injection[2m > [22m[2mshould inject tenantId into request context
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250356793,"env":"test","module":"auth-routes","userId":"9db142b2-4e7c-440d-be88-214be7cf0f3f","msg":"User logged in successfully"}
{"level":30,"time":1768250356840,"env":"test","module":"audit-log-service","userId":"9db142b2-4e7c-440d-be88-214be7cf0f3f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250357251,"env":"test","module":"user-credentials-repository","userId":"4f978ffb-ac32-4c64-a653-aff135f88678","msg":"User credentials created"}
{"level":30,"time":1768250357347,"env":"test","module":"email-queue","jobId":"f509bec8-0f7d-41eb-aa1e-40c0300a7522","to":"protected-test-jobYY_A1LtVVaQ7gvme2S@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250357396,"env":"test","module":"auth-routes","userId":"4f978ffb-ac32-4c64-a653-aff135f88678","email":"protected-test-jobYY_A1LtVVaQ7gvme2S@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mUser Context Injection[2m > [22m[2mshould inject role into request context
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250358007,"env":"test","module":"auth-routes","userId":"4f978ffb-ac32-4c64-a653-aff135f88678","msg":"User logged in successfully"}
{"level":30,"time":1768250358055,"env":"test","module":"audit-log-service","userId":"4f978ffb-ac32-4c64-a653-aff135f88678","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250358464,"env":"test","module":"user-credentials-repository","userId":"243479ab-6ff6-49c8-99ca-de5dfe289dfe","msg":"User credentials created"}
{"level":30,"time":1768250358563,"env":"test","module":"email-queue","jobId":"83a29378-bf42-43d7-ab00-9f51a6190a21","to":"protected-test-4Ma2XB5QKsbw6YUtxdbWY@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250358611,"env":"test","module":"auth-routes","userId":"243479ab-6ff6-49c8-99ca-de5dfe289dfe","email":"protected-test-4Ma2XB5QKsbw6YUtxdbWY@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mRate Limiting on Protected Routes[2m > [22m[2mshould not apply general rate limiting to authenticated requests
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250359217,"env":"test","module":"auth-routes","userId":"243479ab-6ff6-49c8-99ca-de5dfe289dfe","msg":"User logged in successfully"}
{"level":30,"time":1768250359266,"env":"test","module":"audit-log-service","userId":"243479ab-6ff6-49c8-99ca-de5dfe289dfe","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250360080,"env":"test","module":"user-credentials-repository","userId":"f158d6f0-2061-4218-9e87-4249d5e4f734","msg":"User credentials created"}
{"level":30,"time":1768250360175,"env":"test","module":"email-queue","jobId":"f1090a57-d079-4d34-a4b4-a58789d44bbb","to":"protected-test-iMFKeEDboBLOxVvz4zPDv@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250360222,"env":"test","module":"auth-routes","userId":"f158d6f0-2061-4218-9e87-4249d5e4f734","email":"protected-test-iMFKeEDboBLOxVvz4zPDv@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould handle request with both Bearer token and cookies
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250360830,"env":"test","module":"auth-routes","userId":"f158d6f0-2061-4218-9e87-4249d5e4f734","msg":"User logged in successfully"}
{"level":30,"time":1768250360877,"env":"test","module":"audit-log-service","userId":"f158d6f0-2061-4218-9e87-4249d5e4f734","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould handle request with both Bearer token and cookies
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250361382,"env":"test","module":"auth-routes","userId":"f158d6f0-2061-4218-9e87-4249d5e4f734","msg":"User logged in successfully"}
{"level":30,"time":1768250361432,"env":"test","module":"audit-log-service","userId":"f158d6f0-2061-4218-9e87-4249d5e4f734","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250361841,"env":"test","module":"user-credentials-repository","userId":"ebdf7964-e6e8-4d02-8371-b3a4ae6809d9","msg":"User credentials created"}
{"level":30,"time":1768250361935,"env":"test","module":"email-queue","jobId":"06079719-4c87-4531-b8e0-8d67f0247454","to":"protected-test--Mvy8Jn_3ciX2neuwgKWa@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250361982,"env":"test","module":"auth-routes","userId":"ebdf7964-e6e8-4d02-8371-b3a4ae6809d9","email":"protected-test--Mvy8Jn_3ciX2neuwgKWa@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould prioritize Bearer token over cookie when both present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250362582,"env":"test","module":"auth-routes","userId":"ebdf7964-e6e8-4d02-8371-b3a4ae6809d9","msg":"User logged in successfully"}
{"level":30,"time":1768250362628,"env":"test","module":"audit-log-service","userId":"ebdf7964-e6e8-4d02-8371-b3a4ae6809d9","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould prioritize Bearer token over cookie when both present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250363134,"env":"test","module":"auth-routes","userId":"ebdf7964-e6e8-4d02-8371-b3a4ae6809d9","msg":"User logged in successfully"}
{"level":30,"time":1768250363181,"env":"test","module":"audit-log-service","userId":"ebdf7964-e6e8-4d02-8371-b3a4ae6809d9","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250363538,"env":"test","module":"user-credentials-repository","userId":"0da78eec-5d1b-484d-86ff-b3a5f6dc47d8","msg":"User credentials created"}
{"level":30,"time":1768250363633,"env":"test","module":"email-queue","jobId":"72fb0eee-330e-40e2-935e-c66b23f6e338","to":"user2-tsveiUvCtbfh1D-R7Dk5J@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250363687,"env":"test","module":"auth-routes","userId":"0da78eec-5d1b-484d-86ff-b3a5f6dc47d8","email":"user2-tsveiUvCtbfh1D-R7Dk5J@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould prioritize Bearer token over cookie when both present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250364182,"env":"test","module":"auth-routes","userId":"0da78eec-5d1b-484d-86ff-b3a5f6dc47d8","msg":"User logged in successfully"}
{"level":30,"time":1768250364229,"env":"test","module":"audit-log-service","userId":"0da78eec-5d1b-484d-86ff-b3a5f6dc47d8","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250364684,"env":"test","module":"user-credentials-repository","userId":"b93b57df-c80d-4631-abd9-83b1b9204a4c","msg":"User credentials created"}
{"level":30,"time":1768250364782,"env":"test","module":"email-queue","jobId":"ed529b18-475e-46b5-ad34-41dc101b87af","to":"protected-test-GXkHypg-4KQfG6wu7-tO0@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250364828,"env":"test","module":"auth-routes","userId":"b93b57df-c80d-4631-abd9-83b1b9204a4c","email":"protected-test-GXkHypg-4KQfG6wu7-tO0@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mOptional Auth Routes[2m > [22m[2mshould allow unauthenticated access to optional auth routes
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250365423,"env":"test","module":"auth-routes","userId":"b93b57df-c80d-4631-abd9-83b1b9204a4c","msg":"User logged in successfully"}
{"level":30,"time":1768250365477,"env":"test","module":"audit-log-service","userId":"b93b57df-c80d-4631-abd9-83b1b9204a4c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250365986,"env":"test","module":"intake-service","runId":"bff07cd5-6a7b-402d-a052-b7176b6ed0c2","slug":"public-Q1DnjCee7mAAX0Z_gWa3B","msg":"Created intake run"}
{"level":30,"time":1768250366403,"env":"test","module":"user-credentials-repository","userId":"95e0926d-3497-4d71-872f-929b31dc2cc6","msg":"User credentials created"}
{"level":30,"time":1768250366501,"env":"test","module":"email-queue","jobId":"bff8d4bc-abdb-4839-a1e1-a0fd5ac879cf","to":"protected-test-3jUn_Uy6d2Tn8QBwpR-Ku@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250366548,"env":"test","module":"auth-routes","userId":"95e0926d-3497-4d71-872f-929b31dc2cc6","email":"protected-test-3jUn_Uy6d2Tn8QBwpR-Ku@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mOptional Auth Routes[2m > [22m[2mshould enhance optional auth routes with user context when authenticated
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250367146,"env":"test","module":"auth-routes","userId":"95e0926d-3497-4d71-872f-929b31dc2cc6","msg":"User logged in successfully"}
{"level":30,"time":1768250367195,"env":"test","module":"audit-log-service","userId":"95e0926d-3497-4d71-872f-929b31dc2cc6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250367692,"env":"test","module":"intake-service","runId":"6a293b66-0882-41e1-95ab-ee7b84d2bf2b","slug":"optional-N8BfKfW_5NpjHJXXYS0j_","userId":"95e0926d-3497-4d71-872f-929b31dc2cc6","msg":"Created intake run"}
{"level":30,"time":1768250368180,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250368181,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w0_edb5b18d

 [31mÎ“Â¥Â»[39m tests/integration/auth/protected.routes.test.ts [2m([22m[2m33 tests[22m[2m | [22m[31m4 failed[39m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 101832[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow access with valid Bearer token[39m[33m 907[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject access without Authorization header[39m[33m 876[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject access with empty Bearer token [33m 1225[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject access with malformed Authorization header[39m[33m 868[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject access with wrong token type[39m[33m 893[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow POST with valid Bearer token [33m 1244[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject POST without Bearer token [33m 1197[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject POST with invalid token [33m 1206[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow PUT with valid Bearer token [33m 1379[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject PUT without Bearer token [33m 1207[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow DELETE with valid Bearer token [33m 1361[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject DELETE without Bearer token [33m 1157[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow PATCH with valid Bearer token [33m 1841[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject PATCH without Bearer token [33m 1178[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle Bearer token with extra spaces [33m 1220[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should handle token with newlines
       [33m[2mÎ“Â£Ã´[22m[39m should handle very long invalid token [33m 1179[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle empty Authorization header [33m 1174[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle Authorization header with only Bearer [33m 1178[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle multiple Authorization headers [33m 1196[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject token with SQL injection attempt [33m 1171[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject token with XSS attempt [33m 1195[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject token with missing userId [33m 1179[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject token with non-existent userId [33m 1305[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not allow user to access another user's resources [33m 2394[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should inject userId into request context [33m 1244[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should inject tenantId into request context [33m 1230[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should inject role into request context [33m 1214[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not apply general rate limiting to authenticated requests [33m 1598[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle request with both Bearer token and cookies [33m 1776[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prioritize Bearer token over cookie when both present [33m 2846[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow unauthenticated access to optional auth routes [33m 1708[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should enhance optional auth routes with user context when authenticated [33m 1755[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 41 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
AssertionError: expected 401 to be 423 // Object.is equality

- Expected
+ Received

- 423
+ 401

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:110:36
    108|         });
    109| 
    110|       expect(lockedAttempt.status).toBe(423);
       |                                    ^
    111|       expect(lockedAttempt.body.message || lockedAttempt.body.error).tÎ“Ã‡Âª
    112| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/41]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should record all login attempts
AssertionError: expected 2 to be 3 // Object.is equality

- Expected
+ Received

- 3
+ 2

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:145:31
    143|       });
    144| 
    145|       expect(attempts.length).toBe(3);
       |                               ^
    146|       expect(attempts.filter(a => !a.successful).length).toBe(2);
    147|       expect(attempts.filter(a => a.successful).length).toBe(1);

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/41]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > MFA Enrollment and Login Flow > should complete MFA setup and login with TOTP
AssertionError: expected undefined to be defined
 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:182:25
    180|       });
    181| 
    182|       expect(mfaSecret).toBeDefined();
       |                         ^
    183|       expect(mfaSecret!.enabled).toBe(false); // Not enabled until verÎ“Ã‡Âª
    184| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/41]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > MFA Enrollment and Login Flow > should login with backup code when TOTP unavailable
TypeError: Cannot read properties of undefined (reading 'secret')
 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:248:52
    246|       });
    247| 
    248|       const totpCode = generateTotpCode(mfaSecret!.secret);
       |                                                    ^
    249| 
    250|       await request(app)

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/41]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Password Reset Flow > should complete full password reset flow
AssertionError: expected 500 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 500

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:332:36
    330|         });
    331| 
    332|       expect(resetResponse.status).toBe(200);
       |                                    ^
    333| 
    334|       // Step 4: Verify old password no longer works

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/41]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Token Refresh Flow > should rotate refresh token on each use
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:415:40
    413|           .set('Cookie', refreshTokenCookie!);
    414| 
    415|         expect(refreshResponse.status).toBe(200);
       |                                        ^
    416|         expect(refreshResponse.body.token).toBeDefined();
    417| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/41]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Token Refresh Flow > should detect and prevent refresh token reuse (token theft)
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:445:31
    443|         .set('Cookie', originalRefreshToken!);
    444| 
    445|       expect(refresh1.status).toBe(200);
       |                               ^
    446| 
    447|       // Try to reuse original token (simulates theft)

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/41]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Session Management Flow > should list all active sessions
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:492:39
    490|         .set("Authorization", `Bearer ${token}`);
    491| 
    492|       expect(sessionsResponse.status).toBe(200);
       |                                       ^
    493|       expect(sessionsResponse.body.sessions).toBeDefined();
    494|       expect(sessionsResponse.body.sessions.length).toBeGreaterThanOrEÎ“Ã‡Âª

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/41]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Session Management Flow > should revoke specific session
AssertionError: expected 404 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 404

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:524:37
    522|         .set("Authorization", `Bearer ${token}`);
    523| 
    524|       expect(revokeResponse.status).toBe(200);
       |                                     ^
    525| 
    526|       // Verify session count decreased

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/41]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
AssertionError: expected 401 to be 423 // Object.is equality

- Expected
+ Received

- 423
+ 401

 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:250:31
    248|         });
    249| 
    250|       expect(response.status).toBe(423);
       |                               ^
    251|       expect(response.body).toBeDefined();
    252|       expect(response.body.error || response.body.message).toBeDefinedÎ“Ã‡Âª

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/41]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/reset-password > should reset password with valid token
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:405:36
    403|         .send({ email, password: newPassword });
    404| 
    405|       expect(loginResponse.status).toBe(200);
       |                                    ^
    406| 
    407|       // Old password should not work

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[11/41]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > GET /api/auth/me > should return current user for valid token
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:456:31
    454|         .set("Authorization", `Bearer ${token}`);
    455| 
    456|       expect(response.status).toBe(200);
       |                               ^
    457|       expect(response.body.email).toBe(email);
    458|       expect(response.body.id).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[12/41]Î“Ã„Â»

 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should return 401 when no token provided
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should return 401 with expired token
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should authenticate with JWT Bearer token
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should authenticate with refresh token cookie (GET only)
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should reject cookie auth for POST requests (mutation-strict)
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth/auth.middleware.integration.test.ts:82:33
     80|         }
     81| 
     82|         expect(loginRes.status).toBe(200);
       |                                 ^
     83| 
     84|         userToken = loginRes.body.token;

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[13/41]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > GET /api/auth/sessions - List Active Sessions > should list all active sessions for current user
AssertionError: expected 1 to be greater than or equal to 2
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:110:45
    108|       expect(response.status).toBe(200);
    109|       expect(response.body.sessions).toBeInstanceOf(Array);
    110|       expect(response.body.sessions.length).toBeGreaterThanOrEqual(2);
       |                                             ^
    111| 
    112|       // Verify session structure

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[14/41]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > DELETE /api/auth/sessions/:sessionId - Revoke Session > should prevent revoking current session
TypeError: Cannot read properties of undefined (reading 'id')
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:259:54
    257| 
    258|       const response = await request(app)
    259|         .delete(`/api/auth/sessions/${sessionRecord!.id}`)
       |                                                      ^
    260|         .set('Authorization', `Bearer ${authToken}`)
    261|         .set('Cookie', `refresh_token=${token}`);

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[15/41]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > DELETE /api/auth/sessions/all - Logout All Other Devices > should revoke all sessions except current
AssertionError: expected +0 to be 1 // Object.is equality

- Expected
+ Received

- 1
+ 0

 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:332:37
    330|         ));
    331| 
    332|       expect(activeSessions.length).toBe(1);
       |                                     ^
    333|       expect(activeSessions[0].token).toBe(hashToken(currentToken));
    334|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[16/41]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > Session Metadata Tracking > should update lastUsedAt on token refresh
AssertionError: expected +0 to be 1 // Object.is equality

- Expected
+ Received

- 1
+ 0

 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:590:31
    588|         ));
    589| 
    590|       expect(sessions.length).toBe(1);
       |                               ^
    591|       expect(sessions[0].lastUsedAt).toBeDefined();
    592|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[17/41]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > POST /api/auth/refresh-token > should refresh access token with valid refresh token
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:95:31
     93|         .set('Cookie', `refresh_token=${testRefreshToken}`);
     94| 
     95|       expect(response.status).toBe(200);
       |                               ^
     96|       expect(response.body).toMatchObject({
     97|         token: expect.any(String),

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[18/41]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > POST /api/auth/refresh-token > should update refresh token metadata on rotation
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:225:31
    223|         .set('X-Forwarded-For', '192.168.1.100');
    224| 
    225|       expect(response.status).toBe(200);
       |                               ^
    226| 
    227|       // Check new token has updated metadata

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[19/41]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > Refresh Token Lifecycle > should create refresh token on login
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:316:31
    314|         });
    315| 
    316|       expect(response.status).toBe(200);
       |                               ^
    317| 
    318|       // Verify refresh token cookie is set

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[20/41]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > Refresh Token Security > should prevent refresh token reuse after rotation
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:442:36
    440|         .set('Cookie', `refresh_token=${testRefreshToken}`);
    441| 
    442|       expect(firstResponse.status).toBe(200);
       |                                    ^
    443| 
    444|       // Try to reuse old token

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[21/41]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with malformed Authorization header
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:80:14
     78|                 password: testUser.password,
     79|             })
     80|             .expect(200);
       |              ^
     81| 
     82|         userToken = loginRes.body.token;
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[22/41]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Session Creation and Tracking > should create refresh token on login
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:74:18
     72|                     password: testUser.password,
     73|                 })
     74|                 .expect(200);
       |                  ^
     75| 
     76|             expect(loginRes.headers['set-cookie']).toBeDefined();
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[23/41]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Session Creation and Tracking > should track device metadata in session
AssertionError: expected 0 to be greater than 0
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:106:35
    104|             });
    105| 
    106|             expect(tokens.length).toBeGreaterThan(0);
       |                                   ^
    107|             expect(tokens[0].deviceName).toBeDefined();
    108|             expect(tokens[0].ipAddress).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[24/41]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Session Creation and Tracking > should create separate sessions for multiple device logins
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:120:18
    118|                     password: testUser.password,
    119|                 })
    120|                 .expect(200);
       |                  ^
    121| 
    122|             // Login from device 2
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[25/41]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should list all active sessions for user
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:163:18
    161|                     password: testUser.password,
    162|                 })
    163|                 .expect(200);
       |                  ^
    164| 
    165|             await request(ctx.baseURL)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[26/41]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should mark current session correctly
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:208:18
    206|                     password: testUser.password,
    207|                 })
    208|                 .expect(200);
       |                  ^
    209| 
    210|             await request(ctx.baseURL)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[27/41]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should not include revoked sessions
Error: expected 200 "OK", got 404 "Not Found"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:262:18
    260|                 .set("Authorization", `Bearer ${session1.body.token}`)
    261|                 .set("Cookie", session1.headers['set-cookie'])
    262|                 .expect(200);
       |                  ^
    263| 
    264|             // List sessions again
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[28/41]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should order sessions by last used (most recent first)
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:282:18
    280|                     password: testUser.password,
    281|                 })
    282|                 .expect(200);
       |                  ^
    283| 
    284|             await new Promise(resolve => setTimeout(resolve, 100));
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[29/41]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/:sessionId > should revoke specific session
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:341:18
    339|                     password: testUser.password,
    340|                 })
    341|                 .expect(200);
       |                  ^
    342| 
    343|             // Get sessions to find session2's ID
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[30/41]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/:sessionId > should prevent revoking current session
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:373:18
    371|                     password: testUser.password,
    372|                 })
    373|                 .expect(200);
       |                  ^
    374| 
    375|             const sessionsRes = await request(ctx.baseURL)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[31/41]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/:sessionId > should not allow revoking other users sessions
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:417:18
    415|                     password: user2.password,
    416|                 })
    417|                 .expect(200);
       |                  ^
    418| 
    419|             // User1 tries to get user2's sessions
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[32/41]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/:sessionId > should return 404 for non-existent session ID
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:452:18
    450|                     password: testUser.password,
    451|                 })
    452|                 .expect(200);
       |                  ^
    453| 
    454|             await request(ctx.baseURL)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[33/41]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/all > should revoke all sessions except current
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:489:18
    487|                     password: testUser.password,
    488|                 })
    489|                 .expect(200);
       |                  ^
    490| 
    491|             // Revoke all from session1
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[34/41]Î“Ã„Â»


[2m Test Files [22m [1m[31m7 failed[39m[22m[2m | [22m[1m[32m5 passed[39m[22m[90m (12)[39m
[2m      Tests [22m [1m[31m41 failed[39m[22m[2m | [22m[1m[32m249 passed[39m[22m[2m | [22m[33m2 skipped[39m[90m (292)[39m
[2m   Start at [22m 14:37:38
[2m   Duration [22m 110.27s[2m (transform 15.03s, setup 3.47s, import 46.30s, tests 657.32s, environment 3ms)[22m

