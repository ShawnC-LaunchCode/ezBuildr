npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.
 DEPRECATED  `test.poolOptions` was removed in Vitest 4. All previous `poolOptions` are now top-level options. Please, refer to the migration guide: https://vitest.dev/guide/migration#pool-rework

[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768087035673,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768087041071,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768087041084,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39m[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768087041076,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768087041076,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768087041079,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768087041083,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768087041083,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768087041084,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768087041084,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768087041517,"env":"test","module":"user-credentials-repository","userId":"233d509f-6874-4978-b9ca-dfb65e68764e","msg":"User credentials created"}
{"level":30,"time":1768087041626,"env":"test","module":"email-queue","jobId":"33ac6caa-2594-4f11-b7a9-8d7bd75801f5","to":"test-GmkFuQ2OgCroVTaXeI1h1@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768087041677,"env":"test","module":"auth-routes","userId":"233d509f-6874-4978-b9ca-dfb65e68764e","email":"test-GmkFuQ2OgCroVTaXeI1h1@example.com","msg":"User registered"}
{"level":30,"time":1768087042218,"env":"test","module":"user-credentials-repository","userId":"8cf2f10a-409a-4962-bcfe-ed09d93d72f2","msg":"User credentials created"}
{"level":30,"time":1768087042323,"env":"test","module":"email-queue","jobId":"d422ef16-0b05-4bf1-9c1f-be424d9f99d8","to":"jwt-test-7WBmCquLZaCVjsjdj1R6f@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768087042377,"env":"test","module":"auth-routes","userId":"8cf2f10a-409a-4962-bcfe-ed09d93d72f2","email":"jwt-test-7WBmCquLZaCVjsjdj1R6f@example.com","msg":"User registered"}
{"level":30,"time":1768087042956,"env":"test","module":"auth-routes","userId":"8cf2f10a-409a-4962-bcfe-ed09d93d72f2","msg":"User logged in successfully"}
{"level":30,"time":1768087043006,"env":"test","module":"audit-log-service","userId":"8cf2f10a-409a-4962-bcfe-ed09d93d72f2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768087043379,"env":"test","module":"user-credentials-repository","userId":"cc43af24-0087-436c-bdab-b907287bffe2","msg":"User credentials created"}
{"level":30,"time":1768087043483,"env":"test","module":"email-queue","jobId":"64a60a2b-0dea-4b0c-bde8-c5aad60b7e05","to":"jwt-test-uCYvKKu_hqhbwdZ72maQb@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768087043539,"env":"test","module":"auth-routes","userId":"cc43af24-0087-436c-bdab-b907287bffe2","email":"jwt-test-uCYvKKu_hqhbwdZ72maQb@example.com","msg":"User registered"}
{"level":30,"time":1768087043904,"env":"test","module":"user-credentials-repository","userId":"565ed43b-d72c-4247-b7ae-3415eab597d3","msg":"User credentials created"}
{"level":30,"time":1768087044006,"env":"test","module":"email-queue","jobId":"437a67e6-4793-414e-a660-bb35b1d55020","to":"jwt-test-5yegdWIqrYv4vewZuQu_U@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768087044058,"env":"test","module":"auth-routes","userId":"565ed43b-d72c-4247-b7ae-3415eab597d3","email":"jwt-test-5yegdWIqrYv4vewZuQu_U@example.com","msg":"User registered"}
{"level":50,"time":1768087044220,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":50,"time":1768087044224,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768087044228,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768087044388,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768087044394,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768087044394,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768087045499,"env":"test","module":"auth-middleware","error":{"name":"TokenExpiredError","code":"AUTH_002","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768087045499,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768087046605,"env":"test","module":"auth-middleware","error":{"name":"TokenExpiredError","code":"AUTH_002","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768087046605,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768087047523,"env":"test","module":"user-credentials-repository","userId":"30352736-86fc-4fdb-aad6-60aa99fb4aaa","msg":"User credentials created"}
{"level":30,"time":1768087047625,"env":"test","module":"email-queue","jobId":"67173a37-48b2-4e22-a085-4cdc36728bb0","to":"jwt-test-rIgTLvOiFuC4ePXZRQVgF@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768087047679,"env":"test","module":"auth-routes","userId":"30352736-86fc-4fdb-aad6-60aa99fb4aaa","email":"jwt-test-rIgTLvOiFuC4ePXZRQVgF@example.com","msg":"User registered"}
{"level":50,"time":1768087047838,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768087048202,"env":"test","module":"user-credentials-repository","userId":"d0049c19-8afe-4c07-8110-75f7be9cda66","msg":"User credentials created"}
{"level":30,"time":1768087048309,"env":"test","module":"email-queue","jobId":"1f4d957a-7cfb-44e0-aed4-98cf28edc9e9","to":"user1-7OeEkUpLnWWjyU_yvs0QW@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768087048365,"env":"test","module":"auth-routes","userId":"d0049c19-8afe-4c07-8110-75f7be9cda66","email":"user1-7OeEkUpLnWWjyU_yvs0QW@example.com","msg":"User registered"}
{"level":30,"time":1768087048734,"env":"test","module":"user-credentials-repository","userId":"d4d1a52c-0bbe-4dee-8885-109e691c544e","msg":"User credentials created"}
{"level":30,"time":1768087048841,"env":"test","module":"email-queue","jobId":"ca365d7a-87b8-4ada-8716-1ced6b0cb3e2","to":"user2-_77KlNLUUr_GUCqqa9piH@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768087048894,"env":"test","module":"auth-routes","userId":"d4d1a52c-0bbe-4dee-8885-109e691c544e","email":"user2-_77KlNLUUr_GUCqqa9piH@example.com","msg":"User registered"}
{"level":30,"time":1768087049380,"env":"test","module":"user-credentials-repository","userId":"e1f59437-1496-4b76-822c-13fc295c6234","msg":"User credentials created"}
{"level":30,"time":1768087049484,"env":"test","module":"email-queue","jobId":"a2cd7451-93a4-4f23-8afc-2a5a62381766","to":"jwt-test-m51Mw978aZEZSVR96UuTX@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768087049538,"env":"test","module":"auth-routes","userId":"e1f59437-1496-4b76-822c-13fc295c6234","email":"jwt-test-m51Mw978aZEZSVR96UuTX@example.com","msg":"User registered"}
{"level":50,"time":1768087049541,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768087049910,"env":"test","module":"user-credentials-repository","userId":"d7fe6029-e3fe-4c4c-8714-49a0239efb3f","msg":"User credentials created"}
{"level":30,"time":1768087050016,"env":"test","module":"email-queue","jobId":"06cfeb29-8a7d-4739-ad24-211836e35e06","to":"jwt-test-numM-G4_GEjzTWBs2MjtT@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768087050067,"env":"test","module":"auth-routes","userId":"d7fe6029-e3fe-4c4c-8714-49a0239efb3f","email":"jwt-test-numM-G4_GEjzTWBs2MjtT@example.com","msg":"User registered"}
{"level":30,"time":1768087050437,"env":"test","module":"user-credentials-repository","userId":"d4c174a3-ad17-4b4c-bcc3-b4c6df00d958","msg":"User credentials created"}
{"level":30,"time":1768087050544,"env":"test","module":"email-queue","jobId":"f3fe52b2-da49-4c1d-b70b-bbe4332a1aa9","to":"jwt-test-g6KeiS-fF-WCp1ZOpDSG1@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768087050598,"env":"test","module":"auth-routes","userId":"d4c174a3-ad17-4b4c-bcc3-b4c6df00d958","email":"jwt-test-g6KeiS-fF-WCp1ZOpDSG1@example.com","msg":"User registered"}
{"level":50,"time":1768087050601,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768087051079,"env":"test","module":"user-credentials-repository","userId":"8f2a9e28-20e5-4d73-b18d-c04cf2795587","msg":"User credentials created"}
{"level":30,"time":1768087051184,"env":"test","module":"email-queue","jobId":"0b8731e0-566e-45d4-b53c-2e5d936f3122","to":"jwt-test-BUFIFeCf6mb3idlVRP7r4@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768087051238,"env":"test","module":"auth-routes","userId":"8f2a9e28-20e5-4d73-b18d-c04cf2795587","email":"jwt-test-BUFIFeCf6mb3idlVRP7r4@example.com","msg":"User registered"}
{"level":30,"time":1768087051604,"env":"test","module":"user-credentials-repository","userId":"dffe8803-d085-42c9-81e4-b29a15b11c57","msg":"User credentials created"}
{"level":30,"time":1768087051709,"env":"test","module":"email-queue","jobId":"f44177d1-ba1f-47b5-aa3e-5d79e553c4f0","to":"jwt-test-AAqB7d7mdLsHuvUG_ygWE@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768087051762,"env":"test","module":"auth-routes","userId":"dffe8803-d085-42c9-81e4-b29a15b11c57","email":"jwt-test-AAqB7d7mdLsHuvUG_ygWE@example.com","msg":"User registered"}
{"level":30,"time":1768087052120,"env":"test","module":"user-credentials-repository","userId":"c0095a4d-6d5d-4ad6-967c-a65310f75e19","msg":"User credentials created"}
{"level":30,"time":1768087052222,"env":"test","module":"email-queue","jobId":"206fdb81-a883-40ec-b6a2-a2342bd95f89","to":"jwt-test-KHwkaR13vsk9RmblK8wpq@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768087052272,"env":"test","module":"auth-routes","userId":"c0095a4d-6d5d-4ad6-967c-a65310f75e19","email":"jwt-test-KHwkaR13vsk9RmblK8wpq@example.com","msg":"User registered"}
{"level":30,"time":1768087052634,"env":"test","module":"user-credentials-repository","userId":"d4404ba6-777e-4137-a2f6-0e11abd323f4","msg":"User credentials created"}
{"level":30,"time":1768087052744,"env":"test","module":"email-queue","jobId":"1d20b8f3-5462-46c5-8780-7812506ae768","to":"jwt-test-tbrWXuL1EskQ38ymW_uJd@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768087052798,"env":"test","module":"auth-routes","userId":"d4404ba6-777e-4137-a2f6-0e11abd323f4","email":"jwt-test-tbrWXuL1EskQ38ymW_uJd@example.com","msg":"User registered"}
{"level":30,"time":1768087053159,"env":"test","module":"user-credentials-repository","userId":"88fc05a0-830a-4e49-bad4-fbd657e43fa9","msg":"User credentials created"}
{"level":30,"time":1768087053264,"env":"test","module":"email-queue","jobId":"2a0a9834-6ad8-4f51-9e9d-1cb5e802c3a0","to":"jwt-test-xFSn5GIBCqTUXDlzLyI9A@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768087053323,"env":"test","module":"auth-routes","userId":"88fc05a0-830a-4e49-bad4-fbd657e43fa9","email":"jwt-test-xFSn5GIBCqTUXDlzLyI9A@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/auth/jwt.authentication.test.ts [2m([22m[2m27 tests[22m[2m | [22m[31m16 failed[39m[2m)[22m[33m 13222[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should generate valid JWT token on successful login [33m 1170[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should include correct payload in JWT token[39m[33m 532[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set JWT expiry to 15 minutes[39m[33m 518[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should accept valid JWT token on protected routes[39m[32m 162[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject request without authorization header[32m 4[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject request with malformed token[32m 4[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject request with missing Bearer prefix[39m[32m 160[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject token with invalid signature[32m 6[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject expired JWT token [33m 1105[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return token_expired error code for expired tokens[39m[33m 1109[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should authenticate with Bearer token in Authorization header[32m 104[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should work with Bearer token on POST requests[32m 122[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should work with Bearer token on PUT requests[39m[32m 60[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should work with Bearer token on DELETE requests[39m[32m 266[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should exchange valid session cookie for JWT token [33m 675[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject token exchange without valid cookie[32m 3[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prefer Bearer token over cookie when both present [33m 1166[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should fall back to cookie if Bearer token is invalid [33m 537[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow GET requests with cookie auth only[39m[33m 528[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject POST requests with cookie auth only (mutation-strict)[39m[33m 534[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow anonymous access to public workflows[39m[32m 53[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should attach user info if authenticated on optional auth routes[39m[32m 54[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should refresh access token using refresh token[39m[33m 529[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should rotate refresh token on use[39m[33m 525[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should detect token reuse and revoke all user tokens[39m[33m 509[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke refresh token on logout[39m[33m 526[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should clear refresh token cookie on logout[39m[33m 525[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 16 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > JWT Token Generation > should include correct payload in JWT token
TypeError: Cannot read properties of undefined (reading 'emailVerified')
 Î“Â¥Â» node_modules/drizzle-orm/utils.js:86:64
 Î“Â¥Â» mapUpdateSet node_modules/drizzle-orm/utils.js:82:82
 Î“Â¥Â» PgUpdateBuilder.set node_modules/drizzle-orm/pg-core/query-builders/update.js:30:7
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:93:18
     91| 
     92|             await db.update(db.query.users as any)
     93|                 .set({ emailVerified: true })
       |                  ^
     94|                 .where(eq((db.query.users as any).id, registerRes.bodyÎ“Ã‡Âª
     95| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/16]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > JWT Token Generation > should set JWT expiry to 15 minutes
TypeError: Cannot read properties of undefined (reading 'emailVerified')
 Î“Â¥Â» node_modules/drizzle-orm/utils.js:86:64
 Î“Â¥Â» mapUpdateSet node_modules/drizzle-orm/utils.js:82:82
 Î“Â¥Â» PgUpdateBuilder.set node_modules/drizzle-orm/pg-core/query-builders/update.js:30:7
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:125:18
    123| 
    124|             await db.update(db.query.users as any)
    125|                 .set({ emailVerified: true })
       |                  ^
    126|                 .where(eq((db.query.users as any).id, registerRes.bodyÎ“Ã‡Âª
    127| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/16]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > JWT Token Validation > should accept valid JWT token on protected routes
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:153:18
    151|                     password: testUser.password,
    152|                 })
    153|                 .expect(200);
       |                  ^
    154| 
    155|             const meRes = await request(ctx.baseURL)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/16]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > JWT Token Validation > should reject request with missing Bearer prefix
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:183:18
    181|                     password: testUser.password,
    182|                 })
    183|                 .expect(200);
       |                  ^
    184| 
    185|             await request(ctx.baseURL)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/16]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > JWT Token Expiration > should return token_expired error code for expired tokens
AssertionError: expected { code: 'AUTH_008', Î“Ã‡Âª(3) } to be 'token_expired' // Object.is equality

- Expected: 
"token_expired"

+ Received: 
{
  "code": "AUTH_008",
  "details": {
    "errorType": "UnauthorizedError",
  },
  "message": "Authentication required",
  "timestamp": "2026-01-10T23:17:26.605Z",
}

 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:237:36
    235|                 .expect(401);
    236| 
    237|             expect(res.body.error).toBe("token_expired");
       |                                    ^
    238|         });
    239|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/16]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > Bearer Token Authentication > should work with Bearer token on PUT requests
Error: expected 200 "OK", got 404 "Not Found"
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:268:18
    266|                 .set("Authorization", `Bearer ${ctx.authToken}`)
    267|                 .send({ firstName: "Updated" })
    268|                 .expect(200);
       |                  ^
    269| 
    270|             expect(updateRes.body).toBeDefined();
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/index.js:1102:18

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/16]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > Bearer Token Authentication > should work with Bearer token on DELETE requests
Error: expected 200 "OK", got 204 "No Content"
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:285:18
    283|                 .delete(`/api/projects/${projectRes.body.id}`)
    284|                 .set("Authorization", `Bearer ${ctx.authToken}`)
    285|                 .expect(200);
       |                  ^
    286|         });
    287|     });
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:847:12
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/index.js:1102:18

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/16]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > Hybrid Authentication Strategy > should allow GET requests with cookie auth only
TypeError: Cannot read properties of undefined (reading 'emailVerified')
 Î“Â¥Â» node_modules/drizzle-orm/utils.js:86:64
 Î“Â¥Â» mapUpdateSet node_modules/drizzle-orm/utils.js:82:82
 Î“Â¥Â» PgUpdateBuilder.set node_modules/drizzle-orm/pg-core/query-builders/update.js:30:7
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:380:18
    378| 
    379|             await db.update(db.query.users as any)
    380|                 .set({ emailVerified: true })
       |                  ^
    381|                 .where(eq((db.query.users as any).id, registerRes.bodyÎ“Ã‡Âª
    382| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/16]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > Hybrid Authentication Strategy > should reject POST requests with cookie auth only (mutation-strict)
AssertionError: expected { code: 'AUTH_008', Î“Ã‡Âª(3) } to be 'unauthorized' // Object.is equality

- Expected: 
"unauthorized"

+ Received: 
{
  "code": "AUTH_008",
  "details": {
    "errorType": "UnauthorizedError",
  },
  "message": "Authentication required",
  "timestamp": "2026-01-10T23:17:30.601Z",
}

 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:418:43
    416|                 .expect(401);
    417| 
    418|             expect(projectRes.body.error).toBe("unauthorized");
       |                                           ^
    419|         });
    420|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/16]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > Optional Authentication > should allow anonymous access to public workflows
Error: expected 201 "Created", got 400 "Bad Request"
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:432:18
    430|                     publicLink: `public-${nanoid()}`,
    431|                 })
    432|                 .expect(201);
       |                  ^
    433| 
    434|             // Access without authentication
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/16]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > Optional Authentication > should attach user info if authenticated on optional auth routes
Error: expected 201 "Created", got 400 "Bad Request"
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:451:18
    449|                     publicLink: `optional-${nanoid()}`,
    450|                 })
    451|                 .expect(201);
       |                  ^
    452| 
    453|             // Access with authentication
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[11/16]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > Token Refresh Flow > should refresh access token using refresh token
TypeError: Cannot read properties of undefined (reading 'emailVerified')
 Î“Â¥Â» node_modules/drizzle-orm/utils.js:86:64
 Î“Â¥Â» mapUpdateSet node_modules/drizzle-orm/utils.js:82:82
 Î“Â¥Â» PgUpdateBuilder.set node_modules/drizzle-orm/pg-core/query-builders/update.js:30:7
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:472:18
    470| 
    471|             await db.update(db.query.users as any)
    472|                 .set({ emailVerified: true })
       |                  ^
    473|                 .where(eq((db.query.users as any).id, registerRes.bodyÎ“Ã‡Âª
    474| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[12/16]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > Token Refresh Flow > should rotate refresh token on use
TypeError: Cannot read properties of undefined (reading 'emailVerified')
 Î“Â¥Â» node_modules/drizzle-orm/utils.js:86:64
 Î“Â¥Â» mapUpdateSet node_modules/drizzle-orm/utils.js:82:82
 Î“Â¥Â» PgUpdateBuilder.set node_modules/drizzle-orm/pg-core/query-builders/update.js:30:7
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:506:18
    504| 
    505|             await db.update(db.query.users as any)
    506|                 .set({ emailVerified: true })
       |                  ^
    507|                 .where(eq((db.query.users as any).id, registerRes.bodyÎ“Ã‡Âª
    508| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[13/16]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > Token Refresh Flow > should detect token reuse and revoke all user tokens
TypeError: Cannot read properties of undefined (reading 'emailVerified')
 Î“Â¥Â» node_modules/drizzle-orm/utils.js:86:64
 Î“Â¥Â» mapUpdateSet node_modules/drizzle-orm/utils.js:82:82
 Î“Â¥Â» PgUpdateBuilder.set node_modules/drizzle-orm/pg-core/query-builders/update.js:30:7
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:547:18
    545| 
    546|             await db.update(db.query.users as any)
    547|                 .set({ emailVerified: true })
       |                  ^
    548|                 .where(eq((db.query.users as any).id, registerRes.bodyÎ“Ã‡Âª
    549| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[14/16]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > Logout Flow > should revoke refresh token on logout
TypeError: Cannot read properties of undefined (reading 'emailVerified')
 Î“Â¥Â» node_modules/drizzle-orm/utils.js:86:64
 Î“Â¥Â» mapUpdateSet node_modules/drizzle-orm/utils.js:82:82
 Î“Â¥Â» PgUpdateBuilder.set node_modules/drizzle-orm/pg-core/query-builders/update.js:30:7
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:598:18
    596| 
    597|             await db.update(db.query.users as any)
    598|                 .set({ emailVerified: true })
       |                  ^
    599|                 .where(eq((db.query.users as any).id, registerRes.bodyÎ“Ã‡Âª
    600| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[15/16]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests > Logout Flow > should clear refresh token cookie on logout
TypeError: Cannot read properties of undefined (reading 'emailVerified')
 Î“Â¥Â» node_modules/drizzle-orm/utils.js:86:64
 Î“Â¥Â» mapUpdateSet node_modules/drizzle-orm/utils.js:82:82
 Î“Â¥Â» PgUpdateBuilder.set node_modules/drizzle-orm/pg-core/query-builders/update.js:30:7
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:631:18
    629| 
    630|             await db.update(db.query.users as any)
    631|                 .set({ emailVerified: true })
       |                  ^
    632|                 .where(eq((db.query.users as any).id, registerRes.bodyÎ“Ã‡Âª
    633| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[16/16]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m16 failed[39m[22m[2m | [22m[1m[32m11 passed[39m[22m[90m (27)[39m
[2m   Start at [22m 17:17:12
[2m   Duration [22m 21.02s[2m (transform 3.09s, setup 235ms, import 6.93s, tests 13.22s, environment 0ms)[22m

