npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

[1m[46m RUN [49m[22m [36mv4.0.5 [39m[90mC:/Users/scoot/poll/VaultLogic[39m

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[dotenv@17.2.3] injecting env (11) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts[2m > [22m[2mDataVault Autonumber Integration Tests
[22m[39m[DEBUG] Function source: 
      DECLARE
        v_next_value INTEGER;
        v_current_year INTEGER;
        v_last_reset_year INTEGER;
        v_formatted TEXT;
        v_sequence_row RECORD;
      BEGIN
        -- Get current year
        v_current_year := EXTRACT(YEAR FROM now());

        -- Get or create sequence row with row-level lock
        SELECT * INTO v_sequence_row
        FROM "datavault_number_sequences"
        WHERE "tenant_id" = p_tenant_id
          AND "table_id" = p_table_id
          AND "column_id" = p_column_id
        FOR UPDATE;

        -- If sequence doesn't exist, create it
        IF NOT FOUND THEN
          INSERT INTO "datavault_number_sequences" (
            "tenant_id",
            "table_id",
            "column_id",
            "prefix",
            "padding",
            "next_value",
            "reset_policy",
            "last_reset"
          ) VALUES (
            p_tenant_id,
            p_table_id,
            p_column_id,
            p_prefix,
            p_padding,
            2, -- FIX: Start at 2 because we use 1 immediately
            p_reset_policy::autonumber_reset_policy,
            now()
          )
          RETURNING * INTO v_sequence_row;

          v_next_value := 1;
        ELSE
          -- Check if we need to reset for yearly policy
          IF p_reset_policy = 'yearly' THEN
            v_last_reset_year := EXTRACT(YEAR FROM v_sequence_row.last_reset);

            IF v_last_reset_year IS NULL OR v_last_reset_year < v_current_year THEN
              -- Reset the sequence
              UPDATE "datavault_number_sequences"
              SET "next_value" = 2,
                  "last_reset" = now()
              WHERE "tenant_id" = p_tenant_id
                AND "table_id" = p_table_id
                AND "column_id" = p_column_id;

              v_next_value := 1;
            ELSE
              -- Normal increment
              UPDATE "datavault_number_sequences"
              SET "next_value" = "next_value" + 1
              WHERE "tenant_id" = p_tenant_id
                AND "table_id" = p_table_id
                AND "column_id" = p_column_id
              RETURNING "next_value" - 1 INTO v_next_value;
            END IF;
          ELSE
            -- Never reset, just increment
            UPDATE "datavault_number_sequences"
            SET "next_value" = "next_value" + 1
            WHERE "tenant_id" = p_tenant_id
              AND "table_id" = p_table_id
              AND "column_id" = p_column_id
            RETURNING "next_value" - 1 INTO v_next_value;
          END IF;
        END IF;

        -- Format the value
        IF p_prefix IS NOT NULL AND p_prefix != '' THEN
          IF p_reset_policy = 'yearly' THEN
            v_formatted := p_prefix || '-' || v_current_year::TEXT || '-' || LPAD(v_next_value::TEXT, p_padding, '0');
          ELSE
            v_formatted := p_prefix || '-' || LPAD(v_next_value::TEXT, p_padding, '0');
          END IF;
        ELSE
          v_formatted := LPAD(v_next_value::TEXT, p_padding, '0');
        END IF;

        RETURN v_formatted;
      END;
      

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/datavault.autonumber.test.ts [2m([22m[2m5 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 8327[2mms[22m[39m
     [33m[2mÎ“Â£Ã´[22m[39m should generate basic autonumber without prefix [33m 1137[2mms[22m[39m
[31m     [31mâ”œÃ¹[31m should generate autonumber with prefix[39m[33m 558[2mms[22m[39m
[31m     [31mâ”œÃ¹[31m should generate autonumber with yearly reset format[39m[33m 564[2mms[22m[39m
     [33m[2mÎ“Â£Ã´[22m[39m should be atomic and prevent race conditions [33m 2893[2mms[22m[39m
     [33m[2mÎ“Â£Ã´[22m[39m should prevent manual updates to autonumber values [33m 1471[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/datavault.autonumber.test.ts > DataVault Autonumber Integration Tests
Error: Table not found
 Î“Â¥Â» DatavaultTablesService.verifyTenantOwnership server/services/DatavaultTablesService.ts:150:13
    148| 
    149|     if (!table) {
    150|       throw new Error("Table not found");
       |             ^
    151|     }
    152| 
 Î“Â¥Â» DatavaultTablesService.deleteTable server/services/DatavaultTablesService.ts:290:5
 Î“Â¥Â» tests/integration/datavault.autonumber.test.ts:93:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/3]Î“Ã„Â»



Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 2 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m2 failed[39m[22m[2m | [22m[1m[32m3 passed[39m[22m[90m (5)[39m
[2m   Start at [22m 14:18:52
[2m   Duration [22m 9.92s[2m (transform 471ms, setup 57ms, collect 997ms, tests 8.33s, environment 0ms, prepare 13ms)[22m

 FAIL  tests/integration/datavault.autonumber.test.ts > DataVault Autonumber Integration Tests > should generate autonumber with prefix
AssertionError: expected 'CASE-00003' to be 'CASE-00001' // Object.is equality

Expected: "CASE-00001"
Received: "CASE-00003"

 Î“Â¥Â» tests/integration/datavault.autonumber.test.ts:128:51
    126|     );
    127| 
    128|     expect(row1.values[prefixAutonumberColumnId]).toBe('CASE-00001');
       |                                                   ^
    129| 
    130|     // Create second row

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/3]Î“Ã„Â»

 FAIL  tests/integration/datavault.autonumber.test.ts > DataVault Autonumber Integration Tests > should generate autonumber with yearly reset format
AssertionError: expected 'INV-2025-004' to be 'INV-2025-001' // Object.is equality

Expected: "INV-2025-001"
Received: "INV-2025-004"

 Î“Â¥Â» tests/integration/datavault.autonumber.test.ts:153:46
    151| 
    152|     // Format should be: PREFIX-YEAR-PADDED_NUMBER
    153|     expect(row1.values[yearlyResetColumnId]).toBe(`INV-${currentYear}-Î“Ã‡Âª
       |                                              ^
    154| 
    155|     // Create second row

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/3]Î“Ã„Â»

