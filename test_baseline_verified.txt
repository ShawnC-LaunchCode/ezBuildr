npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

> ezbuildr@1.0.0 test
> cross-env VITEST_INTEGRATION=true vitest run --coverage


[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m
      [2mCoverage enabled with [22m[33mv8[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w9_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w4_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w9_v3 (Reused: true)

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w4_v3 (Reused: true)

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w6_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w6_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39müìä Schema test_schema_w9_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39müìä Schema test_schema_w4_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39müìä Schema test_schema_w6_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w8_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w8_v3 (Reused: true)

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715690361,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715690362,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w9_v3\",public"}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w10_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768715690424,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715690429,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715690430,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w4_v3\",public"}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w10_v3 (Reused: true)

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715690473,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715690474,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w6_v3\",public"}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w14_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768715690493,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w14_v3 (Reused: true)

{"level":30,"time":1768715690526,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39müìä Schema test_schema_w8_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715690747,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715690747,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w8_v3\",public"}
{"level":30,"time":1768715690803,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39müìä Schema test_schema_w10_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715690890,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715690891,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w10_v3\",public"}
{"level":30,"time":1768715690948,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39müìä Schema test_schema_w14_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715690960,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715690961,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w14_v3\",public"}
{"level":30,"time":1768715691018,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m‚ö†Ô∏è Could not set database-level search_path (expected in cloud DBs): tuple concurrently updated
‚úÖ Enforced search_path: test_schema_w6_v3, public

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m‚ö†Ô∏è Could not set database-level search_path (expected in cloud DBs): tuple concurrently updated
‚úÖ Enforced search_path: test_schema_w8_v3, public

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m‚ö†Ô∏è Could not set database-level search_path (expected in cloud DBs): tuple concurrently updated
‚úÖ Enforced search_path: test_schema_w4_v3, public

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w9_v3, public
‚úÖ Enforced search_path: test_schema_w9_v3, public

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w14_v3
‚úÖ Current search_path: test_schema_w14_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w4_v3
‚úÖ Current search_path: test_schema_w4_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w6_v3
‚úÖ Current search_path: test_schema_w6_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w9_v3
‚úÖ Current search_path: test_schema_w9_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w10_v3, public
‚úÖ Enforced search_path: test_schema_w10_v3, public

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w14_v3, public
‚úÖ Enforced search_path: test_schema_w14_v3, public

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w14_v3
‚úÖ Current search_path: test_schema_w14_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w14_v3
‚úÖ Current search_path: test_schema_w14_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w3_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w3_v3 (Reused: true)

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w13_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w2_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w13_v3 (Reused: true)

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w2_v3 (Reused: true)

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

{"level":30,"time":1768715692482,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768715692482,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768715692482,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768715692484,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39müìä Schema test_schema_w3_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39müìä Schema test_schema_w13_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39müìä Schema test_schema_w2_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstderr[2m | tests/unit/client/choice-utils.test.ts[2m > [22m[2mchoice-utils[2m > [22m[2mhandles missing content gracefully
[22m[39m[generateOptionsFromList] Invalid list data: [1mnull[22m

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715692882,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768715692886,"env":"test","msg":"DB: closing pool..."}
{"level":40,"time":1768715692887,"env":"test","module":"rbac-middleware","path":"/api/workflows","permission":"workflow:create","msg":"Unauthenticated user attempted to access protected resource"}
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":40,"time":1768715692890,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","permission":"workflow:create","path":"/api/workflows","msg":"Permission denied"}
{"level":40,"time":1768715692892,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":null,"permission":"workflow:view","path":"/api/workflows","msg":"Permission denied"}
{"level":40,"time":1768715692893,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","permissions":["workflow:create","workflow:edit","workflow:delete"],"path":"/api/workflows","msg":"Permission denied (none of required permissions)"}
{"level":40,"time":1768715692894,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"builder","permissions":["workflow:edit","workflow:delete"],"path":"/api/workflows","msg":"Permission denied (missing some required permissions)"}
{"level":40,"time":1768715692896,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","requiredRoles":["owner","builder"],"path":"/api/admin","msg":"Role check failed"}
{"level":40,"time":1768715692896,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":null,"requiredRoles":["owner"],"path":"/api/admin","msg":"Role check failed"}
{"level":40,"time":1768715692897,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"builder","requiredRoles":["owner"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768715692898,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"runner","requiredRoles":["owner","builder"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768715692899,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","requiredRoles":["owner","builder","runner"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768715692903,"env":"test","module":"rbac-middleware","path":"/api/test","permission":"workflow:view","msg":"Unauthenticated user attempted to access protected resource"}
{"level":40,"time":1768715692903,"env":"test","module":"rbac-middleware","userId":"user-123","permission":"workflow:view","path":"/api/test","msg":"Permission denied"}
{"level":40,"time":1768715692903,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"invalid-role","permission":"workflow:view","path":"/api/test","msg":"Permission denied"}
{"level":30,"time":1768715692904,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768715692904,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/api.ai.test.ts [2m([22m[2m32 tests[22m[2m)[22m[33m 4406[2mms[22m[39m
{"level":30,"time":1768715692883,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/client/choice-utils.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 4354[2mms[22m[39m
{"level":30,"time":1768715692886,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/middleware/rbac.test.ts [2m([22m[2m44 tests[22m[2m)[22m[33m 4257[2mms[22m[39m
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w7_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w1_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w5_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768715693056,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715693056,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w7_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w1_v3 (Reused: true)

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w0_v3 (Reused: true)

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w5_v3 (Reused: true)

 [32m‚úì[39m tests/unit/services/DocumentTemplateService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 2957[2mms[22m[39m
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w12_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w12_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39müìä Schema test_schema_w7_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715693504,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39müìä Schema test_schema_w1_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715693528,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39müìä Schema test_schema_w5_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715693541,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715693541,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w5_v3\",public"}
[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39müìä Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715693551,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768715693504,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w7_v3\",public"}
{"level":30,"time":1768715693572,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768715693602,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768715693529,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w1_v3\",public"}
{"level":30,"time":1768715693602,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

{"level":30,"time":1768715693551,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w0_v3\",public"}
{"level":30,"time":1768715693614,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39müìä Schema test_schema_w12_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715693807,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715693808,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w12_v3\",public"}
{"level":30,"time":1768715693895,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715693963,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715693964,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w3_v3\",public"}
{"level":30,"time":1768715693964,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715693965,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w13_v3\",public"}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715693971,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715693973,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w2_v3\",public"}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w17_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768715694027,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768715694030,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768715694041,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w17_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w16_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w16_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m‚ö†Ô∏è Could not set database-level search_path (expected in cloud DBs): tuple concurrently updated
‚úÖ Enforced search_path: test_schema_w1_v3, public

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w7_v3, public
‚úÖ Enforced search_path: test_schema_w7_v3, public

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w5_v3, public
‚úÖ Enforced search_path: test_schema_w5_v3, public

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w0_v3, public
‚úÖ Enforced search_path: test_schema_w0_v3, public

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w10_v3
‚úÖ Current search_path: test_schema_w14_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w14_v3
‚úÖ Current search_path: test_schema_w12_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w12_v3
‚úÖ Current search_path: test_schema_w10_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w12_v3
‚úÖ Current search_path: test_schema_w14_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39müìä Schema test_schema_w17_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39müìä Schema test_schema_w16_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w12_v3, public
‚úÖ Enforced search_path: test_schema_w12_v3, public

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w14_v3
‚úÖ Current search_path: test_schema_w14_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m‚úÖ Set default search_path for database: test_schema_w3_v3, public
‚úÖ Enforced search_path: test_schema_w3_v3, public

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m‚úÖ Set default search_path for database: test_schema_w13_v3, public
‚úÖ Enforced search_path: test_schema_w13_v3, public

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m‚úÖ Set default search_path for database: test_schema_w2_v3, public
‚úÖ Enforced search_path: test_schema_w2_v3, public

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w3_v3
‚úÖ Current search_path: test_schema_w3_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w2_v3
‚úÖ Current search_path: test_schema_w2_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w13_v3
‚úÖ Current search_path: test_schema_w13_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715695312,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715695313,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w17_v3\",public"}
{"level":30,"time":1768715695370,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: 
        CREATE OR REPLACE FUNCTION datavault_get_next_autonumber(
          p_tenant_id UUID,
          p_table_id UUID,
          p_column_id UUID,
          p_context_key TEXT,
          p_min_digits INTEGER DEFAULT 1,
          p_prefix TEXT DEFAULT '',
          p_format TEXT DEFAULT NULL
        )
        RETURNS TEXT
        LANGUAGE plpgsql
        AS $$
        DECLARE
          v_sequence_name TEXT;
          v_next_val BIGINT;
          v_year TEXT;
          v_formatted TEXT;
          v_final_result TEXT;
          v_prefix TEXT;
        BEGIN
          -- Use MD5 hash for sequence name to ensure uniqueness and stay within 63 char limit
          -- Format: seq_{md5_hash}
          v_sequence_name := 'seq_' || md5(p_tenant_id::text || '_' || p_column_id::text);
          
          -- Handle Year-based updates
          IF p_format = 'YYYY' THEN
              v_year := to_char(current_date, 'YYYY');
              v_sequence_name := v_sequence_name || '_' || v_year;
          END IF;

          -- Create sequence if not exists
          EXECUTE format('CREATE SEQUENCE IF NOT EXISTS %I START 1', v_sequence_name);
          
          -- Get next value
          EXECUTE format('SELECT nextval(%L)', v_sequence_name) INTO v_next_val;
          
          -- Ensure defaults for NULL inputs to prevent NULL results
          v_prefix := COALESCE(p_prefix, '');
          
          -- Format the number
          v_formatted := lpad(v_next_val::text, COALESCE(p_min_digits, 4), '0');
          
          -- Combine
          -- Logic: [Prefix-] [Year-] Number
          
          -- 1. Start with Prefix (if exists, add dash)
          IF v_prefix <> '' THEN
             v_final_result := v_prefix || '-';
          ELSE
             v_final_result := '';
          END IF;
          
          -- 2. Add Year (if exists, add dash)
          IF p_format = 'YYYY' THEN
               v_final_result := v_final_result || v_year || '-';
          END IF;
          
          -- 3. Add Number
          v_final_result := v_final_result || v_formatted;
          
          RETURN v_final_result;
        END;
        $$;
      
params: 
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at ensureDbFunctions (C:/Users/scoot/poll/VaultLogic/tests/setup.ts:455:3)
    at ensureDbFunctionsWithRetry (C:/Users/scoot/poll/VaultLogic/tests/setup.ts:401:7)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:346:9 {
  query: [32m'\n'[39m +
    [32m'        CREATE OR REPLACE FUNCTION datavault_get_next_autonumber(\n'[39m +
    [32m'          p_tenant_id UUID,\n'[39m +
    [32m'          p_table_id UUID,\n'[39m +
    [32m'          p_column_id UUID,\n'[39m +
    [32m'          p_context_key TEXT,\n'[39m +
    [32m'          p_min_digits INTEGER DEFAULT 1,\n'[39m +
    [32m"          p_prefix TEXT DEFAULT '',\n"[39m +
    [32m'          p_format TEXT DEFAULT NULL\n'[39m +
    [32m'        )\n'[39m +
    [32m'        RETURNS TEXT\n'[39m +
    [32m'        LANGUAGE plpgsql\n'[39m +
    [32m'        AS $$\n'[39m +
    [32m'        DECLARE\n'[39m +
    [32m'          v_sequence_name TEXT;\n'[39m +
    [32m'          v_next_val BIGINT;\n'[39m +
    [32m'          v_year TEXT;\n'[39m +
    [32m'          v_formatted TEXT;\n'[39m +
    [32m'          v_final_result TEXT;\n'[39m +
    [32m'          v_prefix TEXT;\n'[39m +
    [32m'        BEGIN\n'[39m +
    [32m'          -- Use MD5 hash for sequence name to ensure uniqueness and stay within 63 char limit\n'[39m +
    [32m'          -- Format: seq_{md5_hash}\n'[39m +
    [32m"          v_sequence_name := 'seq_' || md5(p_tenant_id::text || '_' || p_column_id::text);\n"[39m +
    [32m'          \n'[39m +
    [32m'          -- Handle Year-based updates\n'[39m +
    [32m"          IF p_format = 'YYYY' THEN\n"[39m +
    [32m"              v_year := to_char(current_date, 'YYYY');\n"[39m +
    [32m"              v_sequence_name := v_sequence_name || '_' || v_year;\n"[39m +
    [32m'          END IF;\n'[39m +
    [32m'\n'[39m +
    [32m'          -- Create sequence if not exists\n'[39m +
    [32m"          EXECUTE format('CREATE SEQUENCE IF NOT EXISTS %I START 1', v_sequence_name);\n"[39m +
    [32m'          \n'[39m +
    [32m'          -- Get next value\n'[39m +
    [32m"          EXECUTE format('SELECT nextval(%L)', v_sequence_name) INTO v_next_val;\n"[39m +
    [32m'          \n'[39m +
    [32m'          -- Ensure defaults for NULL inputs to prevent NULL results\n'[39m +
    [32m"          v_prefix := COALESCE(p_prefix, '');\n"[39m +
    [32m'          \n'[39m +
    [32m'          -- Format the number\n'[39m +
    [32m"          v_formatted := lpad(v_next_val::text, COALESCE(p_min_digits, 4), '0');\n"[39m +
    [32m'          \n'[39m +
    [32m'          -- Combine\n'[39m +
    [32m'          -- Logic: [Prefix-] [Year-] Number\n'[39m +
    [32m'          \n'[39m +
    [32m'          -- 1. Start with Prefix (if exists, add dash)\n'[39m +
    [32m"          IF v_prefix <> '' THEN\n"[39m +
    [32m"             v_final_result := v_prefix || '-';\n"[39m +
    [32m'          ELSE\n'[39m +
    [32m"             v_final_result := '';\n"[39m +
    [32m'          END IF;\n'[39m +
    [32m'          \n'[39m +
    [32m'          -- 2. Add Year (if exists, add dash)\n'[39m +
    [32m"          IF p_format = 'YYYY' THEN\n"[39m +
    [32m"               v_final_result := v_final_result || v_year || '-';\n"[39m +
    [32m'          END IF;\n'[39m +
    [32m'          \n'[39m +
    [32m'          -- 3. Add Number\n'[39m +
    [32m'          v_final_result := v_final_result || v_formatted;\n'[39m +
    [32m'          \n'[39m +
    [32m'          RETURN v_final_result;\n'[39m +
    [32m'        END;\n'[39m +
    [32m'        $$;\n'[39m +
    [32m'      '[39m,
  params: [],
  cause: error: duplicate key value violates unique constraint "pg_proc_proname_args_nsp_index"
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at ensureDbFunctions (C:/Users/scoot/poll/VaultLogic/tests/setup.ts:455:3)
      at ensureDbFunctionsWithRetry (C:/Users/scoot/poll/VaultLogic/tests/setup.ts:401:7)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:346:9 {
    length: [33m323[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23505'[39m,
    detail: [32m'Key (proname, proargtypes, pronamespace)=(datavault_get_next_autonumber, 2950 2950 2950 25 23 25 25, 2463126) already exists.'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'pg_catalog'[39m,
    table: [32m'pg_proc'[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [32m'pg_proc_proname_args_nsp_index'[39m,
    file: [32m'nbtinsert.c'[39m,
    line: [32m'667'[39m,
    routine: [32m'_bt_check_unique'[39m
  }
}

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715695433,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715695434,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w16_v3\",public"}
{"level":30,"time":1768715695485,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768715695989,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["fd97d4fd-8a54-4f56-b82b-9c5bcd494a9d","$2b$12$2vRrOM5uGIU5FFi63zXXN.Um0J1ZGB/zZXkHkQDEBK2me.mgDLpmy"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(fd97d4fd-8a54-4f56-b82b-9c5bcd494a9d) is not present in table \"users\".","schema":"test_schema_w7_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"fd97d4fd-8a54-4f56-b82b-9c5bcd494a9d","msg":"Failed to create user credentials"}
{"level":50,"time":1768715695989,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["fd97d4fd-8a54-4f56-b82b-9c5bcd494a9d","$2b$12$2vRrOM5uGIU5FFi63zXXN.Um0J1ZGB/zZXkHkQDEBK2me.mgDLpmy"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(fd97d4fd-8a54-4f56-b82b-9c5bcd494a9d) is not present in table \"users\".","schema":"test_schema_w7_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768715696052,"env":"test","module":"auth-routes","email":"test-1768715695566-qxlb0c@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w17_v3, public
‚úÖ Enforced search_path: test_schema_w17_v3, public

{"level":50,"time":1768715696172,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx[2m > [22m[2mTableGridView - Drag & Drop[2m > [22m[2mrenders DndContext wrapper
[22m[39mWarning: validateDOMNesting(...): <th> cannot appear as a child of <div>.
    at th
    at SortableColumnHeader (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/SortableColumnHeader.tsx:12:33)
    at div
    at SortableContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:26:23)
    at tr
    at thead
    at table
    at div
    at DndContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:18:18)
    at div
    at div
    at TableGridView (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/TableGridView.tsx:32:26)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
Warning: validateDOMNesting(...): <div> cannot appear as a child of <tr>.
    at div
    at SortableContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:26:23)
    at tr
    at thead
    at table
    at div
    at DndContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:18:18)
    at div
    at div
    at TableGridView (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/TableGridView.tsx:32:26)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)

[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768715696216,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["38268e56-d1dc-42b0-92de-f28b74d393bb","$2b$12$7iZ3DCNXCoN/H57XqNXcc.hgh0IpyaGqap4xuq6ndTNTqDljXyfAK"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(38268e56-d1dc-42b0-92de-f28b74d393bb) is not present in table \"users\".","schema":"test_schema_w7_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"38268e56-d1dc-42b0-92de-f28b74d393bb","msg":"Failed to create user credentials"}
{"level":50,"time":1768715696216,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["38268e56-d1dc-42b0-92de-f28b74d393bb","$2b$12$7iZ3DCNXCoN/H57XqNXcc.hgh0IpyaGqap4xuq6ndTNTqDljXyfAK"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(38268e56-d1dc-42b0-92de-f28b74d393bb) is not present in table \"users\".","schema":"test_schema_w7_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w16_v3, public
‚úÖ Enforced search_path: test_schema_w16_v3, public

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w17_v3
‚úÖ Current search_path: test_schema_w17_v3, public
‚è© Schema reused, skipping migrations.

{"level":50,"time":1768715696336,"env":"test","module":"auth-routes","userId":"5ee2ea16ef0b782dc23ab20df62c8ba3","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w16_v3
‚úÖ Current search_path: test_schema_w16_v3, public
‚è© Schema reused, skipping migrations.

{"level":50,"time":1768715696453,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:74:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768715696512,"env":"test","module":"auth-routes","email":"test-1768715695566-qxlb0c@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":30,"time":1768715696513,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715696513,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w15_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w15_v3 (Reused: true)

{"level":50,"time":1768715696636,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

 [31m‚ùØ[39m tests/integration/workflows/runtime-pipelines.test.ts [2m([22m[2m4 tests[22m[2m | [22m[33m4 skipped[39m[2m)[22m[33m 3632[2mms[22m[39m
       [2m[90m‚Üì[39m[22m should create DataVault row on workflow completion
       [2m[90m‚Üì[39m[22m should execute writebacks via RunService.completeRun()
       [2m[90m‚Üì[39m[22m should skip document generation when visibleIf condition is false
       [2m[90m‚Üì[39m[22m should generate document when visibleIf condition is true
{"level":30,"time":1768715696888,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768715696983,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715696984,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39müìä Schema test_schema_w15_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

{"level":30,"time":1768715697063,"env":"test","module":"user-credentials-repository","userId":"c827887d-e441-41fc-b4e5-e85e558768f4","msg":"User credentials created"}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

 [32m‚úì[39m tests/unit/components/datavault/TableGridViewDragDrop.test.tsx [2m([22m[2m7 tests[22m[2m)[22m[33m 5201[2mms[22m[39m
     [33m[2m‚úì[22m[39m displays columns in order based on orderIndex [33m 467[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

{"level":30,"time":1768715697218,"env":"test","module":"email-queue","jobId":"7875be54-d3c0-4bc4-adb4-ff55ff1eccc0","to":"test-1768715696257-jjouqu@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":30,"time":1768715697298,"env":"test","module":"auth-routes","userId":"c827887d-e441-41fc-b4e5-e85e558768f4","email":"test-1768715696257-jjouqu@example.com","msg":"User registered"}
{"level":30,"time":1768715697408,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715697409,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768715697471,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715697472,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/collab.client.test.tsx [2m([22m[2m17 tests[22m[2m)[22m[33m 5808[2mms[22m[39m
     [33m[2m‚úì[22m[39m should add a comment [33m 401[2mms[22m[39m
 [32m‚úì[39m tests/unit/utils/encryption.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 3845[2mms[22m[39m
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts[2m > [22m[2mIntakeQuestionVisibilityService[2m > [22m[2mHelper methods[2m > [22m[2mshould get visible question count
[22m[39mMOCK SETUP DONE. Mock questions: [
  {
    id: [32m'q1'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q1'[39m,
    order: [33m0[39m,
    isVirtual: [33mfalse[39m,
    alias: [32m'show'[39m,
    visibleIf: [1mnull[22m
  },
  {
    id: [32m'q2'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q2'[39m,
    order: [33m1[39m,
    isVirtual: [33mfalse[39m,
    visibleIf: { op: [32m'equals'[39m, left: [36m[Object][39m, right: [36m[Object][39m }
  },
  {
    id: [32m'q3'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q3'[39m,
    order: [33m2[39m,
    isVirtual: [33mfalse[39m,
    visibleIf: [1mnull[22m
  }
]
Calling getVisibleQuestionCount...

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts[2m > [22m[2mIntakeQuestionVisibilityService[2m > [22m[2mHelper methods[2m > [22m[2mshould get visible question count
[22m[39mCOUNT RESULT: [33m0[39m
Mock called times: [33m1[39m
Mock last call args: [ [ [32m'section1'[39m ] ]

{"level":50,"time":1768715697568,"env":"test","module":"intake-question-visibility","error":{},"questionId":"q1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating visibleIf condition"}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715697570,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768715697571,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

 [32m‚úì[39m tests/unit/services/intakeQuestionVisibility.test.ts [2m([22m[2m19 tests[22m[2m)[22m[33m 3806[2mms[22m[39m
{"level":50,"time":1768715697636,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768715697766,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["d092f13f-23a5-4247-b232-5914d217388c","$2b$12$QrCbk/TaT3iiUSB.zLimeulj1uugRSUOe3gOPskkcMIDrDehPHzVK"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(d092f13f-23a5-4247-b232-5914d217388c) is not present in table \"users\".","schema":"test_schema_w12_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"d092f13f-23a5-4247-b232-5914d217388c","msg":"Failed to create user credentials"}
{"level":50,"time":1768715697766,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["d092f13f-23a5-4247-b232-5914d217388c","$2b$12$QrCbk/TaT3iiUSB.zLimeulj1uugRSUOe3gOPskkcMIDrDehPHzVK"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(d092f13f-23a5-4247-b232-5914d217388c) is not present in table \"users\".","schema":"test_schema_w12_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768715697769,"env":"test","module":"auth-routes","userId":"dcc75811141bdc96f10b3c1754539804","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768715697884,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:74:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768715697940,"env":"test","module":"auth-routes","email":"test-1768715697243-ui0xe@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":30,"time":1768715697991,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715697992,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715698006,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715698007,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w15_v3\",public"}
{"level":50,"time":1768715698053,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768715698075,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

 [32m‚úì[39m tests/unit/components/datavault/TableGridView.test.tsx [2m([22m[2m9 tests[22m[2m)[22m[33m 6208[2mms[22m[39m
     [33m[2m‚úì[22m[39m loads table schema and rows [33m 420[2mms[22m[39m
     [33m[2m‚úì[22m[39m updates cell value on blur [33m 492[2mms[22m[39m
     [33m[2m‚úì[22m[39m renders delete button for each row [33m 400[2mms[22m[39m
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768715698184,"env":"test","module":"auth-routes","email":"test-1768715697412-xi4lpk@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768715698317,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould complete MFA setup and login with TOTP
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768715698329,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768715698492,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["2e09b530-bf05-4415-a920-5b6f067698ec","$2b$12$NRgFoQrcbcqDk8REhSMPUeuS6Of51rYNxi89TKn2Lo6W0VGaFd2km"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(2e09b530-bf05-4415-a920-5b6f067698ec) is not present in table \"users\".","schema":"test_schema_w10_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"2e09b530-bf05-4415-a920-5b6f067698ec","msg":"Failed to create user credentials"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for 47bd7aab75346b7e78229949aa05a183

{"level":50,"time":1768715698492,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["2e09b530-bf05-4415-a920-5b6f067698ec","$2b$12$NRgFoQrcbcqDk8REhSMPUeuS6Of51rYNxi89TKn2Lo6W0VGaFd2km"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(2e09b530-bf05-4415-a920-5b6f067698ec) is not present in table \"users\".","schema":"test_schema_w10_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w21_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w21_v3 (Reused: true)

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w19_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w19_v3 (Reused: true)

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m‚úÖ Set default search_path for database: test_schema_w15_v3, public
‚úÖ Enforced search_path: test_schema_w15_v3, public

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w15_v3
‚úÖ Current search_path: test_schema_w15_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39müìä Schema test_schema_w21_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768715699096,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39müìä Schema test_schema_w19_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715699117,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715699118,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w19_v3\",public"}
{"level":50,"time":1768715699142,"env":"test","module":"auth-routes","email":"test-1768715698676-66c2xq@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":30,"time":1768715699165,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768715699264,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould exclude revoked sessions
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768715699316,"env":"test","module":"auth-routes","email":"test-1768715698676-66c2xq@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768715699433,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould exclude revoked sessions
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768715699453,"env":"test","module":"auth-routes","userId":"712c53deb2e98200e2233fe4a5759446","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould login with backup code when TOTP unavailable
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:74:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768715699549,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":50,"time":1768715699557,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715699911,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715699912,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w21_v3\",public"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w19_v3, public
‚úÖ Enforced search_path: test_schema_w19_v3, public

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w24_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768715699962,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w24_v3 (Reused: true)

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w7_v3
‚úÖ Current search_path: test_schema_w7_v3, public
‚è© Schema reused, skipping migrations.

{"level":50,"time":1768715700048,"env":"test","module":"auth-routes","email":"test-1768715699202-kj3p3c@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768715700229,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for invalid password
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39müìä Schema test_schema_w24_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715700411,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715700412,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w24_v3\",public"}
{"level":30,"time":1768715700459,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w20_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w20_v3 (Reused: true)

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w23_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w23_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w21_v3, public
‚úÖ Enforced search_path: test_schema_w21_v3, public

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

{"level":30,"time":1768715700850,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715700850,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w21_v3
‚úÖ Current search_path: test_schema_w21_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":50,"time":1768715700888,"env":"test","module":"auth-routes","email":"nonexistent@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39müìä Schema test_schema_w20_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715700953,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715700954,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w20_v3\",public"}
 [32m‚úì[39m tests/unit/components/datavault/CellRenderer.test.tsx [2m([22m[2m12 tests[22m[2m)[22m[33m 4751[2mms[22m[39m
{"level":50,"time":1768715700999,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for non-existent user
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":30,"time":1768715701014,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39müìä Schema test_schema_w23_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w11_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w11_v3 (Reused: true)

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w24_v3, public
‚úÖ Enforced search_path: test_schema_w24_v3, public

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w0_v3
‚úÖ Current search_path: test_schema_w0_v3, public
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768715701384,"env":"test","module":"user-credentials-repository","userId":"f2f4c1d4-e5af-41d4-bd09-d34f24820097","msg":"User credentials created"}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

{"level":50,"time":1768715701483,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["f2f4c1d4-e5af-41d4-bd09-d34f24820097","f26ec39fcc0c82029a78454fc702142892f76c9089acd60606cbe96b471b2b20","2026-01-19T05:55:01.384Z"],"cause":{"length":383,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(f2f4c1d4-e5af-41d4-bd09-d34f24820097) is not present in table \"users\".","schema":"test_schema_w20_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w18_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w18_v3 (Reused: true)

{"level":50,"time":1768715701605,"env":"test","module":"auth-routes","email":"test-1768715700390-dkq7sh@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39müìä Schema test_schema_w11_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715701626,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715701627,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w11_v3\",public"}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

{"level":30,"time":1768715701674,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

{"level":50,"time":1768715701719,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768715701774,"env":"test","module":"auth-routes","email":"test-1768715700390-dkq7sh@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w20_v3, public
‚úÖ Enforced search_path: test_schema_w20_v3, public

{"level":50,"time":1768715701860,"env":"test","module":"auth-routes","email":"test-1768715701003-dk87w@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715701869,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715701869,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w23_v3\",public"}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w7_v3
‚úÖ Current search_path: test_schema_w24_v3, public
‚è© Schema reused, skipping migrations.

{"level":50,"time":1768715701894,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":30,"time":1768715701911,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768715701942,"env":"test","module":"auth-routes","email":"test-1768715701137-d8uzp@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39müìä Schema test_schema_w18_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715701996,"env":"test","msg":"DB: initializing... Local"}
{"level":50,"time":1768715701996,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768715701996,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w18_v3\",public"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 403 for unverified email
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768715702039,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":30,"time":1768715702040,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768715702044,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768715702054,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715702054,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/shared/validation/PageValidator.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 3920[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768715702350,"env":"test","module":"auth-routes","email":"test-1768715701594-ctghbv@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w25_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w25_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w11_v3, public
‚úÖ Enforced search_path: test_schema_w11_v3, public

{"level":50,"time":1768715702469,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould rotate refresh token on each use
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[DEBUG] BaseRepository.update datavault_tables: id=660e8400-e29b-41d4-a716-446655440001, updates={"name":"Updated Table","description":"Updated description","updatedAt":"2026-01-18T05:55:02.488Z"}
{"level":30,"time":1768715702492,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715702493,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/repositories/DatavaultTablesRepository.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 2947[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w1_v3
‚úÖ Current search_path: test_schema_w18_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m‚úÖ Set default search_path for database: test_schema_w23_v3, public
‚úÖ Enforced search_path: test_schema_w23_v3, public

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w23_v3
‚úÖ Current search_path: test_schema_w23_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w18_v3, public
‚úÖ Enforced search_path: test_schema_w18_v3, public

{"level":30,"time":1768715702860,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39müìä Schema test_schema_w25_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715702867,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715702868,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w25_v3\",public"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768715702903,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w8_v3
‚úÖ Current search_path: test_schema_w8_v3, public
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768715703013,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715703014,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768715703073,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715703073,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/workflow/PreviewExecution.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2910[2mms[22m[39m
 [31m‚ùØ[39m tests/integration/collections.e2e.test.ts [2m([22m[2m22 tests[22m[2m | [22m[31m21 failed[39m[2m)[22m[33m 4816[2mms[22m[39m
[31m       [31m√ó[31m should create a collection[39m[32m 204[2mms[22m[39m
[31m       [31m√ó[31m should list collections[39m[33m 413[2mms[22m[39m
[31m       [31m√ó[31m should get a collection by ID[39m[32m 55[2mms[22m[39m
[31m       [31m√ó[31m should update a collection[39m[32m 54[2mms[22m[39m
[31m       [31m√ó[31m should create text field[39m[32m 48[2mms[22m[39m
[31m       [31m√ó[31m should create email field[39m[32m 51[2mms[22m[39m
[31m       [31m√ó[31m should create number field[39m[32m 49[2mms[22m[39m
[31m       [31m√ó[31m should create select field with options[39m[32m 47[2mms[22m[39m
[31m       [31m√ó[31m should create boolean field[39m[32m 44[2mms[22m[39m
[31m       [31m√ó[31m should list all fields[39m[32m 61[2mms[22m[39m
[31m       [31m√ó[31m should update field[39m[32m 59[2mms[22m[39m
[31m       [31m√ó[31m should create a record[39m[32m 53[2mms[22m[39m
[31m       [31m√ó[31m should create multiple records[39m[32m 46[2mms[22m[39m
[31m       [31m√ó[31m should list records with pagination[39m[32m 46[2mms[22m[39m
[31m       [31m√ó[31m should get a single record[39m[32m 49[2mms[22m[39m
[31m       [31m√ó[31m should update a record[39m[32m 49[2mms[22m[39m
[31m       [31m√ó[31m should find records by filters[39m[32m 75[2mms[22m[39m
[31m       [31m√ó[31m should delete a record[39m[32m 48[2mms[22m[39m
[31m       [31m√ó[31m should list collections with stats[39m[32m 49[2mms[22m[39m
       [32m‚úì[39m should enforce required fields[32m 46[2mms[22m[39m
[31m       [31m√ó[31m should validate field types[39m[32m 49[2mms[22m[39m
[31m       [31m√ó[31m should delete collection (cascade fields and records)[39m[32m 46[2mms[22m[39m
{"level":50,"time":1768715703179,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w27_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w27_v3 (Reused: true)

{"level":50,"time":1768715703486,"env":"test","module":"auth-routes","email":"test-1768715703059-x74b4l@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

{"level":50,"time":1768715703579,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould detect and prevent refresh token reuse (token theft)
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/datavault.permissions.test.ts[2m > [22m[2mDataVault Table Permissions API (v4 Micro-Phase 6)
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/datavault.permissions.test.ts[2m > [22m[2mDataVault Table Permissions API (v4 Micro-Phase 6)
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768715703664,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768715703684,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts[2m > [22m[2mDataVault Table Permissions API (v4 Micro-Phase 6)
[22m[39müìö API Documentation available at /api-docs

{"level":30,"time":1768715703673,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768715703673,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768715703677,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768715703678,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768715703683,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768715703683,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768715703683,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768715703683,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w25_v3, public
‚úÖ Enforced search_path: test_schema_w25_v3, public

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w26_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":50,"time":1768715703750,"env":"test","module":"auth-routes","email":"test-1768715703000-amokpi@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w26_v3 (Reused: true)

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w10_v3
‚úÖ Current search_path: test_schema_w10_v3, public
‚è© Schema reused, skipping migrations.

{"level":50,"time":1768715703846,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39müìä Schema test_schema_w27_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

{"level":50,"time":1768715703899,"env":"test","module":"auth-routes","email":"test-1768715703000-amokpi@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768715703977,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768715704001,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39müìö API Documentation available at /api-docs

{"level":50,"time":1768715704002,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":30,"time":1768715703987,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768715703988,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768715703994,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768715703994,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768715704000,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768715704001,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768715704001,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768715704001,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768715704069,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715704070,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

 [32m‚úì[39m tests/ui/datavault/ColumnTypeIcon.test.tsx [2m([22m[2m27 tests[22m[2m)[22m[33m 3861[2mms[22m[39m
{"level":50,"time":1768715704160,"env":"test","module":"auth-routes","userId":"5dc9d81e6881c6006026ce611708c467","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768715704177,"env":"test","module":"user-credentials-repository","userId":"a77a3271-c69c-4ff3-8cca-31770f8ec437","msg":"User credentials created"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39müìä Schema test_schema_w26_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715704195,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715704196,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w26_v3\",public"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

{"level":30,"time":1768715704244,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768715704259,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["a77a3271-c69c-4ff3-8cca-31770f8ec437","6a0599e9da40e74f5abb68730a3afd85655470db6183afbaf133965173ceccb6","2026-01-19T05:55:04.179Z"],"cause":{"length":383,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(a77a3271-c69c-4ff3-8cca-31770f8ec437) is not present in table \"users\".","schema":"test_schema_w25_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768715704263,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:74:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstderr[2m | tests/integration/datavault.permissions.test.ts[2m > [22m[2mDataVault Table Permissions API (v4 Micro-Phase 6)
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/datavault.permissions.test.ts:22:11

{"level":30,"time":1768715704271,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715704271,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768715704320,"env":"test","module":"auth-routes","email":"test-1768715703000-amokpi@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768715704452,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768715704479,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["3f499306-c825-4131-b800-06b381778b7f","$2b$12$CND21bNN4B4CDbc2TxVmuuoumXBEjKmlFPL2SO7rbRqruKz.nazwG"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(3f499306-c825-4131-b800-06b381778b7f) is not present in table \"users\".","schema":"test_schema_w25_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"3f499306-c825-4131-b800-06b381778b7f","msg":"Failed to create user credentials"}
{"level":50,"time":1768715704479,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["3f499306-c825-4131-b800-06b381778b7f","$2b$12$CND21bNN4B4CDbc2TxVmuuoumXBEjKmlFPL2SO7rbRqruKz.nazwG"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(3f499306-c825-4131-b800-06b381778b7f) is not present in table \"users\".","schema":"test_schema_w25_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715704492,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768715704492,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768715704512,"env":"test","module":"auth-routes","email":"test-1768715703000-amokpi@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
 [31m‚ùØ[39m tests/integration/datavault.permissions.test.ts [2m([22m[2m22 tests[22m[2m | [22m[33m22 skipped[39m[2m)[22m[33m 3502[2mms[22m[39m
       [2m[90m‚Üì[39m[22m should allow owner to read table
       [2m[90m‚Üì[39m[22m should allow writer to read table
       [2m[90m‚Üì[39m[22m should allow reader to read table
       [2m[90m‚Üì[39m[22m should deny non-member from reading table
       [2m[90m‚Üì[39m[22m should allow owner to update table
       [2m[90m‚Üì[39m[22m should deny writer from updating table
       [2m[90m‚Üì[39m[22m should deny reader from updating table
       [2m[90m‚Üì[39m[22m should deny writer from deleting table
       [2m[90m‚Üì[39m[22m should deny reader from deleting table
       [2m[90m‚Üì[39m[22m should deny non-member from deleting table
       [2m[90m‚Üì[39m[22m should allow owner to view permissions
       [2m[90m‚Üì[39m[22m should deny writer from viewing permissions
       [2m[90m‚Üì[39m[22m should deny reader from viewing permissions
       [2m[90m‚Üì[39m[22m should allow owner to grant permissions
       [2m[90m‚Üì[39m[22m should allow owner to update existing permission (upsert)
       [2m[90m‚Üì[39m[22m should deny writer from granting permissions
       [2m[90m‚Üì[39m[22m should prevent modifying table owner permissions
       [2m[90m‚Üì[39m[22m should allow owner to revoke permissions
       [2m[90m‚Üì[39m[22m should deny writer from revoking permissions
       [2m[90m‚Üì[39m[22m should enforce owner includes write and read
       [2m[90m‚Üì[39m[22m should enforce write includes read but not owner
       [2m[90m‚Üì[39m[22m should enforce read is read-only
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w29_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768715704602,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715704603,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w27_v3\",public"}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":50,"time":1768715704618,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w29_v3 (Reused: true)

{"level":30,"time":1768715704656,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768715704671,"env":"test","module":"auth-routes","email":"test-1768715703000-amokpi@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
 [31m‚ùØ[39m tests/integration/auth/protected.routes.test.ts [2m([22m[2m33 tests[22m[2m | [22m[33m33 skipped[39m[2m)[22m[33m 3365[2mms[22m[39m
       [2m[90m‚Üì[39m[22m should allow access with valid Bearer token
       [2m[90m‚Üì[39m[22m should reject access without Authorization header
       [2m[90m‚Üì[39m[22m should reject access with empty Bearer token
       [2m[90m‚Üì[39m[22m should reject access with malformed Authorization header
       [2m[90m‚Üì[39m[22m should reject access with wrong token type
       [2m[90m‚Üì[39m[22m should allow POST with valid Bearer token
       [2m[90m‚Üì[39m[22m should reject POST without Bearer token
       [2m[90m‚Üì[39m[22m should reject POST with invalid token
       [2m[90m‚Üì[39m[22m should allow PUT with valid Bearer token
       [2m[90m‚Üì[39m[22m should reject PUT without Bearer token
       [2m[90m‚Üì[39m[22m should allow DELETE with valid Bearer token
       [2m[90m‚Üì[39m[22m should reject DELETE without Bearer token
       [2m[90m‚Üì[39m[22m should allow PATCH with valid Bearer token
       [2m[90m‚Üì[39m[22m should reject PATCH without Bearer token
       [2m[90m‚Üì[39m[22m should handle Bearer token with extra spaces
       [2m[90m‚Üì[39m[22m should handle token with newlines
       [2m[90m‚Üì[39m[22m should handle very long invalid token
       [2m[90m‚Üì[39m[22m should handle empty Authorization header
       [2m[90m‚Üì[39m[22m should handle Authorization header with only Bearer
       [2m[90m‚Üì[39m[22m should handle multiple Authorization headers
       [2m[90m‚Üì[39m[22m should reject token with SQL injection attempt
       [2m[90m‚Üì[39m[22m should reject token with XSS attempt
       [2m[90m‚Üì[39m[22m should reject token with missing userId
       [2m[90m‚Üì[39m[22m should reject token with non-existent userId
       [2m[90m‚Üì[39m[22m should not allow user to access another user's resources
       [2m[90m‚Üì[39m[22m should inject userId into request context
       [2m[90m‚Üì[39m[22m should inject tenantId into request context
       [2m[90m‚Üì[39m[22m should inject role into request context
       [2m[90m‚Üì[39m[22m should not apply general rate limiting to authenticated requests
       [2m[90m‚Üì[39m[22m should handle request with both Bearer token and cookies
       [2m[90m‚Üì[39m[22m should prioritize Bearer token over cookie when both present
       [2m[90m‚Üì[39m[22m should allow unauthenticated access to optional auth routes
       [2m[90m‚Üì[39m[22m should enhance optional auth routes with user context when authenticated
{"level":50,"time":1768715704800,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w22_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w22_v3 (Reused: true)

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w26_v3, public
‚úÖ Enforced search_path: test_schema_w26_v3, public

{"level":30,"time":1768715705075,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715705075,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39müìä Schema test_schema_w29_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715705083,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715705084,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w29_v3\",public"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w8_v3
‚úÖ Current search_path: test_schema_w8_v3, public
‚è© Schema reused, skipping migrations.

{"level":50,"time":1768715705121,"env":"test","module":"auth-routes","userId":"d71dc98c5778c15184c68f99c7c9cd2d","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768715705126,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

 [31m‚ùØ[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m13 failed[39m[2m)[22m[33m 12446[2mms[22m[39m
[31m       [31m√ó[31m should trust current device[39m[33m 371[2mms[22m[39m
[31m       [31m√ó[31m should set trust expiry to 30 days[39m[33m 801[2mms[22m[39m
[31m       [31m√ó[31m should update expiry if device already trusted[39m[33m 843[2mms[22m[39m
       [32m‚úì[39m should require authentication[32m 31[2mms[22m[39m
[31m       [31m√ó[31m should list all trusted devices[39m[33m 1185[2mms[22m[39m
[31m       [31m√ó[31m should mark current device[39m[33m 677[2mms[22m[39m
[31m       [31m√ó[31m should exclude revoked devices[39m[33m 684[2mms[22m[39m
[31m       [31m√ó[31m should exclude expired devices[39m[33m 692[2mms[22m[39m
[31m       [31m√ó[31m should revoke specific device[39m[33m 712[2mms[22m[39m
[31m       [31m√ó[31m should return 404 for non-existent device[39m[33m 844[2mms[22m[39m
[31m       [31m√ó[31m should prevent revoking other user's device[39m[33m 486[2mms[22m[39m
[31m       [31m√ó[31m should skip MFA for trusted device[39m[33m 768[2mms[22m[39m
[31m       [31m√ó[31m should require MFA for untrusted device[39m[33m 688[2mms[22m[39m
[31m       [31m√ó[31m should update lastUsedAt on trusted device login[39m[33m 693[2mms[22m[39m
{"level":50,"time":1768715705218,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould return 404 for non-existent session
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:74:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768715705226,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768715705290,"env":"test","module":"auth-routes","email":"test-1768715704499-e863kq@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39müìä Schema test_schema_w22_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715705372,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715705373,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w22_v3\",public"}
{"level":50,"time":1768715705387,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

{"level":30,"time":1768715705417,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768715705441,"env":"test","module":"auth-routes","email":"test-1768715704499-e863kq@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w27_v3, public
‚úÖ Enforced search_path: test_schema_w27_v3, public

{"level":30,"time":1768715705487,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715705488,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/regression-REG-1.test.ts [2m([22m[2m8 tests[22m[2m | [22m[33m8 skipped[39m[2m)[22m[33m 3455[2mms[22m[39m
       [2m[90m‚Üì[39m[22m should block Next when required visible question is empty
       [2m[90m‚Üì[39m[22m should NOT block Next when required question is hidden
       [2m[90m‚Üì[39m[22m should block when required becomes visible and is empty
       [2m[90m‚Üì[39m[22m should skip hidden required page entirely
       [2m[90m‚Üì[39m[22m should enforce required on visible page
       [2m[90m‚Üì[39m[22m should evaluate visibility consistently across modes
       [2m[90m‚Üì[39m[22m should handle malformed visibility expression gracefully
       [2m[90m‚Üì[39m[22m should handle missing variable in visibility expression
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w27_v3
‚úÖ Current search_path: test_schema_w27_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w31_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":50,"time":1768715705653,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768715705659,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w31_v3 (Reused: true)

{"level":30,"time":1768715705773,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w32_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w32_v3 (Reused: true)

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w29_v3, public
‚úÖ Enforced search_path: test_schema_w29_v3, public

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w8_v3
‚úÖ Current search_path: test_schema_w1_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39müìä Schema test_schema_w31_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w22_v3, public
‚úÖ Enforced search_path: test_schema_w22_v3, public

{"level":30,"time":1768715706218,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715706218,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w33_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w33_v3 (Reused: true)

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w34_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w1_v3
‚úÖ Current search_path: test_schema_w1_v3, public
‚è© Schema reused, skipping migrations.

 [31m‚ùØ[39m tests/integration/auth.flows.real.test.ts [2m([22m[2m11 tests[22m[2m | [22m[31m11 failed[39m[2m)[22m[33m 13591[2mms[22m[39m
[31m       [31m√ó[31m should complete registration, verify email, then login[39m[33m 463[2mms[22m[39m
[31m       [31m√ó[31m should lock account after 5 failed attempts, then unlock after waiting[39m[33m 705[2mms[22m[39m
[31m       [31m√ó[31m should record all login attempts[39m[33m 695[2mms[22m[39m
[31m       [31m√ó[31m should complete MFA setup and login with TOTP[39m[33m 1489[2mms[22m[39m
[31m       [31m√ó[31m should login with backup code when TOTP unavailable[39m[33m 1286[2mms[22m[39m
[31m       [31m√ó[31m should complete full password reset flow[39m[33m 1089[2mms[22m[39m
[31m       [31m√ó[31m should invalidate all sessions after password reset[39m[33m 318[2mms[22m[39m
[31m       [31m√ó[31m should rotate refresh token on each use[39m[33m 1465[2mms[22m[39m
[31m       [31m√ó[31m should detect and prevent refresh token reuse (token theft)[39m[33m 1114[2mms[22m[39m
[31m       [31m√ó[31m should list all active sessions[39m[33m 326[2mms[22m[39m
[31m       [31m√ó[31m should revoke specific session[39m[33m 1719[2mms[22m[39m
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39müìä Schema test_schema_w32_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w34_v3 (Reused: true)

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w28_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w28_v3 (Reused: true)

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715706658,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715706659,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w31_v3\",public"}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39müìä Schema test_schema_w33_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768715706695,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715706695,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768715706700,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768715706725,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715706726,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/unit/repositories/WorkflowTemplateRepository.test.ts [2m([22m[2m19 tests[22m[2m | [22m[31m19 failed[39m[2m)[22m[33m 16814[2mms[22m[39m
[31m       [31m√ó[31m should create a workflow template mapping[39m[33m 816[2mms[22m[39m
[31m       [31m√ó[31m should create non-primary mapping by default[39m[33m 691[2mms[22m[39m
[31m       [31m√ó[31m should find all templates for a workflow version[39m[33m 824[2mms[22m[39m
[31m       [31m√ó[31m should return empty array for version with no templates[39m[33m 715[2mms[22m[39m
[31m       [31m√ó[31m should order by createdAt desc (newest first)[39m[33m 695[2mms[22m[39m
[31m       [31m√ó[31m should find mapping by workflow version and key[39m[33m 719[2mms[22m[39m
[31m       [31m√ó[31m should return undefined for non-existent key[39m[33m 669[2mms[22m[39m
[31m       [31m√ó[31m should find primary template for workflow version[39m[33m 663[2mms[22m[39m
[31m       [31m√ó[31m should return undefined when no primary template exists[39m[33m 694[2mms[22m[39m
[31m       [31m√ó[31m should set a template as primary and unset others[39m[33m 935[2mms[22m[39m
[31m       [31m√ó[31m should handle setting primary when none existed before[39m[33m 695[2mms[22m[39m
[31m       [31m√ó[31m should not delete mapping if workflow version does not match[39m[33m 670[2mms[22m[39m
[31m       [31m√ó[31m should return true if key exists in workflow version[39m[33m 720[2mms[22m[39m
[31m       [31m√ó[31m should return false if key does not exist[39m[33m 683[2mms[22m[39m
[31m       [31m√ó[31m should exclude specified id when checking existence[39m[33m 697[2mms[22m[39m
[31m       [31m√ó[31m should return true if key exists on different mapping[39m[33m 693[2mms[22m[39m
[31m       [31m√ó[31m should update mapping fields[39m[33m 832[2mms[22m[39m
[31m       [31m√ó[31m should find mapping by id[39m[33m 695[2mms[22m[39m
[31m       [31m√ó[31m should return undefined for non-existent id[39m[33m 763[2mms[22m[39m
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39müìä Schema test_schema_w34_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

 [32m‚úì[39m tests/unit/HelperLibrary.test.ts [2m([22m[2m60 tests[22m[2m)[22m[33m 3676[2mms[22m[39m
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39müìä Schema test_schema_w28_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715706911,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715706955,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715706956,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w32_v3\",public"}
{"level":30,"time":1768715706912,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w28_v3\",public"}
{"level":30,"time":1768715706966,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768715706979,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715706979,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768715707003,"env":"test","msg":"DB: initialized flag set."}
 [31m‚ùØ[39m tests/unit/services/WorkflowTemplateService.test.ts [2m([22m[2m21 tests[22m[2m | [22m[31m20 failed[39m[2m)[22m[33m 16987[2mms[22m[39m
       [33m[2m‚úì[22m[39m should throw error if template belongs to different project [33m 861[2mms[22m[39m
[31m       [31m√ó[31m should automatically unset other primaries when setting new primary[39m[33m 545[2mms[22m[39m
[31m         [31m√ó[31m should list all templates for workflow version[39m[33m 591[2mms[22m[39m
[31m         [31m√ó[31m should return empty array for version with no templates[39m[33m 539[2mms[22m[39m
[31m         [31m√ó[31m should get template mapping by id and version[39m[33m 543[2mms[22m[39m
[31m         [31m√ó[31m should throw error if mapping not found[39m[33m 720[2mms[22m[39m
[31m         [31m√ó[31m should get template by key[39m[33m 674[2mms[22m[39m
[31m         [31m√ó[31m should throw error if key not found[39m[33m 859[2mms[22m[39m
[31m         [31m√ó[31m should get primary template for workflow version[39m[33m 561[2mms[22m[39m
[31m         [31m√ó[31m should return null when no primary template exists[39m[33m 668[2mms[22m[39m
[31m         [31m√ó[31m should update mapping key[39m[33m 731[2mms[22m[39m
[31m         [31m√ó[31m should update isPrimary flag[39m[33m 832[2mms[22m[39m
[31m         [31m√ó[31m should throw error if new key already exists[39m[33m 751[2mms[22m[39m
[31m         [31m√ó[31m should throw error if mapping not found[39m[33m 559[2mms[22m[39m
[31m         [31m√ó[31m should unset other primaries when setting isPrimary to true[39m[33m 658[2mms[22m[39m
[31m         [31m√ó[31m should detach template from workflow version[39m[33m 650[2mms[22m[39m
[31m         [31m√ó[31m should throw error if mapping not found[39m[33m 543[2mms[22m[39m
[31m         [31m√ó[31m should set template as primary[39m[33m 768[2mms[22m[39m
[31m         [31m√ó[31m should throw error if mapping not found[39m[33m 813[2mms[22m[39m
[31m         [31m√ó[31m should support operations within a transaction[39m[33m 587[2mms[22m[39m
[31m         [31m√ó[31m should rollback on transaction error[39m[33m 545[2mms[22m[39m
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

{"level":50,"time":1768715707212,"env":"test","module":"auth-routes","email":"test-1768715706460-verpbg@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768715707341,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould rotate refresh token after use
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":30,"time":1768715707400,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715707401,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w33_v3\",public"}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

{"level":30,"time":1768715707413,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768715707435,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests
[22m[39müìö API Documentation available at /api-docs

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715707424,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768715707425,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768715707430,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768715707431,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768715707435,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768715707435,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768715707435,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768715707435,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768715707447,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715707494,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715707495,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w34_v3\",public"}
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w31_v3, public
‚úÖ Enforced search_path: test_schema_w31_v3, public

{"level":30,"time":1768715707540,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w37_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":50,"time":1768715707597,"env":"test","module":"auth-routes","email":"test-1768715706820-weivik@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w31_v3
‚úÖ Current search_path: test_schema_w31_v3, public
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768715707616,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715707617,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w37_v3 (Reused: true)

 [31m‚ùØ[39m tests/integration/dynamic_options_workflow.test.ts [2m([22m[2m1 test[22m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 3400[2mms[22m[39m
     [2m[90m‚Üì[39m[22m should successfully configure a workflow with Read Table -> Dynamic Choice
{"level":50,"time":1768715707692,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould keep current session active
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w28_v3, public
‚úÖ Enforced search_path: test_schema_w28_v3, public

{"level":50,"time":1768715707745,"env":"test","module":"auth-routes","email":"test-1768715706820-weivik@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w32_v3, public
‚úÖ Enforced search_path: test_schema_w32_v3, public

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w26_v3
‚úÖ Current search_path: test_schema_w26_v3, public
‚è© Schema reused, skipping migrations.

{"level":50,"time":1768715707843,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould keep current session active
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w32_v3
‚úÖ Current search_path: test_schema_w32_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39müìä Schema test_schema_w37_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstderr[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests
[22m[39mCleanup error (non-fatal): DrizzleQueryError: Failed query: delete from "workflows" where  = $1
params: 06f77a20-d502-4738-9832-4c70a94a5867
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/api.runs.graph.test.ts:256:9 {
  query: [32m'delete from "workflows" where  = $1'[39m,
  params: [ [32m'06f77a20-d502-4738-9832-4c70a94a5867'[39m ],
  cause: error: syntax error at or near "="
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/api.runs.graph.test.ts:256:9 {
    length: [33m90[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42601'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'32'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'scan.l'[39m,
    line: [32m'1244'[39m,
    routine: [32m'scanner_yyerror'[39m
  }
}

{"level":30,"time":1768715708148,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715708148,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w35_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w33_v3, public
‚úÖ Enforced search_path: test_schema_w33_v3, public

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w35_v3 (Reused: true)

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w33_v3
‚úÖ Current search_path: test_schema_w33_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w34_v3, public
‚úÖ Enforced search_path: test_schema_w34_v3, public

 [31m‚ùØ[39m tests/integration/api.runs.graph.test.ts [2m([22m[2m19 tests[22m[2m | [22m[33m19 skipped[39m[2m)[22m[33m 3624[2mms[22m[39m
       [2m[90m‚Üì[39m[22m should list all runs with pagination
       [2m[90m‚Üì[39m[22m should filter runs by status
       [2m[90m‚Üì[39m[22m should filter runs by workflow
       [2m[90m‚Üì[39m[22m should filter runs by project
       [2m[90m‚Üì[39m[22m should filter runs by date range
       [2m[90m‚Üì[39m[22m should search runs by query string
       [2m[90m‚Üì[39m[22m should get run by ID with all details
       [2m[90m‚Üì[39m[22m should return 404 for non-existent run
       [2m[90m‚Üì[39m[22m should get logs for a run
       [2m[90m‚Üì[39m[22m should re-run workflow with same inputs
       [2m[90m‚Üì[39m[22m should re-run workflow with override inputs
       [2m[90m‚Üì[39m[22m should return 404 for non-existent run
       [2m[90m‚Üì[39m[22m should export runs to CSV
       [2m[90m‚Üì[39m[22m should export runs with filters applied
       [2m[90m‚Üì[39m[22m should compare two runs
       [2m[90m‚Üì[39m[22m should identify changed input keys
       [2m[90m‚Üì[39m[22m should return 404 if run A not found
       [2m[90m‚Üì[39m[22m should return 404 if run B not found
       [2m[90m‚Üì[39m[22m should enforce tenant isolation on runs list
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w36_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w34_v3
‚úÖ Current search_path: test_schema_w34_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w36_v3 (Reused: true)

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39müìä Schema test_schema_w35_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768715708646,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715708647,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w35_v3\",public"}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w38_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

{"level":30,"time":1768715708700,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w38_v3 (Reused: true)

{"level":30,"time":1768715708712,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715708746,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715708746,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w37_v3\",public"}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768715708763,"env":"test","module":"workflow-quality-validator","overall":99,"breakdown":{"aliases":100,"types":100,"structure":100,"ux":95,"completeness":100,"validation":100},"issuesCount":1,"passed":true,"msg":"Workflow quality validation completed"}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715708764,"env":"test","module":"workflow-generation-service","duration":5,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":99,"qualityBreakdown":{"aliases":100,"types":100,"structure":100,"ux":95,"completeness":100,"validation":100},"qualityPassed":true,"issuesCount":1,"msg":"AI workflow generation succeeded"}
{"level":50,"time":1768715708768,"env":"test","module":"workflow-generation-service","error":{"code":"VALIDATION_ERROR","message":"","retryable":false},"duration":1,"msg":"AI workflow generation failed"}
{"level":50,"time":1768715708771,"env":"test","module":"workflow-generation-service","error":{"code":"VALIDATION_ERROR","message":"","retryable":false},"duration":0,"msg":"AI workflow generation failed"}
{"level":50,"time":1768715708774,"env":"test","module":"workflow-generation-service","error":{"code":"VALIDATION_ERROR","message":"","retryable":false},"duration":1,"msg":"AI workflow generation failed"}
{"level":50,"time":1768715708776,"env":"test","module":"workflow-generation-service","error":{"status":429,"code":"rate_limit_exceeded"},"duration":0,"msg":"AI workflow generation failed"}
{"level":50,"time":1768715708777,"env":"test","module":"workflow-generation-service","error":{},"duration":0,"msg":"AI workflow generation failed"}
{"level":30,"time":1768715708780,"env":"test","module":"workflow-quality-validator","overall":100,"breakdown":{"aliases":100,"types":100,"structure":100,"ux":100,"completeness":100,"validation":100},"issuesCount":0,"passed":true,"msg":"Workflow quality validation completed"}
{"level":30,"time":1768715708780,"env":"test","module":"workflow-generation-service","duration":0,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":100,"qualityBreakdown":{"aliases":100,"types":100,"structure":100,"ux":100,"completeness":100,"validation":100},"qualityPassed":true,"issuesCount":0,"msg":"AI workflow generation succeeded"}
{"level":30,"time":1768715708782,"env":"test","module":"workflow-quality-validator","overall":96,"breakdown":{"aliases":100,"types":100,"structure":80,"ux":100,"completeness":90,"validation":100},"issuesCount":2,"passed":true,"msg":"Workflow quality validation completed"}
{"level":30,"time":1768715708783,"env":"test","module":"workflow-generation-service","duration":1,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":96,"qualityBreakdown":{"aliases":100,"types":100,"structure":80,"ux":100,"completeness":90,"validation":100},"qualityPassed":true,"issuesCount":2,"msg":"AI workflow generation succeeded"}
{"level":30,"time":1768715708785,"env":"test","module":"workflow-suggestion-service","duration":0,"suggestionsCount":1,"msg":"AI binding suggestion succeeded"}
{"level":30,"time":1768715708786,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768715708787,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768715708786,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

 [32m‚úì[39m tests/unit/ai.service.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 3539[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39müìä Schema test_schema_w36_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715708872,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715708873,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w36_v3\",public"}
{"level":30,"time":1768715708910,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768715709068,"env":"test","warnings":["Python code does not call emit(). Script will not produce output."],"msg":"Script validation warnings"}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715709071,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768715709071,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

 [32m‚úì[39m tests/unit/ScriptEngine.test.ts [2m([22m[2m26 tests[22m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 3613[2mms[22m[39m
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39müìä Schema test_schema_w38_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715709131,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715709132,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w38_v3\",public"}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w39_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768715709174,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w39_v3 (Reused: true)

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w40_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w40_v3 (Reused: true)

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768715709454,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715709454,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w35_v3, public
‚úÖ Enforced search_path: test_schema_w35_v3, public

 [32m‚úì[39m tests/integration/conditions/conditionEvaluation.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 3854[2mms[22m[39m
{"level":50,"time":1768715709538,"env":"test","module":"auth-routes","email":"test-1768715708793-2be7ud@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":30,"time":1768715709560,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715709560,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w37_v3, public
‚úÖ Enforced search_path: test_schema_w37_v3, public

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w0_v3
‚úÖ Current search_path: test_schema_w26_v3, public
‚è© Schema reused, skipping migrations.

 [32m‚úì[39m tests/unit/workflows/validation.test.ts [2m([22m[2m66 tests[22m[2m)[22m[33m 3646[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39müìä Schema test_schema_w39_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715709618,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715709619,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w39_v3\",public"}
{"level":50,"time":1768715709662,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all trusted devices
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w37_v3
‚úÖ Current search_path: test_schema_w37_v3, public
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768715709669,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w36_v3, public
‚úÖ Enforced search_path: test_schema_w36_v3, public

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39müìä Schema test_schema_w40_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w38_v3
‚úÖ Current search_path: test_schema_w26_v3, public
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768715709793,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715709793,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

 [31m‚ùØ[39m tests/integration/ai/workflowEdit.test.ts [2m([22m[2m8 tests[22m[2m | [22m[31m8 failed[39m[2m)[22m[33m 6457[2mms[22m[39m
[31m     [31m√ó[31m should create draft version on successful AI edit[39m[32m 53[2mms[22m[39m
[31m     [31m√ó[31m should enforce draft mode (revert active workflow to draft)[39m[33m 420[2mms[22m[39m
[31m     [31m√ó[31m should not create version when no changes detected (checksum match)[39m[33m 374[2mms[22m[39m
[31m     [31m√ó[31m should reject unauthorized access[39m[33m 385[2mms[22m[39m
[31m     [31m√ó[31m should reject unsafe DataVault operations[39m[33m 384[2mms[22m[39m
[31m     [31m√ó[31m should handle multi-operation edits with tempId resolution[39m[33m 419[2mms[22m[39m
[31m     [31m√ó[31m should create BEFORE and AFTER snapshots[39m[33m 387[2mms[22m[39m
[31m     [31m√ó[31m should rollback on validation failure[39m[33m 419[2mms[22m[39m
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w38_v3, public
‚úÖ Enforced search_path: test_schema_w38_v3, public

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w26_v3
‚úÖ Current search_path: test_schema_w39_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w43_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w43_v3 (Reused: true)

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w41_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w44_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w44_v3 (Reused: true)

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w39_v3, public
‚úÖ Enforced search_path: test_schema_w39_v3, public

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w41_v3 (Reused: true)

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715710463,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715710464,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w40_v3\",public"}
{"level":30,"time":1768715710496,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w38_v3
‚úÖ Current search_path: test_schema_w38_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w42_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ListTools.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w42_v3 (Reused: true)

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w30_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768715710809,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

{"level":30,"time":1768715710809,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39müìä Schema test_schema_w43_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

 [32m‚úì[39m tests/ui/blocks/SendDataBlockEditorRouting.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 3605[2mms[22m[39m
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w30_v3 (Reused: true)

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39müìä Schema test_schema_w44_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39müìä Schema test_schema_w41_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715710906,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715710907,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w41_v3\",public"}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768715710946,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39müìä Schema test_schema_w42_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715711068,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715711069,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w42_v3\",public"}
{"level":30,"time":1768715711087,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715711088,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768715711117,"env":"test","msg":"DB: initialized flag set."}
 [31m‚ùØ[39m tests/integration/datavault.autonumber.test.ts [2m([22m[2m5 tests[22m[2m | [22m[33m5 skipped[39m[2m)[22m[33m 3113[2mms[22m[39m
     [2m[90m‚Üì[39m[22m should generate basic autonumber without prefix
     [2m[90m‚Üì[39m[22m should generate autonumber with prefix
     [2m[90m‚Üì[39m[22m should generate autonumber with yearly reset format
     [2m[90m‚Üì[39m[22m should be atomic and prevent race conditions
     [2m[90m‚Üì[39m[22m should prevent manual updates to autonumber values
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w45_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w45_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39müìä Schema test_schema_w30_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715711273,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715711273,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w30_v3\",public"}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w40_v3, public
‚úÖ Enforced search_path: test_schema_w40_v3, public

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

{"level":30,"time":1768715711316,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715711368,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715711369,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w43_v3\",public"}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w40_v3
‚úÖ Current search_path: test_schema_w40_v3, public
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768715711403,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715711519,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715711520,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w44_v3\",public"}
{"level":30,"time":1768715711555,"env":"test","msg":"DB: initialized flag set."}
[DEBUG] BaseRepository.update datavault_columns: id=770e8400-e29b-41d4-a716-446655440002, updates={"name":"Mobile Phone","required":true,"updatedAt":"2026-01-18T05:55:11.667Z"}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39müìä Schema test_schema_w45_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715711669,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715711671,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768715711670,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w45_v3\",public"}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715711671,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768715711686,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768715711690,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
 [32m‚úì[39m tests/unit/repositories/DatavaultColumnsRepository.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 2886[2mms[22m[39m
{"level":30,"time":1768715711708,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768715711723,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715711724,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w41_v3, public
‚úÖ Enforced search_path: test_schema_w41_v3, public

 [31m‚ùØ[39m tests/integration/externalSends.test.ts [2m([22m[2m2 tests[22m[2m | [22m[33m2 skipped[39m[2m)[22m[33m 3913[2mms[22m[39m
     [2m[90m‚Üì[39m[22m PREVIEW MODE: Should simulate send and NOT call fetch
     [2m[90m‚Üì[39m[22m LIVE MODE: Should call fetch with mapped payload
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w38_v3
‚úÖ Current search_path: test_schema_w30_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w42_v3, public
‚úÖ Enforced search_path: test_schema_w42_v3, public

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w38_v3
‚úÖ Current search_path: test_schema_w0_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w30_v3, public
‚úÖ Enforced search_path: test_schema_w30_v3, public

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w43_v3, public
‚úÖ Enforced search_path: test_schema_w43_v3, public

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w45_v3
‚úÖ Current search_path: test_schema_w45_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w43_v3
‚úÖ Current search_path: test_schema_w43_v3, public
‚è© Schema reused, skipping migrations.

{"level":50,"time":1768715712327,"env":"test","module":"auth-routes","email":"test-1768715711504-cuawdg@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w44_v3, public
‚úÖ Enforced search_path: test_schema_w44_v3, public

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w44_v3
‚úÖ Current search_path: test_schema_w44_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w45_v3, public
‚úÖ Enforced search_path: test_schema_w45_v3, public

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w47_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w47_v3 (Reused: true)

{"level":50,"time":1768715712538,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould store hashed backup codes
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768715712562,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768715712565,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715712566,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w10_v3
‚úÖ Current search_path: test_schema_w8_v3, public
‚è© Schema reused, skipping migrations.

 [32m‚úì[39m tests/unit/listPipeline.semantics.test.ts [2m([22m[2m70 tests[22m[2m)[22m[33m 3719[2mms[22m[39m
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w46_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":50,"time":1768715712864,"env":"test","module":"auth-routes","email":"test-1768715712083-9qhquf@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w46_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39müìä Schema test_schema_w47_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715712960,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715712961,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w47_v3\",public"}
{"level":30,"time":1768715713000,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

{"level":50,"time":1768715713070,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould track session activity timestamps
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768715713076,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":40,"time":1768715713133,"env":"test","sourceListVar":"nonexistent_list","inputKey":"nonexistent_list","msg":"Input list not found, treating as empty array"}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715713134,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768715713135,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w49_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32m‚úì[39m tests/ListTools.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 2891[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w49_v3 (Reused: true)

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39müìä Schema test_schema_w46_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715713299,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715713299,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39m[DEBUG] Database initialized.

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

{"level":30,"time":1768715713354,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768715713378,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39müìö API Documentation available at /api-docs

{"level":30,"time":1768715713366,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768715713367,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768715713372,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768715713372,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768715713377,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768715713377,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768715713378,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768715713378,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w50_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [31m‚ùØ[39m tests/integration/auth.routes.real.test.ts [2m([22m[2m26 tests[22m[2m | [22m[31m16 failed[39m[2m)[22m[33m 20670[2mms[22m[39m
[31m       [31m√ó[31m should register a new user successfully[39m[33m 809[2mms[22m[39m
       [32m‚úì[39m should return 400 for invalid email format[32m 9[2mms[22m[39m
       [32m‚úì[39m should return 400 for weak password[32m 9[2mms[22m[39m
[31m       [31m√ó[31m should return 409 for duplicate email[39m[33m 1514[2mms[22m[39m
[31m       [31m√ó[31m should set httpOnly refresh token cookie[39m[33m 725[2mms[22m[39m
[31m       [31m√ó[31m should login with valid credentials[39m[33m 706[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for invalid password [33m 1636[2mms[22m[39m
       [32m‚úì[39m should return 401 for non-existent user[32m 166[2mms[22m[39m
[31m       [31m√ó[31m should return 403 for unverified email[39m[33m 996[2mms[22m[39m
[31m       [31m√ó[31m should record failed login attempt[39m[33m 315[2mms[22m[39m
[31m       [31m√ó[31m should return requiresMfa=true for MFA-enabled users[39m[33m 686[2mms[22m[39m
[31m       [31m√ó[31m should lock account after 5 failed attempts[39m[33m 2372[2mms[22m[39m
[31m       [31m√ó[31m should logout and clear refresh token cookie[39m[33m 389[2mms[22m[39m
[31m       [31m√ó[31m should refresh access token with valid refresh token[39m[33m 690[2mms[22m[39m
       [32m‚úì[39m should return 401 for missing refresh token[32m 8[2mms[22m[39m
[31m       [31m√ó[31m should rotate refresh token after use[39m[33m 1453[2mms[22m[39m
       [33m[2m‚úì[22m[39m should send password reset email for existing user [33m 1066[2mms[22m[39m
       [32m‚úì[39m should not reveal if email exists (security)[32m 48[2mms[22m[39m
[31m       [31m√ó[31m should reset password with valid token[39m[33m 1098[2mms[22m[39m
       [32m‚úì[39m should return 400 for invalid token[32m 57[2mms[22m[39m
[31m       [31m√ó[31m should return 400 for weak new password[39m[33m 1125[2mms[22m[39m
[31m       [31m√ó[31m should return current user for valid token[39m[33m 374[2mms[22m[39m
       [32m‚úì[39m should return 401 for missing token[32m 5[2mms[22m[39m
       [32m‚úì[39m should return 401 for invalid token[32m 4[2mms[22m[39m
[31m         [31m√ó[31m should complete MFA login with valid TOTP code[39m[33m 919[2mms[22m[39m
[31m         [31m√ó[31m should reject invalid MFA code[39m[33m 687[2mms[22m[39m
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768715713423,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715713424,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w50_v3 (Reused: true)

 [32m‚úì[39m tests/unit/workflow/QueryBlock.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 3489[2mms[22m[39m
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstderr[2m | tests/unit/shared/conditionEvaluator.test.ts[2m > [22m[2mconditionEvaluator[2m > [22m[2mComparison operators[2m > [22m[2mUnknown operator[2m > [22m[2mshould default to true and log warning
[22m[39mUnknown operator: unknown_operator

{"level":30,"time":1768715713622,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715713623,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39müìä Schema test_schema_w49_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715713658,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715713659,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w49_v3\",public"}
 [32m‚úì[39m tests/unit/shared/conditionEvaluator.test.ts [2m([22m[2m70 tests[22m[2m)[22m[33m 3605[2mms[22m[39m
{"level":30,"time":1768715713671,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715713672,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768715713698,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715713698,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768715713712,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/services/EmailTemplateMetadataService.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 2870[2mms[22m[39m
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w47_v3, public
‚úÖ Enforced search_path: test_schema_w47_v3, public

 [31m‚ùØ[39m tests/integration/session.management.real.test.ts [2m([22m[2m18 tests[22m[2m | [22m[31m17 failed[39m[2m)[22m[33m 21044[2mms[22m[39m
[31m       [31m√ó[31m should list all active sessions for current user[39m[33m 1678[2mms[22m[39m
[31m       [31m√ó[31m should mark current session correctly[39m[33m 1433[2mms[22m[39m
[31m       [31m√ó[31m should exclude revoked sessions[39m[33m 1380[2mms[22m[39m
[31m       [31m√ó[31m should order sessions by last used (most recent first)[39m[33m 334[2mms[22m[39m
[31m       [31m√ó[31m should filter sessions by current user only[39m[33m 2784[2mms[22m[39m
       [32m‚úì[39m should return 401 for unauthenticated request[32m 7[2mms[22m[39m
[31m       [31m√ó[31m should revoke specific session[39m[33m 362[2mms[22m[39m
[31m       [31m√ó[31m should prevent revoking current session[39m[33m 726[2mms[22m[39m
[31m       [31m√ó[31m should return 404 for non-existent session[39m[33m 1534[2mms[22m[39m
[31m       [31m√ó[31m should prevent revoking other user's session[39m[33m 351[2mms[22m[39m
[31m       [31m√ó[31m should revoke all other sessions[39m[33m 665[2mms[22m[39m
[31m       [31m√ó[31m should keep current session active[39m[33m 1615[2mms[22m[39m
[31m       [31m√ó[31m should return 400 if no active session found[39m[33m 358[2mms[22m[39m
[31m       [31m√ó[31m should revoke all trusted devices[39m[33m 1592[2mms[22m[39m
[31m       [31m√ó[31m should handle user with single session gracefully[39m[33m 339[2mms[22m[39m
[31m       [31m√ó[31m should include device metadata in sessions[39m[33m 655[2mms[22m[39m
[31m       [31m√ó[31m should not expose sensitive token data[39m[33m 704[2mms[22m[39m
[31m       [31m√ó[31m should track session activity timestamps[39m[33m 1588[2mms[22m[39m
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39müìä Schema test_schema_w50_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w41_v3
‚úÖ Current search_path: test_schema_w41_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":30,"time":1768715713959,"env":"test","module":"user-credentials-repository","userId":"65fbb11a-638b-419f-81c6-2abfc3a24dd2","msg":"User credentials created"}
{"level":30,"time":1768715714120,"env":"test","module":"email-queue","jobId":"bcfe0a1a-62a1-4ef7-b5de-ee20ad7e8fb7","to":"test-8Z1bW_tQA8EyYaFQweGhN@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768715714208,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["65fbb11a-638b-419f-81c6-2abfc3a24dd2","570d47ddeabb3280f71ab578f5819af067fee9cc4c084e7cbfab9fbf03826db3","2026-02-17T05:55:14.125Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-18T05:55:14.126Z"],"cause":{"length":339,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(65fbb11a-638b-419f-81c6-2abfc3a24dd2) is not present in table \"users\".","schema":"test_schema_w49_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/jwt.authentication.test.ts:31:15

{"level":30,"time":1768715714223,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715714224,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715714298,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715714300,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w46_v3\",public"}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768715714358,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w52_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w48_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w52_v3 (Reused: true)

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w48_v3 (Reused: true)

 [31m‚ùØ[39m tests/integration/auth/jwt.authentication.test.ts [2m([22m[2m27 tests[22m[2m | [22m[33m27 skipped[39m[2m)[22m[33m 3804[2mms[22m[39m
       [2m[90m‚Üì[39m[22m should generate valid JWT token on successful login
       [2m[90m‚Üì[39m[22m should include correct payload in JWT token
       [2m[90m‚Üì[39m[22m should set JWT expiry to 15 minutes
       [2m[90m‚Üì[39m[22m should accept valid JWT token on protected routes
       [2m[90m‚Üì[39m[22m should reject request without authorization header
       [2m[90m‚Üì[39m[22m should reject request with malformed token
       [2m[90m‚Üì[39m[22m should accept request with missing Bearer prefix (lenient)
       [2m[90m‚Üì[39m[22m should reject token with invalid signature
       [2m[90m‚Üì[39m[22m should reject expired JWT token
       [2m[90m‚Üì[39m[22m should return token_expired error code for expired tokens
       [2m[90m‚Üì[39m[22m should authenticate with Bearer token in Authorization header
       [2m[90m‚Üì[39m[22m should work with Bearer token on POST requests
       [2m[90m‚Üì[39m[22m should work with Bearer token on PUT requests
       [2m[90m‚Üì[39m[22m should work with Bearer token on DELETE requests
       [2m[90m‚Üì[39m[22m should exchange valid session cookie for JWT token
       [2m[90m‚Üì[39m[22m should reject token exchange without valid cookie
       [2m[90m‚Üì[39m[22m should prefer Bearer token over cookie when both present
       [2m[90m‚Üì[39m[22m should fall back to cookie if Bearer token is invalid
       [2m[90m‚Üì[39m[22m should allow GET requests with cookie auth only
       [2m[90m‚Üì[39m[22m should reject POST requests with cookie auth only (mutation-strict)
       [2m[90m‚Üì[39m[22m should allow anonymous access to public workflows
       [2m[90m‚Üì[39m[22m should attach user info if authenticated on optional auth routes
       [2m[90m‚Üì[39m[22m should refresh access token using refresh token
       [2m[90m‚Üì[39m[22m should rotate refresh token on use
       [2m[90m‚Üì[39m[22m should detect token reuse and revoke all user tokens
       [2m[90m‚Üì[39m[22m should revoke refresh token on logout
       [2m[90m‚Üì[39m[22m should clear refresh token cookie on logout
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w49_v3, public
‚úÖ Enforced search_path: test_schema_w49_v3, public

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w53_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w47_v3
‚úÖ Current search_path: test_schema_w47_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w53_v3 (Reused: true)

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715714655,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715714656,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w50_v3\",public"}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w54_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768715714710,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w54_v3 (Reused: true)

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w55_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w55_v3 (Reused: true)

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39müìä Schema test_schema_w52_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39müìä Schema test_schema_w48_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715715010,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715715011,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39müìä Schema test_schema_w53_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

 [31m‚ùØ[39m tests/integration/organizations-workflow.test.ts [2m([22m[2m23 tests[22m[2m | [22m[31m14 failed[39m[2m)[22m[33m 4983[2mms[22m[39m
[31m       [31m√ó[31m Step 1: Create organization[39m[32m 59[2mms[22m[39m
[31m       [31m√ó[31m Step 2: Invite member via email[39m[32m 53[2mms[22m[39m
[31m       [31m√ó[31m Step 3: Accept invite[39m[32m 45[2mms[22m[39m
[31m       [31m√ó[31m Step 4: Create workflow owned by user[39m[32m 179[2mms[22m[39m
[31m       [31m√ó[31m Step 5: Transfer workflow to organization[39m[32m 133[2mms[22m[39m
[31m       [31m√ó[31m Step 6: Org member (user2) can access workflow[39m[32m 100[2mms[22m[39m
[31m       [31m√ó[31m Step 7: Org member (user2) can update workflow[39m[32m 95[2mms[22m[39m
[31m       [31m√ó[31m Step 8: Org admin (user1) can still access workflow after transfer[39m[32m 99[2mms[22m[39m
       [32m‚úì[39m Step 9: Non-member (user3) CANNOT access org workflow[32m 107[2mms[22m[39m
       [32m‚úì[39m Step 10: Non-member (user3) CANNOT update org workflow[32m 95[2mms[22m[39m
       [32m‚úì[39m Step 11: Non-member (user3) CANNOT transfer org workflow[32m 96[2mms[22m[39m
[31m       [31m√ó[31m Step 12: Org member can see workflow in list[39m[32m 106[2mms[22m[39m
       [32m‚úì[39m Step 13: Non-member CANNOT see workflow in list[32m 92[2mms[22m[39m
[31m       [31m√ó[31m Step 14: Remove member from org[39m[32m 46[2mms[22m[39m
       [32m‚úì[39m Step 15: Removed member (user2) can no longer access workflow[32m 97[2mms[22m[39m
[31m       [31m√ó[31m Step 16: Re-add member and verify access restored[39m[32m 51[2mms[22m[39m
[31m       [31m√ó[31m Cannot invite same email twice (pending invite exists)[39m[32m 49[2mms[22m[39m
[31m       [31m√ó[31m Cannot accept expired invite[39m[32m 52[2mms[22m[39m
[31m       [31m√ó[31m Cannot transfer workflow to org user is not a member of[39m[32m 47[2mms[22m[39m
       [32m‚úì[39m Member cannot promote themselves to admin[32m 46[2mms[22m[39m
       [32m‚úì[39m Member cannot remove admin[32m 49[2mms[22m[39m
       [32m‚úì[39m Only members can view organization details[32m 51[2mms[22m[39m
       [32m‚úì[39m Only members can view organization members list[32m 50[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39müìä Schema test_schema_w54_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m‚úÖ Set default search_path for database: test_schema_w46_v3, public
‚úÖ Enforced search_path: test_schema_w46_v3, public

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39müìä Schema test_schema_w55_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w46_v3
‚úÖ Current search_path: test_schema_w46_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

{"level":30,"time":1768715715445,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":30,"time":1768715715445,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w51_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

 [31m‚ùØ[39m tests/integration/analytics_preservation.test.ts [2m([22m[2m1 test[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 3362[2mms[22m[39m
[31m     [31m√ó[31m should preserve lifetime user count when a user is deleted[39m[33m 436[2mms[22m[39m
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w51_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w50_v3, public
‚úÖ Enforced search_path: test_schema_w50_v3, public

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w50_v3
‚úÖ Current search_path: test_schema_w50_v3, public
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768715715771,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715715772,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715715775,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715715776,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w52_v3\",public"}
 [32m‚úì[39m tests/unit/repositories/DocumentTemplateRepository.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 2975[2mms[22m[39m
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715715841,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715715842,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w48_v3\",public"}
{"level":30,"time":1768715715842,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715715881,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715715882,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w53_v3\",public"}
{"level":30,"time":1768715715901,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39müìä Schema test_schema_w51_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715715933,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715715934,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w51_v3\",public"}
{"level":30,"time":1768715715937,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768715715986,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould accept TOTP codes within 60-second window
[22m[39m[TEST UTILS] MFA Secret verified for 084f5420d46b0823d4e6155246929b15

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715716049,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715716050,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w54_v3\",public"}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m‚úÖ Applied failsafe schema fixes

{"level":30,"time":1768715716102,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715716168,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715716169,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w55_v3\",public"}
{"level":30,"time":1768715716218,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

{"level":30,"time":1768715716404,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715716405,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/ui/blocks/SendDataToTableBlockEditor.test.tsx [2m([22m[2m12 tests[22m[2m)[22m[33m 4112[2mms[22m[39m
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w59_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w57_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w59_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w57_v3 (Reused: true)

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w52_v3, public
‚úÖ Enforced search_path: test_schema_w52_v3, public

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m‚úÖ Set default search_path for database: test_schema_w48_v3, public
‚úÖ Enforced search_path: test_schema_w48_v3, public

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w52_v3
‚úÖ Current search_path: test_schema_w52_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w53_v3, public
‚úÖ Enforced search_path: test_schema_w53_v3, public

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w60_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mreviseWorkflow should delegate to revision service
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mWorkflow Generation[2m > [22m[2mgenerateWorkflow should return a generated workflow
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w51_v3, public
‚úÖ Enforced search_path: test_schema_w51_v3, public

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mWorkflow Suggestions[2m > [22m[2msuggestWorkflowImprovements should return suggestions
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mWorkflow Suggestions[2m > [22m[2msuggestTemplateBindings should return bindings
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mWorkflow Suggestions[2m > [22m[2msuggestValues should return values
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mLogic Analysis[2m > [22m[2mgenerateLogic should return logic rules
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mLogic Analysis[2m > [22m[2mdebugLogic should return issues
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mLogic Analysis[2m > [22m[2mvisualizeLogic should return graph data
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

{"level":30,"time":1768715716761,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715716761,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w48_v3
‚úÖ Current search_path: test_schema_w48_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w60_v3 (Reused: true)

 [32m‚úì[39m tests/unit/services/AIService.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 3734[2mms[22m[39m
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w53_v3
‚úÖ Current search_path: test_schema_w53_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w38_v3
‚úÖ Current search_path: test_schema_w38_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w54_v3, public
‚úÖ Enforced search_path: test_schema_w54_v3, public

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w58_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w58_v3 (Reused: true)

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39müìä Schema test_schema_w59_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39müìä Schema test_schema_w57_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715716999,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715717000,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w57_v3\",public"}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w54_v3
‚úÖ Current search_path: test_schema_w54_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w55_v3, public
‚úÖ Enforced search_path: test_schema_w55_v3, public

{"level":30,"time":1768715717045,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w55_v3
‚úÖ Current search_path: test_schema_w55_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w56_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39müìä Schema test_schema_w60_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w56_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39müìä Schema test_schema_w58_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715717412,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715717413,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w58_v3\",public"}
{"level":30,"time":1768715717450,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715717625,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715717626,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w59_v3\",public"}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39müìä Schema test_schema_w56_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715717631,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715717632,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w56_v3\",public"}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

{"level":30,"time":1768715717667,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768715717676,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715717765,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715717766,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w60_v3\",public"}
{"level":30,"time":1768715717799,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w57_v3, public
‚úÖ Enforced search_path: test_schema_w57_v3, public

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w61_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w61_v3 (Reused: true)

{"level":30,"time":1768715717904,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715717904,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w58_v3
‚úÖ Current search_path: test_schema_w58_v3, public
‚è© Schema reused, skipping migrations.

 [32m‚úì[39m tests/integration/mfa.flow.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 3943[2mms[22m[39m
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

{"level":30,"time":1768715717969,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768715717995,"env":"test","module":"ai-controller","userId":"user-123","workflowId":"123e4567-e89b-12d3-a456-426614174000","msg":"AI workflow revision job enqueued"}
{"level":30,"time":1768715718006,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":50,"time":1768715718012,"env":"test","module":"ai-controller","error":{"issues":[{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["workflowId"]},{"code":"invalid_type","expected":"object","received":"undefined","path":["currentWorkflow"],"message":"Required"},{"code":"invalid_type","expected":"string","received":"undefined","path":["userInstruction"],"message":"Required"}],"name":"ZodError"},"msg":"Failed to enqueue AI revision job"}
{"level":30,"time":1768715718015,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768715718016,"env":"test","module":"workflow-patch-service","error":{},"op":{"op":"step.create","sectionRef":"temp-section-1","type":"short_text","title":"Field 1","alias":"field1"},"msg":"Failed to apply operation"}
{"level":30,"time":1768715718016,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768715718022,"env":"test","module":"workflow-patch-service","error":{},"op":{"op":"document.bindFields","id":"template-123","bindings":{"client_name":"nonExistentAlias"}},"msg":"Failed to apply operation"}
{"level":30,"time":1768715718024,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768715718024,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/services/WorkflowPatchService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 3851[2mms[22m[39m
 [32m‚úì[39m tests/unit/api.ai.revise.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 2975[2mms[22m[39m
{"level":30,"time":1768715718182,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715718183,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject invalid token
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,75625ef9-0ec9-4ce0-9760-78478f340c13,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'75625ef9-0ec9-4ce0-9760-78478f340c13'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m521[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (1c9f0aae-bf0e-4ea6-a77a-8fc42cc42345, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, 75625ef9-0ec9-4ce0-9760-78478f340c13, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-18 05:55:19.340708, 2026-01-18 05:55:19.340708).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w38_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w58_v3, public
‚úÖ Enforced search_path: test_schema_w58_v3, public

 [32m‚úì[39m tests/unit/utils/pagination.test.ts [2m([22m[2m24 tests[22m[2m)[22m[33m 3876[2mms[22m[39m
[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768715718297,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715718298,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w28_v3
‚úÖ Current search_path: test_schema_w28_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39müìä Schema test_schema_w61_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

 [32m‚úì[39m tests/ui/builder.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 3931[2mms[22m[39m
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w62_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w62_v3 (Reused: true)

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m‚ö†Ô∏è Could not set database-level search_path (expected in cloud DBs): tuple concurrently updated
‚úÖ Enforced search_path: test_schema_w56_v3, public

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w59_v3, public
‚úÖ Enforced search_path: test_schema_w59_v3, public

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w57_v3
‚úÖ Current search_path: test_schema_w28_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w59_v3
‚úÖ Current search_path: test_schema_w59_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w60_v3, public
‚úÖ Enforced search_path: test_schema_w60_v3, public

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w60_v3
‚úÖ Current search_path: test_schema_w60_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768715718809,"env":"test","module":"auth-routes","userId":"3a798b61173ef0bf90ae5c24c4044530","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39müìä Schema test_schema_w62_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715718824,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715718826,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w62_v3\",public"}
{"level":30,"time":1768715718869,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

{"level":50,"time":1768715719018,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould prevent backup code reuse
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:74:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768715719025,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

{"level":30,"time":1768715719088,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715719088,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/unit/services/CollectionFieldService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 2992[2mms[22m[39m
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w61_v3, public
‚úÖ Enforced search_path: test_schema_w61_v3, public

[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mError Handling[2m > [22m[2mreverts value on save error
[22m[39mFailed to save cell: Error: Network error
    at C:/Users/scoot/poll/VaultLogic/tests/ui/datavault/EditableCell.test.tsx:206:36
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w61_v3
‚úÖ Current search_path: test_schema_w61_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mError Handling[2m > [22m[2mdisplays error indicator on save failure
[22m[39mFailed to save cell: Error: Network error
    at C:/Users/scoot/poll/VaultLogic/tests/ui/datavault/EditableCell.test.tsx:222:36
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w64_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w64_v3 (Reused: true)

[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mBoolean Type (Checkbox)[2m > [22m[2mshows loading spinner when saving checkbox
[22m[39mWarning: An update to EditableCell inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at EditableCell (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/EditableCell.tsx:12:25)

[90mstderr[2m | tests/unit/debugging/Lineage.test.ts[2m > [22m[2mDebug & Lineage[2m > [22m[2mshould generate execution trace with lineage
[22m[39m[DEBUG Question] Node q1 executed. Key: userName, Value: Alice. Context keys: 3

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w62_v3, public
‚úÖ Enforced search_path: test_schema_w62_v3, public

{"level":30,"time":1768715719658,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715719659,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768715719728,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715719729,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w61_v3
‚úÖ Current search_path: test_schema_w61_v3, public
‚è© Schema reused, skipping migrations.

 [32m‚úì[39m tests/unit/debugging/Lineage.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 2855[2mms[22m[39m
 [32m‚úì[39m tests/unit/engine/Performance.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 3618[2mms[22m[39m
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w66_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768715719784,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768715719784,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w66_v3 (Reused: true)

 [32m‚úì[39m tests/unit/services/RunExecutionCoordinator.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 3410[2mms[22m[39m
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768715719991,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715719992,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39müìä Schema test_schema_w64_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715720082,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715720083,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w64_v3\",public"}
 [32m‚úì[39m tests/ui/datavault/EditableCell.test.tsx [2m([22m[2m29 tests[22m[2m)[22m[33m 6038[2mms[22m[39m
{"level":30,"time":1768715720139,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39müìä Schema test_schema_w66_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715720256,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768715720257,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w66_v3\",public"}
{"level":30,"time":1768715720310,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w69_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w69_v3 (Reused: true)

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w65_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w65_v3 (Reused: true)

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w64_v3, public
‚úÖ Enforced search_path: test_schema_w64_v3, public

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w64_v3
‚úÖ Current search_path: test_schema_w64_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w66_v3, public
‚úÖ Enforced search_path: test_schema_w66_v3, public

{"level":50,"time":1768715721132,"env":"test","module":"auth-routes","email":"test-1768715720332-yo26qo@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39müìä Schema test_schema_w69_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w38_v3
‚úÖ Current search_path: test_schema_w58_v3, public
‚è© Schema reused, skipping migrations.

{"level":50,"time":1768715721262,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Status[2m > [22m[2mshould return MFA status for user
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768715721269,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39müìä Schema test_schema_w65_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w71_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768715721464,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715721465,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w71_v3 (Reused: true)

 [31m‚ùØ[39m tests/integration/workflow_versioning.test.ts [2m([22m[2m3 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 4901[2mms[22m[39m
     [32m‚úì[39m should diff two versions correctly[32m 3[2mms[22m[39m
[31m     [31m√ó[31m should create a version and populate changelog[39m[33m 534[2mms[22m[39m
[31m     [31m√ó[31m should track execution lineage via snapshot[39m[33m 385[2mms[22m[39m
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w72_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w72_v3 (Reused: true)

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39müìä Schema test_schema_w71_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715721906,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715721907,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w71_v3\",public"}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715721943,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715721944,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w69_v3\",public"}
{"level":30,"time":1768715721954,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

{"level":30,"time":1768715721996,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":30,"time":1768715722142,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768715722143,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768715722152,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715722153,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39müìä Schema test_schema_w72_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715722181,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715722183,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w72_v3\",public"}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715722184,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715722185,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w65_v3\",public"}
 [32m‚úì[39m tests/unit/schema/collections.test.ts [2m([22m[2m34 tests[22m[2m)[22m[33m 2993[2mms[22m[39m
 [31m‚ùØ[39m tests/integration/organizationInvites.test.ts [2m([22m[2m17 tests[22m[2m | [22m[31m16 failed[39m[2m)[22m[33m 13853[2mms[22m[39m
[31m       [31m√ó[31m should create placeholder user for non-existent email[39m[33m 637[2mms[22m[39m
[31m       [31m√ó[31m should create invite for existing user without creating placeholder[39m[33m 588[2mms[22m[39m
[31m       [31m√ó[31m should prevent duplicate pending invites[39m[33m 628[2mms[22m[39m
[31m       [31m√ó[31m should prevent inviting existing members[39m[33m 336[2mms[22m[39m
[31m       [31m√ó[31m should require admin access to create invite[39m[33m 752[2mms[22m[39m
[31m       [31m√ó[31m should set expiry to 7 days from now[39m[33m 612[2mms[22m[39m
[31m       [31m√ó[31m should accept invite and create membership[39m[33m 798[2mms[22m[39m
[31m       [31m√ó[31m should convert placeholder user to real user on accept[39m[33m 500[2mms[22m[39m
[31m       [31m√ó[31m should reject expired invite[39m[33m 597[2mms[22m[39m
[31m       [31m√ó[31m should reject already accepted invite[39m[33m 434[2mms[22m[39m
[31m       [31m√ó[31m should verify email matches invite[39m[33m 359[2mms[22m[39m
       [33m[2m‚úì[22m[39m should reject invalid token [33m 1131[2mms[22m[39m
[31m       [31m√ó[31m should return pending invites for user email[39m[33m 494[2mms[22m[39m
[31m       [31m√ó[31m should not return expired invites[39m[33m 754[2mms[22m[39m
[31m       [31m√ó[31m should not return accepted invites[39m[33m 802[2mms[22m[39m
[31m       [31m√ó[31m should allow admin to revoke invite[39m[33m 800[2mms[22m[39m
[31m       [31m√ó[31m should prevent accepting revoked invite[39m[33m 774[2mms[22m[39m
{"level":30,"time":1768715722250,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768715722261,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/integration/ownershipAccess.test.ts[2m > [22m[2mOwnership Access Control[2m > [22m[2mcanAccessAsset[2m > [22m[2mshould allow access to user-owned asset by owner
[22m[39mSetup error: DrizzleQueryError: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, default, default, default), ($4, $5, default, default, default, default, $6, default, default, default) on conflict do nothing
params: 10000000-0000-0000-0000-000000000001,Test Org 1,00000000-0000-0000-0000-000000000099,10000000-0000-0000-0000-000000000002,Test Org 2,00000000-0000-0000-0000-000000000099
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:35:7 {
  query: [32m'insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, default, default, default), ($4, $5, default, default, default, default, $6, default, default, default) on conflict do nothing'[39m,
  params: [
    [32m'10000000-0000-0000-0000-000000000001'[39m,
    [32m'Test Org 1'[39m,
    [32m'00000000-0000-0000-0000-000000000099'[39m,
    [32m'10000000-0000-0000-0000-000000000002'[39m,
    [32m'Test Org 2'[39m,
    [32m'00000000-0000-0000-0000-000000000099'[39m
  ],
  cause: error: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:35:7 {
    length: [33m347[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23503'[39m,
    detail: [32m'Key (tenant_id)=(00000000-0000-0000-0000-000000000099) is not present in table "tenants".'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w71_v3'[39m,
    table: [32m'organizations'[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [32m'organizations_tenant_id_tenants_id_fk'[39m,
    file: [32m'ri_triggers.c'[39m,
    line: [32m'2599'[39m,
    routine: [32m'ri_ReportViolation'[39m
  }
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w67_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w70_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w71_v3, public
‚úÖ Enforced search_path: test_schema_w71_v3, public

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w68_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w67_v3 (Reused: true)

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w69_v3, public
‚úÖ Enforced search_path: test_schema_w69_v3, public

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w70_v3 (Reused: true)

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w68_v3 (Reused: true)

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w62_v3
‚úÖ Current search_path: test_schema_w72_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w69_v3
‚úÖ Current search_path: test_schema_w69_v3, public
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768715722960,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w75_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w72_v3, public
‚úÖ Enforced search_path: test_schema_w72_v3, public

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m‚úÖ Set default search_path for database: test_schema_w65_v3, public
‚úÖ Enforced search_path: test_schema_w65_v3, public

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w75_v3 (Reused: true)

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w28_v3
‚úÖ Current search_path: test_schema_w28_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w65_v3
‚úÖ Current search_path: test_schema_w65_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39müìä Schema test_schema_w67_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715723171,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715723172,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w67_v3\",public"}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39müìä Schema test_schema_w70_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715723195,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715723196,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w70_v3\",public"}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39müìä Schema test_schema_w68_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":30,"time":1768715723224,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768715723245,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/integration/ownershipAccess.test.ts[2m > [22m[2mOwnership Access Control[2m > [22m[2mcanAccessAsset[2m > [22m[2mshould allow access to org-owned asset by org member
[22m[39mSetup error: DrizzleQueryError: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict do nothing
params: 00000000-0000-0000-0000-000000000001,user1@test.com,User 1,00000000-0000-0000-0000-000000000099,00000000-0000-0000-0000-000000000002,user2@test.com,User 2,00000000-0000-0000-0000-000000000099
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:41:7 {
  query: [32m'insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict do nothing'[39m,
  params: [
    [32m'00000000-0000-0000-0000-000000000001'[39m,
    [32m'user1@test.com'[39m,
    [32m'User 1'[39m,
    [32m'00000000-0000-0000-0000-000000000099'[39m,
    [32m'00000000-0000-0000-0000-000000000002'[39m,
    [32m'user2@test.com'[39m,
    [32m'User 2'[39m,
    [32m'00000000-0000-0000-0000-000000000099'[39m
  ],
  cause: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:41:7 {
    length: [33m315[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23503'[39m,
    detail: [32m'Key (tenant_id)=(00000000-0000-0000-0000-000000000099) is not present in table "tenants".'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w62_v3'[39m,
    table: [32m'users'[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [32m'users_tenant_id_tenants_id_fk'[39m,
    file: [32m'ri_triggers.c'[39m,
    line: [32m'2599'[39m,
    routine: [32m'ri_ReportViolation'[39m
  }
}

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39müìä Schema test_schema_w75_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w73_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768715723765,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715723766,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w73_v3 (Reused: true)

 [31m‚ùØ[39m tests/integration/variableSafety.test.ts [2m([22m[2m4 tests[22m[2m | [22m[31m4 failed[39m[2m)[22m[33m 5803[2mms[22m[39m
[31m     [31m√ó[31m REPRO: ScriptEngine fails to resolve alias 'input_variable' when aliasMap is NOT provided[39m[33m 538[2mms[22m[39m
[31m     [31m√ó[31m ScriptEngine resolves alias 'input_variable' when aliasMap is provided[39m[33m 460[2mms[22m[39m
[31m     [31m√ó[31m REPRO: BlockRunner fails to resolve alias in CreateRecordConfig[39m[33m 450[2mms[22m[39m
[31m     [31m√ó[31m BlockRunner logic resolves alias with aliasMap[39m[33m 807[2mms[22m[39m
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768715723971,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715723971,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w70_v3, public
‚úÖ Enforced search_path: test_schema_w70_v3, public

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w67_v3, public
‚úÖ Enforced search_path: test_schema_w67_v3, public

 [32m‚úì[39m tests/unit/lib/queries/QueryRunner.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 2901[2mms[22m[39m
{"level":30,"time":1768715724022,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715724022,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715724034,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715724035,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w68_v3\",public"}
 [32m‚úì[39m tests/integration/intake.portal.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 3754[2mms[22m[39m
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w28_v3
‚úÖ Current search_path: test_schema_w70_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w66_v3
‚úÖ Current search_path: test_schema_w66_v3, public
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768715724128,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39müìä Schema test_schema_w73_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768715724266,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715724266,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/services/BrandingService.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 2928[2mms[22m[39m
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715724341,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715724342,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w75_v3\",public"}
{"level":30,"time":1768715724403,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768715724481,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715724482,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

 [32m‚úì[39m tests/unit/components/datavault/SortableColumnHeader.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 4064[2mms[22m[39m
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstderr[2m | tests/integration/ownershipAccess.test.ts[2m > [22m[2mOwnership Access Control[2m > [22m[2mcanAccessAsset[2m > [22m[2mshould deny access to org-owned asset by non-member
[22m[39mSetup error: DrizzleQueryError: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, default, default, default), ($4, $5, default, default, default, default, $6, default, default, default) on conflict do nothing
params: 10000000-0000-0000-0000-000000000001,Test Org 1,00000000-0000-0000-0000-000000000099,10000000-0000-0000-0000-000000000002,Test Org 2,00000000-0000-0000-0000-000000000099
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:35:7 {
  query: [32m'insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, default, default, default), ($4, $5, default, default, default, default, $6, default, default, default) on conflict do nothing'[39m,
  params: [
    [32m'10000000-0000-0000-0000-000000000001'[39m,
    [32m'Test Org 1'[39m,
    [32m'00000000-0000-0000-0000-000000000099'[39m,
    [32m'10000000-0000-0000-0000-000000000002'[39m,
    [32m'Test Org 2'[39m,
    [32m'00000000-0000-0000-0000-000000000099'[39m
  ],
  cause: error: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:35:7 {
    length: [33m347[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23503'[39m,
    detail: [32m'Key (tenant_id)=(00000000-0000-0000-0000-000000000099) is not present in table "tenants".'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w70_v3'[39m,
    table: [32m'organizations'[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [32m'organizations_tenant_id_tenants_id_fk'[39m,
    file: [32m'ri_triggers.c'[39m,
    line: [32m'2599'[39m,
    routine: [32m'ri_ReportViolation'[39m
  }
}

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w76_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w76_v3 (Reused: true)

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m‚úÖ Set default search_path for database: test_schema_w68_v3, public
‚úÖ Enforced search_path: test_schema_w68_v3, public

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w68_v3
‚úÖ Current search_path: test_schema_w68_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w78_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715725069,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715725070,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w73_v3\",public"}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w78_v3 (Reused: true)

{"level":30,"time":1768715725115,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w75_v3, public
‚úÖ Enforced search_path: test_schema_w75_v3, public

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w77_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w77_v3 (Reused: true)

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w75_v3
‚úÖ Current search_path: test_schema_w75_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39müìä Schema test_schema_w76_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w63_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstderr[2m | tests/integration/ownershipAccess.test.ts[2m > [22m[2mOwnership Access Control[2m > [22m[2mcanAccessAsset[2m > [22m[2mshould allow access to null ownership (legacy data)
[22m[39mSetup error: DrizzleQueryError: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, default, default, default), ($4, $5, default, default, default, default, $6, default, default, default) on conflict do nothing
params: 10000000-0000-0000-0000-000000000001,Test Org 1,00000000-0000-0000-0000-000000000099,10000000-0000-0000-0000-000000000002,Test Org 2,00000000-0000-0000-0000-000000000099
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:35:7 {
  query: [32m'insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, default, default, default), ($4, $5, default, default, default, default, $6, default, default, default) on conflict do nothing'[39m,
  params: [
    [32m'10000000-0000-0000-0000-000000000001'[39m,
    [32m'Test Org 1'[39m,
    [32m'00000000-0000-0000-0000-000000000099'[39m,
    [32m'10000000-0000-0000-0000-000000000002'[39m,
    [32m'Test Org 2'[39m,
    [32m'00000000-0000-0000-0000-000000000099'[39m
  ],
  cause: error: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:35:7 {
    length: [33m347[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23503'[39m,
    detail: [32m'Key (tenant_id)=(00000000-0000-0000-0000-000000000099) is not present in table "tenants".'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w67_v3'[39m,
    table: [32m'organizations'[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [32m'organizations_tenant_id_tenants_id_fk'[39m,
    file: [32m'ri_triggers.c'[39m,
    line: [32m'2599'[39m,
    routine: [32m'ri_ReportViolation'[39m
  }
}

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w63_v3 (Reused: true)

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39müìä Schema test_schema_w78_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":50,"time":1768715725605,"env":"test","module":"auth-routes","email":"test-1768715724856-db6j5p@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768715725714,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Regeneration[2m > [22m[2mshould return error if MFA not enabled
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768715725720,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39müìä Schema test_schema_w77_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39müìä Schema test_schema_w63_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715725860,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715725860,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w63_v3\",public"}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w73_v3, public
‚úÖ Enforced search_path: test_schema_w73_v3, public

{"level":30,"time":1768715725913,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w73_v3
‚úÖ Current search_path: test_schema_w73_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715726051,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715726052,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w76_v3\",public"}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

{"level":30,"time":1768715726101,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/dataBlocks.test.ts[2m > [22m[2mData Block Integration Tests
[22m[39m[DEBUG] Table not found: 5d42c150-92b9-4281-a06f-7d6c4dec5d96

{"level":30,"time":1768715726233,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715726233,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715726285,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715726286,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w78_v3\",public"}
{"level":30,"time":1768715726339,"env":"test","msg":"DB: initialized flag set."}
 [31m‚ùØ[39m tests/integration/dataBlocks.test.ts [2m([22m[2m2 tests[22m[2m | [22m[33m2 skipped[39m[2m)[22m[33m 3936[2mms[22m[39m
     [2m[90m‚Üì[39m[22m should write data to DataVault via WriteBlock
     [2m[90m‚Üì[39m[22m should query data from DataVault via QueryBlock and use in Logic
{"level":30,"time":1768715726418,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715726418,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/analytics_service.test.ts[2m > [22m[2mAnalytics Service Integration
[22m[39mMANUAL PATCH: Applied FK fix for workflow_run_events AND workflow_run_metrics

 [32m‚úì[39m tests/integration/session.management.test.ts [2m([22m[2m22 tests[22m[2m)[22m[33m 3783[2mms[22m[39m
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715726526,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715726527,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w77_v3\",public"}
{"level":30,"time":1768715726583,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w63_v3, public
‚úÖ Enforced search_path: test_schema_w63_v3, public

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w80_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w67_v3
‚úÖ Current search_path: test_schema_w67_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w80_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w76_v3, public
‚úÖ Enforced search_path: test_schema_w76_v3, public

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w76_v3
‚úÖ Current search_path: test_schema_w76_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w78_v3, public
‚úÖ Enforced search_path: test_schema_w78_v3, public

{"level":50,"time":1768715727122,"env":"test","module":"auth-routes","userId":"8f38a90429eedd6b7c9409097638b5f6","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w78_v3
‚úÖ Current search_path: test_schema_w78_v3, public
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768715727215,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
{"level":30,"time":1768715727215,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768715727218,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39müìä Schema test_schema_w80_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715727238,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715727239,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w80_v3\",public"}
{"level":30,"time":1768715727251,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK shut down successfully"}
[90mstderr[2m | tests/integration/ownershipAccess.test.ts[2m > [22m[2mOwnership Access Control[2m > [22m[2misOrgMember[2m > [22m[2mshould return true for org admin
[22m[39mSetup error: DrizzleQueryError: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict do nothing
params: 00000000-0000-0000-0000-000000000001,user1@test.com,User 1,00000000-0000-0000-0000-000000000099,00000000-0000-0000-0000-000000000002,user2@test.com,User 2,00000000-0000-0000-0000-000000000099
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:41:7 {
  query: [32m'insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict do nothing'[39m,
  params: [
    [32m'00000000-0000-0000-0000-000000000001'[39m,
    [32m'user1@test.com'[39m,
    [32m'User 1'[39m,
    [32m'00000000-0000-0000-0000-000000000099'[39m,
    [32m'00000000-0000-0000-0000-000000000002'[39m,
    [32m'user2@test.com'[39m,
    [32m'User 2'[39m,
    [32m'00000000-0000-0000-0000-000000000099'[39m
  ],
  cause: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:41:7 {
    length: [33m315[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23503'[39m,
    detail: [32m'Key (tenant_id)=(00000000-0000-0000-0000-000000000099) is not present in table "tenants".'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w63_v3'[39m,
    table: [32m'users'[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [32m'users_tenant_id_tenants_id_fk'[39m,
    file: [32m'ri_triggers.c'[39m,
    line: [32m'2599'[39m,
    routine: [32m'ri_ReportViolation'[39m
  }
}

{"level":30,"time":1768715727286,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w82_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768715727319,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768715727321,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
{"level":30,"time":1768715727321,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768715727321,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":40,"time":1768715727330,"env":"test","module":"metrics-routes","ip":"::ffff:127.0.0.1","msg":"Unauthorized metrics access attempt"}
{"level":30,"time":1768715727341,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK shut down successfully"}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715727342,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768715727342,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w82_v3 (Reused: true)

{"level":50,"time":1768715727363,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mTenant-Level MFA Enforcement[2m > [22m[2mshould enforce MFA for tenant users when required by tenant
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:74:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w77_v3, public
‚úÖ Enforced search_path: test_schema_w77_v3, public

 [32m‚úì[39m tests/integration/metrics.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 3987[2mms[22m[39m
{"level":30,"time":1768715727438,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715727438,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w77_v3
‚úÖ Current search_path: test_schema_w77_v3, public
‚è© Schema reused, skipping migrations.

 [31m‚ùØ[39m tests/integration/analytics_service.test.ts [2m([22m[2m1 test[22m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 5122[2mms[22m[39m
     [2m[90m‚Üì[39m[22m should generate events and metrics on run completion
[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39müìä Schema test_schema_w82_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/intake.workflow.test.ts[2m > [22m[2mIntake Workflow Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/intake.workflow.test.ts[2m > [22m[2mIntake Workflow Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768715727910,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768715727937,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/intake.workflow.test.ts[2m > [22m[2mIntake Workflow Integration Tests
[22m[39müìö API Documentation available at /api-docs

{"level":30,"time":1768715727922,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768715727923,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768715727929,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768715727930,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768715727936,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768715727936,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768715727937,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768715727937,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768715728023,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715728023,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w80_v3, public
‚úÖ Enforced search_path: test_schema_w80_v3, public

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w61_v3
‚úÖ Current search_path: test_schema_w61_v3, public
‚è© Schema reused, skipping migrations.

{"level":50,"time":1768715728160,"env":"test","module":"intake-navigation","error":{},"pageId":"page1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating visibleIf condition"}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768715728161,"env":"test","module":"intake-navigation","error":{},"pageId":"page1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating skipIf condition"}
{"level":30,"time":1768715728163,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768715728164,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/mfa.flow.real.test.ts [2m([22m[2m20 tests[22m[2m | [22m[31m20 failed[39m[2m)[22m[33m 22196[2mms[22m[39m
[31m       [31m√ó[31m should complete full MFA setup flow[39m[33m 405[2mms[22m[39m
[31m       [31m√ó[31m should reject invalid TOTP code during setup[39m[33m 723[2mms[22m[39m
[31m       [31m√ó[31m should not allow MFA setup if already enabled[39m[33m 762[2mms[22m[39m
[31m       [31m√ó[31m should generate unique backup codes[39m[33m 675[2mms[22m[39m
[31m       [31m√ó[31m should store hashed backup codes[39m[33m 1723[2mms[22m[39m
[31m       [31m√ó[31m should require MFA for enabled users[39m[33m 385[2mms[22m[39m
[31m       [31m√ó[31m should complete MFA login with valid TOTP[39m[33m 776[2mms[22m[39m
[31m       [31m√ó[31m should reject invalid TOTP during login[39m[33m 732[2mms[22m[39m
[31m       [31m√ó[31m should accept TOTP codes within 60-second window[39m[33m 1182[2mms[22m[39m
[31m       [31m√ó[31m should login with valid backup code[39m[33m 684[2mms[22m[39m
[31m       [31m√ó[31m should mark backup code as used[39m[33m 950[2mms[22m[39m
[31m       [31m√ó[31m should prevent backup code reuse[39m[33m 1904[2mms[22m[39m
[31m       [31m√ó[31m should try TOTP before backup code[39m[33m 491[2mms[22m[39m
[31m       [31m√ó[31m should return MFA status for user[39m[33m 1600[2mms[22m[39m
[31m       [31m√ó[31m should return backup codes count for MFA users[39m[33m 496[2mms[22m[39m
[31m       [31m√ó[31m should disable MFA with password verification[39m[33m 873[2mms[22m[39m
[31m       [31m√ó[31m should require correct password to disable MFA[39m[33m 672[2mms[22m[39m
[31m       [31m√ó[31m should regenerate backup codes[39m[33m 882[2mms[22m[39m
[31m       [31m√ó[31m should return error if MFA not enabled[39m[33m 1544[2mms[22m[39m
[31m       [31m√ó[31m should enforce MFA for tenant users when required by tenant[39m[33m 1622[2mms[22m[39m
 [32m‚úì[39m tests/unit/services/intakeNavigation.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 3684[2mms[22m[39m
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

{"level":30,"time":1768715728310,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715728311,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768715728348,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715728349,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/workflows/conditionTruthTable.test.ts [2m([22m[2m51 tests[22m[2m)[22m[33m 3679[2mms[22m[39m
 [32m‚úì[39m tests/ui/runs.components.test.tsx [2m([22m[2m19 tests[22m[2m)[22m[33m 5999[2mms[22m[39m
       [33m[2m‚úì[22m[39m should show download options for successful runs [33m 795[2mms[22m[39m
       [33m[2m‚úì[22m[39m should call onChange when status filter changes [33m 392[2mms[22m[39m
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

{"level":40,"time":1768715728613,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":40,"time":1768715728623,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768715728629,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768715728637,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768715728641,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":30,"time":1768715728651,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768715728651,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768715728702,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["6176b62d-30a5-452e-8657-aeabcb1013de","$2b$12$bVvaHzbV9cPecWEbwZ/Vo.wLJdwT9wWnS2ObmrmDBJu6icmefYJNG"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(6176b62d-30a5-452e-8657-aeabcb1013de) is not present in table \"users\".","schema":"test_schema_w63_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"6176b62d-30a5-452e-8657-aeabcb1013de","msg":"Failed to create user credentials"}
{"level":50,"time":1768715728703,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["6176b62d-30a5-452e-8657-aeabcb1013de","$2b$12$bVvaHzbV9cPecWEbwZ/Vo.wLJdwT9wWnS2ObmrmDBJu6icmefYJNG"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(6176b62d-30a5-452e-8657-aeabcb1013de) is not present in table \"users\".","schema":"test_schema_w63_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/intake.workflow.test.ts[2m > [22m[2mIntake Workflow Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/intake.workflow.test.ts:11:15

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715728716,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768715728717,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/isolatedVmBridge.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 3785[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715728830,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715728831,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w82_v3\",public"}
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

{"level":30,"time":1768715728903,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

 [31m‚ùØ[39m tests/integration/intake.workflow.test.ts [2m([22m[2m2 tests[22m[2m | [22m[33m2 skipped[39m[2m)[22m[33m 3690[2mms[22m[39m
     [2m[90m‚Üì[39m[22m should allow designating a workflow as Intake
     [2m[90m‚Üì[39m[22m should allow linking a downstream workflow to an intake workflow
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w86_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w86_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w84_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w83_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w84_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w83_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w82_v3, public
‚úÖ Enforced search_path: test_schema_w82_v3, public

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39müìä Schema test_schema_w86_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w82_v3
‚úÖ Current search_path: test_schema_w82_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39müìä Schema test_schema_w84_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715729951,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715729952,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w84_v3\",public"}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39müìä Schema test_schema_w83_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715729999,"env":"test","msg":"DB: initializing... Local"}
{"level":50,"time":1768715730010,"env":"test","error":{"query":"insert into \"connections\" (\"id\", \"tenant_id\", \"project_id\", \"name\", \"type\", \"base_url\", \"auth_config\", \"secret_refs\", \"oauth_state\", \"default_headers\", \"timeout_ms\", \"retries\", \"backoff_ms\", \"enabled\", \"last_tested_at\", \"last_used_at\", \"created_at\", \"updated_at\") values (default, $1, $2, $3, $4, $5, $6, $7, default, $8, $9, $10, $11, $12, default, default, default, default) returning \"id\", \"tenant_id\", \"project_id\", \"name\", \"type\", \"base_url\", \"auth_config\", \"secret_refs\", \"oauth_state\", \"default_headers\", \"timeout_ms\", \"retries\", \"backoff_ms\", \"enabled\", \"last_tested_at\", \"last_used_at\", \"created_at\", \"updated_at\"","params":["eb4d0ff8-e8db-4176-a392-b8036377592c","db6ec642-4964-4e0a-b086-9b9087273aa0","Test OAuth2 Connection","oauth2_3leg","https://api.example.com","{\"authUrl\":\"https://auth.example.com/oauth/authorize\",\"tokenUrl\":\"https://auth.example.com/oauth/token\",\"scope\":\"read write\"}","{\"clientId\":\"oauth2_client_id\",\"clientSecret\":\"oauth2_client_secret\"}","{}",8000,2,250,true],"cause":{"length":339,"name":"error","severity":"ERROR","code":"23503","detail":"Key (tenant_id)=(eb4d0ff8-e8db-4176-a392-b8036377592c) is not present in table \"tenants\".","schema":"test_schema_w61_v3","table":"connections","constraint":"connections_tenant_id_tenants_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Failed to create connection:"}
{"level":30,"time":1768715730011,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715730000,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w83_v3\",public"}
{"level":30,"time":1768715730055,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768715730073,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768715730074,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w90_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w90_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w74_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w74_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w87_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w81_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w87_v3 (Reused: true)

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w81_v3 (Reused: true)

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39müìä Schema test_schema_w90_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715730679,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715730680,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w86_v3\",public"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39müìä Schema test_schema_w74_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715730735,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715730736,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w74_v3\",public"}
{"level":30,"time":1768715730734,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768715730788,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w84_v3, public
‚úÖ Enforced search_path: test_schema_w84_v3, public

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w83_v3, public
‚úÖ Enforced search_path: test_schema_w83_v3, public

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w89_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w61_v3
‚úÖ Current search_path: test_schema_w61_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w89_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w61_v3
‚úÖ Current search_path: test_schema_w61_v3, public
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768715730957,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715730958,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/utils/conditionalLogic.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 4021[2mms[22m[39m
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39müìä Schema test_schema_w87_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715731000,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715731002,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w87_v3\",public"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39müìä Schema test_schema_w81_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715731026,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715731026,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w81_v3\",public"}
{"level":30,"time":1768715731055,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768715731079,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39müìä Schema test_schema_w89_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715731311,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715731312,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w89_v3\",public"}
{"level":30,"time":1768715731362,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715731384,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715731385,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w90_v3\",public"}
{"level":30,"time":1768715731435,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w86_v3, public
‚úÖ Enforced search_path: test_schema_w86_v3, public

{"level":50,"time":1768715731518,"env":"test","error":{},"msg":"Failed to create connection:"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w74_v3, public
‚úÖ Enforced search_path: test_schema_w74_v3, public

[90mstderr[2m | tests/integration/ownershipAccess.test.ts[2m > [22m[2mOwnership Access Control[2m > [22m[2mcanCreateWithOwnership[2m > [22m[2mshould allow creating org-owned asset if user is member
[22m[39mSetup error: DrizzleQueryError: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, default, default, default), ($4, $5, default, default, default, default, $6, default, default, default) on conflict do nothing
params: 10000000-0000-0000-0000-000000000001,Test Org 1,00000000-0000-0000-0000-000000000099,10000000-0000-0000-0000-000000000002,Test Org 2,00000000-0000-0000-0000-000000000099
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:35:7 {
  query: [32m'insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, default, default, default), ($4, $5, default, default, default, default, $6, default, default, default) on conflict do nothing'[39m,
  params: [
    [32m'10000000-0000-0000-0000-000000000001'[39m,
    [32m'Test Org 1'[39m,
    [32m'00000000-0000-0000-0000-000000000099'[39m,
    [32m'10000000-0000-0000-0000-000000000002'[39m,
    [32m'Test Org 2'[39m,
    [32m'00000000-0000-0000-0000-000000000099'[39m
  ],
  cause: error: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:35:7 {
    length: [33m347[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23503'[39m,
    detail: [32m'Key (tenant_id)=(00000000-0000-0000-0000-000000000099) is not present in table "tenants".'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w81_v3'[39m,
    table: [32m'organizations'[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [32m'organizations_tenant_id_tenants_id_fk'[39m,
    file: [32m'ri_triggers.c'[39m,
    line: [32m'2599'[39m,
    routine: [32m'ri_ReportViolation'[39m
  }
}

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w86_v3
‚úÖ Current search_path: test_schema_w86_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w81_v3
‚úÖ Current search_path: test_schema_w81_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768715731813,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w87_v3, public
‚úÖ Enforced search_path: test_schema_w87_v3, public

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w81_v3, public
‚úÖ Enforced search_path: test_schema_w81_v3, public

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w89_v3
‚úÖ Current search_path: test_schema_w66_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w89_v3
‚úÖ Current search_path: test_schema_w89_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts[2m > [22m[2mDatavaultColumnsService[2m > [22m[2mgetColumns[2m > [22m[2mshould throw 404 if table not found
[22m[39m[DEBUG] Table not found: 660e8400-e29b-41d4-a716-446655440001

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w88_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715732079,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715732079,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w88_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w89_v3, public
‚úÖ Enforced search_path: test_schema_w89_v3, public

 [32m‚úì[39m tests/unit/services/RecordService.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 2923[2mms[22m[39m
{"level":30,"time":1768715732152,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715732152,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w90_v3, public
‚úÖ Enforced search_path: test_schema_w90_v3, public

 [32m‚úì[39m tests/unit/services/DatavaultColumnsService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 3030[2mms[22m[39m
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w74_v3
‚úÖ Current search_path: test_schema_w74_v3, public
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768715732221,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715732222,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w85_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w90_v3
‚úÖ Current search_path: test_schema_w90_v3, public
‚è© Schema reused, skipping migrations.

 [31m‚ùØ[39m tests/integration/auth/oauth2.callback.test.ts [2m([22m[2m16 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 5835[2mms[22m[39m
[31m       [31m√ó[31m should initiate OAuth2 3-legged flow and generate authorization URL[39m[33m 601[2mms[22m[39m
       [33m[2m‚úì[22m[39m should include optional scope in authorization URL [33m 522[2mms[22m[39m
       [32m‚úì[39m should validate valid OAuth2 state token[32m 97[2mms[22m[39m
       [32m‚úì[39m should reject invalid OAuth2 state token[32m 122[2mms[22m[39m
       [32m‚úì[39m should reject expired OAuth2 state token[32m 94[2mms[22m[39m
       [32m‚úì[39m should clean up OAuth2 state after use[32m 88[2mms[22m[39m
       [32m‚úì[39m should handle callback with missing state parameter[32m 100[2mms[22m[39m
       [32m‚úì[39m should handle callback with missing code parameter[32m 103[2mms[22m[39m
       [32m‚úì[39m should handle OAuth2 provider error responses[32m 101[2mms[22m[39m
[31m       [31m√ó[31m should track OAuth2 connection status[39m[32m 257[2mms[22m[39m
       [32m‚úì[39m should store OAuth2 state in connection metadata[32m 131[2mms[22m[39m
       [32m‚úì[39m should use cryptographically secure random state[32m 127[2mms[22m[39m
       [32m‚úì[39m should prevent state reuse after validation[32m 110[2mms[22m[39m
       [32m‚úì[39m should include PKCE support metadata in state record[32m 92[2mms[22m[39m
       [32m‚úì[39m should validate redirect URI matches allowed URIs[32m 101[2mms[22m[39m
       [32m‚úì[39m should encode redirect URI in authorization URL[32m 92[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w85_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w79_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w79_v3 (Reused: true)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39müìä Schema test_schema_w88_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w91_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w91_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39müìä Schema test_schema_w85_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715732718,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715732718,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w85_v3\",public"}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768715732770,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39müìä Schema test_schema_w79_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715732777,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715732778,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w79_v3\",public"}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768715732790,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstderr[2m | tests/integration/ownershipAccess.test.ts[2m > [22m[2mOwnership Access Control[2m > [22m[2mcanCreateWithOwnership[2m > [22m[2mshould deny creating org-owned asset if user is not member
[22m[39mSetup error: DrizzleQueryError: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, default, default, default), ($4, $5, default, default, default, default, $6, default, default, default) on conflict do nothing
params: 10000000-0000-0000-0000-000000000001,Test Org 1,00000000-0000-0000-0000-000000000099,10000000-0000-0000-0000-000000000002,Test Org 2,00000000-0000-0000-0000-000000000099
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:35:7 {
  query: [32m'insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, default, default, default), ($4, $5, default, default, default, default, $6, default, default, default) on conflict do nothing'[39m,
  params: [
    [32m'10000000-0000-0000-0000-000000000001'[39m,
    [32m'Test Org 1'[39m,
    [32m'00000000-0000-0000-0000-000000000099'[39m,
    [32m'10000000-0000-0000-0000-000000000002'[39m,
    [32m'Test Org 2'[39m,
    [32m'00000000-0000-0000-0000-000000000099'[39m
  ],
  cause: error: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:35:7 {
    length: [33m347[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23503'[39m,
    detail: [32m'Key (tenant_id)=(00000000-0000-0000-0000-000000000099) is not present in table "tenants".'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w89_v3'[39m,
    table: [32m'organizations'[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [32m'organizations_tenant_id_tenants_id_fk'[39m,
    file: [32m'ri_triggers.c'[39m,
    line: [32m'2599'[39m,
    routine: [32m'ri_ReportViolation'[39m
  }
}

[90mstderr[2m | tests/unit/shared/workflowLogic.test.ts[2m > [22m[2mworkflowLogic[2m > [22m[2mevaluateRules[2m > [22m[2mOperators[2m > [22m[2mUnknown operator[2m > [22m[2mshould return false and log warning for unknown operator
[22m[39mUnknown operator: unknown_operator

{"level":30,"time":1768715732813,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715732814,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests
[22m[39müìö API Documentation available at /api-docs

{"level":30,"time":1768715732813,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768715732800,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768715732801,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768715732806,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768715732807,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768715732813,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768715732813,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768715732814,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768715732814,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768715732830,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/unit/shared/workflowLogic.test.ts [2m([22m[2m65 tests[22m[2m)[22m[33m 3861[2mms[22m[39m
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39müìä Schema test_schema_w91_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715733078,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715733079,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w91_v3\",public"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

{"level":30,"time":1768715733103,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715733104,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768715733137,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/unit/services/CollectionService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 2982[2mms[22m[39m
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715733366,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715733366,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715733367,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768715733368,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w88_v3\",public"}
 [32m‚úì[39m tests/unit/services/StepService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 2888[2mms[22m[39m
{"level":50,"time":1768715733442,"env":"test","status":401,"statusText":"Unauthorized","error":"Invalid client credentials","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768715733442,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768715733445,"env":"test","data":{"token_type":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768715733445,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768715733446,"env":"test","data":{"access_token":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768715733446,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768715733447,"env":"test","error":"Network error: ECONNREFUSED","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":30,"time":1768715733460,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w85_v3, public
‚úÖ Enforced search_path: test_schema_w85_v3, public

{"level":50,"time":1768715733552,"env":"test","error":"Invalid credentials","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768715733553,"env":"test","error":"ECONNREFUSED","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768715733554,"env":"test","status":400,"statusText":"Bad Request","error":"Invalid grant_type","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768715733554,"env":"test","error":"OAuth2 token request failed: 400 Bad Request","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768715733555,"env":"test","status":401,"statusText":"Unauthorized","error":"Client authentication failed","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768715733555,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768715733556,"env":"test","status":403,"statusText":"Forbidden","error":"Access denied","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768715733556,"env":"test","error":"OAuth2 token request failed: 403 Forbidden","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768715733556,"env":"test","status":500,"statusText":"Internal Server Error","error":"Server error","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768715733556,"env":"test","error":"OAuth2 token request failed: 500 Internal Server Error","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768715733557,"env":"test","error":"Unexpected token in JSON","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768715733557,"env":"test","error":"Request timeout","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":30,"time":1768715733559,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768715733559,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/auth/oauth2.client-credentials.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 3763[2mms[22m[39m
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w79_v3, public
‚úÖ Enforced search_path: test_schema_w79_v3, public

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w61_v3
‚úÖ Current search_path: test_schema_w79_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w28_v3
‚úÖ Current search_path: test_schema_w85_v3, public
‚è© Schema reused, skipping migrations.

{"level":50,"time":1768715733801,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["756bc365-ff39-43d9-b49c-20635f9f2aee","$2b$12$fsHnqiXctxFNGiGX0aegb..fEar468fwt/GV8HWlVhHzYX2dfQBx."],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(756bc365-ff39-43d9-b49c-20635f9f2aee) is not present in table \"users\".","schema":"test_schema_w61_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"756bc365-ff39-43d9-b49c-20635f9f2aee","msg":"Failed to create user credentials"}
{"level":50,"time":1768715733801,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["756bc365-ff39-43d9-b49c-20635f9f2aee","$2b$12$fsHnqiXctxFNGiGX0aegb..fEar468fwt/GV8HWlVhHzYX2dfQBx."],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(756bc365-ff39-43d9-b49c-20635f9f2aee) is not present in table \"users\".","schema":"test_schema_w61_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/auth.middleware.integration.test.ts:35:15

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715733817,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768715733817,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w91_v3, public
‚úÖ Enforced search_path: test_schema_w91_v3, public

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w93_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w61_v3
‚úÖ Current search_path: test_schema_w61_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w93_v3 (Reused: true)

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

 [31m‚ùØ[39m tests/integration/auth/auth.middleware.integration.test.ts [2m([22m[2m27 tests[22m[2m | [22m[33m27 skipped[39m[2m)[22m[33m 3958[2mms[22m[39m
       [2m[90m‚Üì[39m[22m should allow access with valid JWT Bearer token
       [2m[90m‚Üì[39m[22m should return 401 when no token provided
       [2m[90m‚Üì[39m[22m should return 401 with invalid token
       [2m[90m‚Üì[39m[22m should return 401 with expired token
       [2m[90m‚Üì[39m[22m should proceed without authentication if no token provided
       [2m[90m‚Üì[39m[22m should authenticate with JWT Bearer token
       [2m[90m‚Üì[39m[22m should authenticate with refresh token cookie (GET only)
       [2m[90m‚Üì[39m[22m should reject cookie auth for POST requests (mutation-strict)
       [2m[90m‚Üì[39m[22m should reject cookie auth for PUT requests
       [2m[90m‚Üì[39m[22m should reject cookie auth for DELETE requests
       [2m[90m‚Üì[39m[22m should allow cookie auth for HEAD requests
       [2m[90m‚Üì[39m[22m should prioritize JWT over cookie when both present
       [2m[90m‚Üì[39m[22m should return 401 when no auth provided
       [2m[90m‚Üì[39m[22m should return 401 when both JWT and cookie are invalid
       [2m[90m‚Üì[39m[22m should authenticate with JWT if provided
       [2m[90m‚Üì[39m[22m should authenticate with cookie if JWT not provided
       [2m[90m‚Üì[39m[22m should proceed anonymously if no auth provided
       [2m[90m‚Üì[39m[22m should proceed anonymously if both JWT and cookie are invalid
       [2m[90m‚Üì[39m[22m should only allow safe methods for cookie auth
       [2m[90m‚Üì[39m[22m should ignore cookies when Bearer token present
       [2m[90m‚Üì[39m[22m should attach userId to request
       [2m[90m‚Üì[39m[22m should attach userEmail to request
       [2m[90m‚Üì[39m[22m should return consistent error format for missing token
       [2m[90m‚Üì[39m[22m should return consistent error format for invalid token
       [2m[90m‚Üì[39m[22m should return consistent error format for expired token
       [2m[90m‚Üì[39m[22m should handle malformed JWT gracefully
       [2m[90m‚Üì[39m[22m should handle JWT with wrong algorithm
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m‚úÖ Set default search_path for database: test_schema_w88_v3, public
‚úÖ Enforced search_path: test_schema_w88_v3, public

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w97_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w97_v3 (Reused: true)

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w88_v3
‚úÖ Current search_path: test_schema_w88_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39müìä Schema test_schema_w93_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715734424,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715734424,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w93_v3\",public"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":30,"time":1768715734473,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39müìä Schema test_schema_w97_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768715734872,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768715734896,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts[2m > [22m[2mRuns API - DOCX Generation Integration Tests
[22m[39müìö API Documentation available at /api-docs

{"level":30,"time":1768715734883,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768715734883,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768715734890,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768715734890,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768715734896,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768715734896,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768715734896,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768715734896,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstderr[2m | tests/integration/ownershipAccess.test.ts[2m > [22m[2mOwnership Access Control[2m > [22m[2mCross-org Access Control[2m > [22m[2mshould allow member of multiple orgs to access all their org assets
[22m[39mSetup error: DrizzleQueryError: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict do nothing
params: 00000000-0000-0000-0000-000000000001,user1@test.com,User 1,00000000-0000-0000-0000-000000000099,00000000-0000-0000-0000-000000000002,user2@test.com,User 2,00000000-0000-0000-0000-000000000099
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:41:7 {
  query: [32m'insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict do nothing'[39m,
  params: [
    [32m'00000000-0000-0000-0000-000000000001'[39m,
    [32m'user1@test.com'[39m,
    [32m'User 1'[39m,
    [32m'00000000-0000-0000-0000-000000000099'[39m,
    [32m'00000000-0000-0000-0000-000000000002'[39m,
    [32m'user2@test.com'[39m,
    [32m'User 2'[39m,
    [32m'00000000-0000-0000-0000-000000000099'[39m
  ],
  cause: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:41:7 {
    length: [33m315[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23503'[39m,
    detail: [32m'Key (tenant_id)=(00000000-0000-0000-0000-000000000099) is not present in table "tenants".'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w91_v3'[39m,
    table: [32m'users'[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [32m'users_tenant_id_tenants_id_fk'[39m,
    file: [32m'ri_triggers.c'[39m,
    line: [32m'2599'[39m,
    routine: [32m'ri_ReportViolation'[39m
  }
}

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w92_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w92_v3 (Reused: true)

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w99_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w99_v3 (Reused: true)

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w93_v3, public
‚úÖ Enforced search_path: test_schema_w93_v3, public

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w66_v3
‚úÖ Current search_path: test_schema_w66_v3, public
‚è© Schema reused, skipping migrations.

{"level":50,"time":1768715735408,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["rtKrJWZKjEEtfMPL5KrK7","$2b$12$L2yDPUZ9KUsNDVnOuRdy5eK7LLxLRtIdsIabJJ6HkaCYdkbjxquG."],"cause":{"length":332,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(rtKrJWZKjEEtfMPL5KrK7) is not present in table \"users\".","schema":"test_schema_w93_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"rtKrJWZKjEEtfMPL5KrK7","msg":"Failed to create user credentials"}
{"level":50,"time":1768715735432,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["7bca9f20-54c7-4b61-a81c-14b923ca30de","$2b$12$YEhErZB1f8GEsNbyHN.OKuTLxxWfs3SY1C8clfW0/Q.oG7ZI.BRSa"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(7bca9f20-54c7-4b61-a81c-14b923ca30de) is not present in table \"users\".","schema":"test_schema_w93_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"7bca9f20-54c7-4b61-a81c-14b923ca30de","msg":"Failed to create user credentials"}
{"level":50,"time":1768715735432,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["7bca9f20-54c7-4b61-a81c-14b923ca30de","$2b$12$YEhErZB1f8GEsNbyHN.OKuTLxxWfs3SY1C8clfW0/Q.oG7ZI.BRSa"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(7bca9f20-54c7-4b61-a81c-14b923ca30de) is not present in table \"users\".","schema":"test_schema_w93_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768715735447,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715735448,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/ownershipAccess.test.ts [2m([22m[2m19 tests[22m[2m | [22m[31m6 failed[39m[2m)[22m[33m 16056[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow access to user-owned asset by owner [33m 667[2mms[22m[39m
       [32m‚úì[39m should deny access to user-owned asset by non-owner[32m 220[2mms[22m[39m
[31m       [31m√ó[31m should allow access to org-owned asset by org member[39m[33m 1214[2mms[22m[39m
       [33m[2m‚úì[22m[39m should deny access to org-owned asset by non-member [33m 664[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow access to null ownership (legacy data) [33m 711[2mms[22m[39m
[31m       [31m√ó[31m should return true for org member[39m[33m 882[2mms[22m[39m
       [32m‚úì[39m should return false for non-member[32m 262[2mms[22m[39m
[31m       [31m√ó[31m should return true for org admin[39m[33m 1333[2mms[22m[39m
[31m       [31m√ó[31m should return true for org admin[39m[33m 731[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return false for org member (non-admin) [33m 456[2mms[22m[39m
       [32m‚úì[39m should return false for non-member[32m 243[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return all org IDs for a user [33m 464[2mms[22m[39m
       [32m‚úì[39m should return empty array for user with no memberships[32m 249[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow creating user-owned asset if ownerUuid matches userId [33m 705[2mms[22m[39m
       [32m‚úì[39m should deny creating user-owned asset if ownerUuid does not match userId[32m 190[2mms[22m[39m
[31m       [31m√ó[31m should allow creating org-owned asset if user is member[39m[33m 1208[2mms[22m[39m
       [33m[2m‚úì[22m[39m should deny creating org-owned asset if user is not member [33m 698[2mms[22m[39m
[31m       [31m√ó[31m should not allow member of org1 to access org2-owned assets[39m[33m 1277[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow member of multiple orgs to access all their org assets [33m 929[2mms[22m[39m
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39müìä Schema test_schema_w92_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39müìä Schema test_schema_w99_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715735791,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715735792,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715735792,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768715735793,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w97_v3\",public"}
{"level":30,"time":1768715735840,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715735840,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/organizations-audit-fixes.test.ts [2m([22m[2m8 tests[22m[2m | [22m[33m8 skipped[39m[2m)[22m[33m 3573[2mms[22m[39m
       [2m[90m‚Üì[39m[22m should cascade ownership to workflow runs when project is transferred
       [2m[90m‚Üì[39m[22m should prevent double-acceptance via transaction
       [2m[90m‚Üì[39m[22m should not create invite if email fails
       [2m[90m‚Üì[39m[22m should allow re-invite after invite expires
       [2m[90m‚Üì[39m[22m should allow last admin to delete empty organization
       [2m[90m‚Üì[39m[22m should prevent deletion if org owns assets
       [2m[90m‚Üì[39m[22m should cleanup placeholder user when invite is revoked
       [2m[90m‚Üì[39m[22m should fail fast on non-existent org
{"level":30,"time":1768715735873,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39müßπ Cleaning up test environment...

 [31m‚ùØ[39m tests/unit/services/PdfQueueService.test.ts [2m([22m[2m15 tests[22m[2m | [22m[31m13 failed[39m[2m)[22m[33m 18422[2mms[22m[39m
[31m       [31m√ó[31m should enqueue a PDF conversion job[39m[33m 1028[2mms[22m[39m
[31m       [31m√ó[31m should create output with empty storagePath initially[39m[33m 989[2mms[22m[39m
[31m       [31m√ó[31m should return job status for pending job[39m[33m 1038[2mms[22m[39m
[31m       [31m√ó[31m should return null for non-existent job[39m[33m 1084[2mms[22m[39m
[31m       [31m√ó[31m should parse attempt count from error field[39m[33m 1171[2mms[22m[39m
[31m       [31m√ó[31m should convert DOCX to PDF immediately[39m[33m 867[2mms[22m[39m
[31m       [31m√ó[31m should handle conversion errors gracefully[39m[33m 807[2mms[22m[39m
[31m       [31m√ó[31m should start and stop service[39m[33m 1000[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not start if already running [33m 1598[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle stop when not running [33m 571[2mms[22m[39m
[31m       [31m√ó[31m should process pending jobs when queue is processed[39m[33m 830[2mms[22m[39m
[31m       [31m√ó[31m should process multiple jobs in batch[39m[33m 1202[2mms[22m[39m
[31m       [31m√ó[31m should handle missing DOCX output gracefully[39m[33m 1349[2mms[22m[39m
[31m       [31m√ó[31m should support enqueue within transaction[39m[33m 805[2mms[22m[39m
[31m       [31m√ó[31m should support convertImmediate within transaction[39m[33m 1204[2mms[22m[39m
{"level":50,"time":1768715735972,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["w9YyX3QmY8sjD-MjsCt_f","$2b$12$eTG2.7OcyDrLTP0NG3MsIO9OVGu4xOowEaK96qJNAxoD0Y0ZX0W92"],"cause":{"length":332,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(w9YyX3QmY8sjD-MjsCt_f) is not present in table \"users\".","schema":"test_schema_w93_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"w9YyX3QmY8sjD-MjsCt_f","msg":"Failed to create user credentials"}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [31m‚ùØ[39m tests/integration/api.runs.docx.test.ts [2m([22m[2m6 tests[22m[2m | [22m[33m6 skipped[39m[2m)[22m[33m 3901[2mms[22m[39m
       [2m[90m‚Üì[39m[22m should execute workflow with template node and generate DOCX
       [2m[90m‚Üì[39m[22m should handle missing template data gracefully
       [2m[90m‚Üì[39m[22m should download DOCX output from successful run
       [2m[90m‚Üì[39m[22m should return 404 for PDF when not generated
       [2m[90m‚Üì[39m[22m should return 404 for non-existent run
       [2m[90m‚Üì[39m[22m should extract placeholders from uploaded template
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w97_v3, public
‚úÖ Enforced search_path: test_schema_w97_v3, public

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715736710,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715736711,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w99_v3\",public"}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768715736776,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w97_v3
‚úÖ Current search_path: test_schema_w97_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715736821,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715736822,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w92_v3\",public"}
{"level":30,"time":1768715736895,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768715737269,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715737270,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

 [32m‚úì[39m tests/ui/datavault/TableCard.test.tsx [2m([22m[2m8 tests[22m[2m)[22m[33m 5632[2mms[22m[39m
     [33m[2m‚úì[22m[39m should call onDelete when delete button is clicked [33m 1319[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w99_v3, public
‚úÖ Enforced search_path: test_schema_w99_v3, public

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould prevent transfer to org if user is not a member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,ad2ee784-104e-4881-a936-e5f68b8b12f7,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'ad2ee784-104e-4881-a936-e5f68b8b12f7'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m523[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (bd74c28d-14bf-4657-85d9-232193cf5d54, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, ad2ee784-104e-4881-a936-e5f68b8b12f7, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 05:55:38.703208, 2026-01-18 05:55:38.703208).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w91_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w99_v3
‚úÖ Current search_path: test_schema_w99_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m‚úÖ Set default search_path for database: test_schema_w92_v3, public
‚úÖ Enforced search_path: test_schema_w92_v3, public

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w92_v3
‚úÖ Current search_path: test_schema_w92_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768715737954,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715737955,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

 [32m‚úì[39m tests/unit/utils/variableResolver.test.ts [2m([22m[2m20 tests[22m[2m)[22m[33m 4060[2mms[22m[39m
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w103_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w103_v3 (Reused: true)

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768715738632,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w101_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w101_v3 (Reused: true)

{"level":30,"time":1768715738806,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715738806,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w102_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32m‚úì[39m tests/unit/shared/validation/stepConfigSchemas.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 4077[2mms[22m[39m
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w102_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39müìä Schema test_schema_w103_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715738869,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715738870,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w103_v3\",public"}
{"level":30,"time":1768715738929,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w105_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w105_v3 (Reused: true)

{"level":30,"time":1768715739077,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715739078,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/ui/datavault/TemplateCard.test.tsx [2m([22m[2m6 tests[22m[2m)[22m[33m 4458[2mms[22m[39m
{"level":30,"time":1768715739181,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39müìä Schema test_schema_w101_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715739200,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715739201,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w101_v3\",public"}
{"level":30,"time":1768715739252,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould allow org member to transfer org-owned project to another org they belong to
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,573d5cc4-b7b2-496b-a8cc-6d96e2ec6b6d,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'573d5cc4-b7b2-496b-a8cc-6d96e2ec6b6d'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m523[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (14699aeb-8515-4ca1-a2de-cadd5a2f7f29, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 573d5cc4-b7b2-496b-a8cc-6d96e2ec6b6d, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 05:55:40.401038, 2026-01-18 05:55:40.401038).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w93_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39müìä Schema test_schema_w102_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715739287,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715739288,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w102_v3\",public"}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w100_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768715739345,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w100_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39müìä Schema test_schema_w105_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768715739496,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w106_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w103_v3, public
‚úÖ Enforced search_path: test_schema_w103_v3, public

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w106_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w85_v3
‚úÖ Current search_path: test_schema_w85_v3, public
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768715739797,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39müìä Schema test_schema_w100_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w107_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w107_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w101_v3, public
‚úÖ Enforced search_path: test_schema_w101_v3, public

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w102_v3, public
‚úÖ Enforced search_path: test_schema_w102_v3, public

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w102_v3
‚úÖ Current search_path: test_schema_w102_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39müìä Schema test_schema_w106_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w85_v3
‚úÖ Current search_path: test_schema_w85_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715740254,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715740255,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w105_v3\",public"}
{"level":30,"time":1768715740303,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39müìä Schema test_schema_w107_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould keep workflow in project when transferring to same owner
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,87e44f23-4b80-4799-8ea9-05115f2913de,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'87e44f23-4b80-4799-8ea9-05115f2913de'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m523[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (2c8bfc99-2042-4154-ad2d-9545a6f4f5b6, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 87e44f23-4b80-4799-8ea9-05115f2913de, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 05:55:41.572219, 2026-01-18 05:55:41.572219).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w81_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w104_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w104_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715740671,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715740671,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w100_v3\",public"}
{"level":30,"time":1768715740720,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715740889,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715740890,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w106_v3\",public"}
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

{"level":30,"time":1768715740922,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768715740939,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715740940,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/unit/services/DataSourceService.test.ts [2m([22m[2m9 tests[22m[2m)[22m[33m 2935[2mms[22m[39m
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39müìä Schema test_schema_w104_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w94_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w94_v3 (Reused: true)

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w105_v3, public
‚úÖ Enforced search_path: test_schema_w105_v3, public

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w105_v3
‚úÖ Current search_path: test_schema_w105_v3, public
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768715741237,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715741238,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/datavault.api-tokens.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 2897[2mms[22m[39m
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w95_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39müìä Schema test_schema_w94_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715741461,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715741462,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w94_v3\",public"}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m‚úÖ Set default search_path for database: test_schema_w100_v3, public
‚úÖ Enforced search_path: test_schema_w100_v3, public

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w95_v3 (Reused: true)

{"level":30,"time":1768715741507,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768715741557,"env":"test","module":"user-credentials-repository","userId":"GsCTM6SfkM1wuumNNWnri","msg":"User credentials created"}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w100_v3
‚úÖ Current search_path: test_schema_w100_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w106_v3, public
‚úÖ Enforced search_path: test_schema_w106_v3, public

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w96_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715741762,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715741763,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w104_v3\",public"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w96_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w106_v3
‚úÖ Current search_path: test_schema_w106_v3, public
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768715741811,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w107_v3, public
‚úÖ Enforced search_path: test_schema_w107_v3, public

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould prevent non-member from transferring org workflow
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,332edd8e-c678-40bf-84e2-1fdeeb1f68c7,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'332edd8e-c678-40bf-84e2-1fdeeb1f68c7'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m521[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (247492ae-5906-497c-93d7-f581816bb142, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 332edd8e-c678-40bf-84e2-1fdeeb1f68c7, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 05:55:43.01313, 2026-01-18 05:55:43.01313).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w93_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39müìä Schema test_schema_w95_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715741937,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715741937,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w95_v3\",public"}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w107_v3
‚úÖ Current search_path: test_schema_w107_v3, public
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768715741980,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w98_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w98_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39müìä Schema test_schema_w96_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715742220,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715742220,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w96_v3\",public"}
{"level":30,"time":1768715742255,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w108_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w94_v3, public
‚úÖ Enforced search_path: test_schema_w94_v3, public

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w108_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m‚úÖ Applied failsafe schema fixes

{"level":30,"time":1768715742387,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715742388,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w95_v3
‚úÖ Current search_path: test_schema_w93_v3, public
‚è© Schema reused, skipping migrations.

 [32m‚úì[39m tests/unit/services/docxHelpers.test.ts [2m([22m[2m39 tests[22m[2m)[22m[33m 3805[2mms[22m[39m
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39müìä Schema test_schema_w98_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715742471,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715742471,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w98_v3\",public"}
{"level":30,"time":1768715742515,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m‚úÖ Set default search_path for database: test_schema_w104_v3, public
‚úÖ Enforced search_path: test_schema_w104_v3, public

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w104_v3
‚úÖ Current search_path: test_schema_w104_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39müìä Schema test_schema_w108_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w95_v3, public
‚úÖ Enforced search_path: test_schema_w95_v3, public

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould validate expression after debounce
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715742766,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715742767,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w108_v3\",public"}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768715742804,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w81_v3
‚úÖ Current search_path: test_schema_w85_v3, public
‚è© Schema reused, skipping migrations.

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould return validation errors for invalid expression
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768715742948,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715742949,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/auth.routes.test.ts [2m([22m[2m41 tests[22m[2m)[22m[33m 3622[2mms[22m[39m
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w96_v3, public
‚úÖ Enforced search_path: test_schema_w96_v3, public

[90mstdout[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould return validation errors for invalid expression
[22m[39mValidation Result DEBUG: {"ok":false,"errors":[{"message":"Unknown identifier: unknown_var","start":{"line":0,"col":0},"end":{"line":0,"col":11}}]}
IsValid DEBUG: [33mfalse[39m

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould debounce validation calls
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/BlockRunner.validate.test.ts [2m([22m[2m7 tests[22m[2m)[22m[33m 3481[2mms[22m[39m
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w98_v3
‚úÖ Current search_path: test_schema_w81_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w110_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w110_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould not validate when workflowId or nodeId is missing
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould not validate when workflowId or nodeId is missing
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w98_v3, public
‚úÖ Enforced search_path: test_schema_w98_v3, public

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould validate helper functions in expressions
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w95_v3
‚úÖ Current search_path: test_schema_w95_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould validate complex expressions with multiple helpers
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768715743539,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768715743557,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39müìö API Documentation available at /api-docs

{"level":30,"time":1768715743547,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768715743548,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768715743552,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768715743552,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768715743557,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768715743557,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768715743557,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768715743557,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w108_v3, public
‚úÖ Enforced search_path: test_schema_w108_v3, public

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39müìä Schema test_schema_w110_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould handle syntax errors
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w108_v3
‚úÖ Current search_path: test_schema_w108_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w111_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w112_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression Editor component behavior[2m > [22m[2mshould update validation when expression changes
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w111_v3 (Reused: true)

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w112_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression Editor component behavior[2m > [22m[2mshould update validation when expression changes
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":30,"time":1768715743948,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715743948,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768715743964,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768715743985,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.projects.test.ts[2m > [22m[2mProjects API Integration Tests
[22m[39müìö API Documentation available at /api-docs

{"level":30,"time":1768715743973,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768715743973,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768715743978,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768715743979,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768715743984,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768715743984,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768715743984,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768715743984,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
 [32m‚úì[39m tests/ui/common/Breadcrumbs.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 3837[2mms[22m[39m
{"level":30,"time":1768715744003,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715744004,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/ui/expression-editor.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 5095[2mms[22m[39m
{"level":30,"time":1768715744136,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715744137,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715744151,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715744152,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w110_v3\",public"}
{"level":30,"time":1768715744153,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715744154,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

 [31m‚ùØ[39m tests/integration/transferOwnership.test.ts [2m([22m[2m11 tests[22m[2m | [22m[31m11 failed[39m[2m)[22m[33m 10565[2mms[22m[39m
[31m       [31m√ó[31m should transfer user-owned project to org[39m[32m 167[2mms[22m[39m
[31m       [31m√ó[31m should prevent transfer to org if user is not a member[39m[33m 1745[2mms[22m[39m
[31m       [31m√ó[31m should allow org member to transfer org-owned project to another org they belong to[39m[33m 1084[2mms[22m[39m
[31m       [31m√ó[31m should detach workflow from project when transferring to different owner[39m[32m 273[2mms[22m[39m
[31m       [31m√ó[31m should keep workflow in project when transferring to same owner[39m[33m 1067[2mms[22m[39m
[31m       [31m√ó[31m should prevent non-member from transferring org workflow[39m[33m 1268[2mms[22m[39m
[31m       [31m√ó[31m should transfer database ownership[39m[33m 643[2mms[22m[39m
[31m       [31m√ó[31m should allow org member to transfer org database[39m[32m 279[2mms[22m[39m
[31m       [31m√ó[31m should prevent transfer to org if user is not a member[39m[33m 661[2mms[22m[39m
[31m       [31m√ó[31m should only allow transfer to self when targetOwnerType is user[39m[32m 230[2mms[22m[39m
[31m       [31m√ó[31m should allow transfer from user to self (org member transferring org asset to themselves)[39m[32m 254[2mms[22m[39m
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39müìä Schema test_schema_w111_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715744204,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768715744212,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["cb3a7a6b-825d-48a1-ab57-982b01f3132b","$2b$12$l.S1wcBaWFz0jpyA4DPetuCyAQolzbavstFqhrRGvlM06hQqomSJe"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(cb3a7a6b-825d-48a1-ab57-982b01f3132b) is not present in table \"users\".","schema":"test_schema_w85_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"cb3a7a6b-825d-48a1-ab57-982b01f3132b","msg":"Failed to create user credentials"}
{"level":50,"time":1768715744212,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["cb3a7a6b-825d-48a1-ab57-982b01f3132b","$2b$12$l.S1wcBaWFz0jpyA4DPetuCyAQolzbavstFqhrRGvlM06hQqomSJe"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(cb3a7a6b-825d-48a1-ab57-982b01f3132b) is not present in table \"users\".","schema":"test_schema_w85_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/session.management.integration.test.ts:31:15

[90mstdout[2m | tests/integration/api.templates-runs.test.ts[2m > [22m[2mTemplates and Runs API Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/api.templates-runs.test.ts[2m > [22m[2mTemplates and Runs API Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768715744226,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768715744226,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768715744229,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39müìä Schema test_schema_w112_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715744256,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts[2m > [22m[2mTemplates and Runs API Integration Tests
[22m[39müìö API Documentation available at /api-docs

 [31m‚ùØ[39m tests/integration/auth/oauth2.sessions.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m25 failed[39m[2m)[22m[33m 13982[2mms[22m[39m
[31m       [31m√ó[31m should list all active sessions for current user[39m[32m 235[2mms[22m[39m
[31m       [31m√ó[31m should mark current session as current[39m[33m 395[2mms[22m[39m
[31m       [31m√ó[31m should return empty array when user has no active sessions[39m[33m 595[2mms[22m[39m
[31m       [31m√ó[31m should not include expired sessions[39m[33m 420[2mms[22m[39m
[31m       [31m√ó[31m should not include revoked sessions[39m[33m 388[2mms[22m[39m
[31m       [31m√ó[31m should parse device name from user agent[39m[33m 820[2mms[22m[39m
[31m       [31m√ó[31m should return 401 for unauthenticated request[39m[33m 384[2mms[22m[39m
[31m       [31m√ó[31m should revoke a specific session[39m[33m 404[2mms[22m[39m
[31m       [31m√ó[31m should return 404 for non-existent session[39m[33m 403[2mms[22m[39m
[31m       [31m√ó[31m should prevent revoking current session[39m[33m 576[2mms[22m[39m
[31m       [31m√ó[31m should prevent revoking another user's session[39m[33m 388[2mms[22m[39m
[31m       [31m√ó[31m should return 401 for unauthenticated request[39m[33m 393[2mms[22m[39m
[31m       [31m√ó[31m should revoke all sessions except current[39m[33m 405[2mms[22m[39m
[31m       [31m√ó[31m should revoke all trusted devices[39m[33m 393[2mms[22m[39m
[31m       [31m√ó[31m should return 400 when no active session found[39m[33m 738[2mms[22m[39m
[31m       [31m√ó[31m should return 401 for unauthenticated request[39m[33m 389[2mms[22m[39m
[31m         [31m√ó[31m should mark current device as trusted[39m[33m 380[2mms[22m[39m
[31m         [31m√ó[31m should update existing trusted device expiry[39m[33m 379[2mms[22m[39m
[31m         [31m√ó[31m should list all trusted devices[39m[33m 386[2mms[22m[39m
[31m         [31m√ó[31m should not include revoked devices[39m[33m 392[2mms[22m[39m
[31m         [31m√ó[31m should revoke a trusted device[39m[33m 403[2mms[22m[39m
[31m         [31m√ó[31m should return 404 for non-existent device[39m[33m 389[2mms[22m[39m
[31m       [31m√ó[31m should track IP address for sessions[39m[33m 381[2mms[22m[39m
[31m       [31m√ó[31m should track user agent for sessions[39m[33m 397[2mms[22m[39m
[31m       [31m√ó[31m should update lastUsedAt on token refresh[39m[33m 597[2mms[22m[39m
{"level":30,"time":1768715744241,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768715744242,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768715744249,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768715744249,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768715744255,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768715744255,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768715744256,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768715744256,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts[2m > [22m[2mLifecycle Hooks Execution
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts[2m > [22m[2mLifecycle Hooks Execution
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768715744522,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
 [31m‚ùØ[39m tests/integration/auth/session.management.integration.test.ts [2m([22m[2m18 tests[22m[2m | [22m[33m18 skipped[39m[2m)[22m[33m 3617[2mms[22m[39m
       [2m[90m‚Üì[39m[22m should create refresh token on login
       [2m[90m‚Üì[39m[22m should track device metadata in session
       [2m[90m‚Üì[39m[22m should create separate sessions for multiple device logins
       [2m[90m‚Üì[39m[22m should list all active sessions for user
       [2m[90m‚Üì[39m[22m should mark current session correctly
       [2m[90m‚Üì[39m[22m should not include revoked sessions
       [2m[90m‚Üì[39m[22m should order sessions by last used (most recent first)
       [2m[90m‚Üì[39m[22m should require authentication
       [2m[90m‚Üì[39m[22m should revoke specific session
       [2m[90m‚Üì[39m[22m should prevent revoking current session
       [2m[90m‚Üì[39m[22m should not allow revoking other users sessions
       [2m[90m‚Üì[39m[22m should return 404 for non-existent session ID
       [2m[90m‚Üì[39m[22m should revoke all sessions except current
       [2m[90m‚Üì[39m[22m should revoke all trusted devices
       [2m[90m‚Üì[39m[22m should require active session
       [2m[90m‚Üì[39m[22m should reject refresh token after 30 days
       [2m[90m‚Üì[39m[22m should handle multiple concurrent logins
       [2m[90m‚Üì[39m[22m should handle concurrent token refreshes
{"level":30,"time":1768715744546,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts[2m > [22m[2mLifecycle Hooks Execution
[22m[39müìö API Documentation available at /api-docs

{"level":30,"time":1768715744532,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768715744533,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768715744539,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768715744539,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768715744545,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768715744545,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768715744545,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768715744545,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768715744561,"env":"test","module":"user-credentials-repository","userId":"3e5fdf9d-ede9-4145-a0fe-b7ef2603b5d8","msg":"User credentials created"}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

{"level":50,"time":1768715744742,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["3e5fdf9d-ede9-4145-a0fe-b7ef2603b5d8","10275fe0d9d032bc776684a860e60229822a59dca777a4c883249f5b9a4c5da9","2026-01-19T05:55:44.562Z"],"cause":{"length":383,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(3e5fdf9d-ede9-4145-a0fe-b7ef2603b5d8) is not present in table \"users\".","schema":"test_schema_w98_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768715744794,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715744794,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/schema/documentEngine.test.ts [2m([22m[2m33 tests[22m[2m)[22m[33m 2894[2mms[22m[39m
{"level":50,"time":1768715744891,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["66ae9760-4fe8-4b07-9ac3-e9ba83a9db5d","$2b$12$vyRaCW3/uu4NFZDE4pizYeTN15GXjDaxOqrs3n6b1Z5UWaQ1YWIj2"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(66ae9760-4fe8-4b07-9ac3-e9ba83a9db5d) is not present in table \"users\".","schema":"test_schema_w98_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"66ae9760-4fe8-4b07-9ac3-e9ba83a9db5d","msg":"Failed to create user credentials"}
{"level":50,"time":1768715744891,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["66ae9760-4fe8-4b07-9ac3-e9ba83a9db5d","$2b$12$vyRaCW3/uu4NFZDE4pizYeTN15GXjDaxOqrs3n6b1Z5UWaQ1YWIj2"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(66ae9760-4fe8-4b07-9ac3-e9ba83a9db5d) is not present in table \"users\".","schema":"test_schema_w98_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/api.templates-runs.test.ts[2m > [22m[2mTemplates and Runs API Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at Module.setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/api.templates-runs.test.ts:59:11

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715744908,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768715744908,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w113_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w113_v3 (Reused: true)

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w110_v3, public
‚úÖ Enforced search_path: test_schema_w110_v3, public

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715745054,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715745055,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w111_v3\",public"}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w115_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w110_v3
‚úÖ Current search_path: test_schema_w110_v3, public
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768715745103,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w115_v3 (Reused: true)

{"level":30,"time":1768715745131,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715745131,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715745160,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715745161,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w112_v3\",public"}
 [31m‚ùØ[39m tests/integration/api.templates-runs.test.ts [2m([22m[2m15 tests[22m[2m | [22m[33m15 skipped[39m[2m)[22m[33m 3536[2mms[22m[39m
         [2m[90m‚Üì[39m[22m should create template with file upload
         [2m[90m‚Üì[39m[22m should reject non-docx files
         [2m[90m‚Üì[39m[22m should reject without file
         [2m[90m‚Üì[39m[22m should list templates
         [2m[90m‚Üì[39m[22m should get template by ID
         [2m[90m‚Üì[39m[22m should extract placeholders
         [2m[90m‚Üì[39m[22m should update template name
         [2m[90m‚Üì[39m[22m should delete template
         [2m[90m‚Üì[39m[22m should execute workflow
         [2m[90m‚Üì[39m[22m should include logs in debug mode
         [2m[90m‚Üì[39m[22m should reject without required permission
         [2m[90m‚Üì[39m[22m should list runs
         [2m[90m‚Üì[39m[22m should filter by workflowId
         [2m[90m‚Üì[39m[22m should get run by ID
         [2m[90m‚Üì[39m[22m should get run logs
{"level":30,"time":1768715745204,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768715745237,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["30200df2-74fc-40d4-b39b-63b702c27d98","$2b$12$p9w4ekcrMMn5CZ3uwvB4EeYdH0aRUFIK6ammjriFufUUNR2xpgkhW"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(30200df2-74fc-40d4-b39b-63b702c27d98) is not present in table \"users\".","schema":"test_schema_w95_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"30200df2-74fc-40d4-b39b-63b702c27d98","msg":"Failed to create user credentials"}
{"level":50,"time":1768715745237,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["30200df2-74fc-40d4-b39b-63b702c27d98","$2b$12$p9w4ekcrMMn5CZ3uwvB4EeYdH0aRUFIK6ammjriFufUUNR2xpgkhW"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(30200df2-74fc-40d4-b39b-63b702c27d98) is not present in table \"users\".","schema":"test_schema_w95_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/lifecycle-hooks-execution.test.ts[2m > [22m[2mLifecycle Hooks Execution
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/lifecycle-hooks-execution.test.ts:41:11

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715745251,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768715745251,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w116_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39müìä Schema test_schema_w113_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w116_v3 (Reused: true)

 [31m‚ùØ[39m tests/integration/api.projects.test.ts [2m([22m[2m10 tests[22m[2m | [22m[33m10 skipped[39m[2m)[22m[33m 4041[2mms[22m[39m
       [2m[90m‚Üì[39m[22m should create a new project
       [2m[90m‚Üì[39m[22m should reject without authentication
       [2m[90m‚Üì[39m[22m should reject with invalid data
       [2m[90m‚Üì[39m[22m should list projects for tenant
       [2m[90m‚Üì[39m[22m should support pagination
       [2m[90m‚Üì[39m[22m should get project by ID
       [2m[90m‚Üì[39m[22m should return 404 for non-existent project
       [2m[90m‚Üì[39m[22m should update project
       [2m[90m‚Üì[39m[22m should soft-delete project
       [2m[90m‚Üì[39m[22m should not allow cross-tenant access
{"level":30,"time":1768715745410,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w117_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w117_v3 (Reused: true)

 [31m‚ùØ[39m tests/integration/lifecycle-hooks-execution.test.ts [2m([22m[2m15 tests[22m[2m | [22m[33m15 skipped[39m[2m)[22m[33m 3618[2mms[22m[39m
       [2m[90m‚Üì[39m[22m should execute beforePage hook and capture console output
       [2m[90m‚Üì[39m[22m should execute beforePage hook with mutation mode enabled
       [2m[90m‚Üì[39m[22m should handle errors gracefully without breaking workflow
       [2m[90m‚Üì[39m[22m should execute afterPage hook with user input data
       [2m[90m‚Üì[39m[22m should execute Python afterPage hook
       [2m[90m‚Üì[39m[22m should execute beforeFinalBlock hook before document generation
       [2m[90m‚Üì[39m[22m should execute afterDocumentsGenerated hook for cleanup
       [2m[90m‚Üì[39m[22m should timeout hook that exceeds timeoutMs limit
       [2m[90m‚Üì[39m[22m should execute multiple hooks in correct order
       [2m[90m‚Üì[39m[22m should list all hooks for a workflow
       [2m[90m‚Üì[39m[22m should update a hook
       [2m[90m‚Üì[39m[22m should delete a hook
       [2m[90m‚Üì[39m[22m should test a hook with sample data
       [2m[90m‚Üì[39m[22m should retrieve execution logs for a run
       [2m[90m‚Üì[39m[22m should clear execution logs for a run
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39müìä Schema test_schema_w115_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w118_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w118_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39müìä Schema test_schema_w116_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w114_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w111_v3, public
‚úÖ Enforced search_path: test_schema_w111_v3, public

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w114_v3 (Reused: true)

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39müìä Schema test_schema_w117_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w112_v3, public
‚úÖ Enforced search_path: test_schema_w112_v3, public

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w111_v3
‚úÖ Current search_path: test_schema_w111_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715746053,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715746054,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w113_v3\",public"}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w119_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w112_v3
‚úÖ Current search_path: test_schema_w112_v3, public
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768715746101,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w119_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39müìä Schema test_schema_w118_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

{"level":30,"time":1768715746273,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715746274,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/engine.expr.test.ts [2m([22m[2m26 tests[22m[2m)[22m[33m 3503[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715746326,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715746327,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w115_v3\",public"}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39müìä Schema test_schema_w114_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715746331,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715746332,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w114_v3\",public"}
{"level":30,"time":1768715746381,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768715746386,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768715746535,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715746535,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39müìä Schema test_schema_w119_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715746594,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715746595,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w116_v3\",public"}
 [31m‚ùØ[39m tests/integration/auth/oauth2.token-refresh.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m24 failed[39m[2m)[22m[33m 14653[2mms[22m[39m
[31m       [31m√ó[31m should refresh access token with valid refresh token[39m[33m 489[2mms[22m[39m
[31m       [31m√ó[31m should rotate refresh token after use[39m[33m 427[2mms[22m[39m
[31m       [31m√ó[31m should return 401 when refresh token is missing[39m[33m 404[2mms[22m[39m
[31m       [31m√ó[31m should return 401 for invalid refresh token[39m[33m 396[2mms[22m[39m
[31m       [31m√ó[31m should return 401 for expired refresh token[39m[33m 408[2mms[22m[39m
[31m       [31m√ó[31m should return 401 for revoked refresh token[39m[33m 398[2mms[22m[39m
[31m       [31m√ó[31m should return 401 when user is not found[39m[33m 398[2mms[22m[39m
[31m       [31m√ó[31m should update refresh token metadata on rotation[39m[33m 381[2mms[22m[39m
[31m       [31m√ó[31m should handle concurrent refresh token requests (token reuse detection)[39m[33m 389[2mms[22m[39m
[31m       [31m√ó[31m should set secure cookie in production[39m[33m 397[2mms[22m[39m
[31m       [31m√ó[31m should set proper cookie attributes[39m[33m 383[2mms[22m[39m
[31m       [31m√ó[31m should include user role information in response[39m[33m 386[2mms[22m[39m
[31m       [31m√ó[31m should create refresh token on login[39m[33m 398[2mms[22m[39m
[31m       [31m√ó[31m should revoke refresh token on logout[39m[33m 600[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle logout without refresh token gracefully [33m 1024[2mms[22m[39m
[31m       [31m√ó[31m should support multiple active refresh tokens per user[39m[32m 290[2mms[22m[39m
[31m       [31m√ó[31m should revoke all user tokens on password reset[39m[33m 395[2mms[22m[39m
[31m       [31m√ó[31m should use cryptographically strong random tokens[39m[33m 595[2mms[22m[39m
[31m       [31m√ó[31m should hash refresh tokens before storing in database[39m[33m 591[2mms[22m[39m
[31m       [31m√ó[31m should prevent refresh token reuse after rotation[39m[33m 380[2mms[22m[39m
[31m       [31m√ó[31m should validate token ownership[39m[33m 406[2mms[22m[39m
[31m       [31m√ó[31m should set HttpOnly flag to prevent XSS[39m[33m 462[2mms[22m[39m
[31m       [31m√ó[31m should set SameSite=Strict to prevent CSRF[39m[33m 409[2mms[22m[39m
[31m       [31m√ó[31m should set proper cookie path[39m[33m 388[2mms[22m[39m
[31m       [31m√ó[31m should set appropriate expiry (30 days)[39m[33m 383[2mms[22m[39m
{"level":30,"time":1768715746648,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715746758,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715746759,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w117_v3\",public"}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

{"level":30,"time":1768715746816,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w113_v3, public
‚úÖ Enforced search_path: test_schema_w113_v3, public

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w113_v3
‚úÖ Current search_path: test_schema_w113_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715747015,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715747015,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w118_v3\",public"}
{"level":30,"time":1768715747068,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w114_v3, public
‚úÖ Enforced search_path: test_schema_w114_v3, public

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w115_v3, public
‚úÖ Enforced search_path: test_schema_w115_v3, public

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w85_v3
‚úÖ Current search_path: test_schema_w85_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w115_v3
‚úÖ Current search_path: test_schema_w115_v3, public
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768715747277,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715747278,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/WorkflowChangeAnalyzer.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 3848[2mms[22m[39m
{"level":40,"time":1768715747350,"env":"test","error":{},"msg":"PDF conversion failed"}
{"level":30,"time":1768715747370,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715747371,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w116_v3, public
‚úÖ Enforced search_path: test_schema_w116_v3, public

 [32m‚úì[39m tests/unit/docxRenderer.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 3984[2mms[22m[39m
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715747451,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715747452,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w119_v3\",public"}
{"level":30,"time":1768715747503,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w116_v3
‚úÖ Current search_path: test_schema_w116_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w117_v3, public
‚úÖ Enforced search_path: test_schema_w117_v3, public

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w117_v3
‚úÖ Current search_path: test_schema_w117_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w109_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w118_v3, public
‚úÖ Enforced search_path: test_schema_w118_v3, public

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w109_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w118_v3
‚úÖ Current search_path: test_schema_w118_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":40,"time":1768715748123,"env":"test","module":"auth-middleware","path":"/test","msg":"No authorization token provided"}
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768715748144,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768715748147,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768715748152,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768715748154,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768715748156,"env":"test","module":"auth-middleware","path":"/test","msg":"No authorization token provided"}
{"level":30,"time":1768715748157,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768715748157,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/unit/middleware/auth.middleware.test.ts [2m([22m[2m22 tests[22m[2m | [22m[31m11 failed[39m[2m)[22m[33m 3635[2mms[22m[39m
       [32m‚úì[39m should authenticate with valid JWT token[32m 4[2mms[22m[39m
       [32m‚úì[39m should return 401 for missing token[32m 7[2mms[22m[39m
       [32m‚úì[39m should return 401 for invalid token[32m 1[2mms[22m[39m
       [32m‚úì[39m should return 401 for expired token[32m 1[2mms[22m[39m
       [32m‚úì[39m should extract token without Bearer prefix[32m 1[2mms[22m[39m
       [32m‚úì[39m should authenticate with valid token[32m 0[2mms[22m[39m
       [32m‚úì[39m should proceed without auth when no token provided[32m 0[2mms[22m[39m
       [32m‚úì[39m should proceed even with invalid token[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should authenticate with JWT Bearer token[39m[32m 8[2mms[22m[39m
[31m       [31m√ó[31m should authenticate with refresh token cookie for GET requests[39m[32m 2[2mms[22m[39m
[31m       [31m√ó[31m should reject cookie auth for POST requests[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should prioritize JWT over cookie when both present[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should allow cookie auth only for safe methods[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should return 401 when no auth provided[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should authenticate with JWT[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should authenticate with cookie for GET[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should proceed without auth when none provided[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should proceed even with invalid auth[39m[32m 2[2mms[22m[39m
       [32m‚úì[39m should not allow token tampering[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should not allow cookie auth for mutations (CSRF protection)[39m[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject malformed JWT[32m 1[2mms[22m[39m
       [32m‚úì[39m should handle missing authorization header gracefully[32m 1[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w119_v3, public
‚úÖ Enforced search_path: test_schema_w119_v3, public

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39müìä Schema test_schema_w109_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715748309,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715748309,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w109_v3\",public"}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":30,"time":1768715748359,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w119_v3
‚úÖ Current search_path: test_schema_w119_v3, public
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768715748399,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715748400,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/utils/conditionalLogic-simple.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 3751[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w123_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w123_v3 (Reused: true)

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768715748637,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715748638,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w122_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32m‚úì[39m tests/unit/services/TemplateAnalysisService.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 3681[2mms[22m[39m
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w122_v3 (Reused: true)

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w120_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w120_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768715748875,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715748876,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

 [32m‚úì[39m tests/unit/client/list-choice-options.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 3805[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39müìä Schema test_schema_w123_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715748937,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715748938,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w123_v3\",public"}
{"level":30,"time":1768715748992,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768715749119,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39müìä Schema test_schema_w122_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768715749120,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715749120,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768715749121,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w122_v3\",public"}
 [32m‚úì[39m tests/unit/services/repeater.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 3730[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w109_v3, public
‚úÖ Enforced search_path: test_schema_w109_v3, public

{"level":30,"time":1768715749173,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39müìä Schema test_schema_w120_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w114_v3
‚úÖ Current search_path: test_schema_w114_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w127_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w127_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715749536,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768715749536,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/shared/validation/Validator.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 3862[2mms[22m[39m
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w125_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w125_v3 (Reused: true)

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39müìä Schema test_schema_w127_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w123_v3, public
‚úÖ Enforced search_path: test_schema_w123_v3, public

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w122_v3
‚úÖ Current search_path: test_schema_w122_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w122_v3, public
‚úÖ Enforced search_path: test_schema_w122_v3, public

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w122_v3
‚úÖ Current search_path: test_schema_w122_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mgetUserOrganizations[2m > [22m[2mshould return all organizations for user
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,64752b51-2a44-4790-b4a1-07cfaf273d74,{"after":{"name":"User Org Test Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'64752b51-2a44-4790-b4a1-07cfaf273d74'[39m,
    [32m'{"after":{"name":"User Org Test Int","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:100:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m524[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (1dadb971-df27-48d1-8fea-e99228162b99, null, null, 00000000-0000-0000-0000-000000000011, organization.create, null, null, organization, 64752b51-2a44-4790-b4a1-07cfaf273d74, {"after": {"name": "User Org Test Int", "slug": null}}, null, null, null, 2026-01-18 05:55:51.261956, 2026-01-18 05:55:51.261956).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w109_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39müìä Schema test_schema_w125_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715750174,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715750175,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w125_v3\",public"}
{"level":30,"time":1768715750228,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715750232,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715750233,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w120_v3\",public"}
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715750293,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768715750470,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768715750495,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts[2m > [22m[2mDataVault v4 Regression Tests
[22m[39müìö API Documentation available at /api-docs

{"level":30,"time":1768715750480,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768715750481,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768715750488,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768715750488,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768715750494,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768715750495,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768715750495,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768715750495,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715750624,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715750625,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w127_v3\",public"}
{"level":30,"time":1768715750678,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":30,"time":1768715750895,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715750895,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w125_v3, public
‚úÖ Enforced search_path: test_schema_w125_v3, public

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m‚úÖ Set default search_path for database: test_schema_w120_v3, public
‚úÖ Enforced search_path: test_schema_w120_v3, public

{"level":30,"time":1768715751074,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w102_v3
‚úÖ Current search_path: test_schema_w102_v3, public
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768715751074,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/services/DatavaultTablesService.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 3015[2mms[22m[39m
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w120_v3
‚úÖ Current search_path: test_schema_w120_v3, public
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768715751171,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768715751202,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
 [31m‚ùØ[39m tests/integration/datavault-v4-regression.test.ts [2m([22m[2m23 tests[22m[2m | [22m[33m23 skipped[39m[2m)[22m[33m 3438[2mms[22m[39m
       [2m[90m‚Üì[39m[22m should create a select column with options
       [2m[90m‚Üì[39m[22m should create a multiselect column with options
       [2m[90m‚Üì[39m[22m should validate select value against options
       [2m[90m‚Üì[39m[22m should validate multiselect values as array
       [2m[90m‚Üì[39m[22m should create an autonumber column with sequence
       [2m[90m‚Üì[39m[22m should format autonumber with prefix
       [2m[90m‚Üì[39m[22m should create a note for a row
       [2m[90m‚Üì[39m[22m should get all notes for a row
       [2m[90m‚Üì[39m[22m should delete a note
       [2m[90m‚Üì[39m[22m should not allow deleting notes by other users
       [2m[90m‚Üì[39m[22m should create an API token
       [2m[90m‚Üì[39m[22m should validate API token scopes
       [2m[90m‚Üì[39m[22m should revoke (delete) an API token
       [2m[90m‚Üì[39m[22m should deny access with expired token
       [2m[90m‚Üì[39m[22m should grant table permission
       [2m[90m‚Üì[39m[22m should list table permissions
       [2m[90m‚Üì[39m[22m should update table permission role
       [2m[90m‚Üì[39m[22m should revoke table permission
       [2m[90m‚Üì[39m[22m should enforce RBAC - only owners can manage permissions
       [2m[90m‚Üì[39m[22m should paginate rows efficiently
       [2m[90m‚Üì[39m[22m should return user-friendly error for invalid column type
       [2m[90m‚Üì[39m[22m should return user-friendly error for missing required fields
       [2m[90m‚Üì[39m[22m should handle network errors gracefully
{"level":30,"time":1768715751233,"env":"test","module":"ai-controller","userId":"user-123","workflowId":"123e4567-e89b-12d3-a456-426614174000","descriptionLength":26,"msg":"AI logic generation requested"}
{"level":30,"time":1768715751234,"env":"test","module":"ai-controller","userId":"user-123","workflowId":"123e4567-e89b-12d3-a456-426614174000","duration":3,"changeCount":0,"msg":"AI logic generation succeeded"}
{"level":30,"time":1768715751253,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768715751291,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768715751310,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715751311,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

 [32m‚úì[39m tests/unit/api.ai.logic.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 3056[2mms[22m[39m
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w127_v3, public
‚úÖ Enforced search_path: test_schema_w127_v3, public

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mupdateOrganization[2m > [22m[2mshould deny non-admin from updating organization
[22m[39mCRITICAL: User lookup failed validation in beforeEach: [90mundefined[39m

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w127_v3
‚úÖ Current search_path: test_schema_w127_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w130_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w130_v3 (Reused: true)

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39müìä Schema test_schema_w130_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715752155,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715752156,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w130_v3\",public"}
{"level":30,"time":1768715752208,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w132_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w132_v3 (Reused: true)

{"level":30,"time":1768715752293,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715752294,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/debug_import.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 2960[2mms[22m[39m
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w129_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w129_v3 (Reused: true)

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39müìä Schema test_schema_w132_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715752746,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768715752746,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mgetOrganizationMembers[2m > [22m[2mshould return all members of organization
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,f5df68df-484f-4fc0-bb8d-3880f522fb93,{"after":{"name":"Members Test Org Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'f5df68df-484f-4fc0-bb8d-3880f522fb93'[39m,
    [32m'{"after":{"name":"Members Test Org Int","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:160:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m527[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (3cf9bcf5-d07a-4e22-87f2-593d4287c858, null, null, 00000000-0000-0000-0000-000000000011, organization.create, null, null, organization, f5df68df-484f-4fc0-bb8d-3880f522fb93, {"after": {"name": "Members Test Org Int", "slug": null}}, null, null, null, 2026-01-18 05:55:53.912862, 2026-01-18 05:55:53.912862).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w102_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

 [32m‚úì[39m tests/unit/captcha.service.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 3845[2mms[22m[39m
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39müìä Schema test_schema_w129_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715753001,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715753002,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w129_v3\",public"}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w130_v3, public
‚úÖ Enforced search_path: test_schema_w130_v3, public

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w134_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w102_v3
‚úÖ Current search_path: test_schema_w102_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w134_v3 (Reused: true)

{"level":30,"time":1768715753096,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w128_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":30,"time":1768715753238,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715753239,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w128_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715753315,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
 [32m‚úì[39m tests/ui/datavault/DatabaseSettingsPage.test.tsx [2m([22m[2m7 tests[22m[2m)[22m[33m 4907[2mms[22m[39m
     [33m[2m‚úì[22m[39m should render database settings page with breadcrumbs [33m 385[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39müìä Schema test_schema_w134_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39müìä Schema test_schema_w128_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715753684,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715753686,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w128_v3\",public"}
{"level":30,"time":1768715753776,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715753800,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715753813,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w132_v3\",public"}
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w129_v3, public
‚úÖ Enforced search_path: test_schema_w129_v3, public

{"level":30,"time":1768715753901,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w129_v3
‚úÖ Current search_path: test_schema_w129_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mpromoteMember[2m > [22m[2mshould allow admin to promote member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,9743b4e2-5ad2-439c-8a4d-6b71e63b4c90,{"after":{"name":"Promote Test Org Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'9743b4e2-5ad2-439c-8a4d-6b71e63b4c90'[39m,
    [32m'{"after":{"name":"Promote Test Org Int","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:179:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m527[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (0040f4c6-3315-4720-8579-20adffba6334, null, null, 00000000-0000-0000-0000-000000000011, organization.create, null, null, organization, 9743b4e2-5ad2-439c-8a4d-6b71e63b4c90, {"after": {"name": "Promote Test Org Int", "slug": null}}, null, null, null, 2026-01-18 05:55:55.184394, 2026-01-18 05:55:55.184394).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w114_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w121_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w121_v3 (Reused: true)

{"level":30,"time":1768715754303,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715754303,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768715754304,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
 [32m‚úì[39m tests/integration/branding.routes.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 3003[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w128_v3, public
‚úÖ Enforced search_path: test_schema_w128_v3, public

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w129_v3
‚úÖ Current search_path: test_schema_w129_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768715754679,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715754680,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w134_v3\",public"}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w132_v3, public
‚úÖ Enforced search_path: test_schema_w132_v3, public

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39müìä Schema test_schema_w121_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715754726,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715754726,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w121_v3\",public"}
{"level":30,"time":1768715754739,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w132_v3
‚úÖ Current search_path: test_schema_w132_v3, public
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768715754802,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mdemoteMember[2m > [22m[2mshould prevent self-demotion
[22m[39mCRITICAL: User lookup failed validation in beforeEach: [90mundefined[39m

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould skip question when condition is false
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: false. Context keys: 3

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute question when condition is true
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: true. Context keys: 4

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute question when condition is true
[22m[39m[DEBUG Question] Node q2 executed. Key: code, Value: ABC123. Context keys: 5

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould skip compute node when condition is false
[22m[39m[DEBUG Question] Node q1 executed. Key: amount, Value: 0. Context keys: 3

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute compute node when condition is true
[22m[39m[DEBUG Question] Node q1 executed. Key: amount, Value: 100. Context keys: 3

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould handle complex workflow with multiple conditions
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: false. Context keys: 4

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould handle complex workflow with multiple conditions
[22m[39m[DEBUG Question] Node q3 executed. Key: amount, Value: 1000. Context keys: 5

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mDebug Mode[2m > [22m[2mshould return trace when debug is enabled
[22m[39m[DEBUG Question] Node q1 executed. Key: name, Value: John. Context keys: 3

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mDebug Mode[2m > [22m[2mshould not return trace when debug is disabled
[22m[39m[DEBUG Question] Node q1 executed. Key: name, Value: John. Context keys: 3

{"level":30,"time":1768715755235,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715755236,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

 [32m‚úì[39m tests/unit/engine.run-conditions.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 3083[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w134_v3, public
‚úÖ Enforced search_path: test_schema_w134_v3, public

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w121_v3, public
‚úÖ Enforced search_path: test_schema_w121_v3, public

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w134_v3
‚úÖ Current search_path: test_schema_w134_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w121_v3
‚úÖ Current search_path: test_schema_w121_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715755823,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768715755824,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

{"level":30,"time":1768715755963,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715755963,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

 [32m‚úì[39m tests/unit/WorkflowOptimizationService.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 4111[2mms[22m[39m
 [32m‚úì[39m tests/integration/datavault.row-notes.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 3024[2mms[22m[39m
{"level":30,"time":1768715756081,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w124_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w124_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768715756820,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715756821,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39müìä Schema test_schema_w124_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715756831,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/api.workflows.test.ts[2m > [22m[2mWorkflows API Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/api.workflows.test.ts[2m > [22m[2mWorkflows API Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768715756855,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/api.workflows.test.ts[2m > [22m[2mWorkflows API Integration Tests
[22m[39müìö API Documentation available at /api-docs

{"level":30,"time":1768715756881,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768715756867,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768715756868,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768715756874,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768715756875,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768715756881,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768715756881,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768715756881,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768715756881,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768715756832,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w124_v3\",public"}
{"level":30,"time":1768715756904,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/unit/services/docxRenderer2.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 4145[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mleaveOrganization[2m > [22m[2mshould allow member to leave organization
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,adb5e96b-45f4-4f68-b4da-4e26ea6ad11e,{"after":{"name":"Leave Test Org Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'adb5e96b-45f4-4f68-b4da-4e26ea6ad11e'[39m,
    [32m'{"after":{"name":"Leave Test Org Int","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:257:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m525[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (f1891aa4-c084-4ce2-aa81-e347a6071803, null, null, 00000000-0000-0000-0000-000000000011, organization.create, null, null, organization, adb5e96b-45f4-4f68-b4da-4e26ea6ad11e, {"after": {"name": "Leave Test Org Int", "slug": null}}, null, null, null, 2026-01-18 05:55:58.535255, 2026-01-18 05:55:58.535255).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w114_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w126_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":50,"time":1768715757513,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["f00c4776-eb56-4f80-80e3-f56c490d7a7f","$2b$12$nyOrp8Fa3R4HsCMYrVAmPudFt.quMIaN9tf8SV2UAbMYU6zbytDwK"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(f00c4776-eb56-4f80-80e3-f56c490d7a7f) is not present in table \"users\".","schema":"test_schema_w121_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"f00c4776-eb56-4f80-80e3-f56c490d7a7f","msg":"Failed to create user credentials"}
{"level":50,"time":1768715757513,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["f00c4776-eb56-4f80-80e3-f56c490d7a7f","$2b$12$nyOrp8Fa3R4HsCMYrVAmPudFt.quMIaN9tf8SV2UAbMYU6zbytDwK"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(f00c4776-eb56-4f80-80e3-f56c490d7a7f) is not present in table \"users\".","schema":"test_schema_w121_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/integration/api.workflows.test.ts[2m > [22m[2mWorkflows API Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at Module.setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/api.workflows.test.ts:42:11

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715757528,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768715757529,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w126_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w124_v3, public
‚úÖ Enforced search_path: test_schema_w124_v3, public

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w121_v3
‚úÖ Current search_path: test_schema_w124_v3, public
‚è© Schema reused, skipping migrations.

 [31m‚ùØ[39m tests/integration/api.workflows.test.ts [2m([22m[2m17 tests[22m[2m | [22m[33m17 skipped[39m[2m)[22m[33m 3686[2mms[22m[39m
       [2m[90m‚Üì[39m[22m should create a new draft workflow
       [2m[90m‚Üì[39m[22m should reject without permission
       [2m[90m‚Üì[39m[22m should list workflows
       [2m[90m‚Üì[39m[22m should filter by status
       [2m[90m‚Üì[39m[22m should search by name
       [2m[90m‚Üì[39m[22m should update draft workflow
       [2m[90m‚Üì[39m[22m should not allow editing published workflow
       [2m[90m‚Üì[39m[22m should publish workflow
       [2m[90m‚Üì[39m[22m should list workflow versions
       [2m[90m‚Üì[39m[22m should move workflow to a project
       [2m[90m‚Üì[39m[22m should move workflow to Main Folder (projectId = null)
       [2m[90m‚Üì[39m[22m should reject move to non-existent project
       [2m[90m‚Üì[39m[22m should reject move without authentication
       [2m[90m‚Üì[39m[22m should reject move of workflow user does not own
       [2m[90m‚Üì[39m[22m should reject move with invalid projectId format
       [2m[90m‚Üì[39m[22m should reject move without projectId in body
       [2m[90m‚Üì[39m[22m should reject move to project user does not have access to
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39müìä Schema test_schema_w126_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715757973,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715757973,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w126_v3\",public"}
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w136_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w136_v3 (Reused: true)

{"level":30,"time":1768715758044,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w142_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w142_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w141_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768715758367,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w141_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39müìä Schema test_schema_w136_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715758462,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715758463,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w136_v3\",public"}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w139_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w140_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mleaveOrganization[2m > [22m[2mshould allow admin to leave organization
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,69c5ded2-4567-4b93-b172-9c4178f269b4,{"after":{"name":"Admin Leave Test Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'69c5ded2-4567-4b93-b172-9c4178f269b4'[39m,
    [32m'{"after":{"name":"Admin Leave Test Int","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:272:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m525[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (5a970703-368b-4bd3-bd06-5c2a202e1c3c, null, null, 00000000-0000-0000-0000-000000000011, organization.create, null, null, organization, 69c5ded2-4567-4b93-b172-9c4178f269b4, {"after": {"name": "Admin Leave Test Int", "slug": null}}, null, null, null, 2026-01-18 05:55:59.66179, 2026-01-18 05:55:59.66179).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w102_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":30,"time":1768715758521,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w139_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w140_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39müìä Schema test_schema_w142_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w126_v3, public
‚úÖ Enforced search_path: test_schema_w126_v3, public

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39müìä Schema test_schema_w141_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/integration/api.expression-validation.test.ts[2m > [22m[2mExpression Validation API Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/api.expression-validation.test.ts[2m > [22m[2mExpression Validation API Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768715758919,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w102_v3
‚úÖ Current search_path: test_schema_w126_v3, public
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768715758944,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts[2m > [22m[2mExpression Validation API Integration Tests
[22m[39müìö API Documentation available at /api-docs

{"level":30,"time":1768715758930,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768715758931,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768715758937,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768715758937,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768715758944,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768715758944,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768715758944,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768715758944,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39müìä Schema test_schema_w140_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstderr[2m | tests/unit/services/AuthService.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): Error: [vitest] No "closeDatabase" export is defined on the "../../../server/db" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

    at VitestMocker.createError [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:311:17[90m)[39m
    at Object.get [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:384:16[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:177:34
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m {
  codeFrame: [32m'vi.mock(import("../../../server/db"), async (importOriginal) => {\n'[39m +
    [32m'  const actual = await importOriginal()\n'[39m +
    [32m'  return {\n'[39m +
    [32m'    ...actual,\n'[39m +
    [32m'    // your mocked methods\n'[39m +
    [32m'  }\n'[39m +
    [32m'})'[39m
}

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39müìä Schema test_schema_w139_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715758974,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715758975,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w139_v3\",public"}
{"level":30,"time":1768715759024,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w131_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715759110,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768715759111,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w131_v3 (Reused: true)

 [31m‚ùØ[39m tests/unit/engine/templateNode.test.ts [2m([22m[2m17 tests[22m[2m | [22m[31m17 failed[39m[2m)[22m[33m 20681[2mms[22m[39m
[31m       [31m√ó[31m should resolve template by key from workflowTemplates mapping[39m[33m 1196[2mms[22m[39m
[31m       [31m√ó[31m should throw error if template key not found[39m[33m 1002[2mms[22m[39m
[31m       [31m√ó[31m should store output in runOutputs table[39m[33m 550[2mms[22m[39m
[31m       [31m√ó[31m should resolve template by templateId directly[39m[33m 614[2mms[22m[39m
[31m       [31m√ó[31m should throw error if templateId not found[39m[33m 875[2mms[22m[39m
[31m       [31m√ó[31m should use docxRenderer2 by default (v2 engine)[39m[33m 527[2mms[22m[39m
[31m       [31m√ó[31m should use legacy engine when engine="legacy"[39m[33m 1859[2mms[22m[39m
[31m       [31m√ó[31m should generate PDF when toPdf=true[39m[33m 1442[2mms[22m[39m
[31m       [31m√ó[31m should default to DOCX when toPdf=false[39m[33m 1516[2mms[22m[39m
[31m       [31m√ó[31m should skip execution when condition evaluates to false[39m[33m 999[2mms[22m[39m
[31m       [31m√ó[31m should execute when condition evaluates to true[39m[33m 918[2mms[22m[39m
[31m       [31m√ó[31m should resolve simple bindings[39m[33m 1342[2mms[22m[39m
[31m       [31m√ó[31m should handle binding resolution errors gracefully[39m[33m 1267[2mms[22m[39m
[31m       [31m√ó[31m should record failed output in runOutputs table[39m[33m 936[2mms[22m[39m
[31m       [31m√ó[31m should not throw errors (should return error in result)[39m[33m 878[2mms[22m[39m
[31m       [31m√ó[31m should deny access to templates from different tenant[39m[33m 639[2mms[22m[39m
[31m       [31m√ó[31m should require either templateKey or templateId[39m[33m 1185[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w136_v3, public
‚úÖ Enforced search_path: test_schema_w136_v3, public

{"level":30,"time":1768715759343,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715759344,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/organizationService.test.ts [2m([22m[2m13 tests[22m[2m | [22m[31m12 failed[39m[2m)[22m[33m 13869[2mms[22m[39m
[31m       [31m√ó[31m should create organization and auto-create admin membership[39m[32m 111[2mms[22m[39m
[31m       [31m√ó[31m should return all organizations for user[39m[33m 1895[2mms[22m[39m
[31m       [31m√ó[31m should return empty array for user with no memberships[39m[33m 581[2mms[22m[39m
[31m       [31m√ó[31m should allow admin to update organization[39m[33m 368[2mms[22m[39m
[31m       [31m√ó[31m should deny non-admin from updating organization[39m[32m 293[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return all members of organization [33m 1581[2mms[22m[39m
[31m       [31m√ó[31m should allow admin to promote member[39m[33m 1057[2mms[22m[39m
[31m       [31m√ó[31m should allow admin to demote other admin[39m[33m 533[2mms[22m[39m
[31m       [31m√ó[31m should prevent self-demotion[39m[32m 289[2mms[22m[39m
[31m       [31m√ó[31m should allow admin to remove member[39m[33m 644[2mms[22m[39m
[31m       [31m√ó[31m should prevent self-removal[39m[33m 380[2mms[22m[39m
[31m       [31m√ó[31m should allow member to leave organization[39m[33m 1512[2mms[22m[39m
[31m       [31m√ó[31m should allow admin to leave organization[39m[33m 1727[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w139_v3
‚úÖ Current search_path: test_schema_w139_v3, public
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768715759507,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39müìä Schema test_schema_w131_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715759551,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715759552,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w131_v3\",public"}
{"level":30,"time":1768715759557,"env":"test","workflowId":"123e4567-e89b-12d3-a456-426614174000","userId":"user-123","sectionsCount":2,"stepsCount":0,"logicRulesCount":1,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768715759585,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["618b59a1-0c80-4d85-b0e0-a61e94ea6b1d","$2b$12$RBHDKydIOa4OCzfVGeXYYuRLfpN8sNF/y1vMZzsZcAxYr/yeo8wcm"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(618b59a1-0c80-4d85-b0e0-a61e94ea6b1d) is not present in table \"users\".","schema":"test_schema_w139_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"618b59a1-0c80-4d85-b0e0-a61e94ea6b1d","msg":"Failed to create user credentials"}
[90mstderr[2m | tests/integration/api.expression-validation.test.ts[2m > [22m[2mExpression Validation API Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/api.expression-validation.test.ts:20:11

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768715759586,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["618b59a1-0c80-4d85-b0e0-a61e94ea6b1d","$2b$12$RBHDKydIOa4OCzfVGeXYYuRLfpN8sNF/y1vMZzsZcAxYr/yeo8wcm"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(618b59a1-0c80-4d85-b0e0-a61e94ea6b1d) is not present in table \"users\".","schema":"test_schema_w139_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
 [32m‚úì[39m tests/unit/services/WorkflowService.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 1904[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return workflow if user is the creator [33m 1007[2mms[22m[39m
{"level":30,"time":1768715759630,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w143_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w139_v3, public
‚úÖ Enforced search_path: test_schema_w139_v3, public

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w143_v3 (Reused: true)

[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768715759598,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768715759598,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w136_v3
‚úÖ Current search_path: test_schema_w136_v3, public
‚è© Schema reused, skipping migrations.

 [31m‚ùØ[39m tests/integration/api.expression-validation.test.ts [2m([22m[2m10 tests[22m[2m | [22m[33m10 skipped[39m[2m)[22m[33m 3641[2mms[22m[39m
       [2m[90m‚Üì[39m[22m should validate a correct expression with valid variables
       [2m[90m‚Üì[39m[22m should validate expression with string concatenation
       [2m[90m‚Üì[39m[22m should reject expression with invalid syntax
       [2m[90m‚Üì[39m[22m should reject without authentication
       [2m[90m‚Üì[39m[22m should reject missing required fields
       [2m[90m‚Üì[39m[22m should return available variables for a node
       [2m[90m‚Üì[39m[22m should reject without authentication
       [2m[90m‚Üì[39m[22m should reject non-existent workflow
       [2m[90m‚Üì[39m[22m should return list of helper functions with metadata
       [2m[90m‚Üì[39m[22m should reject without authentication
{"level":30,"time":1768715760037,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts[2m > [22m[2mAI Document Assistant API Integration Tests
[22m[39müìö API Documentation available at /api-docs

{"level":30,"time":1768715760059,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768715760048,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768715760048,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768715760054,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768715760054,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768715760059,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768715760059,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768715760059,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768715760059,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":40,"time":1768715760119,"env":"test","error":{},"msg":"Deterministic DOCX extraction failed"}
{"level":30,"time":1768715760164,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715760167,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":30,"time":1768715760210,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39müìä Schema test_schema_w143_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

 [32m‚úì[39m tests/unit/services/MfaService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 2327[2mms[22m[39m
[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/PortalAuthService.test.ts [2m([22m[2m42 tests[22m[2m)[22m[33m 989[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w131_v3, public
‚úÖ Enforced search_path: test_schema_w131_v3, public

 [32m‚úì[39m tests/integration/api.ai.doc.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 3066[2mms[22m[39m
[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w145_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w145_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w139_v3
‚úÖ Current search_path: test_schema_w139_v3, public
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768715760567,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715760567,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mDEBUG: Existing functions: []

 [32m‚úì[39m tests/integration/datavault.routes.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 3008[2mms[22m[39m
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39müìä Schema test_schema_w145_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstderr[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): Error: [vitest] No "closeDatabase" export is defined on the "../../../server/db" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

    at VitestMocker.createError [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:311:17[90m)[39m
    at Object.get [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:384:16[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:177:34
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m {
  codeFrame: [32m'vi.mock(import("../../../server/db"), async (importOriginal) => {\n'[39m +
    [32m'  const actual = await importOriginal()\n'[39m +
    [32m'  return {\n'[39m +
    [32m'    ...actual,\n'[39m +
    [32m'    // your mocked methods\n'[39m +
    [32m'  }\n'[39m +
    [32m'})'[39m
}

{"level":30,"time":1768715760973,"env":"test","module":"write-runner","operation":"write_start","mode":"create","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"create","columnMappings":[{"columnId":"col-first","value":"{{ firstName }}"},{"columnId":"col-last","value":"Doe"},{"columnId":"col-age","value":"{{ age }}"}]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":30,"time":1768715760982,"env":"test","module":"write-runner","operation":"write_start","mode":"create","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"create","columnMappings":[]},"tableId":"table-users","preview":true,"msg":"Starting write execution"}
[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715760982,"env":"test","module":"write-runner","operation":"write_preview_simulated","values":{},"msg":"Simulating write in preview mode"}
{"level":30,"time":1768715760983,"env":"test","module":"write-runner","operation":"write_start","mode":"update","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"test@example.com","columnMappings":[{"columnId":"col-status","value":"Active"}]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":30,"time":1768715760985,"env":"test","module":"write-runner","operation":"write_start","mode":"update","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"missing@example.com","columnMappings":[]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":50,"time":1768715760985,"env":"test","module":"write-runner","error":{},"config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"missing@example.com","columnMappings":[]},"msg":"Write execution failed"}
 [32m‚úì[39m tests/unit/writes/WriteRunner.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 887[2mms[22m[39m
[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w146_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w146_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w144_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w144_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w133_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w133_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39müìä Schema test_schema_w146_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715761512,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
 [32m‚úì[39m tests/unit/services/Guardrail.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 865[2mms[22m[39m
{"level":30,"time":1768715761735,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts[2m > [22m[2mPersonalization API Integration Tests
[22m[39müìö API Documentation available at /api-docs

{"level":30,"time":1768715761748,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768715761749,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768715761755,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768715761755,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39müìä Schema test_schema_w144_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39müìä Schema test_schema_w133_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715761814,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715761815,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w133_v3\",public"}
 [32m‚úì[39m tests/unit/services/DatavaultRowsService.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 928[2mms[22m[39m
{"level":30,"time":1768715761875,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768715762012,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

{"level":30,"time":1768715762326,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715762326,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768715762432,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:168:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
{"level":50,"time":1768715762433,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:168:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google authentication failed"}
[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w147_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":40,"time":1768715762496,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768715762496,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:158:23"},"msg":"Google token verification failed"}
{"level":50,"time":1768715762496,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:158:23"},"msg":"Google authentication failed"}
[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w147_v3 (Reused: true)

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

 [31m‚ùØ[39m tests/integration/api.ai.personalization.test.ts [2m([22m[2m3 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 3614[2mms[22m[39m
       [32m‚úì[39m should rewrite text based on user settings[32m 97[2mms[22m[39m
       [32m‚úì[39m should generate help text[32m 54[2mms[22m[39m
[31m       [31m√ó[31m should update user settings[39m[32m 119[2mms[22m[39m
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w133_v3, public
‚úÖ Enforced search_path: test_schema_w133_v3, public

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w131_v3
‚úÖ Current search_path: test_schema_w131_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w150_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w150_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39müìä Schema test_schema_w147_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w135_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768715762975,"env":"test","module":"auth","email":"existing@example.com","msg":"OAuth2 login successful"}
 [32m‚úì[39m tests/unit/services/BrandingService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 1096[2mms[22m[39m
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w135_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w149_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w149_v3 (Reused: true)

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w148_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w148_v3 (Reused: true)

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w153_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w153_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39müìä Schema test_schema_w150_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/DatavaultReferenceColumns.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 881[2mms[22m[39m
[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39müìä Schema test_schema_w135_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715763457,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715763458,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w135_v3\",public"}
{"level":50,"time":1768715763467,"env":"test","module":"auth","err":{"type":"Error","message":"User not found after upsert","stack":"Error: User not found after upsert\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:162:27\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google authentication failed"}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w137_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w151_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w137_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39müìä Schema test_schema_w149_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w151_v3 (Reused: true)

{"level":30,"time":1768715763544,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w152_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/EmailTemplateMetadataService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 951[2mms[22m[39m
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w152_v3 (Reused: true)

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39müìä Schema test_schema_w148_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":40,"time":1768715763628,"env":"test","hookId":"hook-1","hookName":"Hook 1","error":"Test error","msg":"LifecycleHookService: Hook execution failed"}
[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768715763632,"env":"test","error":{},"workflowId":"workflow-1","runId":"run-1","phase":"beforePage","msg":"LifecycleHookService: Failed to execute hooks for phase"}
{"level":30,"time":1768715763634,"env":"test","hookId":"hook-1","workflowId":"workflow-1","phase":"beforePage","msg":"LifecycleHookService: Created lifecycle hook"}
{"level":30,"time":1768715763640,"env":"test","hookId":"hook-1","workflowId":"workflow-1","msg":"LifecycleHookService: Updated lifecycle hook"}
{"level":30,"time":1768715763642,"env":"test","hookId":"hook-1","workflowId":"workflow-1","msg":"LifecycleHookService: Deleted lifecycle hook"}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39müìä Schema test_schema_w153_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":30,"time":1768715763677,"env":"test","msg":"External Send Completed","destination":"My Webhook","success":true,"status":200}
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715763683,"env":"test","msg":"Simulating External Send","destination":"Test","payload":{}}
 [32m‚úì[39m tests/unit/LifecycleHookService.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 925[2mms[22m[39m
 [32m‚úì[39m tests/unit/external/ExternalSendRunner.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 901[2mms[22m[39m
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39müìä Schema test_schema_w137_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715763937,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715763938,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w137_v3\",public"}
{"level":30,"time":1768715763948,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39müìä Schema test_schema_w151_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":30,"time":1768715763972,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.snapshots.test.ts[2m > [22m[2mStage 13: Workflow Snapshots & Versioning
[22m[39müìö API Documentation available at /api-docs

{"level":30,"time":1768715763959,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768715763960,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768715763965,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768715763966,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768715763971,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768715763972,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768715763972,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768715763972,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w154_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768715763988,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768715763998,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

 [32m‚úì[39m tests/unit/services/AuditLogService.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 879[2mms[22m[39m
[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39müìä Schema test_schema_w152_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w154_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715764064,"env":"test","module":"auth","email":"idtoken@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768715763998,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768715764070,"env":"test","msg":"Master key validated successfully"}
{"level":30,"time":1768715764070,"env":"test","provider":"gemini","model":"gemini-2.0-flash","msg":"AI Service configured and ready"}
{"level":30,"time":1768715764070,"env":"test","msg":"Initializing database..."}
{"level":30,"time":1768715764070,"env":"test","msg":"Database initialized."}
{"level":30,"time":1768715764070,"env":"test","module":"email-queue","intervalMs":5000,"msg":"Starting email queue worker"}
 [32m‚úì[39m tests/unit/services/AccountLockoutService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 884[2mms[22m[39m
Sourcemap for "C:/Users/scoot/poll/VaultLogic/node_modules/node-cron/dist/esm/node-cron.js" points to missing source files
{"level":30,"time":1768715764144,"env":"test","module":"cron","msg":"Initializing cron jobs..."}
[90mstdout[2m | tests/unit/services/AuthService.test.ts[2m > [22m[2mAuthService[2m > [22m[2mJWT Token Management[2m > [22m[2mverifyToken()[2m > [22m[2mshould throw error for invalid token signature
[22m[39mDEBUG: verifyToken threw: Invalid or malformed token InvalidTokenError

{"level":30,"time":1768715764213,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39müìö API Documentation available at /api-docs

{"level":30,"time":1768715764174,"env":"test","module":"cron","msg":"Cron jobs initialized"}
{"level":30,"time":1768715764191,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768715764201,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768715764201,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768715764207,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768715764207,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768715764213,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768715764213,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768715764213,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768715764213,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768715764213,"env":"test","msg":"Loading Vite for development..."}
[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w155_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w135_v3, public
‚úÖ Enforced search_path: test_schema_w135_v3, public

[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w155_v3 (Reused: true)

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w137_v3
‚úÖ Current search_path: test_schema_w133_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39müìä Schema test_schema_w154_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/repositories/DatavaultRowsRepository.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 842[2mms[22m[39m
 [2m[90m‚Üì[39m[22m tests/unit/collab.server.test.ts [2m([22m[2m14 tests[22m[2m | [22m[33m14 skipped[39m[2m)[22m
{"level":50,"time":1768715764688,"env":"test","module":"auth","err":{"type":"DrizzleQueryError","message":"Failed query: insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)\nparams: google-user-minimal,f1fdf2fbd78ec2d821b1d9620a2dd1b47bf39947192a55d0105abab52ab8a4c0,2026-02-17T05:56:04.513Z,false,{\"ip\":\"::ffff:127.0.0.1\"},,::ffff:127.0.0.1,Location Unknown,2026-01-18T05:56:04.514Z: insert or update on table \"refresh_tokens\" violates foreign key constraint \"refresh_tokens_user_id_users_id_fk\"","stack":"Error: Failed query: insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)\nparams: google-user-minimal,f1fdf2fbd78ec2d821b1d9620a2dd1b47bf39947192a55d0105abab52ab8a4c0,2026-02-17T05:56:04.513Z,false,{\"ip\":\"::ffff:127.0.0.1\"},,::ffff:127.0.0.1,Location Unknown,2026-01-18T05:56:04.514Z\n    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:173:28\ncaused by: error: insert or update on table \"refresh_tokens\" violates foreign key constraint \"refresh_tokens_user_id_users_id_fk\"\n    at C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\pg-pool\\index.js:45:11\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20\n    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)\n    at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:173:28","query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["google-user-minimal","f1fdf2fbd78ec2d821b1d9620a2dd1b47bf39947192a55d0105abab52ab8a4c0","2026-02-17T05:56:04.513Z",false,"{\"ip\":\"::ffff:127.0.0.1\"}",null,"::ffff:127.0.0.1","Location Unknown","2026-01-18T05:56:04.514Z"]},"msg":"Google authentication failed"}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w137_v3, public
‚úÖ Enforced search_path: test_schema_w137_v3, public

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39müìä Schema test_schema_w155_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/engine/FinalBlockSnapshot.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 832[2mms[22m[39m
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w137_v3
‚úÖ Current search_path: test_schema_w133_v3, public
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768715764908,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715764909,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/api.snapshots.test.ts [2m([22m[2m1 test[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 3966[2mms[22m[39m
[31m     [31m√ó[31m should maintain immutability of runs across versions[39m[32m 212[2mms[22m[39m
{"level":50,"time":1768715765128,"env":"test","module":"auth","err":{"type":"Error","message":"Token verification failed","stack":"Error: Token verification failed\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:431:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
{"level":40,"time":1768715765173,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768715765174,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

{"level":50,"time":1768715765216,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token payload","stack":"Error: Invalid token payload\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:88:26)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768715765265,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715765265,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/auth/oauth2.google.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 7160[2mms[22m[39m
       [33m[2m‚úì[22m[39m should successfully authenticate with valid Google ID token [33m 777[2mms[22m[39m
       [32m‚úì[39m should return 400 when ID token is missing[32m 247[2mms[22m[39m
       [32m‚úì[39m should return 403 when Origin header is invalid[32m 58[2mms[22m[39m
       [32m‚úì[39m should return 401 when Google token verification fails[32m 58[2mms[22m[39m
       [32m‚úì[39m should return 401 when email is not verified by Google[32m 62[2mms[22m[39m
       [33m[2m‚úì[22m[39m should update existing user on subsequent logins [33m 534[2mms[22m[39m
[31m       [31m√ó[31m should create refresh token record in database[39m[33m 444[2mms[22m[39m
       [33m[2m‚úì[22m[39m should support both "token" and "idToken" fields [33m 590[2mms[22m[39m
       [32m‚úì[39m should respect rate limiting[32m 56[2mms[22m[39m
[31m       [31m√ó[31m should handle missing profile information gracefully[39m[33m 571[2mms[22m[39m
       [33m[2m‚úì[22m[39m should verify valid Google ID token [33m 379[2mms[22m[39m
       [32m‚úì[39m should throw error when token verification fails[32m 56[2mms[22m[39m
       [32m‚úì[39m should throw error when email is not verified[32m 44[2mms[22m[39m
       [32m‚úì[39m should throw error when payload is null[32m 43[2mms[22m[39m
{"level":30,"time":1768715765523,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768715765540,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/js_helpers.test.ts[2m > [22m[2mDetailed Verification: JS Helper Availability
[22m[39müìö API Documentation available at /api-docs

{"level":30,"time":1768715765530,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768715765531,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768715765535,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768715765536,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768715765540,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768715765540,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768715765540,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768715765540,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts[2m > [22m[2mData Sources API - Native Catalog
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts[2m > [22m[2mData Sources API - Native Catalog
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768715765993,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768715766023,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts[2m > [22m[2mData Sources API - Native Catalog
[22m[39müìö API Documentation available at /api-docs

{"level":30,"time":1768715766007,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768715766008,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768715766016,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768715766017,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768715766023,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768715766023,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768715766023,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768715766023,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":40,"time":1768715766351,"env":"test","workflowId":"0e6abf0b-8d10-4a67-83ea-7391f02e6538","msg":"No current or pinned version found for workflow, run might be unstable"}
{"level":50,"time":1768715766519,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["08e36bc0-3bf7-41a4-8f7b-ac49c97a7f8b","$2b$12$BochPp2XIyG19Sbi4T48Fu1yeJwdcBr.bV9DcnHxSIJ1KFza909q6"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(08e36bc0-3bf7-41a4-8f7b-ac49c97a7f8b) is not present in table \"users\".","schema":"test_schema_w135_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"08e36bc0-3bf7-41a4-8f7b-ac49c97a7f8b","msg":"Failed to create user credentials"}
{"level":50,"time":1768715766519,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["08e36bc0-3bf7-41a4-8f7b-ac49c97a7f8b","$2b$12$BochPp2XIyG19Sbi4T48Fu1yeJwdcBr.bV9DcnHxSIJ1KFza909q6"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(08e36bc0-3bf7-41a4-8f7b-ac49c97a7f8b) is not present in table \"users\".","schema":"test_schema_w135_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/api.dataSources.native.test.ts[2m > [22m[2mData Sources API - Native Catalog
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/api.dataSources.native.test.ts:20:15

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715766529,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768715766529,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/api.dataSources.native.test.ts [2m([22m[2m2 tests[22m[2m | [22m[33m2 skipped[39m[2m)[22m[33m 3460[2mms[22m[39m
     [2m[90m‚Üì[39m[22m should list databases and databases' tables in the catalog
     [2m[90m‚Üì[39m[22m should create a native_table data source
[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39müßπ Cleaning up test environment...

 [31m‚ùØ[39m tests/unit/services/AuthService.test.ts [2m([22m[2m113 tests[22m[2m | [22m[31m13 failed[39m[2m)[22m[33m 8899[2mms[22m[39m
         [32m‚úì[39m should hash a password using bcrypt with 12 rounds[32m 282[2mms[22m[39m
         [33m[2m‚úì[22m[39m should generate different hashes for same password [33m 533[2mms[22m[39m
         [32m‚úì[39m should handle empty passwords[32m 277[2mms[22m[39m
         [32m‚úì[39m should handle long passwords[32m 247[2mms[22m[39m
         [32m‚úì[39m should handle unicode characters in password[32m 263[2mms[22m[39m
         [33m[2m‚úì[22m[39m should return true for correct password [33m 608[2mms[22m[39m
         [33m[2m‚úì[22m[39m should return false for incorrect password [33m 609[2mms[22m[39m
         [33m[2m‚úì[22m[39m should be case-sensitive [33m 496[2mms[22m[39m
         [33m[2m‚úì[22m[39m should handle empty password comparison [33m 540[2mms[22m[39m
         [32m‚úì[39m should accept valid email addresses[32m 3[2mms[22m[39m
         [32m‚úì[39m should reject emails longer than 254 characters (RFC 5321)[32m 1[2mms[22m[39m
         [32m‚úì[39m should reject emails shorter than 3 characters[32m 1[2mms[22m[39m
         [32m‚úì[39m should reject emails with consecutive dots[32m 2[2mms[22m[39m
         [32m‚úì[39m should reject emails without @ symbol[32m 2[2mms[22m[39m
         [32m‚úì[39m should reject emails without domain[32m 2[2mms[22m[39m
         [32m‚úì[39m should reject emails with spaces[32m 2[2mms[22m[39m
         [32m‚úì[39m should reject emails without TLD[32m 1[2mms[22m[39m
         [32m‚úì[39m should reject null or undefined[32m 2[2mms[22m[39m
         [32m‚úì[39m should reject emails with local part longer than 64 characters[32m 1[2mms[22m[39m
         [32m‚úì[39m should accept valid strong passwords[32m 36[2mms[22m[39m
         [32m‚úì[39m should reject passwords shorter than 8 characters[32m 2[2mms[22m[39m
         [32m‚úì[39m should reject passwords longer than 128 characters[32m 2[2mms[22m[39m
         [32m‚úì[39m should reject weak passwords with zxcvbn score < 3[32m 8[2mms[22m[39m
         [32m‚úì[39m should provide helpful feedback for weak passwords[32m 4[2mms[22m[39m
         [32m‚úì[39m should reject password containing user's email[32m 5[2mms[22m[39m
         [32m‚úì[39m should reject password containing user's name[32m 4[2mms[22m[39m
         [32m‚úì[39m should accept strong password even with user inputs provided[32m 6[2mms[22m[39m
         [32m‚úì[39m should accept password with exactly 8 characters if strong enough[32m 3[2mms[22m[39m
         [32m‚úì[39m should accept password with exactly 128 characters if strong[32m 157[2mms[22m[39m
         [32m‚úì[39m should return score in result object[32m 5[2mms[22m[39m
         [32m‚úì[39m should create a valid JWT token for a user[32m 6[2mms[22m[39m
         [32m‚úì[39m should include userId, email, tenantId, and role in token payload[32m 3[2mms[22m[39m
         [32m‚úì[39m should set token expiry to 15 minutes by default[32m 3[2mms[22m[39m
         [32m‚úì[39m should throw error if JWT_SECRET is not configured[32m 2[2mms[22m[39m
         [32m‚úì[39m should handle null tenantId and role[32m 3[2mms[22m[39m
         [32m‚úì[39m should verify and decode a valid token[32m 4[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error for expired token [33m 1105[2mms[22m[39m
         [32m‚úì[39m should throw error for invalid token signature[32m 3[2mms[22m[39m
         [32m‚úì[39m should throw error for malformed token[32m 1[2mms[22m[39m
         [32m‚úì[39m should throw error for invalid token[32m 1[2mms[22m[39m
         [32m‚úì[39m should extract token from Bearer authorization header[32m 1[2mms[22m[39m
         [32m‚úì[39m should return token if no Bearer prefix[32m 1[2mms[22m[39m
         [32m‚úì[39m should return null for undefined header[32m 1[2mms[22m[39m
         [32m‚úì[39m should return null for empty header[32m 1[2mms[22m[39m
         [32m‚úì[39m should handle Bearer with multiple spaces[32m 1[2mms[22m[39m
         [32m‚úì[39m should return true for JWT-like tokens[32m 1[2mms[22m[39m
         [32m‚úì[39m should return false for non-JWT tokens[32m 2[2mms[22m[39m
         [32m‚úì[39m should return false for empty token[32m 1[2mms[22m[39m
         [32m‚úì[39m should return false for null/undefined[32m 2[2mms[22m[39m
         [32m‚úì[39m should create a valid portal token for an email[32m 2[2mms[22m[39m
         [32m‚úì[39m should include email and portal flag in token payload[32m 2[2mms[22m[39m
         [32m‚úì[39m should set token expiry to 24 hours[32m 2[2mms[22m[39m
         [32m‚úì[39m should verify and decode a valid portal token[32m 2[2mms[22m[39m
         [32m‚úì[39m should throw error for non-portal token[32m 2[2mms[22m[39m
         [32m‚úì[39m should throw error for token without email[32m 2[2mms[22m[39m
         [32m‚úì[39m should throw error for expired portal token[32m 1[2mms[22m[39m
[31m         [31m√ó[31m should generate password reset token for existing user[39m[32m 234[2mms[22m[39m
         [32m‚úì[39m should return null for non-existent user[32m 1[2mms[22m[39m
[31m         [31m√ó[31m should invalidate previous reset tokens[39m[32m 2[2mms[22m[39m
         [32m‚úì[39m should return userId for valid token[32m 2[2mms[22m[39m
         [32m‚úì[39m should return null for invalid token[32m 2[2mms[22m[39m
         [32m‚úì[39m should return null for expired token[32m 1[2mms[22m[39m
         [32m‚úì[39m should return null for used token[32m 1[2mms[22m[39m
         [32m‚úì[39m should mark token as used[32m 2[2mms[22m[39m
         [32m‚úì[39m should generate verification token[32m 1[2mms[22m[39m
         [32m‚úì[39m should have 24 hour expiry[32m 2[2mms[22m[39m
         [32m‚úì[39m should verify email with valid token[32m 2[2mms[22m[39m
         [32m‚úì[39m should return false for invalid token[32m 1[2mms[22m[39m
         [32m‚úì[39m should return false for expired token[32m 2[2mms[22m[39m
         [32m‚úì[39m should delete token after successful verification[32m 2[2mms[22m[39m
         [32m‚úì[39m should create refresh token with 30-day expiry[32m 3[2mms[22m[39m
         [32m‚úì[39m should store device metadata[32m 3[2mms[22m[39m
         [32m‚úì[39m should return userId for valid token[32m 2[2mms[22m[39m
         [32m‚úì[39m should return null for revoked token[32m 2[2mms[22m[39m
         [32m‚úì[39m should return null for expired token[32m 1[2mms[22m[39m
[31m         [31m√ó[31m should rotate valid token and return new one[39m[32m 2[2mms[22m[39m
[31m         [31m√ó[31m should return null for unknown token[39m[32m 2[2mms[22m[39m
[31m         [31m√ó[31m should revoke all tokens on reuse detection[39m[32m 2[2mms[22m[39m
[31m         [31m√ó[31m should return null for expired token[39m[32m 2[2mms[22m[39m
         [32m‚úì[39m should revoke specific token[32m 2[2mms[22m[39m
         [32m‚úì[39m should revoke all tokens for user[32m 2[2mms[22m[39m
[31m         [31m√ó[31m should cleanup expired refresh tokens[39m[32m 2[2mms[22m[39m
[31m         [31m√ó[31m should cleanup expired password reset tokens[39m[32m 2[2mms[22m[39m
[31m         [31m√ó[31m should cleanup expired email verification tokens[39m[32m 1[2mms[22m[39m
[31m         [31m√ó[31m should cleanup old login attempts via accountLockoutService[39m[32m 2[2mms[22m[39m
         [32m‚úì[39m should use JWT_SECRET if provided[32m 2[2mms[22m[39m
         [32m‚úì[39m should warn if JWT_SECRET is less than 32 characters[32m 1[2mms[22m[39m
         [32m‚úì[39m should reject token with modified payload[32m 2[2mms[22m[39m
         [32m‚úì[39m should reject token with valid structure but invalid signature[32m 2[2mms[22m[39m
         [33m[2m‚úì[22m[39m should handle password with special characters [33m 443[2mms[22m[39m
         [32m‚úì[39m should handle password with only spaces[32m 221[2mms[22m[39m
         [33m[2m‚úì[22m[39m should handle password with newlines and tabs [33m 438[2mms[22m[39m
         [33m[2m‚úì[22m[39m should reject password with null bytes (if validation exists) [33m 438[2mms[22m[39m
         [32m‚úì[39m should reject email with unicode domain (security fix)[32m 1[2mms[22m[39m
         [32m‚úì[39m should reject email starting with dot (security fix)[32m 1[2mms[22m[39m
         [32m‚úì[39m should reject email ending with dot before @ (security fix)[32m 1[2mms[22m[39m
         [32m‚úì[39m should handle email with plus addressing[32m 1[2mms[22m[39m
         [32m‚úì[39m should handle email with subdomain[32m 1[2mms[22m[39m
         [32m‚úì[39m should reject email with invalid TLD (single char)[32m 1[2mms[22m[39m
         [32m‚úì[39m should accept email with numeric TLD[32m 1[2mms[22m[39m
         [32m‚úì[39m should prevent timing attacks on token validation[32m 2[2mms[22m[39m
[31m         [31m√ó[31m should support full user authentication lifecycle[39m[32m 225[2mms[22m[39m
[31m         [31m√ó[31m should support complete password reset workflow[39m[32m 1[2mms[22m[39m
[31m         [31m√ó[31m should prevent reuse of password reset tokens[39m[32m 1[2mms[22m[39m
         [32m‚úì[39m should support multiple valid refresh tokens per user[32m 1[2mms[22m[39m
         [32m‚úì[39m should revoke all user tokens on security event[32m 1[2mms[22m[39m
         [32m‚úì[39m should handle database connection failures gracefully[32m 2[2mms[22m[39m
         [32m‚úì[39m should handle transaction failures[32m 1[2mms[22m[39m
         [32m‚úì[39m should throw error if JWT signing fails[32m 1[2mms[22m[39m
         [32m‚úì[39m should hash password in reasonable time (< 500ms)[32m 222[2mms[22m[39m
         [33m[2m‚úì[22m[39m should compare password in reasonable time (< 500ms) [33m 439[2mms[22m[39m
         [32m‚úì[39m should create JWT token in < 10ms[32m 3[2mms[22m[39m
         [32m‚úì[39m should verify JWT token in < 50ms[32m 3[2mms[22m[39m
{"level":30,"time":1768715767037,"env":"test","module":"runs-routes","runId":"2aace30a-2dc0-4d66-8cfb-5b05acdd94a1","sectionId":"135afb30-4f5e-4bb2-8417-c231890ff319","valuesType":"object","isArray":true,"valuesLength":0,"bodyKeys":["values"],"msg":"Section submit request received"}
{"level":40,"time":1768715767465,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":30,"time":1768715768230,"env":"test","module":"runs-routes","runId":"2aace30a-2dc0-4d66-8cfb-5b05acdd94a1","sectionId":"135afb30-4f5e-4bb2-8417-c231890ff319","msg":"Section submitted successfully"}
{"level":30,"time":1768715768364,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715768364,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/js_helpers.test.ts [2m([22m[2m1 test[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 5803[2mms[22m[39m
[31m     [31m√ó[31m should execute a JS block that uses helper functions[39m[33m 2327[2mms[22m[39m
{"level":30,"time":1768715769069,"env":"test","source":"express","msg":"üì¶ vite.ts module loaded successfully"}
{"level":30,"time":1768715769069,"env":"test","msg":"Vite module loaded, calling setupVite..."}
{"level":30,"time":1768715769069,"env":"test","source":"express","msg":"üìù setupVite: Starting Vite setup..."}
{"level":30,"time":1768715769069,"env":"test","source":"express","msg":"üìù setupVite: Resolving Vite config..."}
{"level":30,"time":1768715769073,"env":"test","source":"express","msg":"üìù setupVite: Vite config resolved"}
{"level":30,"time":1768715769073,"env":"test","source":"express","msg":"üìù setupVite: Server options prepared, creating Vite server..."}
{"level":50,"time":1768715769094,"env":"test","module":"email-queue","error":{},"msg":"Error in email queue processor"}
{"level":30,"time":1768715769126,"env":"test","source":"express","msg":"üìù setupVite: Vite server created successfully"}
{"level":30,"time":1768715769126,"env":"test","source":"express","msg":"üìù setupVite: Mounting Vite middlewares..."}
{"level":30,"time":1768715769126,"env":"test","source":"express","msg":"üìù setupVite: Vite middlewares mounted"}
{"level":30,"time":1768715769126,"env":"test","source":"express","msg":"üìù setupVite: Vite setup complete!"}
{"level":30,"time":1768715769127,"env":"test","msg":"Vite setup complete"}
{"level":30,"time":1768715769129,"env":"test","source":"express","msg":"serving on port 5000"}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w138_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w138_v3 (Reused: true)

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39müìä Schema test_schema_w138_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768715770725,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768715770725,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w138_v3\",public"}
{"level":30,"time":1768715770763,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m‚úÖ Set default search_path for database: test_schema_w138_v3, public
‚úÖ Enforced search_path: test_schema_w138_v3, public

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w138_v3
‚úÖ Current search_path: test_schema_w138_v3, public
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m‚úÖ Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":30,"time":1768715772758,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768715772759,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/api-docs.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 8683[2mms[22m[39m
Failed to parse file:///C:/Users/scoot/poll/VaultLogic/client/src/components/builder/cards/ChoiceCardEditor.tsx. Excluding it from coverage.
 Error [RollupError]: Expected ',', got 'UniversalBlock'
    at getRollupError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/rollup/dist/es/shared/parseAst.js:401:41)
    at convertProgram (file:///C:/Users/scoot/poll/VaultLogic/node_modules/rollup/dist/es/shared/parseAst.js:1098:26)
    at parseAstAsync (file:///C:/Users/scoot/poll/VaultLogic/node_modules/rollup/dist/es/shared/parseAst.js:2084:106)
    at V8CoverageProvider.remapCoverage (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/coverage-v8/dist/provider.js:135:10)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/coverage-v8/dist/provider.js:121:23
    at async Promise.all (index 6)
    at V8CoverageProvider.getCoverageMapForUncoveredFiles (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/coverage-v8/dist/provider.js:111:4)
    at V8CoverageProvider.generateCoverage (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/coverage-v8/dist/provider.js:59:29)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/cli-api.BKg19Fvw.js:12546:23
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/cli-api.BKg19Fvw.js:12559:11 {
  code: 'PARSE_ERROR',
  pos: 1537
}

[31m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39m[1m[41m Failed Suites 23 [49m[22m[31m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39m

[41m[1m FAIL [22m[49m tests/integration/analytics_service.test.ts[2m > [22mAnalytics Service Integration
[31m[1mError[22m: Failed query: insert into "workflow_versions" ("id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at") values ($1, $2, default, $3, $4, $5, default, default, default, default, $6, $7, $8, $9, $10) returning "id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at"
params: 098094b7-cef5-4065-8d92-03497761bc83,532e28eb-a03f-4159-ab84-82b79d05a5f0,1,true,{"nodes":[{"id":"start","type":"question","config":{"key":"start","question":"Start Question","type":"short_text"}}],"edges":[],"startNodeId":"start"},user-pY5IzVLffOHxhgv1YrvgT,true,2026-01-18T05:55:27.252Z,2026-01-18T05:55:26.935Z,2026-01-18T05:55:26.935Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/analytics_service.test.ts:[2m45:24[22m[39m
    [90m 43| [39m        workflow [33m=[39m wfRes[33m;[39m
    [90m 44| [39m
    [90m 45| [39m        [35mconst[39m [vRes] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(workflowVersions)[33m.[39m[34mvalues[39m({
    [90m   | [39m                       [31m^[39m
    [90m 46| [39m            [33m...[39mv[33m,[39m
    [90m 47| [39m            workflowId[33m:[39m wfRes[33m.[39mid[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "workflow_versions" violates foreign key constraint "workflow_versions_workflow_id_workflows_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/analytics_service.test.ts:[2m45:24[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 375, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(532e28eb-a03f-4159-ab84-82b79d05a5f0) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w66_v3', table: 'workflow_versions', dataType: undefined, constraint: 'workflow_versions_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[1/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.dataSources.native.test.ts[2m > [22mData Sources API - Native Catalog
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2m‚ùØ[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regi‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2m‚ùØ[22m tests/integration/api.dataSources.native.test.ts:[2m20:15[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[2/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.dataSources.native.test.ts[2m > [22mData Sources API - Native Catalog
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2m‚ùØ[22m tests/integration/api.dataSources.native.test.ts:[2m30:19[22m[39m
    [90m 28| [39m
    [90m 29| [39m    [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 30| [39m        [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m 31| [39m    })[33m;[39m
    [90m 32| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[3/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.expression-validation.test.ts[2m > [22mExpression Validation API Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2m‚ùØ[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regi‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2m‚ùØ[22m tests/integration/api.expression-validation.test.ts:[2m20:11[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[4/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.expression-validation.test.ts[2m > [22mExpression Validation API Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2m‚ùØ[22m tests/integration/api.expression-validation.test.ts:[2m76:15[22m[39m
    [90m 74| [39m
    [90m 75| [39m  [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 76| [39m    [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m              [31m^[39m
    [90m 77| [39m  })[33m;[39m
    [90m 78| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[5/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.projects.test.ts[2m > [22mProjects API Integration Tests
[31m[1mError[22m: expected 201 "Created", got 500 "Internal Server Error"[39m
[36m [2m‚ùØ[22m tests/integration/api.projects.test.ts:[2m66:8[22m[39m
    [90m 64| [39m        lastName[33m:[39m [32m"User"[39m[33m,[39m
    [90m 65| [39m      })
    [90m 66| [39m      [33m.[39m[34mexpect[39m([34m201[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m 67| [39m
    [90m 68| [39m    authToken [33m=[39m registerResponse[33m.[39mbody[33m.[39mtoken[33m;[39m
[90m [2m‚ùØ[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2m‚ùØ[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2m‚ùØ[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2m‚ùØ[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2m‚ùØ[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2m‚ùØ[22m node_modules/supertest/lib/test.js:[2m156:7[22m[39m
[90m [2m‚ùØ[22m Test.Request.callback node_modules/superagent/lib/node/index.js:[2m857:3[22m[39m
[90m [2m‚ùØ[22m node_modules/superagent/lib/node/index.js:[2m1102:18[22m[39m
[90m [2m‚ùØ[22m IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:[2m21:7[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[6/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.runs.docx.test.ts[2m > [22mRuns API - DOCX Generation Integration Tests
[31m[1mError[22m: expected 201 "Created", got 500 "Internal Server Error"[39m
[36m [2m‚ùØ[22m tests/integration/api.runs.docx.test.ts:[2m113:8[22m[39m
    [90m111| [39m      [33m.[39m[34mpost[39m([32m'/api/auth/register'[39m)
    [90m112| [39m      [33m.[39m[34msend[39m({ email[33m,[39m password[33m:[39m [32m'TestPassword123!@#Strong'[39m })
    [90m113| [39m      [33m.[39m[34mexpect[39m([34m201[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m114| [39m
    [90m115| [39m    authToken [33m=[39m registerResponse[33m.[39mbody[33m.[39mtoken[33m;[39m
[90m [2m‚ùØ[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2m‚ùØ[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2m‚ùØ[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2m‚ùØ[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2m‚ùØ[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2m‚ùØ[22m node_modules/supertest/lib/test.js:[2m156:7[22m[39m
[90m [2m‚ùØ[22m Test.Request.callback node_modules/superagent/lib/node/index.js:[2m857:3[22m[39m
[90m [2m‚ùØ[22m node_modules/superagent/lib/node/index.js:[2m1102:18[22m[39m
[90m [2m‚ùØ[22m IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:[2m21:7[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[7/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.runs.graph.test.ts[2m > [22mStage 8: Runs API Integration Tests
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "email" = $6, "tenant_id" = $7, "role" = $8, "tenant_role" = $9
params: test-user-runs-stage8,test-runs-stage8-GrDR1iCh1yK9T5EkLfsQJ@example.com,06f77a20-d502-4738-9832-4c70a94a5867,admin,owner,test-runs-stage8-GrDR1iCh1yK9T5EkLfsQJ@example.com,06f77a20-d502-4738-9832-4c70a94a5867,admin,owner[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/api.runs.graph.test.ts:[2m123:5[22m[39m
    [90m121| [39m    userId [33m=[39m [32m"test-user-runs-stage8"[39m[33m;[39m
    [90m122| [39m
    [90m123| [39m    [35mawait[39m db[33m.[39m[34minsert[39m(schema[33m.[39musers)[33m.[39m[34mvalues[39m({
    [90m   | [39m    [31m^[39m
    [90m124| [39m      id[33m:[39m userId[33m,[39m
    [90m125| [39m      email[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/api.runs.graph.test.ts:[2m123:5[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(06f77a20-d502-4738-9832-4c70a94a5867) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w26_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[8/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.templates-runs.test.ts[2m > [22mTemplates and Runs API Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2m‚ùØ[22m Module.setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regi‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2m‚ùØ[22m tests/integration/api.templates-runs.test.ts:[2m59:11[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[9/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.templates-runs.test.ts[2m > [22mTemplates and Runs API Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2m‚ùØ[22m tests/integration/api.templates-runs.test.ts:[2m85:15[22m[39m
    [90m 83| [39m
    [90m 84| [39m  [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 85| [39m    [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m              [31m^[39m
    [90m 86| [39m  })[33m;[39m
    [90m 87| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[10/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.workflows.test.ts[2m > [22mWorkflows API Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2m‚ùØ[22m Module.setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regi‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2m‚ùØ[22m tests/integration/api.workflows.test.ts:[2m42:11[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[11/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.workflows.test.ts[2m > [22mWorkflows API Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2m‚ùØ[22m tests/integration/api.workflows.test.ts:[2m52:15[22m[39m
    [90m 50| [39m
    [90m 51| [39m  [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 52| [39m    [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m              [31m^[39m
    [90m 53| [39m  })[33m;[39m
    [90m 54| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[12/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/dataBlocks.test.ts[2m > [22mData Block Integration Tests
[31m[1mError[22m: Table not found[39m
[36m [2m‚ùØ[22m DatavaultColumnsService.verifyTableOwnership server/services/DatavaultColumnsService.ts:[2m77:13[22m[39m
    [90m 75| [39m    [35mif[39m ([33m![39mtable) {
    [90m 76| [39m      console[33m.[39m[34mlog[39m([32m`[DEBUG] Table not found: [39m[36m${[39mtableId[36m}[39m[32m`[39m)[33m;[39m
    [90m 77| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Table not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 78| [39m    }
    [90m 79| [39m
[90m [2m‚ùØ[22m DatavaultColumnsService.createColumn server/services/DatavaultColumnsService.ts:[2m274:5[22m[39m
[90m [2m‚ùØ[22m tests/integration/dataBlocks.test.ts:[2m75:24[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[13/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault-v4-regression.test.ts[2m > [22mDataVault v4 Regression Tests
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, $6, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $7, "role" = $8, "tenant_role" = $9
params: google-user-id,testuser@example.com,d379c486-58d3-48c0-86d4-612d124034e9,admin,owner,google,d379c486-58d3-48c0-86d4-612d124034e9,admin,owner[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/datavault-v4-regression.test.ts:[2m90:5[22m[39m
    [90m 88| [39m    [90m// Create test user manually with correct tenant and admin role[39m
    [90m 89| [39m    testUserId [33m=[39m [32m'google-user-id'[39m[33m;[39m
    [90m 90| [39m    [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m    [31m^[39m
    [90m 91| [39m      id[33m:[39m testUserId[33m,[39m
    [90m 92| [39m      email[33m:[39m [32m'testuser@example.com'[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/datavault-v4-regression.test.ts:[2m90:5[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(d379c486-58d3-48c0-86d4-612d124034e9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w125_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[14/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.autonumber.test.ts[2m > [22mDataVault Autonumber Integration Tests
[31m[1mError[22m: Failed query: insert into "datavault_tables" ("id", "tenant_id", "owner_user_id", "database_id", "name", "slug", "description", "created_at", "updated_at") values (default, $1, $2, default, $3, $4, $5, default, default) returning "id", "tenant_id", "owner_user_id", "database_id", "name", "slug", "description", "created_at", "updated_at"
params: 9a20dd35-0457-4039-8261-f82f39b7dde4,,Autonumber Test Table,autonumber_test_table,Testing autonumber functionality[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m DatavaultTablesRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
    [90m 88| [39m    [35mconst[39m database [33m=[39m [35mthis[39m[33m.[39m[34mgetDb[39m(tx)[33m;[39m
    [90m 89| [39m
    [90m 90| [39m    [35mconst[39m [record] [33m=[39m [35mawait[39m database
    [90m   | [39m                     [31m^[39m
    [90m 91| [39m      [33m.[39m[34minsert[39m([35mthis[39m[33m.[39mtable [35mas[39m any)
    [90m 92| [39m      [33m.[39m[34mvalues[39m(data [35mas[39m any)
[90m [2m‚ùØ[22m DatavaultTablesService.createTable server/services/DatavaultTablesService.ts:[2m171:19[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m29:19[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "datavault_tables" violates foreign key constraint "datavault_tables_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m DatavaultTablesRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
[90m [2m‚ùØ[22m DatavaultTablesService.createTable server/services/DatavaultTablesService.ts:[2m171:19[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m29:19[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 359, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(9a20dd35-0457-4039-8261-f82f39b7dde4) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w39_v3', table: 'datavault_tables', dataType: undefined, constraint: 'datavault_tables_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[15/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.permissions.test.ts[2m > [22mDataVault Table Permissions API (v4 Micro-Phase 6)
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2m‚ùØ[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regi‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2m‚ùØ[22m tests/integration/datavault.permissions.test.ts:[2m22:11[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[16/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.permissions.test.ts[2m > [22mDataVault Table Permissions API (v4 Micro-Phase 6)
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2m‚ùØ[22m tests/integration/datavault.permissions.test.ts:[2m66:15[22m[39m
    [90m 64| [39m
    [90m 65| [39m  [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 66| [39m    [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m              [31m^[39m
    [90m 67| [39m  })[33m;[39m
    [90m 68| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[17/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/dynamic_options_workflow.test.ts[2m > [22mDynamic Options Integration Flow
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values (default, $1, default, $2, $3, default, $4, $5, default, default, default, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: test-2841b67b-2f0c-48a9-8c19-0babdd2cff6a@example.com,Test,User,da7c8d57-73c4-4ae0-8a85-826331761b7e,admin[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/dynamic_options_workflow.test.ts:[2m30:24[22m[39m
    [90m 28| [39m        tenantId [33m=[39m tenant[33m.[39mid[33m;[39m
    [90m 29| [39m
    [90m 30| [39m        [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                       [31m^[39m
    [90m 31| [39m            email[33m:[39m [32m`test-[39m[36m${[39m[34muuidv4[39m()[36m}[39m[32m@example.com`[39m[33m,[39m
    [90m 32| [39m            firstName[33m:[39m [32m'Test'[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/dynamic_options_workflow.test.ts:[2m30:24[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(da7c8d57-73c4-4ae0-8a85-826331761b7e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w26_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[18/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/externalSends.test.ts[2m > [22mExternal Send Block Integration
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, default, $3, $4, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Ex Send,External Send Project,2e61612d-08a6-44fe-a65c-15d64ce62e4e,62b4ee72-0f78-43a2-911c-7c748e7ef7ce,2e61612d-08a6-44fe-a65c-15d64ce62e4e,2e61612d-08a6-44fe-a65c-15d64ce62e4e[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/externalSends.test.ts:[2m61:27[22m[39m
    [90m 59| [39m
    [90m 60| [39m        [90m// 3. Setup Project[39m
    [90m 61| [39m        [35mconst[39m [project] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(projects)[33m.[39m[34mvalues[39m({
    [90m   | [39m                          [31m^[39m
    [90m 62| [39m            name[33m:[39m [32m'External Send Project'[39m[33m,[39m
    [90m 63| [39m            title[33m:[39m [32m'Ex Send'[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/externalSends.test.ts:[2m61:27[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(2e61612d-08a6-44fe-a65c-15d64ce62e4e) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w35_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[19/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/intake.workflow.test.ts[2m > [22mIntake Workflow Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2m‚ùØ[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regi‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2m‚ùØ[22m tests/integration/intake.workflow.test.ts:[2m11:15[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[20/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/intake.workflow.test.ts[2m > [22mIntake Workflow Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2m‚ùØ[22m tests/integration/intake.workflow.test.ts:[2m21:19[22m[39m
    [90m 19| [39m
    [90m 20| [39m    [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 21| [39m        [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m 22| [39m    })[33m;[39m
    [90m 23| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[21/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/lifecycle-hooks-execution.test.ts[2m > [22mLifecycle Hooks Execution
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2m‚ùØ[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regi‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2m‚ùØ[22m tests/integration/lifecycle-hooks-execution.test.ts:[2m41:11[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/lifecycle-hooks-execution.test.ts[2m > [22mLifecycle Hooks Execution
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2m‚ùØ[22m tests/integration/lifecycle-hooks-execution.test.ts:[2m89:15[22m[39m
    [90m 87| [39m
    [90m 88| [39m  [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 89| [39m    [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m              [31m^[39m
    [90m 90| [39m  })[33m;[39m
    [90m 91| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[23/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-audit-fixes.test.ts[2m > [22mOrganization Audit Fixes
[31m[1mError[22m: User must belong to a tenant to create organizations[39m
[36m [2m‚ùØ[22m OrganizationService.createOrganization server/services/OrganizationService.ts:[2m49:13[22m[39m
    [90m 47| [39m
    [90m 48| [39m    [35mif[39m ([33m![39muser[33m?.[39mtenantId) {
    [90m 49| [39m      throw new Error('User must belong to a tenant to create organiza‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m 50| [39m    }
    [90m 51| [39m
[90m [2m‚ùØ[22m tests/integration/organizations-audit-fixes.test.ts:[2m58:17[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[24/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression
[31m[1mError[22m: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values ($1, $2, default, $3, default, default, $4, default, default, default)
params: 271fca50-ad06-44a5-804c-3d7ea2eced09,Regression Test Tenant,reg-test-271fca50-ad06-44a5-804c-3d7ea2eced09,28a821eb-44f8-4edf-9588-9d04993752d8[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m56:9[22m[39m
    [90m 54| [39m
    [90m 55| [39m        tenantId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 56| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(organizations)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 57| [39m            id[33m:[39m tenantId[33m,[39m
    [90m 58| [39m            tenantId[33m:[39m rootTenantId[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m56:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 346, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(28a821eb-44f8-4edf-9588-9d04993752d8) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'organizations', dataType: undefined, constraint: 'organizations_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[25/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m > [22mAuth Middleware Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2m‚ùØ[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regi‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2m‚ùØ[22m tests/integration/auth/auth.middleware.integration.test.ts:[2m35:15[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[26/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m > [22mAuth Middleware Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2m‚ùØ[22m tests/integration/auth/auth.middleware.integration.test.ts:[2m45:19[22m[39m
    [90m 43| [39m
    [90m 44| [39m    [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 45| [39m        [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m 46| [39m    })[33m;[39m
    [90m 47| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[27/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/jwt.authentication.test.ts[2m > [22mJWT Authentication Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2m‚ùØ[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regi‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2m‚ùØ[22m tests/integration/auth/jwt.authentication.test.ts:[2m31:15[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[28/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/jwt.authentication.test.ts[2m > [22mJWT Authentication Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2m‚ùØ[22m tests/integration/auth/jwt.authentication.test.ts:[2m40:19[22m[39m
    [90m 38| [39m
    [90m 39| [39m    [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 40| [39m        [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m 41| [39m    })[33m;[39m
    [90m 42| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[29/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/protected.routes.test.ts[2m > [22mProtected Routes Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2m‚ùØ[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regi‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2m‚ùØ[22m tests/integration/auth/protected.routes.test.ts:[2m31:15[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[30/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/session.management.integration.test.ts[2m > [22mSession Management Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2m‚ùØ[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regi‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2m‚ùØ[22m tests/integration/auth/session.management.integration.test.ts:[2m31:15[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[31/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/session.management.integration.test.ts[2m > [22mSession Management Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2m‚ùØ[22m tests/integration/auth/session.management.integration.test.ts:[2m40:19[22m[39m
    [90m 38| [39m
    [90m 39| [39m    [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 40| [39m        [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m 41| [39m    })[33m;[39m
    [90m 42| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[32/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/workflows/runtime-pipelines.test.ts[2m > [22mRuntime Pipelines Integration Tests
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, default, default, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: Rjv33NWeTNbf410SOnXRc,test-pipeline-user@example.com,3e97c6fd-3176-44f7-a474-a0ebea51d6ef,admin,owner[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/workflows/runtime-pipelines.test.ts:[2m75:20[22m[39m
    [90m 73| [39m
    [90m 74| [39m    [90m// Create test user[39m
    [90m 75| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 76| [39m      id[33m:[39m testUserId[33m,[39m
    [90m 77| [39m      email[33m:[39m [32m'test-pipeline-user@example.com'[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/workflows/runtime-pipelines.test.ts:[2m75:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(3e97c6fd-3176-44f7-a474-a0ebea51d6ef) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[33/354]‚éØ[22m[39m


[31m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39m[1m[41m Failed Tests 321 [49m[22m[31m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39m

[41m[1m FAIL [22m[49m tests/integration/analytics_preservation.test.ts[2m > [22mAnalytics Preservation[2m > [22mshould preserve lifetime user count when a user is deleted
[31m[1mAssertionError[22m: expected { ‚Ä¶(18) } to be undefined[39m

[32m- Expected:[39m 
undefined

[31m+ Received:[39m 
{
  "authProvider": "local",
  "createdAt": 2026-01-18T05:55:16.314Z,
  "defaultMode": "easy",
  "email": "analytics-test-1768715715070@example.com",
  "emailVerified": false,
  "firstName": "Analytics",
  "fullName": null,
  "id": "9e149b36-620a-4688-b879-c0abc2068922",
  "isPlaceholder": false,
  "lastName": "Test",
  "lastPasswordChange": null,
  "mfaEnabled": false,
  "placeholderEmail": null,
  "profileImageUrl": null,
  "role": "creator",
  "tenantId": null,
  "tenantRole": null,
  "updatedAt": 2026-01-18T05:55:16.314Z,
}

[36m [2m‚ùØ[22m tests/integration/analytics_preservation.test.ts:[2m42:29[22m[39m
    [90m 40| [39m        [90m// 5. Verify user is gone from users table[39m
    [90m 41| [39m        const deletedUser = await userRepository.findByEmail(testEmail‚Ä¶
    [90m 42| [39m        [34mexpect[39m(deletedUser)[33m.[39m[34mtoBeUndefined[39m()[33m;[39m
    [90m   | [39m                            [31m^[39m
    [90m 43| [39m
    [90m 44| [39m        [90m// 6. Verify lifetime stats are PRESERVED (did not decrement)[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[34/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.ai.personalization.test.ts[2m > [22mPersonalization API Integration Tests[2m > [22mPOST /api/ai/personalize/settings[2m > [22mshould update user settings
[31m[1mAssertionError[22m: expected 'friendly' to be 'formal' // Object.is equality[39m

Expected: [32m"f[7mormal[27m"[39m
Received: [31m"f[7mriendly[27m"[39m

[36m [2m‚ùØ[22m tests/integration/api.ai.personalization.test.ts:[2m137:35[22m[39m
    [90m135| [39m            [90m// Verify in DB[39m
    [90m136| [39m            const [settings] = await db.select().from(userPersonalizat‚Ä¶
    [90m137| [39m            [34mexpect[39m(settings[33m.[39mtone)[33m.[39m[34mtoBe[39m([32m'formal'[39m)[33m;[39m
    [90m   | [39m                                  [31m^[39m
    [90m138| [39m        })[33m;[39m
    [90m139| [39m    })[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[35/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.snapshots.test.ts[2m > [22mStage 13: Workflow Snapshots & Versioning[2m > [22mshould maintain immutability of runs across versions
[31m[1mError[22m: Failed query: insert into "workflow_versions" ("id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at") values ($1, $2, default, $3, $4, $5, default, default, default, default, $6, $7, $8, $9, $10) returning "id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at"
params: a2f184f3-b870-4be8-8032-07a1afe73348,4d295a18-00e3-464e-baa6-36b719a1d557,1,true,{"nodes":[{"id":"q1","type":"question","config":{"key":"q1","question":"Version 1 Question","type":"short_text"}}],"edges":[],"startNodeId":"q1"},test-user-id,true,2026-01-18T05:56:04.363Z,2026-01-18T05:56:04.265Z,2026-01-18T05:56:04.265Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/api.snapshots.test.ts:[2m182:28[22m[39m
    [90m180| [39m
    [90m181| [39m        [90m// 2. Publish Version 1[39m
    [90m182| [39m        const [version1] = await db.insert(schema.workflowVersions).va‚Ä¶
    [90m   | [39m                           [31m^[39m
    [90m183| [39m            [33m...[39mvData[33m,[39m
    [90m184| [39m            workflowId[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "workflow_versions" violates foreign key constraint "workflow_versions_workflow_id_workflows_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/api.snapshots.test.ts:[2m182:28[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 376, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(4d295a18-00e3-464e-baa6-36b719a1d557) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w137_v3', table: 'workflow_versions', dataType: undefined, constraint: 'workflow_versions_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[36/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mComplete Registration ‚Üí Login Flow[2m > [22mshould complete registration, verify email, then login
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m73:39[22m[39m
    [90m 71| [39m        })[33m;[39m
    [90m 72| [39m
    [90m 73| [39m      [34mexpect[39m(registerResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                                      [31m^[39m
    [90m 74| [39m      [34mexpect[39m(registerResponse[33m.[39mbody[33m.[39muser[33m.[39memailVerified)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
    [90m 75| [39m      [34mtrackUser[39m(registerResponse[33m.[39mbody[33m.[39muser[33m.[39mid)[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[37/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mAccount Lockout Flow[2m > [22mshould lock account after 5 failed attempts, then unlock after waiting
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: b540ce593824a98e41934d4f826c703a,$2b$12$WCayknAtRxgaLks7a4kvL.jE9TJ9QrANZZQn91sV0/qJAy9XAcvG6,2026-01-18T05:54:56.642Z,2026-01-18T05:54:56.642Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m105:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m105:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(b540ce593824a98e41934d4f826c703a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[38/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mAccount Lockout Flow[2m > [22mshould record all login attempts
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 0d272d7a85e901929d5b2e85aff9d82a,$2b$12$Ef8/RtF6VyiTGHt.J6C4Ne6.Ki047GeXBdx5lyvbA0.ffQi73EG.S,2026-01-18T05:54:57.362Z,2026-01-18T05:54:57.362Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m161:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m161:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(0d272d7a85e901929d5b2e85aff9d82a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mMFA Enrollment and Login Flow[2m > [22mshould complete MFA setup and login with TOTP
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m197:36[22m[39m
    [90m195| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m196| [39m
    [90m197| [39m      [34mexpect[39m(setupResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                   [31m^[39m
    [90m198| [39m      [34mexpect[39m(setupResponse[33m.[39mbody[33m.[39mqrCodeDataUrl)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m199| [39m      [34mexpect[39m(setupResponse[33m.[39mbody[33m.[39mbackupCodes)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[40/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mMFA Enrollment and Login Flow[2m > [22mshould login with backup code when TOTP unavailable
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'id')[39m
[36m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m276:44[22m[39m
    [90m274| [39m
    [90m275| [39m      [35mconst[39m mfaSecret [33m=[39m [35mawait[39m db[33m.[39mquery[33m.[39mmfaSecrets[33m.[39m[34mfindFirst[39m({
    [90m276| [39m        where[33m:[39m [34meq[39m(mfaSecrets[33m.[39muserId[33m,[39m user[33m![39m[33m.[39mid)[33m,[39m
    [90m   | [39m                                           [31m^[39m
    [90m277| [39m      })[33m;[39m
    [90m278| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[41/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mPassword Reset Flow[2m > [22mshould complete full password reset flow
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'id')[39m
[36m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m342:53[22m[39m
    [90m340| [39m
    [90m341| [39m      const resetTokenRecord = await db.query.passwordResetTokens.find‚Ä¶
    [90m342| [39m        where[33m:[39m [34meq[39m(passwordResetTokens[33m.[39muserId[33m,[39m user[33m![39m[33m.[39mid)[33m,[39m
    [90m   | [39m                                                    [31m^[39m
    [90m343| [39m      })[33m;[39m
    [90m344| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[42/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mPassword Reset Flow[2m > [22mshould invalidate all sessions after password reset
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 03ae1219897d2265b29726ecec1fea5c,$2b$12$vXpKg7KNUvrV9owUBM1yIe701hyjjy8j/3Vk2BrdYsNVr/d.X0fti,2026-01-18T05:55:01.544Z,2026-01-18T05:55:01.544Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m383:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m383:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(03ae1219897d2265b29726ecec1fea5c) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[43/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mToken Refresh Flow[2m > [22mshould rotate refresh token on each use
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m439:40[22m[39m
    [90m437| [39m
    [90m438| [39m      const cookies = loginResponse.headers['set-cookie'] as unknown a‚Ä¶
    [90m439| [39m      let refreshTokenCookie = cookies.find(c => c.startsWith('refresh‚Ä¶
    [90m   | [39m                                       [31m^[39m
    [90m440| [39m
    [90m441| [39m      [34mexpect[39m(refreshTokenCookie)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[44/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mToken Refresh Flow[2m > [22mshould detect and prevent refresh token reuse (token theft)
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m473:44[22m[39m
    [90m471| [39m
    [90m472| [39m      const cookies = loginResponse.headers['set-cookie'] as unknown a‚Ä¶
    [90m473| [39m      const originalRefreshToken = cookies.find(c => c.startsWith('ref‚Ä¶
    [90m   | [39m                                           [31m^[39m
    [90m474| [39m
    [90m475| [39m      [90m// Use token once (rotation happens)[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[45/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mSession Management Flow[2m > [22mshould list all active sessions
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 47438db065fe28f1581e4866a695f012,$2b$12$bk1QgNAz1OdF3JY8Xvz4Ie0MBbIdlasEIoQgCuEt0V.EPEafsh2ZO,2026-01-18T05:55:04.452Z,2026-01-18T05:55:04.452Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m507:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m507:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(47438db065fe28f1581e4866a695f012) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[46/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mSession Management Flow[2m > [22mshould revoke specific session
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m554:40[22m[39m
    [90m552| [39m
    [90m553| [39m      [35mconst[39m sessions [33m=[39m sessionsResponse[33m.[39mbody[33m.[39msessions[33m;[39m
    [90m554| [39m      [35mconst[39m sessionToRevoke [33m=[39m sessions[33m.[39m[34mfind[39m((s[33m:[39m any) [33m=>[39m [33m![39ms[33m.[39mcurrent)[33m;[39m
    [90m   | [39m                                       [31m^[39m
    [90m555| [39m
    [90m556| [39m      [90m// Revoke first session[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[47/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/register[2m > [22mshould register a new user successfully
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m78:31[22m[39m
    [90m 76| [39m        })[33m;[39m
    [90m 77| [39m
    [90m 78| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m 79| [39m      expect((response.body).message).toContain("Registration successf‚Ä¶
    [90m 80| [39m      [34mexpect[39m((response[33m.[39mbody)[33m.[39mtoken)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[48/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/register[2m > [22mshould return 409 for duplicate email
[31m[1mAssertionError[22m: expected 500 to be 409 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 409[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m139:31[22m[39m
    [90m137| [39m        [33m.[39m[34msend[39m({ email[33m,[39m password[33m,[39m firstName[33m:[39m [32m"Second"[39m })[33m;[39m
    [90m138| [39m
    [90m139| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m409[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m140| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"already exists"[39m)[33m;[39m
    [90m141| [39m    })[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[49/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/register[2m > [22mshould set httpOnly refresh token cookie
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m151:31[22m[39m
    [90m149| [39m        [33m.[39m[34msend[39m({ email[33m,[39m password[33m,[39m firstName[33m:[39m [32m"Test"[39m })[33m;[39m
    [90m150| [39m
    [90m151| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m152| [39m      [34mexpect[39m(response[33m.[39mheaders[[32m'set-cookie'[39m])[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m153| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[50/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould login with valid credentials
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: f666e912ea1415ef01e2740a6542ce55,$2b$12$Bi1cPyyeKqQcTn1zydDWfuO/a1ljDVKqo1PmCHesZSBw.8VXLydHy,2026-01-18T05:54:59.152Z,2026-01-18T05:54:59.152Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m164:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m164:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(f666e912ea1415ef01e2740a6542ce55) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[51/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould return 403 for unverified email
[31m[1mAssertionError[22m: expected 401 to be 403 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 403[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m226:31[22m[39m
    [90m224| [39m        [33m.[39m[34msend[39m({ email[33m,[39m password })[33m;[39m
    [90m225| [39m
    [90m226| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m403[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m227| [39m      expect(response.body.message || response.body.error).toBeDefined‚Ä¶
    [90m228| [39m    })[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[52/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould record failed login attempt
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 42d507b80a17d7e48b78e9dd27dd1eb6,$2b$12$fl3mI2AKrs5Ib1GD5fQCUuI0/5cWmfs4F3t.p.r/o5O5VL3EVxV1u,2026-01-18T05:55:02.267Z,2026-01-18T05:55:02.267Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m231:33[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m231:33[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(42d507b80a17d7e48b78e9dd27dd1eb6) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[53/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould return requiresMfa=true for MFA-enabled users
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 0d386761137f0ce4a82997fcce5b4350,$2b$12$12bO2Lr/HTG34nkJuurQ8uo7q1q1Nr0UTrGr70uu05hZFXtSe4XSS,2026-01-18T05:55:02.930Z,2026-01-18T05:55:02.930Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m252:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m252:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(0d386761137f0ce4a82997fcce5b4350) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[54/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould lock account after 5 failed attempts
[31m[1mAssertionError[22m: expected 401 to be 423 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 423[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m287:31[22m[39m
    [90m285| [39m        })[33m;[39m
    [90m286| [39m
    [90m287| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m423[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m288| [39m      [34mexpect[39m(response[33m.[39mbody)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m289| [39m      expect(response.body.error || response.body.message).toBeDefined‚Ä¶

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[55/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/logout[2m > [22mshould logout and clear refresh token cookie
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 9d2080ac6235ae50494148e41f192ab3,$2b$12$BnaFozjHF/8yXAMWsnWGgOd6gB.RqJXyo3y1Pvjd9naC5qqcOahue,2026-01-18T05:55:05.681Z,2026-01-18T05:55:05.681Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m295:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m295:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(9d2080ac6235ae50494148e41f192ab3) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w29_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[56/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould refresh access token with valid refresh token
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 02446f4bbee826319a9e08f7ce932574,$2b$12$zpi7Y4ebaM5Qntshouv1KOk9OlQSsD5qRocErMdzFX4a7XhflzQt6,2026-01-18T05:55:06.371Z,2026-01-18T05:55:06.371Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m325:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m325:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(02446f4bbee826319a9e08f7ce932574) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w29_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[57/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould rotate refresh token after use
[31m[1mAssertionError[22m: expected undefined to be defined[39m
[36m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m372:23[22m[39m
    [90m370| [39m
    [90m371| [39m      const cookies = (loginResponse.headers as any)['set-cookie'] as ‚Ä¶
    [90m372| [39m      [34mexpect[39m(cookies)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m   | [39m                      [31m^[39m
    [90m373| [39m      const oldCookie = cookies!.find(c => c.startsWith('refresh_token‚Ä¶
    [90m374| [39m      [34mexpect[39m(oldCookie)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[58/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/reset-password[2m > [22mshould reset password with valid token
[31m[1mAssertionError[22m: expected null to be truthy[39m

[32m- Expected:[39m 
true

[31m+ Received:[39m 
null

[36m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m428:21[22m[39m
    [90m426| [39m      [90m// Generate reset token[39m
    [90m427| [39m      [35mconst[39m token [33m=[39m [35mawait[39m [34mcreatePasswordResetToken[39m(email)[33m;[39m
    [90m428| [39m      [34mexpect[39m(token)[33m.[39m[34mtoBeTruthy[39m()[33m;[39m
    [90m   | [39m                    [31m^[39m
    [90m429| [39m
    [90m430| [39m      [35mconst[39m newPassword [33m=[39m [34mrandomPassword[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[59/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/reset-password[2m > [22mshould return 400 for weak new password
[31m[1mAssertionError[22m: expected 'Token and password required' to contain 'Password'[39m

Expected: [32m"[7mPasswor[27md"[39m
Received: [31m"[7mToken and password require[27md"[39m

[36m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m481:37[22m[39m
    [90m479| [39m
    [90m480| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m400[39m)[33m;[39m
    [90m481| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"Password"[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m482| [39m    })[33m;[39m
    [90m483| [39m  })[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[60/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mGET /api/auth/me[2m > [22mshould return current user for valid token
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 801079059ab6bec2b72c509d6a1cbd82,$2b$12$reNGEsV4kyl3MgZNP8jcuOsOV/wHA64GtvsbS6znZ.PLOwsG6nRxy,2026-01-18T05:55:11.602Z,2026-01-18T05:55:11.602Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m487:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m487:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(801079059ab6bec2b72c509d6a1cbd82) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w35_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[61/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mMFA Routes[2m > [22mPOST /api/auth/mfa/verify-login[2m > [22mshould complete MFA login with valid TOTP code
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: edc6041bfa16eb7d45987fb0ae64b0c1,GIUES5BVPB2FC4R3KQZVQWTEGBMDIRLEGBRT4JTIKFFUC53LIYYQ,true,2026-01-18T05:55:12.429Z,2026-01-18T05:55:12.429Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m523:57[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m523:57[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(edc6041bfa16eb7d45987fb0ae64b0c1) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w38_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[62/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mMFA Routes[2m > [22mPOST /api/auth/mfa/verify-login[2m > [22mshould reject invalid MFA code
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 741db3824ba3fc0169ae85459ae08edb,$2b$12$H1jcvM4XjKsXFAQc2Fqkm.M5nDL4kAy/.bQJkQ.Ma2pDCtvSemPzq,2026-01-18T05:55:13.215Z,2026-01-18T05:55:13.215Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m549:28[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m549:28[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(741db3824ba3fc0169ae85459ae08edb) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w38_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[63/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mCollection Lifecycle[2m > [22mshould create a collection
[31m[1mError[22m: Failed query: insert into "collections" ("id", "tenant_id", "name", "slug", "description", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, default) returning "id", "tenant_id", "name", "slug", "description", "created_at", "updated_at"
params: 6572535b-f8c4-4c4f-89f0-39fc9c26b213,Customers,customers,Customer database[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m CollectionRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
    [90m 88| [39m    [35mconst[39m database [33m=[39m [35mthis[39m[33m.[39m[34mgetDb[39m(tx)[33m;[39m
    [90m 89| [39m
    [90m 90| [39m    [35mconst[39m [record] [33m=[39m [35mawait[39m database
    [90m   | [39m                     [31m^[39m
    [90m 91| [39m      [33m.[39m[34minsert[39m([35mthis[39m[33m.[39mtable [35mas[39m any)
    [90m 92| [39m      [33m.[39m[34mvalues[39m(data [35mas[39m any)
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m74:26[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "collections" violates foreign key constraint "collections_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m CollectionRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m74:26[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 339, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(6572535b-f8c4-4c4f-89f0-39fc9c26b213) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'collections', dataType: undefined, constraint: 'collections_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[64/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mCollection Lifecycle[2m > [22mshould list collections
[31m[1mAssertionError[22m: expected 0 to be greater than 0[39m
[36m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m92:34[22m[39m
    [90m 90| [39m
    [90m 91| [39m      [34mexpect[39m(collections)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m 92| [39m      [34mexpect[39m(collections[33m.[39mlength)[33m.[39m[34mtoBeGreaterThan[39m([34m0[39m)[33m;[39m
    [90m   | [39m                                 [31m^[39m
    [90m 93| [39m      expect(collections.some(c => c.id === testCollectionId)).toBe(tr‚Ä¶
    [90m 94| [39m    })[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[65/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mCollection Lifecycle[2m > [22mshould get a collection by ID
[31m[1mError[22m: Collection not found[39m
[36m [2m‚ùØ[22m CollectionService.verifyTenantOwnership server/services/CollectionService.ts:[2m67:13[22m[39m
    [90m 65| [39m
    [90m 66| [39m    [35mif[39m ([33m![39mcollection) {
    [90m 67| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Collection not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 68| [39m    }
    [90m 69| [39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m97:26[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[66/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mCollection Lifecycle[2m > [22mshould update a collection
[31m[1mError[22m: Collection not found[39m
[36m [2m‚ùØ[22m CollectionService.verifyTenantOwnership server/services/CollectionService.ts:[2m67:13[22m[39m
    [90m 65| [39m
    [90m 66| [39m    [35mif[39m ([33m![39mcollection) {
    [90m 67| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Collection not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 68| [39m    }
    [90m 69| [39m
[90m [2m‚ùØ[22m CollectionService.updateCollection server/services/CollectionService.ts:[2m147:5[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m105:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[67/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mField Management[2m > [22mshould create text field
[31m[1mError[22m: Collection not found[39m
[36m [2m‚ùØ[22m CollectionFieldService.verifyCollectionExists server/services/CollectionFieldService.ts:[2m62:13[22m[39m
    [90m 60| [39m    const collection = await this.collectionRepo.findById(collectionId‚Ä¶
    [90m 61| [39m    [35mif[39m ([33m![39mcollection) {
    [90m 62| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Collection not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 63| [39m    }
    [90m 64| [39m  }
[90m [2m‚ùØ[22m CollectionFieldService.createField server/services/CollectionFieldService.ts:[2m163:5[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m115:21[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[68/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mField Management[2m > [22mshould create email field
[31m[1mError[22m: Collection not found[39m
[36m [2m‚ùØ[22m CollectionFieldService.verifyCollectionExists server/services/CollectionFieldService.ts:[2m62:13[22m[39m
    [90m 60| [39m    const collection = await this.collectionRepo.findById(collectionId‚Ä¶
    [90m 61| [39m    [35mif[39m ([33m![39mcollection) {
    [90m 62| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Collection not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 63| [39m    }
    [90m 64| [39m  }
[90m [2m‚ùØ[22m CollectionFieldService.createField server/services/CollectionFieldService.ts:[2m163:5[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m133:21[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[69/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mField Management[2m > [22mshould create number field
[31m[1mError[22m: Collection not found[39m
[36m [2m‚ùØ[22m CollectionFieldService.verifyCollectionExists server/services/CollectionFieldService.ts:[2m62:13[22m[39m
    [90m 60| [39m    const collection = await this.collectionRepo.findById(collectionId‚Ä¶
    [90m 61| [39m    [35mif[39m ([33m![39mcollection) {
    [90m 62| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Collection not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 63| [39m    }
    [90m 64| [39m  }
[90m [2m‚ùØ[22m CollectionFieldService.createField server/services/CollectionFieldService.ts:[2m163:5[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m146:21[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[70/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mField Management[2m > [22mshould create select field with options
[31m[1mError[22m: Collection not found[39m
[36m [2m‚ùØ[22m CollectionFieldService.verifyCollectionExists server/services/CollectionFieldService.ts:[2m62:13[22m[39m
    [90m 60| [39m    const collection = await this.collectionRepo.findById(collectionId‚Ä¶
    [90m 61| [39m    [35mif[39m ([33m![39mcollection) {
    [90m 62| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Collection not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 63| [39m    }
    [90m 64| [39m  }
[90m [2m‚ùØ[22m CollectionFieldService.createField server/services/CollectionFieldService.ts:[2m163:5[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m161:21[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[71/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mField Management[2m > [22mshould create boolean field
[31m[1mError[22m: Collection not found[39m
[36m [2m‚ùØ[22m CollectionFieldService.verifyCollectionExists server/services/CollectionFieldService.ts:[2m62:13[22m[39m
    [90m 60| [39m    const collection = await this.collectionRepo.findById(collectionId‚Ä¶
    [90m 61| [39m    [35mif[39m ([33m![39mcollection) {
    [90m 62| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Collection not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 63| [39m    }
    [90m 64| [39m  }
[90m [2m‚ùØ[22m CollectionFieldService.createField server/services/CollectionFieldService.ts:[2m163:5[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m178:21[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[72/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mField Management[2m > [22mshould list all fields
[31m[1mAssertionError[22m: expected +0 to be 5 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 5[39m
[31m+ 0[39m

[36m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m195:29[22m[39m
    [90m193| [39m      const fields = await collectionFieldService.listFields(testColle‚Ä¶
    [90m194| [39m
    [90m195| [39m      [34mexpect[39m(fields[33m.[39mlength)[33m.[39m[34mtoBe[39m([34m5[39m)[33m;[39m
    [90m   | [39m                            [31m^[39m
    [90m196| [39m      [34mexpect[39m(fields[33m.[39m[34mmap[39m(f [33m=>[39m f[33m.[39mslug))[33m.[39m[34mtoEqual[39m([
    [90m197| [39m        [32m'first_name'[39m[33m,[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[73/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mField Management[2m > [22mshould update field
[31m[1mError[22m: Field not found[39m
[36m [2m‚ùØ[22m CollectionFieldService.verifyFieldOwnership server/services/CollectionFieldService.ts:[2m73:13[22m[39m
    [90m 71| [39m
    [90m 72| [39m    [35mif[39m ([33m![39mfield) {
    [90m 73| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Field not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 74| [39m    }
    [90m 75| [39m
[90m [2m‚ùØ[22m CollectionFieldService.updateField server/services/CollectionFieldService.ts:[2m206:5[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m206:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[74/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mRecord CRUD Operations[2m > [22mshould create a record
[31m[1mError[22m: Collection not found[39m
[36m [2m‚ùØ[22m RecordService.verifyCollectionExists server/services/RecordService.ts:[2m35:13[22m[39m
    [90m 33| [39m    const collection = await this.collectionRepo.findById(collectionId‚Ä¶
    [90m 34| [39m    [35mif[39m ([33m![39mcollection) {
    [90m 35| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Collection not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 36| [39m    }
    [90m 37| [39m  }
[90m [2m‚ùØ[22m RecordService.createRecord server/services/RecordService.ts:[2m214:5[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m219:22[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[75/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mRecord CRUD Operations[2m > [22mshould create multiple records
[31m[1mError[22m: Collection not found[39m
[36m [2m‚ùØ[22m RecordService.verifyCollectionExists server/services/RecordService.ts:[2m35:13[22m[39m
    [90m 33| [39m    const collection = await this.collectionRepo.findById(collectionId‚Ä¶
    [90m 34| [39m    [35mif[39m ([33m![39mcollection) {
    [90m 35| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Collection not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 36| [39m    }
    [90m 37| [39m  }
[90m [2m‚ùØ[22m RecordService.createRecord server/services/RecordService.ts:[2m214:5[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m241:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[76/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mRecord CRUD Operations[2m > [22mshould list records with pagination
[31m[1mError[22m: Collection not found or access denied[39m
[36m [2m‚ùØ[22m RecordService.listRecords server/services/RecordService.ts:[2m257:13[22m[39m
    [90m255| [39m    const collection = await this.collectionRepo.findById(collectionId‚Ä¶
    [90m256| [39m    [35mif[39m ([33m![39mcollection [33m||[39m collection[33m.[39mtenantId [33m!==[39m tenantId) {
    [90m257| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Collection not found or access denied"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m258| [39m    }
    [90m259| [39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m269:22[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[77/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mRecord CRUD Operations[2m > [22mshould get a single record
[31m[1mError[22m: Record not found[39m
[36m [2m‚ùØ[22m RecordService.verifyRecordOwnership server/services/RecordService.ts:[2m51:13[22m[39m
    [90m 49| [39m
    [90m 50| [39m    [35mif[39m ([33m![39mrecord) {
    [90m 51| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Record not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 52| [39m    }
    [90m 53| [39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m277:22[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[78/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mRecord CRUD Operations[2m > [22mshould update a record
[31m[1mError[22m: Record not found[39m
[36m [2m‚ùØ[22m RecordService.verifyRecordOwnership server/services/RecordService.ts:[2m51:13[22m[39m
    [90m 49| [39m
    [90m 50| [39m    [35mif[39m ([33m![39mrecord) {
    [90m 51| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Record not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 52| [39m    }
    [90m 53| [39m
[90m [2m‚ùØ[22m RecordService.updateRecord server/services/RecordService.ts:[2m273:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m284:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[79/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mRecord CRUD Operations[2m > [22mshould find records by filters
[31m[1mError[22m: Collection not found or access denied[39m
[36m [2m‚ùØ[22m RecordService.findRecordsByFilters server/services/RecordService.ts:[2m325:13[22m[39m
    [90m323| [39m    const collection = await this.collectionRepo.findById(collectionId‚Ä¶
    [90m324| [39m    [35mif[39m ([33m![39mcollection [33m||[39m collection[33m.[39mtenantId [33m!==[39m tenantId) {
    [90m325| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Collection not found or access denied"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m326| [39m    }
    [90m327| [39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m297:22[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[80/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mRecord CRUD Operations[2m > [22mshould delete a record
[31m[1mError[22m: Record not found[39m
[36m [2m‚ùØ[22m RecordService.verifyRecordOwnership server/services/RecordService.ts:[2m51:13[22m[39m
    [90m 49| [39m
    [90m 50| [39m    [35mif[39m ([33m![39mrecord) {
    [90m 51| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Record not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 52| [39m    }
    [90m 53| [39m
[90m [2m‚ùØ[22m RecordService.deleteRecord server/services/RecordService.ts:[2m298:5[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m308:7[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[81/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mCollection Stats[2m > [22mshould list collections with stats
[31m[1mAssertionError[22m: expected undefined to be defined[39m
[36m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m324:34[22m[39m
    [90m322| [39m
    [90m323| [39m      const customerCollection = collections.find(c => c.id === testCo‚Ä¶
    [90m324| [39m      [34mexpect[39m(customerCollection)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m   | [39m                                 [31m^[39m
    [90m325| [39m      [34mexpect[39m(customerCollection[33m![39m[33m.[39mfieldCount)[33m.[39m[34mtoBe[39m([34m5[39m)[33m;[39m
    [90m326| [39m      [34mexpect[39m([33mNumber[39m(customerCollection[33m![39m[33m.[39mrecordCount))[33m.[39m[34mtoBe[39m([34m2[39m)[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[82/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mData Validation[2m > [22mshould validate field types
[31m[1mError[22m: Collection not found[39m
[36m [2m‚ùØ[22m RecordService.verifyCollectionExists server/services/RecordService.ts:[2m35:13[22m[39m
    [90m 33| [39m    const collection = await this.collectionRepo.findById(collectionId‚Ä¶
    [90m 34| [39m    [35mif[39m ([33m![39mcollection) {
    [90m 35| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Collection not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 36| [39m    }
    [90m 37| [39m  }
[90m [2m‚ùØ[22m RecordService.createRecord server/services/RecordService.ts:[2m214:5[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m345:22[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[83/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mCleanup[2m > [22mshould delete collection (cascade fields and records)
[31m[1mError[22m: Collection not found[39m
[36m [2m‚ùØ[22m CollectionService.verifyTenantOwnership server/services/CollectionService.ts:[2m67:13[22m[39m
    [90m 65| [39m
    [90m 66| [39m    [35mif[39m ([33m![39mcollection) {
    [90m 67| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Collection not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 68| [39m    }
    [90m 69| [39m
[90m [2m‚ùØ[22m CollectionService.deleteCollection server/services/CollectionService.ts:[2m167:5[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m364:7[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[84/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/js_helpers.test.ts[2m > [22mDetailed Verification: JS Helper Availability[2m > [22mshould execute a JS block that uses helper functions
[31m[1mAssertionError[22m: expected undefined to be defined[39m
[36m [2m‚ùØ[22m tests/integration/js_helpers.test.ts:[2m185:28[22m[39m
    [90m183| [39m        )[33m;[39m
    [90m184| [39m
    [90m185| [39m        [34mexpect[39m(savedValue)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m   | [39m                           [31m^[39m
    [90m186| [39m        [35mconst[39m result [33m=[39m savedValue[33m.[39mvalue [35mas[39m any[33m;[39m
    [90m187| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[85/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould complete full MFA setup flow
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 9de6667e1b9e2539b3b1fcd68782ac28,$2b$12$h/2/i7ZW2nZ.NsDKq8eJyusTMwGUT7UE.FoRgoe1Pnjj8ueOUMr5e,2026-01-18T05:55:09.251Z,2026-01-18T05:55:09.251Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m59:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m59:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(9de6667e1b9e2539b3b1fcd68782ac28) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w36_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[86/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould reject invalid TOTP code during setup
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: d93f8eaa4e92d8a235672c9e0557df7c,$2b$12$ymG9VgEozutmlbQjDgPx0e6pfo5Tkifmc80GgUy3DPoy2lwWr/ZLO,2026-01-18T05:55:09.991Z,2026-01-18T05:55:09.991Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m125:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m125:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(d93f8eaa4e92d8a235672c9e0557df7c) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w26_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[87/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould not allow MFA setup if already enabled
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 128e484a3fa46dbf5b4dd94e898c4bf1,$2b$12$1eF.0Jh7iYj8UfRkrHc4Ie1cL24g9/8S5nEu9jd4tebUMI1iu.8iK,2026-01-18T05:55:10.753Z,2026-01-18T05:55:10.753Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m157:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m157:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(128e484a3fa46dbf5b4dd94e898c4bf1) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w28_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[88/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould generate unique backup codes
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 679ca3e607dcd7bad498592e7d1227ca,$2b$12$LqHz1UjePTGK3t.vXkOOy.fov8p.OblrkFbLeFlKjWcidvW1/7/.C,2026-01-18T05:55:11.427Z,2026-01-18T05:55:11.427Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m171:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m171:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(679ca3e607dcd7bad498592e7d1227ca) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w42_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[89/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould store hashed backup codes
[31m[1mAssertionError[22m: expected [] to have a length of 10 but got +0[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 10[39m
[31m+ 0[39m

[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m208:27[22m[39m
    [90m206| [39m      })[33m;[39m
    [90m207| [39m
    [90m208| [39m      [34mexpect[39m(storedCodes)[33m.[39m[34mtoHaveLength[39m([34m10[39m)[33m;[39m
    [90m   | [39m                          [31m^[39m
    [90m209| [39m
    [90m210| [39m      [90m// Hashes should not match plain codes[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[90/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Login Flow[2m > [22mshould require MFA for enabled users
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 2726d5e892284a484bbd9466b1455287,$2b$12$UBYUma5mWw7E2d76TrkypuYjMo.PGbgtW9NlysNz2b7r7bT0xXXnu,2026-01-18T05:55:13.567Z,2026-01-18T05:55:13.567Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m220:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m220:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(2726d5e892284a484bbd9466b1455287) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w41_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[91/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Login Flow[2m > [22mshould complete MFA login with valid TOTP
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 6983382b4be21a1f6da5f48c480f359f,$2b$12$JEjEv95Vw74gAvPWBqbHHuC3nXlfrssqfIBuf3LkSP4zuPVojj6OG,2026-01-18T05:55:14.311Z,2026-01-18T05:55:14.311Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m234:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m234:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(6983382b4be21a1f6da5f48c480f359f) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w47_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[92/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Login Flow[2m > [22mshould reject invalid TOTP during login
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 775bcade411c2c73d1e63d4cd6feeb51,$2b$12$hfL7WkzuGUCKMn/JV8rosOSoVf2RIar9cAAwdWhc9LslRLJoFTXl2,2026-01-18T05:55:15.033Z,2026-01-18T05:55:15.033Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m268:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m268:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(775bcade411c2c73d1e63d4cd6feeb51) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w49_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[93/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Login Flow[2m > [22mshould accept TOTP codes within 60-second window
[31m[1mError[22m: Failed query: insert into "mfa_backup_codes" ("id", "user_id", "code_hash", "used", "used_at", "created_at") values (default, $1, $2, $3, default, $4), (default, $5, $6, $7, default, $8), (default, $9, $10, $11, default, $12), (default, $13, $14, $15, default, $16), (default, $17, $18, $19, default, $20), (default, $21, $22, $23, default, $24), (default, $25, $26, $27, default, $28), (default, $29, $30, $31, default, $32), (default, $33, $34, $35, default, $36), (default, $37, $38, $39, default, $40)
params: 084f5420d46b0823d4e6155246929b15,$2b$10$EJj9Z7xpEby7UVMfeWrjR.Ho1lxUMSS5fQ075s3e0FoaL9PZXX8Gq,false,2026-01-18T05:55:16.109Z,084f5420d46b0823d4e6155246929b15,$2b$10$1HDb0s4c0IsK/cC9CYM/xOg0euJ45fHp56tX2X/1U5ULKQU6MH2MK,false,2026-01-18T05:55:16.109Z,084f5420d46b0823d4e6155246929b15,$2b$10$yw.SNa.a3Z5gvY6nUlMC7e99fGGtLNjUy1jGj9TZzU.k53JdUBqD6,false,2026-01-18T05:55:16.109Z,084f5420d46b0823d4e6155246929b15,$2b$10$.21qlgmwAOUMGtZ.rCfIa.JkzDcp/fs7z7c7uuv6gB9h1PB2ppafO,false,2026-01-18T05:55:16.112Z,084f5420d46b0823d4e6155246929b15,$2b$10$DncfbQWc2PaLGcR86dSiUuxXdjszlEzjga9Uhct0pjPLxLVFxcLxa,false,2026-01-18T05:55:16.167Z,084f5420d46b0823d4e6155246929b15,$2b$10$7ZJzbyvq82AFxawlrp1vcekNXfrYXg0UCDYWTdi672GH7yBSF.2Uq,false,2026-01-18T05:55:16.167Z,084f5420d46b0823d4e6155246929b15,$2b$10$Brp2C50CAg6J9bEiyzPUm.yL0/AJFOFzQdc7I2Sbs3klazH7vfoJq,false,2026-01-18T05:55:16.167Z,084f5420d46b0823d4e6155246929b15,$2b$10$nXteKy8OwpJqHZgfmIXG2ucFqWzC9AkYhgDZUd49dhwkNG3Q0y5Ia,false,2026-01-18T05:55:16.173Z,084f5420d46b0823d4e6155246929b15,$2b$10$IvH4Fj3OmunJ4juJRJ4pm.XZktICS3YglaZ9NZWaCcggOaH.6kHzy,false,2026-01-18T05:55:16.225Z,084f5420d46b0823d4e6155246929b15,$2b$10$zDCbXkTFcvPgTq0F4xYBn.HBmMlqmIKFkfrf9t6yQvIDt8r96UYG6,false,2026-01-18T05:55:16.224Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m258:3[22m[39m
    [90m256| [39m  )[33m;[39m
    [90m257| [39m
    [90m258| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaBackupCodes)[33m.[39m[34mvalues[39m(hashedCodes)[33m;[39m
    [90m   | [39m  [31m^[39m
    [90m259| [39m
    [90m260| [39m  [35mreturn[39m {
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m286:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_backup_codes" violates foreign key constraint "mfa_backup_codes_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m258:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m286:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(084f5420d46b0823d4e6155246929b15) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w28_v3', table: 'mfa_backup_codes', dataType: undefined, constraint: 'mfa_backup_codes_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[94/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould login with valid backup code
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: c0a6fd203bf8beb2ea20786e6e826836,$2b$12$.w.BY.hhJeFxVYg/2B7jp.bToFnNTOz8FmyitoIexZ1nZazFpgPiS,2026-01-18T05:55:16.916Z,2026-01-18T05:55:16.916Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m318:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m318:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(c0a6fd203bf8beb2ea20786e6e826836) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w28_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[95/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould mark backup code as used
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: a3c366128e81540c213af893c170c719,LNGD6UBMHBDGQ62UKIWFA23FOE2TK2DWNF6S6ILVHJWXARD2JAYA,true,2026-01-18T05:55:17.738Z,2026-01-18T05:55:17.738Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m370:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m370:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(a3c366128e81540c213af893c170c719) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w58_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[96/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould prevent backup code reuse
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'id')[39m
[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m410:44[22m[39m
    [90m408| [39m
    [90m409| [39m      [35mconst[39m mfaSecret [33m=[39m [35mawait[39m db[33m.[39mquery[33m.[39mmfaSecrets[33m.[39m[34mfindFirst[39m({
    [90m410| [39m        where[33m:[39m [34meq[39m(mfaSecrets[33m.[39muserId[33m,[39m user[33m![39m[33m.[39mid)[33m,[39m
    [90m   | [39m                                           [31m^[39m
    [90m411| [39m      })[33m;[39m
    [90m412| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[97/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould try TOTP before backup code
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 0dc10587714ea050713c11553a51f0e5,$2b$12$d8RyJAQ1qOkXch4LnAn8p.niTYxK4knrmv6sj8Is.Z/8atK9htSYi,2026-01-18T05:55:20.176Z,2026-01-18T05:55:20.176Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m452:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m452:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(0dc10587714ea050713c11553a51f0e5) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w62_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[98/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Status[2m > [22mshould return MFA status for user
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m486:37[22m[39m
    [90m484| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mloginResponse[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m485| [39m
    [90m486| [39m      [34mexpect[39m(statusResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m487| [39m      [34mexpect[39m(statusResponse[33m.[39mbody[33m.[39mmfaEnabled)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
    [90m488| [39m      [34mexpect[39m(statusResponse[33m.[39mbody[33m.[39mbackupCodesRemaining)[33m.[39m[34mtoBe[39m([34m0[39m)[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[99/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Status[2m > [22mshould return backup codes count for MFA users
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: cebd4b90052a6399a4672145e911f0d1,$2b$12$rnaMBCEaGAxgGfgsLVdiBuV.ISg3mKvdHcWlvFlpS1KL9xKtAZUa2,2026-01-18T05:55:22.246Z,2026-01-18T05:55:22.246Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m492:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m492:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(cebd4b90052a6399a4672145e911f0d1) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w71_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[100/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Disable Flow[2m > [22mshould disable MFA with password verification
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 16dc58e93b8fdae158ae23238be335c0,$2b$12$vomlhYy/yV4OpblnmruVjeQtL6Mk0cIE7kBor829ISy.dXRIYVeja,2026-01-18T05:55:23.257Z,2026-01-18T05:55:23.257Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m529:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m529:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(16dc58e93b8fdae158ae23238be335c0) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w28_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[101/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Disable Flow[2m > [22mshould require correct password to disable MFA
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: d972c74a4f79592a6c0e36708c176bea,$2b$12$OVk9X5AXTMts960J/4D66O6HVT83/U0mDmaDaOOiWd7EmyexY6uFW,2026-01-18T05:55:23.919Z,2026-01-18T05:55:23.919Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m579:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m579:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(d972c74a4f79592a6c0e36708c176bea) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w28_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[102/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Regeneration[2m > [22mshould regenerate backup codes
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: fba29cd3c39dccdac270d3b078bbafea,$2b$12$vg356DlUD23WyKH.eX0dpO8bJIboc1L57.FnU.lY9R.1FrUVx5Neq,2026-01-18T05:55:24.691Z,2026-01-18T05:55:24.691Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m613:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m613:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(fba29cd3c39dccdac270d3b078bbafea) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w67_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[103/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Regeneration[2m > [22mshould return error if MFA not enabled
[31m[1mAssertionError[22m: expected 401 to be 400 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 400[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m657:31[22m[39m
    [90m655| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mloginResponse[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m656| [39m
    [90m657| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m400[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m658| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"not enabled"[39m)[33m;[39m
    [90m659| [39m    })[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[104/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mTenant-Level MFA Enforcement[2m > [22mshould enforce MFA for tenant users when required by tenant
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m684:36[22m[39m
    [90m682| [39m        [33m.[39m[34msend[39m({ email[33m,[39m password })[33m;[39m
    [90m683| [39m
    [90m684| [39m      [34mexpect[39m(loginResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                   [31m^[39m
    [90m685| [39m      [34mexpect[39m(loginResponse[33m.[39mbody[33m.[39mrequiresMfa)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m686| [39m      [34mexpect[39m(loginResponse[33m.[39mbody[33m.[39muserId)[33m.[39m[34mtoBe[39m(userId)[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[105/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould create placeholder user for non-existent email
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould create invite for existing user without creating placeholder
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould prevent duplicate pending invites
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould require admin access to create invite
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould set expiry to 7 days from now
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould accept invite and create membership
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould reject expired invite
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mrevokeInvite[2m > [22mshould allow admin to revoke invite
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mrevokeInvite[2m > [22mshould prevent accepting revoked invite
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default)
params: 00000000-0000-0000-0000-000000000021,admin@test.com,Admin User,00000000-0000-0000-0000-000000000098,00000000-0000-0000-0000-000000000022,existing_1768715708280@test.com,Existing User,00000000-0000-0000-0000-000000000098[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/organizationInvites.test.ts:[2m46:9[22m[39m
    [90m 44| [39m        await db.delete(users).where(inArray(users.id, [adminUserId, e‚Ä¶
    [90m 45| [39m
    [90m 46| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 47| [39m            { id: adminUserId, email: 'admin@test.com', fullName: 'Adm‚Ä¶
    [90m 48| [39m            { id: existingUserId, email: existingUserEmail, fullName: ‚Ä¶

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/organizationInvites.test.ts:[2m46:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(00000000-0000-0000-0000-000000000098) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w41_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[106/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould prevent inviting existing members
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould verify email matches invite
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mgetPendingInvitesForUser[2m > [22mshould return pending invites for user email
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mgetPendingInvitesForUser[2m > [22mshould not return expired invites
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mgetPendingInvitesForUser[2m > [22mshould not return accepted invites
[31m[1mError[22m: User must belong to a tenant to create organizations[39m
[36m [2m‚ùØ[22m OrganizationService.createOrganization server/services/OrganizationService.ts:[2m49:13[22m[39m
    [90m 47| [39m
    [90m 48| [39m    [35mif[39m ([33m![39muser[33m?.[39mtenantId) {
    [90m 49| [39m      throw new Error('User must belong to a tenant to create organiza‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m 50| [39m    }
    [90m 51| [39m
[90m [2m‚ùØ[22m tests/integration/organizationInvites.test.ts:[2m53:21[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[107/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould convert placeholder user to real user on accept
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould reject already accepted invite
[31m[1mError[22m: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values (default, $1, default, default, default, default, $2, $3, default, default) returning "id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at"
params: Invite Test Org,00000000-0000-0000-0000-000000000098,00000000-0000-0000-0000-000000000021[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m server/services/OrganizationService.ts:[2m54:21[22m[39m
    [90m 52| [39m    [35mreturn[39m db[33m.[39m[34mtransaction[39m([35masync[39m (tx) [33m=>[39m {
    [90m 53| [39m      [90m// Create organization with tenant scoping[39m
    [90m 54| [39m      [35mconst[39m [org] [33m=[39m [35mawait[39m tx
    [90m   | [39m                    [31m^[39m
    [90m 55| [39m        [33m.[39m[34minsert[39m(organizations)
    [90m 56| [39m        [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/organizationInvites.test.ts:[2m53:21[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m server/services/OrganizationService.ts:[2m54:21[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/organizationInvites.test.ts:[2m53:21[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 347, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(00000000-0000-0000-0000-000000000098) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w28_v3', table: 'organizations', dataType: undefined, constraint: 'organizations_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[108/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-workflow.test.ts[2m > [22mOrganization Workflow Integration Tests[2m > [22mComplete Organization Workflow[2m > [22mStep 1: Create organization
[31m[1mError[22m: User must belong to a tenant to create organizations[39m
[36m [2m‚ùØ[22m OrganizationService.createOrganization server/services/OrganizationService.ts:[2m49:13[22m[39m
    [90m 47| [39m
    [90m 48| [39m    [35mif[39m ([33m![39muser[33m?.[39mtenantId) {
    [90m 49| [39m      throw new Error('User must belong to a tenant to create organiza‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m 50| [39m    }
    [90m 51| [39m
[90m [2m‚ùØ[22m tests/integration/organizations-workflow.test.ts:[2m92:19[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[109/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-workflow.test.ts[2m > [22mOrganization Workflow Integration Tests[2m > [22mComplete Organization Workflow[2m > [22mStep 2: Invite member via email
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2m‚ùØ[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2m‚ùØ[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m438:5[22m[39m
[90m [2m‚ùØ[22m tests/integration/organizations-workflow.test.ts:[2m117:22[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[110/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-workflow.test.ts[2m > [22mOrganization Workflow Integration Tests[2m > [22mComplete Organization Workflow[2m > [22mStep 3: Accept invite
[31m[1mError[22m: Invite not found[39m
[36m [2m‚ùØ[22m OrganizationService.acceptInvite server/services/OrganizationService.ts:[2m702:13[22m[39m
    [90m700| [39m
    [90m701| [39m    [35mif[39m ([33m![39minvite) {
    [90m702| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m'Invite not found'[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m703| [39m    }
    [90m704| [39m
[90m [2m‚ùØ[22m tests/integration/organizations-workflow.test.ts:[2m141:22[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[111/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-workflow.test.ts[2m > [22mOrganization Workflow Integration Tests[2m > [22mComplete Organization Workflow[2m > [22mStep 4: Create workflow owned by user
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, default, default, default, default, default, default, default, default, $5, $6, $7, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow for Transfer,Will be transferred to org,55b2f859-0c36-4bdf-8cd2-73b77f6cfd3f,55b2f859-0c36-4bdf-8cd2-73b77f6cfd3f,draft,user,55b2f859-0c36-4bdf-8cd2-73b77f6cfd3f[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m WorkflowRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
    [90m 88| [39m    [35mconst[39m database [33m=[39m [35mthis[39m[33m.[39m[34mgetDb[39m(tx)[33m;[39m
    [90m 89| [39m
    [90m 90| [39m    [35mconst[39m [record] [33m=[39m [35mawait[39m database
    [90m   | [39m                     [31m^[39m
    [90m 91| [39m      [33m.[39m[34minsert[39m([35mthis[39m[33m.[39mtable [35mas[39m any)
    [90m 92| [39m      [33m.[39m[34mvalues[39m(data [35mas[39m any)
[90m [2m‚ùØ[22m WorkflowRepository.create server/repositories/WorkflowRepository.ts:[2m25:22[22m[39m
[90m [2m‚ùØ[22m server/services/WorkflowService.ts:[2m173:24[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/organizations-workflow.test.ts:[2m167:24[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m WorkflowRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
[90m [2m‚ùØ[22m WorkflowRepository.create server/repositories/WorkflowRepository.ts:[2m25:22[22m[39m
[90m [2m‚ùØ[22m server/services/WorkflowService.ts:[2m173:24[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/organizations-workflow.test.ts:[2m167:24[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 327, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(55b2f859-0c36-4bdf-8cd2-73b77f6cfd3f) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[112/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-workflow.test.ts[2m > [22mOrganization Workflow Integration Tests[2m > [22mComplete Organization Workflow[2m > [22mStep 5: Transfer workflow to organization
[31m[1mError[22m: Workflow not found[39m
[36m [2m‚ùØ[22m WorkflowService.verifyAccess server/services/WorkflowService.ts:[2m132:13[22m[39m
    [90m130| [39m
    [90m131| [39m    [35mif[39m ([33m![39mworkflow) {
    [90m132| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Workflow not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m133| [39m    }
    [90m134| [39m
[90m [2m‚ùØ[22m WorkflowService.transferOwnership server/services/WorkflowService.ts:[2m855:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/organizations-workflow.test.ts:[2m185:27[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[113/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-workflow.test.ts[2m > [22mOrganization Workflow Integration Tests[2m > [22mComplete Organization Workflow[2m > [22mStep 6: Org member (user2) can access workflow
[31m[1mError[22m: Workflow not found[39m
[36m [2m‚ùØ[22m WorkflowService.verifyAccess server/services/WorkflowService.ts:[2m132:13[22m[39m
    [90m130| [39m
    [90m131| [39m    [35mif[39m ([33m![39mworkflow) {
    [90m132| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Workflow not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m133| [39m    }
    [90m134| [39m
[90m [2m‚ùØ[22m WorkflowService.getWorkflowWithDetails server/services/WorkflowService.ts:[2m209:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/organizations-workflow.test.ts:[2m207:24[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[114/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-workflow.test.ts[2m > [22mOrganization Workflow Integration Tests[2m > [22mComplete Organization Workflow[2m > [22mStep 7: Org member (user2) can update workflow
[31m[1mError[22m: Workflow not found[39m
[36m [2m‚ùØ[22m WorkflowService.verifyAccess server/services/WorkflowService.ts:[2m132:13[22m[39m
    [90m130| [39m
    [90m131| [39m    [35mif[39m ([33m![39mworkflow) {
    [90m132| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Workflow not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m133| [39m    }
    [90m134| [39m
[90m [2m‚ùØ[22m WorkflowService.updateWorkflow server/services/WorkflowService.ts:[2m286:5[22m[39m
[90m [2m‚ùØ[22m tests/integration/organizations-workflow.test.ts:[2m219:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[115/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-workflow.test.ts[2m > [22mOrganization Workflow Integration Tests[2m > [22mComplete Organization Workflow[2m > [22mStep 8: Org admin (user1) can still access workflow after transfer
[31m[1mError[22m: Workflow not found[39m
[36m [2m‚ùØ[22m WorkflowService.verifyAccess server/services/WorkflowService.ts:[2m132:13[22m[39m
    [90m130| [39m
    [90m131| [39m    [35mif[39m ([33m![39mworkflow) {
    [90m132| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Workflow not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m133| [39m    }
    [90m134| [39m
[90m [2m‚ùØ[22m WorkflowService.getWorkflowWithDetails server/services/WorkflowService.ts:[2m209:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/organizations-workflow.test.ts:[2m233:24[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[116/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-workflow.test.ts[2m > [22mOrganization Workflow Integration Tests[2m > [22mComplete Organization Workflow[2m > [22mStep 12: Org member can see workflow in list
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- true[39m
[31m+ false[39m

[36m [2m‚ùØ[22m tests/integration/organizations-workflow.test.ts:[2m274:62[22m[39m
    [90m272| [39m
    [90m273| [39m      [34mexpect[39m(workflows)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m274| [39m      expect(workflows.some((w) => w.id === testWorkflowId)).toBe(true‚Ä¶
    [90m   | [39m                                                             [31m^[39m
    [90m275| [39m    })[33m;[39m
    [90m276| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[117/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-workflow.test.ts[2m > [22mOrganization Workflow Integration Tests[2m > [22mComplete Organization Workflow[2m > [22mStep 14: Remove member from org
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2m‚ùØ[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2m‚ùØ[22m OrganizationService.removeMember server/services/OrganizationService.ts:[2m312:5[22m[39m
[90m [2m‚ùØ[22m tests/integration/organizations-workflow.test.ts:[2m285:7[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[118/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-workflow.test.ts[2m > [22mOrganization Workflow Integration Tests[2m > [22mComplete Organization Workflow[2m > [22mStep 16: Re-add member and verify access restored
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2m‚ùØ[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2m‚ùØ[22m OrganizationService.addMember server/services/OrganizationService.ts:[2m410:5[22m[39m
[90m [2m‚ùØ[22m tests/integration/organizations-workflow.test.ts:[2m307:7[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[119/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-workflow.test.ts[2m > [22mOrganization Workflow Integration Tests[2m > [22mEdge Cases and Security[2m > [22mCannot invite same email twice (pending invite exists)
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2m‚ùØ[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2m‚ùØ[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m438:5[22m[39m
[90m [2m‚ùØ[22m tests/integration/organizations-workflow.test.ts:[2m323:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[120/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-workflow.test.ts[2m > [22mOrganization Workflow Integration Tests[2m > [22mEdge Cases and Security[2m > [22mCannot accept expired invite
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2m‚ùØ[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2m‚ùØ[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m438:5[22m[39m
[90m [2m‚ùØ[22m tests/integration/organizations-workflow.test.ts:[2m348:22[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[121/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-workflow.test.ts[2m > [22mOrganization Workflow Integration Tests[2m > [22mEdge Cases and Security[2m > [22mCannot transfer workflow to org user is not a member of
[31m[1mError[22m: User must belong to a tenant to create organizations[39m
[36m [2m‚ùØ[22m OrganizationService.createOrganization server/services/OrganizationService.ts:[2m49:13[22m[39m
    [90m 47| [39m
    [90m 48| [39m    [35mif[39m ([33m![39muser[33m?.[39mtenantId) {
    [90m 49| [39m      throw new Error('User must belong to a tenant to create organiza‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m 50| [39m    }
    [90m 51| [39m
[90m [2m‚ùØ[22m tests/integration/organizations-workflow.test.ts:[2m373:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[122/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mcreateOrganization[2m > [22mshould create organization and auto-create admin membership
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,ec4c032c-7613-4e78-a62b-2bae3151b58a,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,ec4c032c-7613-4e78-a62b-2bae3151b58a,ec4c032c-7613-4e78-a62b-2bae3151b58a[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee s‚Ä¶
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNam‚Ä¶
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNam‚Ä¶

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(ec4c032c-7613-4e78-a62b-2bae3151b58a) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w85_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[123/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mgetUserOrganizations[2m > [22mshould return all organizations for user
[31m[1mAssertionError[22m: expected 0 to be greater than 0[39m
[36m [2m‚ùØ[22m tests/integration/organizationService.test.ts:[2m108:37[22m[39m
    [90m106| [39m            const userOrgs = await organizationService.getUserOrganiza‚Ä¶
    [90m107| [39m
    [90m108| [39m            [34mexpect[39m(userOrgs[33m.[39mlength)[33m.[39m[34mtoBeGreaterThan[39m([34m0[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m109| [39m            [35mconst[39m foundOrg [33m=[39m userOrgs[33m.[39m[34mfind[39m(o [33m=>[39m o[33m.[39mid [33m===[39m org[33m.[39mid)[33m;[39m
    [90m110| [39m            [34mexpect[39m(foundOrg)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[124/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mgetUserOrganizations[2m > [22mshould return empty array for user with no memberships
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,64d0a3aa-de68-42d6-9ca9-64d20d580b2a,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,64d0a3aa-de68-42d6-9ca9-64d20d580b2a,64d0a3aa-de68-42d6-9ca9-64d20d580b2a[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee s‚Ä¶
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNam‚Ä¶
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNam‚Ä¶

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(64d0a3aa-de68-42d6-9ca9-64d20d580b2a) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w81_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[125/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mupdateOrganization[2m > [22mshould allow admin to update organization
[31m[1mError[22m: User must belong to a tenant to create organizations[39m
[36m [2m‚ùØ[22m OrganizationService.createOrganization server/services/OrganizationService.ts:[2m49:13[22m[39m
    [90m 47| [39m
    [90m 48| [39m    [35mif[39m ([33m![39muser[33m?.[39mtenantId) {
    [90m 49| [39m      throw new Error('User must belong to a tenant to create organiza‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m 50| [39m    }
    [90m 51| [39m
[90m [2m‚ùØ[22m tests/integration/organizationService.test.ts:[2m122:25[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[126/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mupdateOrganization[2m > [22mshould deny non-admin from updating organization
[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mdemoteMember[2m > [22mshould prevent self-demotion
[31m[1mError[22m: Test setup failed: User 00000000-0000-0000-0000-000000000011 missing tenantId[39m
[36m [2m‚ùØ[22m tests/integration/organizationService.test.ts:[2m54:19[22m[39m
    [90m 52| [39m        [35mif[39m ([33m![39muserCheck[33m?.[39mtenantId) {
    [90m 53| [39m            console.error('CRITICAL: User lookup failed validation in ‚Ä¶
    [90m 54| [39m            throw new Error(`Test setup failed: User ${testUserId1} mi‚Ä¶
    [90m   | [39m                  [31m^[39m
    [90m 55| [39m        }
    [90m 56| [39m    })[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[127/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mpromoteMember[2m > [22mshould allow admin to promote member
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2m‚ùØ[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2m‚ùØ[22m OrganizationService.addMember server/services/OrganizationService.ts:[2m410:5[22m[39m
[90m [2m‚ùØ[22m tests/integration/organizationService.test.ts:[2m185:13[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[128/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mdemoteMember[2m > [22mshould allow admin to demote other admin
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,edc1cac9-eda3-49f9-af69-5e969a3a09c6,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,edc1cac9-eda3-49f9-af69-5e969a3a09c6,edc1cac9-eda3-49f9-af69-5e969a3a09c6[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee s‚Ä¶
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNam‚Ä¶
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNam‚Ä¶

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(edc1cac9-eda3-49f9-af69-5e969a3a09c6) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w102_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[129/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mremoveMember[2m > [22mshould allow admin to remove member
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,fbe5c088-3443-4ccc-91be-a012db2ff288,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,fbe5c088-3443-4ccc-91be-a012db2ff288,fbe5c088-3443-4ccc-91be-a012db2ff288[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee s‚Ä¶
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNam‚Ä¶
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNam‚Ä¶

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(fbe5c088-3443-4ccc-91be-a012db2ff288) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w121_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[130/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mremoveMember[2m > [22mshould prevent self-removal
[31m[1mError[22m: User must belong to a tenant to create organizations[39m
[36m [2m‚ùØ[22m OrganizationService.createOrganization server/services/OrganizationService.ts:[2m49:13[22m[39m
    [90m 47| [39m
    [90m 48| [39m    [35mif[39m ([33m![39muser[33m?.[39mtenantId) {
    [90m 49| [39m      throw new Error('User must belong to a tenant to create organiza‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m 50| [39m    }
    [90m 51| [39m
[90m [2m‚ùØ[22m tests/integration/organizationService.test.ts:[2m243:25[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[131/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mleaveOrganization[2m > [22mshould allow member to leave organization
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2m‚ùØ[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2m‚ùØ[22m OrganizationService.addMember server/services/OrganizationService.ts:[2m410:5[22m[39m
[90m [2m‚ùØ[22m tests/integration/organizationService.test.ts:[2m263:13[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[132/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mleaveOrganization[2m > [22mshould allow admin to leave organization
[31m[1mError[22m: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 69c5ded2-4567-4b93-b172-9c4178f269b4,00000000-0000-0000-0000-000000000012,admin[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m OrganizationService.addMember server/services/OrganizationService.ts:[2m420:5[22m[39m
    [90m418| [39m
    [90m419| [39m    [90m// Add membership[39m
    [90m420| [39m    [35mawait[39m db[33m.[39m[34minsert[39m(organizationMemberships)[33m.[39m[34mvalues[39m({
    [90m   | [39m    [31m^[39m
    [90m421| [39m      orgId[33m,[39m
    [90m422| [39m      userId[33m:[39m targetUserId[33m,[39m
[90m [2m‚ùØ[22m tests/integration/organizationService.test.ts:[2m279:13[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_org_id_organizations_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m OrganizationService.addMember server/services/OrganizationService.ts:[2m420:5[22m[39m
[90m [2m‚ùØ[22m tests/integration/organizationService.test.ts:[2m279:13[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 401, severity: 'ERROR', code: '23503', detail: 'Key (org_id)=(69c5ded2-4567-4b93-b172-9c4178f269b4) is not present in table "organizations".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w126_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_org_id_organizations_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[133/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mcanAccessAsset[2m > [22mshould allow access to org-owned asset by org member
[31m[1mError[22m: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 10000000-0000-0000-0000-000000000001,00000000-0000-0000-0000-000000000001,member[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/ownershipAccess.test.ts:[2m80:7[22m[39m
    [90m 78| [39m    it('should allow access to org-owned asset by org member', async (‚Ä¶
    [90m 79| [39m      [90m// Create membership[39m
    [90m 80| [39m      [35mawait[39m db[33m.[39m[34minsert[39m(organizationMemberships)[33m.[39m[34mvalues[39m({
    [90m   | [39m      [31m^[39m
    [90m 81| [39m        orgId[33m:[39m orgId1[33m,[39m
    [90m 82| [39m        userId[33m:[39m userId1[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_org_id_organizations_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/ownershipAccess.test.ts:[2m80:7[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 400, severity: 'ERROR', code: '23503', detail: 'Key (org_id)=(10000000-0000-0000-0000-000000000001) is not present in table "organizations".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w70_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_org_id_organizations_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[134/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22misOrgMember[2m > [22mshould return true for org member
[31m[1mError[22m: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 10000000-0000-0000-0000-000000000001,00000000-0000-0000-0000-000000000001,member[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/ownershipAccess.test.ts:[2m103:7[22m[39m
    [90m101| [39m  [34mdescribe[39m([32m'isOrgMember'[39m[33m,[39m () [33m=>[39m {
    [90m102| [39m    [34mit[39m([32m'should return true for org member'[39m[33m,[39m [35masync[39m () [33m=>[39m {
    [90m103| [39m      [35mawait[39m db[33m.[39m[34minsert[39m(organizationMemberships)[33m.[39m[34mvalues[39m({
    [90m   | [39m      [31m^[39m
    [90m104| [39m        orgId[33m:[39m orgId1[33m,[39m
    [90m105| [39m        userId[33m:[39m userId1[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/ownershipAccess.test.ts:[2m103:7[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 379, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(00000000-0000-0000-0000-000000000001) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w67_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[135/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22misOrgMember[2m > [22mshould return true for org admin
[31m[1mError[22m: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 10000000-0000-0000-0000-000000000001,00000000-0000-0000-0000-000000000001,admin[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/ownershipAccess.test.ts:[2m119:7[22m[39m
    [90m117| [39m
    [90m118| [39m    [34mit[39m([32m'should return true for org admin'[39m[33m,[39m [35masync[39m () [33m=>[39m {
    [90m119| [39m      [35mawait[39m db[33m.[39m[34minsert[39m(organizationMemberships)[33m.[39m[34mvalues[39m({
    [90m   | [39m      [31m^[39m
    [90m120| [39m        orgId[33m:[39m orgId1[33m,[39m
    [90m121| [39m        userId[33m:[39m userId1[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_org_id_organizations_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/ownershipAccess.test.ts:[2m119:7[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 400, severity: 'ERROR', code: '23503', detail: 'Key (org_id)=(10000000-0000-0000-0000-000000000001) is not present in table "organizations".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w80_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_org_id_organizations_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[136/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mcanManageOrg[2m > [22mshould return true for org admin
[31m[1mError[22m: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 10000000-0000-0000-0000-000000000001,00000000-0000-0000-0000-000000000001,admin[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/ownershipAccess.test.ts:[2m132:7[22m[39m
    [90m130| [39m  [34mdescribe[39m([32m'canManageOrg'[39m[33m,[39m () [33m=>[39m {
    [90m131| [39m    [34mit[39m([32m'should return true for org admin'[39m[33m,[39m [35masync[39m () [33m=>[39m {
    [90m132| [39m      [35mawait[39m db[33m.[39m[34minsert[39m(organizationMemberships)[33m.[39m[34mvalues[39m({
    [90m   | [39m      [31m^[39m
    [90m133| [39m        orgId[33m:[39m orgId1[33m,[39m
    [90m134| [39m        userId[33m:[39m userId1[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_org_id_organizations_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/ownershipAccess.test.ts:[2m132:7[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 400, severity: 'ERROR', code: '23503', detail: 'Key (org_id)=(10000000-0000-0000-0000-000000000001) is not present in table "organizations".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w80_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_org_id_organizations_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[137/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mcanCreateWithOwnership[2m > [22mshould allow creating org-owned asset if user is member
[31m[1mError[22m: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 10000000-0000-0000-0000-000000000001,00000000-0000-0000-0000-000000000001,member[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/ownershipAccess.test.ts:[2m190:7[22m[39m
    [90m188| [39m
    [90m189| [39m    it('should allow creating org-owned asset if user is member', asyn‚Ä¶
    [90m190| [39m      [35mawait[39m db[33m.[39m[34minsert[39m(organizationMemberships)[33m.[39m[34mvalues[39m({
    [90m   | [39m      [31m^[39m
    [90m191| [39m        orgId[33m:[39m orgId1[33m,[39m
    [90m192| [39m        userId[33m:[39m userId1[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_org_id_organizations_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/ownershipAccess.test.ts:[2m190:7[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 400, severity: 'ERROR', code: '23503', detail: 'Key (org_id)=(10000000-0000-0000-0000-000000000001) is not present in table "organizations".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w89_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_org_id_organizations_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[138/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mCross-org Access Control[2m > [22mshould not allow member of org1 to access org2-owned assets
[31m[1mError[22m: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 10000000-0000-0000-0000-000000000001,00000000-0000-0000-0000-000000000001,member[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/ownershipAccess.test.ts:[2m208:7[22m[39m
    [90m206| [39m  [34mdescribe[39m([32m'Cross-org Access Control'[39m[33m,[39m () [33m=>[39m {
    [90m207| [39m    it('should not allow member of org1 to access org2-owned assets', ‚Ä¶
    [90m208| [39m      [35mawait[39m db[33m.[39m[34minsert[39m(organizationMemberships)[33m.[39m[34mvalues[39m({
    [90m   | [39m      [31m^[39m
    [90m209| [39m        orgId[33m:[39m orgId1[33m,[39m
    [90m210| [39m        userId[33m:[39m userId1[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_org_id_organizations_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/ownershipAccess.test.ts:[2m208:7[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 400, severity: 'ERROR', code: '23503', detail: 'Key (org_id)=(10000000-0000-0000-0000-000000000001) is not present in table "organizations".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w85_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_org_id_organizations_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[139/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould list all active sessions for current user
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m78:30[22m[39m
    [90m 76| [39m      [35mconst[39m token [33m=[39m session3[33m.[39mbody[33m.[39mtoken[33m;[39m
    [90m 77| [39m      const cookies = (session3.headers as any)["set-cookie"] as strin‚Ä¶
    [90m 78| [39m      const cookie = cookies.find((c) => c.startsWith("refresh_token="‚Ä¶
    [90m   | [39m                             [31m^[39m
    [90m 79| [39m
    [90m 80| [39m      [90m// List sessions[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[140/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould mark current session correctly
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m119:30[22m[39m
    [90m117| [39m      [35mconst[39m token [33m=[39m login2[33m.[39mbody[33m.[39mtoken[33m;[39m
    [90m118| [39m      const cookies = (login2.headers as any)["set-cookie"] as string[‚Ä¶
    [90m119| [39m      const cookie = cookies.find((c) => c.startsWith("refresh_token="‚Ä¶
    [90m   | [39m                             [31m^[39m
    [90m120| [39m
    [90m121| [39m      [90m// List sessions with cookie (should identify current session)[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[141/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould exclude revoked sessions
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'id')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m155:50[22m[39m
    [90m153| [39m        [33m.[39m[34mupdate[39m(refreshTokens)
    [90m154| [39m        [33m.[39m[35mset[39m({ revoked[33m:[39m [35mtrue[39m })
    [90m155| [39m        [33m.[39m[34mwhere[39m([34meq[39m(refreshTokens[33m.[39mid[33m,[39m allTokens[[34m0[39m][33m.[39mid))[33m;[39m
    [90m   | [39m                                                 [31m^[39m
    [90m156| [39m
    [90m157| [39m      [90m// List sessions[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[142/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould order sessions by last used (most recent first)
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 2c4f7ca47403762fc0a3838ffc702494,$2b$12$4/q5b/jqHljtowBf680f3eWeBQ0MwKcD.oBCiF6cZv4TT7Z.2wLMG,2026-01-18T05:55:00.340Z,2026-01-18T05:55:00.340Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m167:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m167:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(2c4f7ca47403762fc0a3838ffc702494) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[143/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould filter sessions by current user only
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'length')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m222:37[22m[39m
    [90m220| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39muser1Login[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m221| [39m
    [90m222| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39msessions[33m.[39mlength)[33m.[39m[34mtoBe[39m([34m2[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m223| [39m    })[33m;[39m
    [90m224| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[144/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould revoke specific session
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 4fd676da8830fd25273d57334506f147,$2b$12$AcjKUmNpZNgpOo55Gx5wKOiJOfAodzJrTJ3UTS2kORF.b97JYTO5S,2026-01-18T05:55:03.467Z,2026-01-18T05:55:03.467Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m234:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m234:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(4fd676da8830fd25273d57334506f147) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w24_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[145/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould prevent revoking current session
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 47036243a54c6020d90c10495850e842,$2b$12$8X1pFlWcduY5r/GxC1CxvuJA4nPVQOkdeTR394UXSNRxzuDbh.zlG,2026-01-18T05:55:04.147Z,2026-01-18T05:55:04.147Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m280:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m280:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(47036243a54c6020d90c10495850e842) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[146/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould return 404 for non-existent session
[31m[1mAssertionError[22m: expected 401 to be 404 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 404[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m323:31[22m[39m
    [90m321| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mlogin[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m322| [39m
    [90m323| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m404[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m324| [39m    })[33m;[39m
    [90m325| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[147/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould prevent revoking other user's session
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: df8dd5f713d31b2ead0251a30c71651e,$2b$12$k6urGAC0KgT2UKf4GQXqgeOZ5jXvumvKOJ.W8L8b0kvYbQhdo0RdG,2026-01-18T05:55:06.070Z,2026-01-18T05:55:06.070Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m327:21[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m327:21[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(df8dd5f713d31b2ead0251a30c71651e) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w22_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[148/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould revoke all other sessions
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 21419677902c8caca7e3ad04922a03ea,$2b$12$RB2CAWnZjRPljDgTyiIsteFi6yBwuA3IhuEjrcDG896aFiA1qfi0i,2026-01-18T05:55:06.768Z,2026-01-18T05:55:06.768Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m360:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m360:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(21419677902c8caca7e3ad04922a03ea) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[149/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould keep current session active
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m406:30[22m[39m
    [90m404| [39m      [35mconst[39m token [33m=[39m currentLogin[33m.[39mbody[33m.[39mtoken[33m;[39m
    [90m405| [39m      const cookies = (currentLogin.headers as any)["set-cookie"] as s‚Ä¶
    [90m406| [39m      const cookie = cookies.find((c) => c.startsWith("refresh_token="‚Ä¶
    [90m   | [39m                             [31m^[39m
    [90m407| [39m
    [90m408| [39m      [90m// Revoke all others[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[150/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould return 400 if no active session found
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: e631fe6e1b09466a8146b274c4d64122,$2b$12$nGzgywJfebFkqbt6sj.9luVlm.wkNbbBQycn3PsUoDpl9Y7i6zGBm,2026-01-18T05:55:08.716Z,2026-01-18T05:55:08.716Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m430:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m430:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(e631fe6e1b09466a8146b274c4d64122) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w26_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[151/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould revoke all trusted devices
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m458:30[22m[39m
    [90m456| [39m      [35mconst[39m token [33m=[39m login[33m.[39mbody[33m.[39mtoken[33m;[39m
    [90m457| [39m      [35mconst[39m cookies [33m=[39m (login[33m.[39mheaders [35mas[39m any)[[32m"set-cookie"[39m] [35mas[39m string[][33m;[39m
    [90m458| [39m      const cookie = cookies.find((c) => c.startsWith("refresh_token="‚Ä¶
    [90m   | [39m                             [31m^[39m
    [90m459| [39m
    [90m460| [39m      [90m// Trust a device[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[152/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould handle user with single session gracefully
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: a9ab9555ae2344fa4850c5739140bef1,$2b$12$K6AaTwUJfC0ighWxgnLqyOqlW5q.F3x1tE/Crdz7wj/kwFZwEv8cC,2026-01-18T05:55:10.679Z,2026-01-18T05:55:10.679Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m481:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m481:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(a9ab9555ae2344fa4850c5739140bef1) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w26_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[153/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mSession Security[2m > [22mshould include device metadata in sessions
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 78b24094b6bec21808532dd289aefd18,$2b$12$lftpNR4ab9zzRTs7wjpNL.PvyyMuR/Z/F5QPu/p1tRA7TkUCotLqW,2026-01-18T05:55:11.330Z,2026-01-18T05:55:11.330Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m511:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m511:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(78b24094b6bec21808532dd289aefd18) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w28_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[154/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mSession Security[2m > [22mshould not expose sensitive token data
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 9a34b3f07c07cfd6b79f45bb56135101,$2b$12$/U7c5TPmnT3bqpgz.DRaleV9hNfLNDDAiHu.sovF4rO0.GgtN39Sm,2026-01-18T05:55:12.004Z,2026-01-18T05:55:12.004Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m533:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m533:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(9a34b3f07c07cfd6b79f45bb56135101) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w45_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[155/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mSession Security[2m > [22mshould track session activity timestamps
[31m[1mTypeError[22m: Cannot read properties of undefined (reading '0')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m563:37[22m[39m
    [90m561| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mlogin[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m562| [39m
    [90m563| [39m      [35mconst[39m session [33m=[39m response[33m.[39mbody[33m.[39msessions[[34m0[39m][33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m564| [39m
    [90m565| [39m      [34mexpect[39m(session[33m.[39mcreatedAt)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[156/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mProject Transfer[2m > [22mshould transfer user-owned project to org
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mWorkflow Transfer[2m > [22mshould detach workflow from project when transferring to different owner
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mDatabase Transfer[2m > [22mshould allow org member to transfer org database
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mTransfer Validation[2m > [22mshould only allow transfer to self when targetOwnerType is user
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mTransfer Validation[2m > [22mshould allow transfer from user to self (org member transferring org asset to themselves)
[31m[1mError[22m: User must belong to a tenant to create organizations[39m
[36m [2m‚ùØ[22m OrganizationService.createOrganization server/services/OrganizationService.ts:[2m49:13[22m[39m
    [90m 47| [39m
    [90m 48| [39m    [35mif[39m ([33m![39muser[33m?.[39mtenantId) {
    [90m 49| [39m      throw new Error('User must belong to a tenant to create organiza‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m 50| [39m    }
    [90m 51| [39m
[90m [2m‚ùØ[22m tests/integration/transferOwnership.test.ts:[2m57:21[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[157/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mProject Transfer[2m > [22mshould prevent transfer to org if user is not a member
[31m[1mError[22m: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: ad2ee784-104e-4881-a936-e5f68b8b12f7,00000000-0000-0000-0000-000000000032,member[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m OrganizationService.addMember server/services/OrganizationService.ts:[2m420:5[22m[39m
    [90m418| [39m
    [90m419| [39m    [90m// Add membership[39m
    [90m420| [39m    [35mawait[39m db[33m.[39m[34minsert[39m(organizationMemberships)[33m.[39m[34mvalues[39m({
    [90m   | [39m    [31m^[39m
    [90m421| [39m      orgId[33m,[39m
    [90m422| [39m      userId[33m:[39m targetUserId[33m,[39m
[90m [2m‚ùØ[22m tests/integration/transferOwnership.test.ts:[2m64:9[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_org_id_organizations_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m OrganizationService.addMember server/services/OrganizationService.ts:[2m420:5[22m[39m
[90m [2m‚ùØ[22m tests/integration/transferOwnership.test.ts:[2m64:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 400, severity: 'ERROR', code: '23503', detail: 'Key (org_id)=(ad2ee784-104e-4881-a936-e5f68b8b12f7) is not present in table "organizations".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w93_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_org_id_organizations_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[158/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mProject Transfer[2m > [22mshould allow org member to transfer org-owned project to another org they belong to
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mWorkflow Transfer[2m > [22mshould prevent non-member from transferring org workflow
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2m‚ùØ[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2m‚ùØ[22m OrganizationService.addMember server/services/OrganizationService.ts:[2m410:5[22m[39m
[90m [2m‚ùØ[22m tests/integration/transferOwnership.test.ts:[2m64:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[159/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mWorkflow Transfer[2m > [22mshould keep workflow in project when transferring to same owner
[31m[1mError[22m: Access denied: You do not have permission to create assets with this ownership[39m
[36m [2m‚ùØ[22m ProjectService.createProject server/services/ProjectService.ts:[2m65:13[22m[39m
    [90m 63| [39m    const canCreate = await canCreateWithOwnership(creatorId, ownerTyp‚Ä¶
    [90m 64| [39m    [35mif[39m ([33m![39mcanCreate) {
    [90m 65| [39m      throw new Error('Access denied: You do not have permission to cr‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m 66| [39m    }
    [90m 67| [39m
[90m [2m‚ùØ[22m tests/integration/transferOwnership.test.ts:[2m208:29[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[160/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mDatabase Transfer[2m > [22mshould transfer database ownership
[31m[1mError[22m: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values (default, $1, default, default, default, default, $2, $3, default, default) returning "id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at"
params: Transfer Test Org,00000000-0000-0000-0000-000000000099,00000000-0000-0000-0000-000000000031[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m server/services/OrganizationService.ts:[2m54:21[22m[39m
    [90m 52| [39m    [35mreturn[39m db[33m.[39m[34mtransaction[39m([35masync[39m (tx) [33m=>[39m {
    [90m 53| [39m      [90m// Create organization with tenant scoping[39m
    [90m 54| [39m      [35mconst[39m [org] [33m=[39m [35mawait[39m tx
    [90m   | [39m                    [31m^[39m
    [90m 55| [39m        [33m.[39m[34minsert[39m(organizations)
    [90m 56| [39m        [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/transferOwnership.test.ts:[2m57:21[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m server/services/OrganizationService.ts:[2m54:21[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/transferOwnership.test.ts:[2m57:21[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 347, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(00000000-0000-0000-0000-000000000099) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w95_v3', table: 'organizations', dataType: undefined, constraint: 'organizations_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[161/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mDatabase Transfer[2m > [22mshould prevent transfer to org if user is not a member
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000031,transfer1@test.com,Transfer User 1,00000000-0000-0000-0000-000000000099,00000000-0000-0000-0000-000000000032,transfer2@test.com,Transfer User 2,00000000-0000-0000-0000-000000000099,00000000-0000-0000-0000-000000000099[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/transferOwnership.test.ts:[2m48:9[22m[39m
    [90m 46| [39m
    [90m 47| [39m        [90m// Create test users[39m
    [90m 48| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 49| [39m            { id: userId1, email: 'transfer1@test.com', fullName: 'Tra‚Ä¶
    [90m 50| [39m            { id: userId2, email: 'transfer2@test.com', fullName: 'Tra‚Ä¶

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/transferOwnership.test.ts:[2m48:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(00000000-0000-0000-0000-000000000099) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w102_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[162/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mPOST /api/auth/trust-device[2m > [22mshould trust current device
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: d04f50bf3d777f40e72f6369fe4fd7b4,$2b$12$IJ5kEAqmSMWNFVL1T/qrWuTInEpfGaM4kyNZZRAdY7dYG9goedK4q,2026-01-18T05:54:55.893Z,2026-01-18T05:54:55.893Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m58:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m58:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(d04f50bf3d777f40e72f6369fe4fd7b4) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[163/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mPOST /api/auth/trust-device[2m > [22mshould set trust expiry to 30 days
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 0ad80625847a49864f5035aa1dd559aa,MY4HUUSQLU7CS3LMJYZWOZCDEY3CGSCDNZFSIYK2KRIVOPZJOVSQ,true,2026-01-18T05:54:56.699Z,2026-01-18T05:54:56.699Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m97:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m97:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(0ad80625847a49864f5035aa1dd559aa) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[164/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mPOST /api/auth/trust-device[2m > [22mshould update expiry if device already trusted
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 71997acb93277d9ca8323f8881bf56db,KUYSUJLEPJFW4V3LKU3SYRJYIR4D62CYJF5EIMCBHB4VON2ROBMA,true,2026-01-18T05:54:57.543Z,2026-01-18T05:54:57.543Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m124:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m124:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 322, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(71997acb93277d9ca8323f8881bf56db) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[165/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould list all trusted devices
[31m[1mError[22m: Failed query: insert into "mfa_backup_codes" ("id", "user_id", "code_hash", "used", "used_at", "created_at") values (default, $1, $2, $3, default, $4), (default, $5, $6, $7, default, $8), (default, $9, $10, $11, default, $12), (default, $13, $14, $15, default, $16), (default, $17, $18, $19, default, $20), (default, $21, $22, $23, default, $24), (default, $25, $26, $27, default, $28), (default, $29, $30, $31, default, $32), (default, $33, $34, $35, default, $36), (default, $37, $38, $39, default, $40)
params: 47bd7aab75346b7e78229949aa05a183,$2b$10$UrrMRfjvgKIPx460TS1dg.jLwEU/TpS9ehxd0wnCQF9eWR0exyLQy,false,2026-01-18T05:54:58.609Z,47bd7aab75346b7e78229949aa05a183,$2b$10$EEicDNavQCaXa.YmFTv8U.MJDERZ9D.gLARoTSnYeAncHrS2WKhee,false,2026-01-18T05:54:58.608Z,47bd7aab75346b7e78229949aa05a183,$2b$10$wLCVt29dA4V/3JvqGrqmv.RlUzrkFHFfrmy0RIswdTBXj.oVsR/SO,false,2026-01-18T05:54:58.607Z,47bd7aab75346b7e78229949aa05a183,$2b$10$RwLnUUO0fEKQX/pz7HHRwuu1ZStGxBk7dguSmcDmBC5k.HJHiOFrC,false,2026-01-18T05:54:58.614Z,47bd7aab75346b7e78229949aa05a183,$2b$10$VCQ2lo2lGYJjXI227mBx1uwP7blRFrqHVP5cV7Em5g5EghmwI3M1m,false,2026-01-18T05:54:58.692Z,47bd7aab75346b7e78229949aa05a183,$2b$10$WOAXDbKMP9nzxqIfn.WXYOPTF5hAru.gezcDzGAr9oqfSmrS0kbtK,false,2026-01-18T05:54:58.680Z,47bd7aab75346b7e78229949aa05a183,$2b$10$RZlDusKHBnnH9PWbnIURhuZmULUeLlh8715cMq/R/UFvP0YHohtYq,false,2026-01-18T05:54:58.692Z,47bd7aab75346b7e78229949aa05a183,$2b$10$oy/.KcXYY1pZ59S7hWXQ6e1G6GyFHPchaBZyegLU4wnXHacgAa7pS,false,2026-01-18T05:54:58.692Z,47bd7aab75346b7e78229949aa05a183,$2b$10$SpDmg3njJN6iMOUNYtMGzOvg6eaCSdWehM6SIYr9y0RHiDLzuLHOy,false,2026-01-18T05:54:58.748Z,47bd7aab75346b7e78229949aa05a183,$2b$10$dfdTrCL2azyl7Q7Tky6x3.SeqXjVHoG21FxMuP4sPgeW8xDQoe6tO,false,2026-01-18T05:54:58.752Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m258:3[22m[39m
    [90m256| [39m  )[33m;[39m
    [90m257| [39m
    [90m258| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaBackupCodes)[33m.[39m[34mvalues[39m(hashedCodes)[33m;[39m
    [90m   | [39m  [31m^[39m
    [90m259| [39m
    [90m260| [39m  [35mreturn[39m {
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m183:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_backup_codes" violates foreign key constraint "mfa_backup_codes_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m258:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m183:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(47bd7aab75346b7e78229949aa05a183) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'mfa_backup_codes', dataType: undefined, constraint: 'mfa_backup_codes_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[166/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould mark current device
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 2a032b01dca94c989540649be529be6f,$2b$12$myj/VQ8sh43ODt8atN85dOfcOd6su.0NmFRnz3QbcnDe6phQA9MBm,2026-01-18T05:54:59.460Z,2026-01-18T05:54:59.460Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m240:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m240:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(2a032b01dca94c989540649be529be6f) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[167/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould exclude revoked devices
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 2a2013c5571af9493c2658e0efe7bf47,$2b$12$GL8WnO3q8bIHZCXXatC/wObJWNLZmZK3KLOTUF0skr585H54OJmla,2026-01-18T05:55:00.144Z,2026-01-18T05:55:00.144Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m272:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m272:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(2a2013c5571af9493c2658e0efe7bf47) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[168/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould exclude expired devices
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 40155a28ed07a44e1f1b6b028326a6f2,$2b$12$j/PxV1w9dw0sPNU3CR1K.e5QhhWWS3ISfoyNkiQ2ryWYVVyovkWja,2026-01-18T05:55:00.835Z,2026-01-18T05:55:00.835Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m305:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m305:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(40155a28ed07a44e1f1b6b028326a6f2) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[169/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould revoke specific device
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 26e8419d793750e794bb08d6202b4f03,$2b$12$ucBzLGQjI4F38Nl.5hDcKuUO03CKf7v4/Xa01CPZIb4hJeye2Mh7i,2026-01-18T05:55:01.543Z,2026-01-18T05:55:01.543Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m341:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m341:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(26e8419d793750e794bb08d6202b4f03) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w14_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[170/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould return 404 for non-existent device
[31m[1mError[22m: [TEST UTILS] MFA Secret verification failed for c5bca0861ce00da208ac699cb6a3164b[39m
[36m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m228:22[22m[39m
    [90m226| [39m    where[33m:[39m [34meq[39m(mfaSecrets[33m.[39muserId[33m,[39m userData[33m.[39muserId)
    [90m227| [39m  })[33m;[39m
    [90m228| [39m  if (!check) {throw new Error(`[TEST UTILS] MFA Secret verification f‚Ä¶
    [90m   | [39m                     [31m^[39m
    [90m229| [39m  if (!check.enabled) {throw new Error(`[TEST UTILS] MFA Secret enable‚Ä¶
    [90m230| [39m  console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}‚Ä¶
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m391:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[171/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould prevent revoking other user's device
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 4b0389436c62fa83c469b450e8a3d5bb,J5KGYS2OHZKHUN2TMQZHU3C2NVKEKN2GIFCSUPCFJFNFWUZRKVUA,true,2026-01-18T05:55:02.853Z,2026-01-18T05:55:02.853Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m410:21[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m410:21[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 322, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(4b0389436c62fa83c469b450e8a3d5bb) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[172/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDevice Trust with MFA Login[2m > [22mshould skip MFA for trusted device
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 7d98a6940212e6167088ed542ee2c5a4,LBKXUZRPHYYVW3LFGQTGMUTMJVTVEZRVKNATWUJEFJIWY53UJZEQ,true,2026-01-18T05:55:03.624Z,2026-01-18T05:55:03.624Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m459:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m459:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 322, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(7d98a6940212e6167088ed542ee2c5a4) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[173/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDevice Trust with MFA Login[2m > [22mshould require MFA for untrusted device
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 417d15d6ded0d7bfd11f4e5a618520b2,$2b$12$d6zjaCU/S.9N8zN17tcel..cFupMscgKNIEnArZMne4A4uwto5/4y,2026-01-18T05:55:04.302Z,2026-01-18T05:55:04.302Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m497:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m497:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(417d15d6ded0d7bfd11f4e5a618520b2) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w25_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[174/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDevice Trust with MFA Login[2m > [22mshould update lastUsedAt on trusted device login
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: cd98bece40c1fca0450fb12f8f2dd0c1,$2b$12$.NE1N0HUV/bYqCFnIUFChehQrUjY9ZnwHd6Iki6kEK9yqVjiO9qvy,2026-01-18T05:55:05.023Z,2026-01-18T05:55:05.023Z[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m528:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m528:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(cd98bece40c1fca0450fb12f8f2dd0c1) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[175/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mREPRO: ScriptEngine fails to resolve alias 'input_variable' when aliasMap is NOT provided
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 2beb621b-c705-4664-ade1-81dc39a552ec,Safety Workflow,eda6c4cf-53f6-4ec4-9a44-a779f64e1848,eda6c4cf-53f6-4ec4-9a44-a779f64e1848,ed098e5e-d12d-417e-ab08-c0eb8f2a8f34,259e9d40-c629-482b-b88c-d013dbeda943[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m
    [90m 73| [39m        workflowId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 74| [39m        versionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 75| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(workflowsSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 76| [39m            id[33m:[39m workflowId[33m,[39m
    [90m 77| [39m            projectId[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(eda6c4cf-53f6-4ec4-9a44-a779f64e1848) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w61_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[176/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mScriptEngine resolves alias 'input_variable' when aliasMap is provided
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, $6, default, default, default, default, default, default, default, default)
params: 993112ef-3788-48e8-bf0f-709db42c99c8,safety - 3c2c937f-107e-432d-a043-bedeecfdf332 @example.com,78673761-f505-4602-9a94-8491c80eec4b,admin,owner,local[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m51:9[22m[39m
    [90m 49| [39m
    [90m 50| [39m        userId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 51| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(usersSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 52| [39m            id[33m:[39m userId[33m,[39m
    [90m 53| [39m            email[33m:[39m [32m`safety - [39m[36m${[39m[34muuidv4[39m()[36m}[39m[32m @example.com`[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m51:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(78673761-f505-4602-9a94-8491c80eec4b) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w62_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[177/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mREPRO: BlockRunner fails to resolve alias in CreateRecordConfig
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, $6, default, default, default, default, default, default, default, default)
params: de1bc8ca-43b7-4112-ac5e-a3487cbcacbd,safety - 1b2b4faa-9c72-4324-8c74-70153bcbd7e2 @example.com,0afb4d66-0b7a-4f3b-83d1-9d294f547212,admin,owner,local[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m51:9[22m[39m
    [90m 49| [39m
    [90m 50| [39m        userId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 51| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(usersSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 52| [39m            id[33m:[39m userId[33m,[39m
    [90m 53| [39m            email[33m:[39m [32m`safety - [39m[36m${[39m[34muuidv4[39m()[36m}[39m[32m @example.com`[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m51:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(0afb4d66-0b7a-4f3b-83d1-9d294f547212) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[178/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mBlockRunner logic resolves alias with aliasMap
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, default, $4, $5, $6, $7, default, default, default, default, default, default)
params: f99068d7-61b2-4cb7-ac20-f0f80cdedbd7,Safety Project,Safety Project,6f70a27f-136c-4266-a9a6-bd643c4b8d8c,be53bea0-a098-4caf-ba83-dde96beb2a56,6f70a27f-136c-4266-a9a6-bd643c4b8d8c,6f70a27f-136c-4266-a9a6-bd643c4b8d8c[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m63:9[22m[39m
    [90m 61| [39m        [90m// 2. Setup Project & Workflow[39m
    [90m 62| [39m        projectId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 63| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(projectsSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 64| [39m            id[33m:[39m projectId[33m,[39m
    [90m 65| [39m            name[33m:[39m [32m"Safety Project"[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m63:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(6f70a27f-136c-4266-a9a6-bd643c4b8d8c) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w72_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[179/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/workflow_versioning.test.ts[2m > [22mWorkflow Versioning & Lineage[2m > [22mshould create a version and populate changelog
[31m[1mError[22m: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, default, $1, $2, $3, $4, default, default, default, $5, default, default, default, default)
params: 93f6e9fb-d569-41f0-9371-cc06337c9f72,publish,workflow_version,8f14182e-0a00-4489-bc2c-9bdf75dc73ed,{"notes":"Initial version","checksum":"1a9e59ad8ac8d8ccaa360880d6023a7d8a50e1c8317f85dfc0d66a6313f807e2","versionNumber":1,"validationWarnings":[],"forced":false,"changelog":null}[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m VersionService.publishVersion server/services/VersionService.ts:[2m342:5[22m[39m
    [90m340| [39m
    [90m341| [39m    [90m// Log audit event[39m
    [90m342| [39m    [35mawait[39m db[33m.[39m[34minsert[39m(schema[33m.[39mauditLogs)[33m.[39m[34mvalues[39m({
    [90m   | [39m    [31m^[39m
    [90m343| [39m      userId[33m:[39m userId[33m,[39m
    [90m344| [39m      entityType[33m:[39m [32m'workflow_version'[39m[33m,[39m
[90m [2m‚ùØ[22m tests/integration/workflow_versioning.test.ts:[2m108:20[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "audit_logs" violates foreign key constraint "audit_logs_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m VersionService.publishVersion server/services/VersionService.ts:[2m342:5[22m[39m
[90m [2m‚ùØ[22m tests/integration/workflow_versioning.test.ts:[2m108:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(93f6e9fb-d569-41f0-9371-cc06337c9f72) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w66_v3', table: 'audit_logs', dataType: undefined, constraint: 'audit_logs_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[180/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/workflow_versioning.test.ts[2m > [22mWorkflow Versioning & Lineage[2m > [22mshould track execution lineage via snapshot
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'id')[39m
[36m [2m‚ùØ[22m tests/integration/workflow_versioning.test.ts:[2m130:143[22m[39m
    [90m128| [39m
    [90m129| [39m        [90m// Create Snapshot[39m
    [90m130| [39m        const snapshot = await snapshotService.createSnapshot(workflow‚Ä¶
    [90m   | [39m                                                                                                                                              [31m^[39m
    [90m131| [39m
    [90m132| [39m        [34mexpect[39m(snapshot[33m.[39mworkflowVersionId)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[181/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould create draft version on successful AI edit
[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould enforce draft mode (revert active workflow to draft)
[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould not create version when no changes detected (checksum match)
[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould reject unauthorized access
[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould reject unsafe DataVault operations
[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould handle multi-operation edits with tempId resolution
[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould create BEFORE and AFTER snapshots
[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould rollback on validation failure
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, default, $2, $3, default, default, default, $4, default, default, default, default, default, default, $5, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,33caa0cf-1ab0-41b3-b932-9b8d351515f8,33caa0cf-1ab0-41b3-b932-9b8d351515f8,b9fcf8f8-cf1b-447b-9da7-ad85ea742fcd,active[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/ai/workflowEdit.test.ts:[2m137:24[22m[39m
    [90m135| [39m  [34mbeforeEach[39m([35masync[39m () [33m=>[39m {
    [90m136| [39m    [90m// Create fresh workflow for each test[39m
    [90m137| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m                       [31m^[39m
    [90m138| [39m      title[33m:[39m [32m'Test Workflow'[39m[33m,[39m
    [90m139| [39m      projectId[33m:[39m testProjectId[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/ai/workflowEdit.test.ts:[2m137:24[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 327, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(33caa0cf-1ab0-41b3-b932-9b8d351515f8) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[182/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Authorization Flow Initiation[2m > [22mshould initiate OAuth2 3-legged flow and generate authorization URL
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth/oauth2.callback.test.ts:[2m125:37[22m[39m
    [90m123| [39m        })[33m;[39m
    [90m124| [39m
    [90m125| [39m      [34mexpect[39m(createResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m126| [39m      testConnectionId [33m=[39m createResponse[33m.[39mbody[33m.[39mid[33m;[39m
    [90m127| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[183/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Connection Status[2m > [22mshould track OAuth2 connection status
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth/oauth2.callback.test.ts:[2m309:37[22m[39m
    [90m307| [39m        })[33m;[39m
    [90m308| [39m
    [90m309| [39m      [34mexpect[39m(createResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m310| [39m      [35mconst[39m connectionId [33m=[39m createResponse[33m.[39mbody[33m.[39mid[33m;[39m
    [90m311| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[184/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould create refresh token record in database
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/auth/oauth2.google.test.ts:[2m297:31[22m[39m
    [90m295| [39m        })[33m;[39m
    [90m296| [39m
    [90m297| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m298| [39m
    [90m299| [39m      [90m// Verify refresh token exists in database[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[185/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould handle missing profile information gracefully
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/auth/oauth2.google.test.ts:[2m395:31[22m[39m
    [90m393| [39m        })[33m;[39m
    [90m394| [39m
    [90m395| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m396| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39muser)[33m.[39m[34mtoMatchObject[39m({
    [90m397| [39m        email[33m:[39m [32m'minimal@example.com'[39m[33m,[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[186/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould list all active sessions for current user
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: ZQL0gVkiVqmpEoAOQmNId,session-test--4iFYCocMJ-2pHNmjMtuh@example.com,Session Test,Session,Test,79098fde-a036-4c09-ab9e-32915ae1e448,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(79098fde-a036-4c09-ab9e-32915ae1e448) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w85_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[187/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould mark current session as current
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: lH6v_fCdq6hdumh1XTfEz,session-test-uK-oreaO2kJpd32m3-FY1@example.com,Session Test,Session,Test,79098fde-a036-4c09-ab9e-32915ae1e448,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(79098fde-a036-4c09-ab9e-32915ae1e448) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w85_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[188/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould return empty array when user has no active sessions
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: celSUXFqrD_VhB93mdLFA,session-test-UMwwYG6dZlFokPSlgUrGf@example.com,Session Test,Session,Test,79098fde-a036-4c09-ab9e-32915ae1e448,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(79098fde-a036-4c09-ab9e-32915ae1e448) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w81_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[189/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould not include expired sessions
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: Sery0vB9s3NeOOslL2ghE,session-test-RNF4YCvj_Bh5jcb6KlKB9@example.com,Session Test,Session,Test,79098fde-a036-4c09-ab9e-32915ae1e448,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(79098fde-a036-4c09-ab9e-32915ae1e448) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w81_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[190/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould not include revoked sessions
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: LF-8F9QghRAoAvbQcXhLk,session-test-YNuJB1at-nOSN-ZQlX9ax@example.com,Session Test,Session,Test,79098fde-a036-4c09-ab9e-32915ae1e448,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(79098fde-a036-4c09-ab9e-32915ae1e448) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w81_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[191/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould parse device name from user agent
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, default, default) returning "id", "user_id", "password_hash", "created_at", "updated_at"
params: w9YyX3QmY8sjD-MjsCt_f,$2b$12$eTG2.7OcyDrLTP0NG3MsIO9OVGu4xOowEaK96qJNAxoD0Y0ZX0W92[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:[2m42:29[22m[39m
    [90m 40| [39m
    [90m 41| [39m    [35mtry[39m {
    [90m 42| [39m      [35mconst[39m [credentials] [33m=[39m [35mawait[39m database
    [90m   | [39m                            [31m^[39m
    [90m 43| [39m        [33m.[39m[34minsert[39m(userCredentials)
    [90m 44| [39m        [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m70:5[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:[2m42:29[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m70:5[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 332, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(w9YyX3QmY8sjD-MjsCt_f) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w93_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[192/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould return 401 for unauthenticated request
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: oAzECHR3-xrTdE8SIn13V,session-test-yFmcyxam8XTpE3xl_c4-X@example.com,Session Test,Session,Test,79098fde-a036-4c09-ab9e-32915ae1e448,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(79098fde-a036-4c09-ab9e-32915ae1e448) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w81_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[193/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould revoke a specific session
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: ctMqJojFMTbi1tkeu66EF,session-test-KFYeGodF3i1ZydyVdmSpM@example.com,Session Test,Session,Test,79098fde-a036-4c09-ab9e-32915ae1e448,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(79098fde-a036-4c09-ab9e-32915ae1e448) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w81_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[194/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould return 404 for non-existent session
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: jHyzaOAiHRp7G9VadvHcp,session-test-p-Mzk500p2bHZ_PHf1k-i@example.com,Session Test,Session,Test,79098fde-a036-4c09-ab9e-32915ae1e448,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(79098fde-a036-4c09-ab9e-32915ae1e448) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w81_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[195/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould prevent revoking current session
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 1HcBqAb7vJDYJcrvbIvqS,session-test-CGl8D3FvpQ8nDRNGKeLUm@example.com,Session Test,Session,Test,79098fde-a036-4c09-ab9e-32915ae1e448,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(79098fde-a036-4c09-ab9e-32915ae1e448) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w93_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[196/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould prevent revoking another user's session
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: gFaDiBGZK2pISQwZSxP3i,session-test-MS5y4ijlmnlymiBkqWEWo@example.com,Session Test,Session,Test,79098fde-a036-4c09-ab9e-32915ae1e448,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(79098fde-a036-4c09-ab9e-32915ae1e448) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w81_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[197/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould return 401 for unauthenticated request
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: s1D7YJ4e2e7UrlJdHHaSa,session-test-V31Gdim8A5faYB0a9oTVg@example.com,Session Test,Session,Test,79098fde-a036-4c09-ab9e-32915ae1e448,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(79098fde-a036-4c09-ab9e-32915ae1e448) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w81_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[198/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould revoke all sessions except current
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 9_WmaEEWGLyXsZu5WmCCn,session-test-5mJ2bXsHBwD_HQwvgmPXW@example.com,Session Test,Session,Test,79098fde-a036-4c09-ab9e-32915ae1e448,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(79098fde-a036-4c09-ab9e-32915ae1e448) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w81_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[199/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould revoke all trusted devices
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: d9LuFj1Pp5v6B_4f6-AQy,session-test-YGgYjU1vTcRXEoxV6dTQr@example.com,Session Test,Session,Test,79098fde-a036-4c09-ab9e-32915ae1e448,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(79098fde-a036-4c09-ab9e-32915ae1e448) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w81_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[200/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould return 400 when no active session found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: IyTExYs7Xto1L_LZuHdKH,session-test-92KhHfeLbwmkQLfYOVbse@example.com,Session Test,Session,Test,79098fde-a036-4c09-ab9e-32915ae1e448,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(79098fde-a036-4c09-ab9e-32915ae1e448) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w102_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[201/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould return 401 for unauthenticated request
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: LWfiK3WTYs_Dzfa8BvQp5,session-test-9hJ10QTl9YW8KMmrtShpM@example.com,Session Test,Session,Test,79098fde-a036-4c09-ab9e-32915ae1e448,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(79098fde-a036-4c09-ab9e-32915ae1e448) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w91_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[202/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mPOST /api/auth/trust-device[2m > [22mshould mark current device as trusted
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: kXMnR8UHXcLxOZfWuIJLI,session-test-9pp4pYqf95prWw6Zoi4MR@example.com,Session Test,Session,Test,79098fde-a036-4c09-ab9e-32915ae1e448,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(79098fde-a036-4c09-ab9e-32915ae1e448) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w101_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[203/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mPOST /api/auth/trust-device[2m > [22mshould update existing trusted device expiry
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: jZWzsIp77H9a5xDC1BxFN,session-test-PC3WeJP-JnT53T9jBgwc9@example.com,Session Test,Session,Test,79098fde-a036-4c09-ab9e-32915ae1e448,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(79098fde-a036-4c09-ab9e-32915ae1e448) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w81_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[204/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould list all trusted devices
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 57mWs95u0CF5MJRQ_kCLz,session-test-leUFqXUbIYDfERw600Rfu@example.com,Session Test,Session,Test,79098fde-a036-4c09-ab9e-32915ae1e448,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(79098fde-a036-4c09-ab9e-32915ae1e448) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w81_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[205/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould not include revoked devices
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 60aT_R14fX-T--hk6bEij,session-test-vGUBmkBLXkx3fKUZtFjzt@example.com,Session Test,Session,Test,79098fde-a036-4c09-ab9e-32915ae1e448,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(79098fde-a036-4c09-ab9e-32915ae1e448) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w81_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[206/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould revoke a trusted device
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: -o_3_1_L8MP7CCfnSv1bf,session-test-FFvmhtlsZtxRm2CgF0w6l@example.com,Session Test,Session,Test,79098fde-a036-4c09-ab9e-32915ae1e448,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(79098fde-a036-4c09-ab9e-32915ae1e448) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w93_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[207/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould return 404 for non-existent device
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: rFhl3f91KXCagQH_wnN6A,session-test-p_QOd1m0xbxjoQD-8XQzC@example.com,Session Test,Session,Test,79098fde-a036-4c09-ab9e-32915ae1e448,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(79098fde-a036-4c09-ab9e-32915ae1e448) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w81_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[208/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mSession Metadata Tracking[2m > [22mshould track IP address for sessions
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: OsGnkQIipn2XJrTmPnaHN,session-test-C1w8WRlaIazVMPxaAJyRy@example.com,Session Test,Session,Test,79098fde-a036-4c09-ab9e-32915ae1e448,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(79098fde-a036-4c09-ab9e-32915ae1e448) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w102_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[209/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mSession Metadata Tracking[2m > [22mshould track user agent for sessions
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: QvYqijMVJL90rmF-3ogrJ,session-test-SSc-7puh22t4oW-8Qsqtv@example.com,Session Test,Session,Test,79098fde-a036-4c09-ab9e-32915ae1e448,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(79098fde-a036-4c09-ab9e-32915ae1e448) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w28_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[210/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mSession Metadata Tracking[2m > [22mshould update lastUsedAt on token refresh
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: gnKHOfNSzN5UjrmYlq3Gz,session-test-BCV3FcbbcFgXK2QnU9WkN@example.com,Session Test,Session,Test,79098fde-a036-4c09-ab9e-32915ae1e448,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(79098fde-a036-4c09-ab9e-32915ae1e448) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w98_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[211/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould refresh access token with valid refresh token
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, default, default) returning "id", "user_id", "password_hash", "created_at", "updated_at"
params: rtKrJWZKjEEtfMPL5KrK7,$2b$12$L2yDPUZ9KUsNDVnOuRdy5eK7LLxLRtIdsIabJJ6HkaCYdkbjxquG.[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:[2m42:29[22m[39m
    [90m 40| [39m
    [90m 41| [39m    [35mtry[39m {
    [90m 42| [39m      [35mconst[39m [credentials] [33m=[39m [35mawait[39m database
    [90m   | [39m                            [31m^[39m
    [90m 43| [39m        [33m.[39m[34minsert[39m(userCredentials)
    [90m 44| [39m        [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m72:5[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:[2m42:29[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m72:5[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 332, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(rtKrJWZKjEEtfMPL5KrK7) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w93_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[212/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould rotate refresh token after use
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: wH3gv22gpTKrdhMfmevVJ,refresh-test-ZGFcsDTYHUcVZMZrP0o6Y@example.com,Refresh Test,Refresh,Test,b1442cc3-260e-4daa-a693-47a4cdecc3b9,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b1442cc3-260e-4daa-a693-47a4cdecc3b9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w79_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[213/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 when refresh token is missing
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: lrGQ-yZ-4QWhYLjEme7rV,refresh-test-Sw9l-F_sECyIgdk8F0OWE@example.com,Refresh Test,Refresh,Test,b1442cc3-260e-4daa-a693-47a4cdecc3b9,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b1442cc3-260e-4daa-a693-47a4cdecc3b9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w85_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[214/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 for invalid refresh token
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 7MeXiU07EqOc642V9dj2j,refresh-test-ehYrVNh8Q64lavyzunwqU@example.com,Refresh Test,Refresh,Test,b1442cc3-260e-4daa-a693-47a4cdecc3b9,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b1442cc3-260e-4daa-a693-47a4cdecc3b9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w85_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[215/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 for expired refresh token
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: Env-ueBCNmMDt1VI67t6b,refresh-test-pUeo8OwEZX19h-CywdMRr@example.com,Refresh Test,Refresh,Test,b1442cc3-260e-4daa-a693-47a4cdecc3b9,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b1442cc3-260e-4daa-a693-47a4cdecc3b9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w85_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[216/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 for revoked refresh token
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: gNJ8Pk33yqPhljccS57Gs,refresh-test-hW8CqaDx9H3gIVIdsYQNZ@example.com,Refresh Test,Refresh,Test,b1442cc3-260e-4daa-a693-47a4cdecc3b9,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b1442cc3-260e-4daa-a693-47a4cdecc3b9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w85_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[217/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 when user is not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: XdIPvjn2M2XNDv59nUpwZ,refresh-test-V9IEzDFhao42Bivl8Mybm@example.com,Refresh Test,Refresh,Test,b1442cc3-260e-4daa-a693-47a4cdecc3b9,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b1442cc3-260e-4daa-a693-47a4cdecc3b9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w85_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[218/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould update refresh token metadata on rotation
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: UGDp959GkS6ICtne6q7X7,refresh-test-UCJYT1ymT-mLKLLQ7oCKh@example.com,Refresh Test,Refresh,Test,b1442cc3-260e-4daa-a693-47a4cdecc3b9,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b1442cc3-260e-4daa-a693-47a4cdecc3b9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w85_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[219/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould handle concurrent refresh token requests (token reuse detection)
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: NJqX-auoMtoot3Y2ADR8H,refresh-test-KmWNbaOJ9eYfw60B9g4S9@example.com,Refresh Test,Refresh,Test,b1442cc3-260e-4daa-a693-47a4cdecc3b9,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b1442cc3-260e-4daa-a693-47a4cdecc3b9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w85_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[220/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould set secure cookie in production
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: hbO1iwhLz58FvG96VyXC6,refresh-test-BBZlRUCs4gJDZM6MgDOMu@example.com,Refresh Test,Refresh,Test,b1442cc3-260e-4daa-a693-47a4cdecc3b9,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b1442cc3-260e-4daa-a693-47a4cdecc3b9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w85_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[221/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould set proper cookie attributes
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: A7xQjmD_0pGcWXz0c1G8E,refresh-test-WFeT71cKrkWVWhIOQnckN@example.com,Refresh Test,Refresh,Test,b1442cc3-260e-4daa-a693-47a4cdecc3b9,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b1442cc3-260e-4daa-a693-47a4cdecc3b9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w85_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[222/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould include user role information in response
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: ewFzTNjiMm1flSK_Vee0T,refresh-test-_TdSAXyRDeiD6qUeVIDRF@example.com,Refresh Test,Refresh,Test,b1442cc3-260e-4daa-a693-47a4cdecc3b9,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b1442cc3-260e-4daa-a693-47a4cdecc3b9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w85_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[223/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould create refresh token on login
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: k9h1pUI7SNOzWYwOjjIi4,refresh-test-Z2fEqNZKs7Q6yuKDJ1vDS@example.com,Refresh Test,Refresh,Test,b1442cc3-260e-4daa-a693-47a4cdecc3b9,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b1442cc3-260e-4daa-a693-47a4cdecc3b9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w85_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[224/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould revoke refresh token on logout
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 5xD82zgjB4lrnm3Mp2gKl,refresh-test-ZWGKhFJnOFBS8s8_6ZlzN@example.com,Refresh Test,Refresh,Test,b1442cc3-260e-4daa-a693-47a4cdecc3b9,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b1442cc3-260e-4daa-a693-47a4cdecc3b9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w101_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[225/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould support multiple active refresh tokens per user
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: zCaaf0qgNRI3WH5XZVXB3,refresh-test-PFFa5VIS71PfxsdZzTrfa@example.com,Refresh Test,Refresh,Test,b1442cc3-260e-4daa-a693-47a4cdecc3b9,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b1442cc3-260e-4daa-a693-47a4cdecc3b9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w94_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[226/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould revoke all user tokens on password reset
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 9BdUMXpTzpSkPeQicPbMb,refresh-test-sprY39yEb0R192QFzTdpw@example.com,Refresh Test,Refresh,Test,b1442cc3-260e-4daa-a693-47a4cdecc3b9,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b1442cc3-260e-4daa-a693-47a4cdecc3b9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w102_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[227/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Security[2m > [22mshould use cryptographically strong random tokens
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: zY46JzJooRfXr6ChHhxR8,refresh-test-2Dg-MVwEIOyW3VxugpZJM@example.com,Refresh Test,Refresh,Test,b1442cc3-260e-4daa-a693-47a4cdecc3b9,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b1442cc3-260e-4daa-a693-47a4cdecc3b9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w96_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[228/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Security[2m > [22mshould hash refresh tokens before storing in database
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: CxcV7kSIMhDhBjRnkl6Vz,refresh-test-LFx7kUU1zxYaKvllg-dx4@example.com,Refresh Test,Refresh,Test,b1442cc3-260e-4daa-a693-47a4cdecc3b9,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b1442cc3-260e-4daa-a693-47a4cdecc3b9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w95_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[229/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Security[2m > [22mshould prevent refresh token reuse after rotation
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: oeOm1_ayuUTvtBCKxS-hF,refresh-test-TlFQ2DnfuzYdMrBvG15cV@example.com,Refresh Test,Refresh,Test,b1442cc3-260e-4daa-a693-47a4cdecc3b9,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b1442cc3-260e-4daa-a693-47a4cdecc3b9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w85_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[230/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Security[2m > [22mshould validate token ownership
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: lJKM0LR6bqzmqR1mw42HG,refresh-test-ueytdLP8g6KH97Y9V_u0_@example.com,Refresh Test,Refresh,Test,b1442cc3-260e-4daa-a693-47a4cdecc3b9,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b1442cc3-260e-4daa-a693-47a4cdecc3b9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w85_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[231/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mCookie Security[2m > [22mshould set HttpOnly flag to prevent XSS
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: gf-SDVikiIzcHG8z33m59,refresh-test-LfhAGca8A6fNKIrLBhVSk@example.com,Refresh Test,Refresh,Test,b1442cc3-260e-4daa-a693-47a4cdecc3b9,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b1442cc3-260e-4daa-a693-47a4cdecc3b9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w98_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[232/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mCookie Security[2m > [22mshould set SameSite=Strict to prevent CSRF
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: bWBMlrpvyfIDwl8aLEb4b,refresh-test-flRM4NbMyByPpKkwFlVde@example.com,Refresh Test,Refresh,Test,b1442cc3-260e-4daa-a693-47a4cdecc3b9,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b1442cc3-260e-4daa-a693-47a4cdecc3b9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w85_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[233/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mCookie Security[2m > [22mshould set proper cookie path
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: b3jAL8kVjTWJ3b-pFsHQu,refresh-test-0RnSnjQlllu43H1-dFpjg@example.com,Refresh Test,Refresh,Test,b1442cc3-260e-4daa-a693-47a4cdecc3b9,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b1442cc3-260e-4daa-a693-47a4cdecc3b9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w85_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[234/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mCookie Security[2m > [22mshould set appropriate expiry (30 days)
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: x00UHvcMfuRr9SzzHRqGZ,refresh-test-GS9_n8phnPwfzIMQRBhGD@example.com,Refresh Test,Refresh,Test,b1442cc3-260e-4daa-a693-47a4cdecc3b9,creator,owner,local,easy,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b1442cc3-260e-4daa-a693-47a4cdecc3b9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w85_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[235/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mTemplate Key Resolution (New Path)[2m > [22mshould resolve template by key from workflowTemplates mapping
[31m[1mError[22m: Failed query: insert into "workflow_versions" ("id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at") values ($1, $2, default, $3, default, $4, default, $5, default, default, $6, default, default, default, default) returning "id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at"
params: b7fb95ce-79c9-4c02-ad4e-2b8191f20c04,407e2916-900e-45c8-ad3b-4709d2b09944,1,{},"Initial version",74929f21-da4b-435f-a3d7-feec6ad94b01[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m166:23[22m[39m
    [90m164| [39m      [33m.[39m[34mreturning[39m()[33m;[39m
    [90m165| [39m
    [90m166| [39m    [35mconst[39m [version] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m167| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mworkflowVersions)
    [90m168| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m87:35[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "workflow_versions" violates foreign key constraint "workflow_versions_workflow_id_workflows_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m166:23[22m[39m
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m87:35[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 375, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(407e2916-900e-45c8-ad3b-4709d2b09944) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w93_v3', table: 'workflow_versions', dataType: undefined, constraint: 'workflow_versions_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[236/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mTemplate Key Resolution (New Path)[2m > [22mshould throw error if template key not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 4473acf7-b25e-4add-938b-f608e7d26452,test-1768715742695@example.com,Test User,Test,User,483df6bf-ae03-47b5-8fc4-069428384159,admin,owner,local,easy[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(483df6bf-ae03-47b5-8fc4-069428384159) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w81_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[237/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mTemplate Key Resolution (New Path)[2m > [22mshould store output in runOutputs table
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: aa88b6b5-1817-424f-9ecb-bbd39c381324,test-1768715743636@example.com,Test User,Test,User,8a8b0357-cf08-4c20-9338-28616f10a406,admin,owner,local,easy[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(8a8b0357-cf08-4c20-9338-28616f10a406) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w95_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[238/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mLegacy Template ID Path (Backward Compatibility)[2m > [22mshould resolve template by templateId directly
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 21b63e22-19ba-4cea-827f-6b6955e03dcc,test-1768715744177@example.com,Test User,Test,User,cdd98b4e-5d91-4990-94d1-0a1231a27b6e,admin,owner,local,easy[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(cdd98b4e-5d91-4990-94d1-0a1231a27b6e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w85_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[239/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mLegacy Template ID Path (Backward Compatibility)[2m > [22mshould throw error if templateId not found
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: 0797d49f-d091-40a5-bcb7-9bd6d475cab4,Test Project,Test Project,Test project for integration tests,a80fad53-befa-46b6-9afd-1faa2aa5697b,3b4bfcc8-d013-4e04-8db1-7bb0405e6a75,a80fad53-befa-46b6-9afd-1faa2aa5697b,a80fad53-befa-46b6-9afd-1faa2aa5697b[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(a80fad53-befa-46b6-9afd-1faa2aa5697b) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w98_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[240/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mRendering Engine Selection[2m > [22mshould use docxRenderer2 by default (v2 engine)
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 181c724d-c184-4540-8872-4b6f9bd040a5,test-1768715745651@example.com,Test User,Test,User,90034491-1c0f-4d53-a529-7b3decab89c0,admin,owner,local,easy[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(90034491-1c0f-4d53-a529-7b3decab89c0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w85_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[241/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mRendering Engine Selection[2m > [22mshould use legacy engine when engine="legacy"
[31m[1mError[22m: Failed query: insert into "runs" ("id", "workflow_version_id", "input_json", "output_refs", "trace", "status", "error", "duration_ms", "run_token", "share_token", "share_token_expires_at", "created_by", "created_at", "updated_at") values ($1, $2, default, default, default, $3, default, default, default, default, default, $4, default, default) returning "id", "workflow_version_id", "input_json", "output_refs", "trace", "status", "error", "duration_ms", "run_token", "share_token", "share_token_expires_at", "created_by", "created_at", "updated_at"
params: 2c98239a-8f07-497a-931e-0712a99e8cb3,ad94ad9a-bb85-49b3-9c67-b7f74c9b176c,pending,412e97ca-87aa-404a-b41e-267322fb01f7[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createRun tests/helpers/testFactory.ts:[2m283:19[22m[39m
    [90m281| [39m    overrides[33m?[39m[33m:[39m [33mPartial[39m[33m<[39m[35mtypeof[39m schema[33m.[39mruns[33m.[39m$inferInsert[33m>[39m
    [90m282| [39m  )[33m:[39m [33mPromise[39m[33m<[39m[33mTestRun[39m[33m>[39m {
    [90m283| [39m    [35mconst[39m [run] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                  [31m^[39m
    [90m284| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mruns)
    [90m285| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m117:21[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "runs" violates foreign key constraint "runs_workflow_version_id_workflow_versions_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createRun tests/helpers/testFactory.ts:[2m283:19[22m[39m
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m117:21[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 372, severity: 'ERROR', code: '23503', detail: 'Key (workflow_version_id)=(ad94ad9a-bb85-49b3-9c67-b7f74c9b176c) is not present in table "workflow_versions".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w114_v3', table: 'runs', dataType: undefined, constraint: 'runs_workflow_version_id_workflow_versions_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[242/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mPDF Generation[2m > [22mshould generate PDF when toPdf=true
[31m[1mError[22m: Failed query: insert into "workflow_versions" ("id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at") values ($1, $2, default, $3, default, $4, default, $5, default, default, $6, default, default, default, default) returning "id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at"
params: 5a42fc0d-3906-427d-8311-0c4945594b22,ef2e248a-93f2-4989-ad39-43559db47865,1,{},"Initial version",59cbaabf-5c30-44ae-ac90-ce8b2da03e8f[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m166:23[22m[39m
    [90m164| [39m      [33m.[39m[34mreturning[39m()[33m;[39m
    [90m165| [39m
    [90m166| [39m    [35mconst[39m [version] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m167| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mworkflowVersions)
    [90m168| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m87:35[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "workflow_versions" violates foreign key constraint "workflow_versions_workflow_id_workflows_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m166:23[22m[39m
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m87:35[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 376, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(ef2e248a-93f2-4989-ad39-43559db47865) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w109_v3', table: 'workflow_versions', dataType: undefined, constraint: 'workflow_versions_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[243/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mPDF Generation[2m > [22mshould default to DOCX when toPdf=false
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: 608dc802-88b7-458b-a6c6-28a49b4ed813,Test Project,Test Project,Test project for integration tests,aa8f1260-18b7-4e3c-8393-aaa88a6602c4,18208377-e226-4a08-b500-e2ac183006b6,aa8f1260-18b7-4e3c-8393-aaa88a6602c4,aa8f1260-18b7-4e3c-8393-aaa88a6602c4[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 325, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(aa8f1260-18b7-4e3c-8393-aaa88a6602c4) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w109_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[244/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mConditional Execution[2m > [22mshould skip execution when condition evaluates to false
[31m[1mError[22m: Failed query: insert into "templates" ("id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, default, default, default, default, $7, default, default) returning "id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at"
params: 81b0dda9-94f2-4a42-b854-37b6ddb30c33,ed38eba7-a2b4-4c88-a6c0-6424f5c18ae4,Engagement Letter,Main engagement letter,template1.docx,docx,d4ffa96d-3de7-43e9-8fbb-f6a0c788b93d[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTemplate tests/helpers/testFactory.ts:[2m235:24[22m[39m
    [90m233| [39m    overrides[33m?[39m[33m:[39m [33mPartial[39m[33m<[39m[35mtypeof[39m schema[33m.[39mtemplates[33m.[39m$inferInsert[33m>[39m
    [90m234| [39m  )[33m:[39m [33mPromise[39m[33m<[39m[33mTestTemplate[39m[33m>[39m {
    [90m235| [39m    [35mconst[39m [template] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                       [31m^[39m
    [90m236| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mtemplates)
    [90m237| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m100:37[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "templates" violates foreign key constraint "templates_project_id_projects_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTemplate tests/helpers/testFactory.ts:[2m235:24[22m[39m
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m100:37[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 338, severity: 'ERROR', code: '23503', detail: 'Key (project_id)=(ed38eba7-a2b4-4c88-a6c0-6424f5c18ae4) is not present in table "projects".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w125_v3', table: 'templates', dataType: undefined, constraint: 'templates_project_id_projects_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[245/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mConditional Execution[2m > [22mshould execute when condition evaluates to true
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, $3, $4, $5, default, $6, default, $7, default, default, default, default, default, default, $8, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: c4638423-2475-4028-9357-323b66aa0f0f,Test Workflow,Test workflow,2e58aac6-3729-49d2-9d1b-11e933fef34b,2e58aac6-3729-49d2-9d1b-11e933fef34b,test-workflow-91dd63a1-515b-498a-96ce-0c550c1ce5ba,313eb396-52ea-446d-9712-59de232048cb,draft[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
    [90m149| [39m    }
    [90m150| [39m  )[33m:[39m [33mPromise[39m[33m<[39m[33mTestWorkflow[39m[33m>[39m {
    [90m151| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                       [31m^[39m
    [90m152| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mworkflows)
    [90m153| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m87:35[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m87:35[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 329, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(2e58aac6-3729-49d2-9d1b-11e933fef34b) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w114_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[246/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mBinding Resolution[2m > [22mshould resolve simple bindings
[31m[1mError[22m: Failed query: insert into "runs" ("id", "workflow_version_id", "input_json", "output_refs", "trace", "status", "error", "duration_ms", "run_token", "share_token", "share_token_expires_at", "created_by", "created_at", "updated_at") values ($1, $2, default, default, default, $3, default, default, default, default, default, $4, default, default) returning "id", "workflow_version_id", "input_json", "output_refs", "trace", "status", "error", "duration_ms", "run_token", "share_token", "share_token_expires_at", "created_by", "created_at", "updated_at"
params: 625bdc4b-8416-465a-afa1-56f6c3e868a8,80030f17-80c8-4f3e-b48e-c5e279f35319,pending,c9dc614b-bb3c-40b0-9e5f-1ae1c925fc39[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createRun tests/helpers/testFactory.ts:[2m283:19[22m[39m
    [90m281| [39m    overrides[33m?[39m[33m:[39m [33mPartial[39m[33m<[39m[35mtypeof[39m schema[33m.[39mruns[33m.[39m$inferInsert[33m>[39m
    [90m282| [39m  )[33m:[39m [33mPromise[39m[33m<[39m[33mTestRun[39m[33m>[39m {
    [90m283| [39m    [35mconst[39m [run] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                  [31m^[39m
    [90m284| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mruns)
    [90m285| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m117:21[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "runs" violates foreign key constraint "runs_workflow_version_id_workflow_versions_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createRun tests/helpers/testFactory.ts:[2m283:19[22m[39m
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m117:21[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 372, severity: 'ERROR', code: '23503', detail: 'Key (workflow_version_id)=(80030f17-80c8-4f3e-b48e-c5e279f35319) is not present in table "workflow_versions".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w129_v3', table: 'runs', dataType: undefined, constraint: 'runs_workflow_version_id_workflow_versions_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[247/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mBinding Resolution[2m > [22mshould handle binding resolution errors gracefully
[31m[1mError[22m: Failed query: insert into "templates" ("id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, default, default, default, default, $7, default, default) returning "id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at"
params: 5089df77-2868-4a81-9eef-d4dc462864e7,cd8f9046-c5bf-4be0-ad49-45d6710a2e64,Schedule A,Schedule A annex,template2.docx,docx,a25f13d9-3691-4d35-ad2b-816ce6b7ca36[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTemplate tests/helpers/testFactory.ts:[2m235:24[22m[39m
    [90m233| [39m    overrides[33m?[39m[33m:[39m [33mPartial[39m[33m<[39m[35mtypeof[39m schema[33m.[39mtemplates[33m.[39m$inferInsert[33m>[39m
    [90m234| [39m  )[33m:[39m [33mPromise[39m[33m<[39m[33mTestTemplate[39m[33m>[39m {
    [90m235| [39m    [35mconst[39m [template] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                       [31m^[39m
    [90m236| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mtemplates)
    [90m237| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m108:37[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "templates" violates foreign key constraint "templates_project_id_projects_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTemplate tests/helpers/testFactory.ts:[2m235:24[22m[39m
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m108:37[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 338, severity: 'ERROR', code: '23503', detail: 'Key (project_id)=(cd8f9046-c5bf-4be0-ad49-45d6710a2e64) is not present in table "projects".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w114_v3', table: 'templates', dataType: undefined, constraint: 'templates_project_id_projects_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[248/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mError Handling[2m > [22mshould record failed output in runOutputs table
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, $3, $4, $5, default, $6, default, $7, default, default, default, default, default, default, $8, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: 907e1518-a783-4fe6-add9-d6d858065f47,Test Workflow,Test workflow,cff9a0a6-6b7f-4628-b45f-d9939ed3c66b,cff9a0a6-6b7f-4628-b45f-d9939ed3c66b,test-workflow-f25a3696-9188-434e-b879-dec70fba5ce1,e10455ab-1f57-4b72-ac05-473bf84b9ed3,draft[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
    [90m149| [39m    }
    [90m150| [39m  )[33m:[39m [33mPromise[39m[33m<[39m[33mTestWorkflow[39m[33m>[39m {
    [90m151| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                       [31m^[39m
    [90m152| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mworkflows)
    [90m153| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m87:35[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m87:35[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 329, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(cff9a0a6-6b7f-4628-b45f-d9939ed3c66b) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w121_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[249/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mError Handling[2m > [22mshould not throw errors (should return error in result)
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: d034e973-6cbd-422b-8f31-d30177d730de,Test Project,Test Project,Test project for integration tests,068eb2a4-9f77-429b-914a-fd94f7186f1a,64958285-bfab-4530-82b1-0a7541219907,068eb2a4-9f77-429b-914a-fd94f7186f1a,068eb2a4-9f77-429b-914a-fd94f7186f1a[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 325, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(068eb2a4-9f77-429b-914a-fd94f7186f1a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w114_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[250/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mTenant Access Control[2m > [22mshould deny access to templates from different tenant
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 88663023-72f3-490d-a96a-5a5f5a5651a4,test-1768715757418@example.com,Test User,Test,User,bc71443c-760d-478c-8ce9-19750a40ca85,admin,owner,local,easy[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(bc71443c-760d-478c-8ce9-19750a40ca85) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w121_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[251/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mValidation[2m > [22mshould require either templateKey or templateId
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, $3, $4, $5, default, $6, default, $7, default, default, default, default, default, default, $8, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: 0e3a7e83-1fbd-46c4-9d11-bc35ab0ce490,Test Workflow,Test workflow,d69f5df6-97b8-4c4c-accb-8b03adbe4575,d69f5df6-97b8-4c4c-accb-8b03adbe4575,test-workflow-4200d32d-0870-4544-b43a-173d7cd1a60d,336de9d1-c737-4459-b8aa-a12d3f9eecd7,draft[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
    [90m149| [39m    }
    [90m150| [39m  )[33m:[39m [33mPromise[39m[33m<[39m[33mTestWorkflow[39m[33m>[39m {
    [90m151| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                       [31m^[39m
    [90m152| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mworkflows)
    [90m153| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m87:35[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m87:35[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 329, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(d69f5df6-97b8-4c4c-accb-8b03adbe4575) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w126_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[252/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22mhybridAuth[2m > [22mshould authenticate with JWT Bearer token
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2m‚ùØ[22m tests/unit/middleware/auth.middleware.test.ts:[2m238:24[22m[39m
    [90m236| [39m      await hybridAuth(mockReq as unknown as Request, mockRes as unkno‚Ä¶
    [90m237| [39m
    [90m238| [39m      [34mexpect[39m(mockNext)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m239| [39m      [35mconst[39m authReq [33m=[39m mockReq [35mas[39m unknown [35mas[39m [33mAuthRequest[39m[33m;[39m
    [90m240| [39m      [34mexpect[39m(authReq[33m.[39muserId)[33m.[39m[34mtoBe[39m(mockUser[33m.[39mid)[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[253/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22mhybridAuth[2m > [22mshould authenticate with refresh token cookie for GET requests
[31m[1mAssertionError[22m: expected "vi.fn()" to be called with arguments: [ 'user-123' ][90m

Number of calls: [1m0[22m
[31m[39m
[36m [2m‚ùØ[22m tests/unit/middleware/auth.middleware.test.ts:[2m256:39[22m[39m
    [90m254| [39m
    [90m255| [39m      expect(authService.validateRefreshToken).toHaveBeenCalledWith(re‚Ä¶
    [90m256| [39m      expect(userRepository.findById).toHaveBeenCalledWith(mockUser.id‚Ä¶
    [90m   | [39m                                      [31m^[39m
    [90m257| [39m      [34mexpect[39m(mockNext)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m258| [39m      [35mconst[39m authReq [33m=[39m mockReq [35mas[39m unknown [35mas[39m [33mAuthRequest[39m[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[254/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22mhybridAuth[2m > [22mshould reject cookie auth for POST requests
[31m[1mAssertionError[22m: expected "vi.fn()" to be called with arguments: [ 401 ][90m

Number of calls: [1m0[22m
[31m[39m
[36m [2m‚ùØ[22m tests/unit/middleware/auth.middleware.test.ts:[2m272:26[22m[39m
    [90m270| [39m
    [90m271| [39m      [34mexpect[39m(mockNext)[33m.[39mnot[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m272| [39m      [34mexpect[39m(statusMock)[33m.[39m[34mtoHaveBeenCalledWith[39m([34m401[39m)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m273| [39m      expect(authService.validateRefreshToken).not.toHaveBeenCalled();‚Ä¶
    [90m274| [39m    })[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[255/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22mhybridAuth[2m > [22mshould prioritize JWT over cookie when both present
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2m‚ùØ[22m tests/unit/middleware/auth.middleware.test.ts:[2m296:24[22m[39m
    [90m294| [39m      await hybridAuth(mockReq as unknown as Request, mockRes as unkno‚Ä¶
    [90m295| [39m
    [90m296| [39m      [34mexpect[39m(mockNext)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m297| [39m      [35mconst[39m authReq [33m=[39m mockReq [35mas[39m unknown [35mas[39m [33mAuthRequest[39m[33m;[39m
    [90m298| [39m      [90m// Should use JWT (mockUser), not cookie (mockUser2)[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[256/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22mhybridAuth[2m > [22mshould allow cookie auth only for safe methods
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2m‚ùØ[22m tests/unit/middleware/auth.middleware.test.ts:[2m324:22[22m[39m
    [90m322| [39m
    [90m323| [39m        await hybridAuth(req as unknown as Request, res as unknown as ‚Ä¶
    [90m324| [39m        [34mexpect[39m(next)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                     [31m^[39m
    [90m325| [39m        expect(authService.validateRefreshToken).toHaveBeenCalledWith(‚Ä¶
    [90m326| [39m        expect(userRepository.findById).toHaveBeenCalledWith(mockUser.‚Ä¶

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[257/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22mhybridAuth[2m > [22mshould return 401 when no auth provided
[31m[1mAssertionError[22m: expected "vi.fn()" to be called with arguments: [ 401 ][90m

Number of calls: [1m0[22m
[31m[39m
[36m [2m‚ùØ[22m tests/unit/middleware/auth.middleware.test.ts:[2m364:26[22m[39m
    [90m362| [39m
    [90m363| [39m      [34mexpect[39m(mockNext)[33m.[39mnot[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m364| [39m      [34mexpect[39m(statusMock)[33m.[39m[34mtoHaveBeenCalledWith[39m([34m401[39m)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m365| [39m    })[33m;[39m
    [90m366| [39m  })[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[258/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22moptionalHybridAuth[2m > [22mshould authenticate with JWT
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2m‚ùØ[22m tests/unit/middleware/auth.middleware.test.ts:[2m381:24[22m[39m
    [90m379| [39m      await optionalHybridAuth(mockReq as unknown as Request, mockRes ‚Ä¶
    [90m380| [39m
    [90m381| [39m      [34mexpect[39m(mockNext)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m382| [39m      [35mconst[39m authReq [33m=[39m mockReq [35mas[39m unknown [35mas[39m [33mAuthRequest[39m[33m;[39m
    [90m383| [39m      [34mexpect[39m(authReq[33m.[39muserId)[33m.[39m[34mtoBe[39m(mockUser[33m.[39mid)[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[259/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22moptionalHybridAuth[2m > [22mshould authenticate with cookie for GET
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2m‚ùØ[22m tests/unit/middleware/auth.middleware.test.ts:[2m400:24[22m[39m
    [90m398| [39m      await optionalHybridAuth(mockReq as unknown as Request, mockRes ‚Ä¶
    [90m399| [39m
    [90m400| [39m      [34mexpect[39m(mockNext)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m401| [39m      [35mconst[39m authReq [33m=[39m mockReq [35mas[39m unknown [35mas[39m [33mAuthRequest[39m[33m;[39m
    [90m402| [39m      [34mexpect[39m(authReq[33m.[39muserId)[33m.[39m[34mtoBe[39m(mockUser[33m.[39mid)[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[260/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22moptionalHybridAuth[2m > [22mshould proceed without auth when none provided
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2m‚ùØ[22m tests/unit/middleware/auth.middleware.test.ts:[2m413:24[22m[39m
    [90m411| [39m      await optionalHybridAuth(mockReq as unknown as Request, mockRes ‚Ä¶
    [90m412| [39m
    [90m413| [39m      [34mexpect[39m(mockNext)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m414| [39m      [35mconst[39m authReq [33m=[39m mockReq [35mas[39m unknown [35mas[39m [33mAuthRequest[39m[33m;[39m
    [90m415| [39m      [34mexpect[39m(authReq[33m.[39muserId)[33m.[39m[34mtoBeUndefined[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[261/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22moptionalHybridAuth[2m > [22mshould proceed even with invalid auth
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2m‚ùØ[22m tests/unit/middleware/auth.middleware.test.ts:[2m435:24[22m[39m
    [90m433| [39m      await optionalHybridAuth(mockReq as unknown as Request, mockRes ‚Ä¶
    [90m434| [39m
    [90m435| [39m      [34mexpect[39m(mockNext)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m436| [39m      [35mconst[39m authReq [33m=[39m mockReq [35mas[39m unknown [35mas[39m [33mAuthRequest[39m[33m;[39m
    [90m437| [39m      [34mexpect[39m(authReq[33m.[39muserId)[33m.[39m[34mtoBeUndefined[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[262/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22mSecurity Edge Cases[2m > [22mshould not allow cookie auth for mutations (CSRF protection)
[31m[1mAssertionError[22m: expected "vi.fn()" to be called with arguments: [ 401 ][90m

Number of calls: [1m0[22m
[31m[39m
[36m [2m‚ùØ[22m tests/unit/middleware/auth.middleware.test.ts:[2m479:28[22m[39m
    [90m477| [39m
    [90m478| [39m        [34mexpect[39m(next)[33m.[39mnot[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m479| [39m        [34mexpect[39m(res[33m.[39mstatus)[33m.[39m[34mtoHaveBeenCalledWith[39m([34m401[39m)[33m;[39m
    [90m   | [39m                           [31m^[39m
    [90m480| [39m        expect(authService.validateRefreshToken).not.toHaveBeenCalled(‚Ä¶
    [90m481| [39m        vi[33m.[39m[34mclearAllMocks[39m()[33m;[39m [90m// Clear mocks for next iteration[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[263/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mcreate[2m > [22mshould create a workflow template mapping
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, default, $5, default, default, default, default, default, default, $6, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,f6e93600-6dc1-4416-a202-890db5719d37,f6e93600-6dc1-4416-a202-890db5719d37,1f64c567-795d-4693-9823-dc7cdb502b0a,draft[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m
    [90m 50| [39m
    [90m 51| [39m    [90m// Create test workflow[39m
    [90m 52| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m db
    [90m   | [39m                       [31m^[39m
    [90m 53| [39m      [33m.[39m[34minsert[39m(workflows)
    [90m 54| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(f6e93600-6dc1-4416-a202-890db5719d37) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[264/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mcreate[2m > [22mshould create non-primary mapping by default
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,b387949f-dde3-4b7a-8885-fecd70f86350,b387949f-dde3-4b7a-8885-fecd70f86350,b387949f-dde3-4b7a-8885-fecd70f86350[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(b387949f-dde3-4b7a-8885-fecd70f86350) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w14_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[265/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionId[2m > [22mshould find all templates for a workflow version
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, default, $5, default, default, default, default, default, default, $6, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,70f13085-c5b7-4a9a-9367-5a77a96c08c8,70f13085-c5b7-4a9a-9367-5a77a96c08c8,895ad2c2-db15-419b-8921-51bb07230fc4,draft[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m
    [90m 50| [39m
    [90m 51| [39m    [90m// Create test workflow[39m
    [90m 52| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m db
    [90m   | [39m                       [31m^[39m
    [90m 53| [39m      [33m.[39m[34minsert[39m(workflows)
    [90m 54| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(70f13085-c5b7-4a9a-9367-5a77a96c08c8) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w14_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[266/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionId[2m > [22mshould return empty array for version with no templates
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,6f4981ac-8359-469d-910d-4b81b7064016,6f4981ac-8359-469d-910d-4b81b7064016,6f4981ac-8359-469d-910d-4b81b7064016[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(6f4981ac-8359-469d-910d-4b81b7064016) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[267/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionId[2m > [22mshould order by createdAt desc (newest first)
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,9b9977b8-dbbb-458e-9eec-27489138ee64,9b9977b8-dbbb-458e-9eec-27489138ee64,9b9977b8-dbbb-458e-9eec-27489138ee64[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(9b9977b8-dbbb-458e-9eec-27489138ee64) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[268/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionAndKey[2m > [22mshould find mapping by workflow version and key
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, default, $5, default, default, default, default, default, default, $6, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,853966b1-673c-43c4-8d18-58e591ed1e0d,853966b1-673c-43c4-8d18-58e591ed1e0d,77fa0a12-a203-401c-8235-868b83b0109f,draft[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m
    [90m 50| [39m
    [90m 51| [39m    [90m// Create test workflow[39m
    [90m 52| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m db
    [90m   | [39m                       [31m^[39m
    [90m 53| [39m      [33m.[39m[34minsert[39m(workflows)
    [90m 54| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(853966b1-673c-43c4-8d18-58e591ed1e0d) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[269/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionAndKey[2m > [22mshould return undefined for non-existent key
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,49532d28-2462-4437-bbc2-5a945d928e12,49532d28-2462-4437-bbc2-5a945d928e12,49532d28-2462-4437-bbc2-5a945d928e12[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(49532d28-2462-4437-bbc2-5a945d928e12) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[270/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindPrimaryByWorkflowVersionId[2m > [22mshould find primary template for workflow version
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,6aa4b5dd-b445-4941-bbfe-2be70e50750a,6aa4b5dd-b445-4941-bbfe-2be70e50750a,6aa4b5dd-b445-4941-bbfe-2be70e50750a[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(6aa4b5dd-b445-4941-bbfe-2be70e50750a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[271/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindPrimaryByWorkflowVersionId[2m > [22mshould return undefined when no primary template exists
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,dc39269a-26d9-4b76-891a-7b3e10fd6381,dc39269a-26d9-4b76-891a-7b3e10fd6381,dc39269a-26d9-4b76-891a-7b3e10fd6381[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(dc39269a-26d9-4b76-891a-7b3e10fd6381) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[272/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22msetPrimary[2m > [22mshould set a template as primary and unset others
[31m[1mError[22m: Failed query: insert into "templates" ("id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, default, default, default, default, default, default, default) returning "id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at"
params: 24395fcb-e40b-433f-a10e-accf41b847b5,Template 1,First test template,/uploads/template1.docx,docx[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m80:25[22m[39m
    [90m 78| [39m
    [90m 79| [39m    [90m// Create test templates[39m
    [90m 80| [39m    [35mconst[39m [template1] [33m=[39m [35mawait[39m db
    [90m   | [39m                        [31m^[39m
    [90m 81| [39m      [33m.[39m[34minsert[39m(templates)
    [90m 82| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "templates" violates foreign key constraint "templates_project_id_projects_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m80:25[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 337, severity: 'ERROR', code: '23503', detail: 'Key (project_id)=(24395fcb-e40b-433f-a10e-accf41b847b5) is not present in table "projects".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'templates', dataType: undefined, constraint: 'templates_project_id_projects_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[273/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22msetPrimary[2m > [22mshould handle setting primary when none existed before
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,d70ec809-1a8d-4c77-b464-73ead037dc0b,d70ec809-1a8d-4c77-b464-73ead037dc0b,d70ec809-1a8d-4c77-b464-73ead037dc0b[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(d70ec809-1a8d-4c77-b464-73ead037dc0b) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[274/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22msetPrimary[2m > [22mshould not delete mapping if workflow version does not match
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,b2b5c8f6-6efb-4e63-bb02-7f54fa06fcb5,b2b5c8f6-6efb-4e63-bb02-7f54fa06fcb5,b2b5c8f6-6efb-4e63-bb02-7f54fa06fcb5[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(b2b5c8f6-6efb-4e63-bb02-7f54fa06fcb5) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w14_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[275/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mexistsByKey[2m > [22mshould return true if key exists in workflow version
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,260a6c40-75fe-4cee-b132-82cfd0e26d44,260a6c40-75fe-4cee-b132-82cfd0e26d44,260a6c40-75fe-4cee-b132-82cfd0e26d44[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(260a6c40-75fe-4cee-b132-82cfd0e26d44) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[276/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mexistsByKey[2m > [22mshould return false if key does not exist
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,bdfb55b7-cde8-4fa5-b42a-24d956de7a4d,bdfb55b7-cde8-4fa5-b42a-24d956de7a4d,bdfb55b7-cde8-4fa5-b42a-24d956de7a4d[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(bdfb55b7-cde8-4fa5-b42a-24d956de7a4d) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[277/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mexistsByKey[2m > [22mshould exclude specified id when checking existence
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,be8af1f5-ddda-45a6-b26e-2d0099608e46,be8af1f5-ddda-45a6-b26e-2d0099608e46,be8af1f5-ddda-45a6-b26e-2d0099608e46[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(be8af1f5-ddda-45a6-b26e-2d0099608e46) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w24_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[278/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mexistsByKey[2m > [22mshould return true if key exists on different mapping
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,17ba2455-c643-42c3-861f-480e2bc22a27,17ba2455-c643-42c3-861f-480e2bc22a27,17ba2455-c643-42c3-861f-480e2bc22a27[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(17ba2455-c643-42c3-861f-480e2bc22a27) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[279/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mupdate[2m > [22mshould update mapping fields
[31m[1mError[22m: Failed query: insert into "workflow_versions" ("id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at") values (default, $1, default, $2, $3, $4, default, $5, default, default, $6, default, default, default, default) returning "id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at"
params: 6d40e8b5-62df-485f-83ce-03f501cf5dde,1,true,{},"Initial version",f42c6903-a08c-49c2-8eee-52ff6105bacf[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m66:23[22m[39m
    [90m 64| [39m
    [90m 65| [39m    [90m// Create test workflow version[39m
    [90m 66| [39m    [35mconst[39m [version] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 67| [39m      [33m.[39m[34minsert[39m(workflowVersions)
    [90m 68| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflow_versions" violates foreign key constraint "workflow_versions_workflow_id_workflows_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m66:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 375, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(6d40e8b5-62df-485f-83ce-03f501cf5dde) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w26_v3', table: 'workflow_versions', dataType: undefined, constraint: 'workflow_versions_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[280/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindById[2m > [22mshould find mapping by id
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,bf5d8465-84a1-4a72-aee4-a6ebd91c20ad,bf5d8465-84a1-4a72-aee4-a6ebd91c20ad,bf5d8465-84a1-4a72-aee4-a6ebd91c20ad[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(bf5d8465-84a1-4a72-aee4-a6ebd91c20ad) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[281/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindById[2m > [22mshould return undefined for non-existent id
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, default, $5, default, default, default, default, default, default, $6, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,9ea4dfe1-07a7-4749-bb35-6dae05babebf,9ea4dfe1-07a7-4749-bb35-6dae05babebf,d07a3628-37c3-4a1e-bb76-b346ab660498,draft[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m
    [90m 50| [39m
    [90m 51| [39m    [90m// Create test workflow[39m
    [90m 52| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m db
    [90m   | [39m                       [31m^[39m
    [90m 53| [39m      [33m.[39m[34minsert[39m(workflows)
    [90m 54| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(9ea4dfe1-07a7-4749-bb35-6dae05babebf) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w22_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[282/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mPassword Reset[2m > [22mgeneratePasswordResetToken()[2m > [22mshould generate password reset token for existing user
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2m‚ùØ[22m AuthService.generatePasswordResetToken server/services/AuthService.ts:[2m508:9[22m[39m
    [90m506| [39m
    [90m507| [39m        [35mawait[39m [34msendPasswordResetEmail[39m(email[33m,[39m plainToken)[33m;[39m
    [90m508| [39m        log[33m.[39m[34minfo[39m({ email }[33m,[39m [32m'Password reset email sent'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m509| [39m
    [90m510| [39m        [35mreturn[39m plainToken[33m;[39m
[90m [2m‚ùØ[22m tests/unit/services/AuthService.test.ts:[2m671:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[283/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mPassword Reset[2m > [22mgeneratePasswordResetToken()[2m > [22mshould invalidate previous reset tokens
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2m‚ùØ[22m AuthService.generatePasswordResetToken server/services/AuthService.ts:[2m508:9[22m[39m
    [90m506| [39m
    [90m507| [39m        [35mawait[39m [34msendPasswordResetEmail[39m(email[33m,[39m plainToken)[33m;[39m
    [90m508| [39m        log[33m.[39m[34minfo[39m({ email }[33m,[39m [32m'Password reset email sent'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m509| [39m
    [90m510| [39m        [35mreturn[39m plainToken[33m;[39m
[90m [2m‚ùØ[22m tests/unit/services/AuthService.test.ts:[2m695:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[284/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mRefresh Token Management[2m > [22mrotateRefreshToken()[2m > [22mshould rotate valid token and return new one
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2m‚ùØ[22m AuthService.rotateRefreshToken server/services/AuthService.ts:[2m396:9[22m[39m
    [90m394| [39m        [90m// DEBUG LOG[39m
    [90m395| [39m        [90m// logger is available as 'log' from imports[39m
    [90m396| [39m        log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEB‚Ä¶
    [90m   | [39m        [31m^[39m
    [90m397| [39m
    [90m398| [39m        [90m// Find token purely by hash to detect state[39m
[90m [2m‚ùØ[22m tests/unit/services/AuthService.test.ts:[2m901:42[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[285/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mRefresh Token Management[2m > [22mrotateRefreshToken()[2m > [22mshould return null for unknown token
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2m‚ùØ[22m AuthService.rotateRefreshToken server/services/AuthService.ts:[2m396:9[22m[39m
    [90m394| [39m        [90m// DEBUG LOG[39m
    [90m395| [39m        [90m// logger is available as 'log' from imports[39m
    [90m396| [39m        log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEB‚Ä¶
    [90m   | [39m        [31m^[39m
    [90m397| [39m
    [90m398| [39m        [90m// Find token purely by hash to detect state[39m
[90m [2m‚ùØ[22m tests/unit/services/AuthService.test.ts:[2m914:42[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[286/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mRefresh Token Management[2m > [22mrotateRefreshToken()[2m > [22mshould revoke all tokens on reuse detection
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2m‚ùØ[22m AuthService.rotateRefreshToken server/services/AuthService.ts:[2m396:9[22m[39m
    [90m394| [39m        [90m// DEBUG LOG[39m
    [90m395| [39m        [90m// logger is available as 'log' from imports[39m
    [90m396| [39m        log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEB‚Ä¶
    [90m   | [39m        [31m^[39m
    [90m397| [39m
    [90m398| [39m        [90m// Find token purely by hash to detect state[39m
[90m [2m‚ùØ[22m tests/unit/services/AuthService.test.ts:[2m933:42[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[287/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mRefresh Token Management[2m > [22mrotateRefreshToken()[2m > [22mshould return null for expired token
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2m‚ùØ[22m AuthService.rotateRefreshToken server/services/AuthService.ts:[2m396:9[22m[39m
    [90m394| [39m        [90m// DEBUG LOG[39m
    [90m395| [39m        [90m// logger is available as 'log' from imports[39m
    [90m396| [39m        log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEB‚Ä¶
    [90m   | [39m        [31m^[39m
    [90m397| [39m
    [90m398| [39m        [90m// Find token purely by hash to detect state[39m
[90m [2m‚ùØ[22m tests/unit/services/AuthService.test.ts:[2m950:42[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[288/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mToken Cleanup[2m > [22mcleanupExpiredTokens()[2m > [22mshould cleanup expired refresh tokens
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2m‚ùØ[22m AuthService.cleanupExpiredTokens server/services/AuthService.ts:[2m593:9[22m[39m
    [90m591| [39m        [35mawait[39m accountLockoutService[33m.[39m[34mcleanupOldAttempts[39m()[33m;[39m
    [90m592| [39m
    [90m593| [39m        log[33m.[39m[34minfo[39m([32m'Cleaned up expired tokens and old login attempts'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m594| [39m    }
    [90m595| [39m}
[90m [2m‚ùØ[22m tests/unit/services/AuthService.test.ts:[2m977:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[289/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mToken Cleanup[2m > [22mcleanupExpiredTokens()[2m > [22mshould cleanup expired password reset tokens
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2m‚ùØ[22m AuthService.cleanupExpiredTokens server/services/AuthService.ts:[2m593:9[22m[39m
    [90m591| [39m        [35mawait[39m accountLockoutService[33m.[39m[34mcleanupOldAttempts[39m()[33m;[39m
    [90m592| [39m
    [90m593| [39m        log[33m.[39m[34minfo[39m([32m'Cleaned up expired tokens and old login attempts'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m594| [39m    }
    [90m595| [39m}
[90m [2m‚ùØ[22m tests/unit/services/AuthService.test.ts:[2m982:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[290/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mToken Cleanup[2m > [22mcleanupExpiredTokens()[2m > [22mshould cleanup expired email verification tokens
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2m‚ùØ[22m AuthService.cleanupExpiredTokens server/services/AuthService.ts:[2m593:9[22m[39m
    [90m591| [39m        [35mawait[39m accountLockoutService[33m.[39m[34mcleanupOldAttempts[39m()[33m;[39m
    [90m592| [39m
    [90m593| [39m        log[33m.[39m[34minfo[39m([32m'Cleaned up expired tokens and old login attempts'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m594| [39m    }
    [90m595| [39m}
[90m [2m‚ùØ[22m tests/unit/services/AuthService.test.ts:[2m987:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[291/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mToken Cleanup[2m > [22mcleanupExpiredTokens()[2m > [22mshould cleanup old login attempts via accountLockoutService
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2m‚ùØ[22m AuthService.cleanupExpiredTokens server/services/AuthService.ts:[2m593:9[22m[39m
    [90m591| [39m        [35mawait[39m accountLockoutService[33m.[39m[34mcleanupOldAttempts[39m()[33m;[39m
    [90m592| [39m
    [90m593| [39m        log[33m.[39m[34minfo[39m([32m'Cleaned up expired tokens and old login attempts'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m594| [39m    }
    [90m595| [39m}
[90m [2m‚ùØ[22m tests/unit/services/AuthService.test.ts:[2m993:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[292/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mIntegration Scenarios[2m > [22mComplete Authentication Flow[2m > [22mshould support full user authentication lifecycle
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2m‚ùØ[22m AuthService.rotateRefreshToken server/services/AuthService.ts:[2m396:9[22m[39m
    [90m394| [39m        [90m// DEBUG LOG[39m
    [90m395| [39m        [90m// logger is available as 'log' from imports[39m
    [90m396| [39m        log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEB‚Ä¶
    [90m   | [39m        [31m^[39m
    [90m397| [39m
    [90m398| [39m        [90m// Find token purely by hash to detect state[39m
[90m [2m‚ùØ[22m tests/unit/services/AuthService.test.ts:[2m1239:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[293/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mIntegration Scenarios[2m > [22mPassword Reset Flow[2m > [22mshould support complete password reset workflow
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2m‚ùØ[22m AuthService.generatePasswordResetToken server/services/AuthService.ts:[2m508:9[22m[39m
    [90m506| [39m
    [90m507| [39m        [35mawait[39m [34msendPasswordResetEmail[39m(email[33m,[39m plainToken)[33m;[39m
    [90m508| [39m        log[33m.[39m[34minfo[39m({ email }[33m,[39m [32m'Password reset email sent'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m509| [39m
    [90m510| [39m        [35mreturn[39m plainToken[33m;[39m
[90m [2m‚ùØ[22m tests/unit/services/AuthService.test.ts:[2m1259:28[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[294/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mIntegration Scenarios[2m > [22mPassword Reset Flow[2m > [22mshould prevent reuse of password reset tokens
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2m‚ùØ[22m AuthService.generatePasswordResetToken server/services/AuthService.ts:[2m508:9[22m[39m
    [90m506| [39m
    [90m507| [39m        [35mawait[39m [34msendPasswordResetEmail[39m(email[33m,[39m plainToken)[33m;[39m
    [90m508| [39m        log[33m.[39m[34minfo[39m({ email }[33m,[39m [32m'Password reset email sent'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m509| [39m
    [90m510| [39m        [35mreturn[39m plainToken[33m;[39m
[90m [2m‚ùØ[22m tests/unit/services/AuthService.test.ts:[2m1296:28[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[295/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22menqueue[2m > [22mshould enqueue a PDF conversion job
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,9abb043a-04d8-4d7b-b3c8-b1e5f7a68cb0,8e082ae7-1a6b-43eb-8937-c7420a5caa47,9abb043a-04d8-4d7b-b3c8-b1e5f7a68cb0,9abb043a-04d8-4d7b-b3c8-b1e5f7a68cb0[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(9abb043a-04d8-4d7b-b3c8-b1e5f7a68cb0) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w61_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[296/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22menqueue[2m > [22mshould create output with empty storagePath initially
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, $5, $6, default, default, default, default, default, default, $7, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,35e25161-3f70-4d27-9c05-54bdbb6c1087,35e25161-3f70-4d27-9c05-54bdbb6c1087,Test Workflow,44e630c6-f6ac-4eae-b5ee-ccc214cdd2ec,draft[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m109:24[22m[39m
    [90m107| [39m
    [90m108| [39m    [90m// Create test workflow[39m
    [90m109| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m db
    [90m   | [39m                       [31m^[39m
    [90m110| [39m      [33m.[39m[34minsert[39m(workflows)
    [90m111| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m109:24[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(35e25161-3f70-4d27-9c05-54bdbb6c1087) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w58_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[297/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mgetJobStatus[2m > [22mshould return job status for pending job
[31m[1mError[22m: Failed query: insert into "workflow_versions" ("id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at") values (default, $1, default, $2, $3, $4, default, $5, default, default, $6, default, default, default, default) returning "id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at"
params: 91b674fb-8109-4961-b379-67e44f7d1d89,1,true,{},"Initial version",557b48eb-0ba4-430c-8621-1e6ff563187c[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m124:23[22m[39m
    [90m122| [39m
    [90m123| [39m    [90m// Create test workflow version[39m
    [90m124| [39m    [35mconst[39m [version] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m125| [39m      [33m.[39m[34minsert[39m(workflowVersions)
    [90m126| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflow_versions" violates foreign key constraint "workflow_versions_workflow_id_workflows_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m124:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 375, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(91b674fb-8109-4961-b379-67e44f7d1d89) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w72_v3', table: 'workflow_versions', dataType: undefined, constraint: 'workflow_versions_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[298/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mgetJobStatus[2m > [22mshould return null for non-existent job
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,f1428869-03cb-446c-96d0-f07b5beeb581,772780cf-51fe-42d8-b4bc-1bb5d5c65fde,f1428869-03cb-446c-96d0-f07b5beeb581,f1428869-03cb-446c-96d0-f07b5beeb581[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(f1428869-03cb-446c-96d0-f07b5beeb581) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w67_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[299/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mgetJobStatus[2m > [22mshould parse attempt count from error field
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,b21b4eac-d53a-41b2-aee5-73a7bc189c84,7030e5ae-6d7f-43a8-aa22-ba2e4e32d14b,b21b4eac-d53a-41b2-aee5-73a7bc189c84,b21b4eac-d53a-41b2-aee5-73a7bc189c84[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(b21b4eac-d53a-41b2-aee5-73a7bc189c84) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w28_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[300/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mconvertImmediate[2m > [22mshould convert DOCX to PDF immediately
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,eb820def-3b03-4087-a10e-0d268a3d1634,4da54888-5e34-4b98-8de1-3c406dc4d717,eb820def-3b03-4087-a10e-0d268a3d1634,eb820def-3b03-4087-a10e-0d268a3d1634[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(eb820def-3b03-4087-a10e-0d268a3d1634) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w67_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[301/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mconvertImmediate[2m > [22mshould handle conversion errors gracefully
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,8104cc9a-2d7b-42d9-a894-0d4f0450e3b1,bab97ae0-be7d-47f1-a622-c8bafc63be42,8104cc9a-2d7b-42d9-a894-0d4f0450e3b1,8104cc9a-2d7b-42d9-a894-0d4f0450e3b1[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(8104cc9a-2d7b-42d9-a894-0d4f0450e3b1) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w67_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[302/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mService Lifecycle[2m > [22mshould start and stop service
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,c148d522-029a-451b-af52-e5a44067431d,d3938337-77c5-4ca6-a5d3-ada34fe5048f,c148d522-029a-451b-af52-e5a44067431d,c148d522-029a-451b-af52-e5a44067431d[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(c148d522-029a-451b-af52-e5a44067431d) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w66_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[303/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mQueue Processing[2m > [22mshould process pending jobs when queue is processed
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, $5, $6, default, default, default, default, default, default, $7, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,743516b2-2fb3-4365-8a23-80a5bb7c05ac,743516b2-2fb3-4365-8a23-80a5bb7c05ac,Test Workflow,3fe83a57-20d0-4aad-b2dd-ecc1d198b26e,draft[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m109:24[22m[39m
    [90m107| [39m
    [90m108| [39m    [90m// Create test workflow[39m
    [90m109| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m db
    [90m   | [39m                       [31m^[39m
    [90m110| [39m      [33m.[39m[34minsert[39m(workflows)
    [90m111| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m109:24[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(743516b2-2fb3-4365-8a23-80a5bb7c05ac) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w80_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[304/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mQueue Processing[2m > [22mshould process multiple jobs in batch
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,26c7642f-0587-4cb9-add2-8cde497bd578,83be3c6f-15e8-467b-8fa7-cd3d92fd9ad5,26c7642f-0587-4cb9-add2-8cde497bd578,26c7642f-0587-4cb9-add2-8cde497bd578[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(26c7642f-0587-4cb9-add2-8cde497bd578) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w81_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[305/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mError Handling[2m > [22mshould handle missing DOCX output gracefully
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,87c29f27-dda4-4a12-9543-f187af3b43a1,cdbbe652-0bf9-4070-b697-752c249fe159,87c29f27-dda4-4a12-9543-f187af3b43a1,87c29f27-dda4-4a12-9543-f187af3b43a1[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 327, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(cdbbe652-0bf9-4070-b697-752c249fe159) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w87_v3', table: 'projects', dataType: undefined, constraint: 'projects_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[306/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mTransaction Support[2m > [22mshould support enqueue within transaction
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,b806c2f2-67af-4481-8bb0-616ac91f3eee,55f4a3b5-7640-4bfa-95c0-c62dd21fcfaf,b806c2f2-67af-4481-8bb0-616ac91f3eee,b806c2f2-67af-4481-8bb0-616ac91f3eee[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(b806c2f2-67af-4481-8bb0-616ac91f3eee) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w61_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[307/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mTransaction Support[2m > [22mshould support convertImmediate within transaction
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,910e1310-e1a1-4d41-b371-99ce1ba48a6a,2b168418-7c30-40dc-a88f-cd8926857ed0,910e1310-e1a1-4d41-b371-99ce1ba48a6a,910e1310-e1a1-4d41-b371-99ce1ba48a6a[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(910e1310-e1a1-4d41-b371-99ce1ba48a6a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w93_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[308/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mshould automatically unset other primaries when setting new primary
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: fca88fb1-4b4b-4b6c-9c2f-b90bd5095474,test-1768715693890@example.com,Test User,Test,User,5c03f7bf-39ba-45f5-8abd-a8ef5b07167e,admin,owner,local,easy[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5c03f7bf-39ba-45f5-8abd-a8ef5b07167e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[309/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mlistTemplates[2m > [22mshould list all templates for workflow version
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: eec33f34-72bc-451d-b4b1-1e1c9c873226,test-1768715694489@example.com,Test User,Test,User,0a4a67ae-164e-43fc-a69a-8769fed0a416,admin,owner,local,easy[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(0a4a67ae-164e-43fc-a69a-8769fed0a416) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[310/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mlistTemplates[2m > [22mshould return empty array for version with no templates
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 375f730f-eee8-48e9-8963-bfd41c395d32,test-1768715695053@example.com,Test User,Test,User,06b3820d-5aa9-4682-b76b-a87cdefd3449,admin,owner,local,easy[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(06b3820d-5aa9-4682-b76b-a87cdefd3449) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[311/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetTemplateMapping[2m > [22mshould get template mapping by id and version
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: eb9f7ce0-e6e1-4ae0-a5b5-a5d33101e4eb,test-1768715695586@example.com,Test User,Test,User,6a4ea2a6-5bd2-459a-ba81-b9e099d6467a,admin,owner,local,easy[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(6a4ea2a6-5bd2-459a-ba81-b9e099d6467a) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[312/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetTemplateMapping[2m > [22mshould throw error if mapping not found
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, $3, $4, $5, default, $6, $7, $8, default, default, default, default, default, default, $9, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: ba272901-bf5b-4e51-8ae3-05a3df652d34,Test Workflow,Test workflow,532eb192-246c-47e2-9728-0f498cfae580,532eb192-246c-47e2-9728-0f498cfae580,test-workflow-81a1171f-8cff-4208-a082-ee430461577f,Test Workflow,5d3dd64d-69af-42de-bc51-00636a190619,draft[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
    [90m149| [39m    }
    [90m150| [39m  )[33m:[39m [33mPromise[39m[33m<[39m[33mTestWorkflow[39m[33m>[39m {
    [90m151| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                       [31m^[39m
    [90m152| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mworkflows)
    [90m153| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m53:35[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m53:35[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(532eb192-246c-47e2-9728-0f498cfae580) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[313/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetTemplateByKey[2m > [22mshould get template by key
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, $3, $4, $5, default, $6, $7, $8, default, default, default, default, default, default, $9, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: 3eec19a6-c613-48fc-bfcf-b925c6d244f6,Test Workflow,Test workflow,e1007c9f-0487-457b-b44c-e7db76d29a4a,e1007c9f-0487-457b-b44c-e7db76d29a4a,test-workflow-a321a8bc-71ca-419c-94de-83dae331c2eb,Test Workflow,94793090-18b6-4cf3-8569-22cab355fd8c,draft[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
    [90m149| [39m    }
    [90m150| [39m  )[33m:[39m [33mPromise[39m[33m<[39m[33mTestWorkflow[39m[33m>[39m {
    [90m151| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                       [31m^[39m
    [90m152| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mworkflows)
    [90m153| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m53:35[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m53:35[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 327, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(e1007c9f-0487-457b-b44c-e7db76d29a4a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[314/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetTemplateByKey[2m > [22mshould throw error if key not found
[31m[1mError[22m: Failed query: insert into "templates" ("id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, default, default, default, default, $7, default, default) returning "id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at"
params: f919e872-da1d-4465-939b-8003fbd516cb,85c13bae-9f97-4422-84ec-84dd7233fa85,Template 1,First test template,/uploads/template1.docx,docx,5dcbe45f-cb5e-4a2c-8458-4bbdcbcea064[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTemplate tests/helpers/testFactory.ts:[2m235:24[22m[39m
    [90m233| [39m    overrides[33m?[39m[33m:[39m [33mPartial[39m[33m<[39m[35mtypeof[39m schema[33m.[39mtemplates[33m.[39m$inferInsert[33m>[39m
    [90m234| [39m  )[33m:[39m [33mPromise[39m[33m<[39m[33mTestTemplate[39m[33m>[39m {
    [90m235| [39m    [35mconst[39m [template] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                       [31m^[39m
    [90m236| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mtemplates)
    [90m237| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m66:37[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "templates" violates foreign key constraint "templates_project_id_projects_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTemplate tests/helpers/testFactory.ts:[2m235:24[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m66:37[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 337, severity: 'ERROR', code: '23503', detail: 'Key (project_id)=(85c13bae-9f97-4422-84ec-84dd7233fa85) is not present in table "projects".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'templates', dataType: undefined, constraint: 'templates_project_id_projects_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[315/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetPrimaryTemplate[2m > [22mshould get primary template for workflow version
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 8f429a9f-6de8-4bcb-83ed-90027be8c68f,test-1768715698384@example.com,Test User,Test,User,b279c01b-63f0-4673-b7dd-5293052d05d9,admin,owner,local,easy[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b279c01b-63f0-4673-b7dd-5293052d05d9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[316/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetPrimaryTemplate[2m > [22mshould return null when no primary template exists
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, $3, $4, $5, default, $6, $7, $8, default, default, default, default, default, default, $9, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: ca7975df-6c5c-4277-8569-558bde56a0f3,Test Workflow,Test workflow,bc315533-825b-4b13-ba59-68c474543c31,bc315533-825b-4b13-ba59-68c474543c31,test-workflow-f517ce4b-92f4-4556-bf62-7892786438f4,Test Workflow,d4965ee8-e307-4988-a912-020ec3e8912d,draft[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
    [90m149| [39m    }
    [90m150| [39m  )[33m:[39m [33mPromise[39m[33m<[39m[33mTestWorkflow[39m[33m>[39m {
    [90m151| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                       [31m^[39m
    [90m152| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mworkflows)
    [90m153| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m53:35[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m53:35[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 327, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(bc315533-825b-4b13-ba59-68c474543c31) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[317/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould update mapping key
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, $3, $4, $5, default, $6, $7, $8, default, default, default, default, default, default, $9, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: 92eef917-900d-4594-9d1d-5283f00e1768,Test Workflow,Test workflow,db9e6e3d-485a-4841-8c79-eec1faa22ffd,db9e6e3d-485a-4841-8c79-eec1faa22ffd,test-workflow-8a2a74af-3f8d-4660-a548-8ea3dbc9c0a8,Test Workflow,bec3af1c-19be-4b8d-acac-0129ae8702e2,draft[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
    [90m149| [39m    }
    [90m150| [39m  )[33m:[39m [33mPromise[39m[33m<[39m[33mTestWorkflow[39m[33m>[39m {
    [90m151| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                       [31m^[39m
    [90m152| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mworkflows)
    [90m153| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m53:35[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m53:35[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 327, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(db9e6e3d-485a-4841-8c79-eec1faa22ffd) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[318/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould update isPrimary flag
[31m[1mError[22m: Failed query: insert into "templates" ("id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, default, default, default, default, $7, default, default) returning "id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at"
params: 627e6e71-631f-48ad-9cb8-37729dc1ae97,f8920716-b8dd-4259-8f4d-dfeded51911c,Template 1,First test template,/uploads/template1.docx,docx,1416c658-2792-4278-bb85-b641cb861cd5[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTemplate tests/helpers/testFactory.ts:[2m235:24[22m[39m
    [90m233| [39m    overrides[33m?[39m[33m:[39m [33mPartial[39m[33m<[39m[35mtypeof[39m schema[33m.[39mtemplates[33m.[39m$inferInsert[33m>[39m
    [90m234| [39m  )[33m:[39m [33mPromise[39m[33m<[39m[33mTestTemplate[39m[33m>[39m {
    [90m235| [39m    [35mconst[39m [template] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                       [31m^[39m
    [90m236| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mtemplates)
    [90m237| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m66:37[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "templates" violates foreign key constraint "templates_project_id_projects_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTemplate tests/helpers/testFactory.ts:[2m235:24[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m66:37[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 337, severity: 'ERROR', code: '23503', detail: 'Key (project_id)=(f8920716-b8dd-4259-8f4d-dfeded51911c) is not present in table "projects".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'templates', dataType: undefined, constraint: 'templates_project_id_projects_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[319/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould throw error if new key already exists
[31m[1mError[22m: Failed query: insert into "templates" ("id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, default, default, default, default, $7, default, default) returning "id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at"
params: 00a115ae-7043-437c-9f6a-4ea4b070a98b,6d7ddbea-c12f-4ce3-8015-3fa191a0bb0d,Template 1,First test template,/uploads/template1.docx,docx,da1a1047-aabe-4313-835e-e1598d5ad7eb[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTemplate tests/helpers/testFactory.ts:[2m235:24[22m[39m
    [90m233| [39m    overrides[33m?[39m[33m:[39m [33mPartial[39m[33m<[39m[35mtypeof[39m schema[33m.[39mtemplates[33m.[39m$inferInsert[33m>[39m
    [90m234| [39m  )[33m:[39m [33mPromise[39m[33m<[39m[33mTestTemplate[39m[33m>[39m {
    [90m235| [39m    [35mconst[39m [template] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                       [31m^[39m
    [90m236| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mtemplates)
    [90m237| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m66:37[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "templates" violates foreign key constraint "templates_project_id_projects_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTemplate tests/helpers/testFactory.ts:[2m235:24[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m66:37[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 337, severity: 'ERROR', code: '23503', detail: 'Key (project_id)=(6d7ddbea-c12f-4ce3-8015-3fa191a0bb0d) is not present in table "projects".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'templates', dataType: undefined, constraint: 'templates_project_id_projects_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[320/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould throw error if mapping not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 631f1091-43f6-406b-8762-7014293cc16c,test-1768715701943@example.com,Test User,Test,User,a38a88ac-4ccf-435f-9e0c-53a22af7dd9e,admin,owner,local,easy[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(a38a88ac-4ccf-435f-9e0c-53a22af7dd9e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[321/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould unset other primaries when setting isPrimary to true
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: 6cbcafe8-a9e2-40bb-8580-1c1e3bd99a50,Test Project,Test Project,Test project for integration tests,174b9845-808e-432b-a303-caa41dc81da7,5bcae592-fb46-4fd1-9c0a-db5cc1cce20f,174b9845-808e-432b-a303-caa41dc81da7,174b9845-808e-432b-a303-caa41dc81da7[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(174b9845-808e-432b-a303-caa41dc81da7) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w18_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[322/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mdetachTemplate[2m > [22mshould detach template from workflow version
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: 26f46274-8b43-4cd6-b6a2-2f906331a6cb,Test Project,Test Project,Test project for integration tests,50a9ae5f-50bc-482e-a614-f3ba5bd0ef5e,7ea107d3-78a6-469c-bc00-b1442463f8f9,50a9ae5f-50bc-482e-a614-f3ba5bd0ef5e,50a9ae5f-50bc-482e-a614-f3ba5bd0ef5e[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(50a9ae5f-50bc-482e-a614-f3ba5bd0ef5e) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w25_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[323/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mdetachTemplate[2m > [22mshould throw error if mapping not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 90df0544-831b-4561-85df-8d780c9e627b,test-1768715703771@example.com,Test User,Test,User,f9b4d2b8-b8b0-40e5-8eae-83b8fe23eb5b,admin,owner,local,easy[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f9b4d2b8-b8b0-40e5-8eae-83b8fe23eb5b) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[324/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22msetPrimaryTemplate[2m > [22mshould set template as primary
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: ad2a9387-9b10-43ee-a0ab-2c182a01f316,Test Project,Test Project,Test project for integration tests,15d02452-b767-4a10-8338-bf4a95a85644,54d5a580-a166-4e07-9f47-52c79d3016a2,15d02452-b767-4a10-8338-bf4a95a85644,15d02452-b767-4a10-8338-bf4a95a85644[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(15d02452-b767-4a10-8338-bf4a95a85644) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[325/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22msetPrimaryTemplate[2m > [22mshould throw error if mapping not found
[31m[1mError[22m: Failed query: insert into "workflow_versions" ("id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at") values ($1, $2, default, $3, default, $4, default, default, default, default, $5, default, default, default, default) returning "id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at"
params: 1a20f793-4839-4f23-9d04-bc92905fdf52,4e1b5ac2-6492-4809-ae60-2b7d8c92516b,1,{},923ad159-5338-42e3-99e0-101bc74a2553[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m166:23[22m[39m
    [90m164| [39m      [33m.[39m[34mreturning[39m()[33m;[39m
    [90m165| [39m
    [90m166| [39m    [35mconst[39m [version] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m167| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mworkflowVersions)
    [90m168| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m53:35[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "workflow_versions" violates foreign key constraint "workflow_versions_workflow_id_workflows_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m166:23[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m53:35[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 374, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(4e1b5ac2-6492-4809-ae60-2b7d8c92516b) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'workflow_versions', dataType: undefined, constraint: 'workflow_versions_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[326/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mtransaction support[2m > [22mshould support operations within a transaction
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: d8ac3ce8-20da-41f6-9f50-7e25c94af752,Test Project,Test Project,Test project for integration tests,01070ffb-37a5-46cd-bf20-5c3a0e620b2a,0b6e20ec-2dfd-4407-9589-9cfe009cec8b,01070ffb-37a5-46cd-bf20-5c3a0e620b2a,01070ffb-37a5-46cd-bf20-5c3a0e620b2a[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(01070ffb-37a5-46cd-bf20-5c3a0e620b2a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[327/354]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mtransaction support[2m > [22mshould rollback on transaction error
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 67623e3f-a41c-447f-962a-6d708eee436f,test-1768715706509@example.com,Test User,Test,User,83b21e6f-c1d0-4fd2-a9ec-9429d1d111d4,admin,owner,local,easy[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(83b21e6f-c1d0-4fd2-a9ec-9429d1d111d4) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[328/354]‚éØ[22m[39m


[2m Test Files [22m [1m[31m51 failed[39m[22m[2m | [22m[1m[32m105 passed[39m[22m[2m | [22m[33m1 skipped[39m[90m (157)[39m
[2m      Tests [22m [1m[31m321 failed[39m[22m[2m | [22m[1m[32m2027 passed[39m[22m[2m | [22m[33m292 skipped[39m[90m (2640)[39m
[2m   Start at [22m 23:54:47
[2m   Duration [22m 94.54s[2m (transform 21.79s, setup 19.14s, import 291.43s, tests 757.00s, environment 23.17s)[22m

